"use strict";(self.webpackChunk_flowgram_ai_docs=self.webpackChunk_flowgram_ai_docs||[]).push([["475509"],{893740:function(t,e,i){i.d(e,{yT:()=>t7,Fw:()=>e2,YZ:()=>g,Lk:()=>e_,Qc:()=>E.Qc,z2:()=>eE,JA:()=>E.JA,Ho:()=>L,UJ:()=>p,ER:()=>eO,Zs:()=>eR,WV:()=>Y,Yv:()=>eS,wY:()=>eF,Tj:()=>eL,yy:()=>y,VO:()=>W,Wi:()=>ir,JH:()=>z,XQ:()=>e1,VD:()=>P,mh:()=>eB,s5:()=>Q,nn:()=>em,W6:()=>e9,iX:()=>is,qY:()=>eW,p4:()=>tt,v2:()=>eo,KV:()=>E.KV,M1:()=>eq,cv:()=>es,W4:()=>eH,yb:()=>E.yb,_z:()=>J,km:()=>e7,Zn:()=>eZ,Rm:()=>eY,H$:()=>it,KU:()=>e6,G2:()=>ie,Dc:()=>e8,RX:()=>ep,JW:()=>eA,RD:()=>G,bP:()=>ii,xm:()=>et,mY:()=>u,rQ:()=>eU,el:()=>ei,aI:()=>ef,O0:()=>eg,d3:()=>e0});var r,n,s,o,a,l,h,d,u,c,g,p,f,y,m,E=i(832176),b=i(129034),C=i(9163),S=i(661881),D=i(550570);i(543789);var _=i(908600),w=i(473732),x=i(89802),N=Object.defineProperty,M=Object.getOwnPropertyDescriptor,I=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?M(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&N(e,i,s),s};(n=(r=u||(u={})).Default||(r.Default={})).ZOOM_IN="ZOOM_IN",n.ZOOM_OUT="ZOOM_OUT",n.DELETE="DELETE",n.COPY="COPY",n.PASTE="PASTE",n.UNDO="UNDO",n.REDO="REDO",n.VIEW_CLOSE_ALL_WIDGET="view.closeAllWidget",n.VIEW_CLOSE_CURRENT_WIDGET="view.closeCurrentWidget",n.VIEW_REOPEN_LAST_WIDGET="view.reopenLastWidget",n.VIEW_CLOSE_OTHER_WIDGET="view.closeOtherWidget",n.VIEW_CLOSE_BOTTOM_PANEL="view.closeBottomPannel",n.VIEW_OPEN_NEXT_TAB="view.openNextTab",n.VIEW_OEPN_LAST_TAB="view.openLastTab",n.VIEW_FULL_SCREEN="view.fullScreen",n.VIEW_SAVING_WIDGET_CLOSE_CONFIRM="view.savingWidgetCloseConfirm",n.VIEW_SHORTCUTS="view.shortcuts",n.VIEW_PREFERENCES="view.preferences",n.VIEW_LOG="view.log",n.VIEW_PROBLEMS="view.problems",r.is=function(t){return!!t&&t===Object(t)&&"id"in t};var T=Symbol("CommandContribution");(c||(c={})).findSimple=function(t,e){for(let i of t.values())if(i.id===e.id&&i.args.length===e.args.length&&i.args.every((t,i)=>e[i]===t))return i};var L=class{init(){for(let t of this.contributions)t.registerCommands(this)}get commands(){let t=[];for(let e of this.commandIds){let i=this.getCommand(e);i&&t.push(i)}return t}get commandIds(){return Object.keys(this._commands)}registerCommand(t,e){let i="string"==typeof t?{id:t}:t;if(this._commands[i.id])return console.warn(`A command ${i.id} is already registered.`),E.JT.NULL;let r=new E.K4(this.doRegisterCommand(i));return e&&r.push(this.registerHandler(i.id,e)),this.toUnregisterCommands.set(i.id,r),r.push(E.JT.create(()=>this.toUnregisterCommands.delete(i.id))),r}unregisterCommand(t){let e=u.is(t)?t.id:t,i=this.toUnregisterCommands.get(e);i&&i.dispose()}registerHandler(t,e){let i=this._handlers[t];return i||(this._handlers[t]=i=[]),i.unshift(e),{dispose:()=>{let t=i.indexOf(e);t>=0&&i.splice(t,1)}}}isVisible(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return void 0!==this.getVisibleHandler(t,...i)}isEnabled(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return void 0!==this.getActiveHandler(t,...i)}isToggled(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return void 0!==this.getToggledHandler(t,...i)}async executeCommand(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=this.getActiveHandler(t,...i),s={id:t,args:i};if(c.findSimple(this._commandExecutings,s))return s.promise;if(n)try{this._commandExecutings.add(s),this.onWillExecuteCommandEmitter.fire({commandId:t,args:i});let e=n.execute(...i);s.promise=e;let r=await e;return this.onDidExecuteCommandEmitter.fire({commandId:t,args:i}),r}finally{this._commandExecutings.delete(s)}}getVisibleHandler(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=this._handlers[t];if(n)for(let t of n)try{if(!t.isVisible||t.isVisible(...i))return t}catch(t){console.error(t)}}getActiveHandler(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=this._handlers[t];if(n)for(let t of n)try{if(!t.isEnabled||t.isEnabled(...i))return t}catch(t){console.error(t)}}getAllHandlers(t){let e=this._handlers[t];return e?e.slice():[]}getToggledHandler(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=this._handlers[t];if(n)for(let t of n)try{if(t.isToggled&&t.isToggled(...i))return t}catch(t){console.error(t)}}getCommand(t){return this._commands[t]}doRegisterCommand(t){return this._commands[t.id]=t,{dispose:()=>{delete this._commands[t.id]}}}updateCommand(t,e){this._commands[t]&&(this._commands[t]={...this._commands[t],...e})}dispose(){this.onWillExecuteCommandEmitter.dispose(),this.onDidExecuteCommandEmitter.dispose()}constructor(){this._handlers={},this._commands={},this._commandExecutings=new Set,this.toUnregisterCommands=new Map,this.onDidExecuteCommandEmitter=new E.Q5,this.onDidExecuteCommand=this.onDidExecuteCommandEmitter.event,this.onWillExecuteCommandEmitter=new E.Q5,this.onWillExecuteCommand=this.onWillExecuteCommandEmitter.event}};I([(0,C.nx)(T),(0,C.jt)()],L.prototype,"contributions",2),L=I([(0,C.b2)()],L);var P=Symbol("CommandService"),R=new C.nZ(t=>{(0,E.yb)(t,T),t(L).toSelf().inSingletonScope(),t(P).toService(L),t("CommandRegistryFactory").toFactory(t=>()=>t.container.get(L))}),A=Object.defineProperty,k=Object.getOwnPropertyDescriptor,O=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?k(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&A(e,i,s),s},V=(t,e)=>(i,r)=>e(i,r,t),B=Object.__proto__,F=0,z=class{getDefaultDataRegistries(){return[]}get changeLocked(){return this._changeLockedTimes>0}set changeLocked(t){this._changeLockedTimes=t?this._changeLockedTimes+1:this._changeLockedTimes-1,this._changeLockedTimes<0&&(this._changeLockedTimes=0)}get type(){if(!this.constructor.type)throw Error(`Entity Registry need a type: ${this.constructor.name}`);return this.constructor.type}get context(){return this.entityManager.context}addInitializeData(t,e){this.isInitialized=!0,t.forEach(t=>this.addData(t,e)),this.isInitialized=!1}get version(){return this._version}toJSON(){let t=[];for(let e of this.dataManager.values())t.push({type:e.type,data:e.toJSON()});return{type:this.type,id:this.id,dataList:t}}fromJSON(t){t&&t.id&&t.type&&(this.changeLocked=!0,this.reset(),t.dataList&&t.dataList.forEach(t=>{let e=this.entityManager.getDataRegistryByType(t.type);e&&this.addData(e).update(t.data)}),this.changeLocked=!1,this.fireChange())}get id(){return this._id}dispose(){this.preDispose.dispose(),this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}reset(){for(let t of(this.changeLocked=!0,this.dataManager.values()))this.initializeDataKeys.includes(t.type)||t.dispose();this.register(),this.changeLocked=!1,this.fireChange()}get onDispose(){return this.toDispose.onDispose}fireChange(){this.changeLocked||this.isInitialized||this.disposed||(this._version++,this._version>=Number.MAX_SAFE_INTEGER&&(this._version=0),this.onEntityChangeEmitter.fire(this))}addData(t,e){this.entityManager.registerEntityData(t);let i=this.dataManager.get(t.type);if(i)return e&&this.updateData(t,e),i;let r=this.entityManager.getDataInjector(t);i=new t(this,null==r?void 0:r()),this.isInitialized&&this.initializeDataKeys.push(i.type),this.dataManager.set(t.type,i),this.toDispose.push(i),i.onDataChange(()=>{let t={type:"update",data:i,entity:this};this.onDataChangeEmitter.fire(t),this.fireChange()}),i.toDispose.push(E.JT.create(()=>{this.initializeDataKeys.includes(t.type)||this.dataManager.delete(t.type);let e={type:"delete",data:i,entity:this};this.onDataChangeEmitter.fire(e),this.fireChange()})),i.changeLocked=!0,this.updateData(t,e||i.getDefaultData()),i.changeLocked=!1;let n={type:"add",data:i,entity:this};return this.onDataChangeEmitter.fire(n),i}get savedInManager(){return this._savedInManager}updateData(t,e){let i=this.dataManager.get(t.type);i&&i.update(e)}getData(t){return this.dataManager.get(t.type)}hasData(t){return this.dataManager.has(t.type)}removeData(t){if(this.initializeDataKeys.includes(t.type))return;let e=this.dataManager.get(t.type);e&&e.dispose()}getService(t){return this.entityManager.getService(t)}register(){this.getDefaultDataRegistries().forEach(t=>this.addData(t))}constructor(t){this.onEntityChangeEmitter=new E.Q5,this.onDataChangeEmitter=new E.Q5,this.initializeDataKeys=[],this.dataManager=new Map,this.toDispose=new E.K4,this.preDispose=new E.K4,this.onEntityChange=this.onEntityChangeEmitter.event,this.onDataChange=this.onDataChangeEmitter.event,this._changeLockedTimes=0,this.isInitialized=!0,this._version=F++,this._savedInManager=!0,this.entityManager=t.entityManager,this._id=t.id||(0,b.x0)(),this._savedInManager=void 0===t.savedInManager||t.savedInManager,this.isInitialized=!0,this.toDispose.push(this.onEntityChangeEmitter),this.toDispose.push(this.onDataChangeEmitter),this.register(),t.datas&&t.datas.forEach(t=>this.addData(t.registry,t.data)),this.isInitialized=!1}};z.type="Entity",(s=z||(z={})).getType=function(t){return t.type},s.checkDataChanged=function(t,e){return E.XJ.isChanged(t,e)},s.isRegistryOf=function(t,e){if(t===e)return!0;let i=t.__proto__;for(;i&&i!==B;){if(i.prototype===e.prototype)return!0;i=i.__proto__}return!1};var G=class extends E.Pq{get type(){if(!this.constructor.type)throw Error(`Entity Data Registry need a type: ${this.constructor.name}`);return this.constructor.type}get data(){return this._data}update(t,e){2==arguments.length?this._data[t]!==e&&(this.fireWillChange(),this._data[t]=e,this.fireChange()):this.checkChanged(t)&&(this.fireWillChange(),"object"!=typeof t?this._data=t:this._data={...this._data,...t},this.fireChange())}fullyUpdate(t){E.XJ.isChanged(this._data,t,1,!1)&&(this.fireWillChange(),this._data=t,this.fireChange())}checkChanged(t){return z.checkDataChanged(this._data,t)}toJSON(){return this.data}fromJSON(t){this.update(t)}get changeLocked(){return this._changeLocked}set changeLocked(t){this._changeLocked=t}fireWillChange(){this.onWillChangeEmitter.fire(this)}fireChange(){this._changeLocked||(this._version++,this._version>=Number.MAX_SAFE_INTEGER&&(this._version=0),this.onDataChangeEmitter.fire(this))}bindChange(t,e){this.toDispose.push(t.onDataChange(()=>{e&&e(),this.fireChange()}))}get version(){return this._version}constructor(t,e){super(),this.opts=e,this.onDataChangeEmitter=new E.Q5,this.onWillChangeEmitter=new E.Q5,this._changeLocked=!1,this._version=0,this.onDataChange=this.onDataChangeEmitter.event,this.onWillChange=this.onWillChangeEmitter.event,this.entity=t,this._data=this.getDefaultData(),this.toDispose.push(this.onDataChangeEmitter),this.toDispose.push(this.onWillChangeEmitter)}};G.type="EntityData";var $=class extends G{getDefaultData(){return E.V_.createDefault(E.i1)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};$.type="OriginData";var Y=class extends G{getDefaultData(){return E.V_.createDefault(E.Zp)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};Y.type="PositionData";var X=class extends G{getDefaultData(){return E.V_.createDefault(E.z)}};X.type="RotationData";var j=class extends G{getDefaultData(){return E.V_.createDefault(E.Of)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};j.type="ScaleData";var J=class extends G{getDefaultData(){return E.V_.createDefault(E.gE)}get width(){return this.data.width}get height(){return this.data.height}set width(t){this.update("width",t)}set height(t){this.update("height",t)}get locked(){return!!this.data.locked}set locked(t){this.update("locked",t)}};J.type="SizeData";var U=class extends G{getDefaultData(){return E.V_.createDefault(E.S9)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};U.type="SkewData";var{fixZero:H}=E.E9;(t=>{function e(t,e){return e&&e.apply(t,t),H(t),t}function i(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x),y:-(r.height*n.y)},i)}function r(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width,y:-(r.height*n.y)},i)}function n(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x),y:-(r.height*n.y)+r.height},i)}function s(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width,y:-(r.height*n.y)+r.height},i)}t.getPointWithMatrix=e,t.getBounds=function(t,e){let o=new E.Ae;if(!e||e.isSimple()){let{size:i,origin:r}=t;o.x=-(i.width*r.x)+((null==e?void 0:e.tx)||0),o.y=-(i.height*r.y)+((null==e?void 0:e.ty)||0),o.width=i.width,o.height=i.height,H(o)}else{let a=i(t,e),l=r(t,e),h=n(t,e),d=s(t,e);o.x=Math.min(a.x,l.x,h.x,d.x),o.y=Math.min(a.y,l.y,h.y,d.y),o.width=Math.max(a.x,l.x,h.x,d.x)-o.x,o.height=Math.max(a.y,l.y,h.y,d.y)-o.y}return o},t.applyMatrix=function(t,i){let r=new E.Ae;if(i.isSimple())r.x=t.x+i.tx,r.y=t.y+i.ty,r.width=t.width,r.height=t.height,H(r);else{let n=e(t.leftTop,i),s=e(t.rightTop,i),o=e(t.leftBottom,i),a=e(t.rightBottom,i);r.x=Math.min(n.x,s.x,o.x,a.x),r.y=Math.min(n.y,s.y,o.y,a.y),r.width=Math.max(n.x,s.x,o.x,a.x)-r.x,r.height=Math.max(n.y,s.y,o.y,a.y)-r.y}return r},t.getLeftPointFromBounds=function(t,e){let o=i(t,e),a=r(t,e);return[o,a,n(t,e),s(t,e)].sort((t,e)=>t.x-e.x)[0]},t.getTopPointFromBounds=function(t,e){let o=i(t,e),a=r(t,e);return[o,a,n(t,e),s(t,e)].sort((t,e)=>t.y-e.y)[0]},t.getCenter=function(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width/2,y:-(r.height*n.y)+r.height/2},i)},t.getTopLeft=i,t.getTopCenter=function(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width/2,y:-(r.height*n.y)},i)},t.getTopRight=r,t.getLeftCenter=function(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x),y:-(r.height*n.y)+r.height/2},i)},t.getRightCenter=function(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width,y:-(r.height*n.y)+r.height/2},i)},t.getBottomLeft=n,t.getBottomCenter=function(t,i){let{size:r,origin:n}=t;return e({x:-(r.width*n.x)+r.width/2,y:-(r.height*n.y)+r.height},i)},t.getBottomRight=s})(g||(g={}));var W=class extends G{get children(){return this._children||[]}clearChildren(){this._children&&this._children.slice().forEach(t=>{t.setParent(void 0)})}get isContainer(){return!!this._children&&this._children.length>0}fireChange(){this.changeLocked||(this._localID++,this.mutationCache.clear(),super.fireChange())}get localTransform(){return this.updateLocalTransformMatrix(),this._localTransform}get worldTransform(){return this.updateTransformMatrix(),this._worldTransform}getDefaultData(){return E.V_.createDefault(E.hY)}update(t){t.position&&this.entity.updateData(Y,t.position),t.size&&this.entity.updateData(J,t.size),t.origin&&this.entity.updateData($,t.origin),t.scale&&this.entity.updateData(j,t.scale),t.skew&&this.entity.updateData(U,t.skew),void 0!==t.rotation&&this.entity.updateData(X,t.rotation)}get position(){return this.entity.getData(Y)}set position(t){this.entity.updateData(Y,t)}get size(){return this.entity.getData(J)}set size(t){this.entity.updateData(J,t)}get origin(){return this.entity.getData($)}set origin(t){this.entity.updateData($,t)}get scale(){return this.entity.getData(j)}set scale(t){this.entity.updateData(j,t)}get skew(){return this.entity.getData(U)}set skew(t){this.entity.updateData(U,t)}get rotation(){return this.entity.getData(X).data}set rotation(t){this.entity.updateData(X,t)}get data(){return E.pL.toJSON(this)}updateSkew(){let{rotation:t}=this;this._cx=Math.cos(t+this.skew.y),this._sx=Math.sin(t+this.skew.y),this._cy=-Math.sin(t-this.skew.x),this._sy=Math.cos(t-this.skew.x),this._localID++}updateLocalTransformMatrix(){let t=this._localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x,t.ty=this.position.y,this._currentLocalID=this._localID,this._parentID=-1)}get localID(){return this._localID}get worldID(){return this._worldID}updateTransformMatrix(){let t=this._localTransform;this.updateLocalTransformMatrix();let e=E.y3.TEMP_MATRIX,i=0;if(this.parent&&(e=this.parent.worldTransform,i=this.parent._worldID),this._parentID!==i){let r=e,n=this._worldTransform;n.a=t.a*r.a+t.b*r.c,n.b=t.a*r.b+t.b*r.d,n.c=t.c*r.a+t.d*r.c,n.d=t.c*r.b+t.d*r.d,n.tx=t.tx*r.a+t.ty*r.c+r.tx,n.ty=t.tx*r.b+t.ty*r.d+r.ty,this._parentID=i,this._worldID++}}setFromMatrix(t){let{a:e,b:i,c:r,d:n}=t,s=-Math.atan2(-r,n),o=Math.atan2(i,e),a=Math.abs(s+o);a<1e-5||1e-5>Math.abs(E._b-a)?(this.rotation=o,this.skew.x=this.skew.y=0):(this.rotation=0,this.skew.x=s,this.skew.y=o),this.scale.x=Math.sqrt(e*e+i*i),this.scale.y=Math.sqrt(r*r+n*n),this.position.x=t.tx,this.position.y=t.ty,this.fireChange()}getMutationCache(t,e){if(this.mutationCache.has(t))return this.mutationCache.get(t);let i=e();return this.mutationCache.set(t,i),i}get bounds(){if(this.isContainer){let t=this._children;return E.Ae.enlarge(t.map(t=>t.bounds))}return g.getBounds(this,this.worldTransform)}get boundsWithoutRotation(){let{center:t}=this.bounds,{worldScale:e}=this,i=this.localSize,r=e.x*i.width,n=e.y*i.height,s={x:t.x-r/2,y:t.y-n/2};return new E.Ae(s.x,s.y,r,n)}get localSize(){let{size:t}=this;if(this.isContainer){let e=E.Ae.enlarge(this.children.map(t=>t.localBounds));t={width:e.width,height:e.height}}return{width:t.width,height:t.height}}get worldSize(){let{localSize:t}=this,{worldScale:e}=this;return{width:t.width*e.x,height:t.height*e.y}}get localBounds(){if(this.isContainer){let t=this._children,e=E.Ae.enlarge(t.map(t=>t.localBounds));return g.applyMatrix(e,this.localTransform)}return this.getMutationCache("localBounds",()=>g.getBounds(this,this.localTransform))}contains(t,e,i){if(this.isContainer)return this.bounds.contains(t,e);let r=this.worldTransform.applyInverse({x:t,y:e}),{width:n,height:s}=this.size;if(0===n||0===s)return!1;let o=-n*this.origin.x,a=-s*this.origin.y;return i?new E.Cd(o+n/2,a+s/2,Math.min(n/2,s/2)).contains(r.x,r.y):!!(r.x>=o)&&!!(r.x<o+n)&&!!(r.y>=a)&&!!(r.y<a+s)}get parent(){return this._parent}isParent(t){let e=this.parent;for(;e;){if(e===t)return!0;e=e.parent}return!1}isParentTransform(t){let e=this.parent;for(;e;){if(e===t)return!0;e=e.parent}return!1}setParent(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this._parent!==t&&(this.entityDispose&&(this.entityDispose.dispose(),this.entityDispose=void 0),this._parentChangedDispose&&(this._parentChangedDispose.dispose(),this._parentChangedDispose=void 0),this._parentID=-1,t&&e&&(t._children||(t._children=[]),t._children.push(this),this._parentChangedDispose=new E.K4,this.toDispose.push(this._parentChangedDispose),this.entityDispose=this.entity.onDispose(()=>{t.fireChange()}),this._parentChangedDispose.pushAll([t.onDispose(()=>{this.setParent(void 0)}),E.JT.create(()=>{let e=t._children.indexOf(this);-1!==e&&t._children.splice(e,1)})])),this._parent=t,this.fireChange())}intersects(t){return(!!this.isContainer||0!==this.size.width&&0!==this.size.height)&&E.Ae.intersectsWithRotation(this.boundsWithoutRotation,this.worldRotation,t,0)}get worldScale(){let{parent:t}=this,e=t?t.worldScale:{x:1,y:1};return{x:this.scale.x*e.x,y:this.scale.y*e.y}}get worldRotation(){let{parent:t}=this;return t?E.RZ.wrap(this.rotation+t.worldRotation):E.RZ.wrap(this.rotation)}get worldDegree(){return Math.round(this.worldRotation*E.jl)}get localOrigin(){let t=this.localTransform,e=this.localBounds;return t.apply({x:this.origin.x*e.width,y:this.origin.y*e.height})}get worldOrigin(){let t=this.worldTransform,{bounds:e}=this;return t.apply({x:this.origin.x*e.width,y:this.origin.y*e.height})}widthToScaleX(t,e){return t/(e&&this.parent?this.parent.worldScale.x:1)/this.localSize.width}heightToScaleY(t,e){return t/(e&&this.parent?this.parent.worldScale.y:1)/this.localSize.height}sizeToScaleValue(t,e){return{x:this.widthToScaleX(t.width,e),y:this.heightToScaleY(t.height,e)}}constructor(t){super(t),this._worldTransform=new E.y3,this._localTransform=new E.y3,this.mutationCache=new Map,this.sizeToScale=!1,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0,this.bindChange(this.entity.addData(Y)),this.bindChange(this.entity.addData(J)),this.bindChange(this.entity.addData($)),this.bindChange(this.entity.addData(j)),this.bindChange(this.entity.addData(U),()=>this.updateSkew()),this.bindChange(this.entity.addData(X),()=>this.updateSkew())}};W.type="TransformData",(o=W||(W={})).isParentOrChildrenTransform=function(t,e){let i=e.getData(o);if(!i)return!1;for(let e of t.values()){let t=e.getData(o);if(t&&(t.isParent(i)||i.isParent(t)))return!0}return!1};var K=class{push(t,e){let{execMap:i}=this,r=i.get(t);r||(r=(0,S.Z)(e,0),i.set(t,r)),r()}dispose(){this.execMap.clear()}constructor(){this.execMap=new Map}};function Z(t,e,i){let r=document.createEvent("MouseEvent");return r.initMouseEvent(t,!0,!0,void 0,0,0,0,e,i,!1,!1,!1,!1,0,null),r}(a=p||(p={})).isTouchEvent=t=>"touches"in t,a.touchToMouseEvent=t=>{if(!(0,a.isTouchEvent)(t))return t;let e=t.touches[0]||t.changedTouches[0];"touchmove"===t.type&&(0,a.preventDefault)(t);let i={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",touchcancel:"mouseup"}[t.type];if(!i)throw Error(`Unknown touch event type: ${t.type}`);return new MouseEvent(i,{bubbles:t.bubbles,cancelable:t.cancelable,view:t.view,clientX:e.clientX,clientY:e.clientY,screenX:e.screenX,screenY:e.screenY,ctrlKey:t.ctrlKey,altKey:t.altKey,shiftKey:t.shiftKey,metaKey:t.metaKey})},a.getEventCoord=t=>(0,a.isTouchEvent)(t)?0===t.touches.length?{clientX:0,clientY:0}:{clientX:t.touches[0].clientX,clientY:t.touches[0].clientY}:(t instanceof MouseEvent,{clientX:t.clientX,clientY:t.clientY}),a.preventDefault=t=>{t.cancelable&&t.preventDefault()},a.onTouched=(t,e)=>{let i=t.changedTouches[0],r=t=>{let n=t.changedTouches[0],s=n.clientX-i.clientX,o=n.clientY-i.clientY;5>Math.abs(s)&&5>Math.abs(o)&&e((0,a.touchToMouseEvent)(t)),document.removeEventListener("touchend",r),document.removeEventListener("touchcancel",r)};document.addEventListener("touchend",r),document.addEventListener("touchcancel",r)};var Q=class{get isStarted(){return!!this._promise}start(t,e,i,r){if(this._disposed)return Promise.resolve();if(this._promise)return this._promise;this.context=r,this.localId=(0,E.oN)(),this._addListeners(),this._promise=new Promise(t=>{this._resolve=t}),this._playgroundConfigEntity=i;let n=Z("mousedown",t,e);return this._startPos=this.getRelativePos(n),this.onDragStartEmitter.fire(this.getDragEvent(n)),this._promise}stop(t,e){if(this._disposed||!this._promise)return;let i=Z("mouseup",t,e);this.handleEvent(i)}dispose(){this._disposed||(this._stopScrollX(),this._stopScrollY(),this._disposed=!0,this.onDragEmitter.dispose(),this.onDragStartEmitter.dispose(),this.onDragEndEmitter.dispose(),this._finalize())}handleEvent(t){let e=p.touchToMouseEvent(t);switch(e.type){case"mousemove":this._evtMouseMove(e);break;case"mouseup":this._stopScrollX(),this._stopScrollY(),this._evtMouseUp(e);break;case"keydown":this._evtKeyDown(e);break;case"contextmenu":let i=Z("mouseup",e.clientX,e.clientY);this._evtMouseUp(i);break;default:p.preventDefault(e),e.stopPropagation()}}get scale(){return this._playgroundConfigEntity?this._playgroundConfigEntity.finalScale:1}getRelativePos(t){return this._playgroundConfigEntity?this._playgroundConfigEntity.getPosFromMouseEvent(t,!1):{x:t.clientX,y:t.clientY}}getDragEvent(t){let e=this._startPos,{scale:i}=this;switch(t.type){case"mousedown":return this._lastPos=e,Object.assign(t,{id:this.localId,startPos:e,endPos:e,scale:i,movingDelta:{x:0,y:0},isStart:!0,isMoving:!1});case"mousemove":let r=this.getRelativePos(t),n={x:r.x-this._lastPos.x,y:r.y-this._lastPos.y};return this._lastPos=r,Object.assign(t,{id:this.localId,startPos:e,endPos:r,scale:i,isStart:!0,movingDelta:n,isMoving:!0});case"mouseup":return this._lastPos={x:0,y:0},Object.assign(t,{id:this.localId,startPos:e,endPos:this.getRelativePos(t),movingDelta:{x:0,y:0},scale:i,isStart:!1,isMoving:!1});default:throw Error("unknown event")}}_finalize(){let t=this._resolve;this._removeListeners(),this._startPos=void 0,this._promise=void 0,this._resolve=void 0,t&&t()}_evtMouseMove(t){t.preventDefault(),t.stopPropagation(),this._lastMouseMoveEvent=t;let e=this.getDragEvent(t);this._updateDragScroll(e),this.onDragEmitter.fire(e)}_evtMouseUp(t){this._lastMouseMoveEvent=void 0,t.preventDefault(),t.stopPropagation(),(0===t.button||1===t.button)&&(this.onDragEndEmitter.fire(this.getDragEvent(t)),this._finalize())}_evtKeyDown(t){t.preventDefault(),t.stopPropagation(),27===t.keyCode&&this.stop(NaN,NaN)}_addListeners(){document.addEventListener("mousedown",this,!0),document.addEventListener("mousemove",this,!0),document.addEventListener("mouseup",this,!0),document.addEventListener("touchstart",this,!0),document.addEventListener("touchmove",this,{passive:!1}),document.addEventListener("touchend",this,!0),document.addEventListener("touchcancel",this,!0),this._stopGlobalEventNames.forEach(t=>{document.addEventListener(t,this,!0)})}_removeListeners(){document.removeEventListener("mousedown",this,!0),document.removeEventListener("mousemove",this,!0),document.removeEventListener("mouseup",this,!0),document.removeEventListener("touchstart",this,!0),document.removeEventListener("touchmove",this),document.removeEventListener("touchend",this,!0),document.removeEventListener("touchcancel",this,!0),this._stopGlobalEventNames.forEach(t=>{document.removeEventListener(t,this,!0)})}_startScrollX(t,e){if(this._scrollXInterval)return;let i=window.setInterval(()=>{this._scrollXInterval&&this.fireScroll("scrollX",e)},6);this._scrollXInterval={interval:i,origin:t}}_stopScrollX(){this._scrollXInterval&&(clearInterval(this._scrollXInterval.interval),this._scrollXInterval=void 0)}_startScrollY(t,e){if(this._scrollYInterval)return;let i=window.setInterval(()=>{this.fireScroll("scrollY",e)},6);this._scrollYInterval={interval:i,origin:t}}_stopScrollY(){this._scrollYInterval&&(clearInterval(this._scrollYInterval.interval),this._scrollYInterval=void 0)}fireScroll(t,e){let i="scrollY"===t?this._scrollYInterval:this._scrollXInterval;if(!i)return;let r=i.origin=e?i.origin+4:i.origin-4,n=this._playgroundConfigEntity.config[t];this._playgroundConfigEntity.updateConfig({[t]:r});let s=this._playgroundConfigEntity.config[t];if(s!==n){let e=this._lastMouseMoveEvent,r={x:"scrollX"===t?s-i.origin:0,y:"scrollY"===t?s-i.origin:0},n=Z("mousemove",e.clientX+r.x,e.clientY+r.y),o=this.getDragEvent(n);this.onDragEmitter.fire(o)}}constructor(t={}){this.onDragStartEmitter=new E.Q5,this.onDragEndEmitter=new E.Q5,this.onDragEmitter=new E.Q5,this._stopGlobalEventNames=["mouseenter","mouseleave","mouseover","mouseout","contextmenu"],this.onDrag=this.onDragEmitter.event,this.onDragStart=this.onDragStartEmitter.event,this.onDragEnd=this.onDragEndEmitter.event,this._lastPos={x:0,y:0},this._updateDragScroll=t=>{if(!this._playgroundConfigEntity)return;let e=this._playgroundConfigEntity.config,i=t.endPos,{scrollX:r,width:n,height:s,scrollY:o}=e;i.x>n+r-20?this._startScrollX(r,!0):i.x<r+20?this._startScrollX(r,!1):this._stopScrollX(),i.y>s+o-20?this._startScrollY(o,!0):i.y<o+20?this._startScrollY(o,!1):this._stopScrollY()},this._disposed=!1,t.onDragStart&&this.onDragStart(e=>t.onDragStart(e,this.context)),t.onDrag&&this.onDrag(e=>t.onDrag(e,this.context)),t.onDragEnd&&this.onDragEnd(e=>t.onDragEnd(e,this.context)),t.stopGlobalEventNames&&(this._stopGlobalEventNames=t.stopGlobalEventNames)}};(l=Q||(Q={})).startDrag=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};f&&f.stop(NaN,NaN);let r=f=new l({onDragStart(t,e){i.onDragStart&&i.onDragStart(t,e)},onDrag(t,e){i.onDrag&&i.onDrag(t,e)},onDragEnd(t,e){i.onDragEnd&&i.onDragEnd(t,e),r.dispose(),f===r&&(f=void 0)}});return r.start(t,e,i.config,i.context),E.JT.create(()=>{r.stop(0,0),r.dispose(),f===r&&(f=void 0)})};var q=0;function tt(t){q++,requestAnimationFrame(function t(e){q<=0||(requestAnimationFrame(t),D.ZP.update(e))});let e=!1,i=new D.ZP.Tween(t.from).to(t.to,t.duration).easing(t.easing||D.ZP.Easing.Quadratic.Out).onUpdate(()=>{!e&&t.onUpdate&&t.onUpdate(t.from)}).onComplete(()=>{!e&&(e=!0,q--,t.onComplete&&t.onComplete(t.from))}).start();return E.JT.create(()=>{!e&&(e=!0,q--,i.stop(),t.onDispose&&t.onDispose(t.from))})}function te(t){let[e,i]=t.overflow,[r,n]=t._delta,[s,o]=t._direction;(e<0&&r>0&&s<0||e>0&&r<0&&s>0)&&(t._movement[0]=t._movementBound[0]),(i<0&&n>0&&o<0||i>0&&n<0&&o>0)&&(t._movement[1]=t._movementBound[1])}var ti={toVector:(t,e)=>(void 0===t&&(t=e),Array.isArray(t)?t:[t,t]),add:(t,e)=>[t[0]+e[0],t[1]+e[1]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1]],addTo(t,e){t[0]+=e[0],t[1]+=e[1]},subTo(t,e){t[0]-=e[0],t[1]-=e[1]}};function tr(t,e,i){return 0===e||Math.abs(e)===1/0?Math.pow(t,5*i):t*e*i/(e+i*t)}function tn(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.15;return 0===r?Math.max(e,Math.min(t,i)):t<e?-tr(e-t,i-e,r)+e:t>i?+tr(t-i,i-e,r)+i:t}var ts={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function to(t){return t?t[0].toUpperCase()+t.slice(1):""}var ta=["enter","leave"],tl=["gotpointercapture","lostpointercapture"];function th(t){return"touches"in t}function td(t){return th(t)?"touch":"pointerType"in t?t.pointerType:"mouse"}function tu(t){return th(t)?("touchend"===t.type||"touchcancel"===t.type?t.changedTouches:t.targetTouches)[0]:t}function tc(t,e){try{let i=e.clientX-t.clientX,r=e.clientY-t.clientY,n=(e.clientX+t.clientX)/2,s=(e.clientY+t.clientY)/2,o=Math.hypot(i,r);return{angle:-(180*Math.atan2(i,r))/Math.PI,distance:o,origin:[n,s]}}catch{}return null}function tg(t,e){let[i,r]=Array.from(t.touches).filter(t=>e.includes(t.identifier));return tc(i,r)}function tp(t){let e=tu(t);return th(t)?e.identifier:e.pointerId}function tf(t){let e=tu(t);return[e.clientX,e.clientY]}function ty(t){let{deltaX:e,deltaY:i,deltaMode:r}=t;return 1===r?(e*=40,i*=40):2===r&&(e*=800,i*=800),[e,i]}function tm(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return"function"==typeof t?t(...i):t}function tv(){}function tE(t,e){return Object.assign({},e,t||{})}var tb=class{get state(){return this.ctrl.state[this.key]}set state(t){this.ctrl.state[this.key]=t}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){let{state:t,shared:e,ingKey:i,args:r}=this;e[i]=t._active=t.active=t._blocked=t._force=!1,t._step=[!1,!1],t.intentional=!1,t._movement=[0,0],t._distance=[0,0],t._direction=[0,0],t._delta=[0,0],t._bounds=[[-1/0,1/0],[-1/0,1/0]],t.args=r,t.axis=void 0,t.memo=void 0,t.elapsedTime=t.timeDelta=0,t.direction=[0,0],t.distance=[0,0],t.overflow=[0,0],t._movementBound=[!1,!1],t.velocity=[0,0],t.movement=[0,0],t.delta=[0,0],t.timeStamp=0}start(t){let e=this.state,i=this.config;e._active||(this.reset(),this.computeInitial(),e._active=!0,e.target=t.target,e.currentTarget=t.currentTarget,e.lastOffset=i.from?tm(i.from,e):e.offset,e.offset=e.lastOffset,e.startTime=e.timeStamp=t.timeStamp)}computeValues(t){let e=this.state;e._values=t,e.values=this.config.transform(t)}computeInitial(){let t=this.state;t._initial=t._values,t.initial=t.values}compute(t){let{state:e,config:i,shared:r}=this;e.args=this.args;let n=0;if(t&&(e.event=t,i.preventDefault&&t.cancelable&&e.event.preventDefault(),e.type=t.type,r.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,r.locked=!!document.pointerLockElement,Object.assign(r,function(t){let e={};if("buttons"in t&&(e.buttons=t.buttons),"shiftKey"in t){let{shiftKey:i,altKey:r,metaKey:n,ctrlKey:s}=t;Object.assign(e,{shiftKey:i,altKey:r,metaKey:n,ctrlKey:s})}return e}(t)),r.down=r.pressed=r.buttons%2==1||r.touches>0,n=t.timeStamp-e.timeStamp,e.timeStamp=t.timeStamp,e.elapsedTime=e.timeStamp-e.startTime),e._active){let t=e._delta.map(Math.abs);ti.addTo(e._distance,t)}this.axisIntent&&this.axisIntent(t);let[s,o]=e._movement,[a,l]=i.threshold,{_step:h,values:d}=e;if(i.hasCustomTransform?(!1===h[0]&&(h[0]=Math.abs(s)>=a&&d[0]),!1===h[1]&&(h[1]=Math.abs(o)>=l&&d[1])):(!1===h[0]&&(h[0]=Math.abs(s)>=a&&Math.sign(s)*a),!1===h[1]&&(h[1]=Math.abs(o)>=l&&Math.sign(o)*l)),e.intentional=!1!==h[0]||!1!==h[1],!e.intentional)return;let u=[0,0];if(i.hasCustomTransform){let[t,e]=d;u[0]=!1!==h[0]?t-h[0]:0,u[1]=!1!==h[1]?e-h[1]:0}else u[0]=!1!==h[0]?s-h[0]:0,u[1]=!1!==h[1]?o-h[1]:0;this.restrictToAxis&&!e._blocked&&this.restrictToAxis(u);let c=e.offset,g=e._active&&!e._blocked||e.active;g&&(e.first=e._active&&!e.active,e.last=!e._active&&e.active,e.active=r[this.ingKey]=e._active,t&&(e.first&&("bounds"in i&&(e._bounds=tm(i.bounds,e)),this.setup&&this.setup()),e.movement=u,this.computeOffset()));let[p,f]=e.offset,[[y,m],[E,b]]=e._bounds;e.overflow=[p<y?-1:+(p>m),f<E?-1:+(f>b)],e._movementBound[0]=!!e.overflow[0]&&(!1===e._movementBound[0]?e._movement[0]:e._movementBound[0]),e._movementBound[1]=!!e.overflow[1]&&(!1===e._movementBound[1]?e._movement[1]:e._movementBound[1]);let C=e._active&&i.rubberband||[0,0];if(e.offset=function(t,e,i){let[r,n]=e,[s,o]=i,[[a,l],[h,d]]=t;return[tn(r,a,l,s),tn(n,h,d,o)]}(e._bounds,e.offset,C),e.delta=ti.sub(e.offset,c),this.computeMovement(),g&&(!e.last||n>32)){e.delta=ti.sub(e.offset,c);let t=e.delta.map(Math.abs);ti.addTo(e.distance,t),e.direction=e.delta.map(Math.sign),e._direction=e._delta.map(Math.sign),!e.first&&n>0&&(e.velocity=[t[0]/n,t[1]/n],e.timeDelta=n)}}emit(){let t=this.state,e=this.shared,i=this.config;if(t._active||this.clean(),(t._blocked||!t.intentional)&&!t._force&&!i.triggerAllEvents)return;let r=this.handler({...e,...t,[this.aliasKey]:t.values});void 0!==r&&(t.memo=r)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}constructor(t,e,i){this.ctrl=t,this.args=e,this.key=i,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}},tC=class extends tb{reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=ti.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=ti.sub(this.state.offset,this.state.lastOffset)}axisIntent(t){let e=this.state,i=this.config;if(!e.axis&&t){let r="object"==typeof i.axisThreshold?i.axisThreshold[td(t)]:i.axisThreshold;e.axis=function(t,e){let[i,r]=t,n=Math.abs(i),s=Math.abs(r);return n>s&&n>e?"x":s>n&&s>e?"y":void 0}(e._movement,r)}e._blocked=(i.lockDirection||!!i.axis)&&!e.axis||!!i.axis&&i.axis!==e.axis}restrictToAxis(t){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":t[1]=0;break;case"y":t[0]=0}}constructor(){super(...arguments),this.aliasKey="xy"}},tS=class extends tC{wheel(t){this.state._active||this.start(t),this.wheelChange(t),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(t){let e=this.state;e._delta=ty(t),ti.addTo(e._movement,e._delta),te(e),this.compute(t),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){t("wheel","",this.wheel.bind(this))}constructor(){super(...arguments),this.ingKey="wheeling"}},tD=class extends tC{scroll(t){this.state._active||this.start(t),this.scrollChange(t),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(t){t.cancelable&&t.preventDefault();let e=this.state,i=function(t){let{scrollX:e,scrollY:i,scrollLeft:r,scrollTop:n}=t.currentTarget;return[e??r??0,i??n??0]}(t);e._delta=ti.sub(i,e._values),ti.addTo(e._movement,e._delta),this.computeValues(i),this.compute(t),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){t("scroll","",this.scroll.bind(this))}constructor(){super(...arguments),this.ingKey="scrolling"}},t_=class extends tb{init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();let t=this.state;t._touchIds=[],t.canceled=!1,t.cancel=this.cancel.bind(this),t.turns=0}computeOffset(){let{type:t,movement:e,lastOffset:i}=this.state;"wheel"===t?this.state.offset=ti.add(e,i):this.state.offset=[(1+e[0])*i[0],e[1]+i[1]]}computeMovement(){let{offset:t,lastOffset:e}=this.state;this.state.movement=[t[0]/e[0],t[1]-e[1]]}axisIntent(){let t=this.state,[e,i]=t._movement;if(!t.axis){let r=30*Math.abs(e)-Math.abs(i);r<0?t.axis="angle":r>0&&(t.axis="scale")}}restrictToAxis(t){this.config.lockDirection&&("scale"===this.state.axis?t[1]=0:"angle"===this.state.axis&&(t[0]=0))}cancel(){let t=this.state;t.canceled||setTimeout(()=>{t.canceled=!0,t._active=!1,this.compute(),this.emit()},0)}touchStart(t){this.ctrl.setEventIds(t);let e=this.state,i=this.ctrl.touchIds;if(e._active&&e._touchIds.every(t=>i.has(t))||i.size<2)return;this.start(t),e._touchIds=Array.from(i).slice(0,2);let r=tg(t,e._touchIds);r&&this.pinchStart(t,r)}pointerStart(t){if(null!=t.buttons&&t.buttons%2!=1)return;this.ctrl.setEventIds(t),t.target.setPointerCapture(t.pointerId);let e=this.state,i=e._pointerEvents,r=this.ctrl.pointerIds;if(e._active&&Array.from(i.keys()).every(t=>r.has(t))||(i.size<2&&i.set(t.pointerId,t),e._pointerEvents.size<2))return;this.start(t);let n=tc(...Array.from(i.values()));n&&this.pinchStart(t,n)}pinchStart(t,e){this.state.origin=e.origin,this.computeValues([e.distance,e.angle]),this.computeInitial(),this.compute(t),this.emit()}touchMove(t){if(!this.state._active)return;let e=tg(t,this.state._touchIds);e&&this.pinchMove(t,e)}pointerMove(t){let e=this.state._pointerEvents;if(e.has(t.pointerId)&&e.set(t.pointerId,t),!this.state._active)return;let i=tc(...Array.from(e.values()));i&&this.pinchMove(t,i)}pinchMove(t,e){let i=this.state,r=i._values[1],n=e.angle-r,s=0;Math.abs(n)>270&&(s+=Math.sign(n)),this.computeValues([e.distance,e.angle-360*s]),i.origin=e.origin,i.turns=s,i._movement=[i._values[0]/i._initial[0]-1,i._values[1]-i._initial[1]],this.compute(t),this.emit()}touchEnd(t){this.ctrl.setEventIds(t),this.state._active&&this.state._touchIds.some(t=>!this.ctrl.touchIds.has(t))&&(this.state._active=!1,this.compute(t),this.emit())}pointerEnd(t){let e=this.state;this.ctrl.setEventIds(t);try{t.target.releasePointerCapture(t.pointerId)}catch{}e._pointerEvents.has(t.pointerId)&&e._pointerEvents.delete(t.pointerId),e._active&&e._pointerEvents.size<2&&(e._active=!1,this.compute(t),this.emit())}gestureStart(t){t.cancelable&&t.preventDefault();let e=this.state;e._active||(this.start(t),this.computeValues([t.scale,t.rotation]),e.origin=[t.clientX,t.clientY],this.compute(t),this.emit())}gestureMove(t){if(t.cancelable&&t.preventDefault(),!this.state._active)return;let e=this.state;this.computeValues([t.scale,t.rotation]),e.origin=[t.clientX,t.clientY];let i=e._movement;e._movement=[t.scale-1,t.rotation],e._delta=ti.sub(e._movement,i),this.compute(t),this.emit()}gestureEnd(t){this.state._active&&(this.state._active=!1,this.compute(t),this.emit())}wheel(t){let e=this.config.modifierKey;(!e||(Array.isArray(e)?e.find(e=>t[e]):t[e]))&&(this.state._active?this.wheelChange(t):this.wheelStart(t),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(t){this.start(t),this.wheelChange(t)}wheelChange(t){"uv"in t||t.cancelable&&t.preventDefault();let e=this.state,i=-ty(t)[1]/100*e.offset[0];Math.abs(i)>.1&&(i=.1*Math.sign(i)),e._delta=[i,0],ti.addTo(e._movement,e._delta),te(e),this.state.origin=[t.clientX,t.clientY],this.compute(t),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){let e=this.config.device;e&&(t(e,"start",this[e+"Start"].bind(this)),t(e,"change",this[e+"Move"].bind(this)),t(e,"end",this[e+"End"].bind(this)),t(e,"cancel",this[e+"End"].bind(this)),t("lostPointerCapture","",this[e+"End"].bind(this))),this.config.pinchOnWheel&&t("wheel","",this.wheel.bind(this),{passive:!1})}constructor(){super(...arguments),this.ingKey="pinching",this.aliasKey="da"}},tw=class extends tC{move(t){this.config.mouseOnly&&"mouse"!==t.pointerType||(this.state._active?this.moveChange(t):this.moveStart(t),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(t){this.start(t),this.computeValues(tf(t)),this.compute(t),this.computeInitial(),this.emit()}moveChange(t){if(!this.state._active)return;let e=tf(t),i=this.state;i._delta=ti.sub(e,i._values),ti.addTo(i._movement,i._delta),this.computeValues(e),this.compute(t),this.emit()}moveEnd(t){this.state._active&&(this.state._active=!1,this.compute(t),this.emit())}bind(t){t("pointer","change",this.move.bind(this)),t("pointer","leave",this.moveEnd.bind(this))}constructor(){super(...arguments),this.ingKey="moving"}},tx=class extends tC{enter(t){this.config.mouseOnly&&"mouse"!==t.pointerType||(this.start(t),this.computeValues(tf(t)),this.compute(t),this.emit())}leave(t){if(this.config.mouseOnly&&"mouse"!==t.pointerType)return;let e=this.state;if(!e._active)return;e._active=!1;let i=tf(t);e._movement=e._delta=ti.sub(i,e._values),this.computeValues(i),this.compute(t),e.delta=e.movement,this.emit()}bind(t){t("pointer","enter",this.enter.bind(this)),t("pointer","leave",this.leave.bind(this))}constructor(){super(...arguments),this.ingKey="hovering"}},tN=t=>t,tM={enabled(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return t},eventOptions:(t,e,i)=>({...i.shared.eventOptions,...t}),preventDefault(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return t},triggerAllEvents(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return t},rubberband(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;switch(t){case!0:return[.15,.15];case!1:return[0,0];default:return ti.toVector(t)}},from:t=>"function"==typeof t?t:null!=t?ti.toVector(t):void 0,transform(t,e,i){let r=t||i.shared.transform;return this.hasCustomTransform=!!r,r||tN},threshold:t=>ti.toVector(t,0)},tI={...tM,axis(t,e,i){let{axis:r}=i;if(this.lockDirection="lock"===r,!this.lockDirection)return r},axisThreshold(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return t},bounds(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("function"==typeof t)return e=>tI.bounds(t(e));if("current"in t)return()=>t.current;if("function"==typeof HTMLElement&&t instanceof HTMLElement)return t;let{left:e=-1/0,right:i=1/0,top:r=-1/0,bottom:n=1/0}=t;return[[e,i],[r,n]]}},tT={ArrowRight:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return[t*e,0]},ArrowLeft:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return[-1*t*e,0]},ArrowUp:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return[0,-1*t*e]},ArrowDown:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return[0,t*e]}},tL=class extends tC{reset(){super.reset();let t=this.state;t._pointerId=void 0,t._pointerActive=!1,t._keyboardActive=!1,t._preventScroll=!1,t._delayed=!1,t.swipe=[0,0],t.tap=!1,t.canceled=!1,t.cancel=this.cancel.bind(this)}setup(){let t=this.state;if(t._bounds instanceof HTMLElement){let e=t._bounds.getBoundingClientRect(),i=t.currentTarget.getBoundingClientRect(),r={left:e.left-i.left+t.offset[0],right:e.right-i.right+t.offset[0],top:e.top-i.top+t.offset[1],bottom:e.bottom-i.bottom+t.offset[1]};t._bounds=tI.bounds(r)}}cancel(){let t=this.state;t.canceled||(t.canceled=!0,t._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(t){let e=this.config,i=this.state;if(null!=t.buttons&&(Array.isArray(e.pointerButtons)?!e.pointerButtons.includes(t.buttons):-1!==e.pointerButtons&&e.pointerButtons!==t.buttons))return;let r=this.ctrl.setEventIds(t);e.pointerCapture&&t.target.setPointerCapture(t.pointerId),r&&r.size>1&&i._pointerActive||(this.start(t),this.setupPointer(t),i._pointerId=tp(t),i._pointerActive=!0,this.computeValues(tf(t)),this.computeInitial(),e.preventScrollAxis&&"mouse"!==td(t)?(i._active=!1,this.setupScrollPrevention(t)):e.delay>0?(this.setupDelayTrigger(t),e.triggerAllEvents&&(this.compute(t),this.emit())):this.startPointerDrag(t))}startPointerDrag(t){let e=this.state;e._active=!0,e._preventScroll=!0,e._delayed=!1,this.compute(t),this.emit()}pointerMove(t){let e=this.state,i=this.config;if(!e._pointerActive)return;let r=tp(t);if(void 0!==e._pointerId&&r!==e._pointerId)return;let n=tf(t);if(document.pointerLockElement===t.target?e._delta=[t.movementX,t.movementY]:(e._delta=ti.sub(n,e._values),this.computeValues(n)),ti.addTo(e._movement,e._delta),this.compute(t),e._delayed&&e.intentional){this.timeoutStore.remove("dragDelay"),e.active=!1,this.startPointerDrag(t);return}if(i.preventScrollAxis&&!e._preventScroll)if(!e.axis)return;else if(e.axis===i.preventScrollAxis||"xy"===i.preventScrollAxis){e._active=!1,this.clean();return}else{this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(t);return}this.emit()}pointerUp(t){this.ctrl.setEventIds(t);try{this.config.pointerCapture&&t.target.hasPointerCapture(t.pointerId)&&t.target.releasePointerCapture(t.pointerId)}catch{}let e=this.state,i=this.config;if(!e._active||!e._pointerActive)return;let r=tp(t);if(void 0!==e._pointerId&&r!==e._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(t);let[n,s]=e._distance;if(e.tap=n<=i.tapsThreshold&&s<=i.tapsThreshold,e.tap&&i.filterTaps)e._force=!0;else{let[t,r]=e._delta,[n,s]=e._movement,[o,a]=i.swipe.velocity,[l,h]=i.swipe.distance,d=i.swipe.duration;if(e.elapsedTime<d){let i=Math.abs(t/e.timeDelta),d=Math.abs(r/e.timeDelta);i>o&&Math.abs(n)>l&&(e.swipe[0]=Math.sign(t)),d>a&&Math.abs(s)>h&&(e.swipe[1]=Math.sign(r))}}this.emit()}pointerClick(t){!this.state.tap&&t.detail>0&&(t.preventDefault(),t.stopPropagation())}setupPointer(t){let e=this.config,i=e.device;e.pointerLock&&t.currentTarget.requestPointerLock(),e.pointerCapture||(this.eventStore.add(this.sharedConfig.window,i,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(t){this.state._preventScroll&&t.cancelable&&t.preventDefault()}setupScrollPrevention(t){var e;this.state._preventScroll=!1,"persist"in(e=t)&&"function"==typeof e.persist&&e.persist();let i=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",i),this.eventStore.add(this.sharedConfig.window,"touch","cancel",i),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,t)}setupDelayTrigger(t){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(t)},this.config.delay)}keyDown(t){let e=tT[t.key];if(e){let i=this.state,r=t.shiftKey?10:t.altKey?.1:1;this.start(t),i._delta=e(this.config.keyboardDisplacement,r),i._keyboardActive=!0,ti.addTo(i._movement,i._delta),this.compute(t),this.emit()}}keyUp(t){t.key in tT&&(this.state._keyboardActive=!1,this.setActive(),this.compute(t),this.emit())}bind(t){let e=this.config.device;t(e,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(t(e,"change",this.pointerMove.bind(this)),t(e,"end",this.pointerUp.bind(this)),t(e,"cancel",this.pointerUp.bind(this)),t("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(t("key","down",this.keyDown.bind(this)),t("key","up",this.keyUp.bind(this))),this.config.filterTaps&&t("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}constructor(){super(...arguments),this.ingKey="dragging"}},tP="undefined"!=typeof window&&window.document&&window.document.createElement;function tR(){return tP&&"ontouchstart"in window}var tA={isBrowser:tP,gesture:function(){try{return"constructor"in GestureEvent}catch(t){return!1}}(),touch:tR(),touchscreen:tR()||tP&&window.navigator.maxTouchPoints>1,pointer:tP&&"onpointerdown"in window,pointerLock:tP&&"exitPointerLock"in window.document},tk={...tM,device(t,e,i){let{shared:r,pointer:{touch:n=!1}={}}=i;if(r.target&&!tA.touch&&tA.gesture)return"gesture";if(tA.touch&&n)return"touch";if(tA.touchscreen){if(tA.pointer)return"pointer";if(tA.touch)return"touch"}},bounds(t,e,i){let{scaleBounds:r={},angleBounds:n={}}=i,s=t=>{let e=tE(tm(r,t),{min:-1/0,max:1/0});return[e.min,e.max]},o=t=>{let e=tE(tm(n,t),{min:-1/0,max:1/0});return[e.min,e.max]};return"function"!=typeof r&&"function"!=typeof n?[s(),o()]:t=>[s(t),o(t)]},threshold(t,e,i){return this.lockDirection="lock"===i.axis,ti.toVector(t,this.lockDirection?[.1,3]:0)},modifierKey:t=>void 0===t?"ctrlKey":t,pinchOnWheel(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return t}},tO={...tI,mouseOnly:function(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return t}},tV={...tI,mouseOnly:function(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return t}},tB={mouse:0,touch:0,pen:8},tF={...tI,device(t,e,i){let{pointer:{touch:r=!1,lock:n=!1,mouse:s=!1}={}}=i;return(this.pointerLock=n&&tA.pointerLock,tA.touch&&r)?"touch":this.pointerLock?"mouse":tA.pointer&&!s?"pointer":tA.touch?"touch":"mouse"},preventScrollAxis(t,e,i){let{preventScroll:r}=i;if(this.preventScrollDelay="number"==typeof r?r:r||void 0===r&&t?250:void 0,tA.touchscreen&&!1!==r)return t||(void 0!==r?"y":void 0)},pointerCapture(t,e,i){let{pointer:{capture:r=!0,buttons:n=1,keys:s=!0}={}}=i;return this.pointerButtons=n,this.keys=s,!this.pointerLock&&"pointer"===this.device&&r},threshold(t,e,i){let{filterTaps:r=!1,tapsThreshold:n=3,axis:s}=i,o=ti.toVector(t,r?n:+!!s);return this.filterTaps=r,this.tapsThreshold=n,o},swipe(){let{velocity:t=.5,distance:e=50,duration:i=250}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{velocity:this.transform(ti.toVector(t)),distance:this.transform(ti.toVector(e)),duration:i}},delay(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;switch(t){case!0:return 180;case!1:return 0;default:return t}},axisThreshold:t=>t?{...tB,...t}:tB,keyboardDisplacement(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;return t}},tz=new Map,tG=new Map;function t$(t){tz.set(t.key,t.engine),tG.set(t.key,t.resolver)}var tY={key:"drag",engine:tL,resolver:tF},tX={key:"hover",engine:tx,resolver:tV},tj={key:"move",engine:tw,resolver:tO},tJ={key:"pinch",engine:t_,resolver:tk},tU={key:"scroll",engine:tD,resolver:tI},tH={key:"wheel",engine:tS,resolver:tI},tW=class{add(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:140;for(var r=arguments.length,n=Array(r>3?r-3:0),s=3;s<r;s++)n[s-3]=arguments[s];this.remove(t),this._timeouts.set(t,window.setTimeout(e,i,...n))}remove(t){let e=this._timeouts.get(t);e&&window.clearTimeout(e)}clean(){this._timeouts.forEach(t=>void window.clearTimeout(t)),this._timeouts.clear()}constructor(){this._timeouts=new Map}},tK=class{add(t,e,i,r,n){let s=this._listeners,o=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=ts[t];return t+(i&&i[e]||e)}(e,i),a={...this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},...n};t.addEventListener(o,r,a);let l=()=>{t.removeEventListener(o,r,a),s.delete(l)};return s.add(l),l}clean(){this._listeners.forEach(t=>t()),this._listeners.clear()}constructor(t,e){this._listeners=new Set,this._ctrl=t,this._gestureKey=e}},tZ={target(t){if(t)return()=>"current"in t?t.current:t},enabled(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return t},window(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:tA.isBrowser?window:void 0;return t},eventOptions(){let{passive:t=!0,capture:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{passive:t,capture:e}},transform:t=>t};function tQ(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0,i={};for(let[r,n]of Object.entries(e))switch(typeof n){case"function":i[r]=n.call(i,t[r],r,t);break;case"object":i[r]=tQ(t[r],n);break;case"boolean":n&&(i[r]=t[r])}return i}var tq=class{setEventIds(t){if(th(t))return this.touchIds=new Set(Array.from(t.touches).filter(e=>{var i,r;return e.target===t.currentTarget||(null==(r=t.currentTarget)||null==(i=r.contains)?void 0:i.call(r,e.target))}).map(t=>t.identifier)),this.touchIds;if("pointerId"in t)return"pointerup"===t.type||"pointercancel"===t.type?this.pointerIds.delete(t.pointerId):"pointerdown"===t.type&&this.pointerIds.add(t.pointerId),this.pointerIds}applyHandlers(t,e){this.handlers=t,this.nativeHandlers=e}applyConfig(t,e){this.config=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{target:r,eventOptions:n,window:s,enabled:o,transform:a,...l}=t;if(i.shared=tQ({target:r,eventOptions:n,window:s,enabled:o,transform:a},tZ),e){let t=tG.get(e);i[e]=tQ({shared:i.shared,...l},t)}else for(let t in l){let e=tG.get(t);e&&(i[t]=tQ({shared:i.shared,...l[t]},e))}return i}(t,e,this.config)}clean(){for(let t of(this._targetEventStore.clean(),this.gestures))this.gestureEventStores[t].clean(),this.gestureTimeoutStores[t].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(){let t;for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];let n=this.config.shared,s={};if(!n.target||(t=n.target())){if(n.enabled){for(let e of this.gestures){let r=this.config[e],n=t1(s,r.eventOptions,!!t);r.enabled&&new(tz.get(e))(this,i,e).bind(n)}let e=t1(s,n.eventOptions,!!t);for(let t in this.nativeHandlers)e(t,"",e=>this.nativeHandlers[t]({...this.state.shared,event:e,args:i}),void 0,!0)}for(let t in s)s[t]=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return 0===e.length?tv:1===e.length?e[0]:function(){let t;for(let i of e)t=i.apply(this,arguments)||t;return t}}(...s[t]);if(!t)return s;for(let e in s){let{device:i,capture:r,passive:n}=function(t){let e=t.substring(2).toLowerCase(),i=!!~e.indexOf("passive");i&&(e=e.replace("passive",""));let r=tl.includes(e)?"capturecapture":"capture",n=!!~e.indexOf(r);return n&&(e=e.replace("capture","")),{device:e,capture:n,passive:i}}(e);this._targetEventStore.add(t,i,"",s[e],{capture:r,passive:n})}}}constructor(t){this.gestures=new Set,this._targetEventStore=new tK(this),this.gestureEventStores={},this.gestureTimeoutStores={},this.handlers={},this.config={},this.pointerIds=new Set,this.touchIds=new Set,this.state={shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}},function(t,e){e.drag&&t0(t,"drag"),e.wheel&&t0(t,"wheel"),e.scroll&&t0(t,"scroll"),e.move&&t0(t,"move"),e.pinch&&t0(t,"pinch"),e.hover&&t0(t,"hover")}(this,t)}};function t0(t,e){t.gestures.add(e),t.gestureEventStores[e]=new tK(t,e),t.gestureTimeoutStores[e]=new tW}var t1=(t,e,i)=>function(r,n,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=o.capture??e.capture,h=o.passive??e.passive,d=a?r:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=ts[t],n=r&&r[e]||e;return"on"+to(t)+to(n)+(!function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1?arguments[1]:void 0;return t&&!ta.includes(e)}(i,n)?"":"Capture")}(r,n,l);i&&h&&(d+="Passive"),t[d]=t[d]||[],t[d].push(s)},t2=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function t3(t,e,i,r,n,s){if(!t.has(i)||!tz.has(r))return;let o=i+"Start",a=i+"End";n[r]=t=>{let r;return t.first&&o in e&&e[o](t),i in e&&(r=e[i](t)),t.last&&a in e&&e[a](t),r},s[r]=s[r]||{}}var t5=class{destroy(){this._ctrl.clean()}setConfig(t){this._ctrl.clean(),this._ctrl.applyConfig({...t,target:this._target},this._gestureKey),this._ctrl.effect()}constructor(t,e,i,r,n){this._target=t,this._gestureKey=r,this._ctrl=new tq(e),this._ctrl.applyHandlers(e,n),this._ctrl.applyConfig({...i,target:t},r),this._ctrl.effect()}},t4=function(t,e,i){return([tY,tJ,tU,tH,tj,tX].forEach(t$),function(t,e,i){let{handlers:r,nativeHandlers:n,config:s}=function(t,e){let[i,r,n]=function(t){let e={},i={},r=new Set;for(let n in t)t2.test(n)?(r.add(RegExp.lastMatch),i[n]=t[n]):e[n]=t[n];return[i,e,r]}(t),s={};return t3(n,i,"onDrag","drag",s,e),t3(n,i,"onWheel","wheel",s,e),t3(n,i,"onScroll","scroll",s,e),t3(n,i,"onPinch","pinch",s,e),t3(n,i,"onMove","move",s,e),t3(n,i,"onHover","hover",s,e),{handlers:s,config:e,nativeHandlers:r}}(e,i||{});return new t5(t,r,s,void 0,n)})(t,e,i||{})},t9=class extends E.Pq{handlePinch(t){let{first:e,last:i,originX:r,originY:n,newScale:s}=t;if(Number.isNaN(t.newScale))return;e&&(this._pinching=!0),i&&(this._pinching=!1);let o=this.config.finalScale,a=this.config.getPosFromMouseEvent({clientX:r,clientY:n},!1),l={x:a.x/o*s,y:a.y/o*s};this.config.updateConfig({scrollX:this.config.config.scrollX+l.x-a.x,scrollY:this.config.config.scrollY+l.y-a.y,zoom:s})}getScaleBounds(){return{min:this.config.config.minZoom,max:this.config.config.maxZoom}}preventDefault(){let t=t=>t.preventDefault();document.addEventListener("gesturestart",t),document.addEventListener("gesturechange",t),this.toDispose.push(E.JT.create(()=>{document.removeEventListener("gesturestart",t),document.removeEventListener("gesturechange",t)}))}get pinching(){return this._pinching}constructor(t,e){super(),this.target=t,this.config=e,this._pinching=!1,this.preventDefault();let i=new t4(t,{onPinch:t=>{let{origin:[e,i],first:r,last:n,movement:[s],offset:[o,a]}=t;this.handlePinch({first:r,last:n,originX:e,originY:i,newScale:o})}},{pinch:{scaleBounds:()=>this.getScaleBounds(),from:()=>[this.config.finalScale,0],modifierKey:["metaKey","ctrlKey"]}});this.toDispose.push(E.JT.create(()=>{i.destroy()}))}},t8=Symbol("LazyInjectContext"),t6=Symbol("IS_LAZY_INJECT_CONTEXT_INJECTED"),t7=t=>function(e,i){if(!t)throw Error(`ServiceIdentifier ${t} in @lazyInject is Empty, it might be caused by file circular dependency, please check it.`);return Reflect.hasMetadata(t6,e)||((0,C.f3)(t8)(e,t8),Reflect.defineMetadata(t6,!0,e)),{get(){return this[t8].get(t)},set(){},configurable:!0,enumerable:!0}},et=Symbol("PlaygroundContext"),ee=Symbol("PlaygroundContextProvider"),ei=()=>function(t,e){let i=`${e}Provider`;return(0,C.f3)(ee)(t,i),(0,C.jt)()(t,i),{get(){var t;return null==(t=this[i])?void 0:t.call(this)},configurable:!0,enumerable:!0}},er=Symbol("PlaygroundContainerFactory"),en=Symbol("EntityManagerContribution"),es=class extends z{getDefaultConfig(){return{}}checkChanged(t,e){return z.checkDataChanged(t,e)}get config(){return this.getData(this.ConfigDataRegistry).data}updateConfig(t){this.updateData(this.ConfigDataRegistry,t)}onConfigChanged(t){return this.getData(this.ConfigDataRegistry).onDataChange(e=>t(e.data))}constructor(t){super(t),this.isInitialized=!0,this.ConfigDataRegistry=function(t){class e extends G{getDefaultData(){return t.getDefaultConfig()}checkChanged(e){return t.checkChanged(this.data,e)}toJSON(){return super.toJSON()}}return Object.defineProperty(e,"type",{value:`_${t.type}DataMixin`}),e}(this),this.addData(this.ConfigDataRegistry),this.isInitialized=!1}};es.type="ConfigEntity";var eo=class{init(){this.contributions.forEach(t=>{var e;return null==(e=t.registerEntityManager)?void 0:e.call(t,this)})}createEntity(t,e){if(!t.type)throw Error(`[EntityManager] createEntity need a type: ${t}`);if(this.configEntities.has(t.type))return this.configEntities.get(t.type);let i={entityManager:this,savedInManager:!0,...e},r=new t(i);return i.savedInManager&&this.saveEntity(r),r}isConfigEntity(t){return this.configEntities.has(t)}removeEntities(t){for(let e of this.getEntities(t).values())e.dispose()}removeEntityById(t){let e=this.getEntityById(t);return!!e&&(e.dispose(),!0)}resetEntities(t){this.getEntities(t).forEach(t=>{t.reset()})}resetEntity(t,e){let i=this.getEntity(t,e);null==i||i.reset()}updateConfigEntity(t,e){let i=this.configEntities.get(t.type);i&&i.updateConfig(e)}getRegistryByType(t){return this.registryMap.get(t)}registerEntity(t){if(!t.type)throw Error(`Registry entity need a type: ${t.name}`);let e=this.registryMap.get(t.type);if(e){if(e!==t)throw Error(`Entity registry ${t.type} need a new type`);return}this.registryMap.set(t.type,t)}registerEntityData(t,e){if(!t.type)throw Error(`Registry entity data need a type: ${t.name}`);this.dataRegistryMap.get(t.type)||this.dataRegistryMap.set(t.type,t),!this.dataInjectorMap.get(t.type)&&e&&this.dataInjectorMap.set(t.type,e)}getDataRegistryByType(t){return this.dataRegistryMap.get(t)}getEntityById(t){return this.entityInstanceMap.get(t)}getEntity(t,e){let i=this.getEntities(t)[0];return!i&&e?this.createEntity(t):i}getEntities(t){return this.entityInstanceMapByType.get(t.type)||[]}getEntityDatas(t,e){return this.getEntities(t).map(t=>t.getData(e)).filter(t=>!!t)}hasEntity(t){return!!this.getEntity(t)}storeState(){let{configOnly:t=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=[];for(let i of this.entityInstanceMap.values())if((!t||i instanceof es)&&i.toJSON&&i.toJSON){let t=i.toJSON();t&&e.push(t)}return e}restoreState(t){t&&Array.isArray(t)&&t.forEach(t=>{if(!t||!t.type||!t.id)return;let e=this.getRegistryByType(t.type);if(!e)return void console.warn(`Playground entity registry lost: ${t.type}`);let i=this.createEntity(e,{id:t.id});i.fromJSON&&i.fromJSON(t)})}saveEntity(t){let{id:e}=t;if(e&&this.entityInstanceMap.has(e))return void console.error(`Entity ${t.type} ${e} is created before`);this.entityInstanceMap.set(t.id,t);let i=this.entityInstanceMapByType.get(t.type);i||(i=[],this.entityInstanceMapByType.set(t.type,i)),t instanceof es&&this.configEntities.set(t.type,t),i.push(t),t.onEntityChange(t=>{this.fireEntityChanged(t),this.fireEntityLifeCycleChanged({type:"update",entity:t})}),t.onDataChange(e=>{this.fireEntityDataChanged(t.type,e.data.type)}),t.toDispose.push(E.JT.create(()=>{this.removeEntity(t),this.fireEntityLifeCycleChanged({type:"delete",entity:t})})),t.getDefaultDataRegistries().forEach(e=>this.fireEntityDataChanged(t.type,e.type)),this.fireEntityChanged(t),this.fireEntityLifeCycleChanged({type:"add",entity:t})}removeEntity(t){if(this.entityInstanceMap.has(t.id)&&this.entityInstanceMapByType.has(t.type)){let e=this.entityInstanceMapByType.get(t.type);-1!==e.indexOf(t)&&(this.entityInstanceMapByType.set(t.type,e.filter(e=>e!==t)),this.entityInstanceMap.delete(t.id),this.configEntities.has(t.type)&&this.configEntities.delete(t.type),this.fireEntityChanged(t))}}reset(){for(let t of this.entityInstanceMap.values())t.reset()}getEntityVersion(t){return this.entityVersionMap.get("string"==typeof t?t:t.type)||0}getEntityDataVersion(t){return this.entityDataVersionMap.get("string"==typeof t?t:t.type)||0}dispose(){this.toDispose.dispose()}getDataInjector(t){return this.dataInjectorMap.get("string"==typeof t?t:t.type)}getService(t){var e;return null==(e=this.containerFactory)?void 0:e.get(t)}constructor(){this.toDispose=new E.K4,this.onEntityChangeEmitter=new E.Q5,this.onEntityLifeCycleEmitter=new E.Q5,this.onEntityDataChangeEmitter=new E.Q5,this.registryMap=new Map,this.dataRegistryMap=new Map,this.dataInjectorMap=new Map,this.entityInstanceMap=new Map,this.entityVersionMap=new Map,this.entityDataVersionMap=new Map,this.entityInstanceMapByType=new Map,this.configEntities=new Map,this.onEntityChange=this.onEntityChangeEmitter.event,this.onEntityDataChange=this.onEntityDataChangeEmitter.event,this.onEntityLifeCycleChange=this.onEntityLifeCycleEmitter.event,this.changeEntityLocked=!1,this.schedule=new K,this.fireEntityChanged=t=>{let e="string"==typeof t?t:t.type,i=this.entityVersionMap.get(e)||0;i===Number.MAX_SAFE_INTEGER&&(i=0),this.entityVersionMap.set(e,i+1),this.changeEntityLocked||this.schedule.push(e,()=>{this.onEntityChangeEmitter.fire(e)})},this.fireEntityDataChanged=(t,e)=>{let i=this.entityDataVersionMap.get(e)||0;i===Number.MAX_SAFE_INTEGER&&(i=0),this.entityDataVersionMap.set(e,i+1),this.schedule.push(`${t}/${e}`,()=>{this.onEntityDataChangeEmitter.fire({entityType:t,entityDataType:e})})},this.fireEntityLifeCycleChanged=t=>{let{type:e,entity:i}=t;this.schedule.push(`${e}/${i.id}`,()=>{this.onEntityLifeCycleEmitter.fire({type:e,entity:i})})},this.toDispose.pushAll([this.onEntityChangeEmitter,this.schedule])}};O([(0,C.nx)(en),(0,C.jt)()],eo.prototype,"contributions",2),O([ei()],eo.prototype,"context",2),O([(0,C.f3)(er),(0,C.jt)()],eo.prototype,"containerFactory",2),O([(0,C.zY)()],eo.prototype,"init",1),eo=O([(0,C.b2)()],eo);var ea=Symbol("EntitiesDecorator"),el=Symbol("EntitiesByDataDecorator"),eh=Symbol("PropertiesInjected");function ed(t,e){return Reflect.getMetadata(e,t.prototype)||[]}function eu(t){return Reflect.getMetadata(eh,t)||[]}function ec(t,e,i,r){return(n,s)=>{let o=Reflect.getMetadata(t,n);if(o||Reflect.defineMetadata(t,o=[],n),Array.isArray(e)||(e=[e]),e.forEach(t=>{o.includes(t)||o.push(t)}),r&&r(n,s),s&&i){let t=eu(n);return t.push(s),Reflect.defineMetadata(eh,t,n),{enumerable:!1,configurable:!1,get(){return i(this,s)}}}}}function eg(t){return ec(ea,t,e=>e.observeManager.get(t))}function ep(t){return ec(ea,t,e=>e.observeManager.getEntities(t))}function ef(t,e){return ec(el,{entity:t,data:e},i=>i.observeManager.getEntityDatas(t,e))}var ey=Symbol("ProtectWheelArea"),em=((h=em||{})[h.BASE_LAYER=-2]="BASE_LAYER",h[h.TOOL_LAYER=-1]="TOOL_LAYER",h[h.NORMAL_LAYER=0]="NORMAL_LAYER",h),ev=Symbol("PipelineLayerFactory"),eE=class{get selection(){return this.currentSelection}isEmpty(){return 0===this.currentSelection.length}set selection(t){E.XJ.isArrayShallowChanged(this.currentSelection,t)&&(this.disposers.forEach(t=>t.dispose()),this.changeSelection(t),this.disposers=this.currentSelection.map(t=>t.onDispose(()=>{let e=this.currentSelection.filter(e=>e!==t);this.changeSelection(e)})))}changeSelection(t){this.currentSelection=t,this.onSelectionChangedEmitter.fire(this.currentSelection)}dispose(){this.onSelectionChangedEmitter.dispose()}constructor(){this.onSelectionChangedEmitter=new E.Q5,this.onSelectionChanged=this.onSelectionChangedEmitter.event,this.currentSelection=[],this.disposers=[]}};eE=O([(0,C.b2)()],eE);var eb=Symbol("StorageService"),eC=class{setData(t,e){this.storage[this.prefix(t)]=JSON.stringify(e)}getData(t,e){let i=this.storage[this.prefix(t)];return void 0===i?e:JSON.parse(i)}prefix(t){return`${this._prefix}${t}`}setPrefix(t){this._prefix=t}init(){"undefined"!=typeof window&&window.localStorage?this.storage=window.localStorage:this.storage={}}constructor(){this._prefix="__gedit:"}};O([(0,C.zY)()],eC.prototype,"init",1),eC=O([(0,C.b2)()],eC);var eS=Symbol("ClipboardService"),eD=class{readText(){return this._currentData}writeText(t){this._currentData!==t&&(this._currentData=t,this.onClipboardChangedEmitter.fire(t))}constructor(){this.onClipboardChangedEmitter=new E.Q5,this.onClipboardChanged=this.onClipboardChangedEmitter.event}};eD=O([(0,C.b2)()],eD);var e_=class{get rightPanelVisible(){return this.isRightPanelVisible}set rightPanelVisible(t){this.isRightPanelVisible=t}};e_=O([(0,C.b2)()],e_);var ew=class{onAllLayersRendered(){this.onLoggerEmitter.fire({event:0})}onFlushRequest(t){t<=0||this.onLoggerEmitter.fire({event:1,props:{rfi:t,fps:1e3/t}})}dispose(){this.onLoggerEmitter.dispose()}constructor(){this.onLoggerEmitter=new E.Q5,this.onLogger=this.onLoggerEmitter.event}};function ex(t){let{originRenderer:e,renderedCb:i}=t;return(0,_.useEffect)(()=>{i()},[]),e()||null}ew=O([(0,C.b2)()],ew);var eN=class{subscribeEntities(t,e){let i=this.getSelector(t);e.forEach(e=>{i.entities.includes(e)||i.entities.push(e);let r=this.entityLayerMap.get(e.type);r||(r=new Set,this.entityLayerMap.set(e.type,r)),r.add(t)})}subscribleEntityByData(t,e,i){let r=this.getSelector(t),n=this.entityLayerMap.get(e.type);n||(n=new Set,this.entityLayerMap.set(e.type,n)),n.add(t);let s=[e,i];r.datas.find(t=>t[0]===e&&t[1]===i)||r.datas.push(s)}getSelector(t){let e=this.layerEntitiesSelectorMap.get(t);return e||(e={entities:[],datas:[]},this.layerEntitiesSelectorMap.set(t,e)),e}getLayerEntities(t){let e=this.layerEntitiesSelectorMap.get(t);if(!e)return{entities:[],changed:!1};let i=new Set,r=new Map,n=!1;e.entities.forEach(t=>{let e=this.entityManager.getEntities(t),n=this.entityManager.getEntityVersion(t);for(let s of(r.set(t.type,n),e))i.add(s)});let s=[];for(let t of i.values())s.push(t);return eM(r,e.lastEntityVersion)&&(e.lastEntityVersion=r,n=!0),{entities:s,changed:n}}getLayerEntityDatas(t){let e=this.layerEntitiesSelectorMap.get(t);if(!e)return{datas:[],changed:!1};let i=[],r=new Map,n=!1;return e.datas.forEach(t=>{let[e,n]=t,s=this.entityManager.getEntityDatas(e,n),o=this.entityManager.getEntityDataVersion(n);for(let t of(r.set(n.type,o),s))i.push(t)}),eM(r,e.lastDataVersion)&&(e.lastDataVersion=r,n=!0),{datas:i,changed:n}}getLayerData(t){let e=this.getLayerEntities(t),i=this.getLayerEntityDatas(t);return{observeEntities:e.entities,observeDatas:i.datas,changed:i.changed||e.changed}}constructor(){this.layerEntitiesSelectorMap=new WeakMap,this.entityLayerMap=new Map,this.ableLayerMap=new Map}};function eM(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Map,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map;if(t.size!==e.size)return!0;for(let i of t.keys())if(t.get(i)!==e.get(i))return!0;return!1}O([(0,C.f3)(eo)],eN.prototype,"entityManager",2),eN=O([(0,C.b2)()],eN);var eI=0,eT=class extends w.ConflatableMessage{constructor(t){super(`flush-layer-request_layer${eI++}`),this.layer=t}},eL=class{reportLayerRendered(t){this.layerRenderedMap.set(t,!0),Array.from(this.layerRenderedMap.values()).every(t=>t)&&(this.loggerService.onAllLayersRendered(),this.onAllLayersRenderedEmitter.fire(),window.REPORT_TTI_FOR_E2E&&window.REPORT_TTI_FOR_E2E(performance.now(),performance.getEntriesByType("resource")))}addLayer(t){if(this.layers.push(t),this.toDispose.push(t),this.layerFlushMessages.set(t,new eT(t)),t.pipelineNode=this.node,t.playgroundNode=this.node.parentElement,(t.autorun||t.render)&&!t.node&&(t.node=document.createElement("div")),t.node&&(this.node.appendChild(t.node),t.node.classList.add("gedit-playground-layer")),t.autorun){let e=t.autorun.bind(t);this.layerAutorunMap.set(t,e),t.autorun=()=>{this.updateLayer(t,!0)}}else if(t.render){this.layerRenderedMap.set(t,!1);let e=t.render.bind(t),i=function(t,e,i,r){let n=E.dG;function s(){let s,[,o]=(0,_.useState)({}),a=(0,_.useCallback)(()=>{i(t)},[t]);(0,_.useEffect)(()=>(n=()=>o({}),()=>{n=E.dG}));try{s=r.isReady?_.createElement(ex,{originRenderer:e,renderedCb:a}):_.createElement(_.Fragment,null)}catch(e){console.error(`Render Layer "${t.constructor.name}" error `,e),s=_.createElement(_.Fragment,null)}return x.createPortal(s,t.node)}return{autorun:()=>n(),portal:t.renderWithReactMemo?_.memo(s):s}}(t,e,this.reportLayerRendered.bind(this),this);this.reactPortals.push(i.portal),this.layerAutorunMap.set(t,i.autorun),t.render=()=>{this.updateLayer(t,!0)}}}flush(t){this.layers.forEach(e=>{this.updateLayer(e,t)})}ready(){this.layers.forEach(t=>{this.loadLayerEntities(t),t.onReady&&t.onReady()}),this.isReady=!0,this.flush(!0)}dispose(){this.toDispose.dispose(),this.node.remove()}processMessage(t){t instanceof eT&&this.onFlushRequest(t.layer)}loadLayerEntities(t){let e=this.selector.getLayerData(t);return e.changed&&t.observeManager.load(e.observeEntities,e.observeDatas),e.changed}onFlushRequest(t){if(!this.isReady||this.toDispose.disposed)return!1;let e=performance.now(),i=()=>{let t=performance.now()-e;t<4||this.loggerService.onFlushRequest(t)},r=this.layerAutorunMap.get(t),n=this.loadLayerEntities(t);if(r&&(n||this.forceUpdates.has(t))){this.forceUpdates.delete(t);try{r()}catch(t){console.error(t)}return i(),!0}return i(),!1}updateLayer(t,e){e&&this.forceUpdates.add(t),w.MessageLoop.postMessage(this,this.layerFlushMessages.get(t))}toReactComponent(){if(this.reactComp)return this.reactComp;let t=this.reactPortals,e=()=>_.createElement(_.Fragment,null,t.map((t,e)=>_.createElement(t,{key:e})));return this.reactComp=e,e}constructor(t,e){this.selector=t,this.isReady=!1,this.onAllLayersRenderedEmitter=new E.Q5,this.toDispose=new E.K4,this.layers=[],this.forceUpdates=new Set,this.layerAutorunMap=new Map,this.layerRenderedMap=new Map,this.layerFlushMessages=new Map,this.reactPortals=[],this.node=E.xF.createDivWithClass("gedit-playground-pipeline"),this.onAllLayersRendered=this.onAllLayersRenderedEmitter.event,this.toDispose.push(e.onEntityChange(t=>{let e=this.selector.entityLayerMap.get(t);e&&e.forEach(t=>this.updateLayer(t))})),this.toDispose.push(this.onAllLayersRenderedEmitter)}};O([(0,C.f3)(ew)],eL.prototype,"loggerService",2),eL=O([(0,C.b2)(),V(0,(0,C.f3)(eN)),V(1,(0,C.f3)(eo))],eL),(d=y||(y={})).STATE_SELECT={id:"STATE_SELECT",cursor:"",shortcut:"",cancelMode:"hold"},d.STATE_MOUSE_FRIENDLY_SELECT={id:"STATE_MOUSE_FRIENDLY_SELECT",cursor:"grab",shortcut:"",cancelMode:"hold"},d.STATE_GRAB={id:"STATE_GRAB",cursor:"grab",shortcut:"SPACE",shortcutAutoEsc:!0,shortcutWorksOnlyOnStateChanged:!0,cancelMode:"hold"};var eP=[y.STATE_SELECT,y.STATE_MOUSE_FRIENDLY_SELECT,y.STATE_GRAB],eR=class extends es{get isPressingSpaceBar(){return this._isPressingSpaceBar}set isPressingSpaceBar(t){this._isPressingSpaceBar=t}get isPressingShift(){return this._isPressingShift}set isPressingShift(t){this._isPressingShift=t}onCancel(t,e){return this.onStateChange(i=>{i.lastState&&i.lastState.id===t&&e()})}getCurrentState(){return this.states.find(t=>t.id===this.selected)}is(t){return this.selected===t}changeState(t,e){let i=this.states.find(e=>e.id===t);if(!i)throw Error(`Unknown editor state ${t}`);if(this.selected!==t){let r=this.getCurrentState();this.selected=t,this.onStateChangeEmitter.fire({state:i,event:e,lastState:r}),this.fireChange()}}toDefaultState(){this.changeState(y.STATE_SELECT.id)}registerState(t){this.states.push(t),this.fireChange()}getStates(){return this.states}isMouseFriendlyMode(){return this.getCurrentState()===y.STATE_MOUSE_FRIENDLY_SELECT}getStateFromShortcut(t){return this.states.find(e=>{if(("SPACE"===e.shortcut?" ":(e.shortcut||"").toLowerCase())===t.key.toLowerCase())return e})}constructor(t){super(t),this._isPressingSpaceBar=!1,this._isPressingShift=!1,this.states=eP.slice(),this.selected=y.STATE_SELECT.id,this.onStateChangeEmitter=new E.Q5,this.onStateChange=this.onStateChangeEmitter.event,this.toDispose.push(this.onStateChangeEmitter)}};eR.type="EditorStateConfigEntity";var eA=0,ek=t=>t/20,eO=class extends es{get grabDisable(){return this.config.grabDisable}set grabDisable(t){this.updateConfig({grabDisable:t})}get scrollDisable(){return this.config.scrollDisable}set scrollDisable(t){this.updateConfig({scrollDisable:t})}get zoomDisable(){return this.config.zoomDisable}set zoomDisable(t){this.updateConfig({zoomDisable:t})}getDefaultConfig(){return{scrollX:0,scrollY:0,originX:0,originY:0,width:0,height:0,minZoom:.25,maxZoom:2,zoom:1,reverseScroll:!0,overflowX:"scroll",overflowY:"scroll",disabled:!1,readonly:!1,grabDisable:!1,scrollDisable:!1,zoomDisable:!1,mouseScrollDelta:ek}}addScrollLimit(t){this._scrollLimitFn=t}updateConfig(t){void 0!==t.zoom&&(t={...t,zoom:this.normalizeZoom(t.zoom)}),!(t={...this.config,...t}).reverseScroll&&(t.scrollX<this.config.originX&&(t.scrollX=this.config.originX),t.scrollY<this.config.originY&&(t.scrollY=this.config.originY)),void 0!==t.scrollLimitX&&t.scrollX<t.scrollLimitX&&(t.scrollX=t.scrollLimitX),void 0!==t.scrollLimitY&&t.scrollY<t.scrollLimitY&&(t.scrollY=t.scrollLimitY),"hidden"===t.overflowX&&(t.scrollX=this.config.originX),"hidden"===t.overflowY&&(t.scrollY=this.config.originY);let e=t.scrollDisable||this.scrollDisable,{readonly:i,disabled:r,grabDisable:n}=this;e&&(t.scrollX=this.config.scrollX,t.scrollY=this.config.scrollY),super.updateConfig(this._scrollLimitFn?{...t,...this._scrollLimitFn({scrollX:t.scrollX,scrollY:t.scrollY})}:t),(i!==this.readonly||r!==this.disabled)&&this._onReadonlyOrDisabledChangeEmitter.fire({readonly:this.readonly,disabled:this.disabled}),n!==this.grabDisable&&this._onGrabDisableChangeEmitter.fire(this.grabDisable)}get finalScale(){return this.zoomEnable?this.config.zoom:1}get zoom(){return this.zoomEnable?this.config.zoom:1}get scrollData(){return{scrollX:this.config.scrollX,scrollY:this.config.scrollY}}normalizeZoom(t){return this.zoomEnable?this.zoomDisable?this.config.zoom:(t<this.config.minZoom?t=this.config.minZoom:t>this.config.maxZoom&&(t=this.config.maxZoom),t):1}updateCursor(t){this.cursor!==t&&(this.cursor=t,this.fireChange())}getPosFromMouseEvent(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],{config:i}=this,r=e?this.zoom:1,{clientX:n,clientY:s}=p.getEventCoord(t),o=this.playgroundDomNode.getBoundingClientRect();return{x:(n+i.scrollX-o.x)/r,y:(s+i.scrollY-o.y)/r}}getClientBounds(){let t=this.playgroundDomNode.getBoundingClientRect();return new E.Ae(t.x,t.y,t.width,t.height)}toFixedPos(t){let{config:e}=this,i=this.playgroundDomNode.getBoundingClientRect();return{x:t.x-e.scrollX+i.x,y:t.y-e.scrollY+i.y}}getViewport(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0],{config:e}=this,i=t?this.finalScale:1;return new E.Ae(e.scrollX/i,e.scrollY/i,e.width/i,e.height/i)}isViewportVisible(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return E.Ae.isViewportVisible(t,this.getViewport(),e,i)}scrollToView(){let t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{scrollDelta:i,position:r,easing:n=!0,easingDuration:s=300,entities:o}=e,{config:a}=this,l=e.zoom?e.zoom:this.finalScale;if(o&&o.length>0){let e=o.map(t=>{let e=t.getData(W);if(e)return e.bounds;let i=t.getData(Y),r=t.getData(J)||{width:0,height:0};if(i)return new E.Ae(i.x,i.y,r.width,r.height||0)}).filter(t=>!!t);e.length>0&&(t=E.Ae.enlarge(e))}else r?t=new E.Ae(r.x,r.y,0,0):e.bounds&&(t=e.bounds);if(!t){let e=this.getDefaultConfig();t=new E.Ae((e.scrollX+a.width/2)/l,(e.scrollY+a.height/2)/l,0,0)}if(!e.scrollToCenter&&this.getViewport().containsRectangle(t))return Promise.resolve();let h={scrollX:(t.x+t.width/2+(i?i.x:0))*l-a.width/2,scrollY:(t.y+t.height/2+(i?i.y:0))*l-a.height/2,zoom:e.zoom};return this.scroll(h,n,s)}setPageBounds(t){this.updateConfig({pageBounds:{x:t.x,y:t.y,width:t.width,height:t.height}})}getPageBounds(){let{pageBounds:t}=this.config;if(t)return new E.Ae(t.x,t.y,t.width,t.height)}scrollPageBoundsToCenter(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],r=this.getPageBounds();if(r){let n,s=2*e;return t&&(n=E.rM.fixSize({width:r.width,height:r.height},{width:s>this.config.width?s:this.config.width-s,height:s>this.config.height?s:this.config.height-s})),this.scrollToView({bounds:r,zoom:n,scrollToCenter:!0,easing:i})}return this.scrollToView({easing:i})}scroll(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,r=new E.cO;if(this.cancelScrollTeeen&&this.cancelScrollTeeen.dispose(),e){let e={scrollX:this.config.scrollX,scrollY:this.config.scrollY,zoom:this.config.zoom};this.cancelScrollTeeen=tt({from:e,to:{...e,...t},onUpdate:t=>{this.updateConfig(t)},onComplete:()=>{this.cancelScrollTeeen=void 0,r.resolve()},onDispose:()=>{r.resolve()},duration:i})}else this.updateConfig(t),r.resolve();return r.promise}fixLayerPosition(t){E.xF.setStyle(t,{left:this.config.scrollX,top:this.config.scrollY})}get loading(){return this._loading}set loading(t){this.loading!==t&&(this._loading=t,this.fireChange())}get zoomEnable(){return this._zoomEnable}set zoomEnable(t){this._zoomEnable!==t&&(this._zoomEnable=t,this.fireChange())}zoomin(t,e){let i=this.config.zoom/10,r=Math.ceil((this.config.zoom+i)*10)/10;this.updateZoom(r,t,e)}zoomout(t,e){let i=this.config.zoom/10,r=Math.floor((this.config.zoom-i)*10)/10;this.updateZoom(r,t,e)}updateZoom(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200;t=this.normalizeZoom(t);let{center:r}=this.getViewport(),n=this.finalScale,s=this.zoomEnable?t:n;if(s!==n){let o={x:r.x*s-r.x*n,y:r.y*s-r.y*n};this.scroll({scrollX:this.config.scrollX+o.x,scrollY:this.config.scrollY+o.y,zoom:t},e,i)}}get disabled(){return this.config.disabled}get readonly(){return this.config.readonly}get readonlyOrDisabled(){return this.config.readonly||this.config.disabled}set readonly(t){this.updateConfig({readonly:t})}set disabled(t){this.updateConfig({disabled:t})}fitView(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:300,n=this.getViewport(!1),s=E.rM.fixSize(t.clone().pad(i,i),n);return this.scrollToView({bounds:t,zoom:s,easing:e,easingDuration:r,scrollToCenter:!0})}constructor(t){super(t),this._loading=!1,this._zoomEnable=!0,this._onReadonlyOrDisabledChangeEmitter=new E.Q5,this._onGrabDisableChangeEmitter=new E.Q5,this.onGrabDisableChange=this._onGrabDisableChangeEmitter.event,this.onReadonlyOrDisabledChange=this._onReadonlyOrDisabledChangeEmitter.event,this.playgroundDomNode=document.createElement("div"),this.cursor="default",this.toDispose.push(this._onReadonlyOrDisabledChangeEmitter)}};eO.type="PlaygroundConfigEntity";var eV=Symbol("LayerOptions"),eB=class{dispose(){this.toDispose.dispose()}createDOMCache(t,e){if(!this.node)throw Error("DomCache need a parent dom node.");return E.xF.createDOMCache(this.node,t,e)}getPosFromMouseEvent(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=this.config.getPosFromMouseEvent(t,e);return{x:i.x,y:i.y}}constructor(){this.toDispose=new E.K4,this.renderWithReactMemo=!0}};O([(0,C.f3)(eV)],eB.prototype,"options",2),O([(0,C.f3)(eo)],eB.prototype,"entityManager",2),O([ei()],eB.prototype,"context",2),eB=O([(0,C.b2)()],eB);var eF=class extends eB{onReady(){if(this.options={preventGlobalGesture:!1,...this.options},this.options.preventGlobalGesture){let t=new t4(document.body,{onPinch:()=>{}});document.documentElement&&(document.documentElement.style.overscrollBehaviorX="none"),document.body.style.overscrollBehaviorX="none",this.toDispose.push(E.JT.create(()=>t.destroy()))}this.toDispose.pushAll([this.config.onGrabDisableChange(t=>{t&&this.grabDragger.stop(0,0)}),E.xF.addStandardDisposableListener(this.playgroundNode,"wheel",t=>{this.getScrollParent(t.target)||(t.preventDefault(),t.stopPropagation())}),this.listenPlaygroundEvent("wheel",this.handleWheelEvent.bind(this),-2,{passive:!0}),this.listenPlaygroundEvent("touchstart",t=>{var e,i;let{clientX:r,clientY:n}=p.getEventCoord(t);(null==(e=this.options)?void 0:e.hoverService)&&(this.options.hoverService.updateHoverPosition({x:r,y:n},t.target),(null==(i=this.options.hoverService)?void 0:i.isSomeHovered())||this.grabDragger.start(r,n))},0),this.listenPlaygroundEvent("touchend",t=>{var e;null==(e=this.options.hoverService)||e.clearHovered()}),this.listenPlaygroundEvent("touchcancel",t=>{var e;null==(e=this.options.hoverService)||e.clearHovered()}),this.listenPlaygroundEvent("mousedown",t=>{let e=1===t.button;e&&!this.isMouseMode()&&this.editorStateConfig.changeState(y.STATE_GRAB.id),this.isGrab()&&(this.editorStateConfig.isPressingSpaceBar||e)&&this.grabDragger.start(t.clientX,t.clientY)},-2),this.listenPlaygroundEvent("mousedown",t=>{var e,i;let r=null==(i=this.options)||null==(e=i.hoverService)?void 0:e.isSomeHovered();!this.isMouseMode()||r||this.editorStateConfig.isPressingShift||this.grabDragger.start(t.clientX,t.clientY)},0),this.editorStateConfig.onStateChange(this.onStateChanged.bind(this)),this.listenGlobalEvent("keydown",t=>{t.shiftKey&&(this.editorStateConfig.isPressingShift=!0,this.isMouseMode()&&this.config.updateCursor(""))},-2),this.listenGlobalEvent("keypress",t=>{if(!this.isFocused||t.target!==this.playgroundNode||this.isMouseMode())return;let e=this.editorStateConfig.getStateFromShortcut(t);" "===t.key&&(this.editorStateConfig.isPressingSpaceBar=!0),((null==e?void 0:e.shortcutWorksOnlyOnStateChanged)!==!0||e!==this.editorStateConfig.getCurrentState())&&(this.lastShortcutState=e,e&&this.editorStateConfig.changeState(e.id))},-2),this.listenGlobalEvent("keyup",t=>{" "===t.key&&(this.editorStateConfig.isPressingSpaceBar=!1),this.editorStateConfig.isPressingShift=!1,this.lastShortcutState&&this.lastShortcutState.shortcutAutoEsc&&this.editorStateConfig.toDefaultState(),this.lastShortcutState=void 0}),{dispose:()=>{this.maskNode.parentNode&&this.maskNode.parentNode.removeChild(this.maskNode),this.cursorStyle.parentNode&&this.cursorStyle.parentNode.removeChild(this.cursorStyle)}}]),"MOUSE"===this.options.ineractiveType&&this.editorStateConfig.changeState(y.STATE_MOUSE_FRIENDLY_SELECT.id)}getCursor(t){var e,i,r;return t?(null==(i=(r=this.playgroundConfigEntity).getCursors)||null==(e=i.call(r))?void 0:e[t])??t:""}isMouseMode(){return this.editorStateConfig.isMouseFriendlyMode()}onStateChanged(t){let{state:e}=t;if(this.cancelStateListen&&(this.cancelStateListen.dispose(),this.cancelStateListen=void 0),e.handle&&e.handle(this.config,t),e.cursor?(this.playgroundConfigEntity.updateCursor(e.cursor),this.currentGesture&&(this.playgroundNode.style.cursor=this.getCursor(e.cursor))):(this.playgroundConfigEntity.updateCursor(""),this.playgroundNode.style.cursor=""),"grab"===e.cursor||"grabbing"===e.cursor){if(e===y.STATE_MOUSE_FRIENDLY_SELECT)return;this.maskNode.style.cssText=`
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 100;
      `,this.playgroundNode.appendChild(this.maskNode)}else this.maskNode.parentNode&&this.maskNode.parentNode.removeChild(this.maskNode);"esc"===e.cancelMode?this.cancelStateListen=E.xF.addStandardDisposableListener(document.body,"keydown",t=>{("Escape"===t.key||"Enter"===t.key)&&this.editorStateConfig.toDefaultState()},!0):"once"===e.cancelMode&&this.editorStateConfig.toDefaultState()}isGrab(){let t=this.editorStateConfig.getCurrentState();return t===y.STATE_GRAB||t===y.STATE_MOUSE_FRIENDLY_SELECT}createGesture(){this.currentGesture||(this.currentGesture=new t9(this.playgroundNode,this.config),this.currentGesture.onDispose(()=>{this.currentGesture=void 0}),this.toDispose.push(this.currentGesture))}handleScrollEvent(t){let{playgroundConfigEntity:e}=this,i=e.config.scrollX+t.deltaX,r=e.config.scrollY+t.deltaY;e.updateConfig({scrollX:i,scrollY:r})}getMouseScaleDelta(){let{mouseScrollDelta:t,zoom:e}=this.config.config;return"function"==typeof t?t(e):t}handleWheelEvent(t){if((!this.currentGesture||!this.currentGesture.pinching)&&!t.ctrlKey&&!t.metaKey&&!this.getScrollParent(t.target)){if(this.isMouseMode()){let{zoom:e,minZoom:i,maxZoom:r,scrollX:n,scrollY:s}=this.playgroundConfigEntity.config,o=this.getMouseScaleDelta(),a=(Math.abs(t.deltaY)>0?t.deltaY:t.deltaX)>0?-o:o,l=this.config.finalScale,h=t.clientX,d=t.clientY,u=Math.max(i,Math.min(r,e+a)),c=this.config.getPosFromMouseEvent({clientX:h,clientY:d},!1),g={x:c.x/l*u,y:c.y/l*u};this.config.updateConfig({scrollX:n+g.x-c.x,scrollY:s+g.y-c.y,zoom:u});return}this.handleScrollEvent(t)}}getScrollParent(t){var e;if(!t||t===this.pipelineNode.parentElement)return null;let i=t.scrollWidth>t.clientWidth,r=t.scrollHeight>t.clientHeight,n=window.getComputedStyle(t).overflowX,s=window.getComputedStyle(t).overflowY,o=["auto","scroll","overlay"].includes(n),a=["auto","scroll","overlay"].includes(s);return i&&o||r&&a||(null==(e=this.protectWheelArea)?void 0:e.call(this,t))?t:this.getScrollParent(t.parentElement)}autorun(){let t=this.playgroundConfigEntity.config,{cursor:e}=this.playgroundConfigEntity,i=this.getCursor(e);if(this.config.zoomEnable?this.createGesture():this.currentGesture&&this.currentGesture.dispose(),E.xF.setStyle(this.pipelineNode,{left:-t.scrollX,top:-t.scrollY,width:t.width,height:t.height}),this.playgroundNode.style.cursor=i,"grab"===e||"grabbing"===e){let t="";this.playgroundNode.classList.forEach(e=>{t+=`.${e}`}),this.cursorStyle.innerText=`.${t} * { cursor: ${i} }`,this.cursorStyle.parentNode||document.head.appendChild(this.cursorStyle)}else this.cursorStyle.parentNode&&this.cursorStyle.parentNode.removeChild(this.cursorStyle)}constructor(){super(...arguments),this.startGrabScroll={scrollX:0,scrollY:0},this.cursorStyle=document.createElement("style"),this.maskNode=document.createElement("div"),this.grabDragger=new Q({onDragStart:t=>{this.config.grabDisable||(this.config.updateCursor("grabbing"),this.startGrabScroll={scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY})},onDrag:t=>{this.config.grabDisable||this.config.updateConfig({scrollX:this.startGrabScroll.scrollX-t.endPos.x+t.startPos.x,scrollY:this.startGrabScroll.scrollY-t.endPos.y+t.startPos.y})},onDragEnd:t=>{this.isGrab()&&this.config.updateCursor("grab"),1===t.button&&(this.isMouseMode()?(this.editorStateConfig.changeState(y.STATE_MOUSE_FRIENDLY_SELECT.id),this.config.updateCursor("grab")):(this.editorStateConfig.toDefaultState(),this.config.updateCursor("")))}})}};O([eg(eO)],eF.prototype,"playgroundConfigEntity",2),O([eg(eR)],eF.prototype,"editorStateConfig",2),O([(0,C.jt)(),(0,C.f3)(ey)],eF.prototype,"protectWheelArea",2),eF=O([(0,C.b2)()],eF);var ez=class{get size(){return this.observeEntities.length}load(t,e){this.observeEntities=t,this.observeDatas=e,this.entitiesTypeCache.clear(),this.entitiesAbleCache.clear(),this.entitiyDataCache.clear()}get(t,e){let i=this.getEntities(t);return void 0!==e?i.find(t=>t.id===e):i[0]}has(t){return!!this.get(t)}getEntities(t){let e=this.entitiesTypeCache.get(t);return e||(e=[],this.observeEntities.forEach(i=>{i.type===t.type&&e.push(i)}),this.entitiesTypeCache.set(t,e)),e.filter(t=>!t.disposed)}getEntityDatas(t,e){let i=`${t.type}:${e.type}`,r=this.entitiyDataCache.get(i);return r||(r=this.observeDatas.filter(i=>i.type===e.type&&i.entity.type===t.type),this.entitiyDataCache.set(i,r)),r}updateConfig(t,e){let i=this.get(t);i&&i.updateConfig&&i.updateConfig(e)}getConfig(t){let e=this.get(t);if(e)return e.config}createEntity(t,e){return this.entityManager.createEntity(t,e)}removeEntities(t){this.entityManager.removeEntities(t)}[Symbol.iterator](){let t=0,e=this.observeEntities.length;return{next:()=>{let i=t++;return{value:this.observeEntities[i],done:i===e}}}}constructor(t){this.entityManager=t,this.observeEntities=[],this.observeDatas=[],this.entitiesTypeCache=new Map,this.entitiesAbleCache=new Map,this.entitiyDataCache=new Map}},eG=new w.ConflatableMessage("PIPELINE_ZOOM"),e$=new w.ConflatableMessage("PIPELINE_SCROLL"),eY=class{_listenEvent(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4?arguments[4]:void 0,s=i?this.globalEvents:this.playgroundEvents,o=i?document:this.renderer.node.parentNode,a=s[t];if(!a){let e={handleEvent:t=>{let e=a.handlers;for(let i=0,r=e.length;i<r;i++)if(e[i].handle(t))return}};o.addEventListener(t,e,n),a=s[t]={handlers:[],dispose:()=>{o.removeEventListener(t,e),delete s[t]}}}let{handlers:l}=a,h={handle:e,priority:r};l.unshift(h),l.sort((t,e)=>e.priority-t.priority);let d=E.JT.create(()=>{let t=a.handlers.indexOf(h);-1!==t&&a.handlers.splice(t,1),0===a.handlers.length&&a.dispose()});return this.toDispose.push(d),d}listenPlaygroundEvent(t,e,i,r){return this._listenEvent(t,e,!1,i,r)}listenGlobalEvent(t,e,i,r){return this._listenEvent(t,e,!0,i,r)}registerLayer(t,e){if(this.allLayersMap.has(t))return;let i=this.layerFactory(t,e);this.allLayersMap.set(t,i);let r=ed(t,ea),n=ed(t,el);if(r.forEach(t=>{this.entityManager.registerEntity(t),z.isRegistryOf(t,es)&&this.entityManager.createEntity(t)}),n.forEach(t=>{this.entityManager.registerEntity(t.entity),this.entityManager.registerEntityData(t.data)}),this.selector.subscribeEntities(i,r),n.forEach(t=>this.selector.subscribleEntityByData(i,t.entity,t.data)),i.observeManager=new ez(this.entityManager),i.reloadEntities=()=>{let t=this.selector.getLayerData(i);return t.changed&&i.observeManager.load(t.observeEntities,t.observeDatas),t.changed},i.listenPlaygroundEvent=this.listenPlaygroundEvent.bind(this),i.listenGlobalEvent=this.listenGlobalEvent.bind(this),i.config=this.configEntity,i.getOtherLayer=this.getLayer.bind(this),Object.defineProperty(i,"isFocused",{get:()=>this._isFocused}),i.onResize&&this.onResize(i.onResize.bind(i)),i.onBlur&&this.onBlurEmitter.event(i.onBlur.bind(i)),i.onFocus&&this.onFocusEmitter.event(i.onFocus.bind(i)),i.onZoom&&this.onZoomEmitter.event(i.onZoom.bind(i)),i.onScroll&&this.onScrollEmitter.event(i.onScroll.bind(i)),i.onViewportChange){let t=i.onViewportChange.bind(i);this.onResize(t),this.onZoomEmitter.event(t),this.onScrollEmitter.event(t)}i.onReadonlyOrDisabledChange&&this.configEntity.onReadonlyOrDisabledChange(i.onReadonlyOrDisabledChange.bind(i)),this.renderer.addLayer(i)}getLayer(t){return this.allLayersMap.get(t)}get configEntity(){return this.entityManager.getEntity(eO,!0)}ready(){let t=this.configEntity,e=t.finalScale,i=t.scrollData;t.onConfigChanged(()=>{let r=t.finalScale,n=t.scrollData;r!==e&&(e=r,w.MessageLoop.postMessage(this,eG)),(i.scrollX!==n.scrollX||i.scrollY!==n.scrollY)&&(i=n,w.MessageLoop.postMessage(this,e$))})}processMessage(t){let e=this.configEntity;switch(t.type){case"PIPELINE_SCROLL":this.onScrollEmitter.fire(e.scrollData);break;case"PIPELINE_ZOOM":this.onZoomEmitter.fire(e.finalScale)}}dispose(){this.toDispose.dispose()}constructor(){this._isFocused=!1,this.toDispose=new E.K4,this.allLayersMap=new Map,this.onResizeEmitter=new E.Q5,this.onFocusEmitter=new E.Q5,this.onBlurEmitter=new E.Q5,this.onZoomEmitter=new E.Q5,this.onScrollEmitter=new E.Q5,this.onFocus=this.onFocusEmitter.event,this.onBlur=this.onBlurEmitter.event,this.onZoom=this.onZoomEmitter.event,this.onScroll=this.onScrollEmitter.event,this.playgroundEvents={},this.globalEvents={},this.onResize=this.onResizeEmitter.event,this.toDispose.pushAll([this.onResizeEmitter,this.onFocusEmitter,this.onZoomEmitter,this.onBlurEmitter,this.onScrollEmitter]),this.onFocusEmitter.event(()=>{this._isFocused=!0}),this.onBlurEmitter.event(()=>{this._isFocused=!1})}};O([(0,C.f3)(eL)],eY.prototype,"renderer",2),O([(0,C.f3)(eN)],eY.prototype,"selector",2),O([(0,C.f3)(eo)],eY.prototype,"entityManager",2),O([ei()],eY.prototype,"context",2),O([(0,C.f3)(ev)],eY.prototype,"layerFactory",2),eY=O([(0,C.b2)()],eY);var eX=_.createContext({}),ej=_.createContext({}),eJ=_.createContext({}),eU=_.createContext(void 0),eH=Symbol("PlaygroundConfig"),eW=Symbol("PlaygroundContribution"),eK=class{config(t){Object.assign(this.playgroundConfig,t)}registerLayer(t){this.pipeline.registerLayer(t)}registerEntity(t){this.entityManager.registerEntity(t)}registerEditorState(t){let e=this.entityManager.getEntity(eR);null==e||e.registerState(t)}};O([(0,C.f3)(eY)],eK.prototype,"pipeline",2),O([(0,C.f3)(eo)],eK.prototype,"entityManager",2),O([(0,C.f3)(eH)],eK.prototype,"playgroundConfig",2),eK=O([(0,C.b2)()],eK);var eZ=Symbol("PluginContext");Symbol("Plugin");var eQ=0;function eq(t){let{contributionKeys:e,singleton:i=!1}=t;eQ+=1;let r=`Playground_${eQ}`;return n=>{let s=[],o=!1;return{pluginId:r,singleton:i,initPlugin:()=>{!o&&(o=!0,t.containerModules&&s.push(...t.containerModules),t.onBind&&s.push(new C.nZ((e,i,r,s)=>{t.onBind({bind:e,unbind:i,isBound:r,rebind:s},n)})),(t.onInit||t.onDispose||t.onReady||t.onAllLayersRendered)&&s.push(new C.nZ(e=>{e(eW).toDynamicValue(e=>{let i=e.container.get(eZ);return{onInit:()=>{var e;null==(e=t.onInit)||e.call(t,i,n)},onReady:()=>{var e;null==(e=t.onReady)||e.call(t,i,n)},onDispose:()=>{var e;null==(e=t.onDispose)||e.call(t,i,n)},onAllLayersRendered:()=>{var e;null==(e=t.onAllLayersRendered)||e.call(t,i,n)}}})})))},options:n,contributionKeys:e,containerModules:s}}}var e0=t=>eq(t)(void 0),e1=class{get onResize(){return this.pipelineRegistry.onResizeEmitter.event}get context(){var t;return null==(t=this.contextProvider)?void 0:t.call(this)}get contributions(){return this.contributionProvider.getContributions()}init(){let{contributions:t}=this;for(let e of t)e.registerPlayground&&e.registerPlayground(this.registry);for(let e of t)e.onInit&&e.onInit(this)}get pipelineNode(){return this.pipelineRenderer.node}setParent(t){t.appendChild(this.node),this.resize()}get zoomEnable(){return this.config.zoomEnable}set zoomEnable(t){this.config.zoomEnable=t}flush(){this.pipelineRenderer.flush()}ready(){if(this.isReady)return;if(this.isReady=!0,this.playgroundConfig.autoResize){let t=()=>{this.disposed||this.resize()};if("undefined"!=typeof ResizeObserver){let e=new ResizeObserver(t);e.observe(this.node),this.toDispose.push(E.JT.create(()=>{e.disconnect()}))}else this.toDispose.push(E.xF.addStandardDisposableListener(window.document.body,"resize",t,{passive:!0}));this.resize()}this.pipelineRegistry.ready(),this.pipelineRenderer.ready();let{contributions:t}=this;for(let e of t)e.onReady&&e.onReady(this)}scrollToView(t){return this.entityManager.getEntity(eO).scrollToView(t)}resize(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!t){let e=this.node.getBoundingClientRect();t={width:e.width,height:e.height}}let{width:i,height:r}=this.config.config;if(0===t.width||0===t.height)return!1;let n=this.config.config,{scrollX:s,scrollY:o}=this.config.config;return e&&i&&Math.round(t.width)!==i&&(s+=(i-t.width)/2),e&&r&&Math.round(t.height)!==r&&(o+=(r-t.height)/2),(Math.round(t.width)!==i||Math.round(t.height)!==r||n.scrollX!==s||n.scrollY!==o)&&(this.config.updateConfig({...t,scrollX:s,scrollY:o}),this.pipelineRegistry.onResizeEmitter.fire(t)),!0}focus(){this._focused||(this._focused=!0,this.pipelineRegistry.onFocusEmitter.fire())}blur(){this._focused&&(this._focused=!1,this.pipelineRegistry.onBlurEmitter.fire())}get focused(){return this._focused}get config(){return this.entityManager.getEntity(eO)}get editorState(){return this.entityManager.getEntity(eR)}getConfigEntity(t){return this.entityManager.getEntity(t,!0)}dispose(){if(this.disposed)return;let{contributions:t}=this;for(let e of t)e.onDispose&&e.onDispose(this);this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}toReactComponent(){return this.pipelineRenderer.toReactComponent()}registerLayer(t,e){this.pipelineRegistry.registerLayer(t,e)}registerLayers(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(t=>this.pipelineRegistry.registerLayer(t))}getLayer(t){return this.pipelineRegistry.getLayer(t)}get onAllLayersRendered(){return this.pipelineRenderer.onAllLayersRendered}constructor(t,e,i,r,n,s,o,a,l){this.entityManager=t,this.registry=e,this.contextProvider=i,this.pipelineRenderer=r,this.pipelineRegistry=n,this.playgroundConfig=s,this.contributionProvider=o,this.commandService=a,this.selectionService=l,this.toDispose=new E.K4,this._focused=!1,this.playgroundClassName=(0,b.x0)(),this.isReady=!1,this.toDispose.pushAll([this.pipelineRenderer,this.pipelineRegistry,this.entityManager,this.commandService,this.selectionService,E.JT.create(()=>{this.node.remove()}),r.onAllLayersRendered(()=>{this.contributions.forEach(t=>{var e;return null==(e=t.onAllLayersRendered)?void 0:e.call(t,this)})})]);let h=this.entityManager.createEntity(eR);if(this.entityManager.createEntity(eO),this.node=s.node||document.createElement("div"),this.config.playgroundDomNode=this.node,this.toDispose.pushAll([E.xF.addStandardDisposableListener(this.node,"scroll",t=>{this.node.scrollTop=0,this.node.scrollLeft=0,t.preventDefault(),t.stopPropagation()})]),this.node.classList.add("gedit-playground"),this.node.classList.add(this.playgroundClassName),this.node.dataset.testid="sdk.workflow.canvas",s.layers&&s.layers.forEach(t=>this.registry.registerLayer(t)),s.editorStates&&s.editorStates.forEach(t=>h.registerState(t)),void 0!==s.zoomEnable&&(this.zoomEnable=s.zoomEnable),s.entityConfigs)for(let[t,e]of s.entityConfigs){let i=this.entityManager.getEntity(t,!0);null==i||i.updateConfig(e)}this.node.addEventListener("blur",()=>{this.blur()}),this.node.addEventListener("focus",()=>{this.focus()}),this.node.tabIndex=0,this.node.appendChild(this.pipelineRenderer.node),this.onBlur=this.pipelineRegistry.onBlurEmitter.event,this.onFocus=this.pipelineRegistry.onFocusEmitter.event,this.onZoom=this.pipelineRegistry.onZoomEmitter.event,this.onScroll=this.pipelineRegistry.onScrollEmitter.event}};function e2(t){return{container:t,playground:t.get(e1),get:e=>t.get(e),getAll:e=>t.getAll(e)}}function e3(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.createChild();r.bind(e).toSelf().inSingletonScope(),r.bind(eV).toConstantValue(i);let n=r.get(e);return"object"==typeof n&&eu(n.constructor.prototype).forEach(t=>{n.hasOwnProperty(t)&&void 0===n[t]&&delete n[t]}),n}e1=O([(0,C.b2)(),V(0,(0,C.f3)(eo)),V(1,(0,C.f3)(eK)),V(2,(0,C.f3)(ee)),V(2,(0,C.jt)()),V(3,(0,C.f3)(eL)),V(4,(0,C.f3)(eY)),V(5,(0,C.f3)(eH)),V(6,(0,C.f3)(E.Qc)),V(6,(0,C.t6)(eW)),V(6,(0,C.jt)()),V(7,(0,C.f3)(P)),V(8,(0,C.f3)(eE))],e1);var e5=new C.nZ(t=>{t(eo).toSelf().inSingletonScope(),t(eL).toSelf().inSingletonScope(),t(eK).toSelf().inSingletonScope(),t(e1).toSelf().inSingletonScope(),t(eN).toSelf().inSingletonScope(),t(ev).toDynamicValue(t=>(e,i)=>e3(t.container,e,i)).inSingletonScope(),t(eY).toSelf().inSingletonScope(),t(er).toDynamicValue(t=>t.container).inSingletonScope(),t(eH).toConstantValue({autoFocus:!0,autoResize:!0,zoomEnable:!0,layers:[]}),t(et).toConstantValue({}),t(ee).toDynamicValue(t=>()=>{if(t.container.isBound(et))return t.container.get(et)}),t(ew).toSelf().inSingletonScope(),t(e_).toSelf().inSingletonScope(),t(eE).toSelf().inSingletonScope(),t(eb).to(eC).inSingletonScope(),t(eS).to(eD).inSingletonScope(),t(eO).toDynamicValue(t=>t.container.get(eo).createEntity(eO)).inSingletonScope(),(0,E.yb)(t,eW),t(eZ).toDynamicValue(t=>e2(t.container)).inSingletonScope(),t(t8).toService(eZ)});function e4(t,e,i){let r=i||new C.W2({defaultScope:"Singleton"});return e&&(r.parent=e),r.load(e5),r.isBound(P)||r.load(R),t&&(r.rebind(eH).toConstantValue(t),t.context&&r.rebind(et).toConstantValue(t.context)),r}var e9=(0,_.forwardRef)(function(t,e){let{containerModules:i,playgroundContext:r,parentContainer:n,playgroundContainer:s,plugins:o,customPluginContext:a,...l}=t,h=(0,_.useMemo)(()=>{let t;return s?t=s:(t=e4({autoFocus:!0,autoResize:!0,zoomEnable:!0,...l},n),r&&t.rebind(et).toConstantValue(r),i&&i.forEach(e=>t.load(e))),t},[]),d=(0,_.useMemo)(()=>{let t,e=h.get(e1);return a?(t=a(h),h.rebind(eZ).toConstantValue(t)):t=h.get(eZ),o&&function(t,e){let i=new Set,r=new Set;t.reduceRight((t,e)=>{let i=e.singleton&&r.has(e.pluginId);return e.singleton&&r.add(e.pluginId),i?t:[e,...t]},[]).reduce((t,e)=>{if(i.has(e.pluginId)||(e.initPlugin(),i.add(e.pluginId)),e.containerModules&&e.containerModules.length>0)for(let i of e.containerModules)t.includes(i)||t.push(i);return t},[]).forEach(t=>e.load(t)),t.forEach(t=>{if(t.contributionKeys)for(let i of t.contributionKeys)e.bind(i).toConstantValue(t.options)})}(o(t),h),e.init(),e},[]),u=(0,_.useRef)(0);return(0,_.useEffect)(()=>(u.current+=1,()=>{d.dispose()}),[]),(0,_.useImperativeHandle)(e,()=>h.get(eZ),[]),_.createElement(ej.Provider,{value:h},_.createElement(eJ.Provider,{value:d},_.createElement(eX.Provider,{value:r},t.children)))});function e8(){return _.useContext(eJ)}function e6(){return _.useContext(ej)}function e7(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=e6().get(eo),i=(0,_.useContext)(eU);if(!i)throw Error('[useEntityFromContext] Unknown entity from "PlaygroundEntityContext"');let r=(0,E.JA)(i.version);return(0,_.useLayoutEffect)(()=>{let e;return t&&(e=i.onEntityChange(()=>r(i.version))),()=>null==e?void 0:e.dispose()},[e,r,i,t]),i}function it(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=(0,E.JA)();(0,_.useLayoutEffect)(()=>{let t=new E.K4;return t.pushAll(e.map(t=>t(()=>r()))),()=>t.dispose()},[e,r])}function ie(t){var e;let i=e6();return null==(e=i.get)?void 0:e.call(i,t)}function ii(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=e6().get(eo),r=i.getEntity(t,!0),n=(0,E.JA)(r.version);return(0,_.useLayoutEffect)(()=>{let t=e?r.onEntityChange(()=>{n(r.version)}):E.JT.NULL;return()=>t.dispose()},[i,n,r,e]),r}function ir(){let t=e8();return(0,_.useMemo)(()=>({start:(e,i)=>Q.startDrag(e.clientX,e.clientY,{...i,config:t.config})}),[])}var is=t=>{let e=e8(),i=ie(eH),r=(0,_.useRef)();(0,_.useEffect)(()=>{e.setParent(r.current),e.ready(),i.autoFocus&&e.node.focus()},[]);let n=e.toReactComponent();return _.createElement(_.Fragment,null,_.createElement("div",{ref:r,className:`gedit-playground-container${t.className?` ${t.className}`:""}`,style:t.style}),_.createElement(n,null),t.children?x.createPortal(_.createElement(_.Fragment,null,t.children),e.node):null)};(t=>{let e=Symbol("LayerStateProvider");class i{hijackMethod(t,e){"function"==typeof t[e]&&(this[e]=vi.spyOn(t,e))}constructor(t,e,i){this.instance=t,this.playground=e,this.container=i,this.hijackMethod(t,"autorun"),this.hijackMethod(t,"render"),this.hijackMethod(t,"onReady"),this.hijackMethod(t,"onResize"),this.hijackMethod(t,"onFocus"),this.hijackMethod(t,"onBlur"),this.hijackMethod(t,"onZoom"),this.hijackMethod(t,"onScroll"),this.hijackMethod(t,"onViewportChange"),this.hijackMethod(t,"onReadonlyOrDisabledChange")}}function r(t){let r=e4();return r.bind(e).toConstantValue(new WeakMap),r.rebind(ev).toDynamicValue(t=>(n,s)=>{let o=e3(t.container,n,s);return t.container.get(e).set(n,new i(o,r.get(e1),r)),o}),t&&t.forEach(t=>r.load(t)),r}function n(t,i){return t.get(e).get(i)}t.LayerTestState=i,t.createContainer=r,t.createPlayground=function(t){return r(t).get(e1)},t.getLayerTestState=n,t.createLayerTestState=function(t,e,i){let s=r(i),o=s.get(e1);return o.registerLayer(t,e),o.init(),o.ready(),n(s,t)}})(m||(m={}))},579962:function(t,e,i){i.d(e,{C8:()=>B,D9:()=>tl,GA:()=>j,IG:()=>I,JU:()=>ti,Lu:()=>P,Lw:()=>q,Lz:()=>G,OT:()=>w,QU:()=>th,Sy:()=>_,T4:()=>L,Uy:()=>tn,VH:()=>R,VO:()=>F,Vl:()=>J,XP:()=>M,Xr:()=>X,Xs:()=>Z,cc:()=>Q,d1:()=>tc,eE:()=>ta,eG:()=>Y,h3:()=>K,nx:()=>T,pQ:()=>tr,y3:()=>U,yI:()=>tg});var r,n,s,o,a,l,h,d,u,c,g=i(893740),p=i(832176),f=i(827656),y=i(492320),m=i(9163),E=i(129034),b=Object.defineProperty,C=Object.getOwnPropertyDescriptor,S=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?C(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&b(e,i,s),s},D=(t,e)=>(i,r)=>e(i,r,t),_=((r=_||{}).START="start",r.DEFAULT="default",r.ROOT="root",r.EMPTY="empty",r.INLINE_BLOCKS="inlineBlocks",r.BLOCK_ICON="blockIcon",r.BLOCK="block",r.BLOCK_ORDER_ICON="blockOrderIcon",r.GROUP="group",r.END="end",r.BREAK="break",r.CONDITION="condition",r.SUB_CANVAS="subCanvas",r.MULTI_INPUTS="multiInputs",r.MULTI_OUTPUTS="multiOutputs",r.INPUT="input",r.OUTPUT="output",r.SLOT="slot",r.SLOT_BLOCK="slotBlock",r),w=((n=w||{}).SIMPLE_SPLIT="simpleSplit",n.DYNAMIC_SPLIT="dynamicSplit",n.STATIC_SPLIT="staticSplit",n),x=["root","inlineBlocks","block"];Symbol("FlowLayout");var N=Symbol("FlowLayoutContribution"),M=((s=M||{}).VERTICAL_FIXED_LAYOUT="vertical-fixed-layout",s.HORIZONTAL_FIXED_LAYOUT="horizontal-fixed-layout",s);(M||(M={})).isVertical=function(t){return"vertical-fixed-layout"===t.name};var I=((o=I||{})[o.STRAIGHT_LINE=0]="STRAIGHT_LINE",o[o.DIVERGE_LINE=1]="DIVERGE_LINE",o[o.MERGE_LINE=2]="MERGE_LINE",o[o.ROUNDED_LINE=3]="ROUNDED_LINE",o[o.CUSTOM_LINE=4]="CUSTOM_LINE",o[o.DRAGGING_LINE=5]="DRAGGING_LINE",o),T=((a=T||{})[a.ADDER_LABEL=0]="ADDER_LABEL",a[a.TEXT_LABEL=1]="TEXT_LABEL",a[a.COLLAPSE_LABEL=2]="COLLAPSE_LABEL",a[a.COLLAPSE_ADDER_LABEL=3]="COLLAPSE_ADDER_LABEL",a[a.CUSTOM_LABEL=4]="CUSTOM_LABEL",a[a.BRANCH_DRAGGING_LABEL=5]="BRANCH_DRAGGING_LABEL",a),L={NODE_SPACING:"SPACING",BRANCH_SPACING:"BRANCH_SPACING",ROUNDED_LINE_X_RADIUS:"ROUNDED_LINE_X_RADIUS",ROUNDED_LINE_Y_RADIUS:"ROUNDED_LINE_Y_RADIUS",INLINE_BLOCKS_PADDING_BOTTOM:"INLINE_BLOCKS_PADDING_BOTTOM",COLLAPSED_SPACING:"COLLAPSED_SPACING",HOVER_AREA_WIDTH:"HOVER_AREA_WIDTH"},P={NULL:0,[L.NODE_SPACING]:32,[L.BRANCH_SPACING]:20,MARGIN_RIGHT:20,INLINE_BLOCK_PADDING_BOTTOM:16,INLINE_BLOCKS_PADDING_TOP:30,[L.INLINE_BLOCKS_PADDING_BOTTOM]:40.1,MIN_INLINE_BLOCK_SPACING:200,MIN_INLINE_BLOCK_SPACING_HORIZONTAL:80,[L.COLLAPSED_SPACING]:12,[L.ROUNDED_LINE_X_RADIUS]:16,[L.ROUNDED_LINE_Y_RADIUS]:20,[L.HOVER_AREA_WIDTH]:20},R=((l=R||{}).PRE_BRANCH="pre_branch",l.NORMAL_BRANCH="normal_branch",l),A={width:280,height:60},k=u||(u={});function O(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return 0===t.length||0===e.length?[...t,...e]:[...t.map(t=>{let i=e.find(e=>e.type===t.type);return i?V(t,i,t.type):t}),...e.filter(e=>!t.some(t=>t.type===e.type))]}function V(t,e,i){let r=t.__extends__?t.__extends__.slice():[];return t.type!==e.type&&r.unshift(t.type),{...t,...e,extendChildRegistries:O(t.extendChildRegistries,e.extendChildRegistries),meta:{...t.meta,...e.meta},extend:void 0,type:i,__extends__:r}}k.mergeChildRegistries=O,k.merge=V,k.extend=function(t,e){return e.length?e.reduce((e,i)=>V(e,i,t.type),t):t};var B=((h=B||{}).addFromNode="addFromNode",h.deleteFromNode="deleteFromNode",h.addBlock="addBlock",h.deleteBlock="deleteBlock",h.createGroup="createGroup",h.ungroup="ungroup",h.moveNodes="moveNodes",h.moveBlock="moveBlock",h.moveChildNodes="moveChildNodes",h.addNodes="addNodes",h.deleteNodes="deleteNodes",h.addChildNode="addChildNode",h.deleteChildNode="deleteChildNode",h.addNode="addNode",h.deleteNode="deleteNode",h),F=Symbol("FlowOperationBaseService"),z=class t extends g.RD{get key(){return this.entity.id}getDefaultData(){let{addable:t,expandable:e,defaultExpanded:i}=this.entity.getNodeMeta();return{addable:t,expandable:e,expanded:i||!1,activated:!1,hovered:!1,dragging:!1,stackIndex:0}}updateExtInfo(t,e){let i=this.data.extInfo,r=e?t:{...i,...t};p.XJ.isChanged(i,r)&&(this.update({extInfo:r}),this.onExtInfoChangeEmitter.fire({oldInfo:i,newInfo:r}))}getExtInfo(){return this.data.extInfo}get addable(){return this.data.addable}get expandable(){return this.data.expandable}get draggable(){let{draggable:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this.entity):t}get expanded(){return this.data.expanded}set expanded(t){this.expandable&&this.data.expanded!==t&&(this.data.expanded=t,this.fireChange())}toggleExpand(){this.expanded=!this.expanded}toggleMouseEnter(){var t;let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.entity.document.renderState.setNodeHovered(this.entity),e)return;let i=this.entity.getData(Y);i.renderState.hidden||(this.mouseLeaveTimeout&&(clearTimeout(this.mouseLeaveTimeout),this.mouseLeaveTimeout=void 0),i.renderState.hovered=!0,this.entity.isFirst&&(null==(t=this.entity.parent)?void 0:t.id)!=="root"?i.parent.renderState.activated=!0:i.renderState.activated=!0)}toggleMouseLeave(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.entity.document.renderState.setNodeHovered(void 0),t)return;let e=this.entity.getData(Y);this.mouseLeaveTimeout=setTimeout(()=>{var t;e.renderState.hovered=!1,this.entity.isFirst&&(null==(t=this.entity.parent)?void 0:t.id)!=="root"&&(e.parent.renderState.activated=!1),e.renderState.activated=!1},200)}get hidden(){return this.entity.hidden}set hovered(t){this.data.hovered=t,this.fireChange()}get hovered(){return this.data.hovered}get dragging(){return this.data.dragging}set dragging(t){this.data.dragging!==t&&(this.data.dragging=t,this.fireChange())}set activated(e){if("blockIcon"===this.entity.flowNodeType&&this.entity.parent){this.entity.parent.getData(t).activated=e;return}this.data.activated!==e&&(this.data.activated=e,this.fireChange())}get activated(){let{entity:e}=this;return!!e.parent&&!!e.parent.getData(t).activated||this.data.activated}get stackIndex(){return this.data.stackIndex}set stackIndex(t){this.data.stackIndex=t}get lineActivated(){var e,i,r;let{activated:n}=this;return!!n&&!!((null==(i=this.entity.parent)||null==(e=i.getData(t))?void 0:e.activated)||this.entity.isInlineBlock||(null==(r=this.entity.next)?void 0:r.getData(t).activated))}get node(){return this._node||(this._node=p.xF.createDivWithClass("gedit-flow-activity-node"),this._node.dataset.testid="sdk.workflow.canvas.node",this._node.dataset.nodeId=this.entity.id),this._node}dispose(){super.dispose(),this.onExtInfoChangeEmitter.dispose()}constructor(t){super(t),this.onExtInfoChangeEmitter=new p.Q5,this.onExtInfoChange=this.onExtInfoChangeEmitter.event,this.toDispose.push(p.JT.create(()=>{this._node&&this._node.remove()}))}};z.type="FlowNodeRenderData";var G=z,$=class t extends g.RD{get origin(){return this.transform.origin}get key(){return this.entity.id}getDefaultData(){let{size:t,hidden:e}=this.entity.getNodeMeta();return{size:e?{width:0,height:0}:{...t}}}get collapsed(){return this.entity.collapsed}set collapsed(t){this.entity.collapsed=t,this.localDirty=!0,this.firstChild&&(this.firstChild.localDirty=!0),this.fireChange()}get size(){return this.entity.memoGlobal("size",()=>this.isContainer?this.transform.localSize:this.data.size)}get position(){let{position:t}=this.transform;return{x:t.x,y:t.y}}set position(t){this.transform.update({position:t})}set size(t){let{width:e,height:i}=this.data.size;this.isContainer||(t.width!==e||t.height!==i)&&(this._data.size={...t},this.localDirty=!0,this.fireChange())}get inputPoint(){return this.entity.memoGlobal("inputPoint",()=>{let{getInputPoint:t}=this.entity.getNodeRegistry();return t?t(this,this.entity.document.layout):this.defaultInputPoint})}get defaultInputPoint(){return this.entity.memoGlobal("defaultInputPoint",()=>this.entity.document.layout.getDefaultInputPoint(this.entity))}get defaultOutputPoint(){return this.entity.memoGlobal("defaultOutputPoint",()=>this.entity.document.layout.getDefaultOutputPoint(this.entity))}get outputPoint(){return this.entity.memoGlobal("outputPoint",()=>{let{getOutputPoint:t}=this.entity.getNodeRegistry();return t?t(this,this.entity.document.layout):this.defaultOutputPoint})}get originDeltaX(){return this.entity.memoLocal("originDeltaX",()=>{let{children:t}=this,{getOriginDeltaX:e}=this.entity.getNodeRegistry();return e?e(this,this.entity.document.layout):0===t.length?-this.size.width*this.origin.x:1===t.length?t[0].originDeltaX:this.entity.isInlineBlocks&&t.length>1?t[0].originDeltaX+this.transform.position.x:t.reduce((t,e)=>{let i=e.originDeltaX;return void 0===t||i<t?i:t},void 0)})}get originDeltaY(){return this.entity.memoLocal("originDeltaY",()=>{let{children:t}=this,{getOriginDeltaY:e}=this.entity.getNodeRegistry();return e?e(this,this.entity.document.layout):0===t.length?-this.size.height*this.origin.y:1===t.length?t[0].originDeltaY:this.entity.isInlineBlocks&&t.length>1?t[0].originDeltaY+this.transform.position.y:t.reduce((t,e)=>{let i=e.originDeltaY;return void 0===t||i<t?i:t},void 0)})}get bounds(){return this.entity.memoGlobal("bounds",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).boundsWithPadding);return p.Ae.enlarge(i).withPadding(this.padding)}return e.bounds})}get boundsWithPadding(){return this.entity.memoGlobal("boundsWithPadding",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).boundsWithPadding);return p.Ae.enlarge(i).withPadding(this.padding)}return e.bounds.clone().withPadding(this.padding)})}get isContainer(){return this.transform.isContainer}get localBounds(){return this.entity.memoLocal("localBounds",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).localBounds),r=p.Ae.enlarge(i).withPadding(this.padding);return g.YZ.applyMatrix(r,e.localTransform)}return e.localBounds.clone().withPadding(this.padding)})}get padding(){return this.entity.document.layout.getPadding(this.entity)}setParentTransform(t){this.transform.parent!==(null==t?void 0:t.transform)&&(this.localDirty=!0),this.transform.setParent(null==t?void 0:t.transform)}get spacing(){let{spacing:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get inlineSpacingPre(){let{inlineSpacingPre:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get inlineSpacingAfter(){let{inlineSpacingAfter:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get minInlineBlockSpacing(){let{minInlineBlockSpacing:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get children(){return this.entity.children.map(e=>e.getData(t))}get pre(){var e;return null==(e=this.entity.pre)?void 0:e.getData(t)}get originParent(){var e;return null==(e=this.entity.originParent)?void 0:e.getData(t)}get isFirst(){return this.entity.isFirst}get isLast(){return this.entity.isLast}get lastChild(){var e;return null==(e=this.entity.lastChild)?void 0:e.getData(t)}get firstChild(){var e;return null==(e=this.entity.firstChild)?void 0:e.getData(t)}get next(){var e;return null==(e=this.entity.next)?void 0:e.getData(t)}get parent(){var e;return null==(e=this.entity.parent)?void 0:e.getData(t)}constructor(t){super(t),this.localDirty=!0;let{origin:e}=this.entity.getNodeMeta();this.transform=this.entity.addData(g.VO),this.transform.changeLocked=!0,this.transform.update({origin:{...e}}),this.transform.changeLocked=!1,this.renderState=this.entity.addData(G),this.bindChange(this.transform),this.toDispose.push(p.JT.create(()=>{let{next:t,parent:e}=this;t&&(t.localDirty=!0),e&&(e.localDirty=!0)}))}};$.type="FlowNodeTransformData";var Y=$,X=class extends g.RD{getDefaultData(){return{}}formatLines(t){var e,i,r;return(null==(e=this.entity.document.options)?void 0:e.formatNodeLines)?null==(r=this.entity.document.options)||null==(i=r.formatNodeLines)?void 0:i.call(r,this.entity,t):t}formatLabels(t){if(this.entity.document.options.formatNodeLabels){var e,i;return null==(i=this.entity.document.options)||null==(e=i.formatNodeLabels)?void 0:e.call(i,this.entity,t)}return t}get lines(){return this.entity.memoGlobal("lines",()=>{var t;let{getChildLines:e}=(null==(t=this.entity.parent)?void 0:t.getNodeRegistry())||{};if(e)return this.formatLines(e(this,this.entity.document.layout));let{getLines:i}=this.entity.getNodeRegistry();return i?this.formatLines(i(this,this.entity.document.layout)):this.transform.entity.isInlineBlock?[]:this.formatLines([...(t=>{let{transform:e}=t,i=e.outputPoint;return e.next?[{type:0,from:i,to:e.next.inputPoint}]:[]})(this),...(t=>{var e;let{transform:i}=t,r=i.outputPoint,n=null==(e=i.parent)?void 0:e.outputPoint;return i.next||!n||new p.E9().copyFrom(r).equals(n)||t.isNodeEnd?[]:[{type:0,from:r,to:n}]})(this)])})}get labels(){return this.entity.memoGlobal("labels",()=>{var t,e;let{getChildLabels:i}=(null==(t=this.entity.parent)?void 0:t.getNodeRegistry())||{};if(i)return this.formatLabels(i(this,this.entity.document.layout));let{getLabels:r}=this.entity.getNodeRegistry();if(r)return this.formatLabels(r(this,this.entity.document.layout));if(this.transform.entity.isInlineBlock)return[];let n=this.transform.outputPoint;if(this.transform.next)return this.formatLabels([{offset:p.E9.getMiddlePoint(n,this.transform.next.inputPoint),type:0}]);let s=null==(e=this.transform.parent)?void 0:e.outputPoint;return!s||new p.E9().copyFrom(n).equals(s)||this.isNodeEnd?[]:this.formatLabels([{offset:s,type:0}])})}get collapsed(){return this.entity.collapsed}get isNodeEnd(){return this.entity.isNodeEnd}constructor(t){super(t),this.transform=this.entity.addData(Y),this.renderData=this.entity.addData(G),this.bindChange(this.transform),this.bindChange(this.renderData)}};X.type="FlowNodeTransitionData";var j=class extends g.JH{initData(t){t.originParent!==this.originParent&&(this.originParent=t.originParent,this._registerCache=void 0),t.parent&&t.parent.addChild(this,t.index),t.meta!==this.metaFromJSON&&(this._metaCache=void 0,this.metaFromJSON=t.meta),this._hidden=!!(this.getNodeMeta().hidden||t.hidden)}get isStart(){return this.getNodeMeta().isStart}get isFirst(){return!this.pre}get isLast(){return!this.next}get isInlineBlocks(){let t=this.getNodeMeta().isInlineBlocks;return"function"==typeof t?t(this):t}get isInlineBlock(){let t=this.document.renderTree.getParent(this);return!!(t&&t.isInlineBlocks)}get isNodeEnd(){return this.memoLocal("isNodeEnd",()=>!!this.getNodeMeta().isNodeEnd||(this.isInlineBlocks&&this.collapsedChildren.length?this.collapsedChildren.every(t=>t.isNodeEnd):!!this.lastCollapsedChild&&this.lastCollapsedChild.isNodeEnd))}addChild(t,e){t.parent!==this&&this.document.originTree.addChild(this,t,e)}get hasChild(){return this.children.length>0}get pre(){return this.document.renderTree.getPre(this)}get next(){return this.document.renderTree.getNext(this)}get parent(){return this.document.renderTree.getParent(this)}getNodeRegistry(){return this._registerCache||(this._registerCache=this.document.getNodeRegistry(this.flowNodeType,this.originParent)),this._registerCache}getNodeRegister(){return this.getNodeRegistry()}getNodeMeta(){return this._metaCache||(this.metaFromJSON?this._metaCache={...this.getNodeRegistry().meta,...this.metaFromJSON}:this._metaCache=this.getNodeRegistry().meta),this._metaCache}get allChildren(){let t=[];for(let e of this.children)t.push(e),t.push(...e.allChildren);return t}get allCollapsedChildren(){let t=[];for(let e of this.collapsedChildren)t.push(e),t.push(...e.allCollapsedChildren);return t}get collapsedChildren(){return this.document.renderTree.getCollapsedChildren(this)}get blocks(){return this.collapsedChildren}get lastBlock(){return this.lastCollapsedChild}get lastCollapsedChild(){let{collapsedChildren:t}=this;return t[t.length-1]}get children(){return this.document.renderTree.getChildren(this)}get lastChild(){let{children:t}=this;return t[t.length-1]}get firstChild(){return this.children[0]}memoLocal(t,e){if(this._memoLocalCache.has(t))return this._memoLocalCache.get(t);let i=e();return this._memoLocalCache.set(t,i),i}memoGlobal(t,e){if(this._memoGlobalCache.has(t))return this._memoGlobalCache.get(t);let i=e();return this._memoGlobalCache.set(t,i),i}clearMemoGlobal(){this._memoGlobalCache.clear()}clearMemoLocal(){this._memoLocalCache.clear()}get childrenLength(){return this.children.length}get collapsed(){var t;return!!this.document.renderTree.isCollapsed(this)||!!(null==(t=this.parent)?void 0:t.collapsed)}set collapsed(t){this.document.renderTree.setCollapsed(this,t),this.clearMemoGlobal(),this.clearMemoLocal()}get hidden(){return this._hidden}openInsideCollapsed(){this.document.renderTree.openNodeInsideCollapsed(this)}getJSONData(){return this.getExtInfo()}toJSON(){return this.document.toNodeJSON(this)}get isVertical(){return"vertical-fixed-layout"===this.document.layout.name}updateExtInfo(t,e){this.getData(G).updateExtInfo(t,e)}getExtInfo(){return this.getData(G).getExtInfo()}get onExtInfoChange(){return this.renderData.onExtInfoChange}get renderData(){return this.getData(G)}get transform(){return this.getData(Y)}get bounds(){return this.transform.bounds}isExtend(t){return this.document.isExtend(this.flowNodeType,t)}isTypeOrExtendType(t){return this.document.isTypeOrExtendType(this.flowNodeType,t)}constructor(t){super(t),this._memoLocalCache=new Map,this._memoGlobalCache=new Map,this.flowNodeType="unknown",this._hidden=!1,this.index=-1,this.document=t.document,this.flowNodeType=t.flowNodeType,this.originParent=t.originParent,this.metaFromJSON=t.meta,this.onDispose(()=>{this.document.originTree.getChildren(this).slice().forEach(t=>{t.dispose()}),this.document.originTree.remove(this,!1),this.originParent=void 0})}};j.type="FlowNodeEntity",(d=j||(j={})).is=function(t){return t instanceof d};var J=class extends g.cv{getDefaultConfig(){return{loading:!0,treeVersion:0}}get loading(){return this.config.loading}set loading(t){this.config.loading!==t&&(this.config.loading=t,this.fireChange())}updateTransformsTree(){this.document.renderTree.traverse((t,e,i)=>{let r=t.getData(Y);r.collapsed&&r.transform.clearChildren(),t.parent&&r.setParentTransform(t.parent.getData(Y)),t.index=i})}clear(){this.lastTreeVersion=-1,this.lastTransformVersion=-1}isTreeDirty(){let t=this.entityManager.getEntityDataVersion(Y),e=this.lastTreeVersion!==this.config.treeVersion,i=this.lastTransformVersion!==t;return e||i}refresh(){let t=this.entityManager.getEntityDataVersion(Y),e=this.lastTreeVersion!==this.config.treeVersion,i=this.lastTransformVersion!==t;this.entityManager.changeEntityLocked=!0,e&&(this.document.renderTree.updateRenderStruct(),this.updateTransformsTree(),this.lastTreeVersion=this.config.treeVersion),(e||i)&&(this.document.layout.update(),this.lastTransformVersion=this.entityManager.getEntityDataVersion(Y),this.lastTreeVersion=this.config.treeVersion,this.onRefreshEmitter.fire()),this.entityManager.changeEntityLocked=!1}constructor(t){super(t),this.onRefreshEmitter=new p.Q5,this.lastTransformVersion=-1,this.lastTreeVersion=-1,this.onRefresh=this.onRefreshEmitter.event,this.document=t.document,this.toDispose.push(this.document.originTree.onTreeChange(()=>{this.config.treeVersion+=1,this.fireChange()})),this.toDispose.push(this.onRefreshEmitter)}};J.type="FlowDocumentTransformerEntity";var U=class extends g.cv{getDefaultConfig(){return{}}getNodeHovered(){return this.config.nodeHoveredId?this.entityManager.getEntityById(this.config.nodeHoveredId):void 0}setNodeHovered(t){this.updateConfig({nodeHoveredId:null==t?void 0:t.id})}get dragging(){return this.config.dragging}setDragging(t){this.updateConfig({dragging:t})}get isBranch(){return this.config.isBranch}setIsBranch(t){this.updateConfig({isBranch:t})}getDragLabelSide(){return this.config.dragLabelSide}setDragLabelSide(t){this.updateConfig({dragLabelSide:t})}getNodeDroppingId(){return this.config.nodeDroppingId}setNodeDroppingId(t){this.updateConfig({nodeDroppingId:t})}getDragStartEntity(){let{nodeDragStartId:t}=this.config;return this.entityManager.getEntityById(t)}setDragStartEntity(t){this.updateConfig({nodeDragStartId:null==t?void 0:t.id})}getDragEntities(){let{nodeDragIds:t}=this.config;return(t||[]).map(t=>this.entityManager.getEntityById(t))}setDragEntities(t){this.updateConfig({nodeDragIds:t.map(t=>t.id),nodeDragIdsWithChildren:t.map(t=>[t.id,...t.allCollapsedChildren.map(t=>t.id)]).flat()})}onNodeHoveredChange(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return this.onConfigChanged((0,f.Z)(()=>t(this.getNodeHovered()),e))}constructor(t){super(t)}};U.type="FlowRendererStateEntity";var H=class t{dispose(){this.map.clear(),this.onTreeChangeEmitter.dispose()}getInfo(t){let e=this.map.get(t);return e||(e={children:[]},this.map.set(t,e)),e}clear(){this.map.clear()}cloneMap(){let t=new Map;for(let[e,i]of this.map)t.set(e,{...i,children:i.children.slice()});return t}clone(){let e=new t(this.root);return e.map=this.cloneMap(),e}remove(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this.removeParent(t),e&&this._removeChildren(t),this.map.delete(t),this.fireTreeChange()}addChild(t,e,i){let r=this.getInfo(t),n=this.getInfo(e);if(n.parent){if(n.parent===t)return e;n.parent!==t&&this.removeParent(e)}let s=r.children.length,o=void 0===i?s-1:i-1,a=r.children[o],l=r.children[o+1];return a&&(this.getInfo(a).next=e),l&&(this.getInfo(l).pre=e),n.pre=a,n.next=l,r.children.splice(o+1,0,e),n.parent=t,this.fireTreeChange(),e}moveChilds(t,e,i){let r=this.getInfo(t),n=r.children.length,s=i??n;return e.forEach(t=>{this.getInfo(t).parent&&this.removeParent(t)}),e.forEach(e=>{let i=this.getInfo(e),n=r.children[s-1],o=r.children[s];n&&(this.getInfo(n).next=e),o&&(this.getInfo(o).pre=e),i.pre=n,i.next=o,r.children.splice(s,0,e),i.parent=t,s++}),this.fireTreeChange(),e}getById(t){for(let e of this.map.keys())if(e.id===t)return e}insertAfter(t,e){let i=this.getInfo(t),r=this.getInfo(e);if(this.removeParent(e),i.parent){let n=this.getInfo(i.parent);n.children.splice(n.children.indexOf(t)+1,0,e);let{next:s}=i;s&&(this.getInfo(s).pre=e),r.next=s,i.next=e,r.pre=t,r.parent=i.parent}this.fireTreeChange()}removeParent(t){let e=this.getInfo(t);if(!e.parent)return;let i=this.getInfo(e.parent),r=i.children.indexOf(t);i.children.splice(r,1);let{pre:n,next:s}=e;n&&(this.getInfo(n).next=s),s&&(this.getInfo(s).pre=n),this.fireTreeChange()}_removeChildren(t){let e=this.getChildren(t);e.length>0&&e.forEach(t=>{this._removeChildren(t),this.map.delete(t)})}getParent(t){return this.getInfo(t).parent}getPre(t){return this.getInfo(t).pre}getNext(t){return this.getInfo(t).next}getChildren(t){return this.getInfo(t).children}traverse(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.root,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(t(e,i,r)||this.getInfo(e).children.find((e,r)=>this.traverse(t,e,i+1,r)))return!0}fireTreeChange(){this.onTreeChangeEmitter.fire()}get size(){return this.map.size}toString(t){let e=[];return this.traverse((i,r)=>{0===r?e.push(i.id):e.push(`|${Array(r).fill("--").join("")} ${t?`${i.flowNodeType}(${i.id})`:i.id}`)}),`${e.join("\n")}`}constructor(t){this.root=t,this.onTreeChangeEmitter=new p.Q5,this.onTreeChange=this.onTreeChangeEmitter.event,this.map=new Map}},W=class extends H{isCollapsed(t){return this.nodesCollapsed.has(t)}get collapsedNodeList(){return Array.from(this.nodesCollapsed)}setCollapsed(t,e){e?this.nodesCollapsed.add(t):this.nodesCollapsed.delete(t),this.originTree.fireTreeChange()}openNodeInsideCollapsed(t){var e;let i=null==(e=this.originTree.getInfo(t))?void 0:e.parent;for(;i;){this.nodesCollapsed.has(i)&&this.nodesCollapsed.delete(i);let{parent:t}=this.originTree.getInfo(i)||{};i=t}this.originTree.fireTreeChange()}updateRenderStruct(){this.map=this.originTree.cloneMap(),this.document.config.get("END_NODES_REFINE_BRANCH")&&this.refineBranch(this.root),this.hideCollapsed()}hideCollapsed(){this.nodesCollapsed.forEach(t=>{let e=this.getInfo(t);if(!e)return void this.nodesCollapsed.delete(t);let i=e.children.find(t=>"blockIcon"===t.flowNodeType||"blockOrderIcon"===t.flowNodeType);if(i){let t=this.getInfo(i);t.next=void 0,t.pre=void 0,e.children=[i];return}e.children=[]})}isNodeEnd(t){if(t.getNodeMeta().isNodeEnd)return!0;let{children:e}=this.getInfo(t);return e.length>0&&t.isInlineBlocks?e.every(t=>this.isNodeEnd(t)):!!t.isInlineBlock&&this.isNodeEnd(e[e.length-1])}refineBranch(t){let e=this.getInfo(t).children[0];for(;e;){if("dynamicSplit"===e.flowNodeType||"staticSplit"===e.flowNodeType){let{next:t,children:i}=this.getInfo(e),{children:r}=this.getInfo(i[1]),n=(r||[]).filter(t=>!this.isNodeEnd(t)),s=1===n.length;if(s&&t&&this.dragNextNodesToBlock(n[0],t),null==r||r.forEach(t=>{this.refineBranch(t)}),s)break}e=e.next}}dragNextNodesToBlock(t,e){let i=this.getInfo(t),r=this.getInfo(e),n=i.children[t.children.length-1];if(r.parent){let s=this.getInfo(r.parent);r.pre&&(this.getInfo(r.pre).next=void 0),n&&(this.getInfo(n).next=e,r.pre=n);let o=s.children.indexOf(e),a=s.children.slice(o);for(let e of(s.children=s.children.slice(0,o),a)){let r=this.getInfo(e);i.children.push(e),r.parent=t}}}getInfo(t){return this.map.get(t)||this.originTree.getInfo(t)}getOriginInfo(t){return this.originTree.getInfo(t)}getCollapsedChildren(t){return this.getOriginInfo(t).children||[]}remove(){throw Error("Render Tree cannot use remove node")}addChild(){throw Error("Render tree cannot use add child")}insertAfter(){throw Error("Render tree cannot use insert after")}removeParent(){throw Error("Render tree cannot use remove parent")}constructor(t,e,i){super(t),this.root=t,this.nodesCollapsed=new Set,this.originTree=e,this.onTreeChange=this.originTree.onTreeChange,this.document=i}},K=Symbol("FlowDocumentOptions"),Z={allNodesDefaultExpanded:!1},Q={...L,INLINE_SPACING_BOTTOM:"INLINE_SPACING_BOTTOM",INLINE_BLOCKS_INLINE_SPACING_TOP:"INLINE_BLOCKS_INLINE_SPACING_TOP",INLINE_BLOCKS_INLINE_SPACING_BOTTOM:"INLINE_BLOCKS_INLINE_SPACING_BOTTOM",BASE_COLOR:"BASE_COLOR",BASE_ACTIVATED_COLOR:"BASE_ACTIVATED_COLOR",INLINE_BLOCKS_PADDING_TOP:"INLINE_BLOCKS_PADDING_TOP"},q=Symbol("FlowDocumentContribution"),tt=Symbol("FlowDocumentConfigDefaultData"),te=class{get(t){return this._data[t]}set(t,e){this.get(t)!==e&&(this._data[t]=e,this.onDataChangeEmitter.fire(t))}registerConfigs(t){Object.keys(t).forEach(e=>{this.set(e,t[e])})}constructor(t={}){this._data=t,this.onDataChangeEmitter=new p.Q5,this.onChange=this.onDataChangeEmitter.event}};te=S([(0,m.b2)(),D(0,(0,m.f3)(tt)),D(0,(0,m.jt)())],te);var ti=Symbol("FlowDocumentProvider"),tr=class{get disposed(){return this._disposed}init(){var t,e;this.options||(this.options=Z),this.currentLayoutKey=this.options.defaultLayout||"vertical-fixed-layout",this.contributions.forEach(t=>{var e;return null==(e=t.registerDocument)?void 0:e.call(t,this)}),this.root=this.addNode({id:"root",type:"root"}),this.originTree=new H(this.root),this.transformer=this.entityManager.createEntity(J,{document:this}),this.renderState=this.entityManager.createEntity(U),this.renderTree=new W(this.root,this.originTree,this),null==(t=(e=this.layout).reload)||t.call(e)}fromJSON(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this._disposed)return;this.originTree.clear(),this.renderTree.clear(),this.entityManager.changeEntityLocked=!0;let i=this.entityManager.getEntities(j),r=[this.root];this.addBlocksAsChildren(this.root,t.nodes||[],r),i.forEach(t=>{r.includes(t)||t.dispose()}),this.entityManager.changeEntityLocked=!1,this.transformer.loading=!1,e&&this.fireRender()}get layout(){let t=this.layouts.find(t=>t.name==this.currentLayoutKey);if(!t)throw Error(`Unknown flow layout: ${this.currentLayoutKey}`);return t}async load(){await Promise.all(this.contributions.map(t=>{var e;return null==(e=t.loadDocument)?void 0:e.call(t,this)}))}get loading(){return this.transformer.loading}fireRender(){this.transformer.isTreeDirty()&&(this.entityManager.fireEntityChanged(j.type),this.entityManager.fireEntityChanged(J.type))}addFromNode(t,e){let i="string"==typeof t?this.getNode(t):t;this.entityManager.changeEntityLocked=!0;let{parent:r}=i,n=this.addNode({...e,parent:r});return this.originTree.insertAfter(i,n),this.entityManager.changeEntityLocked=!1,this.entityManager.fireEntityChanged(j.type),n}removeNode(t){if("string"==typeof t){var e;null==(e=this.getNode(t))||e.dispose()}else t.dispose()}addNode(t,e){var i,r,n,s,o,a;let{id:l,type:h="block",originParent:d,parent:u,meta:c,hidden:g,index:p}=t,f=this.getNode(l),y=!1,m=this.getNodeRegistry(h,t.originParent);if(f&&f.flowNodeType!==t.type&&(f.dispose(),f=void 0),f)null==(o=(a=this.options).fromNodeJSON)||o.call(a,f,t,!1);else{let{dataRegistries:e}=m;f=this.entityManager.createEntity(j,{id:l,document:this,flowNodeType:h,originParent:d,meta:c}),null==(i=(r=this.options).preNodeCreate)||i.call(r,f);let o=e?this.nodeDataRegistries.concat(...e):this.nodeDataRegistries;f.addInitializeData(o),f.onDispose(()=>this.onNodeDisposeEmitter.fire({node:f})),null==(n=(s=this.options).fromNodeJSON)||n.call(s,f,t,!0),y=!0}if(f.initData({originParent:d,parent:u,meta:c,hidden:g,index:p}),f.isStart&&this.root.addChild(f),null==e||e.push(f),m.onCreate){let i=m.onCreate(f,t);i&&e&&e.push(...i)}else t.blocks&&t.blocks.length>0&&(t.blocks[0].type?this.addBlocksAsChildren(f,t.blocks,e):this.addInlineBlocks(f,t.blocks,e));return y?this.onNodeCreateEmitter.fire({node:f,data:t,json:t}):this.onNodeUpdateEmitter.fire({node:f,data:t,json:t}),f}addBlocksAsChildren(t,e,i){for(let r of e)this.addNode({...r,parent:t},i)}addInlineBlocks(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=this.addNode({id:`$blockIcon$${t.id}`,type:"blockIcon",originParent:t,parent:t});i.push(r);let n=this.addNode({id:`$inlineBlocks$${t.id}`,type:"inlineBlocks",originParent:t,parent:t});return i.push(n),e.forEach(e=>{this.addBlock(t,e,i)}),i}addBlock(t,e,i,r,n){var s;let o="string"==typeof t?this.getNode(t):t,{onBlockChildCreate:a}=o.getNodeRegistry();if(a)return a(o,e,i);r=r||this.getNode(`$inlineBlocks$${o.id}`);let l=this.addNode({...(0,y.Z)(e,"blocks"),type:e.type||"block",originParent:o,parent:r,index:n});(null==(s=e.meta)?void 0:s.defaultCollapsed)&&(l.collapsed=!0);let h=this.addNode({id:`$blockOrderIcon$${e.id}`,type:"blockOrderIcon",originParent:o,meta:e.meta,data:e.data,parent:l});return null==i||i.push(l,h),e.blocks&&this.addBlocksAsChildren(l,e.blocks,i),l}getNode(t){if(t)return this.entityManager.getEntityById(t)}registerFlowNodes(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(t=>{if(!t)throw Error("[FlowDocument] registerFlowNodes parameters get undefined registry.");let e=this.registers.get(t.type);this.registers.set(t.type,{...e,...t,meta:{...null==e?void 0:e.meta,...null==t?void 0:t.meta},extendChildRegistries:u.mergeChildRegistries(null==e?void 0:e.extendChildRegistries,null==t?void 0:t.extendChildRegistries)})})}isExtend(t,e){return(this.getNodeRegistry(t).__extends__||[]).includes(e)}isTypeOrExtendType(t,e){return t===e||this.isExtend(t,e)}toJSON(){if(this.disposed)throw Error("The FlowDocument has been disposed and it is no longer possible to call toJSON.");return{nodes:this.root.toJSON().blocks}}getNodeRegister(t,e){return this.getNodeRegistry(t,e)}getNodeRegistry(t,e){var i,r,n,s,o;let a=`${t}_${(null==e?void 0:e.flowNodeType)||""}`;if(this.nodeRegistryCache.has(a))return this.nodeRegistryCache.get(a);let l=null==(i=(r=this.options).getNodeDefaultRegistry)?void 0:i.call(r,t),h=this.registers.get(t)||{type:t},d=[],c=h.extend;if(h.extend&&this.registers.has(h.extend)&&(h=u.merge(this.getNodeRegistry(h.extend),h,h.type)),e){let i=null==(o=this.getNodeRegistry(e.flowNodeType).extendChildRegistries)?void 0:o.find(e=>e.type===t);i&&(i.extend&&this.registers.has(i.extend)&&d.push(this.registers.get(i.extend)),d.push(i))}h=u.extend(h,d);let g=((t,e)=>{let i=x.includes(t);return{isStart:"start"===t,hidden:i,defaultExpanded:e.options.allNodesDefaultExpanded,size:A,origin:e.layout.getDefaultNodeOrigin(),isInlineBlocks:"inlineBlocks"===t,spacing:P.SPACING,inlineSpacingPre:0,inlineSpacingAfter:0,expandable:!0,draggable:!0,selectable:!0,renderKey:"",minInlineBlockSpacing:()=>M.isVertical(e.layout)?P.MIN_INLINE_BLOCK_SPACING:P.MIN_INLINE_BLOCK_SPACING_HORIZONTAL}})(t,this);g.spacing=(null==(s=this.options)||null==(n=s.constants)?void 0:n[Q.NODE_SPACING])||g.spacing;let p={...l,...h,meta:{...g,...null==l?void 0:l.meta,...h.meta}};return c&&(p.extend=c),this.nodeRegistryCache.set(a,p),p}registerNodeDatas(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];this.nodeDataRegistries.push(...e)}traverse(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.root,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.originTree.traverse(t,e,i)}get size(){return this.getAllNodes().length}hasNode(t){return!!this.entityManager.getEntityById(t)}getAllNodes(){return this.entityManager.getEntities(j)}toString(t){return this.originTree.toString(t)}getRenderDatas(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=[];return this.renderTree.traverse(r=>{(e||!r.hidden)&&i.push(r.getData(t))}),i}toNodeJSON(t){let e;if(this.options.toNodeJSON)return this.options.toNodeJSON(t);let i={};return this.traverse(t=>{if(t.id.startsWith("$"))return;let r=t.getJSONData(),n={id:t.id,type:t.flowNodeType};void 0!==r&&(n.data=r),e||(e=n);let{parent:s}=t;s&&s.id.startsWith("$")&&(s=s.originParent);let o=s?i[s.id]:void 0;o&&(o.blocks||(o.blocks=[]),o.blocks.push(n)),i[t.id]=n},t),e}moveNodes(t){let{dropNodeId:e,sortNodeIds:i,inside:r=!1}=t,n=this.getNode(e);if(!n)return;let s=i.map(t=>this.getNode(t));for(let t of(this.entityManager.changeEntityLocked=!0,s.reverse()))r?this.originTree.addChild(n,t,0):this.originTree.insertAfter(n,t);this.entityManager.changeEntityLocked=!1,this.fireRender()}moveChildNodes(t){let{toParentId:e,toIndex:i,nodeIds:r}=t;if(0===r.length)return;let n=this.getNode(e);n&&(this.entityManager.changeEntityLocked=!0,this.originTree.moveChilds(n,r.map(t=>this.getNode(t)),i),this.entityManager.changeEntityLocked=!1,this.fireRender())}registerLayout(t){this.layouts.push(t)}setLayout(t){var e;if(this.currentLayoutKey===t)return;let i=this.layouts.find(e=>e.name===t);i&&(this.currentLayoutKey=t,this.transformer.clear(),null==(e=i.reload)||e.call(i),this.fireRender(),this.onLayoutChangeEmitter.fire(this.layout))}toggleFixedLayout(){this.setLayout("horizontal-fixed-layout"===this.layout.name?"vertical-fixed-layout":"horizontal-fixed-layout")}dispose(){this._disposed||(this.registers.clear(),this.nodeRegistryCache.clear(),this.originTree.dispose(),this.renderTree.dispose(),this.onNodeUpdateEmitter.dispose(),this.onNodeCreateEmitter.dispose(),this.onNodeDisposeEmitter.dispose(),this.onLayoutChangeEmitter.dispose(),this._disposed=!0)}constructor(){this.contributions=[],this.registers=new Map,this.nodeRegistryCache=new Map,this.nodeDataRegistries=[],this.layouts=[],this.currentLayoutKey="",this.onNodeUpdateEmitter=new p.Q5,this.onNodeCreateEmitter=new p.Q5,this.onNodeDisposeEmitter=new p.Q5,this.onLayoutChangeEmitter=new p.Q5,this.onNodeUpdate=this.onNodeUpdateEmitter.event,this.onNodeCreate=this.onNodeCreateEmitter.event,this.onNodeDispose=this.onNodeDisposeEmitter.event,this.onLayoutChange=this.onLayoutChangeEmitter.event,this._disposed=!1}};S([(0,m.f3)(g.v2)],tr.prototype,"entityManager",2),S([(0,m.f3)(te)],tr.prototype,"config",2),S([(0,m.f3)(K),(0,m.jt)()],tr.prototype,"options",2),S([(0,m.nx)(q),(0,m.jt)()],tr.prototype,"contributions",2),S([(0,m.zY)()],tr.prototype,"init",1),tr=S([(0,m.b2)()],tr);var tn=class t{get nodes(){return this.groupNode.collapsedChildren||[]}get collapsed(){return this.groupNode.getData(Y).collapsed}collapse(){this.collapsed=!0}expand(){this.collapsed=!1}get bounds(){return this.groupNode.getData(Y).bounds}isStartNode(t){if(!t)return!1;let e=this.nodes;return!!e[0]&&t.id===e[0].id}isEndNode(t){if(!t)return!1;let e=this.nodes;return!!e[e.length-1]&&t.id===e[e.length-1].id}set note(t){this.groupNode.getNodeMeta().note=t}get note(){return this.groupNode.getNodeMeta().note||""}set noteHeight(t){this.groupNode.getNodeMeta().noteHeight=t}get noteHeight(){return this.groupNode.getNodeMeta().noteHeight||0}get positionConfig(){return this.groupNode.getNodeMeta().positionConfig}set collapsed(t){var e;let i=this.groupNode.getData(Y);i.collapsed=t,i.localDirty=!0,i.parent&&(i.parent.localDirty=!0),(null==(e=i.parent)?void 0:e.firstChild)&&(i.parent.firstChild.localDirty=!0)}set hovered(t){let e=this.groupNode.getData(G);t?e.toggleMouseEnter():e.toggleMouseLeave(),e.hovered!==t&&(e.hovered=t)}get hovered(){return this.groupNode.getData(G).hovered}static create(e){if(e&&c.isGroupNode(e))return new t(e)}constructor(t){this.groupNode=t}},ts=c||(c={});let to=t=>{var e;return(null==t||null==(e=t.parent)?void 0:e.flowNodeType)==="group"};ts.validate=t=>{if(!t||!Array.isArray(t)||0===t.length||t.some(t=>(0,ts.isGroupNode)(t))||t.some(t=>t&&to(t)))return!1;let e=t[0].parent;return!(!t.every(t=>t.parent===e)||!t.map(t=>t.index).sort((t,e)=>t-e).every((t,e,i)=>0===e||t===i[e-1]+1)||(t=>{let e=[],i=t.parent;for(;i;)e.push(i),i=i.parent;return e})(t[0]).some(t=>to(t)))},ts.getNodeGroupController=t=>{if(!t||!to(t))return;let e=null==t?void 0:t.parent;return tn.create(e)},ts.getNodeRecursionGroupController=t=>{if(!t)return;let e=(0,ts.getNodeGroupController)(t);return e||(t.parent?(0,ts.getNodeRecursionGroupController)(t.parent):void 0)},ts.isGroupNode=t=>"group"===t.flowNodeType;var ta=class{get renderState(){return this.document.renderState}get dragStartNode(){return this.renderState.getDragStartEntity()}get dragNodes(){return this.renderState.getDragEntities()}get dropNodeId(){return this.renderState.getNodeDroppingId()}get isDragBranch(){var t;return this.renderState.isBranch||(null==(t=this.dragStartNode)?void 0:t.isInlineBlock)}get nodeDragIdsWithChildren(){return this.renderState.config.nodeDragIdsWithChildren||[]}get dragging(){return!!this.renderState.dragging}get labelSide(){return this.renderState.config.dragLabelSide}dropBranch(){this.dropNode()}async dropCreateNode(t,e){let i=this.document.getNode(this.dropNodeId);if(i&&t){let r=await (null==e?void 0:e(t,i));this.onDropEmitter.fire({dropNode:i,dragNodes:r?[r]:[],dragJSON:t})}}dropNode(){let t=this.document.getNode(this.dropNodeId);if(!t)return;let e=[],i=this.dragStartNode;for(;i&&this.dragNodes.includes(i);)e.push(i),i=i.next;this.operationService.dragNodes({dropNode:t,nodes:e}),e.length>0&&this.onDropEmitter.fire({dropNode:t,dragNodes:e})}isDroppableNode(t){return!(!this.dragging||this.isDragBranch||this.nodeDragIdsWithChildren.includes(t.id)||t.next&&this.nodeDragIdsWithChildren.includes(t.next.id)||t.isInlineBlocks||t.isInlineBlock||this.dragNodes.some(t=>"group"===t.flowNodeType)&&c.getNodeRecursionGroupController(t))&&!0}isDroppableBranch(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal_branch";if(this.renderState.isBranch)return!0;if(this.isDragBranch){if(!t.isInlineBlock||t.parent!==this.dragStartNode.parent||t===this.dragStartNode)return!1;if("normal_branch"===e&&t.next!==this.dragStartNode||"pre_branch"===e&&t.pre!==this.dragStartNode)return!0}return!1}constructor(){this.onDropEmitter=new p.Q5,this.onDrop=this.onDropEmitter.event}};S([(0,m.f3)(tr)],ta.prototype,"document",2),S([(0,m.f3)(F)],ta.prototype,"operationService",2),S([(0,m.f3)(g.v2)],ta.prototype,"entityManager",2),ta=S([(0,m.b2)()],ta);var tl=class{init(){this.toDispose.pushAll([this.onNodeAddEmitter,this.onNodeMoveEmitter])}addNode(t){let e,i,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{parent:s,index:o,hidden:a}=n;s&&(e=this.toNodeEntity(s)),e&&(i=e.getNodeRegistry());let l={...t,type:t.type||"block"},h={...l,parent:e,index:o,hidden:a};return r=e&&(null==i?void 0:i.addChild)?i.addChild(e,l,{index:o,hidden:a}):this.document.addNode(h),this.onNodeAddEmitter.fire({node:r,data:h}),r}addFromNode(t,e){return this.document.addFromNode(t,e)}deleteNode(t){this.document.removeNode(t)}deleteNodes(t){(t||[]).forEach(t=>{this.deleteNode(t)})}addBlock(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{parent:r,index:n}=i;return this.document.addBlock(t,e,void 0,r,n)}moveNode(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{parent:i,index:r}=e,n=this.toNodeEntity(t),s=null==n?void 0:n.parent;if(!s)return;let o=i?this.toNodeEntity(i):s;if(!o)return void console.warn("no new parent found",i);let a=void 0===r?o.collapsedChildren.length:r;return this.doMoveNode(n,o,a)}dragNodes(t){let{dropNode:e,nodes:i}=t;if(0===i.length)return;let r=i[0],n=r.parent,s=e.parent;if(!n||!s)return;let o=n.children.findIndex(t=>t===r),a=s.children.findIndex(t=>t===e),l=a+1;n===s&&o<a&&(l-=i.length);let h={nodeIds:i.map(t=>t.id),fromParentId:n.id,toParentId:s.id,fromIndex:o,toIndex:l};return this.apply({type:"moveChildNodes",value:h})}apply(t){var e,i,r,n,s,o;let a=this.document;switch(t.type){case"addFromNode":return a.addFromNode(t.value.fromId,t.value.data);case"deleteFromNode":return null==(e=a.getNode(null==(r=t.value)||null==(i=r.data)?void 0:i.id))?void 0:e.dispose();case"addBlock":{let e;return t.value.parentId&&(e=a.getNode(t.value.parentId)),a.addBlock(t.value.targetId,t.value.blockData,void 0,e,t.value.index)}case"deleteBlock":{let e=a.getNode(null==(n=t.value)?void 0:n.blockData.id);return null==e?void 0:e.dispose()}case"createGroup":{let e=a.addFromNode(t.value.targetId,{id:t.value.groupId,type:"group"});return a.moveNodes({dropNodeId:t.value.groupId,sortNodeIds:t.value.nodeIds,inside:!0}),e}case"ungroup":return a.moveNodes({dropNodeId:t.value.groupId,sortNodeIds:t.value.nodeIds}),null==(s=a.getNode(t.value.groupId))?void 0:s.dispose();case"moveNodes":return a.moveNodes({dropNodeId:t.value.toId,sortNodeIds:t.value.nodeIds});case"moveBlock":return a.moveChildNodes({...t.value,nodeIds:[t.value.nodeId]});case"addNodes":{let e=t.value.fromId;(t.value.nodes||[]).forEach(t=>{e=a.addFromNode(e,t).id});break}case"deleteNodes":(t.value.nodes||[]).forEach(t=>{let e=a.getNode(t.id);null==e||e.dispose()});break;case"addChildNode":return a.addNode({...t.value.data,parent:t.value.parentId?a.getNode(t.value.parentId):void 0,originParent:t.value.originParentId?a.getNode(t.value.originParentId):void 0,index:t.value.index,hidden:t.value.hidden});case"deleteChildNode":return null==(o=a.getNode(t.value.data.id))?void 0:o.dispose();case"moveChildNodes":return a.moveChildNodes(t.value);default:throw Error("unknown operation type")}}transact(t){t()}dispose(){this.toDispose.dispose()}toId(t){return"string"==typeof t?t:t.id}toNodeEntity(t){return"string"==typeof t?this.document.getNode(t):t}getNodeIndex(t){let e=this.toNodeEntity(t),i=null==e?void 0:e.parent;return i?i.children.findIndex(t=>t===e):-1}doMoveNode(t,e,i){if(!t.parent)throw Error("root node cannot move");let r={node:t,fromParent:t.parent,toParent:e,fromIndex:this.getNodeIndex(t),toIndex:i};this.document.moveChildNodes({nodeIds:[this.toId(t)],toParentId:this.toId(e),toIndex:i}),this.onNodeMoveEmitter.fire(r)}constructor(){this.onNodeAddEmitter=new p.Q5,this.onNodeAdd=this.onNodeAddEmitter.event,this.toDispose=new p.K4,this.onNodeMoveEmitter=new p.Q5,this.onNodeMove=this.onNodeMoveEmitter.event}};S([(0,m.f3)(g.v2)],tl.prototype,"entityManager",2),S([(0,m.f3)(tr)],tl.prototype,"document",2),S([(0,m.zY)()],tl.prototype,"init",1),tl=S([(0,m.b2)()],tl);var th=class{createGroup(t){if(!t||!Array.isArray(t)||0===t.length||!c.validate(t))return;let e=t.sort((t,e)=>t.index-e.index)[0],i=`group_${(0,E.x0)(5)}`;this.operationService.apply({type:"createGroup",value:{targetId:e.id,groupId:i,nodeIds:t.map(t=>t.id)}});let r=this.entityManager.getEntityById(i);if(!r)return;let n=this.groupController(r);if(n)return n.expand(),r}deleteGroup(t){let e=t.toJSON();t.pre&&e&&this.operationService.apply({type:"deleteNodes",value:{fromId:t.pre.id,nodes:[e]}})}ungroup(t){let e=this.groupController(t);if(!e)return;let i=e.nodes;t.pre&&(e.collapse(),this.operationService.apply({type:"ungroup",value:{groupId:t.id,targetId:t.pre.id,nodeIds:i.map(t=>t.id)}}))}getAllGroups(){return this.entityManager.getEntities(j).filter(t=>"group"===t.flowNodeType).map(t=>this.groupController(t)).filter(Boolean)}groupController(t){return tn.create(t)}static validate(t){return c.validate(t)}};S([(0,m.f3)(g.v2)],th.prototype,"entityManager",2),S([(0,m.f3)(F)],th.prototype,"operationService",2),th=S([(0,m.b2)()],th);var td=class{get document(){return this.documentProvider()}reload(){this.structDataMap=new WeakMap}update(){this.updateLocalTransform(this.document.root)}updateLocalTransform(t){var e,i,r,n;let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{children:o,parent:a,isInlineBlock:l}=t,h=t.getData(Y),{getDelta:d,getOrigin:u}=t.getNodeRegistry(),c=this.structDataMap.get(t)||{childrenLength:0,index:-1};t.clearMemoGlobal();let g=h.localDirty||s,p={index:t.index,childrenLength:t.children.length};(c.childrenLength!==p.childrenLength||c.index!==p.index)&&(g=!0,this.structDataMap.set(t,p));let f=!1;if(o.length>0)for(let t of o)this.updateLocalTransform(t,f)&&(f=!0,g=!0);if(!g)return!1;t.clearMemoLocal(),h.transform.update({origin:u?u(h,this):this.getDefaultNodeOrigin()});let y=h.pre,m=(null==d?void 0:d(h,this))||{x:0,y:0},E=l&&(null==(e=h.parent)?void 0:e.inlineSpacingPre)?null==(i=h.parent)?void 0:i.inlineSpacingPre:0,b=(null==a||null==(r=(n=a.getNodeRegistry()).getChildDelta)?void 0:r.call(n,h,this))||{x:0,y:0};m.x+=b.x,m.y+=b.y;let C={x:m.x,y:m.y};return l?C.y+=E:(C.y+=(null==y?void 0:y.localBounds.bottom)||0,C.y+=(null==y?void 0:y.spacing)||0),h.transform.update({size:h.data.size,position:C}),this.onAfterUpdateLocalTransform(h),h.localDirty=!1,!0}onAfterUpdateLocalTransform(t){var e;let{onAfterUpdateLocalTransform:i}=t.entity.getNodeRegistry();null==i||i(t,this),null==(e=this.contribs)||e.forEach(e=>{var i;null==e||null==(i=e.onAfterUpdateLocalTransform)||i.call(e,t,this)})}getNodeTransform(t){return t.getData(Y)}getPadding(t){let{inlineSpacingPre:e,inlineSpacingAfter:i,padding:r}=t.getNodeMeta(),n=this.getNodeTransform(t);return r?"function"==typeof r?r(n):r:{left:0,top:"function"==typeof e?e(n):e,right:0,bottom:"function"==typeof i?i(n):i}}getInitScroll(t){return{scrollX:-t.width/2,scrollY:-36}}getDefaultInputPoint(t){return this.getNodeTransform(t).bounds.topCenter}getDefaultOutputPoint(t){return this.getNodeTransform(t).bounds.bottomCenter}getDefaultNodeOrigin(){return{x:.5,y:0}}constructor(){this.name="vertical-fixed-layout",this.structDataMap=new WeakMap}};S([(0,m.f3)(ti)],td.prototype,"documentProvider",2),S([(0,m.nx)(N),(0,m.jt)()],td.prototype,"contribs",2),td=S([(0,m.b2)()],td);var tu=class{get document(){return this.documentProvider()}reload(){this.structDataMap=new WeakMap}update(){this.updateLocalTransform(this.document.root)}updateLocalTransform(t){var e,i,r,n;let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{children:o,parent:a,isInlineBlock:l}=t,h=t.getData(Y),{getDelta:d,getOrigin:u}=t.getNodeRegistry(),c=this.structDataMap.get(t)||{childrenLength:0,index:-1};t.clearMemoGlobal();let g=h.localDirty||s,p={index:t.index,childrenLength:t.children.length};(c.childrenLength!==p.childrenLength||c.index!==p.index)&&(g=!0,this.structDataMap.set(t,p));let f=!1;if(o.length>0)for(let t of o)this.updateLocalTransform(t,f)&&(f=!0,g=!0);if(!g)return!1;t.clearMemoLocal(),h.transform.update({origin:u?u(h,this):this.getDefaultNodeOrigin()});let y=h.pre,m=(null==d?void 0:d(h,this))||{x:0,y:0},E=l&&(null==(e=h.parent)?void 0:e.inlineSpacingPre)?null==(i=h.parent)?void 0:i.inlineSpacingPre:0,b=(null==a||null==(r=(n=a.getNodeRegistry()).getChildDelta)?void 0:r.call(n,h,this))||{x:0,y:0};m.x+=b.x,m.y+=b.y;let C={x:m.x,y:m.y};return l?C.x+=E:(C.x+=(null==y?void 0:y.localBounds.right)||0,C.x+=(null==y?void 0:y.spacing)||0),h.transform.update({size:h.data.size,position:C}),this.onAfterUpdateLocalTransform(h),h.localDirty=!1,!0}onAfterUpdateLocalTransform(t){var e;let{onAfterUpdateLocalTransform:i}=t.entity.getNodeRegistry();null==i||i(t,this),null==(e=this.contribs)||e.forEach(e=>{var i;null==e||null==(i=e.onAfterUpdateLocalTransform)||i.call(e,t,this)})}getNodeTransform(t){return t.getData(Y)}getPadding(t){let{inlineSpacingPre:e,inlineSpacingAfter:i,padding:r}=t.getNodeMeta(),n=this.getNodeTransform(t);return r?"function"==typeof r?r(n):r:{left:"function"==typeof e?e(n):e,top:0,right:"function"==typeof i?i(n):i,bottom:0}}getInitScroll(t){return{scrollX:-36,scrollY:-t.height/2}}getDefaultInputPoint(t){return this.getNodeTransform(t).bounds.leftCenter}getDefaultOutputPoint(t){return this.getNodeTransform(t).bounds.rightCenter}getDefaultNodeOrigin(){return{x:0,y:.5}}constructor(){this.name="horizontal-fixed-layout",this.structDataMap=new WeakMap}};S([(0,m.f3)(ti)],tu.prototype,"documentProvider",2),S([(0,m.nx)(N),(0,m.jt)()],tu.prototype,"contribs",2),tu=S([(0,m.b2)()],tu);var tc=new m.nZ(t=>{t(tr).toSelf().inSingletonScope(),t(ti).toDynamicValue(t=>()=>t.container.get(tr)).inSingletonScope(),t(te).toSelf().inSingletonScope(),t(td).toSelf().inSingletonScope(),t(tu).toSelf().inSingletonScope(),t(ta).toSelf().inSingletonScope(),t(F).to(tl).inSingletonScope(),t(th).toSelf().inSingletonScope(),t(q).toDynamicValue(t=>({registerDocument:e=>{e.registerLayout(t.container.get(td)),e.registerLayout(t.container.get(tu))}}))}),tg=(t,e,i)=>{var r;let n=t.getService(K);return(null==n||null==(r=n.constants)?void 0:r[e])||i||P[e]}},336330:function(t,e,i){i.d(e,{x0:()=>P,gw:()=>w.gw,gO:()=>ta,v6:()=>tg,dm:()=>W,ps:()=>$,xV:()=>p,FD:()=>B,sJ:()=>to,XH:()=>J,SP:()=>g,QW:()=>F,Qu:()=>R,uB:()=>T,iw:()=>tr,PF:()=>tu,_s:()=>tf,YC:()=>tc,fY:()=>U,n2:()=>A,jg:()=>H,L4:()=>tt,G2:()=>E.G2,CT:()=>V,oJ:()=>j,e2:()=>X,PV:()=>td,Dc:()=>E.Dc,ZO:()=>ts,Z1:()=>G,fT:()=>c,KH:()=>L});var r,n,s,o,a,l,h,d,u=Symbol(""),c=((r=c||{}).ADD_NODE="ADD_NODE",r.DELETE_NODE="DELETE_NODE",r.MOVE_NODE="MOVE_NODE",r.NODE_DATA_CHANGE="NODE_DATA_CHANGE",r.ADD_LINE="ADD_LINE",r.DELETE_LINE="DELETE_LINE",r.LINE_DATA_CHANGE="LINE_DATA_CHANGE",r.META_CHANGE="META_CHANGE",r),g=((n=g||{})[n.BEZIER=0]="BEZIER",n[n.LINE_CHART=1]="LINE_CHART",n[n.STRAIGHT=2]="STRAIGHT",n),p=Symbol("WorkflowOperationBaseService"),f=Object.defineProperty,y=Object.getOwnPropertyDescriptor,m=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?y(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&f(e,i,s),s},E=i(893740),b=i(908600),C=i(875787),S=i(928079),D=i(579962),_=i(9163),w=i(832176),x=i(129034),N=i(938573),M=i(374488),I=i(57064),T=((s=T||{}).DELETE_NODES="DELETE_NODES",s.COPY_NODES="COPY_NODES",s.PASTE_NODES="PASTE_NODES",s.ZOOM_IN="ZOOM_IN",s.ZOOM_OUT="ZOOM_OUT",s.UNDO="UNDO",s.REDO="REDO",s);function L(t,e,i,r){return{x:i.center.x,y:i.center.y,labelX:i.center.x-i.x+r,labelY:i.center.y-i.y+r}}function P(t){return(0,x.x0)(t)}var R=function(t,e){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],r=w.Ae.enlarge(t.getAllNodes().map(t=>t.getData(E.VO).bounds));return e.fitView(r,i,30)};function A(t,e,i){let{x:r,y:n}=e;for(let e of(i?i.collapsedChildren:t.getAllNodes()).map(t=>{let e=t.getData(E.VO);return{x:e.position.x,y:e.position.y}}).sort((t,e)=>t.y-e.y)){let{x:t,y:i}=e;if(n-i<-3)break;let s=Math.abs(n-i);3>=Math.abs(r-t)&&s<=3&&(r+=30,n+=30)}return{x:r,y:n}}var k=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return`port_${e}_${t.id}_${i}`},O="WorkflowLineEntity",V=D.GA,B=class extends E.JH{static getPortEntityId(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return k(t,e,i)}get position(){return this._location}get hasError(){return this._hasError}set hasError(t){t!==this._hasError&&(this._hasError=t,this._onErrorChangedEmitter.fire())}validate(){let t=this.allLines.some(t=>!t.disposed&&!t.isHidden&&t.hasError),e=this.node.document.isErrorPort(this);this.hasError=t||e}isErrorPort(){return this.node.document.isErrorPort(this,this.hasError)}get location(){return this._location?this._location:"input"===this.portType?"left":"right"}get point(){let{targetElement:t,_locationConfig:e}=this,{bounds:i}=this.node.getData(D.eG),r=this.location;if(t){var n;let e=(n=t.getBoundingClientRect(),new w.Ae(n.x,n.y,n.width,n.height)).center,i=this.entityManager.getEntity(E.ER).getPosFromMouseEvent({clientX:e.x,clientY:e.y});return{x:i.x,y:i.y,location:r}}if(e)return{...function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0},r={...i};return void 0!==e.left?r.x+="string"==typeof e.left?.01*parseFloat(e.left)*t.width:e.left:void 0!==e.right&&(r.x+=t.width-("string"==typeof e.right?.01*parseFloat(e.right)*t.width:e.right)),void 0!==e.top?r.y+="string"==typeof e.top?.01*parseFloat(e.top)*t.height:e.top:void 0!==e.bottom&&(r.y+=t.height-("string"==typeof e.bottom?.01*parseFloat(e.bottom)*t.height:e.bottom)),{x:t.x+r.x,y:t.y+r.y}}(i,e,this._offset),location:r};let s=this._offset||{x:0,y:0},o={x:0,y:0};switch(r){case"left":o=i.leftCenter;break;case"top":o=i.topCenter;break;case"right":o=i.rightCenter;break;case"bottom":o=i.bottomCenter}return{x:o.x+s.x,y:o.y+s.y,location:r}}get bounds(){let{point:t}=this,e=this._size||{width:24,height:24};return new w.Ae(t.x-e.width/2,t.y-e.height/2,e.width,e.height)}isHovered(t,e){return this.bounds.contains(t,e)}get relativePosition(){let{point:t}=this,{bounds:e}=this.node.getData(D.eG);return{x:t.x-e.x,y:t.y-e.y}}updateTargetElement(t){t!==this.targetElement&&(this.targetElement=t,this.fireChange())}get disabled(){let t=this.node.document;if("function"==typeof t.options.isDisabledPort)return t.options.isDisabledPort(this);if(this._disabled)return!0;let e=this.node.getNodeMeta();return"input"===this.portType?!!e.inputDisable:!!e.outputDisable}get lines(){return this.allLines.filter(t=>!t.isDrawing)}get availableLines(){return this.allLines.filter(t=>!t.isDrawing&&!t.isHidden)}get allLines(){let t=[];return this.entityManager.getEntities({type:O}).forEach(e=>{(e.toPort===this||e.fromPort===this)&&t.push(e)}),t}update(t){let e=!1;t.targetElement!==this.targetElement&&(this.targetElement=t.targetElement,e=!0),t.location!==this._location&&(this._location=t.location,e=!0),w.XJ.isChanged(t.offset,this._offset)&&(this._offset=t.offset,e=!0),w.XJ.isChanged(t.locationConfig,this._locationConfig)&&(this._locationConfig=t.locationConfig,e=!0),w.XJ.isChanged(t.size,this._size)&&(this._size=t.size,e=!0),t.disabled!==this._disabled&&(this._disabled=t.disabled,e=!0),e&&this.fireChange()}dispose(){this.lines.forEach(t=>t.dispose()),super.dispose()}constructor(t){super(t),this.portID="",this._hasError=!1,this._onErrorChangedEmitter=new w.Q5,this.onErrorChanged=this._onErrorChangedEmitter.event,this.portID=t.portID||"",this.portType=t.type,this._disabled=t.disabled,this._offset=t.offset,this._locationConfig=t.locationConfig,this._location=t.location,this._size=t.size,this.node=t.node,this.updateTargetElement(t.targetElement),this.toDispose.push(this.node.getData(E.VO).onDataChange(()=>this.fireChange())),this.toDispose.push(this.node.onDispose(this.dispose.bind(this)))}};B.type="WorkflowPortEntity";var F=class extends E.RD{getDefaultData(){return{}}updateAllPorts(t){let e=this.entity.getNodeMeta();t&&(this._staticPorts=t),e.useDynamicPort?this.updateDynamicPorts():this.updatePorts(this._staticPorts)}updateStaticPorts(t){this.updateAllPorts(t)}updateDynamicPorts(){let t=this.entity.getData(D.Lz).node.querySelectorAll("[data-port-id]"),e=this._staticPorts,i=[];t.length>0&&i.push(...Array.from(t).map(t=>({portID:t.getAttribute("data-port-id"),type:t.getAttribute("data-port-type"),location:t.getAttribute("data-port-location"),targetElement:t}))),this.updatePorts(e.concat(i))}getPortEntityByKey(t,e){return this.getOrCreatePortEntity({type:t,portID:e})}updatePorts(t){if(!(0,N.Z)(this._prePorts,t)){let e=t.map(t=>this.getPortId(t.type,t.portID));this._portIDSet.forEach(t=>{if(!e.includes(t)){var i;null==(i=this.getPortEntity(t))||i.dispose()}}),t.forEach(t=>this.updatePortEntity(t)),this._prePorts=t,this.fireChange()}this.allPorts.forEach(t=>{t.allLines.forEach(t=>{t.validate()})})}get allPorts(){return Array.from(this._portIDSet).map(t=>this.getPortEntity(t)).filter(Boolean)}get inputPorts(){return this.allPorts.filter(t=>"input"===t.portType)}get outputPorts(){return this.allPorts.filter(t=>"output"===t.portType)}get inputPoints(){return this.inputPorts.map(t=>t.point)}get outputPoints(){return this.inputPorts.map(t=>t.point)}getInputPoint(t){return this.getPortEntityByKey("input",t).point}getOutputPoint(t){return this.getPortEntityByKey("output",t).point}getPortEntity(t){if(this._portIDSet.has(t))return this.entity.entityManager.getEntityById(t)}getPortId(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return k(this.entity,t,e)}createPortEntity(t){let e=this.getPortId(t.type,t.portID),i=this.entity.entityManager.getEntityById(e);return i||(i=this.entity.entityManager.createEntity(B,{id:e,node:this.entity,...t})),i.onDispose(()=>{this._portIDSet.delete(e)}),this._portIDSet.add(e),i}getOrCreatePortEntity(t){let e=this.getPortId(t.type,t.portID);return this.getPortEntity(e)??this.createPortEntity(t)}updatePortEntity(t){let e=this.getOrCreatePortEntity(t);return e.update(t),e}constructor(t){var e;super(t),this._staticPorts=[],this._portIDSet=new Set,this.entity=t;let i=t.getNodeMeta(),r=i.useDynamicPort?[]:[{type:"input"},{type:"output"}];this._staticPorts=(null==(e=i.defaultPorts)?void 0:e.slice())||r,this.updatePorts(this._staticPorts),i.useDynamicPort&&this.toDispose.push(t.getData(E._z).onDataChange(()=>{t.getData(E._z).width&&t.getData(E._z).height&&this.updateDynamicPorts()})),this.onDispose(()=>{this.allPorts.forEach(t=>t.dispose())})}};F.type="WorkflowNodePortsData";var z=class t extends E.RD{getDefaultData(){return{inputLines:[],outputLines:[]}}get inputLines(){return this.data.inputLines}get outputLines(){return this.data.outputLines}get allLines(){return this.data.inputLines.concat(this.data.outputLines)}get availableLines(){return this.allLines.filter(t=>!t.isDrawing&&!t.isHidden)}get inputNodes(){return this.inputLines.map(t=>t.from).filter(Boolean)}get allInputNodes(){let e=new Set,i=r=>{if(e.has(r))return;e.add(r);let{inputNodes:n}=r.getData(t);n&&n.length&&n.forEach(t=>{(null==t?void 0:t.parent)!==r&&(null==r?void 0:r.parent)!==t&&i(t)})};return i(this.entity),e.delete(this.entity),Array.from(e)}get outputNodes(){return this.outputLines.map(t=>t.to).filter(Boolean)}get allOutputNodes(){let e=new Set,i=r=>{if(e.has(r))return;e.add(r);let{outputNodes:n}=r.getData(t);n&&n.length&&n.forEach(t=>{(null==t?void 0:t.parent)!==r&&(null==r?void 0:r.parent)!==t&&i(t)})};return i(this.entity),e.delete(this.entity),Array.from(e)}addLine(t){t.from===this.entity?this.outputLines.push(t):this.inputLines.push(t),this.fireChange()}removeLine(t){let{inputLines:e,outputLines:i}=this,r=e.indexOf(t),n=i.indexOf(t);-1!==r&&(e.splice(r,1),this.fireChange()),-1!==n&&(i.splice(n,1),this.fireChange())}constructor(t){super(t),this.entity=t,this.entity.preDispose.push(w.JT.create(()=>{this.inputLines.slice().forEach(t=>t.dispose()),this.outputLines.slice().forEach(t=>t.dispose())}))}};z.type="WorkflowNodeLinesData";var G=z,$=class extends E.RD{getDefaultData(){return{version:"",contributions:new Map,position:{from:{x:0,y:0,location:"right"},to:{x:0,y:0,location:"left"}}}}get renderVersion(){return this.data.version}get position(){return this.data.position}get path(){var t;return(null==(t=this.currentLine)?void 0:t.path)??""}calcDistance(t){var e;return(null==(e=this.currentLine)?void 0:e.calcDistance(t))??Number.MAX_SAFE_INTEGER}get bounds(){var t;return(null==(t=this.currentLine)?void 0:t.bounds)??new w.Ae}update(){var t;this.syncContributions();let e=this.data.version;this.updatePosition();let i=this.data.version;e!==i&&(this.data.version=i,null==(t=this.currentLine)||t.update({fromPos:this.data.position.from,toPos:this.data.position.to}))}get lineType(){return this.entity.renderType??this.entity.linesManager.lineType}get center(){var t;return(null==(t=this.currentLine)?void 0:t.center)||{x:0,y:0,labelX:0,labelY:0}}updatePosition(){this.data.position.from=this.entity.drawingFrom||this.entity.fromPort.point,this.data.position.to=this.entity.drawingTo||this.entity.toPort.point,this.data.version=[this.lineType,this.data.position.from.x,this.data.position.from.y,this.data.position.from.location,this.data.position.to.x,this.data.position.to.y,this.data.position.to.location].join("-")}get currentLine(){return this.data.contributions.get(this.lineType)}syncContributions(){this.entity.linesManager.contributionFactories.length!==this.data.contributions.size&&this.entity.linesManager.contributionFactories.forEach(t=>{this.registerContribution(t)})}registerContribution(t){if(this.data.contributions.has(t.type))return;let e=new t(this.entity);this.data.contributions.set(t.type,e)}constructor(t){super(t),this.syncContributions()}};$.type="WorkflowLineRenderData";var Y=class t extends E.JH{static portInfoToLineId(t){let{from:e,to:i,fromPort:r,toPort:n}=t;return`${e}_${r||""}-${i||""}_${n||""}`}get uiState(){return this._uiState}updateUIState(t){let e=!1;Object.keys(t).forEach(i=>{let r=t[i];this._uiState[i]!==r&&(this._uiState[i]=r,e=!0)}),e&&this.fireChange()}get lineData(){return this._lineData}set lineData(t){let e=this._lineData;(0,N.Z)(e,t)||(this._lineData=t,this._onLineDataChangeEmitter.fire({oldValue:e,newValue:t}),this.fireChange())}get from(){return this._from}get to(){return this._to}get isHidden(){return this.highlightColor===this.linesManager.lineColor.hidden}get inContainer(){let t=t=>!!(null==t?void 0:t.parent)&&"root"!==t.parent.flowNodeType;return t(this.from)||t(this.to)}get processing(){return this._uiState.flowing}set processing(t){this.flowing=t}get hasError(){return this.uiState.hasError}set hasError(t){this.updateUIState({hasError:t}),this._node&&(this._node.dataset.hasError=this.hasError?"true":"false")}setToPort(t){if(!this.isDrawing)throw Error("[setToPort] only support drawing line.");if(this.toPort===t)return;let e=this.toPort;if(t&&"input"===t.portType&&this.linesManager.canAddLine(this.fromPort,t,!0)){let{node:e,portID:i}=t;this._to=e,this.info.drawingTo=void 0,this.info.to=e.id,this.info.toPort=i}else this._to=void 0,this.info.to=void 0,this.info.toPort="";e&&e.validate(),this.fireChange()}setFromPort(t){if(!this.isDrawing)throw Error("[setFromPort] only support drawing line.");if(this.fromPort===t)return;let e=this.fromPort;if(t&&"output"===t.portType&&this.linesManager.canAddLine(t,this.toPort,!0)){let{node:e,portID:i}=t;this._from=e,this.info.drawingFrom=void 0,this.info.from=e.id,this.info.fromPort=i}else this._from=void 0,this.info.from=void 0,this.info.fromPort="";e&&e.validate(),this.fireChange()}set drawingTo(t){let e=this.info.drawingTo;if(!t){this.info.drawingTo=void 0,this.fireChange();return}e&&t.x===e.x&&t.y===e.y||(this.info.to=void 0,this.info.drawingTo=t,this.fireChange())}set drawingFrom(t){let e=this.info.drawingFrom;if(!t){this.info.drawingFrom=void 0,this.fireChange();return}e&&t.x===e.x&&t.y===e.y||(this.info.from=void 0,this.info.drawingFrom=t,this.fireChange())}get drawingFrom(){return this.info.drawingFrom}get drawingTo(){return this.info.drawingTo}get highlightColor(){return this.uiState.highlightColor||""}set highlightColor(t){this.updateUIState({highlightColor:t})}get lockedColor(){return this.uiState.lockedColor}set lockedColor(t){this.updateUIState({lockedColor:t})}get bounds(){return this.getData($).bounds}get center(){return this.getData($).center}getHoverDist(t){return this.getData($).calcDistance(t)}get fromPort(){if(this.from)return this.from.ports.getPortEntityByKey("output",this.info.fromPort)}get toPort(){if(this.to)return this.to.ports.getPortEntityByKey("input",this.info.toPort)}get position(){return this.getData($).position}get reverse(){return this.linesManager.isReverseLine(this,this.uiState.reverse)}get hideArrow(){return this.linesManager.isHideArrowLine(this,this.uiState.hideArrow)}get flowing(){return this.linesManager.isFlowingLine(this,this.uiState.flowing)}set flowing(t){this._uiState.flowing!==t&&(this._uiState.flowing=t,this.fireChange())}get disabled(){return this.linesManager.isDisabledLine(this,this.uiState.disabled)}get vertical(){var t,e;let i=null==(t=this.fromPort)?void 0:t.location,r=null==(e=this.toPort)?void 0:e.location;return r?"top"===r:"bottom"===i}get renderType(){return this.linesManager.setLineRenderType(this)}get className(){return[this.linesManager.setLineClassName(this),this._uiState.className].filter(t=>!!t).join(" ")}get color(){return this.linesManager.getLineColor(this)}initInfo(t){(0,N.Z)(t,this.info)||(this.info=t,this._from=t.from?this.document.getNode(t.from):void 0,this._to=t.to?this.document.getNode(t.to):void 0,this._lineData=t.data,this.fireChange())}validate(){this.validateSelf()}validateSelf(){let{fromPort:t,toPort:e}=this;t&&(this.hasError=this.linesManager.isErrorLine(t,e,this.uiState.hasError))}is(e){return e instanceof t?this===e:t.portInfoToLineId(e)===this.id}canRemove(t){return this.linesManager.canRemove(this,t)}get node(){var t,e,i,r;return this._node||(this._node=w.xF.createDivWithClass("gedit-flow-activity-line"),this._node.dataset.testid="sdk.workflow.canvas.line",this._node.dataset.lineId=this.id,this._node.dataset.fromNodeId=(null==(t=this.from)?void 0:t.id)??"",this._node.dataset.fromPortId=(null==(e=this.fromPort)?void 0:e.id)??"",this._node.dataset.toNodeId=(null==(i=this.to)?void 0:i.id)??"",this._node.dataset.toPortId=(null==(r=this.toPort)?void 0:r.id)??"",this._node.dataset.hasError=this.hasError?"true":"false"),this._node}toJSON(){let t={sourceNodeID:this.info.from,targetNodeID:this.info.to,sourcePortID:this.info.fromPort,targetPortID:this.info.toPort};return void 0!==this._lineData&&(t.data=this._lineData),t.sourcePortID||delete t.sourcePortID,t.targetPortID||delete t.targetPortID,t}fireRender(){this.fireChange()}constructor(t){super(t),this._onLineDataChangeEmitter=new w.Q5,this.onLineDataChange=this._onLineDataChangeEmitter.event,this._uiState={hasError:!1,flowing:!1,disabled:!1,hideArrow:!1,reverse:!1,shrink:10,curvature:.25,highlightColor:"",lockedColor:""},this.stackIndex=0,this.info={from:""},this.document=t.document,this.linesManager=t.linesManager,this.initInfo({from:t.from,to:t.to,drawingTo:t.drawingTo,fromPort:t.fromPort,drawingFrom:t.drawingFrom,toPort:t.toPort,data:t.data}),(t.drawingTo||t.drawingFrom)&&(this.isDrawing=!0),this.onEntityChange(()=>{var t,e;null==(t=this.fromPort)||t.validate(),null==(e=this.toPort)||e.validate()}),this.onDispose(()=>{var t,e;null==(t=this.fromPort)||t.validate(),null==(e=this.toPort)||e.validate()}),this.toDispose.push(this._onLineDataChangeEmitter)}};Y.type=O;var X=Y,j=class{get onSelectionChanged(){return this.selectionService.onSelectionChanged}get selection(){return this.selectionService.selection}set selection(t){this.selectionService.selection=t}get activatedNode(){let{selectedNodes:t}=this;if(1===t.length)return t[0]}isSelected(t){return this.selectionService.selection.some(e=>e.id===t)}isActivated(t){var e;return(null==(e=this.activatedNode)?void 0:e.id)===t}get selectedNodes(){return this.selectionService.selection.filter(t=>t instanceof V)}selectNode(t){this.selectionService.selection=[t]}toggleSelect(t){this.selectionService.selection.includes(t)?this.selectionService.selection=this.selectionService.selection.filter(e=>e!==t):this.selectionService.selection=this.selectionService.selection.concat(t)}select(t){this.selectionService.selection=[t]}clear(){this.selectionService.selection=[]}async selectNodeAndScrollToView(t,e){this.selectNodeAndFocus(t),await (0,w.gw)(30);let i={entities:[t]};if(e){let e=w.Ae.enlarge([t.getData(E.VO).bounds]).pad(30,30),r=this.playground.config.getViewport(!1);i.zoom=w.rM.fixSize(e,r),i.scrollToCenter=!0,i.easing=!0}return this.playground.config.scrollToView(i)}selectNodeAndFocus(t){this.select(t),this.playground.node.focus()}};m([(0,_.f3)(E.z2)],j.prototype,"selectionService",2),m([(0,_.f3)(E.XQ)],j.prototype,"playground",2),j=m([(0,_.b2)()],j);var J=class{updateHoveredKey(t){this.hoveredKey!==t&&(this.hoveredKey=t,this.onHoveredChangeEmitter.fire(t))}updateHoverPosition(t,e){this.hoveredPos=t,this.onUpdateHoverPositionEmitter.fire({position:t,target:e})}clearHovered(){this.updateHoveredKey("")}isHovered(t){return t===this.hoveredKey}isSomeHovered(){return!!this.hoveredKey}get hoveredNode(){return this.entityManager.getEntityById(this.hoveredKey)}get someHovered(){return this.entityManager.getEntityById(this.hoveredKey)}constructor(){this.onHoveredChangeEmitter=new w.Q5,this.onUpdateHoverPositionEmitter=new w.Q5,this.onHoveredChange=this.onHoveredChangeEmitter.event,this.onUpdateHoverPosition=this.onUpdateHoverPositionEmitter.event,this.hoveredPos={x:0,y:0},this.hoveredKey=""}};m([(0,_.f3)(E.v2)],J.prototype,"entityManager",2),J=m([(0,_.b2)()],J);var U=Symbol("WorkflowDocumentOptions"),H={fromNodeJSON(t,e,i){let r=t.getData(I.Ps),{formMeta:n}=t.getNodeRegistry();r&&n&&(i?(r.createForm(n,e.data),r.onDataChange(()=>{t.document.fireContentChange({type:"NODE_DATA_CHANGE",toJSON:()=>r.toJSON(),entity:t})})):r.updateFormValues(e.data))},toNodeJSON(t){var e,i;let r=null==(e=t.getData(I.fu))?void 0:e.getError();if(r)throw r;let n=t.getData(E.VO),s=function(t){let e=t.getData(I.Ps);if(e&&t.getNodeRegistry().formMeta)return e.toJSON()}(t),o={},a=t.getNodeMeta(),l=null==(i=a.subCanvas)?void 0:i.call(a,t);if((null==l?void 0:l.isCanvas)===!1){let{x:t,y:e}=l.canvasNode.getData(D.eG).transform.position;o.canvasPosition={x:t,y:e}}return{id:t.id,type:t.flowNodeType,meta:{position:{x:n.position.x,y:n.position.y},...o},data:s}}},W=class{init(t){this.document=t}forceUpdate(){this.onForceUpdateEmitter.fire()}get lineType(){return this._lineType}get lineColor(){let t={default:"var(--g-workflow-line-color-default,#4d53e8)",error:"var(--g-workflow-line-color-error,red)",hidden:"var(--g-workflow-line-color-hidden,transparent)",drawing:"var(--g-workflow-line-color-drawing, #5DD6E3)",hovered:"var(--g-workflow-line-color-hover,#37d0ff)",selected:"var(--g-workflow-line-color-selected,#37d0ff)",flowing:"var(--g-workflow-line-color-flowing,#4d53e8)"};return this.options.lineColor&&Object.assign(t,this.options.lineColor),t}switchLineType(t){return void 0===t&&(t=+(0===this._lineType)),t!==this._lineType&&(this._lineType=t,this.getAllLines().forEach(t=>{t.getData($).update()}),window.requestAnimationFrame(()=>{this.entityManager.fireEntityChanged(X.type)})),this._lineType}getAllLines(){return this.entityManager.getEntities(X)}getAllAvailableLines(){return this.getAllLines().filter(t=>!t.isDrawing&&!t.isHidden)}hasLine(t){return!!this.entityManager.getEntityById(X.portInfoToLineId(t))}getLine(t){return this.entityManager.getEntityById(X.portInfoToLineId(t))}getLineById(t){return this.entityManager.getEntityById(t)}replaceLine(t,e){let i=this.getLine(t);return i&&i.dispose(),this.createLine(e)}createLine(t){let{from:e,to:i,drawingTo:r,fromPort:n,drawingFrom:s,toPort:o,data:a}=t,l=!!(e&&i),h=t.key||X.portInfoToLineId(t),d=this.entityManager.getEntityById(h);if(d)return d.highlightColor="",d.validate(),d;let u=e?this.entityManager.getEntityById(e).getData(G):void 0,c=i?this.entityManager.getEntityById(i).getData(G):void 0;if(u||c)return this.isDrawing=!!(r||s),d=this.entityManager.createEntity(X,{id:h,document:this.document,linesManager:this,from:e,fromPort:n,toPort:o,to:i,drawingTo:r,drawingFrom:s,data:a}),this.registerData(d),null==u||u.addLine(d),null==c||c.addLine(d),d.onDispose(()=>{this.isDrawing=!1,null==u||u.removeLine(d),null==c||c.removeLine(d)}),d.onDispose(()=>{l&&this.onAvailableLinesChangeEmitter.fire({type:"DELETE_LINE",toJSON:()=>d.toJSON(),entity:d})}),d.onLineDataChange(t=>{let{oldValue:e}=t;this.onAvailableLinesChangeEmitter.fire({type:"LINE_DATA_CHANGE",toJSON:()=>d.toJSON(),oldValue:e,entity:d})}),l&&this.onAvailableLinesChangeEmitter.fire({type:"ADD_LINE",toJSON:()=>d.toJSON(),entity:d}),d.validate(),d}getCloseInLineFromMousePos(t){let e,i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;return this.getAllLines().forEach(n=>{let s=n.getHoverDist(t);s<=r&&(!i||i>=s)&&(i=s,e=n)}),e}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}isErrorLine(t,e,i){return this.options.isErrorLine?this.options.isErrorLine(t,e,this):!!i}isReverseLine(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.options.isReverseLine?this.options.isReverseLine(t):e}isHideArrowLine(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.options.isHideArrowLine?this.options.isHideArrowLine(t):e}isFlowingLine(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.options.isFlowingLine?this.options.isFlowingLine(t):e}isDisabledLine(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.options.isDisabledLine?this.options.isDisabledLine(t):e}setLineRenderType(t){if(this.options.setLineRenderType)return this.options.setLineRenderType(t)}setLineClassName(t){if(this.options.setLineClassName)return this.options.setLineClassName(t)}getLineColor(t){return t.isHidden?this.lineColor.hidden:t.lockedColor?t.lockedColor:t.hasError?this.lineColor.error:t.highlightColor?t.highlightColor:t.drawingTo?this.lineColor.drawing:this.hoverService.isHovered(t.id)?this.lineColor.hovered:this.selectService.isSelected(t.id)?this.lineColor.selected:this.isFlowingLine(t)?this.lineColor.flowing:this.lineColor.default}canAddLine(t,e,i){if(t===e||t.node===e.node||"output"!==t.portType||"input"!==e.portType||t.disabled||e.disabled)return!1;let r=t.node.getNodeRegistry().canAddLine,n=e.node.getNodeRegistry().canAddLine;return(!r||!!r(t,e,this,i))&&(!n||!!n(t,e,this,i))&&(this.options.canAddLine?this.options.canAddLine(t,e,this,i):t.node!==e.node)}toJSON(){return this.getAllLines().filter(t=>!t.isDrawing).map(t=>t.toJSON())}getPortById(t){return this.entityManager.getEntityById(t)}canRemove(t,e,i){return!this.options||!this.options.canDeleteLine||!!this.options.canDeleteLine(t,e,i)}canReset(t,e){return!this.options||!this.options.canResetLine||!!this.options.canResetLine(t,e,this)}getPortFromMousePos(t,e){let i=this.getSortedNodes().reverse().map(t=>e?"input"===e?t.ports.inputPorts:t.ports.outputPorts:t.ports.allPorts).flat().find(e=>e.isHovered(t.x,t.y));if(i){let e=this.getContainNodesFromMousePos(t),r=(0,M.Z)(e);if(r&&r!==i.node)return}return i}getNodeFromMousePos(t){let{selection:e}=this.selectService,i=this.getContainNodesFromMousePos(t);if(null==e?void 0:e.length){let t=i.filter(t=>e.some(e=>t.id===e.id));if(null==t?void 0:t.length)return(0,M.Z)(t)}return(0,M.Z)(i)}registerContribution(t){return this.contributionFactories.push(t),this}registerData(t){t.addData($)}getSortedNodes(){return this.document.getAllNodes().sort((t,e)=>this.getNodeIndex(t)-this.getNodeIndex(e))}getContainNodesFromMousePos(t){var e,i;let r=this.getSortedNodes(),n=(null==(i=this.entityManager.getEntity(E.ER))||null==(e=i.config)?void 0:e.zoom)||1;return r.map(e=>{let{bounds:i}=e.getData(D.eG);if(i.clone().pad(4/n).contains(t.x,t.y))return e}).filter(Boolean)}getNodeIndex(t){return t.getData(D.Lz).stackIndex}constructor(){this.toDispose=new w.K4,this._lineType=0,this.onAvailableLinesChangeEmitter=new w.Q5,this.onForceUpdateEmitter=new w.Q5,this.onAvailableLinesChange=this.onAvailableLinesChangeEmitter.event,this.onForceUpdate=this.onForceUpdateEmitter.event,this.contributionFactories=[],this.isDrawing=!1}};m([(0,_.f3)(J)],W.prototype,"hoverService",2),m([(0,_.f3)(j)],W.prototype,"selectService",2),m([(0,_.f3)(E.v2)],W.prototype,"entityManager",2),m([(0,_.f3)(U)],W.prototype,"options",2),W=m([(0,_.b2)()],W);var K="free-layout",Z=class{get document(){return this.documentProvider()}update(){var t;(null==(t=this.document.root.getData(D.eG))?void 0:t.localDirty)&&this.document.root.clearMemoGlobal()}syncTransform(t){let e=t.getData(D.eG);if(e.localDirty)t.clearMemoGlobal(),t.clearMemoLocal(),e.transform.update({size:e.data.size}),t.parent&&(t.parent.clearMemoGlobal(),t.parent.clearMemoLocal(),t.parent.getData(D.eG).transform.fireChange())}updateAffectedTransform(t){if(!t.transform.localDirty)return;let e=this.getAllParents(t);[...this.getAllBlocks(t).reverse(),...e].forEach(t=>{this.fireChange(t)})}getPadding(t){let{padding:e}=t.getNodeMeta(),i=t.getData(D.eG);return e?"function"==typeof e?e(i):e:w.sI.empty()}getInitScroll(t){let e=w.Ae.enlarge(this.document.getAllNodes().map(t=>t.getData(E.VO).bounds)).pad(30,30),i=this.playgroundConfig.getViewport(!1),r=w.rM.fixSize(e,i);return{scrollX:(e.x+e.width/2)*r-this.playgroundConfig.config.width/2,scrollY:(e.y+e.height/2)*r-this.playgroundConfig.config.height/2}}getDefaultInputPoint(t){return t.getData(E.VO).bounds.leftCenter}getDefaultOutputPoint(t){return t.getData(E.VO).bounds.rightCenter}getDefaultNodeOrigin(){return{x:.5,y:0}}getAllParents(t){let e=[],i=t.parent;for(;i;)e.push(i),i=i.parent;return e}getAllBlocks(t){return t.blocks.reduce((t,e)=>[...t,...this.getAllBlocks(e)],[t])}fireChange(t){let e=null==t?void 0:t.transform;t&&(null==e?void 0:e.localDirty)&&(t.clearMemoGlobal(),t.clearMemoLocal(),e.transform.fireChange())}constructor(){this.name=K}};m([(0,_.f3)(E.ER)],Z.prototype,"playgroundConfig",2),m([(0,_.f3)(D.JU)],Z.prototype,"documentProvider",2),Z=m([(0,_.b2)()],Z);var Q=(0,x.kP)("1234567890",5),q=Symbol("WorkflowDocumentProvider"),tt=class extends D.pQ{get loading(){return this._loading}async fitView(t){return R(this,this.playgroundConfig,t).then(()=>{this.linesManager.forceUpdate()})}init(){super.init(),this.currentLayoutKey=this.options.defaultLayout||K,this.linesManager.init(this),this.playgroundConfig.getCursors=()=>this.options.cursors,this.linesManager.onAvailableLinesChange(t=>this.fireContentChange(t)),this.playgroundConfig.onReadonlyOrDisabledChange(t=>{let{readonly:e}=t;this.nodeEngineContext&&(this.nodeEngineContext.readonly=e)})}async load(){this.disposed||(this._loading=!0,await super.load(),this._loading=!1,this.onLoadedEmitter.fire())}async reload(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.disposed||(this._loading=!0,this.clear(),this.fromJSON(t),await (0,w.gw)(e),this._loading=!1,this._onReloadEmitter.fire(this))}fromJSON(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this.disposed)return;let i={nodes:t.nodes??[],edges:t.edges??[]};this.entityManager.changeEntityLocked=!0,this.batchAddFromJSON(i),this.entityManager.changeEntityLocked=!1,this.transformer.loading=!1,e&&this.fireRender()}clear(){this.getAllNodes().map(t=>t.dispose()),this.linesManager.getAllLines().map(t=>t.dispose()),this.getAllPorts().map(t=>t.dispose()),this.selectServices.clear()}createWorkflowNode(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];let e=arguments.length>2?arguments[2]:void 0;return this._createWorkflowNode(t,{parentID:e})}_createWorkflowNode(t,e){let{parentID:i,onNodeCreated:r,onEdgeCreated:n}=e??{},s=this.getNode(t.id),o=this.getNode(i??this.root.id)??this.root,a=this.addNode({...t,parent:o},void 0,!0),{formMeta:l}=a.getNodeRegistry(),h=a.getNodeMeta(),d=a.getData(I.Ps),u=a.getData(D.eG),c=this.layout;s||u.onDataChange(()=>{c.syncTransform(a)});let{position:g}=h;g||(g=this.getNodeDefaultPosition(t.type)),a.getData(E.VO).update({position:g}),l&&d&&(d.formModel.initialized?d.updateFormValues(t.data):(d.createForm(l,t.data),d.onDataChange(()=>{this.fireContentChange({type:"NODE_DATA_CHANGE",toJSON:()=>d.toJSON(),entity:a})})));let p=a.getData(E.WV);s||p.onDataChange(()=>{this.fireContentChange({type:"MOVE_NODE",toJSON:()=>p.toJSON(),entity:a})});let f=this.getNodeSubCanvas(a);if(!s&&!(null==f?void 0:f.isCanvas)){let t;this.fireContentChange({type:"ADD_NODE",entity:a,toJSON:()=>this.toNodeJSON(a)}),a.onDispose(()=>{a.parent&&a.parent.flowNodeType!==D.Sy.ROOT&&a.parent.getData(D.eG).fireChange()}),a.preDispose.onDispose(()=>{t=this.toNodeJSON(a)}),a.onDispose(()=>{this.fireContentChange({type:"DELETE_NODE",entity:a,toJSON:()=>t})})}if(t.blocks&&this.batchAddFromJSON({nodes:t.blocks,edges:t.edges??[]},{parent:a,onNodeCreated:r,onEdgeCreated:n}),f){var y;f.canvasNode.getData(E.VO).update({position:null==(y=f.parentNode.getNodeMeta())?void 0:y.canvasPosition}),s||(f.parentNode.onDispose(()=>{f.canvasNode.dispose()}),f.canvasNode.onDispose(()=>{f.parentNode.dispose()}))}return s?this.onNodeUpdateEmitter.fire({node:a,data:t,json:t}):this.onNodeCreateEmitter.fire({node:a,data:t,json:t}),a}addNode(t,e,i){var r,n,s,o,a,l;let{id:h,type:d="block",originParent:u,parent:c,meta:g,hidden:p,index:f}=t,y=this.getNode(h),m=!1,E=this.getNodeRegistry(d,t.originParent);if(y&&y.flowNodeType!==t.type&&(y.dispose(),y=void 0),y)null==(a=(l=this.options).fromNodeJSON)||a.call(l,y,t,!1);else{let{dataRegistries:e}=E;y=this.entityManager.createEntity(V,{id:h,document:this,flowNodeType:d,originParent:u,meta:g}),null==(r=(n=this.options).preNodeCreate)||r.call(n,y);let i=e?this.nodeDataRegistries.concat(...e):this.nodeDataRegistries;y.addInitializeData(i),y.ports=y.getData(F),y.lines=y.getData(G),y.onDispose(()=>this.onNodeDisposeEmitter.fire({node:y})),null==(s=(o=this.options).fromNodeJSON)||s.call(o,y,t,!0),m=!0}if(y.initData({originParent:u,parent:c,meta:g,hidden:p,index:f}),null==e||e.push(y),E.onCreate){let i=E.onCreate(y,t);i&&e&&e.push(...i)}return i||(m?this.onNodeCreateEmitter.fire({node:y,data:t,json:t}):this.onNodeUpdateEmitter.fire({node:y,data:t,json:t})),y}get layout(){let t=this.layouts.find(t=>t.name==this.currentLayoutKey);if(!t)throw Error(`Unknown flow layout: ${this.currentLayoutKey}`);return t}getNodeDefaultPosition(t){let{size:e}=this.getNodeRegistry(t).meta||{},i=this.playgroundConfig.getViewport(!0).center;return e&&(i={x:i.x,y:i.y-e.height/2}),A(this,i)}createWorkflowNodeByType(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,n=i.id;if(void 0===n)do n=`1${Q()}`;while(this.entityManager.getEntityById(n));else if(this.entityManager.getEntityById(n))throw Error(`[WorkflowDocument.createWorkflowNodeByType] Node Id "${n}" duplicated.`);return this._createWorkflowNode({...i,id:n,type:t,meta:{position:e,...null==i?void 0:i.meta},data:null==i?void 0:i.data,blocks:null==i?void 0:i.blocks,edges:null==i?void 0:i.edges},{parentID:r})}getAllNodes(){return this.entityManager.getEntities(V).filter(t=>t.id!==D.Sy.ROOT)}getAllEdges(){return this.entityManager.getEntities(X)}getAllPorts(){return this.entityManager.getEntities(B).filter(t=>t.node.id!==D.Sy.ROOT)}getAssociatedNodes(){var t,e;let i=this.getAllNodes(),r=this.linesManager.getAllLines().filter(t=>t.from&&t.to).map(t=>({from:t.from.id,to:t.to.id})),n=null==(t=i.find(t=>t.isStart))?void 0:t.id,s=null==(e=i.find(t=>t.isNodeEnd))?void 0:e.id,o=new Set(i.filter(t=>{var e;return null==(e=t.parent)?void 0:e.getNodeMeta().isContainer}).map(t=>t.id));s&&o.add(s);let a=t=>{o.has(t)||(o.add(t),r.reduce((e,i)=>{let{from:r,to:n}=i;return r!==t||o.has(n)||e.push(n),e},[]).forEach(a))};return n&&a(n),i.filter(t=>o.has(t.id))}fireRender(){this.entityManager.fireEntityChanged(V.type),this.entityManager.fireEntityChanged(X.type),this.entityManager.fireEntityChanged(B.type)}fireContentChange(t){this._loading||this.disposed||this.entityManager.changeEntityLocked||this._onContentChangeEmitter.fire(t)}toNodeJSON(t){let e=this.getNodeSubCanvas(t);if((null==e?void 0:e.isCanvas)===!0)return this.toNodeJSON(e.parentNode);let i=this.toNodeJSONFromOptions(t),r=this.getNodeChildren(t),n=r.map(t=>this.toNodeJSON(t)),s=new Map;r.forEach(t=>{let e=t.getData(G);[...e.inputLines,...e.outputLines].filter(Boolean).forEach(t=>{let e=this.toLineJSON(t);!e||s.has(t.id)||s.set(t.id,e)})});let o=Array.from(s.values());return n.length>0&&(i.blocks=n),o.length>0&&(i.edges=o),i}toNodeJSONFromOptions(t){return this.options.toNodeJSON?this.options.toNodeJSON(t):H.toNodeJSON(t)}copyNode(t,e,i,r){var n;let s=this.toNodeJSON(t);return i&&(s=i(s)),r=r||{x:s.meta.position.x+30,y:s.meta.position.y+30},this._createWorkflowNode({id:e||`1${Q()}`,type:t.flowNodeType,meta:{...s.meta,position:r},data:s.data,blocks:s.blocks,edges:s.edges},{parentID:null==(n=t.parent)?void 0:n.id})}copyNodeFromJSON(t,e,i,r,n){return r=r||{x:e.meta.position.x+30,y:e.meta.position.y+30},this._createWorkflowNode({id:i||`1${Q()}`,type:t,meta:{...e.meta,position:r},data:e.data,blocks:e.blocks,edges:e.edges},{parentID:n})}canRemove(t,e){return!t.getNodeMeta().deleteDisable&&(!this.options.canDeleteNode||!!this.options.canDeleteNode(t,e))}isErrorPort(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return"function"==typeof this.options.isErrorPort?this.options.isErrorPort(t):e}toJSON(){if(this.disposed)throw Error("The WorkflowDocument has been disposed and it is no longer possible to call toJSON.");let t=this.toNodeJSON(this.root);return{nodes:t.blocks??[],edges:t.edges??[]}}dispose(){super.dispose(),this._onReloadEmitter.dispose()}renderJSON(t,e){return this.batchAddFromJSON(t,e)}batchAddFromJSON(t,e){var i;let{parent:r=this.root,onNodeCreated:n,onEdgeCreated:s}=e??{},o=(null==(i=this.getNodeSubCanvas(r))?void 0:i.canvasNode.id)??r.id,a=(t=>{let{nodes:e,edges:i}=t,r=e.filter(t=>t.type===D.Sy.GROUP),n=new Map(e.map(t=>[t.id,t])),s=r.map(t=>{let e=(t.data.blockIDs??[]).map(t=>n.get(t)).filter(Boolean),r=null==i?void 0:i.filter(t=>e.some(e=>e.id===t.sourceNodeID||e.id===t.targetNodeID));return{...t,blocks:e,edges:r}}),o=new Set(r.map(t=>t.data.blockIDs).flat());return{nodes:e.filter(t=>!o.has(t.id)).concat(s),edges:i}})(t),l=a.nodes.map(t=>this._createWorkflowNode(t,{parentID:o,onNodeCreated:n,onEdgeCreated:s})),h=a.edges.map(t=>this.createWorkflowLine(t,o)).filter(Boolean);return l.forEach(t=>{var i;return null==e||null==(i=e.onNodeCreated)?void 0:i.call(e,t)}),h.forEach(t=>{var i;return null==e||null==(i=e.onEdgeCreated)?void 0:i.call(e,t)}),{nodes:l,edges:h}}getNodeSubCanvas(t){var e;if(!t)return;let i=t.getNodeMeta();return null==(e=i.subCanvas)?void 0:e.call(i,t)}getNodeChildren(t){if(!t||t.flowNodeType===D.Sy.GROUP)return[];let e=this.getNodeSubCanvas(t);return(e?e.canvasNode.blocks:t.blocks).filter(e=>{var i,r;let n=e.getNodeMeta();return!(null==(r=n.subCanvas)||null==(i=r.call(n,t))?void 0:i.isCanvas)}).filter(Boolean).map(t=>t.flowNodeType===D.Sy.GROUP?[t,...t.blocks]:t).flat()}toLineJSON(t){let e=t.toJSON();if(!t.from||!t.info.from||!t.fromPort||!t.to||!t.info.to||!t.toPort)return;let i=this.getNodeSubCanvas(t.from),r=this.getNodeSubCanvas(t.to);if(!i||i.isCanvas||!r||!r.isCanvas)return t.from===t.to.parent&&i?{...e,sourceNodeID:i.parentNode.id}:t.to===t.from.parent&&r?{...e,targetNodeID:r.parentNode.id}:e}createWorkflowLine(t,e){let i=this.getNode(t.sourceNodeID),r=this.getNode(t.targetNodeID);if(!i||!r)return;let n={from:t.sourceNodeID,fromPort:t.sourcePortID,to:t.targetNodeID,toPort:t.targetPortID,data:t.data};if(!e)return this.linesManager.createLine(n);let s=this.getNode(e);if(!s)return this.linesManager.createLine(n);let o=this.getNodeSubCanvas(s);return o?n.from===o.parentNode.id?this.linesManager.createLine({...n,from:o.canvasNode.id}):n.to===o.parentNode.id?this.linesManager.createLine({...n,to:o.canvasNode.id}):this.linesManager.createLine(n):this.linesManager.createLine(n)}constructor(){super(...arguments),this._onContentChangeEmitter=new w.Q5,this.onLoadedEmitter=new w.Q5,this.onContentChange=this._onContentChangeEmitter.event,this._onReloadEmitter=new w.Q5,this.onReload=this._onReloadEmitter.event,this.onLoaded=this.onLoadedEmitter.event,this._loading=!1,this.options={}}};function te(t,e,i){return!!(!i||t>100||Math.abs(e.endPos.x-e.startPos.x)>=5||Math.abs(e.endPos.y-e.startPos.y)>=5)}function ti(t){switch(t){case"bottom":return"top";case"left":return"right";case"top":return"bottom";case"right":return"left"}}m([(0,_.f3)(W)],tt.prototype,"linesManager",2),m([(0,_.f3)(E.ER)],tt.prototype,"playgroundConfig",2),m([(0,E.el)()],tt.prototype,"playgroundContext",2),m([(0,_.f3)(U)],tt.prototype,"options",2),m([(0,_.f3)(I.j0),(0,_.jt)()],tt.prototype,"nodeEngineContext",2),m([(0,_.f3)(j)],tt.prototype,"selectServices",2),m([(0,_.zY)()],tt.prototype,"init",1),tt=m([(0,_.b2)()],tt);var tr=class{init(){this._toDispose.pushAll([this._onDragLineEventEmitter,this._nodesDragEmitter]),this.options.onDragLineEnd&&this._toDispose.push(this.onDragLineEnd(this.options.onDragLineEnd))}dispose(){this._toDispose.dispose()}async startDragSelectedNodes(t){var e;let{selectedNodes:i}=this.selectService;if(0===i.length||this.playgroundConfig.readonly||this.playgroundConfig.disabled||this.isDragging)return Promise.resolve(!1);this.isDragging=!0;let r=this.getNodesPosition(i),n=i.map(t=>{let e=t.getData(E.VO);return{x:e.position.x,y:e.position.y}}),s=!1,o=Date.now(),a=new E.s5({onDragStart:e=>{this._nodesDragEmitter.fire({type:"onDragStart",nodes:i,startPositions:n,dragEvent:e,triggerEvent:t,dragger:a})},onDrag:e=>{!s&&te(Date.now()-o,e)&&(s=!0);let l=this.getDragPosOffset({event:e,selectedNodes:i,startPosition:r}),h=[];i.forEach((t,e)=>{let i=t.getData(E.VO),r=n[e],s={x:r.x+l.x,y:r.y+l.y};i.update({position:s}),this.document.layout.updateAffectedTransform(t),h.push(s)}),this._nodesDragEmitter.fire({type:"onDragging",nodes:i,startPositions:n,positions:h,dragEvent:e,triggerEvent:t,dragger:a})},onDragEnd:e=>{this.isDragging=!1,this._nodesDragEmitter.fire({type:"onDragEnd",nodes:i,startPositions:n,dragEvent:e,triggerEvent:t,dragger:a}),this.resetContainerInternalPosition(i)}}),{clientX:l,clientY:h}=E.UJ.getEventCoord(t);return null==(e=a.start(l,h,this.playgroundConfig))?void 0:e.then(()=>s)}async dropCard(t,e,i,r){let n=this.playgroundConfig.getPosFromMouseEvent(e);if(!this.playgroundConfig.getViewport().contains(n.x,n.y))return;let s=this.adjustSubNodePosition(t,r,n);return await this.document.createWorkflowNodeByType(t,s,i,null==r?void 0:r.id)}async startDragCard(t,e,i,r){let n,s={x:0,y:0},o=new w.cO,a=new E.s5({onDragStart:t=>{let i=e.currentTarget;n=r?r(t):i.cloneNode(!0);let o=i.getBoundingClientRect();s={x:o.left+window.scrollX,y:o.top+window.scrollY},w.xF.setStyle(n,{zIndex:1e3,position:"absolute",left:s.x,top:s.y,boxShadow:"0 6px 8px 0 rgba(28, 31, 35, .2)"}),document.body.appendChild(n),this.updateDroppableTransforms()},onDrag:t=>{let e=t.endPos.x-t.startPos.x,i=t.endPos.y-t.startPos.y,r=s.x+e,o=s.y+i;n.style.left=`${r}px`,n.style.top=`${o}px`;let{x:a,y:l}=this.playgroundConfig.getPosFromMouseEvent(t),h=new w.Ae(a,l,170,90),d=this._droppableTransforms.find(t=>{let{bounds:e,entity:i}=t,r=this.document.layout.getPadding(i),n=new w.Ae(e.x+r.left+r.right,e.y,e.width,e.height);return w.Ae.intersects(h,n)});this.updateDropNode(null==d?void 0:d.entity)},onDragEnd:async e=>{let r=this._dropNode,{allowDrop:a}=this.canDropToNode({dragNodeType:t,dropNodeType:null==r?void 0:r.flowNodeType,dropNode:r}),l=a?await this.dropCard(t,e,i,r):void 0;(this.clearDrop(),l)?(n.remove(),o.resolve(l)):(n.style.transition="all ease .2s",n.style.left=`${s.x}px`,n.style.top=`${s.y}px`,await (0,w.gw)(200),n.remove(),o.resolve())}});return await a.start(e.clientX,e.clientY),o.promise}adjustSubNodePosition(t,e,i){if(!i)return{x:0,y:0};if(!t||!e||e.flowNodeType===D.Sy.ROOT)return i;let r=!e.children||0===e.children.length,n=this.document.layout.getPadding(e),s=e.transform.transform.worldTransform;return r?{x:0,y:n.top}:{x:i.x-s.tx,y:i.y-s.ty}}registerPosAdjuster(t){return this.posAdjusters.add(t),{dispose:()=>this.posAdjusters.delete(t)}}canDropToNode(t){let{canDropToNode:e}=this.document.options,{dragNodeType:i,dropNode:r}=t;return e?e(t)?{allowDrop:!0,dropNode:r}:{allowDrop:!1}:i?{allowDrop:!0,dropNode:r}:{allowDrop:!1,message:"Please select a node to drop"}}getDragPosOffset(t){let{event:e,selectedNodes:i,startPosition:r}=t,{finalScale:n}=this.playgroundConfig,s={x:(e.endPos.x-e.startPos.x)/n,y:(e.endPos.y-e.startPos.y)/n},o={x:r.x+s.x,y:r.y+s.y};return Array.from(this.posAdjusters.values()).map(t=>t({selectedNodes:i,position:o})).reduce((t,e)=>({x:t.x+e.x,y:t.y+e.y}),s)}updateDroppableTransforms(){this._droppableTransforms=this.document.getRenderDatas(D.eG,!1).filter(t=>{let{entity:e}=t;return e.originParent?this.nodeSelectable(e)&&this.nodeSelectable(e.originParent):this.nodeSelectable(e)}).filter(t=>this.isContainer(t.entity))}isContainer(t){return(null==t?void 0:t.getNodeMeta().isContainer)??!1}getNodesPosition(t){let e=w.Ae.enlarge(t.map(t=>t.getData(D.eG).bounds));return{x:e.x,y:e.y}}nodeSelectable(t){let e=t.getNodeMeta().selectable;return"function"==typeof e?e(t):e}updateDropNode(t){if(this._dropNode){if(this._dropNode.id===(null==t?void 0:t.id))return;this.selectService.clear()}t&&this.selectService.selectNode(t),this._dropNode=t}clearDrop(){this._dropNode&&this.selectService.clear(),this._dropNode=void 0,this._droppableTransforms=[]}setLineColor(t,e){t.highlightColor=e,this.hoverService.clearHovered()}checkDraggingPort(t,e,i,r,n){return(t?!(r&&((null==n?void 0:n.toPort)===r||"input"===r.portType&&this.linesManager.canAddLine(e.fromPort,r,!0))):!(r&&((null==n?void 0:n.fromPort)===r||"output"===r.portType&&this.linesManager.canAddLine(r,e.toPort,!0))))?this.isContainer(i)?{hasError:!1}:(this.setLineColor(e,this.linesManager.lineColor.error),{hasError:!0}):(this.hoverService.updateHoveredKey(r.id),t?e.setToPort(r):e.setFromPort(r),this._onDragLineEventEmitter.fire({type:"onDrag",onDragNodeId:i.id}),{hasError:!1})}resetContainerInternalPosition(t){let e=this.childrenOfContainer(t);if(!e)return;let i=w.Ae.enlarge(e.blocks.map(t=>{let e=t.transform.position.x-t.transform.bounds.width/2,i=t.transform.position.y,r=t.transform.bounds.width,n=t.transform.bounds.height;return new w.Ae(e,i,r,n)})),r=e.getData(E.VO);this.operationService.updateNodePosition(e,{x:r.position.x+i.x,y:r.position.y+i.y}),this.document.layout.updateAffectedTransform(e),e.blocks.forEach(t=>{let e=t.getData(E.VO);this.operationService.updateNodePosition(t,{x:e.position.x-i.x,y:e.position.y-i.y}),this.document.layout.updateAffectedTransform(t)})}childrenOfContainer(t){var e;if(0===t.length)return;let i=null==(e=t[0])?void 0:e.parent;if(i&&i.flowNodeType!==D.Sy.ROOT&&t.every(t=>(null==t?void 0:t.parent)===i))return i}async startDrawingLine(t,e,i){let r,n,s="output"===t.portType,o=!i&&t.isErrorPort()&&t.disabled;if((null==i?void 0:i.disabled)||o||this.playgroundConfig.readonly||this.playgroundConfig.disabled)return{dragSuccess:!1,newLine:void 0};this.selectService.clear();let a=this.playgroundConfig,l=new w.cO,h=a.cursor,d=Date.now(),u=!1,c=new E.s5({onDrag:o=>{if(!r&&te(Date.now()-d,o,i)){i&&(i.highlightColor=this.linesManager.lineColor.hidden),u=!0;let n=a.getPosFromMouseEvent(e);if(!(r=s?this.linesManager.createLine({from:t.node.id,fromPort:t.portID,data:null==i?void 0:i.lineData,drawingTo:{x:n.x,y:n.y,location:"right"===t.location?"left":"top"}}):this.linesManager.createLine({to:t.node.id,toPort:t.portID,data:null==i?void 0:i.lineData,drawingFrom:{x:n.x,y:n.y,location:"left"===t.location?"right":"bottom"}})))return;a.updateCursor("grab"),r.highlightColor=(null==i?void 0:i.lockedColor)||this.linesManager.lineColor.drawing,this.hoverService.updateHoveredKey("")}if(!r)return;let l=a.getPosFromMouseEvent(o);n=this.updateDrawingLine(s,r,l,i)},onDragEnd:async t=>{let e=a.getPosFromMouseEvent(t),s=Array.from(this._onDragLineEndCallbacks.values());a.updateCursor(h);let{fromPort:o,toPort:d,hasError:c}=n||{};await Promise.all(s.map(n=>n({fromPort:o,toPort:d,mousePos:e,line:r,originLine:i,event:t}))),null==r||r.dispose(),this._onDragLineEventEmitter.fire({type:"onDragEnd"}),i&&(i.highlightColor="");let g=()=>{null==i||i.validate(),l.resolve({dragSuccess:u})};if(u){if(i&&i.toPort===d&&i.fromPort===o||d&&"input"!==d.portType||o&&"output"!==o.portType)return g();let t=d&&o?{from:o.node.id,fromPort:o.portID,to:d.node.id,toPort:d.portID,data:null==i?void 0:i.lineData}:void 0;if(i&&t&&!this.linesManager.canReset(i,t)||i&&(!this.linesManager.canRemove(i,t,!1)||c))return g();if(null==i||i.dispose(),!t||!this.linesManager.canAddLine(o,d,!1))return g();let e=this.linesManager.createLine(t);e||g(),l.resolve({dragSuccess:u,newLine:e})}else g()}}),{clientX:g,clientY:p}=E.UJ.getEventCoord(e);return await c.start(g,p,a),l.promise}updateDrawingLine(t,e,i,r){let n,s,o=!1,a=this.linesManager.getNodeFromMousePos(i);return t?(s=e.fromPort,n=this.linesManager.getPortFromMousePos(i,"input"),a&&this.canBuildContainerLine(a,i)&&(n=this.getNearestPort(a,i,"input"),o=this.checkDraggingPort(t,e,a,n,r).hasError),n?this.linesManager.canAddLine(s,n,!0)?e.setToPort(n):(o=!0,e.setToPort(void 0)):e.setToPort(void 0),e.toPort?e.drawingTo={x:e.toPort.point.x,y:e.toPort.point.y,location:e.toPort.location}:e.drawingTo={x:i.x,y:i.y,location:ti(e.fromPort.location)}):(n=e.toPort,s=this.linesManager.getPortFromMousePos(i,"output"),a&&this.canBuildContainerLine(a,i)&&(s=this.getNearestPort(a,i,"output"),o=this.checkDraggingPort(t,e,a,s,r).hasError),s?this.linesManager.canAddLine(s,n,!0)?e.setFromPort(s):(o=!0,e.setFromPort(void 0)):e.setFromPort(void 0),e.fromPort?e.drawingFrom={x:e.fromPort.point.x,y:e.fromPort.point.y,location:e.fromPort.location}:e.drawingFrom={x:i.x,y:i.y,location:ti(e.toPort.location)}),this._onDragLineEventEmitter.fire({type:"onDrag"}),o?this.setLineColor(e,this.linesManager.lineColor.error):this.setLineColor(e,(null==r?void 0:r.lockedColor)||this.linesManager.lineColor.drawing),null==r||r.validate(),e.validate(),{fromPort:s,toPort:n,hasError:o}}async resetLine(t,e){let{fromPort:i,toPort:r}=t,n=this.playgroundConfig.getPosFromMouseEvent(e),s=w.E9.getDistance(i.point,n),o=w.E9.getDistance(r.point,n),{dragSuccess:a}=await this.startDrawingLine(o<=s||!this.document.options.twoWayConnection?i:r,e,t);a||this.selectService.select(t)}onDragLineEnd(t){let e=(0,x.x0)();return this._onDragLineEndCallbacks.set(e,t),{dispose:()=>{this._onDragLineEndCallbacks.delete(e)}}}canBuildContainerLine(t,e){if(!this.isContainer(t))return!0;let{padding:i,bounds:r}=t.transform,n=2*i.left/3||10,s=2*i.right/3||10,o=2*i.bottom/3||10,a=2*i.top/3||10;return[new w.Ae(r.x,r.y,n,r.height),new w.Ae(r.x,r.y,r.width,a),new w.Ae(r.x,r.y+r.height-o,r.width,o),new w.Ae(r.x+r.width-s,r.y,s,r.height)].some(t=>t.contains(e.x,e.y))}getNearestPort(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"input",r=t.ports;return("input"===i?r.inputPorts:r.outputPorts).sort((t,i)=>w.E9.getDistance(e,t.point)-w.E9.getDistance(e,i.point))[0]}constructor(){this._onDragLineEventEmitter=new w.Q5,this.onDragLineEventChange=this._onDragLineEventEmitter.event,this.isDragging=!1,this._nodesDragEmitter=new w.Q5,this.onNodesDrag=this._nodesDragEmitter.event,this._toDispose=new w.K4,this._droppableTransforms=[],this.posAdjusters=new Set,this._onDragLineEndCallbacks=new Map}};m([(0,_.f3)(E.ER)],tr.prototype,"playgroundConfig",2),m([(0,_.f3)(J)],tr.prototype,"hoverService",2),m([(0,_.f3)(tt)],tr.prototype,"document",2),m([(0,_.f3)(W)],tr.prototype,"linesManager",2),m([(0,_.f3)(E.VD)],tr.prototype,"commandService",2),m([(0,_.f3)(j)],tr.prototype,"selectService",2),m([(0,_.f3)(p)],tr.prototype,"operationService",2),m([(0,_.f3)(U)],tr.prototype,"options",2),m([(0,_.zY)()],tr.prototype,"init",1),tr=m([(0,_.b2)()],tr);var tn=async(t,e)=>{let i={};return t.forEach(t=>{let e=t.getData(E.VO),r=t.getData(D.eG);i[t.id]={x:e.position.x,y:e.position.y+r.bounds.height/2}}),new Promise(r=>{(0,E.p4)({from:{d:0},to:{d:100},duration:300,onUpdate:i=>{t.forEach(t=>{let r=t.getData(E.VO),n=(e[t.id].x-r.position.x)*i.d/100,s=(e[t.id].y-r.bounds.height/2-r.position.y)*i.d/100;r.update({position:{x:r.position.x+n,y:r.position.y+s}}),t.document.layout.updateAffectedTransform(t)})},onComplete:()=>{r(i)}})})},ts=class{init(){this._toDispose.push(this._resetLayoutEmitter)}fireResetLayout(t,e,i){this._resetLayoutEmitter.fire({nodeIds:t,positionMap:e,oldPositionMap:i})}async layoutToPositions(t,e){let i=t.map(t=>this._entityManager.getEntityById(t)).filter(Boolean),r=await tn(i,e);return R(this._document,this._config,!0),r}dispose(){this._toDispose.dispose()}constructor(){this._resetLayoutEmitter=new w.Q5,this.onResetLayout=this._resetLayoutEmitter.event,this._toDispose=new w.K4}};m([(0,_.f3)(E.ER)],ts.prototype,"_config",2),m([(0,_.f3)(tt)],ts.prototype,"_document",2),m([(0,_.f3)(E.v2)],ts.prototype,"_entityManager",2),m([(0,_.zY)()],ts.prototype,"init",1),ts=m([(0,_.b2)()],ts);var to=class extends D.D9{updateNodePosition(t,e){let i=this.toNodeEntity(t);if(!i)return;let r=i.getData(E.VO),n={x:r.position.x,y:r.position.y};r.update({position:e}),this.onNodePostionUpdateEmitter.fire({node:i,oldPosition:n,newPosition:e})}fromJSON(t){if(this.document.disposed)return;let e={nodes:t.nodes??[],edges:t.edges??[]},i=this.document.getAllNodes(),r=this.linesManager.getAllLines(),n=new Map(i.map(t=>[t.id,{x:t.transform.transform.position.x,y:t.transform.transform.position.y}])),s=[],o=[];this.document.batchAddFromJSON(e,{onNodeCreated:t=>s.push(t),onEdgeCreated:t=>o.push(t)});let a=new Set(o.map(t=>t.id));r.forEach(t=>{if(!a.has(t.id))return void t.dispose()});let l=new Set(s.map(t=>t.id));i.forEach(t=>{if(!l.has(t.id))return void t.dispose();let e=n.get(t.id),i={x:t.transform.transform.position.x,y:t.transform.transform.position.y};e&&(e.x!==i.x||e.y!==i.y)&&this.onNodePostionUpdateEmitter.fire({node:t,oldPosition:e,newPosition:i})}),this.document.fireRender()}constructor(){super(...arguments),this.onNodePostionUpdateEmitter=new w.Q5,this.onNodePostionUpdate=this.onNodePostionUpdateEmitter.event}};function ta(t){let e=(0,E.Dc)(),i=(0,E.JA)();return(0,b.useEffect)(()=>{let r;return t&&(r=e.config.onReadonlyOrDisabledChange(()=>i())),()=>null==r?void 0:r.dispose()},[t]),e.config.readonly}function tl(t){return t&&"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.closest(".flow-canvas-not-draggable")}m([(0,_.f3)(tt)],to.prototype,"document",2),m([(0,_.f3)(W)],to.prototype,"linesManager",2);var th=null==(d=navigator)||null==(h=d.userAgent)||null==(l=h.includes)?void 0:l.call(h,"Firefox");function td(t){let e=t||(0,b.useContext)(E.rQ),i=e.getData(D.Lz),r=e.ports,n=ta(),s=(0,E.G2)(tr),o=(0,E.G2)(j),a=(0,b.useRef)(!1),[l,h]=(0,b.useState)(0),d=(0,b.useRef)(!1);d.current=!1;let u=(0,b.useRef)(null),[c,g]=(0,b.useState)("");(0,b.useEffect)(()=>{let t=s.onDragLineEventChange(t=>{let{type:e,onDragNodeId:i}=t;"onDrag"===e?g(i||""):g("")});return()=>{t.dispose()}},[]);let p=(0,b.useCallback)(t=>{var i;E.UJ.preventDefault(t),o.isSelected(e.id)||f(t),(E.UJ.isTouchEvent(t)||tl(t.target)&&tl(document.activeElement))&&(a.current=!0,null==(i=s.startDragSelectedNodes(t))||i.finally(()=>setTimeout(()=>{a.current=!1})))},[s,e]),f=(0,b.useCallback)(t=>{!a.current&&(t.shiftKey?o.toggleSelect(e):o.selectNode(e),t.target&&t.target.focus())},[e]),y=(0,b.useCallback)(()=>e.dispose(),[e]);(0,E.H$)(r.onDataChange);let m=(0,b.useCallback)(()=>{if(th){var t;null==(t=u.current)||t.setAttribute("draggable","false")}},[]),_=(0,b.useCallback)(()=>{if(th){var t;null==(t=u.current)||t.setAttribute("draggable","true")}},[]),w=(0,b.useCallback)(()=>e.getExtInfo(),[e]),x=(0,b.useCallback)((t,i)=>{e.updateExtInfo(t,i)},[e]),N=(0,b.useMemo)(()=>(0,S.CM)(e),[e]),M=(0,C.Re)(null==N?void 0:N.state),I=(0,b.useCallback)(()=>{i.toggleExpand()},[i]),T=o.isSelected(e.id),L=o.isActivated(e.id),P=i.expanded;return(0,b.useEffect)(()=>{let t=null==N?void 0:N.onFormValuesChange(()=>{d.current&&h(t=>t+1)});return()=>null==t?void 0:t.dispose()},[N]),(0,b.useMemo)(()=>({id:e.id,type:e.flowNodeType,get data(){if(N)return d.current=!0,N.values;return w()},updateData(t){N?N.updateFormValues(t):x(t,!0)},node:e,selected:T,activated:L,expanded:P,startDrag:p,get ports(){return r.allPorts},deleteNode:y,selectNode:f,readonly:n,linkingNodeId:c,nodeRef:u,onFocus:m,onBlur:_,getExtInfo:w,updateExtInfo:x,toggleExpand:I,get form(){if(!N)return;return{...N,get values(){return d.current=!0,N.values},get state(){return M}}}}),[e,T,L,P,p,y,f,n,c,u,m,_,w,x,I,l])}function tu(){return(0,E.km)()}var tc=((o=tc||{}).GRAB="GRAB",o.SELECT="SELECT",o),tg=((a=tg||{}).MOUSE="MOUSE",a.PAD="PAD",a),tp=class{registerDocument(t){t.registerNodeDatas(D.eG,D.Lz,F,G),t.registerLayout(this.freeLayout)}};m([(0,_.f3)(Z)],tp.prototype,"freeLayout",2),tp=m([(0,_.b2)()],tp);var tf=new _.nZ((t,e,i,r)=>{t(tt).toSelf().inSingletonScope(),t(W).toSelf().inSingletonScope(),t(Z).toSelf().inSingletonScope(),t(tr).toSelf().inSingletonScope(),t(j).toSelf().inSingletonScope(),t(J).toSelf().inSingletonScope(),t(ts).toSelf().inSingletonScope(),t(p).to(to).inSingletonScope(),t(u).toDynamicValue(()=>(function(){let t=new Map;return location.search.replace(/^\?/,"").split("&").forEach(e=>{if(!e)return;let[i,r]=e.split("=");if(i){let e=decodeURIComponent(i.trim()),n=r?decodeURIComponent(r.trim()):"";if(["__proto__","constructor","prototype","__defineGetter__","__defineSetter__","__lookupGetter__","__lookupSetter__","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toString","valueOf","toLocaleString"].includes(e.toLowerCase()))return;t.set(e,n)}}),Object.fromEntries(t)})()).inSingletonScope(),(0,w.KV)(t,tp,[D.Lw]),t(U).toConstantValue({...H}),r(D.pQ).toService(tt),t(q).toDynamicValue(t=>()=>t.container.get(tt)).inSingletonScope()})},438024:function(t,e,i){i.d(e,{EU:()=>tn,Em:()=>O,Eq:()=>Z,HW:()=>j,Kz:()=>ts,NQ:()=>M,OK:()=>L,Pi:()=>P,Rf:()=>k,V7:()=>T,XD:()=>S,aK:()=>to,kD:()=>R,lV:()=>tr,oC:()=>A,qf:()=>th,qq:()=>tl});var r,n,s,o=i(832176),a=i(579962),l=i(893740),h=i(721855),d=i(9163),u=i(863875),c=i(89802),g=i(908600),p=i(27430),f=i(336808),y=i(661881),m=Object.defineProperty,E=Object.getOwnPropertyDescriptor,b=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?E(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&m(e,i,s),s},C="#BBBFC4";function S(){var t,e;let i=(0,l.G2)(a.h3);return{baseColor:(null==(t=i.constants)?void 0:t[a.cc.BASE_COLOR])||C,baseActivatedColor:(null==(e=i.constants)?void 0:e[a.cc.BASE_ACTIVATED_COLOR])||"#82A7FC"}}var D={stroke:C,fill:"transparent",strokeLinecap:"round",strokeLinejoin:"round"};function _(t){let{isVertical:e}=t.entity;if(e){var i,r,n;let e=(null==(i=t.entity.next)?void 0:i.firstChild)&&!t.entity.next.isInlineBlocks?t.entity.next.firstChild.getData(a.eG).size.width:null==(r=t.entity.next)?void 0:r.getData(a.eG).size.width;return Math.max((null==(n=t.entity.getData(a.eG))?void 0:n.size.width)??a.Lu[a.T4.HOVER_AREA_WIDTH],e||0)}return t.transform.next?t.transform.next.inputPoint.x-t.transform.outputPoint.x:32}function w(t){var e,i,r;let{isVertical:n}=t.entity;if(n)return t.transform.next?t.transform.next.inputPoint.y-t.transform.outputPoint.y:32;let s=(null==(e=t.entity.next)?void 0:e.firstChild)&&!t.entity.next.isInlineBlocks?t.entity.next.firstChild.getData(a.eG).size.height:null==(i=t.entity.next)?void 0:i.getData(a.eG).size.height;return Math.max((null==(r=t.entity.getData(a.eG))?void 0:r.size.height)||280,s||0)}var x=class extends l.cv{get hasScroll(){return!!(this._scrollXInterval||this._scrollYInterval)}isCollision(t,e,i){let r=this.playgroundConfigEntity.finalScale||0;return i?this.isBranchCollision(t,e,r):this.isNodeCollision(t,e,r)}isNodeCollision(t,e,i){let{labels:r}=t,{isVertical:n}=t.entity;return{hasCollision:r.some(r=>{if(!r||![a.nx.ADDER_LABEL,a.nx.COLLAPSE_ADDER_LABEL].includes(r.type))return!1;let s=n?t.transform.bounds.width:32,l=n?32:t.transform.bounds.height,h=new o.Ae((r.offset.x-s/2)*i,(r.offset.y-l/2)*i,s*i,l*i);return o.Ae.intersects(h,e)}),labelOffsetType:void 0}}isBranchCollision(t,e,i){let{labels:r}=t,{isVertical:n}=t.entity,s=a.VH.NORMAL_BRANCH;return{hasCollision:r.some(t=>{if(!t||t.type!==a.nx.BRANCH_DRAGGING_LABEL)return!1;let r=n?64:t.width||0,l=n?t.width||0:64,h=new o.Ae((t.offset.x-l/2)*i,(t.offset.y-r/2)*i,l*i,r*i),d=o.Ae.intersects(h,e);return d&&(s=t.props.side),d}),labelOffsetType:s}}_startScrollX(t,e){if(this._scrollXInterval)return;let i=window.setInterval(()=>{let t=this._scrollXInterval;if(!t)return;let i=t.origin=e?t.origin+4:t.origin-4;this.playgroundConfigEntity.updateConfig({scrollX:i});let r=this.playgroundConfigEntity.config;(null==r?void 0:r.scrollX)===i&&(e?this.containerX+=4:this.containerX-=4)},20);this._scrollXInterval={interval:i,origin:t}}_stopScrollX(){this._scrollXInterval&&(clearInterval(this._scrollXInterval.interval),this._scrollXInterval=void 0)}_startScrollY(t,e){if(this._scrollYInterval)return;let i=window.setInterval(()=>{let t=this._scrollYInterval;if(!t)return;let i=t.origin=e?t.origin+4:t.origin-4;this.playgroundConfigEntity.updateConfig({scrollY:i});let r=this.playgroundConfigEntity.config;(null==r?void 0:r.scrollY)===i&&(e?this.containerY+=4:this.containerY-=4)},20);this._scrollYInterval={interval:i,origin:t}}_stopScrollY(){this._scrollYInterval&&(clearInterval(this._scrollYInterval.interval),this._scrollYInterval=void 0)}stopAllScroll(){this._stopScrollX(),this._stopScrollY()}scrollDirection(t,e,i){let r=this.playgroundConfigEntity.config,n=r.scrollX,s=r.scrollY;this.containerX=e,this.containerY=i;let o=this.playgroundConfigEntity.playgroundDomNode.getBoundingClientRect();return r.height+o.y-t.clientY<20?(this._startScrollY(s,!0),1):t.clientY-o.y<20?(this._startScrollY(s,!1),0):(this._stopScrollY(),r.width+o.x-t.clientX<20)?(this._startScrollX(n,!0),3):t.clientX-o.x<80?(this._startScrollX(n,!1),2):void this._stopScrollX()}dispose(){this.toDispose.dispose()}constructor(t){super(t),this.containerX=0,this.containerY=0,this.playgroundConfigEntity=this.entityManager.getEntity(l.ER,!0)}};x.type="FlowDragEntity";var N=class extends l.cv{getDefaultConfig(){return{selectedNodes:[]}}get selectedNodes(){return this.config.selectedNodes}set selectedNodes(t){((t=function(t){if(0===t.length)return[];let e=t.map(t=>(function(t){let e=[t];for(t=t.parent;t;)e.push(t),t=t.parent;return e.reverse()})(t)),i=Math.min(...e.map(t=>t.length)),r=0,n=[];for(;r<i&&!((n=(0,h.Z)(e.map(t=>t[r]))).length>1);)r+=1;return(0,h.Z)(n.map(t=>(function(t){for(;t.originParent;)t=t.originParent;return t})(t)))}(t)).length!==this.config.selectedNodes.length||t.some(t=>!this.config.selectedNodes.includes(t)))&&(this.config.selectedNodes.forEach(e=>{t.includes(e)||(e.getData(a.Lz).activated=!1)}),t.forEach(t=>{t.getData(a.Lz).activated=!0}),o.XJ.isArrayShallowChanged(this.config.selectedNodes,t)&&this.updateConfig({selectedNodes:t}))}clearSelectedNodes(){0!==this.config.selectedNodes.length&&(this.config.selectedNodes.forEach(t=>{t.getData(a.Lz).activated=!1}),this.updateConfig({selectedNodes:[]}))}selectFromBounds(t,e){let i=[];e.forEach(e=>{o.Ae.intersects(t,e.bounds)&&(e.entity.originParent?i.push(e.entity.originParent):i.push(e.entity))}),this.selectedNodes=i}getSelectedBounds(){let t=this.selectedNodes;return 0===t.length?o.Ae.EMPTY:o.Ae.enlarge(t.map(t=>t.getData(a.eG).bounds)).pad(this.boundsPadding)}constructor(){super(...arguments),this.boundsPadding=10}};N.type="FlowSelectConfigEntity";var M=class extends l.cv{get dragInfo(){return this.config}setDragInfo(t){this.updateConfig(t)}get disabled(){return this.config&&!!this.config.disabled}set disabled(t){this.updateConfig({disabled:t})}get isStart(){return this.dragInfo.isStart}get isMoving(){return this.dragInfo.isMoving}get position(){let{dragInfo:t}=this;return{x:t.startPos.x<t.endPos.x?t.startPos.x:t.endPos.x,y:t.startPos.y<t.endPos.y?t.startPos.y:t.endPos.y}}get size(){let{dragInfo:t}=this;return{width:Math.abs(t.startPos.x-t.endPos.x),height:Math.abs(t.startPos.y-t.endPos.y)}}get collapsed(){let{size:t}=this;return 0===t.width&&0===t.height}collapse(){this.setDragInfo({...this.dragInfo,isMoving:!1,isStart:!1})}toRectangle(t){let{position:e,size:i}=this;return new o.Ae(e.x/t,e.y/t,i.width/t,i.height/t)}};M.type="SelectorBoxConfigEntity";var I=class{observe(t,e){let i=new ResizeObserver(t=>{window.requestAnimationFrame(()=>{if(!Array.isArray(t)||!t.length)return;let{contentRect:i,target:r}=t[0],n=!!i&&(0!==i.bottom||0!==i.height||0!==i.left||0!==i.right||0!==i.top||0!==i.width||0!==i.x||0!==i.y)&&!0,s=!r.parentNode,o=(t=>{if(!t||(0,u.Z)(null==t?void 0:t.offsetParent))return!0;let e=window.getComputedStyle(t);return(null==e?void 0:e.display)==="none"})(r.parentNode);!n||s||o||(e.size={width:Math.round(10*i.width)/10,height:Math.round(10*i.height)/10})})});return i.observe(t),o.JT.create(()=>{i.unobserve(t)})}};I=b([(0,d.b2)()],I);var T=class extends l.mh{get transformVisibles(){return this.document.getRenderDatas(a.eG,!1)}onZoom(t){this.node.style.transform=`scale(${t})`}dispose(){this.renderCache.dispose(),super.dispose()}isCoordEqual(t,e){return .05>Math.abs(t-e)}onReady(){this.node.style.zIndex="10"}get visibeBounds(){return this.transformVisibles.map(t=>t.bounds)}updateNodesBounds(){this.renderCache.getMoreByItems(this.transformVisibles).forEach(t=>t.updateBounds())}autorun(){this.documentTransformer.loading||(this.documentTransformer.refresh(),this.updateNodesBounds())}get renderElement(){if("function"==typeof this.options.renderElement){let t=this.options.renderElement();if(t)return t}else if(void 0!==this.options.renderElement)return this.options.renderElement;return this.node}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-flow-nodes-layer"),this.renderCache=o.Ct.create(t=>{let e,{renderState:i}=t,{node:r}=i,{entity:n}=t;r.id=n.id;let s=()=>{e&&(r.parentElement&&this.renderElement.removeChild(r),e.dispose(),e=void 0)};return!e&&(this.renderElement.appendChild(r),n.getNodeMeta().autoResizeDisable||(e=this.resizeObserver.observe(r,t))),{dispose:s,updateBounds:()=>{let{bounds:e}=t,i=parseFloat(r.style.left),n=parseFloat(r.style.top);this.isCoordEqual(i,e.x)&&this.isCoordEqual(n,e.y)||(r.style.left=`${e.x}px`,r.style.top=`${e.y}px`)}}})}};b([(0,d.f3)(a.pQ)],T.prototype,"document",2),b([(0,d.f3)(I)],T.prototype,"resizeObserver",2),b([(0,l.O0)(a.Vl)],T.prototype,"documentTransformer",2),b([(0,l.aI)(a.GA,a.eG)],T.prototype,"_transforms",2),T=b([(0,d.b2)()],T);var L=Symbol("FlowRendererContribution"),P=((r=P||{})[r.REACT=0]="REACT",r[r.DOM=1]="DOM",r[r.TEXT=2]="TEXT",r),R=((n=R||{}).NODE_RENDER="node-render",n.ADDER="adder",n.COLLAPSE="collapse",n.BRANCH_ADDER="branch-adder",n.TRY_CATCH_COLLAPSE="try-catch-collapse",n.DRAG_NODE="drag-node",n.DRAGGABLE_ADDER="draggable-adder",n.DRAG_HIGHLIGHT_ADDER="drag-highlight-adder",n.DRAG_BRANCH_HIGHLIGHT_ADDER="drag-branch-highlight-adder",n.SELECTOR_BOX_POPOVER="selector-box-popover",n.CONTEXT_MENU_POPOVER="context-menu-popover",n.SUB_CANVAS="sub-canvas",n.SLOT_ADDER="slot-adder",n.SLOT_LABEL="slot-label",n.SLOT_COLLAPSE="slot-collapse",n.ARROW_RENDERER="arrow-renderer",n.MARKER_ARROW="marker-arrow",n.MARKER_ACTIVATE_ARROW="marker-active-arrow",n),A=((s=A||{}).LOOP_END_TEXT="loop-end-text",s.LOOP_TRAVERSE_TEXT="loop-traverse-text",s.LOOP_WHILE_TEXT="loop-while-text",s.TRY_START_TEXT="try-start-text",s.TRY_END_TEXT="try-end-text",s.CATCH_TEXT="catch-text",s),k=class{init(){this.contribs.forEach(t=>{var e;return null==(e=t.registerRenderer)?void 0:e.call(t,this)})}registerRendererComponents(t,e){this.componentsMap.set(t,e)}registerReactComponent(t,e){this.componentsMap.set(t,{type:0,renderer:e})}registerText(t){Object.entries(t).forEach(t=>{let[e,i]=t;this.textMap.set(e,i)})}getText(t){return p.o.t(t,{defaultValue:""})||this.textMap.get(t)}getRendererComponent(t){let e=this.componentsMap.get(t);if(!e)throw Error(`Unknown render key ${t}`);return e}tryToGetRendererComponent(t){return this.componentsMap.get(t)}registerLayers(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(t=>this.pipeline.registerLayer(t))}registerLayer(t,e){this.pipeline.registerLayer(t,e)}constructor(){this.componentsMap=new Map,this.textMap=new Map,this.contribs=[]}};b([(0,d.nx)(L),(0,d.jt)()],k.prototype,"contribs",2),b([(0,d.f3)(l.Rm)],k.prototype,"pipeline",2),k=b([(0,d.b2)()],k);var O=class extends l.mh{get renderStatesVisible(){return this.document.getRenderDatas(a.Lz,!1)}getPortalRenderer(t){let e=t.entity.getNodeMeta(),i=this.rendererRegistry.getRendererComponent(e.renderKey||"node-render").renderer,r=this.renderMemoCache.get(i);return r||(r=g.memo(i),this.renderMemoCache.set(i,r)),r}onZoom(t){this.node.style.transform=`scale(${t})`}dispose(){this.reactPortals.dispose(),super.dispose()}onReady(){this.node.style.zIndex="10"}onReadonlyOrDisabledChange(){this.render()}getPortals(){return this.reactPortals.getMoreByItems(this.renderStatesVisible)}render(){return this.documentTransformer.loading?g.createElement(g.Fragment,null):(this.documentTransformer.refresh(),g.createElement(g.Fragment,null,this.getPortals().map(t=>g.createElement(t.Portal,{key:t.id}))))}constructor(){super(...arguments),this.renderMemoCache=new WeakMap,this.node=o.xF.createDivWithClass("gedit-flow-nodes-layer"),this.reactPortals=o.Ct.create(t=>{let{node:e,entity:i}=t,{config:r}=this,n=this.getPortalRenderer(t);return{id:e.id||i.id,dispose:()=>{},Portal:function(){return g.useEffect(()=>{if(!i.getNodeMeta().autoResizeDisable&&e.clientWidth&&e.clientHeight){let t=i.getData(a.eG);t&&(t.size={width:e.clientWidth,height:e.clientHeight})}},[i,e]),c.createPortal(g.createElement(l.rQ.Provider,{value:i},g.createElement(n,{node:i,version:null==t?void 0:t.version,activated:null==t?void 0:t.activated,readonly:r.readonly,disabled:r.disabled})),e)}}})}};b([(0,d.f3)(a.pQ)],O.prototype,"document",2),b([(0,d.f3)(k)],O.prototype,"rendererRegistry",2),b([(0,l.O0)(a.Vl)],O.prototype,"documentTransformer",2),b([(0,l.aI)(a.GA,a.Lz)],O.prototype,"_renderStates",2),O=b([(0,d.b2)()],O);var V=function(t){let{from:e,to:i,activated:r,style:n}=t,{baseColor:s,baseActivatedColor:o}=S();return g.createElement("path",{"data-line-id":t.lineId,d:`M ${e.x} ${e.y} L ${i.x} ${i.y}`,...D,stroke:r?o:s,style:n})},B="$marker_arrow$",F=function(t){let{baseColor:e}=S();return g.createElement("marker",{"data-line-id":t.id,id:t.id||B,markerWidth:"11",markerHeight:"14",refX:"10",refY:"7",orient:"auto"},g.createElement("path",{d:"M9.6 5.2C10.8 6.1 10.8 7.9 9.6 8.8L3.6 13.3C2.11672 14.4125 0 13.3541 0 11.5L0 2.5C0 0.645898 2.11672 -0.412461 3.6 0.7L9.6 5.2Z",fill:e}))},z="$marker_arrow_activated$",G=function(t){let{baseActivatedColor:e}=S();return g.createElement("marker",{"data-line-id":t.id,id:t.id||z,markerWidth:"11",markerHeight:"14",refX:"10",refY:"7",orient:"auto"},g.createElement("path",{d:"M9.6 5.2C10.8 6.1 10.8 7.9 9.6 8.8L3.6 13.3C2.11672 14.4125 0 13.3541 0 11.5L0 2.5C0 0.645898 2.11672 -0.412461 3.6 0.7L9.6 5.2Z",fill:e}))};function $(t){let e=(0,l.G2)(k),i=null==e?void 0:e.tryToGetRendererComponent(t.activated?"marker-active-arrow":"marker-arrow");return i?g.createElement(i.renderer,{...t}):t.activated?g.createElement("defs",null,g.createElement(G,{id:t.id})):g.createElement("defs",null,g.createElement(F,{id:t.id}))}var Y=function(t){let{vertices:e,radius:i=16,hide:r,xRadius:n,yRadius:s,...l}=t,{from:h,to:d,arrow:c,activated:p,style:f}=l||{},{baseActivatedColor:y,baseColor:m}=S(),E=e||(t.isHorizontal?function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,{from:r,to:n,type:s}=t||{},o=Math.abs(n.y-r.y),l=Math.abs(n.x-r.x),h=l/e,d=o/i,u=[];if(h<1)return[];switch(s){case a.IG.DIVERGE_LINE:case a.IG.DRAGGING_LINE:if(h<=1)return[{x:n.x,y:r.y,radiusX:l}];if(u=[{x:r.x+i,y:r.y},{x:r.x+i,y:n.y}],h<2){let t=l-i;u=[{x:r.x+t,y:r.y,radiusX:t},{x:r.x+t,y:n.y}]}return d<2&&(u[0].moveY=o/2,u[1].moveY=o/2),u;case a.IG.MERGE_LINE:if(h<2)return[{x:n.x,y:r.y}];return u=[{x:n.x-i,y:r.y},{x:n.x-i,y:n.y}],d<2&&(u[0].moveY=o/2,u[1].moveY=o/2),u}return[]}(l,n,s):function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,{from:r,to:n,type:s}=t||{},o=Math.abs(n.y-r.y),l=Math.abs(n.x-r.x),h=o/i,d=l/e,u=[];if(h<1)return[];switch(s){case a.IG.DIVERGE_LINE:case a.IG.DRAGGING_LINE:if(h<=1)return[{x:n.x,y:r.y,radiusY:o}];if(u=[{x:r.x,y:r.y+i},{x:n.x,y:r.y+i}],h<2){let t=o-i;u=[{x:r.x,y:r.y+t,radiusY:t},{x:n.x,y:r.y+t}]}return d<2&&(u[0].moveX=l/2,u[1].moveX=l/2),u;case a.IG.MERGE_LINE:if(h<2)return[{x:r.x,y:n.y}];return u=[{x:r.x,y:n.y-i},{x:n.x,y:n.y-i}],d<2&&(u[0].moveX=l/2,u[1].moveX=l/2),u}return[]}(l,n,s)),b=(0,g.useMemo)(()=>E.map((t,e)=>{let r=E[e-1]||h,n=E[e+1]||d,s={x:Math.abs(r.x-t.x),y:Math.abs(r.y-t.y)},a={x:Math.abs(n.x-t.x),y:Math.abs(n.y-t.y)},l=0===s.x&&0===a.y,c=0===s.y&&0===a.x;l||c||console.error(`vertex ${t.x},${t.y} is not right angle`);let g=new o.E9().copyFrom(t),p=new o.E9().copyFrom(t),f=(0,u.Z)(t.radiusX)?i:t.radiusX,y=(0,u.Z)(t.radiusY)?i:t.radiusY,m=f,b=y;if(l){b=Math.min(s.y,y);let e=(0,u.Z)(t.moveY)?b:t.moveY;g.y+=h.y<t.y?-e:+e,m=Math.min(a.x,f);let i=(0,u.Z)(t.moveX)?m:t.moveX;p.x+=d.x<t.x?-i:+i}if(c){m=Math.min(s.x,f);let e=(0,u.Z)(t.moveX)?m:t.moveX;g.x+=h.x<t.x?-e:+e,b=Math.min(a.y,y);let i=(0,u.Z)(t.moveY)?b:t.moveY;p.y+=d.y<t.y?-i:+i}"truncate"===t.radiusOverflow&&(m=f,b=y);let C=(t.x-g.x)*(p.y-g.y)-(t.y-g.y)*(p.x-g.x);return`L ${g.x} ${g.y} A ${m} ${b} 0 0 ${+(C>0)} ${p.x} ${p.y}`}).join(" "),[E]);if(r)return null;let C=`M ${h.x} ${h.y} ${b} L ${d.x} ${d.y}`,_=p?`${z}${t.lineId}`:`${B}${t.lineId}`;return g.createElement(g.Fragment,null,c?g.createElement($,{id:_,activated:p}):null,g.createElement("path",{"data-line-id":t.lineId,d:C,...D,stroke:p?y:m,...c?{markerEnd:`url(#${_})`}:{},style:f}))},X=function(t){let{renderKey:e,rendererRegistry:i,...r}=t;if(!e)return g.createElement(g.Fragment,null);let n=i.getRendererComponent(e);if(!n)return g.createElement(g.Fragment,null);let s=n.renderer;return g.createElement(s,{lineId:t.lineId,...r})},j=class extends l.mh{get transitions(){return this.document.getRenderDatas(a.Xr)}onZoom(){var t;let e=this.node.querySelector("svg.flow-lines-container");null==e||null==(t=e.setAttribute)||t.call(e,"viewBox",this.viewBox)}onReady(){this.node.style.zIndex="1"}get viewBox(){let t=1e3/this.config.finalScale;return`0 0 ${t} ${t}`}render(){let t=[],e=this.config.isViewportVisible.bind(this.config);if(this.documentTransformer.loading)return g.createElement(g.Fragment,null);this.documentTransformer.refresh(),this.transitions.forEach(i=>{!function(t){let{data:e,rendererRegistry:i,linesSave:r,dragService:n}=t,{lines:s,entity:l}=e||{},h=(0,a.yI)(l,a.T4.ROUNDED_LINE_X_RADIUS),d=(0,a.yI)(l,a.T4.ROUNDED_LINE_Y_RADIUS);s.forEach((s,l)=>{let u=o.Ae.createRectangleWithTwoPoints(s.from,s.to).pad(10);if(t.isViewportVisible(u)){let t=((t,r)=>{var s;let{renderData:o}=e,{isVertical:l}=e.entity,{lineActivated:u}=o||{},c=(t.type===a.IG.DRAGGING_LINE||t.isDraggingLine)&&!n.isDroppableBranch(e.entity,t.side),p=(t.type===a.IG.DRAGGING_LINE||t.isDraggingLine)&&(null==(s=e.entity)?void 0:s.id)===n.dropNodeId&&t.side===n.labelSide;switch(t.type){case a.IG.STRAIGHT_LINE:return g.createElement(V,{key:`${e.entity.id}_${r}`,lineId:e.entity.id,activated:u,...t});case a.IG.DIVERGE_LINE:case a.IG.DRAGGING_LINE:case a.IG.MERGE_LINE:case a.IG.ROUNDED_LINE:return g.createElement(Y,{key:`${e.entity.id}_${r}`,lineId:e.entity.id,isHorizontal:!l,activated:u||p,...t,xRadius:h,yRadius:d,hide:c});case a.IG.CUSTOM_LINE:return g.createElement(X,{key:`${e.entity.id}_${r}`,lineId:e.entity.id,...t,rendererRegistry:i})}})(s,l);t&&r.push(t)}})}({data:i,rendererRegistry:this.rendererRegistry,isViewportVisible:e,linesSave:t,dragService:this.dragService})});let{activateLines:i=[],normalLines:r=[]}=(0,f.Z)(t,t=>t.props.activated?"activateLines":"normalLines"),n=[...r,...i];return g.createElement("svg",{className:"flow-lines-container",width:"1000",height:"1000",overflow:"visible",viewBox:this.viewBox,xmlns:"http://www.w3.org/2000/svg"},n)}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-flow-lines-layer"),this.onViewportChange=(0,y.Z)(()=>{this.render()},100)}};function J(t){let{data:e,rendererRegistry:i,forceVisible:r,hoverHeight:n=w(e),hoverWidth:s=_(e),wrapperStyle:o,...l}=t,{activateNode:h}=l,[d,u]=(0,g.useState)(!1),c=null==h?void 0:h.getData(a.Lz),p=(0,g.useCallback)(()=>{u(!0),null==c||c.toggleMouseEnter()},[]),f=(0,g.useCallback)(()=>{u(!1),null==c||c.toggleMouseLeave()},[]),y=i.getRendererComponent("collapse"),m=e.entity,E=g.createElement(y.renderer,{node:m,collapseNode:m,...l,hoverActivated:d}),b=e.collapsed||(null==c?void 0:c.hovered)||d||r;return g.createElement("div",{className:"flow-canvas-collapse",onMouseEnter:p,onMouseLeave:f,style:{width:s,height:n,display:"flex",justifyContent:"center",alignItems:"center",...o}},b?E:null)}function U(t){let{data:e,rendererRegistry:i,hoverHeight:r=w(e),hoverWidth:n=_(e),...s}=t,[o,h]=(0,g.useState)(!1),d=(0,g.useCallback)(()=>h(!0),[]),u=(0,g.useCallback)(()=>h(!1),[]),c=e.entity,p=((t,e)=>{let{dragService:i}=e;return i&&i.dragging&&i.isDroppableNode(t)?i.dropNodeId===t.id?"drag-highlight-adder":"draggable-adder":"adder"})(c,{dragService:(0,l.G2)(a.eE)}),f=i.getRendererComponent(p),y=e.entity.document.renderTree.getOriginInfo(c).next,m=c.next,E=g.createElement(f.renderer,{node:c,from:c,to:y,renderTo:m,hoverActivated:o,setHoverActivated:h,hoverWidth:n,hoverHeight:r,...s});return g.createElement("div",{className:"flow-canvas-adder","data-testid":"sdk.flowcanvas.line.adder","data-from":c.id,"data-to":(null==y?void 0:y.id)??"",onMouseEnter:d,onMouseLeave:u,style:{width:n,height:r,display:"flex",justifyContent:"center",alignItems:"center"}},E)}function H(t){let{data:e,rendererRegistry:i,...r}=t,{activateNode:n}=r,[s,o]=(0,g.useState)(!1),l=null==n?void 0:n.getData(a.Lz),h=(0,g.useCallback)(()=>{o(!0)},[]),d=(0,g.useCallback)(()=>{o(!1)},[]),u=null==n?void 0:n.isVertical,c=(null==l?void 0:l.hovered)||s;return u?g.createElement("div",{className:"flow-canvas-collapse-adder",onMouseEnter:h,onMouseLeave:d},(c||e.collapsed)&&g.createElement(J,{forceVisible:!0,...t,wrapperStyle:{alignItems:"flex-end"},hoverHeight:20}),!e.collapsed&&g.createElement(U,{...t,hoverHeight:c?20:40,hoverActivated:c})):g.createElement("div",{className:"flow-canvas-collapse-adder",onMouseEnter:h,onMouseLeave:d,style:{display:e.collapsed?"block":"flex"}},(c||e.collapsed)&&g.createElement(J,{forceVisible:!0,...t,wrapperStyle:{justifyContent:"flex-end"},hoverWidth:20}),!e.collapsed&&g.createElement(U,{...t,hoverWidth:c?20:40,hoverActivated:c}))}function W(t){let{data:e,rendererRegistry:i,side:r,...n}=t,s=e.entity,o=((t,e)=>{let{dragService:i,side:r}=e;return i.isDragBranch&&r&&i.labelSide===r&&i.isDroppableBranch(t,r)?i.dropNodeId===t.id?"drag-branch-highlight-adder":"draggable-adder":""})(s,{side:r,dragService:(0,l.G2)(a.eE)});if(!o)return null;let h=i.getRendererComponent(o),d=e.entity.document.renderTree.getOriginInfo(s).next,u=s.next,c=g.createElement(h.renderer,{node:s,from:s,to:d,renderTo:u,...n});return g.createElement("div",{className:"flow-canvas-branch-draggable-adder"},c)}b([(0,d.f3)(a.pQ)],j.prototype,"document",2),b([(0,d.f3)(a.eE)],j.prototype,"dragService",2),b([(0,d.f3)(k)],j.prototype,"rendererRegistry",2),b([(0,l.O0)(a.Vl)],j.prototype,"documentTransformer",2),b([(0,l.O0)(a.y3)],j.prototype,"flowRenderState",2),b([(0,l.aI)(a.GA,a.Xr)],j.prototype,"_transitions",2),j=b([(0,d.b2)()],j);var K={fontSize:12,color:"#8F959E",textAlign:"center",whiteSpace:"nowrap",backgroundColor:"var(--g-editor-background)",lineHeight:"20px"},Z=class extends l.mh{get transitions(){return this.document.getRenderDatas(a.Xr)}onZoom(t){this.node.style.transform=`scale(${t})`}onReady(){this.node.style.zIndex="9"}onReadonlyOrDisabledChange(){this.render()}render(){var t,e,i;let r=[];if(null==(t=this.documentTransformer)?void 0:t.loading)return g.createElement(g.Fragment,null);null==(i=this.documentTransformer)||null==(e=i.refresh)||e.call(i);let{baseActivatedColor:n,baseColor:s}=S(),l=this.config.isViewportVisible.bind(this.config);return this.transitions.forEach(t=>{!function(t){let{data:e,rendererRegistry:i,labelsSave:r,getLabelColor:n}=t,{labels:s,renderData:l}=e||{},{activated:h}=l||{};s.forEach((s,l)=>{var d;t.isViewportVisible((d=s.offset,new o.Ae(d.x-75,d.y-30,150,60)))&&r.push(((r,s)=>{let{offset:o,renderKey:l,props:d,rotate:u,origin:c,type:p}=r||{},f=o.x,y=o.y,m=null;switch(p){case a.nx.BRANCH_DRAGGING_LABEL:m=g.createElement(W,{labelId:r.labelId||t.data.entity.id,rendererRegistry:i,data:e,...d});break;case a.nx.ADDER_LABEL:m=g.createElement(U,{labelId:r.labelId||t.data.entity.id,rendererRegistry:i,data:e,...d});break;case a.nx.COLLAPSE_LABEL:m=g.createElement(J,{labelId:r.labelId||t.data.entity.id,rendererRegistry:i,data:e,...d});break;case a.nx.COLLAPSE_ADDER_LABEL:m=g.createElement(H,{labelId:r.labelId||t.data.entity.id,rendererRegistry:i,data:e,...d});break;case a.nx.TEXT_LABEL:if(!l)return null;let E=i.getText(l)||l;m=g.createElement("div",{"data-label-id":r.labelId||t.data.entity.id,style:{...K,...null==d?void 0:d.style,color:n(h),transform:u?`rotate(${u})`:void 0}},E);break;case a.nx.CUSTOM_LABEL:if(!l)return null;try{let n=i.getRendererComponent(l);m=g.createElement(n.renderer,{node:e.entity,labelId:r.labelId||t.data.entity.id,...d})}catch(t){console.error(t),m=l}}let b="number"==typeof(null==c?void 0:c[0])?null==c?void 0:c[0]:.5,C="number"==typeof(null==c?void 0:c[1])?null==c?void 0:c[1]:.5;return g.createElement("div",{key:`${e.entity.id}${s}`,"data-label-id":r.labelId||t.data.entity.id,style:{position:"absolute",left:f,top:y,transform:`translate(-${100*b}%, -${100*C}%)`}},m)})(s,l))})}({data:t,rendererRegistry:this.rendererRegistry,isViewportVisible:l,labelsSave:r,getLabelColor:t=>t?n:s})}),g.createElement(g.Fragment,null,r)}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-flow-labels-layer"),this.onViewportChange=(0,y.Z)(()=>{this.render()},100)}};function Q(t,e){let i=e.finalScale;return new o.Ae(t.scrollX/i,t.scrollY/i,e.config.width/i,e.config.height/i).pad(-120/i,-120/i)}b([(0,d.f3)(a.pQ)],Z.prototype,"document",2),b([(0,d.f3)(k)],Z.prototype,"rendererRegistry",2),b([(0,l.O0)(a.Vl)],Z.prototype,"documentTransformer",2),b([(0,l.O0)(a.y3)],Z.prototype,"flowRenderState",2),b([(0,l.aI)(a.GA,a.Xr)],Z.prototype,"_transitions",2),Z=b([(0,d.b2)()],Z);var q=Symbol("ScrollBarEvents"),tt=0;function te(t){let e=Math.min(t/10*255,255),i=(tt+=1)%3,r=()=>Math.floor(Math.random()*e);return`rgb(${0===i?r():0}, ${1===i?r():0}, ${2===i?r():0})`}var ti=class extends l.mh{get transforms(){return this.document.getRenderDatas(a.eG)}onReady(){this.node.style.zIndex="20",o.xF.setStyle(this.originLine,{position:"absolute",width:1,height:"100%",left:this.pipelineNode.style.left,top:0,borderLeft:"1px dashed rgba(255, 0, 0, 0.5)"}),this.pipelineNode.parentElement.appendChild(this.originLine),this.node.appendChild(this.viewport),this.node.appendChild(this.versionNodes),this.node.appendChild(this.boundsNodes),this.node.appendChild(this.pointsNodes),this.renderScrollViewportBounds()}onScroll(){this.originLine.style.left=this.pipelineNode.style.left,this.renderScrollViewportBounds()}onResize(){this.renderScrollViewportBounds()}onZoom(t){this.node.style.transform=`scale(${t})`,this.renderScrollViewportBounds()}createBounds(t,e,i){if(this.filterKey&&-1===t.key.indexOf(this.filterKey))return;let r=this.domCache.get(t),{bounds:n,inputPoint:s,outputPoint:a}=t;if(!r){let i=o.xF.createDivWithClass(""),n=o.xF.createDivWithClass(""),s=o.xF.createDivWithClass(""),a=o.xF.createDivWithClass("");i.title=t.key,n.title=t.key+"(input)",s.title=t.key+"(output)",a.title=t.key,this.boundsNodes.appendChild(i),this.pointsNodes.appendChild(n),this.pointsNodes.appendChild(s),this.versionNodes.appendChild(a),t.onDispose(()=>{i.remove(),n.remove(),s.remove()}),r={bbox:i,input:n,output:s,version:a,color:e},this.domCache.set(t,r)}o.xF.setStyle(r.version,{position:"absolute",marginLeft:"-9px",marginTop:"-10px",borderRadius:12,background:"#f54a45",padding:4,color:"navajowhite",display:t.renderState.hidden?"none":"block",zIndex:i+1e3,left:n.center.x,top:n.center.y}),r.version.innerHTML=t.version.toString(),o.xF.setStyle(r.input,{position:"absolute",width:10,height:10,marginLeft:-5,marginTop:-5,borderRadius:5,left:s.x,top:s.y,opacity:.4,zIndex:i,backgroundColor:r.color,whiteSpace:"nowrap",overflow:"visible"}),r.input.innerHTML=`${s.x},${s.y}`,o.xF.setStyle(r.output,{position:"absolute",width:10,height:10,marginLeft:-5,marginTop:-5,borderRadius:5,left:a.x,top:a.y,opacity:.4,zIndex:i,backgroundColor:r.color,whiteSpace:"nowrap",overflow:"visible"}),r.output.innerHTML=`${a.x},${a.y}`,o.xF.setStyle(r.bbox,{position:"absolute",width:n.width,height:n.height,left:n.left,top:n.top,opacity:`${i/30}`,backgroundColor:r.color})}renderScrollViewportBounds(){let t=Q({scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY},this.config);o.xF.setStyle(this.viewport,{position:"absolute",width:t.width-2,height:t.height-2,left:t.left+1,top:t.top+1,border:"1px solid rgba(200, 200, 255, 0.5)"})}autorun(){if(this.documentTransformer.loading)return;this.documentTransformer.refresh();let t=te(0);this.document.traverse((e,i)=>{let r=e.getData(a.eG);t=te(i),this.createBounds(r,t,i)}),this.renderScrollViewportBounds()}constructor(){var t;super(...arguments),this.node=document.createElement("div"),this.viewport=o.xF.createDivWithClass("gedit-flow-debug-bounds"),this.boundsNodes=o.xF.createDivWithClass("gedit-flow-debug-bounds"),this.pointsNodes=o.xF.createDivWithClass("gedit-flow-debug-points"),this.versionNodes=o.xF.createDivWithClass("gedit-flow-debug-versions gedit-hidden"),this.filterKey=(null==(t=window.location.search.match(/debug=([^&]+)/))?void 0:t[1])||"",this.originLine=document.createElement("div"),this.domCache=new WeakMap}};b([(0,d.f3)(a.pQ)],ti.prototype,"document",2),b([(0,l.O0)(a.Vl)],ti.prototype,"documentTransformer",2),b([(0,l.aI)(a.GA,a.eG)],ti.prototype,"_transforms",2),ti=b([(0,d.b2)()],ti);var tr=class extends l.mh{get clientViewportWidth(){return this.viewportWidth*this.scale-11}get clientViewportHeight(){return this.viewportHeight*this.scale-11}get viewportFullWidth(){return this.mostLeft-this.mostRight}get viewportFullHeight(){return this.mostTop-this.mostBottom}get viewportMoveWidth(){return this.mostLeft-this.mostRight+this.width}get viewportMoveHeight(){return this.mostTop-this.mostBottom+this.height}getToLeft(t){return(t-this.mostRight)/this.viewportMoveWidth*this.clientViewportWidth}getToTop(t){return(t-this.mostBottom)/this.viewportMoveHeight*this.clientViewportHeight}clickRightScrollBar(t){t.preventDefault(),t.stopPropagation();let e=1-((null==t?void 0:t.y)||0)/this.clientViewportHeight,i=(this.mostTop-this.viewportFullHeight*e)*this.scale;this.playgroundConfigEntity.scroll({scrollY:i},!1)}clickBottomScrollBar(t){t.preventDefault(),t.stopPropagation();let e=1-((null==t?void 0:t.x)||0)/this.clientViewportWidth,i=(this.mostLeft-this.viewportFullWidth*e)*this.scale;this.playgroundConfigEntity.scroll({scrollX:i},!1)}onBoardingToast(){var t;null==(t=this.events)||t.dragStart()}changeScrollBarVisibility(t,e){o.xF.addClass(t,"show"===e?"gedit-playground-scroll-show":"gedit-playground-scroll-hidden"),o.xF.delClass(t,"show"===e?"gedit-playground-scroll-hidden":"gedit-playground-scroll-show")}onReady(){this.options.getBounds||(this.options={getBounds:()=>{let t=this.flowDocument;return t?(t.transformer.refresh(),t.root.getData(a.eG).bounds):o.Ae.EMPTY},showScrollBars:"whenScrolling"}),this.pipelineNode.parentNode.appendChild(this.rightScrollBar),this.pipelineNode.parentNode.appendChild(this.rightScrollBarBlock),this.pipelineNode.parentNode.appendChild(this.bottomScrollBar),this.pipelineNode.parentNode.appendChild(this.bottomScrollBarBlock),this.rightScrollBar.onclick=this.clickRightScrollBar.bind(this),this.bottomScrollBar.onclick=this.clickBottomScrollBar.bind(this),"whenScrolling"===this.options.showScrollBars&&(this.rightScrollBar.addEventListener("mouseenter",t=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"show")}),this.rightScrollBar.addEventListener("mouseleave",t=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"hidden")}),this.bottomScrollBar.addEventListener("mouseenter",t=>{this.changeScrollBarVisibility(this.bottomScrollBarBlock,"show")}),this.bottomScrollBar.addEventListener("mouseleave",t=>{this.changeScrollBarVisibility(this.bottomScrollBarBlock,"hidden")})),this.bottomScrollBarBlock.addEventListener("mousedown",t=>{this.bottomGrabDragger.start(t.clientX,t.clientY),t.stopPropagation()}),this.rightScrollBarBlock.addEventListener("mousedown",t=>{this.rightGrabDragger.start(t.clientX,t.clientY),t.stopPropagation()})}autorun(){this.hideTimeout&&clearTimeout(this.hideTimeout);let t=Q({scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY},this.config),e=this.config.getViewport();this.viewportWidth=e.width,this.viewportHeight=e.height;let i=this.options.getBounds();this.width=(null==i?void 0:i.width)||0,this.height=(null==i?void 0:i.height)||0;let r=(this.viewportWidth-t.width)/2-2,n=(this.viewportHeight-t.height)/2-2,s=this.width+t.width,a=this.height+t.height,l=i.x,h=i.y;this.mostLeft=this.width+l-r,this.mostRight=this.mostLeft-s,this.mostTop=this.height+h-n,this.mostBottom=this.mostTop-a,this.scale=this.config.finalScale;let d=this.clientViewportWidth,u=this.clientViewportHeight;this.scrollBottomWidth=d-d*(this.mostLeft-this.mostRight)/this.viewportMoveWidth,this.scrollRightHeight=u-u*(this.mostTop-this.mostBottom)/this.viewportMoveHeight;let c=this.getToLeft(e.x),g=this.getToTop(e.y);o.xF.setStyle(this.rightScrollBarBlock,{right:2,top:g,background:"#1F2329",zIndex:10,height:this.scrollRightHeight,width:"7px"}),o.xF.setStyle(this.bottomScrollBarBlock,{left:c,bottom:2,background:"#1F2329",zIndex:10,height:"7px",width:this.scrollBottomWidth}),this.changeScrollBarVisibility(this.rightScrollBarBlock,"show"),this.changeScrollBarVisibility(this.bottomScrollBarBlock,"show"),"whenScrolling"===this.options.showScrollBars&&(this.hideTimeout=window.setTimeout(()=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"hidden"),this.changeScrollBarVisibility(this.bottomScrollBarBlock,"hidden"),this.hideTimeout=void 0},1e3))}constructor(){super(...arguments),this.rightScrollBar=o.xF.createDivWithClass("gedit-playground-scroll-right"),this.rightScrollBarBlock=o.xF.createDivWithClass("gedit-playground-scroll-right-block"),this.bottomScrollBar=o.xF.createDivWithClass("gedit-playground-scroll-bottom"),this.bottomScrollBarBlock=o.xF.createDivWithClass("gedit-playground-scroll-bottom-block"),this.sum=0,this.initialScrollX=0,this.initialScrollY=0,this.bottomGrabDragger=new l.s5({onDragStart:t=>{this.config.updateCursor("grabbing"),this.sum=0,this.initialScrollX=this.config.getViewport().x,this.onBoardingToast()},onDrag:t=>{this.sum+=t.movingDelta.x,this.playgroundConfigEntity.scroll({scrollX:(this.initialScrollX+this.sum*this.viewportFullWidth/(this.clientViewportWidth-this.scrollBottomWidth))*this.scale},!1)},onDragEnd:t=>{this.config.updateCursor("default")}}),this.rightGrabDragger=new l.s5({onDragStart:t=>{this.config.updateCursor("grabbing"),this.sum=0,this.initialScrollY=this.config.getViewport().y,this.onBoardingToast()},onDrag:t=>{this.sum+=t.movingDelta.y,this.playgroundConfigEntity.scroll({scrollY:(this.initialScrollY+this.sum*this.viewportFullHeight/(this.clientViewportHeight-this.scrollRightHeight))*this.scale},!1)},onDragEnd:t=>{this.config.updateCursor("default")}})}};b([(0,d.jt)(),(0,d.f3)(q)],tr.prototype,"events",2),b([(0,d.f3)(a.pQ),(0,d.jt)()],tr.prototype,"flowDocument",2),b([(0,l.O0)(l.ER)],tr.prototype,"playgroundConfigEntity",2),tr=b([(0,d.b2)()],tr);var tn=class extends l.mh{get transitions(){let t=[];return this.document.traverse(e=>{t.push(e.getData(a.Xr))}),t}get dragStartEntity(){return this.flowRenderStateEntity.getDragStartEntity()}set dragStartEntity(t){this.flowRenderStateEntity.setDragStartEntity(t)}get dragEntities(){return this.flowRenderStateEntity.getDragEntities()}set dragEntities(t){this.flowRenderStateEntity.setDragEntities(t)}isGrab(){return this.editorStateConfig.getCurrentState()===l.yy.STATE_GRAB}setDraggingStatus(t){this.flowDragService.nodeDragIdsWithChildren.length&&this.flowDragService.nodeDragIdsWithChildren.forEach(e=>{let i=this.entityManager.getEntityById(e);(null==i?void 0:i.getData(a.Lz)).dragging=t}),this.flowRenderStateEntity.setDragging(t)}dragEnable(t){return Math.abs(t.clientX-this.initialPosition.x)>10||Math.abs(t.clientY-this.initialPosition.y)>10}handleMouseMove(t){if((this.dragJSON||this.dragStartEntity)&&this.dragEnable(t)){this.setDraggingStatus(!0);let i=this.playgroundConfigEntity.finalScale;if(this.containerRef.current){var e;let r,n=null==(e=this.containerRef.current.children)?void 0:e[0],s=this.playgroundConfigEntity.getClientBounds(),a=t.clientX-(this.pipelineNode.offsetLeft||0)-s.x-(n.clientWidth-this.dragOffset.x)*i,l=t.clientY-(this.pipelineNode.offsetTop||0)-s.y-(n.clientHeight-this.dragOffset.y)*i,h=this.flowDragService.isDragBranch,d=new o.Ae(a,l,n.clientWidth*i,n.clientHeight*i),u=this.transitions.find(t=>{var e,i;if(null==t||null==(i=t.entity)||null==(e=i.parent)?void 0:e.collapsed)return!1;let{hasCollision:n,labelOffsetType:s}=this.flowDragConfigEntity.isCollision(t,d,h);return r=s,n});u&&(h?this.flowDragService.isDroppableBranch(u.entity,r):this.flowDragService.isDroppableNode(u.entity))&&(!this.options.canDrop||this.options.canDrop({dragNodes:this.dragEntities,dropNode:u.entity,isBranch:h}))?this.flowRenderStateEntity.setNodeDroppingId(u.entity.id):this.flowRenderStateEntity.setNodeDroppingId(""),this.flowRenderStateEntity.setDragLabelSide(r),this.containerRef.current.style.visibility="visible",this.pipelineNode.parentElement.appendChild(this.draggingNodeMask),this.containerRef.current.style.left=`${a+this.pipelineNode.offsetLeft+s.x+window.scrollX}px`,this.containerRef.current.style.top=`${l+this.pipelineNode.offsetTop+s.y+window.scrollY}px`,this.containerRef.current.style.transformOrigin="top left",this.containerRef.current.style.transform=`scale(${i})`,this.disableDragScroll||this.flowDragConfigEntity.scrollDirection(t,a,l)}}}async handleMouseUp(){this.setDraggingStatus(!1),(this.dragStartEntity||this.dragJSON)&&(this.flowDragService.dropNodeId&&(this.flowDragService.isDragBranch?this.dragJSON?await this.flowDragService.dropCreateNode(this.dragJSON,this.onCreateNode):this.flowDragService.dropBranch():(this.dragJSON?await this.flowDragService.dropCreateNode(this.dragJSON,this.onCreateNode):this.flowDragService.dropNode(),this.selectConfigEntity.clearSelectedNodes())),this.flowRenderStateEntity.setNodeDroppingId(""),this.flowRenderStateEntity.setDragLabelSide(),this.flowRenderStateEntity.setIsBranch(!1),this.dragStartEntity=void 0,this.dragEntities=[],this.flowDragConfigEntity.stopAllScroll()),this.disableDragScroll=!1,this.dragJSON=void 0,this.containerRef.current&&(this.containerRef.current.style.visibility="hidden",this.pipelineNode.parentElement.contains(this.draggingNodeMask)&&this.pipelineNode.parentElement.removeChild(this.draggingNodeMask))}async startDrag(t,e,i){let{dragStartEntity:r,dragEntities:n,dragJSON:s,isBranch:o,onCreateNode:l}=e;if(this.isGrab()||this.config.disabled||this.config.readonly)return;this.disableDragScroll=!!(null==i?void 0:i.disableDragScroll),this.dragJSON=s,this.onCreateNode=l,this.flowRenderStateEntity.setIsBranch(!!o),this.dragOffset.x=(null==i?void 0:i.dragOffsetX)||8,this.dragOffset.y=(null==i?void 0:i.dragOffsetY)||8;let h=(null==r?void 0:r.flowNodeType)||(null==s?void 0:s.type),d=h===a.Sy.BLOCK_ICON,u=h===a.Sy.BLOCK_ORDER_ICON,c=d||u?r.parent:r;if(!c||c.getData(a.Lz).draggable)return this.initialPosition={x:t.clientX,y:t.clientY},this.dragStartEntity=c,this.dragEntities=n||(this.dragStartEntity?[this.dragStartEntity]:[]),this._dragger.start(t.clientX,t.clientY)}onReady(){this.draggingNodeMask.style.width="100%",this.draggingNodeMask.style.height="100%",this.draggingNodeMask.style.position="absolute",this.draggingNodeMask.classList.add("dragging-node"),this.draggingNodeMask.style.zIndex="99",this.draggingNodeMask.style.cursor="pointer",this.dragNodeComp=this.rendererRegistry.getRendererComponent("drag-node"),this.options.onDrop&&this.toDispose.push(this.flowDragService.onDrop(this.options.onDrop))}dispose(){this._dragger.dispose(),super.dispose()}render(){let t=this.dragNodeComp.renderer;return c.createPortal(g.createElement("div",{ref:this.containerRef,style:{position:"absolute",zIndex:99999,visibility:"hidden"},onMouseEnter:t=>t.stopPropagation()},g.createElement(t,{dragJSON:this.dragJSON,dragStart:this.dragStartEntity,dragNodes:this.dragEntities})),document.body)}constructor(){super(...arguments),this.disableDragScroll=!1,this.dragOffset={x:8,y:8},this.containerRef=g.createRef(),this.draggingNodeMask=document.createElement("div"),this._dragger=new l.s5({onDrag:t=>{this.handleMouseMove(t)},onDragEnd:()=>{this.handleMouseUp()},stopGlobalEventNames:["contextmenu"]})}};b([(0,d.f3)(a.pQ)],tn.prototype,"document",2),b([(0,d.f3)(a.eE)],tn.prototype,"flowDragService",2),b([(0,l.aI)(a.GA,a.eG)],tn.prototype,"transforms",2),b([(0,l.O0)(l.Zs)],tn.prototype,"editorStateConfig",2),b([(0,l.O0)(l.ER)],tn.prototype,"playgroundConfigEntity",2),b([(0,l.O0)(x)],tn.prototype,"flowDragConfigEntity",2),b([(0,l.O0)(a.y3)],tn.prototype,"flowRenderStateEntity",2),b([(0,l.O0)(N)],tn.prototype,"selectConfigEntity",2),b([(0,d.f3)(k)],tn.prototype,"rendererRegistry",2),tn=b([(0,d.b2)()],tn);var ts=class extends l.mh{onReady(){this.options.canSelect||(this.options.canSelect=t=>{let e=t.target;return e===this.pipelineNode||e===this.playgroundNode}),this.toDispose.pushAll([this.selectConfigEntity.onConfigChanged(()=>{this.selectionService.selection=this.selectConfigEntity.selectedNodes}),this.selectionService.onSelectionChanged(()=>{let t=this.selectionService.selection.filter(t=>t instanceof a.GA);this.selectConfigEntity.selectedNodes=t})]),this.listenPlaygroundEvent("mousedown",t=>{if(this.isEnabled()&&(!this.options.canSelect||this.options.canSelect(t,this.selectorBoxConfigEntity)))return this.editorStateConfig.getCurrentState()===l.yy.STATE_MOUSE_FRIENDLY_SELECT&&this.selectConfigEntity.clearSelectedNodes(),this.selectboxDragger.start(t.clientX,t.clientY,this.config),!0},l.nn.BASE_LAYER)}isEnabled(){let t=this.editorStateConfig.getCurrentState(),e=t===l.yy.STATE_MOUSE_FRIENDLY_SELECT;return!this.config.disabled&&!this.config.readonly&&(e&&this.editorStateConfig.isPressingShift||t===l.yy.STATE_SELECT)&&!this.selectorBoxConfigEntity.disabled}dispose(){this.selectorBox.dispose(),this.selectorBoxBlock.dispose(),super.dispose()}updateSelectorBox(t){let e=this.selectorBox.get(),i=this.selectorBoxBlock.get();!this.isEnabled()&&t.isMoving&&this.selectorBoxConfigEntity.collapse(),this.isEnabled()&&t.isMoving?(e.setStyle({display:"block",left:t.position.x,top:t.position.y,width:t.size.width,height:t.size.height}),i.setStyle({display:"block",left:t.position.x-10,top:t.position.y-10,width:t.size.width+20,height:t.size.height+20})):(e.setStyle({display:"none"}),i.setStyle({display:"none"}))}nodeSelectable(t,e){let i=t.getNodeMeta().selectable;return"function"==typeof i?i(t,e):i}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-selector-box-layer"),this.selectorBox=this.createDOMCache("gedit-selector-box"),this.selectorBoxBlock=this.createDOMCache("gedit-selector-box-block"),this.selectboxDragger=new l.s5({onDragStart:t=>{this.selectConfigEntity.clearSelectedNodes();let e=this.playgroundConfigEntity.getPosFromMouseEvent(t);this.transformVisibles=this.flowDocument.getRenderDatas(a.eG,!1).filter(t=>{let{entity:i}=t;return i.originParent?this.nodeSelectable(i,e)&&this.nodeSelectable(i.originParent,e):this.nodeSelectable(i,e)}),this.selectorBoxConfigEntity.setDragInfo(t),this.updateSelectorBox(this.selectorBoxConfigEntity)},onDrag:t=>{this.selectorBoxConfigEntity.setDragInfo(t),this.selectConfigEntity.selectFromBounds(this.selectorBoxConfigEntity.toRectangle(this.playgroundConfigEntity.finalScale),this.transformVisibles),this.updateSelectorBox(this.selectorBoxConfigEntity)},onDragEnd:t=>{this.selectorBoxConfigEntity.setDragInfo(t),this.transformVisibles.length=0,this.updateSelectorBox(this.selectorBoxConfigEntity)}})}};b([(0,d.f3)(a.pQ)],ts.prototype,"flowDocument",2),b([(0,d.f3)(l.Lk)],ts.prototype,"contextMenuService",2),b([(0,l.O0)(l.ER)],ts.prototype,"playgroundConfigEntity",2),b([(0,d.f3)(l.z2)],ts.prototype,"selectionService",2),b([(0,l.O0)(M)],ts.prototype,"selectorBoxConfigEntity",2),b([(0,l.O0)(N)],ts.prototype,"selectConfigEntity",2),b([(0,l.O0)(l.Zs)],ts.prototype,"editorStateConfig",2),ts=b([(0,d.b2)()],ts);var to=class extends l.mh{onReady(){this.node.style.zIndex="20";let{firstChild:t}=this.pipelineNode;void 0!==this.options.boundsPadding&&(this.flowSelectConfigEntity.boundsPadding=this.options.boundsPadding),this.options.backgroundClassName&&this.selectBoundsBackground.classList.add(this.options.backgroundClassName);let e=o.xF.createDivWithClass("gedit-playground-layer");e.appendChild(this.selectBoundsBackground),this.pipelineNode.insertBefore(e,t)}onZoom(t){this.node.style.transform=`scale(${t})`,this.selectBoundsBackground.parentElement.style.transform=`scale(${t})`}onViewportChange(){this.render()}isEnabled(){return this.editorStateConfig.getCurrentState()===l.yy.STATE_SELECT}render(){var t;let{ignoreOneSelect:e,ignoreChildrenLength:i,SelectorBoxPopover:r,disableBackground:n,CustomBoundsRenderer:s}=this.options,a=this.flowSelectConfigEntity.getSelectedBounds(),l=this.flowSelectConfigEntity.selectedNodes,h=this.selectBoundsBackground,d=!this.selectorBoxConfigEntity.isStart;if(0===a.width||0===a.height||e&&1===l.length&&(i||l[0].childrenLength<=1))return o.xF.setStyle(h,{display:"none"}),g.createElement(g.Fragment,null);if(s)return g.createElement(s,{bounds:a,config:this.config,flowSelectConfig:this.flowSelectConfigEntity,commandRegistry:this.commandRegistry});let u={display:"block",left:a.left,top:a.top,width:a.width,height:a.height};n||o.xF.setStyle(h,u);let c="gedit-selector-bounds-foreground";this.options.foregroundClassName&&(c+=" "+this.options.foregroundClassName);let p=r||(null==(t=this.rendererRegistry.tryToGetRendererComponent("selector-box-popover"))?void 0:t.renderer);return d&&p?g.createElement(p,{bounds:a,config:this.config,flowSelectConfig:this.flowSelectConfigEntity,commandRegistry:this.commandRegistry},g.createElement("div",{className:c,style:u})):g.createElement("div",{className:c,style:u})}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-selector-bounds-layer"),this.selectBoundsBackground=o.xF.createDivWithClass("gedit-selector-bounds-background")}};b([(0,d.f3)(k)],to.prototype,"rendererRegistry",2),b([(0,d.f3)(l.Ho)],to.prototype,"commandRegistry",2),b([(0,l.O0)(N)],to.prototype,"flowSelectConfigEntity",2),b([(0,l.O0)(l.Zs)],to.prototype,"editorStateConfig",2),b([(0,l.O0)(M)],to.prototype,"selectorBoxConfigEntity",2),b([(0,l.aI)(a.GA,a.Lz)],to.prototype,"renderStates",2),b([(0,l.aI)(a.GA,a.eG)],to.prototype,"_transforms",2),to=b([(0,d.b2)()],to);var ta=class extends l.mh{isEnabled(){let t=this.editorStateConfig.getCurrentState();return!this.config.disabled&&!this.config.readonly&&t===l.yy.STATE_SELECT&&!this.selectorBoxConfigEntity.disabled}onReady(){this.node.style.zIndex="30",this.node.style.display="block",this.toDispose.pushAll([this.listenPlaygroundEvent("contextmenu",t=>{var e;if(!this.isEnabled())return;this.contextMenuService.rightPanelVisible=!0;let i=this.flowSelectConfigEntity.getSelectedBounds();if(0===i.width||0===i.height)return;t.stopPropagation(),t.preventDefault(),null==(e=this.nodeRef.current)||e.setVisible(!0);let r=this.playgroundConfigEntity.getClientBounds(),n=t.clientX-(this.pipelineNode.offsetLeft||0)-r.x,s=t.clientY-(this.pipelineNode.offsetTop||0)-r.y;this.node.style.left=`${n}px`,this.node.style.top=`${s}px`},l.nn.BASE_LAYER),this.listenPlaygroundEvent("mousedown",()=>{var t;null==(t=this.nodeRef.current)||t.setVisible(!1),this.contextMenuService.rightPanelVisible=!1})])}onScroll(){var t;null==(t=this.nodeRef.current)||t.setVisible(!1)}onZoom(){var t;null==(t=this.nodeRef.current)||t.setVisible(!1)}dispose(){super.dispose()}renderCommandMenus(){return this.commandRegistry.commands.filter(t=>"SELECTOR_BOX"===t.category).map(t=>{var e;let i=null==(e=this.rendererRegistry.getRendererComponent(t.icon||t.id))?void 0:e.renderer;return g.createElement(i,{key:t.id,command:t,isContextMenu:!0,disabled:!this.commandRegistry.isEnabled(t.id),onClick:e=>this.commandRegistry.executeCommand(t.id,e)})}).filter(t=>t)}render(){let t=this.rendererRegistry.getRendererComponent("context-menu-popover").renderer;return g.createElement(t,{ref:this.nodeRef,content:this.renderCommandMenus()})}constructor(){super(...arguments),this.node=o.xF.createDivWithClass("gedit-context-menu-layer"),this.nodeRef=g.createRef()}};b([(0,d.f3)(l.Ho)],ta.prototype,"commandRegistry",2),b([(0,d.f3)(k)],ta.prototype,"rendererRegistry",2),b([(0,d.f3)(l.Lk)],ta.prototype,"contextMenuService",2),b([(0,l.O0)(N)],ta.prototype,"flowSelectConfigEntity",2),b([(0,d.f3)(l.z2)],ta.prototype,"selectionService",2),b([(0,l.O0)(l.ER)],ta.prototype,"playgroundConfigEntity",2),b([(0,l.O0)(l.Zs)],ta.prototype,"editorStateConfig",2),b([(0,l.O0)(M)],ta.prototype,"selectorBoxConfigEntity",2),ta=b([(0,d.b2)()],ta);var tl=class extends l.mh{getInitScroll(){return this.document.layout.getInitScroll(this.pipelineNode.getBoundingClientRect())}onReady(){let t=()=>this.getInitScroll();this.config.updateConfig(t()),this.config.addScrollLimit(e=>(function(t,e,i,r){t={...t};let n=i.config,s={scrollX:n.scrollX,scrollY:n.scrollY};if(0===e.length||0===n.width||0===n.height)return t;let a=Q(t,i);if(!e.find(t=>o.Ae.isViewportVisible(t,a))){let t=Q(s,i);return e.find(e=>o.Ae.isViewportVisible(e,t))?s:r()}return t})(e,[this.document.root.getData(a.eG).bounds],this.config,t))}};b([(0,d.f3)(a.pQ)],tl.prototype,"document",2),tl=b([(0,d.b2)()],tl);var th=new d.nZ(t=>{t(k).toSelf().inSingletonScope(),t(I).toSelf().inSingletonScope()})},950454:function(t,e,i){i.d(e,{JTr:()=>a.JT,f3M:()=>u.f3,qRT:()=>c.qR,QUv:()=>h.QU,_J4:()=>b,PiV:()=>d.Pi,D9C:()=>h.D9,fin:()=>_,qmw:()=>c.qm,Emw:()=>d.Em,xFV:()=>a.xF,GAy:()=>h.GA,kmj:()=>l.km,d3V:()=>l.d3,Fu1:()=>ty,zEJ:()=>o.zE,Rf1:()=>d.Rf,C8:()=>h.C8,VOn:()=>l.VO,i2z:()=>c.i2,OTb:()=>h.OT,XsM:()=>h.Xs,z2R:()=>l.z2,SyX:()=>h.Sy,yyW:()=>l.yy,HoL:()=>l.Ho,ERL:()=>l.ER,Odm:()=>k.Od,nYJ:()=>n,esp:()=>tn.es,LzJ:()=>h.Lz,cL:()=>T.cL,_cB:()=>U,XQj:()=>l.XQ,AeJ:()=>a.Ae,F26:()=>k.F2,cc3:()=>h.cc,mYg:()=>l.mY,v2K:()=>l.v2,gw0:()=>a.gw,u$R:()=>M,b2C:()=>u.b2,Dcz:()=>l.Dc,k6H:()=>N,Zn3:()=>l.Zn,FwO:()=>l.Fw,YvH:()=>l.Yv,R6T:()=>l.iX,kDE:()=>d.kD,pQ4:()=>h.pQ,EU3:()=>d.EU,VDr:()=>l.VD,h3M:()=>h.h3,Aub:()=>D,eGM:()=>h.eG,XDS:()=>d.XD,gNt:()=>k.gN,V7e:()=>d.V7,loc:()=>E,rQR:()=>l.rQ,C$T:()=>k.C$,THq:()=>o.TH,$eD:()=>c.$e,KUq:()=>l.KU,rVg:()=>c.rV,Psq:()=>L.Ps,oci:()=>R.o,W2M:()=>H,G2Z:()=>l.G2,CR5:()=>o.CR,Q5$:()=>a.Q5,lVg:()=>d.lV,M1y:()=>l.M1,qoQ:()=>k.qo,UJL:()=>l.UJ,LF0:()=>c.LF,CMu:()=>o.CM,JAk:()=>a.JA,l09:()=>k.l0,W6u:()=>l.W6,XPE:()=>h.XP,K46:()=>a.K4,GwP:()=>c.Gw,qq0:()=>d.qq,oC4:()=>d.oC,mh4:()=>l.mh,Ys9:()=>I}),i(543789);var r,n,s,o=i(928079),a=i(832176),l=i(893740),h=i(579962),d=i(438024),u=i(9163),c=i(319428),g=i(336330),p=Object.defineProperty,f=Object.getOwnPropertyDescriptor,y=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?f(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&p(e,i,s),s},m=(t,e)=>(i,r)=>e(i,r,t),E=((r=E||{}).public="public",r.private="private",r),b=class extends l.RD{get private(){return this._private}get public(){return this._public}setVar(t,e){if("string"==typeof t&&void 0!==e)return this.public.ast.set(t,e);if("object"==typeof t&&void 0===e)return this.public.ast.set("outputs",t);throw Error("Invalid arguments")}getVar(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return this.public.ast.get(t)}clearVar(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return this.public.ast.remove(t)}setPrivateVar(t,e){if("string"==typeof t&&void 0!==e)return this.initPrivate().ast.set(t,e);if("object"==typeof t&&void 0===e)return this.initPrivate().ast.set("outputs",t);throw Error("Invalid arguments")}getPrivateVar(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return null==(t=this.private)?void 0:t.ast.get(e)}clearPrivateVar(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return null==(t=this.private)?void 0:t.ast.remove(e)}get allScopes(){let t=[];return this._public&&t.push(this._public),this._private&&t.push(this._private),t}getDefaultData(){return{}}initPrivate(){return this._private||(this._private=this.variableEngine.createScope(`${this.entity.id}_private`,{node:this.entity,type:"private"}),this.variableEngine.chain.refreshAllChange(),this.toDispose.push(this._private)),this._private}getByKeyPath(t){return this.public.available.getByKeyPath(t)}getByKeyPathInPrivate(t){var e;return null==(e=this.private)?void 0:e.available.getByKeyPath(t)}constructor(t,e){super(t),this.opts=e;let{variableEngine:i}=e||{};this.variableEngine=i,this._public=this.variableEngine.createScope(this.entity.id,{node:this.entity,type:"public"}),this.toDispose.push(this._public)}};b.type="FlowNodeVariableData";var C=Symbol("VariableChainConfig"),S=(t,e)=>t,D=class{hasTransformer(t){return this.transformerMap.has(t)}registerTransformer(t,e){this.transformerMap.set(t,e)}transformDeps(t,e){let{scope:i}=e;return Array.from(this.transformerMap.values()).reduce((t,e)=>e.transformDeps?t=e.transformDeps(t,{scope:i,document:this.document,variableEngine:this.variableEngine}):t,t)}transformCovers(t,e){let{scope:i}=e;return Array.from(this.transformerMap.values()).reduce((t,e)=>e.transformCovers?t=e.transformCovers(t,{scope:i,document:this.document,variableEngine:this.variableEngine}):t,t)}constructor(t){var e,i;this.configs=t,this.transformerMap=new Map,((null==(e=this.configs)?void 0:e.transformDeps)||(null==(i=this.configs)?void 0:i.transformCovers))&&this.transformerMap.set("VARIABLE_LAYOUT_CONFIG",{transformDeps:this.configs.transformDeps||S,transformCovers:this.configs.transformCovers||S})}};y([(0,l.yT)(h.pQ)],D.prototype,"document",2),y([(0,l.yT)(c.i2)],D.prototype,"variableEngine",2),D=y([(0,u.b2)(),m(0,(0,u.jt)()),m(0,(0,u.f3)(C))],D);var _=class extends c.sX{static is(t){return t.id===_.ID}};_.ID=Symbol("GlobalScope"),_=y([(0,u.b2)()],_);var w=class extends c.$s{get tree(){return this.flowDocument.originTree}onInit(){this.toDispose.pushAll([this.entityManager.onEntityDataChange(t=>{let{entityDataType:e}=t;e===g.Z1.type&&this.refreshAllChange()}),this.tree.onTreeChange(()=>{this.refreshAllChange()})])}getAllInputLayerNodes(t){let e=this.getNodeParent(t),i=new Set,r=[t];for(;r.length;){var n;((null==(n=r.shift().lines)?void 0:n.inputNodes)||[]).forEach(t=>{this.getNodeParent(t)===e&&(i.has(t)||(r.push(t),i.add(t)))})}return Array.from(i).reverse()}getAllOutputLayerNodes(t){var e;let i=this.getNodeParent(t);return((null==(e=t.lines)?void 0:e.allOutputNodes)||[]).filter(t=>this.getNodeParent(t)===i)}getDeps(t){let{node:e}=t.meta||{};if(!e)return this.transformService.transformDeps([],{scope:t});let i=[],r=e;for(;r;){let e=r.getData(b);(null==e?void 0:e.private)&&t!==e.private&&i.unshift(e.private);let n=this.getAllInputLayerNodes(r);i.unshift(...n.map(t=>[t.getData(b).public,...this.getAllPublicChildScopes(t)]).flat().filter(Boolean)),r=this.getNodeParent(r)}let n=this.variableEngine.getScopeById(_.ID);n&&i.unshift(n);let s=Array.from(new Set(i));return this.transformService.transformDeps(s,{scope:t})}getCovers(t){if(_.is(t)){let e=this.variableEngine.getAllScopes({sort:!0}).filter(t=>!_.is(t));return this.transformService.transformCovers(e,{scope:t})}let{node:e}=t.meta||{};if(!e)return this.transformService.transformCovers([],{scope:t});let i="private"===t.meta.type,r=[];if(i)r.push(...this.getNodeChildren(e));else{r.push(...this.getAllOutputLayerNodes(e)||[]);let t=this.getNodeParent(e);for(;t&&!this.isNodeChildrenPrivate(t);)r.push(...this.getAllOutputLayerNodes(t)),t=this.getNodeParent(t)}let n=[];for(;r.length;){let t=r.shift(),e=t.getData(b);n.push(...e.allScopes);let i=t&&this.getNodeChildren(t);(null==i?void 0:i.length)&&r.push(...i)}let s=e.getData(b);i&&s.public&&n.push(s.public);let o=Array.from(new Set(n));return this.transformService.transformCovers(o,{scope:t})}getNodeChildren(t){var e,i,r,n;if(null==(e=this.configs)?void 0:e.getNodeChildren)return null==(r=(n=this.configs).getNodeChildren)?void 0:r.call(n,t);let s=t.getNodeMeta(),o=null==(i=s.subCanvas)?void 0:i.call(s,t);if(o)if(o.isCanvas)return[];else return o.canvasNode.collapsedChildren;return this.tree.getChildren(t)}getAllPublicChildScopes(t){return this.isNodeChildrenPrivate(t)?[]:this.getNodeChildren(t).map(t=>[t.getData(b).public,...this.getAllPublicChildScopes(t)]).flat()}getNodeParent(t){var e,i;if(null==(e=this.configs)?void 0:e.getNodeParent)return this.configs.getNodeParent(t);let r=t.document.originTree.getParent(t);for(;(null==r?void 0:r.flowNodeType)===h.Sy.GROUP;)r=r.parent;if(!r)return r;let n=r.getNodeMeta(),s=null==(i=n.subCanvas)?void 0:i.call(n,r);return(null==s?void 0:s.isCanvas)?s.parentNode:r}isNodeChildrenPrivate(t){var e,i;return(null==(e=this.configs)?void 0:e.isNodeChildrenPrivate)?!!t&&(null==(i=this.configs)?void 0:i.isNodeChildrenPrivate(t)):!(null==t?void 0:t.id.startsWith("$"))&&(null==t?void 0:t.flowNodeType)!==h.Sy.GROUP}sortAll(){return console.warn("FreeLayoutScopeChain.sortAll is not implemented"),[]}};y([(0,u.f3)(l.v2)],w.prototype,"entityManager",2),y([(0,u.f3)(h.pQ)],w.prototype,"flowDocument",2),y([(0,u.jt)(),(0,u.f3)(C)],w.prototype,"configs",2),y([(0,u.f3)(D)],w.prototype,"transformService",2),y([(0,u.zY)()],w.prototype,"onInit",1);var x=class extends c.$s{bindTree(t){this.tree=t}getDeps(t){if(!this.tree)return this.transformService.transformDeps([],{scope:t});let e=t.meta.node;if(!e)return this.transformService.transformDeps([],{scope:t});let i=[],r=e;for(;r;){let{parent:n,pre:s}=this.tree.getInfo(r),o=this.getVariableData(r);if(r===e?"public"===t.meta.type&&(null==o?void 0:o.private)&&i.unshift(o.private):this.hasChildren(r)&&!this.isNodeChildrenPrivate(r)&&i.unshift(...this.getAllSortedChildScope(r,{ignoreNodeChildrenPrivate:!0})),o&&r!==e&&i.unshift(o.public),s){r=s;continue}if(n){let t=n,e=this.tree.getPre(t);for(;t;){let r=this.getVariableData(t);if(r&&i.unshift(...r.allScopes),e)break;e=(t=this.tree.getParent(t))?this.tree.getPre(t):void 0}r=e;continue}r=void 0}let n=this.variableEngine.getScopeById(_.ID);return n&&i.unshift(n),this.transformService.transformDeps(i,{scope:t})}getCovers(t){if(!this.tree)return this.transformService.transformCovers([],{scope:t});if(_.is(t)){let e=this.variableEngine.getAllScopes({sort:!0}).filter(t=>!_.is(t));return this.transformService.transformCovers(e,{scope:t})}let e=t.meta.node;if(!e)return this.transformService.transformCovers([],{scope:t});let i=[];if("private"===t.meta.type)return i.push(...this.getAllSortedChildScope(e,{addNodePrivateScope:!0}).filter(e=>e!==t)),this.transformService.transformCovers(i,{scope:t});let r=e;for(;r;){let{next:n,parent:s}=this.tree.getInfo(r),o=this.getVariableData(r);if(r!==e&&(this.hasChildren(r)?i.push(...this.getAllSortedChildScope(r,{addNodePrivateScope:!0})):o&&i.push(...o.allScopes)),n){r=n;continue}if(s){let e=s,n=this.tree.getNext(e);for(;e;){if(this.isNodeChildrenPrivate(e))return this.transformService.transformCovers(i,{scope:t});if(n)break;n=(e=this.tree.getParent(e))?this.tree.getNext(e):void 0}if(!n&&e)break;r=n;continue}r=void 0}return this.transformService.transformCovers(i,{scope:t})}sortAll(){let t=this.flowDocument.getAllNodes().find(t=>t.isStart);if(!t)return[];let e=t.getData(b).public,i=this.getDeps(e),r=this.getCovers(e).filter(t=>!i.includes(t)&&t!==e);return[...i,e,...r]}getVariableData(t){if("virtualNode"!==t.flowNodeType&&!t.id.startsWith("$"))return t.getData(b)}isNodeChildrenPrivate(t){var e,i;return(null==(e=this.configs)?void 0:e.isNodeChildrenPrivate)?!!t&&(null==(i=this.configs)?void 0:i.isNodeChildrenPrivate(t)):!(null==t?void 0:t.id.startsWith("$"))&&this.hasChildren(t)}hasChildren(t){return!!(this.tree&&t&&this.tree.getChildren(t).length>0)}getAllSortedChildScope(t){var e;let{ignoreNodeChildrenPrivate:i,addNodePrivateScope:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[],s=this.getVariableData(t);return s&&n.push(s.public),i&&this.isNodeChildrenPrivate(t)||(r&&(null==s?void 0:s.private)&&n.push(s.private),n.push(...((null==(e=this.tree)?void 0:e.getChildren(t))||[]).map(t=>this.getAllSortedChildScope(t,{ignoreNodeChildrenPrivate:i,addNodePrivateScope:r})).flat())),n}constructor(t,e){super(),this.flowDocument=t,this.configs=e,this.bindTree(t.originTree),this.toDispose.push(t.originTree.onTreeChange(()=>{this.refreshAllChange()}))}};function N(t){return t.getData(b).public}function M(t){return t.getData(b).initPrivate()}y([(0,u.f3)(D)],x.prototype,"transformService",2),x=y([m(0,(0,u.f3)(h.pQ)),m(1,(0,u.jt)()),m(1,(0,u.f3)(C))],x);var I=(0,l.M1)({onBind(t,e){let{bind:i}=t,{layout:r,layoutConfig:n,chainConfig:s}=e;i(D).toSelf().inSingletonScope(),"free"===r&&i(c.$s).to(w).inSingletonScope(),"fixed"===r&&i(c.$s).to(x).inSingletonScope(),s?i(C).toConstantValue(s||{}):n&&(console.warn("Layout Config deprecated, use chainConfig instead"),i(C).toConstantValue(n||{})),i(_).toDynamicValue(t=>{let e=t.container.get(c.i2),i=e.getScopeById(_.ID);return i||(i=e.createScope(_.ID,{},{ScopeConstructor:_}),e.chain.refreshAllChange()),i})},onInit(t,e){let{extendASTNodes:i}=e||{},r=t.get(c.i2),n=t.get(c.OI),s=t.get(l.v2),o=t.get(h.pQ);(i||[]).forEach(e=>{if(Array.isArray(e)){let[i,r]=e;n.registerAST(i,r?()=>r(t):void 0);return}n.registerAST(e)}),s.registerEntityData(b,()=>({variableEngine:r})),o.registerNodeDatas(b)},containerModules:[c.gJ]}),T=i(148168),L=i(57064),P=(0,l.M1)({onInit(t,e){t.get(h.pQ).registerNodeDatas(...(0,L.Co)());let i=t=>new o.wL(t);if(t.get(l.v2).registerEntityData(L.Ps,()=>({formModelFactory:i})),!e.materials)return;let r=t.get(L.Bl),n=t.get(L.yf);if(!r||!n)throw Error("NodeCorePlugin Error: nodeManager or formManager not found");!function(t){let{nodeManager:e,formManager:i,material:r}=t,{setters:n=[],decorators:s=[],effects:o=[],validators:a=[],nodeErrorRender:l,nodePlaceholderRender:h}=r;l&&(0,L.kq)(e,l),h&&(0,L.FC)(e,h),n.forEach(t=>{i.registerAbilityExtension(L.Bw.type,t)}),s.forEach(t=>{i.registerAbilityExtension(L.GH.type,t)}),o.forEach(t=>{i.registerAbilityExtension(L.ps.type,t)}),a.forEach(t=>{i.registerAbilityExtension(L.Us.type,t)})}({nodeManager:r,formManager:n,material:e.materials})},onDispose(t){var e;null==(e=t.get(L.yf))||e.dispose()},containerModules:(0,L.pm)()}),R=i(27430),A=(0,l.M1)({onInit:(t,e)=>{e.onLanguageChange&&t.playground.toDispose.push(R.o.onLanguageChange(e.onLanguageChange)),e.languages&&(Array.isArray(e.languages)?R.o.addLanguages(e.languages):R.o.addLanguages(Object.keys(e.languages).map(t=>({languageId:t,contents:e.languages[t]})))),(e.locale||e.localLanguage)&&(R.o.locale=e.locale||e.localLanguage)}});i(875787);var k=i(755395),O=Object.defineProperty,V=Object.getOwnPropertyDescriptor,B=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?V(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&O(e,i,s),s},F=class{init(){this.devTools&&(this.devTools.init(this.getState()),this.devTools.subscribe(t=>{var e;(null==t||null==(e=t.payload)?void 0:e.type)==="COMMIT"&&this.devTools.init(this.getState())}),this.onInit())}send(t,e){this.devTools&&this.devTools.send(t,e||this.getState())}constructor(){var t;this.devTools=null==(t=window.__REDUX_DEVTOOLS_EXTENSION__)?void 0:t.connect({name:this.getName()})}};B([(0,u.zY)()],F.prototype,"init",1),F=B([(0,u.b2)()],F);var z=class extends F{getName(){return"@flowgram.ai/EntityManager"}getState(){return this.entityManager.storeState({configOnly:!1})}onInit(){this.entityManager.onEntityLifeCycleChange(t=>{this.send(`${t.type}/${t.entity.type}/${t.entity.id}`)})}};B([(0,u.f3)(l.v2)],z.prototype,"entityManager",2),z=B([(0,u.b2)()],z);var G=class extends F{getName(){return"@flowgram.ai/VariableEngine"}getState(){return{scopes:this.scopes,variables:this.variableEngine.globalVariableTable.variables}}getScopeState(t){return{ast:null==t?void 0:t.ast.toJSON(),output:t.output.variables,available:t.available.variables}}onInit(){this.variableEngine.onScopeChange(t=>{let{scope:e,type:i}=t;"delete"===i?delete this.scopes[String(e.id)]:this.scopes={...this.scopes,[e.id]:this.getScopeState(e)},this.send(`${i}/${String(e.id)}`)})}constructor(){super(...arguments),this.scopes={}}};B([(0,u.f3)(c.i2)],G.prototype,"variableEngine",2),G=B([(0,u.b2)()],G);var $=(0,l.M1)({onBind(t,e){let{bind:i}=t,{enable:r}=e;r&&(i(z).toSelf().inSingletonScope(),i(G).toSelf().inSingletonScope())},onInit(t,e){let{enable:i,ecs:r=!0,variable:n=!1}=e;i&&(r&&t.get(z),n&&t.get(G))}}),Y=i(908600),X=t=>{let{children:e}=t,i=(0,l.km)(),r=(0,Y.useMemo)(()=>i.getData(b).public,[i]);return Y.createElement(c.$Y,{scope:r},e)},j=t=>e=>Y.createElement(X,null,Y.createElement(t,{...e})),J=(0,l.M1)({onInit(t){t.get(L.Bl).registerNodeRenderHoc(j)}}),U=t=>{let{children:e}=t,i=(0,l.km)(),r=(0,Y.useMemo)(()=>{let t=i.getData(b);return t.private||t.initPrivate(),t.private},[i]);return Y.createElement(c.$Y,{scope:r},e)};function H(t){let e=e=>{let i=e.getData(b);return t.private||"private"===t.scope?i.initPrivate():i.public},i=i=>{let{value:r,name:n,context:s,formValues:o,form:a}=i;if(!s)return;let{node:l}=s,h=e(l),d=t.parse(r,{node:l,scope:h,options:t,name:n,formValues:o,form:a});h.ast.set(t.namespace||n||"",{kind:c.Hx.VariableDeclarationList,declarations:Array.isArray(d)?d:[d]})};return[{event:o.zE.onValueInit,effect:r=>{var n;let{context:s}=r,o=e(s.node),a=null==(n=t.onInit)?void 0:n.call(t,{node:s.node,scope:o,options:t,name:r.name,formValues:r.formValues,form:r.form});return i(r),()=>{null==a||a.dispose()}}},{event:o.zE.onValueChange,effect:t=>{i(t)}}]}(0,o.CR)({name:"VariableProviderPlugin",onInit:(t,e)=>{},onSetupFormMeta(t){let{mergeEffect:e}=t;e({arr:[{event:o.zE.onValueInitOrChange,effect:()=>{}}]})},onDispose:(t,e)=>{}});var W=(0,l.M1)({onInit(t,e){let i=t.get(d.Rf);i.registerReactComponent(d.kD.NODE_RENDER,e.renderDefaultNode||(()=>null)),e.renderTexts&&i.registerText(e.renderTexts),e.components&&Object.keys(e.components).forEach(t=>i.registerReactComponent(t,e.components[t])),e.renderNodes&&Object.keys(e.renderNodes).forEach(t=>i.registerReactComponent(t,e.renderNodes[t]))}}),K=i(66298),Z=i(969134),Q=Object.defineProperty,q=Object.getOwnPropertyDescriptor;function tt(t){var e;if(!t)return;let i=null==t||null==(e=t.getData(L.Ps))?void 0:e.getFormModel();if(i&&(0,o.TH)(i))return i}var te=[{type:"changeFormValues",inverse:t=>({...t,value:{...t.value,value:t.value.oldValue,oldValue:t.value.value}}),apply:(t,e)=>{let{value:{value:i,path:r,id:n}}=t,s=tt(e.get(h.pQ).getNode(n));s&&(r?s.setValueIn(r,i):s.updateFormValues(i))},shouldMerge:function(t,e,i){if(!e)return!1;if(Date.now()-i.getTimestamp()<500){var r,n,s,o,a,l;return t.type!==e.type||(null==(r=t.value)?void 0:r.id)!==(null==(n=e.value)?void 0:n.id)||(null==(s=t.value)?void 0:s.path)!==(null==(o=e.value)?void 0:o.path)||{type:t.type,value:{...t.value,value:null==(a=t.value)?void 0:a.value,oldValue:null==(l=e.value)?void 0:l.oldValue}}}return!1}}],ti=class{registerOperationMeta(t){te.forEach(e=>{t.registerOperationMeta(e)})}};ti=((t,e,i,r)=>{for(var n,s=r>1?void 0:r?q(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&Q(e,i,s),s})([(0,u.b2)()],ti);var tr=(0,l.M1)({onBind:t=>{let{bind:e}=t;(0,l.KV)(e,ti,[K.FU])},onInit:(t,e)=>{let i=t.get(h.pQ),r=t.get(K.qp);i.onNodeCreate(t=>{let{node:e}=t,i=tt(e);i&&i.onFormValuesChange(t=>{r.pushOperation({type:"changeFormValues",value:{id:e.id,path:t.name,value:t.name?(0,Z.Z)(t.values,t.name):t.values,oldValue:t.name?(0,Z.Z)(t.prevValues,t.name):t.prevValues}},{noApply:!0})})})},containerModules:[K.Xn]}),tn=i(309844),ts=Object.defineProperty,to=Object.getOwnPropertyDescriptor,ta=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?to(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&ts(e,i,s),s};(n||(n={})).DEFAULT={background:{}};var tl="flowide-highlight",th=`
@keyframes flowide-fade {
  from {
   opacity: 1.0;
  }
  to {
    opacity: 0;
  }
}
@-webkit-keyframes flowide-fade {
  from {
   opacity: 1.0;
  }
  to {
    opacity: 0;
  }
}
.${tl} {
  background-color: rgba(238, 245, 40, 0.5);
  animation: flowide-fade 2s 1 forwards;
  -webkit-animation: flowide-fade 2s 1 forwards;
}
`,td=class{highlightNodeFormItem(t,e){this.previousOverlay=function(t,e){let i=t.formModel.flowNodeEntity.getData(h.Lz).node,r=t.domRef.current;if(!r)return;let n=document.createElement("div"),{padding:s=0,overlayClassName:o}=e||{};n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.zIndex="9999",i.appendChild(n);let a=i.getBoundingClientRect(),l=r.getBoundingClientRect();return n.style.top=l.top-a.top-s+"px",n.style.left=l.left-a.left-s+"px",n.style.width=l.width+2*s+"px",n.style.height=l.height+2*s+"px",n.className=o||tl,setTimeout(()=>{n.remove()},2e3),n}(t,e)}focusNodeFormItem(t,e){let i=t.formModel.flowNodeEntity,{canvas:r={},highlight:n}=e||{};this.previousOverlay&&(this.previousOverlay.remove(),this.previousOverlay=void 0);let s=this.playground.scrollToView({entities:[i],scrollToCenter:!0,...r}).then(()=>{t&&n&&this.currentPromise===s&&this.highlightNodeFormItem(t,"boolean"==typeof n?{}:n)});return this.currentPromise=s,this.currentPromise}};ta([(0,u.f3)(l.XQ)],td.prototype,"playground",2),td=ta([(0,u.b2)()],td);var tu=class{};ta([(0,u.f3)(td)],tu.prototype,"nodeFocusService",2),tu=ta([(0,u.b2)()],tu);var tc=(0,l.M1)({onInit(){s||((s=document.createElement("style")).innerHTML=th,document.head.appendChild(s))},onDispose(){null==s||s.remove(),s=void 0}}),tg=(0,l.M1)({onBind(t){let{bind:e}=t;e(td).toSelf().inSingletonScope(),e(tu).toSelf().inSingletonScope()}}),tp=class{focusNodeFormItem(t,e){this.nodeClient.nodeFocusService.focusNodeFormItem(t,e)}focusNode(t,e){this.playground.scrollToView({entities:[t],...e})}};ta([(0,u.f3)(tu)],tp.prototype,"nodeClient",2),ta([(0,u.f3)(l.XQ)],tp.prototype,"playground",2),tp=ta([(0,u.b2)()],tp);var tf=(0,l.M1)({onBind(t){let{bind:e}=t;e(tp).toSelf().inSingletonScope()}});function ty(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return i=>{var r,s,a,u;(t={...n.DEFAULT,...t}).i18n&&e.push(A(t.i18n)),e.push(tc({}),tg({}),tf({})),(null==(r=t.reduxDevTool)?void 0:r.enable)&&e.push($(t.reduxDevTool));let c=[h.d1,d.qf];return e.push(W(t.materials||{})),t.nodeEngine&&!1!==t.nodeEngine.enable&&(e.push(P({materials:t.nodeEngine.materials})),(null==(s=t.variableEngine)?void 0:s.enable)&&e.push(J({})),(null==(a=t.history)?void 0:a.enable)&&(null==(u=t.history)?void 0:u.enableChangeNode)!==!1&&e.push(tr({}))),e.push((0,l.d3)({onInit:e=>{t.nodeRegistries&&e.document.registerFlowNodes(...t.nodeRegistries),t.constants&&(e.document.options.constants=t.constants),t.getNodeDefaultRegistry&&(e.document.options.getNodeDefaultRegistry=t.getNodeDefaultRegistry),e.document.options.preNodeCreate=e=>{if(t.nodeEngine&&!1!==t.nodeEngine.enable){let t;Object.defineProperty(e,"form",{get:()=>t||(t=(0,o.CM)(e))})}if(t.variableEngine&&!1!==t.variableEngine.enable){let t,i;Object.defineProperty(e,"scope",{get:()=>t||(t=N(e))}),Object.defineProperty(e,"privateScope",{get:()=>i||(i=M(e))})}},e.get(d.Rf).init()},onReady(e){t.initialData&&e.document.fromJSON(t.initialData),t.readonly&&(e.playground.config.readonly=t.readonly),e.document.load().then(()=>{t.onLoad&&t.onLoad(e)})},onDispose(t){t.document.dispose()},containerModules:c})),e}}},309844:function(t,e,i){i.d(e,{Dc:()=>n.Dc,RE:()=>p,Wi:()=>n.Wi,er:()=>u,es:()=>c,mY:()=>n.mY,pk:()=>f}),i(543789);var r=i(832176),n=i(893740),s=i(908600),o=i(148168),a=i(569517),l=i(9163),h=Object.defineProperty,d=Object.getOwnPropertyDescriptor;function u(t){let{maxZoom:e,minZoom:i}=t||{},o=(0,n.Dc)(),a=(0,n.bP)(n.Zs,!0),[l,h]=(0,s.useState)(1),d=(0,s.useCallback)(t=>{o.config.zoomout(t)},[o]),u=(0,s.useCallback)(t=>{o.config.zoomin(t)},[o]),c=(0,s.useCallback)((t,e,i)=>{o.config.updateZoom(t,e,i)},[o]),g=(0,s.useCallback)(()=>{a.isMouseFriendlyMode()?a.changeState(n.yy.STATE_SELECT.id):a.changeState(n.yy.STATE_MOUSE_FRIENDLY_SELECT.id)},[a]);return(0,s.useEffect)(()=>{let t=new r.K4;return t.push(o.onZoom(t=>h(t))),()=>t.dispose()},[o]),(0,s.useEffect)(()=>{let t=o.config.config;o.config.updateConfig({maxZoom:void 0!==e?e:t.maxZoom,minZoom:void 0!==i?i:t.minZoom})},[o,e,i]),{zoomin:u,zoomout:d,updateZoom:c,zoom:l,interactiveType:a.isMouseFriendlyMode()?"MOUSE":"PAD",toggleIneractiveType:g}}function c(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return i=>{if(e=e.slice(),t.background||void 0===t.background){let i="object"==typeof t.background?t.background:{};e.push((0,a.bz)(i))}return t.shortcuts&&e.push((0,o.cL)({registerShortcuts:e=>t.shortcuts(e,i)})),t.plugins&&e.push(...t.plugins(i)),e.push((0,n.d3)({onBind:e=>{var i;null==(i=t.onBind)||i.call(t,e)},onInit:e=>{let i=e.get(n.W4);t.playground&&(void 0!==t.playground.autoFocus&&(i.autoFocus=t.playground.autoFocus),void 0!==t.playground.autoResize&&(i.autoResize=t.playground.autoResize)),i.autoFocus=!1,e.playground.registerLayer(n.wY,t.playground),t.layers&&e.playground.registerLayers(...t.layers),t.onInit&&t.onInit(e)},onReady(e){t.onReady&&t.onReady(e)},onAllLayersRendered(){t.onAllLayersRendered&&t.onAllLayersRendered(i)},onDispose(){t.onDispose&&t.onDispose(i)},containerModules:t.containerModules||[]})),e}}var g=class extends n.mh{onZoom(t){this.node.style.transform=`scale(${t})`}onReady(){this.node.style.left="0px",this.node.style.top="0px"}updateOptions(t){this.options=t,this.render()}render(){return s.createElement("div",{className:this.options.className,style:{position:"absolute",...this.options.style}},this.options.children)}constructor(){super(...arguments),this.node=r.xF.createDivWithClass("gedit-playground-layer gedit-playground-content-layer")}};g.type="PlaygroundContentLayer",g=((t,e,i,r)=>{for(var n,s=r>1?void 0:r?d(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&h(e,i,s),s})([(0,l.b2)()],g);var p=(0,s.forwardRef)(function(t,e){let{parentContainer:i,children:r,...o}=t,a=(0,s.useMemo)(()=>(0,n.d3)({onInit(t){t.playground.registerLayer(g)}}),[]),l=(0,s.useMemo)(()=>c(o,[a]),[]);return s.createElement(n.W6,{ref:e,plugins:l,parentContainer:i},s.createElement(n.iX,null,r))}),f=t=>{let e=(0,n.Dc)();return(0,s.useMemo)(()=>{e.getLayer(g).updateOptions(t)},[t]),s.createElement(s.Fragment,null)}},66298:function(t,e,i){i.d(e,{CD:()=>g,FU:()=>c,Xn:()=>D,f9:()=>y,qp:()=>S});var r=i(9163),n=i(832176),s=i(129034),o=i(976826),a=i(952893),l=i(893740),h=Object.defineProperty,d=Object.getOwnPropertyDescriptor,u=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?d(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&h(e,i,s),s},c=Symbol("OperationContribution"),g=class{init(){for(let e of this.contributions){var t;null==(t=e.registerOperationMeta)||t.call(e,this)}}registerOperationMeta(t){return this._operationMetas.has(t.type)?(console.warn(`A operation meta ${t.type} is already registered.`),n.JT.NULL):new n.K4(this._doRegisterOperationMetaMeta(t))}getOperationMeta(t){return this._operationMetas.get(t)}_doRegisterOperationMetaMeta(t){return this._operationMetas.set(t.type,t),{dispose:()=>{this._operationMetas.delete(t.type)}}}constructor(){this._operationMetas=new Map,this.contributions=[]}};u([(0,r.nx)(c),(0,r.jt)()],g.prototype,"contributions",2),u([(0,r.zY)()],g.prototype,"init",1),g=u([(0,r.b2)()],g);var p=class{};p=u([(0,r.b2)()],p);var f=class{constructor(){this.generateId=()=>(0,s.x0)(),this.getSnapshot=()=>""}};f=u([(0,r.b2)()],f);var y=class{init(){this._toDispose.push(this.applyEmitter)}applyOperation(t,e){let i,r=this.operationRegistry.getOperationMeta(t.type);if(!r)throw Error(`Operation meta ${t.type} has not registered.`);return(null==e?void 0:e.noApply)||(i=r.apply(t,this.context.source)),this.applyEmitter.fire(t),i}getOperationLabel(t){let e=this.operationRegistry.getOperationMeta(t.type);if(e&&e.getLabel)return e.getLabel(t,this.context.source)}getOperationDescription(t){let e=this.operationRegistry.getOperationMeta(t.type);if(e&&e.getDescription)return e.getDescription(t,this.context.source)}inverseOperations(t){return t.map(t=>this.inverseOperation(t)).reverse()}inverseOperation(t){let e=this.operationRegistry.getOperationMeta(t.type);if(!e)throw Error(`Operation meta ${t.type} has not registered.`);return e.inverse(t)}dispose(){this._toDispose.dispose()}constructor(){this.applyEmitter=new n.Q5,this.onApply=this.applyEmitter.event,this._toDispose=new n.K4}};u([(0,r.f3)(g)],y.prototype,"operationRegistry",2),u([(0,r.f3)(p)],y.prototype,"context",2),u([(0,r.f3)(f)],y.prototype,"config",2),u([(0,r.zY)()],y.prototype,"init",1),y=u([(0,r.b2)()],y);var m=class{setLimit(t){this._limit=t}pushElement(t){this._redoStack=[],this._stackPush(this._undoStack,t),this._toDispose.push(t),this._emitChange("push",t)}getUndoStack(){return this._undoStack}getRedoStack(){return this._redoStack}getLastElement(){return this._undoStack[this._undoStack.length-1]}async undo(){if(!this.canUndo()||this._undoing)return;this._undoing=!0;let t=this._undoStack.pop();try{await t.undo()}finally{this._stackPush(this._redoStack,t),this._emitChange("undo",t),this._undoing=!1}}async redo(){if(!this.canRedo()||this._redoing)return;this._redoing=!0;let t=this._redoStack.pop();try{await t.redo()}finally{this._stackPush(this._undoStack,t),this._emitChange("redo",t),this._redoing=!1}}canUndo(){return this._undoStack.length>0}canRedo(){return this._redoStack.length>0}canPush(){return!this._redoing&&!this._undoing}clear(){this.clearRedoStack(),this.clearUndoStack(),this._emitChange("clear")}clearRedoStack(){this._redoStack.forEach(t=>{t.dispose()}),this._redoStack=[]}clearUndoStack(){this._undoStack.forEach(t=>{t.dispose()}),this._undoStack=[]}dispose(){this.clear(),this._toDispose.dispose()}_stackPush(t,e){t.push(e),t.length>this._limit&&t.shift()}_emitChange(t,e){e?this.onChangeEmitter.fire({type:t,element:e}):this.onChangeEmitter.fire({type:t})}constructor(){this._undoing=!1,this._redoing=!1,this._limit=100,this.onChangeEmitter=new n.Q5,this.onChange=this.onChangeEmitter.event,this._toDispose=new n.K4,this._undoStack=[],this._redoStack=[],this._toDispose.push(this.onChangeEmitter)}};m=u([(0,r.b2)()],m);var E=class{get id(){return this._id}getTimestamp(){return this._timestamp}pushOperation(t){let e=this._operation(t);return this._operations.push(e),e}getOperations(){return this._operations}getChangeOperations(t){return"undo"===t?this._operationService.inverseOperations(this._operations):this._operations}getFirstOperation(){return this._operations[0]}getLastOperation(){return this._operations[this._operations.length-1]}async undo(){for(let t of this._operationService.inverseOperations(this._operations))await this._apply(t)}async redo(){for(let t of this._operations)await this._apply(t)}revert(t){let e=this._operations;for(let i of("undo"!==t&&(e=this._operations.map(t=>this._inverse(t)).reverse()),e))this._apply(i)}_inverse(t){return this._operationService.inverseOperation(t)}async _apply(t){await this._operationService.applyOperation(t)}_operation(t){return{...t,value:(0,a.Z)(t.value),id:this._operationService.config.generateId()}}dispose(){this._toDispose.dispose()}constructor(t,e=[]){this._toDispose=new n.K4,this._timestamp=Date.now(),this._operationService=t,this._operations=e.map(t=>this._operation(t)),this._id=t.config.generateId()}},b=class{get items(){return this._items}add(t,e){let i=this._getHistoryItem(t,e);return this._items.unshift(i),this._items.length>this.limit&&this._items.pop(),this.onChangeEmitter.fire({type:"add",value:i,service:t}),i}findById(t){return this._items.find(e=>e.id===t)}changeByIndex(t,e,i){let r=this._getHistoryItem(e,i);this._items[t]=r,this.onChangeEmitter.fire({type:"update",value:r,service:e})}addOperation(t,e,i){let r=this._items.find(t=>t.id===e);if(!r)return void console.warn("no history item found");let n=this._getHistoryOperation(t,i);r.operations.push(n),this.onChangeEmitter.fire({type:"add_operation",value:{historyItem:r,operation:n},service:t})}updateOperation(t,e,i){let r=this._items.find(t=>t.id===e);if(!r)return void console.warn("no history item found");let n=r.operations.findIndex(t=>t.id==t.id);if(n<0)return void console.warn("no operation found");let s=this._getHistoryOperation(t,i);r.operations.splice(n,1,s),this.onChangeEmitter.fire({type:"update_operation",value:{historyItem:r,operation:s},service:t})}clear(){this._items=[]}dispose(){this._items=[],this._toDispose.dispose()}_getHistoryItem(t,e){return{...e,uri:t.context.uri,time:b.dateFormat(e.timestamp),operations:e.operations.map(i=>this._getHistoryOperation(t,i,"push"!==e.type))}}_getHistoryOperation(t,e){let i,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(r)i=this.historyConfig.generateId();else{let t=e.id;if(!t)throw Error("no operation id found");i=t}return{...(0,a.Z)(e),id:i,label:t.operationService.getOperationLabel(e),description:t.operationService.getOperationDescription(e),timestamp:Date.now()}}static dateFormat(t){return new Date(t).toLocaleString()}constructor(){this._items=[],this.onChangeEmitter=new n.Q5,this.onChange=this.onChangeEmitter.event,this._toDispose=new n.K4,this.limit=100,this._toDispose.push(this.onChangeEmitter)}};u([(0,r.f3)(f)],b.prototype,"historyConfig",2),b=u([(0,r.b2)()],b);var C=class{registerHistoryService(t){let e=new n.K4;e.pushAll([t.undoRedoService.onChange(e=>{if("clear"===e.type)return;let{type:i,element:r}=e,n=r.getChangeOperations(i),s={id:"push"===i?r.id:this.historyConfig.generateId(),type:i,uri:t.context.uri,operations:n,timestamp:Date.now()};this.historyStack.add(t,s)}),t.onMerge(e=>{this._handleMerge(t,e)})]),this._historyServices.set(t,e),this._toDispose.push(t.onWillDispose(()=>{this.unregisterHistoryService(t)}))}unregisterHistoryService(t){let e=this._historyServices.get(t);e&&(e.dispose(),this._historyServices.delete(t))}getHistoryServiceByURI(t){for(let e of this._historyServices.keys())if(e.context.uri===t)return e}getFirstHistoryService(){for(let t of this._historyServices.keys())return t}dispose(){this._toDispose.dispose(),this.historyStack.dispose(),this._historyServices.forEach(t=>t.dispose()),this._historyServices.clear()}_handleMerge(t,e){let{element:i,operation:r}=e.value;if(this.historyStack.findById(i.id)){if(!r.id)return void console.warn("no operation id found");"UPDATE"===e.type&&this.historyStack.updateOperation(t,i.id,r),"ADD"===e.type&&this.historyStack.addOperation(t,i.id,r)}}constructor(){this._historyServices=new Map,this._toDispose=new n.K4}};u([(0,r.f3)(b)],C.prototype,"historyStack",2),u([(0,r.f3)(f)],C.prototype,"historyConfig",2),C=u([(0,r.b2)()],C);var S=class{get onApply(){return this.operationService.onApply}init(){this._toDispose.push(this._willDisposeEmitter),this._toDispose.push(this._mergeEmitter)}start(){this._locked=!1}stop(){this._locked=!0}limit(t){this.undoRedoService.setLimit(t)}startTransaction(){if(this._transacting)return;this._transacting=!0;let t=new E(this.operationService,[]);this._transactOperation=t}endTransaction(){let t=this._transactOperation;t&&(0!==t.getOperations().length&&this._pushStackOperation(t),this._transactOperation=null,this._transacting=!1)}transact(t){this._transacting||(this.startTransaction(),t(),this.endTransaction())}pushOperation(t,e){if(!this._canPush())return;let i=this._transactOperation||this.undoRedoService.getLastElement(),r=this.operationRegistry.getOperationMeta(t.type);if(!r)throw Error(`Operation meta ${t.type} has not registered.`);if(r.shouldSave&&!r.shouldSave(t))return r.apply(t,this.context.source);let n=this.operationService.applyOperation(t,{noApply:null==e?void 0:e.noApply});r.getURI&&!t.uri&&(t.uri=r.getURI(t,this.context.source));let s=this._shouldMerge(t,i,r);if(s)if("object"==typeof s){let t=i.getLastOperation();t.value=s.value,this._mergeEmitter.fire({type:"UPDATE",value:{element:i,operation:t,value:s.value}})}else{let e=i.pushOperation(t);this._mergeEmitter.fire({type:"ADD",value:{element:i,operation:e}})}else{let e=new E(this.operationService,[t]);this._pushStackOperation(e)}return n}getHistoryOperations(){return this.historyManager.historyStack.items.reverse().map(t=>t.operations.map(t=>({...(0,o.Z)(t,["type","value"]),label:t.label||t.type}))).flat()}async undo(){await this.undoRedoService.undo()}async redo(){await this.undoRedoService.redo()}canUndo(){return this.undoRedoService.canUndo()}canRedo(){return this.undoRedoService.canRedo()}getSnapshot(){return this.config.getSnapshot()}getRecords(){throw Error("Method not implemented.")}restore(t){throw Error("Method not implemented.")}clear(){this.undoRedoService.clear()}dispose(){this._willDisposeEmitter.fire(this),this._toDispose.dispose()}_canPush(){return!this._locked&&this.undoRedoService.canPush()}_pushStackOperation(t){this.undoRedoService.pushElement(t),this.undoRedoService.clearRedoStack()}_shouldMerge(t,e,i){return!!e&&(!!this._transacting||i.shouldMerge&&i.shouldMerge(t,e.getLastOperation(),e))}constructor(){this._toDispose=new n.K4,this._transacting=!1,this._transactOperation=null,this._locked=!1,this._willDisposeEmitter=new n.Q5,this._mergeEmitter=new n.Q5,this.onWillDispose=this._willDisposeEmitter.event,this.onMerge=this._mergeEmitter.event}};u([(0,r.f3)(m)],S.prototype,"undoRedoService",2),u([(0,r.f3)(g)],S.prototype,"operationRegistry",2),u([(0,r.f3)(y)],S.prototype,"operationService",2),u([(0,r.f3)(p)],S.prototype,"context",2),u([(0,r.f3)(f)],S.prototype,"config",2),u([(0,r.f3)(C)],S.prototype,"historyManager",2),u([(0,r.zY)()],S.prototype,"init",1),S=u([(0,r.b2)()],S);var D=new r.nZ((t,e,i,r,n,s,o)=>{t(g).toSelf().inSingletonScope(),t(y).toSelf().inSingletonScope(),t(m).toSelf().inSingletonScope(),t(S).toSelf().inSingletonScope(),t(p).toSelf().inSingletonScope(),t(C).toSelf().inSingletonScope(),t(b).toSelf().inSingletonScope(),t(f).toSelf().inSingletonScope(),s(S,(t,e)=>{var i,r,n,s;let o;return(o=(null==(r=t.container)||null==(i=r.parent)?void 0:i.isBound(C))?null==(s=t.container)||null==(n=s.parent)?void 0:n.get(C):t.container.get(C))&&(e.historyManager=o,o.registerHistoryService(e)),e})});(0,l.M1)({onInit:(t,e)=>{e.onApply&&t.get(y).onApply(e.onApply.bind(null,t))},containerModules:[D]})},27430:function(t,e,i){i.d(e,{o:()=>s});var r=i(958481),n=i(832176),s=new class{t(t,e){return this.i18n.t(t,{defaultValue:this.missingStrictMode?void 0:t,...e})}get locale(){return this.i18n.locale}set locale(t){this.i18n.locale=t}addLanguages(t){this.i18n.store(t.reduce((t,e)=>Object.assign(t,{[e.languageId]:{languageName:e.languageName,localizedLanguageName:e.localizedLanguageName,...e.contents}}),{}))}addLanguage(t){this.addLanguages([t])}constructor(t){this.i18n=new r.oc,this._onLanguageChangeEmitter=new n.Q5,this.onLanguageChange=this._onLanguageChangeEmitter.event,this.missingStrictMode=!1,this.addLanguages(t),this.locale=function(){if("object"!=typeof navigator)return"en-US";let t=navigator.language;return"en"===t||"en-US"===t?"en-US":"zh"===t||"zh-CN"===t?"zh-CN":t}(),this.i18n.onChange(()=>{this._onLanguageChangeEmitter.fire(this.i18n.locale)})}}([{languageId:"en-US",languageName:"English",localizedLanguageName:"English",contents:{Yes:"Yes",No:"No"}},{languageId:"zh-CN",languageName:"Chinese",localizedLanguageName:"()",contents:{Yes:"",No:""}}])},875787:function(t,e,i){i.d(e,{BP:()=>h,Re:()=>d,nt:()=>u});var r,n=i(908600),s=i(832176);(t=>{let e,i=[],r=[],n=!1,s=!1,o=!1,a=!1;function l(t,e){if(a)throw e;console.error(`[Tracker error] ${t}`,e)}function h(t){if(s)throw Error("Can't call Tracker.flush while flushing");if(o)throw Error("Can't flush inside Tracker.autorun");s=!0,n=!0,a=!!(t=t||{}).throwFirstError;var e=0,u=!1;try{for(;i.length||r.length;){for(;i.length;){var c=i.shift();if(c._recompute(),c._needsRecompute()&&i.unshift(c),!t.finishSynchronously&&++e>100){u=!0;return}}if(r.length){var g=r.shift();try{g()}catch(t){l("afterFlush",t)}}}u=!0}finally{if(u||(s=!1,h({finishSynchronously:t.finishSynchronously,throwFirstError:!1})),n=!1,s=!1,i.length||r.length){if(t.finishSynchronously)throw Error("still have more to do?");setTimeout(d,10)}}}function d(){n||(setTimeout(h,0),n=!0)}function u(t){let i=e;e=void 0;try{return t(void 0)}finally{e=i}}function c(){return!!e}t.withComputation=function(t,i){let r=e;e=t;try{return i.call(null,t)}finally{e=r}},t.withoutComputation=u,t.isActive=c,t.getCurrentComputation=function(){return e},t.autorun=function(i,r){var n=new g(i,e,null==r?void 0:r.onError);return c()&&t.onInvalidate(function(){n.stop()}),n};t.onInvalidate=function(t){if(!e)throw Error("Tracker.onInvalidate requires a currentComputation");e.onInvalidate(t)},t.inFlush=function(){return s},t.flush=function(t){h({finishSynchronously:!0,throwFirstError:t&&t.throwFirstError})},t.afterFlush=function(t){r.push(t),d()};class g{onInvalidate(t){this.invalidated?u(t.bind(null,this)):this._onInvalidateCallbacks.push(t)}invalidate(){if(!this.invalidated){this._recomputing||this.stopped||(d(),i.push(this)),this.invalidated=!0;for(var t,e=0;t=this._onInvalidateCallbacks[e];e++)u(t.bind(null,this));this._onInvalidateCallbacks=[]}}stop(){if(!this.stopped){this.stopped=!0,this.invalidate();for(let t=0,e;e=this._onStopCallbacks[t];t++)u(e.bind(null,this));this._onStopCallbacks=[]}}onStop(t){this.stopped?u(t.bind(null,this)):this._onStopCallbacks.push(t)}_compute(){this.invalidated=!1;var e=o;o=!0;try{this._result=t.withComputation(this,this._fn)}finally{o=e}}_needsRecompute(){return this.invalidated&&!this.stopped}_recompute(){this._recomputing=!0;try{if(this._needsRecompute())try{this._compute()}catch(t){this._onError?this._onError(t):l("recompute",t)}}finally{this._recomputing=!1}}flush(){this._recomputing||this._recompute()}run(){this.invalidate(),this.flush()}get result(){return this._result}constructor(t,e,i){this._fn=t,this.parent=e,this._onError=i,this._onInvalidateCallbacks=[],this._onStopCallbacks=[],this._recomputing=!1,this.stopped=!1,this.invalidated=!1,this.firstRun=!0;let r=!0;try{this._compute(),r=!1}finally{this.firstRun=!1,r&&this.stop()}}}t.Computation=g,t.Dependency=class{depend(t){if(!t){if(!c())return!1;t=e}return!this._dependents.has(t)&&(this._dependents.add(t),t.onInvalidate(()=>{this._dependents.delete(t)}),!0)}changed(){for(let t of this._dependents)t.invalidate()}hasDependents(){return 0!==this._dependents.size}constructor(){this._dependents=new Set}}})(r||(r={}));var o=class{_addDepend(t){r.isActive()&&t.depend()}hasDependents(){return this._dep.hasDependents()}get value(){return this._addDepend(this._dep),this._value}set value(t){this._isEqual(this._value,t)||(this._value=t,this._dep.changed())}constructor(t,e){this._dep=new r.Dependency,this._isEqual=(t,e)=>t==e,this._value=t,(null==e?void 0:e.isEqual)&&(this._isEqual=e.isEqual)}};function a(t,e){if("Proxy"in window)return new Proxy(t,e);let i={};for(let r in t)Object.defineProperty(i,r,{enumerable:!0,get:e.get?()=>e.get(t,r):void 0,set:e.set?i=>e.set(t,r,i):void 0});return i}var l=r.Dependency,h=class extends o{set(t,e){this._ensureKey(t);let i=this._value[t];return!this._isEqual(i,e)&&(this._value[t]=e,this._keyDeps.get(t).changed(),!0)}get(t){return this._ensureKey(t),this._addDepend(this._keyDeps.get(t)),this._value[t]}_ensureKey(t){this._keyDeps.has(t)||this._keyDeps.set(t,new l)}hasDependents(){if(this._dep.hasDependents())return!0;for(let t of this._keyDeps.values())if(t.hasDependents())return!0;return!1}keys(){return Object.keys(this._value)}set value(t){this._isEqual(this._value,t)||(this._value=t,this._keyDeps.clear(),this._dep.changed())}get value(){return this._addDepend(this._dep),this._proxyValue||(this._proxyValue=a(this._value,{get:(t,e)=>this.get(e),set:(t,e,i)=>(this.set(e,i),!0)})),this._proxyValue}get readonlyValue(){return this._addDepend(this._dep),this._proxyReadonlyValue||(this._proxyReadonlyValue=a(this._value,{get:(t,e)=>this.get(e),set:(t,e)=>{throw Error(`[ReactiveState] Cannnot set readonly field "${e}"`)}})),this._proxyReadonlyValue}constructor(){super(...arguments),this._keyDeps=new Map}};function d(t){let e=(0,s.JA)(),i=(0,n.useMemo)(()=>new Map,[]),o=(0,n.useCallback)(()=>{i.forEach(t=>t.stop()),i.clear()},[]);return(0,n.useEffect)(()=>o,[]),o(),(0,n.useMemo)(()=>void 0===t?{}:a(t,{get(n,s){let o=i.get(s);return o||(o=new r.Computation(i=>i.firstRun?t[s]:void e()),i.set(s,o)),t[s]}}),[t])}function u(t){return d(t.readonlyValue)}var{Dependency:c,Computation:g}=r},832176:function(t,e,i){i.d(e,{Ae:()=>P,Cd:()=>O,Ct:()=>p,E9:()=>I,JA:()=>tE,JT:()=>d,K4:()=>W,KV:()=>tf,Of:()=>to,Pq:()=>H,Q5:()=>U,Qc:()=>ty,RZ:()=>h,S9:()=>ta,V_:()=>y,XJ:()=>g,Zp:()=>tn,_b:()=>x,cO:()=>Q,dG:()=>Y,gE:()=>ti,gw:()=>q,hY:()=>tl,i1:()=>tr,jl:()=>N,oN:()=>tp,pL:()=>m,r9:()=>th,rM:()=>E,sI:()=>b,xF:()=>S,y3:()=>V,yb:()=>tv,z:()=>ts});var r,n,s,o,a,l,h,d,u,c,g,p,f,y,m,E,b,C,S,D=i(65881),_=i(908600),{PI:w}=Math,x=2*w,N=180/w,M=class t{sub(e){return new t(this.x-e.x,this.y-e.y)}dot(t){return this.x*t.x+this.y*t.y}constructor(t=0,e=0){this.x=t,this.y=e}},I=class t{clone(){return new t(this.x,this.y)}copyFrom(t){return this.set(t.x,t.y),this}copyTo(t){return t.x=this.x,t.y=this.y,t}equals(t){return t.x===this.x&&t.y===this.y}set(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.x=t,this.y=e,this}constructor(t=0,e=0){this.x=t,this.y=e}},T=I||(I={});function L(t,e,i){return{x:t.x+i*(e.x-t.x),y:t.y+i*(e.y-t.y)}}T.EMPTY={x:0,y:0},T.getDistance=function(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)},T.getMiddlePoint=function(t,e){return L(t,e,.5)},T.getRatioPoint=L,T.fixZero=function(t){return 0===t.x&&(t.x=0),0===t.y&&(t.y=0),t},T.move=function(t,e){return{x:t.x+(e.x||0),y:t.y+(e.y||0)}},T.moveDistanceToDirection=function(t,e,i){let r=e.x-t.x,n=e.y-t.y,s=0===r?0:Math.sqrt(i**2/(1+n**2/r**2)),o=0===r?i:Math.abs(s*n/r);return{x:t.x+(r>0?s:-s),y:t.y+(n>0?o:-o)}};var P=class t{static get EMPTY(){return new t(0,0,0,0)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}clone(){return new t(this.x,this.y,this.width,this.height)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}copyTo(t){return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t}contains(t,e){return!(this.width<=0)&&!(this.height<=0)&&!!(t>=this.x)&&!!(t<=this.right)&&!!(e>=this.y)&&!!(e<=this.bottom)}isEqual(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}containsRectangle(t){return t.left>=this.left&&t.right<=this.right&&t.top>=this.top&&t.bottom<=this.bottom}pad(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return this.x-=t,this.y-=e,this.width+=2*t,this.height+=2*e,this}fit(t){let e=Math.max(this.x,t.x),i=Math.min(this.x+this.width,t.x+t.width),r=Math.max(this.y,t.y),n=Math.min(this.y+this.height,t.y+t.height);return this.x=e,this.width=Math.max(i-e,0),this.y=r,this.height=Math.max(n-r,0),this}ceil(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.001,i=Math.ceil((this.x+this.width-e)*t)/t,r=Math.ceil((this.y+this.height-e)*t)/t;return this.x=Math.floor((this.x+e)*t)/t,this.y=Math.floor((this.y+e)*t)/t,this.width=i-this.x,this.height=r-this.y,this}enlarge(t){let e=Math.min(this.x,t.x),i=Math.max(this.x+this.width,t.x+t.width),r=Math.min(this.y,t.y),n=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=i-e,this.y=r,this.height=n-r,this}get center(){return{x:this.x+this.width/2,y:this.y+this.height/2}}get rightBottom(){return{x:this.right,y:this.bottom}}get leftBottom(){return{x:this.left,y:this.bottom}}get rightTop(){return{x:this.right,y:this.top}}get leftTop(){return{x:this.left,y:this.top}}get bottomCenter(){return{x:this.x+this.width/2,y:this.bottom}}get topCenter(){return{x:this.x+this.width/2,y:this.top}}get rightCenter(){return{x:this.right,y:this.y+this.height/2}}get leftCenter(){return{x:this.left,y:this.y+this.height/2}}update(t){return t(this)}get crossDistance(){return I.getDistance(this.leftTop,this.rightBottom)}toStyleStr(){return`left: ${this.x}px; top: ${this.y}px; width: ${this.width}px; height: ${this.height}px;`}withPadding(t){return this.x-=t.left,this.y-=t.top,this.width+=t.left+t.right,this.height+=t.top+t.bottom,this}withoutPadding(t){return this.x+=t.left,this.y+=t.top,this.width=this.width-t.left-t.right,this.height=this.height-t.top-t.bottom,this}withHeight(t){return this.height=t,this}clearSpace(){return this.width=0,this.height=0,this}constructor(t=0,e=0,i=0,r=0){this.x=t,this.y=e,this.width=i,this.height=r,this.type=1}},R=P||(P={});function A(t){let e=R.EMPTY.clone();if(!t.length)return e;let i=[],r=[],n=[],s=[];t.forEach(t=>{i.push(t.left),n.push(t.right),s.push(t.bottom),r.push(t.top)});let o=Math.min.apply(Math,i),a=Math.max.apply(Math,n),l=Math.min.apply(Math,r),h=Math.max.apply(Math,s);return e.x=o,e.width=a-o,e.y=l,e.height=h-l,e}R.align=function(t,e){if(t.length<=1)return t;switch(e){case"align-bottom":let i=Math.max(...t.map(t=>t.bottom));t.forEach(t=>{t.y=i-t.height});break;case"align-center":let r=A(t).center.x;t.forEach(t=>{t.x=r-t.width/2});break;case"align-left":let n=Math.min(...t.map(t=>t.left));t.forEach(t=>{t.x=n});break;case"align-middle":let s=A(t).center.y;t.forEach(t=>{t.y=s-t.height/2});break;case"align-right":let o=Math.max(...t.map(t=>t.right));t.forEach(t=>{t.x=o-t.width});break;case"align-top":let a=Math.min(...t.map(t=>t.top));t.forEach(t=>{t.y=a});break;case"distribute-horizontal":if(t.length<=2)break;let l=t.slice().sort((t,e)=>t.left-e.left),h=A(t),d=t.reduce((t,e)=>t-e.width,h.width)/(t.length-1);l.reduce((t,e)=>(e.x=t,t+e.width+d),h.x);break;case"distribute-vertical":if(t.length<=2)break;let u=t.slice().sort((t,e)=>t.top-e.top),c=A(t),g=t.reduce((t,e)=>t-e.height,c.height)/(t.length-1);u.reduce((t,e)=>(e.y=t,t+e.height+g),c.y)}return t},R.enlarge=A,R.intersects=function(t,e,i){let r=t.left,n=t.top,s=t.right,o=t.bottom,a=e.left,l=e.top,h=e.right,d=e.bottom;return"horizontal"===i?s>a&&r<h:"vertical"===i?o>l&&n<d:!!(s>a)&&!!(r<h)&&!!(o>l)&&!!(n<d)},R.intersectsWithRotation=function(t,e,i,r){let n=new k(t.center,t.width,t.height,e),s=new k(i.center,i.width,i.height,r),o=n.centerPoint.sub(s.centerPoint),a=n.axesX;if(n.getProjectionRadius(a)+s.getProjectionRadius(a)<=Math.abs(o.dot(a)))return!1;let l=n.axesY;if(n.getProjectionRadius(l)+s.getProjectionRadius(l)<=Math.abs(o.dot(l)))return!1;let h=s.axesX;if(n.getProjectionRadius(h)+s.getProjectionRadius(h)<=Math.abs(o.dot(h)))return!1;let d=s.axesY;return!(n.getProjectionRadius(d)+s.getProjectionRadius(d)<=Math.abs(o.dot(d)))},R.isViewportVisible=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return r?e.containsRectangle(t):0===i?R.intersects(t,e):R.intersectsWithRotation(t,i,e,0)},R.setViewportVisible=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,{left:r,right:n,top:s,bottom:o,width:a,height:l}=t,{left:h,right:d,top:u,bottom:c}=e;return r<=h?t.x=h+i:n>=d&&(t.x=d-i-a),s<=u?t.y=u+i:o>=c&&(t.y=c-i-l),t},R.createRectangleWithTwoPoints=function(t,e){let i=t.x<e.x?t.x:e.x,r=t.y<e.y?t.y:e.y;return new R(i,r,Math.abs(t.x-e.x),Math.abs(t.y-e.y))};var k=class{getProjectionRadius(t){return this.width/2*Math.abs(t.dot(this.axesX))+this.height/2*Math.abs(t.dot(this.axesY))}constructor(t,e,i,r){this.width=e,this.height=i,this.centerPoint=new M(t.x,t.y),this.axesX=new M(Math.cos(r),Math.sin(r)),this.axesY=new M(-1*this.axesX.y,this.axesX.x)}},O=class t{clone(){return new t(this.x,this.y,this.radius)}contains(t,e){if(this.radius<=0)return!1;let i=this.radius*this.radius,r=this.x-t,n=this.y-e;return r*=r,n*=n,r+n<=i}getBounds(){return new P(this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.radius=i,this.type=2}},V=class t{static get IDENTITY(){return new t}static get TEMP_MATRIX(){return new t}fromArray(t){return t.length<6||(this.a=t[0],this.b=t[1],this.c=t[3],this.d=t[4],this.tx=t[2],this.ty=t[5]),this}set(t,e,i,r,n,s){return this.a=t,this.b=e,this.c=i,this.d=r,this.tx=n,this.ty=s,this}toArray(t,e){this.array||(this.array=new Float32Array(9));let i=e||this.array;return t?(i[0]=this.a,i[1]=this.b,i[2]=0,i[3]=this.c,i[4]=this.d,i[5]=0,i[6]=this.tx,i[7]=this.ty):(i[0]=this.a,i[1]=this.c,i[2]=this.tx,i[3]=this.b,i[4]=this.d,i[5]=this.ty,i[6]=0,i[7]=0),i[8]=1,i}apply(t,e){let{x:i,y:r}=t;return(e=e||{x:0,y:0}).x=this.a*i+this.c*r+this.tx,e.y=this.b*i+this.d*r+this.ty,e}applyInverse(t,e){e=e||{x:0,y:0};let i=1/(this.a*this.d+-(this.c*this.b)),{x:r}=t,{y:n}=t;return e.x=this.d*i*r+-this.c*i*n+(this.ty*this.c-this.tx*this.d)*i,e.y=this.a*i*n+-this.b*i*r+(-this.ty*this.a+this.tx*this.b)*i,e}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){let e=Math.cos(t),i=Math.sin(t),r=this.a,n=this.c,s=this.tx;return this.a=r*e-this.b*i,this.b=r*i+this.b*e,this.c=n*e-this.d*i,this.d=n*i+this.d*e,this.tx=s*e-this.ty*i,this.ty=s*i+this.ty*e,this}append(t){let e=this.a,i=this.b,r=this.c,n=this.d;return this.a=t.a*e+t.b*r,this.b=t.a*i+t.b*n,this.c=t.c*e+t.d*r,this.d=t.c*i+t.d*n,this.tx=t.tx*e+t.ty*r+this.tx,this.ty=t.tx*i+t.ty*n+this.ty,this}setTransform(t,e,i,r,n,s,o,a,l){return this.a=Math.cos(o+l)*n,this.b=Math.sin(o+l)*n,this.c=-Math.sin(o-a)*s,this.d=Math.cos(o-a)*s,this.tx=t-(i*this.a+r*this.c),this.ty=e-(i*this.b+r*this.d),this}prepend(t){let e=this.tx;if(1!==t.a||0!==t.b||0!==t.c||1!==t.d){let e=this.a,i=this.c;this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}decompose(t){let{a:e}=this,{b:i}=this,{c:r}=this,{d:n}=this,s=-Math.atan2(-r,n),o=Math.atan2(i,e),a=Math.abs(s+o);return a<1e-5||1e-5>Math.abs(x-a)?(t.rotation=o,t.skew.x=0,t.skew.y=0):(t.rotation=0,t.skew.x=s,t.skew.y=o),t.scale.x=Math.sqrt(e*e+i*i),t.scale.y=Math.sqrt(r*r+n*n),t.position.x=this.tx,t.position.y=this.ty,t}invert(){let t=this.a,e=this.b,i=this.c,r=this.d,n=this.tx,s=t*r-e*i;return this.a=r/s,this.b=-e/s,this.c=-i/s,this.d=t/s,this.tx=(i*this.ty-r*n)/s,this.ty=-(t*this.ty-e*n)/s,this}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}isSimple(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d}clone(){let e=new t;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t}copyFrom(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this}constructor(t=1,e=0,i=0,r=1,n=0,s=0){this.a=t,this.b=e,this.c=i,this.d=r,this.tx=n,this.ty=s,this.array=null}},B=class t{get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this.cb.call(this.scope))}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this.cb.call(this.scope))}clone(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.cb,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.scope;return new t(e,i,this._x,this._y)}set(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;return(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this.cb.call(this.scope)),this}copyFrom(t){return(this._x!==t.x||this._y!==t.y)&&(this._x=t.x,this._y=t.y,this.cb.call(this.scope)),this}copyTo(t){return t.x=this._x,t.y=this._y,t}equals(t){return t.x===this._x&&t.y===this._y}constructor(t,e,i=0,r=0){this._x=i,this._y=r,this.cb=t,this.scope=e}},F=class{onChange(){this._localID++}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this._localID++}updateLocalTransform(){let t=this.localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x-(this.pivot.x*t.a+this.pivot.y*t.c),t.ty=this.position.y-(this.pivot.x*t.b+this.pivot.y*t.d),this._currentLocalID=this._localID,this._parentID=-1)}updateTransform(t){let e=this.localTransform;if(this._localID!==this._currentLocalID&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this._currentLocalID=this._localID,this._parentID=-1),this._parentID!==t._worldID){let i=t.worldTransform,r=this.worldTransform;r.a=e.a*i.a+e.b*i.c,r.b=e.a*i.b+e.b*i.d,r.c=e.c*i.a+e.d*i.c,r.d=e.c*i.b+e.d*i.d,r.tx=e.tx*i.a+e.ty*i.c+i.tx,r.ty=e.tx*i.b+e.ty*i.d+i.ty,this._parentID=t._worldID,this._worldID++}}setFromMatrix(t){t.decompose(this),this._localID++}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this.updateSkew())}constructor(){this.worldTransform=new V,this.localTransform=new V,this.position=new B(this.onChange,this,0,0),this.scale=new B(this.onChange,this,1,1),this.pivot=new B(this.onChange,this,0,0),this.skew=new B(this.updateSkew,this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0}};function z(t,e,i){let r=i-e;return e+((t-e)%r+r)%r}F.IDENTITY=new F,(r=h||(h={})).wrap=function(t){return z(t,-Math.PI,Math.PI)},r.wrapDegrees=function(t){return z(t,-180,180)},r.betweenPoints=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0},r={x:t.x-i.x,y:t.y-i.y},n={x:e.x-i.x,y:e.y-i.y};return Math.atan2(r.x*n.y-r.y*n.x,r.x*n.x+r.y*n.y)};var{keys:G}=Object;Object.prototype.hasOwnProperty;var $=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return G(t).reduce((i,r)=>e(i,t[r],r),i)},Y=()=>{};Object.prototype.toString;var X=d||(d={});function j(t){return{dispose:t}}X.is=function(t){return"object"==typeof t&&null!==t&&"function"==typeof t.dispose},X.create=j,X.NULL=Object.freeze(j(()=>{})),(u||(u={})).None=()=>d.NULL;var J=class t{get event(){return this._event||(this._event=(e,i)=>{if(this._disposed)return d.NULL;this._listeners||(this._listeners=[]);let r=i?e.bind(i):e;this._listeners.length>=t.LEAK_WARNING_THRESHHOLD&&console.warn(`[Emitter] Listeners length >= ${t.LEAK_WARNING_THRESHHOLD}`),this._listeners.push(r);let n={dispose:()=>{if(n.dispose=Y,!this._disposed){let t=this._listeners.indexOf(r);-1!==t&&this._listeners.splice(t,1)}}};return n}),this._event}fire(t){this._listeners&&this._listeners.forEach(e=>e(t))}get disposed(){return this._disposed}dispose(){this._listeners&&(this._listeners=void 0),this._disposed=!0}constructor(){this._disposed=!1}};J.LEAK_WARNING_THRESHHOLD=175;var U=J,H=class{dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}get onDispose(){return this.toDispose.onDispose}constructor(){this.toDispose=new W}},W=class{get length(){return this.disposables.length}get onDispose(){return this.onDisposeEmitter.event}get disposed(){return this._disposed}dispose(){this.disposed||(this._disposed=!0,this.disposables.slice().reverse().forEach(t=>{try{t.dispose()}catch(t){console.error(t)}}),this.onDisposeEmitter.fire(void 0),this.onDisposeEmitter.dispose())}push(t){if(this.disposed||t===d.NULL)return d.NULL;let{disposables:e}=this;if(e.find(e=>e===t))return d.NULL;let i=t.dispose,r=d.create(()=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1),t.dispose=i});return t.dispose=()=>{r.dispose(),t.dispose()},e.push(t),r}pushAll(t){return t.map(t=>this.push(t))}constructor(...t){this.disposables=[],this.onDisposeEmitter=new U,this._disposed=!1,t.forEach(t=>this.push(t))}},K=Object.freeze(function(t,e){let i=setTimeout(t.bind(e),0);return{dispose(){clearTimeout(i)}}});(n=c||(c={})).isCancellationToken=function(t){return t===n.None||t===n.Cancelled||t instanceof Z||!!t&&"object"==typeof t&&"boolean"==typeof t.isCancellationRequested&&"function"==typeof t.onCancellationRequested},n.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:u.None}),n.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:K});var Z=class{cancel(){!this._isCancelled&&(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?K:(this._emitter||(this._emitter=new U),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}constructor(){this._isCancelled=!1}},Q=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};function q(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.None,i=new Q,r=setTimeout(()=>i.resolve(),t);return e.onCancellationRequested(()=>{clearTimeout(r),i.reject(Error("Cancelled"))}),i.promise}var tt=g||(g={});function te(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=!(arguments.length>3)||void 0===arguments[3]||arguments[3];if(t===e)return!1;if(0===i||"object"!=typeof t||"object"!=typeof e)return t!==e;let n=Object.keys(e);if(!r){let e=Object.keys(t);if(n.length!==e.length)return!0}for(let s=0,o=n.length;s<o;s++){let o=n[s];if(te(t[o],e[o],i-1,r))return!0}return!1}tt.isChanged=te,tt.isDeepChanged=function(t,e,i){return te(t,e,1/0,i)},tt.isArrayShallowChanged=function(t,e){if(t.length!==e.length)return!0;for(let i=0,r=t.length;i<r;i++)if(t[i]!==e[i])return!0;return!1},(s=p||(p={})).create=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=[];return{getFromCache:()=>i,getMore(r){let n=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(r===i.length);else if(r>i.length){let e=r-i.length;for(;e>0;)i.push(t()),e--}else if(n){let t=e.deleteLimit??0;i.length-r>t&&i.splice(r).forEach(t=>t.dispose&&t.dispose())}return i.slice(0,r)},getMoreByItemKeys(e){let r=[],n=new Map;return i.forEach(t=>{if(e.find(e=>e.key===t.key))n.set(t.key,t);else{var i;null==(i=t.dispose)||i.call(t)}}),e.forEach(e=>{if(!e.key)throw Error("getMoreByItemKeys need a key");let i=n.get(e.key);i?r.push(i):r.push(t(e))}),i=r},getMoreByItems(e){let r=[],n=new Map;return i.forEach(t=>{if(e.find(e=>e===t.key))n.set(t.key,t);else{var i;null==(i=t.dispose)||i.call(t)}}),e.forEach(e=>{let i=n.get(e);i?r.push(i):r.push({...t(e),key:e})}),i=r},get:()=>(i.length>0||i.push(t()),i[0]),getFromCacheByKey:t=>i.find(e=>e.key===t),dispose(){i.forEach(t=>t.dispose&&t.dispose()),i.length=0},clear(){this.dispose()}}},s.assign=function(t,e){return Object.assign(t,e)},s.createShortCache=function(){let t,e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;function r(){e&&clearTimeout(e),e=setTimeout(()=>{e=void 0,t=void 0},i)}return{get:e=>(t||(t=e()),r(),t)}},s.createWeakCache=function(){let t=new WeakMap;return{get:e=>t.get(e),save:(e,i)=>t.set(e,i),isChanged:(e,i)=>g.isChanged(t.get(e),i)}},(f||(f={})).create=function(t,e,i){return{type:"object",properties:{...null==e?void 0:e.properties,...t},mixinDefaults:{...null==e?void 0:e.mixinDefaults,...i}}},(o=y||(y={})).createDefault=function t(e,i,r){i={...e.mixinDefaults,...i};let n=r?`${r}.`:"";if(e.properties){let r,s;return r=e.properties,s=(e,r)=>{let s=n+r;return i&&void 0!==i[s]?i[s]:t(e,i,s)},$(r,(t,e,i)=>Object.assign(t,{[i]:s(e,i)}))}return"function"==typeof e.default?e.default():e.default},o.isBaseType=function(t){return"string"===t.type||"float"===t.type||"integer"===t.type||"boolean"===t.type||"enum"===t.type||"color"===t.type||"range"===t.type};var ti={label:"",properties:{width:{label:"",default:0,type:"float"},height:{label:"",default:0,type:"float"},locked:{label:"",default:!1,type:"boolean"}},type:"object"},tr={label:"",description:"",properties:{x:{label:"x",default:.5,type:"float"},y:{label:"y",default:.5,type:"float"}},type:"object"},tn={label:"",properties:{x:{label:"x",default:0,type:"float"},y:{label:"y",default:0,type:"float"}},type:"object"},ts={label:"",type:"float",default:0},to={label:"",properties:{x:{label:"x",default:1,type:"float"},y:{label:"y",default:1,type:"float"}},type:"object"},ta={label:"",properties:{x:{label:"x",default:0,type:"float"},y:{label:"y",default:0,type:"float"}},type:"object"},tl={properties:{position:tn,size:ti,origin:tr,scale:to,skew:ta,rotation:ts},type:"object"};(a=m||(m={})).createDefault=function(){return y.createDefault(tl)},a.toJSON=function(t){return{position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height,locked:t.size.locked},origin:{x:t.origin.x,y:t.origin.y},scale:{x:t.scale.x,y:t.scale.y},skew:{x:t.skew.x,y:t.skew.y},rotation:t.rotation}},a.getDelta=function(t,e){return{position:{x:e.position.x-t.position.x,y:e.position.y-t.position.y},size:{width:e.size.width-t.size.width,height:e.size.height-t.size.height},origin:{x:e.origin.x-t.origin.x,y:e.origin.y-t.origin.y},scale:{x:e.scale.x-t.scale.x,y:e.scale.y-t.scale.y},skew:{x:e.skew.x-t.skew.x,y:e.skew.y-t.skew.y},rotation:e.rotation-t.rotation}},a.mergeDelta=function(t,e,i){let r=void 0!==i?t=>Math.round(100*t)/100:t=>t;return{position:{x:r(e.position.x+t.position.x),y:r(e.position.y+t.position.y)},size:{width:r(e.size.width+t.size.width),height:r(e.size.height+t.size.height),locked:t.size.locked},origin:{x:r(e.origin.x+t.origin.x),y:r(e.origin.y+t.origin.y)},scale:{x:r(e.scale.x+t.scale.x),y:r(e.scale.y+t.scale.y)},skew:{x:r(e.skew.x+t.skew.x),y:r(e.skew.y+t.skew.y)},rotation:e.rotation+t.rotation}},a.is=function(t){return t&&t.position&&t.size&&"number"==typeof t.position.x&&"number"==typeof t.size.width},(l=E||(E={})).fixSize=function(t,e){if(t.width<=e.width&&t.height<=e.height)return 1;let i=t.width/e.width,r=t.height/e.height;return 1/(i>r?i:r)},l.coverSize=function(t,e){let i=t.width/e.width,r=t.height/e.height;return 1/(i<r?i:r)},l.empty=function(){return{width:0,height:0}},(b||(b={})).empty=()=>({left:0,right:0,top:0,bottom:0}),(C||(C={})).isEmpty=function(t){return!t||void 0===t.topLeft&&void 0===t.topRight&&void 0===t.bottomLeft&&void 0===t.bottomRight};var th={label:"",type:"float",min:0,max:1,default:1},td=S||(S={});function tu(t){return`${t}px`}function tc(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=document.createElement(t);return i.length>0&&(n.className=(0,D.Z)(i)),n}td.toPixel=tu,td.fromPercent=function(t){return parseFloat(t.substring(0,t.length-1))},td.toPercent=function(t){return`${t}%`},td.enableEvent=function(t){t.style.pointerEvents="all"},td.disableEvent=function(t){t.style.pointerEvents="none"},td.createElement=tc,td.createDivWithClass=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return tc("div",...e)},td.addClass=function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];t.className=(0,D.Z)(i.concat(t.className.split(" ")))},td.delClass=function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];i.forEach(e=>{t.classList.remove(e)}),t.className=t.classList.toString()},td.coverClass=function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];t.className=(0,D.Z)(i)},td.clearChildren=function(t){t.innerHTML=""},td.translatePercent=function(t,e,i){t.style.transform=`translate(${e}%, ${i}%)`},td.translateXPercent=function(t,e){t.style.transform=`translateX(${e}%)`},td.translateYPercent=function(t,e){t.style.transform=`translateY(${e}%)`},td.setStyle=function(t,e){let i=[];G(e).forEach(t=>((t,e)=>{void 0!==t&&("number"==typeof t&&"opacity"!==e&&"zIndex"!==e&&"scale"!==e&&(t=tu(t)),i.push(`${e.replace(/([A-Z])/,t=>`-${t.toLowerCase()}`)}:${t}`))})(e[t],t));let r=t.getAttribute("style"),n=i.join(";");r!==n&&t.setAttribute("style",n)},td.classNameWithPrefix=function(t){return(e,i)=>(0,D.Z)(e.split(/\s+/).map(e=>`${t}-${e}`).join(" "),i)},td.addStandardDisposableListener=function(t,e,i,r){return t.addEventListener(e,i,r),d.create(()=>{t.removeEventListener(e,i)})},td.createDOMCache=function(t,e,i){return p.create(()=>{let r="string"==typeof e?td.createDivWithClass(e):e();return i&&(r.innerHTML=i),t.appendChild(r),Object.assign(r,{dispose:()=>{let{parentNode:t}=r;t&&t.removeChild(r)},setStyle:t=>{td.setStyle(r,t)}})})};var tg=0;function tp(){return tg===Number.MAX_SAFE_INTEGER&&(tg=0),tg++}function tf(t,e,i){t(e).toSelf().inSingletonScope(),i.forEach(i=>t(i).toService(e))}var ty=Symbol("ContributionProvider"),tm=class{forEach(t){this.getContributions().forEach(t)}getContributions(){if(!this.services){let t=[],{container:e}=this;if(e.isBound(this.identifier))try{t.push(...e.getAll(this.identifier))}catch(t){console.error(t)}this.services=t}return this.services}constructor(t,e){this.container=t,this.identifier=e}};function tv(t,e){t(ty).toDynamicValue(t=>new tm(t.container,e)).inSingletonScope().whenTargetNamed(e)}function tE(t){let[,e]=(0,_.useState)(t);return(0,_.useCallback)(t=>e(void 0!==t?t:{}),[])}new class{isDevEnv(){return!1}info(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];if(this.isDevEnv())return console.info(e)}log(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];if(this.isDevEnv())return console.log(...e)}error(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return console.error(...e)}warn(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return console.warn(...e)}}},57064:function(t,e,i){i.d(e,{Bl:()=>g,Bw:()=>A,Co:()=>Q,FC:()=>Z,GH:()=>O,Ps:()=>$,Us:()=>z,au:()=>T,b5:()=>I,fu:()=>S,j0:()=>p,kq:()=>K,o:()=>W,pm:()=>U,ps:()=>B,yf:()=>G});var r=i(9163),n=i(430550),s=i(832176),o=i(893740),a=i(908600),l=i(444596),h=Object.defineProperty,d=Object.getOwnPropertyDescriptor,u=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?d(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&h(e,i,s),s},c=Symbol("NodeContribution"),g=class{registerMaterialRender(t,e){this.materialRenderRegistry.set(t,e)}getMaterialRender(t){return this.materialRenderRegistry.get(t)}registerPluginRender(t,e){this.pluginRenderRegistry.set(t,e)}getPluginRender(t){return this.pluginRenderRegistry.get(t)}registerNodeErrorRender(t){this.registerMaterialRender("Material_CustomNodeError",t)}get nodeRenderHoc(){return(0,n.Z)(this.nodeRenderHocs)}registerNodeRenderHoc(t){this.nodeRenderHocs.push(t)}get nodeErrorRender(){return this.materialRenderRegistry.get("Material_CustomNodeError")}init(){this.nodeContributions.forEach(t=>{var e;return null==(e=t.onRegister)?void 0:e.call(t,this)})}constructor(){this.materialRenderRegistry=new Map,this.pluginRenderRegistry=new Map,this.nodeRenderHocs=[],this.nodeContributions=[]}};u([(0,r.nx)(c),(0,r.jt)()],g.prototype,"nodeContributions",2),u([(0,r.zY)()],g.prototype,"init",1),g=u([(0,r.b2)()],g);var p=class{get json(){return this._json}get readonly(){return this._readonly}set readonly(t){this._readonly=t,this.fireChange()}fireChange(){this.updateJSON(),this.onChangeEmitter.fire(this)}updateJSON(){this._json={readonly:this._readonly}}constructor(){this.onChangeEmitter=new s.Q5,this.onChange=this.onChangeEmitter.event,this._readonly=p.DEFAULT_READONLY,this._json=p.DEFAULT_JSON}};p.DEFAULT_READONLY=!1,p.DEFAULT_JSON={readonly:p.DEFAULT_READONLY},p=u([(0,r.b2)()],p);var f=class{};u([(0,r.f3)(g)],f.prototype,"nodeManager",2),u([(0,r.f3)(p)],f.prototype,"context",2),f=u([(0,r.b2)()],f);var y=new r.nZ((t,e,i,r)=>{t(f).toSelf().inSingletonScope(),t(g).toSelf().inSingletonScope(),t(p).toSelf().inSingletonScope()}),m="Plugin_Form",E="Plugin_Error",b="node_error_render",C="node_placeholder_render",S=class extends o.RD{getDefaultData(){return{error:null}}setError(t){this.update({error:t})}getError(){return this.data.error}};S.type="FlowNodeErrorData";var D={color:"#f54a45"},_=t=>{let{node:e,playgroundContext:i,clientContext:r}=t,n=(0,o.JA)(),s=e.getData(S),l=s.getError(),h=(0,o.G2)(g).getMaterialRender(b),d=(0,a.useCallback)(()=>h?h({error:l,context:{node:e,playgroundContext:i,clientContext:r}}):(t=>{let{error:e}=t;return a.createElement("div",{style:D},e.message)})({error:l,context:{node:e,playgroundContext:i,clientContext:r}}),[l,e,i,r]);return(0,a.useEffect)(()=>{let t=s.onDataChange(()=>{n()});return()=>{t.dispose()}},[]),l?d():null},w=t=>a.createElement(_,{...t}),x=class{onRegister(t){t.registerPluginRender(E,w)}};x=u([(0,r.b2)()],x);var N=new r.nZ(t=>{(0,s.KV)(t,x,[c])}),M=class{makeFormItemMaterialContext(t,e){return{meta:t.meta,path:t.path,readonly:this.nodeEngineContext.readonly,getFormItemValueByPath:t.formModel.getFormItemValueByPath.bind(t.formModel),onFormValidate:t.formModel.onValidate.bind(t.formModel),form:t.formModel,node:t.formModel.flowNodeEntity,playgroundContext:this.playgroundContext,index:null==e?void 0:e.getIndex()}}};u([(0,r.f3)(p)],M.prototype,"nodeEngineContext",2),u([(0,o.el)()],M.prototype,"playgroundContext",2),M=u([(0,r.b2)()],M);var I=class{static normalize(t){return t===I.ROOT||t.endsWith(I.DIVIDER)&&(t=t.slice(0,-1)),t}static join(t){if(t[1].startsWith(I.ROOT))throw Error(`FormPathService Error: join failed, invalid paths[1], paths[1]= ${t[1]}`);return t[0].endsWith(I.DIVIDER)?`${t[0]}${t[1]}`:t.join(I.DIVIDER)}static toArrayPath(t){return I.join([t,I.ARRAY])}static parseArrayItemPath(t){let e=t.split("/"),i=0;for(;i<e.length;){let t=parseInt(e[i]);if(!isNaN(t)){let r=I.toArrayPath(e.slice(0,i).join(I.DIVIDER)),n=e.slice(i+1).join(I.DIVIDER),s=I.join([r,n]);return{itemIndex:t,arrayPath:r,itemMetaPath:s}}i+=1}return null}simplify(t){let e=t.split(I.DIVIDER),i=[];for(let t=0;t<e.length;t++){if(!e[t])throw Error("FormPathService: join failed");e[t]!==I.RELATIVE_CURRENT&&(e[t]===I.RELATIVE_PARENT&&i.pop(),i.push(e[t]))}return i.join(I.DIVIDER)}};I.ROOT="/",I.DIVIDER="/",I.RELATIVE_PARENT="..",I.RELATIVE_CURRENT=".",I.ARRAY="[]",I=u([(0,r.b2)()],I),Symbol("FormModelFactory"),Symbol("FormModelEntity");var T=class{constructor(){this.toDispose=new s.K4}};T=u([(0,r.b2)()],T);var L=class{register(t){this.registry.set(t.key,t)}get(t){return this.registry.get(t)}get objectMap(){return Object.fromEntries(this.registry)}get collection(){return Array.from(this.registry.values())}constructor(){this.registry=new Map}};L=u([(0,r.b2)()],L);var P=Symbol("FormContribution"),R=class t{get type(){return t.type}};R.type="setter";var A=R,k=class t{get type(){return t.type}};k.type="decorator";var O=k;var V=class t{get type(){return t.type}};V.type="effect";var B=V;var F=class t{get type(){return t.type}};F.type="validation";var z=F,G=class{get components(){var t;return(0,l.Z)((null==(t=this.extensionRegistryMap.get(A.type))?void 0:t.objectMap)||{},t=>t.component)}get decorators(){var t;return(0,l.Z)((null==(t=this.extensionRegistryMap.get(O.type))?void 0:t.objectMap)||{},t=>t.component)}registerAbilityExtension(t,e){this.extensionRegistryMap.get(t)||this.extensionRegistryMap.set(t,new L);let i=this.extensionRegistryMap.get(t);i&&i.register(e)}getAbilityExtension(t,e){var i;return null==(i=this.extensionRegistryMap.get(t))?void 0:i.get(e)}registerAbility(t){let e=new t;this.abilityRegistry.set(e.type,e)}registerAbilities(t){t.forEach(this.registerAbility.bind(this))}getAbility(t){return this.abilityRegistry.get(t)}registerSetterHoc(t){this.setterHocs.push(t)}fireFormModelWillInit(t,e){this.onFormModelWillInitEmitter.fire({model:t,data:e})}dispose(){this.onFormModelWillInitEmitter.dispose()}init(){this.formContributions.forEach(t=>{var e;return null==(e=t.onRegister)?void 0:e.call(t,this)})}constructor(){this.abilityRegistry=new Map,this.setterHocs=[],this.extensionRegistryMap=new Map,this.formContributions=[],this.onFormModelWillInitEmitter=new s.Q5,this.onFormModelWillInit=this.onFormModelWillInitEmitter.event}};u([(0,r.f3)(I)],G.prototype,"pathManager",2),u([(0,r.f3)(M)],G.prototype,"formContextMaker",2),u([(0,o.el)()],G.prototype,"playgroundContext",2),u([(0,r.nx)(P),(0,r.jt)()],G.prototype,"formContributions",2),u([(0,r.zY)()],G.prototype,"init",1),G=u([(0,r.b2)()],G);var $=class extends o.RD{getFormModel(){return this.formModel}getDefaultData(){return{}}createForm(t,e){let i=this.flowNodeEntity.getData(S);i.setError(null);try{this.formModel.init(t,e)}catch(t){i.setError(t)}}updateFormValues(t){this.formModel.updateFormValues(t)}recreateForm(t,e){this.createForm(t,e)}toJSON(){return this.formModel.toJSON()}dispose(){super.dispose()}fireDetaiChange(t){this.onDetailChangeEmitter.fire(t)}constructor(t,e){super(t),this.onDetailChangeEmitter=new s.Q5,this.onDetailChange=this.onDetailChangeEmitter.event,this.flowNodeEntity=t,this.formModel=e.formModelFactory(t),this.toDispose.push(this.onDetailChangeEmitter),this.toDispose.push(s.JT.create(()=>{this.formModel.dispose()}))}};function Y(t){var e;let{node:i}=t,r=(0,s.JA)(),n=null==(e=i.getData($))?void 0:e.getFormModel();return(0,a.useEffect)(()=>{let t=null==n?void 0:n.onInitialized(()=>{r()});return()=>{t.dispose()}},[n]),(null==n?void 0:n.initialized)?n.render():null}$.type="FlowNodeEntityFormData";var X=t=>a.createElement(Y,{...t}),j=class{onRegister(t){t.registerPluginRender(m,X)}};j=u([(0,r.b2)()],j);var J=new r.nZ(t=>{t(G).toSelf().inSingletonScope(),t(I).toSelf().inSingletonScope(),t(M).toSelf().inSingletonScope(),(0,s.KV)(t,j,[c])});function U(){return[y,J,N]}var H=a.createContext(p.DEFAULT_JSON),W=(0,a.memo)(t=>{let{node:e}=t,i=(0,o.JA)(),r=e.getData(S),n=e.getData($).formModel,s=!!e.getData(S).getError(),l=e.getData($).getFormModel().initialized,h=(0,o.G2)(o.xm),d=(0,o.G2)(o.Zn),u=(0,o.G2)(g),c=u.getPluginRender(m),f=u.getPluginRender(E),y=u.getMaterialRender(C),b=function(){let t=(0,o.JA)(),e=(0,o.G2)(p);return(0,a.useEffect)(()=>{let i=e.onChange(()=>{t()});return()=>{i.dispose()}},[]),e}();(0,a.useEffect)(()=>{let t=r.onDataChange(()=>{i()}),e=n.onInitialized(()=>{i()});return()=>{t.dispose(),e.dispose()}},[]);let D=(0,a.useCallback)(()=>s?f({node:e,playgroundContext:h,clientContext:d}):n.formMeta?l?c({node:e,playgroundContext:h,clientContext:d}):(null==y?void 0:y({node:e,playgroundContext:h}))||null:null,[s,l,f,c,y,e,h]);return a.createElement(H.Provider,{value:b.json},u.nodeRenderHoc(D)())});function K(t,e){t.registerMaterialRender(b,e)}function Z(t,e){t.registerMaterialRender(C,e)}function Q(){return[$,S]}},755395:function(t,e,i){i.d(e,{C$:()=>R,F2:()=>ts,Np:()=>te,Od:()=>P,eP:()=>z,gN:()=>j,l0:()=>tr,lE:()=>q,qo:()=>tn,rR:()=>o});var r,n,s,o,a,l=i(908600),h=i(314112),d=i(832176),u=i(875787),c=i(349090),g=i(626866),p=i(661195),f=i(969134),y=i(13721),m=i(325486),E=i(938573),b=i(437104),C=i(268479),S=i(952893),D=i(129034),_=i(959250),w=i(336808),x=t=>null!==t&&"object"==typeof t,N=t=>String(Math.floor(Number(t)))===t;function M(t,e){let i=new Set(e),r={};return Object.keys(t).forEach(e=>{i.has(e)&&(r[e]=t[e])}),r}var I=o||(o={});function T(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let n=i.shift();if(void 0===n)return t.toString();let s="";return(s=""===t&&""===n?"":""!==t&&""===n?t.toString():""===t&&""!==n?n.toString():`${t}${I.DIVIDER}${n}`,i.length>0)?T(s,...i):s}function L(t,e,i){if(!t||!e)return[];let r=e.split(I.DIVIDER),n=r.shift(),s=[],o=t;for(;n;){if("object"!=typeof o||null===o)return[];if(n===I.ALL){let t=s.join(I.DIVIDER);return(0,p.Z)(Object.keys(o).map(e=>0===r.length?T(t,e):L(o[e],`${r.join(I.DIVIDER)}`,i).map(i=>T(t,e,i))))}if(!(n in o)&&!i)return[];o=o[n],s.push(n),n=r.shift()}return[e]}I.DIVIDER=".",I.ALL="*",I.isMatch=function(t,e){let i=t.split(I.DIVIDER),r=e.split(I.DIVIDER);return i.length===r.length&&i.every((t,e)=>t===I.ALL||t===r[e])},I.isMatchOrParent=function(t,e){if(""===t)return!0;let i=t.split(I.DIVIDER),r=e.split(I.DIVIDER);if(i.length>r.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==I.ALL&&i[t]!==r[t])return!1;return!0},I.getParentPathByPattern=function(t,e){let i=t.split(I.DIVIDER);return e.split(I.DIVIDER).slice(0,i.length).join(I.DIVIDER)},I.getSubPaths=function(t,e){return e&&"object"==typeof e?(0,p.Z)(t.map(t=>{let i=""===t?e:(0,f.Z)(e,t);return(0,y.Z)(i)?i.map((e,i)=>T(t,i)):(0,m.Z)(i)?Object.keys(i).map(e=>T(t,e)):[]})):[]},I.splitPattern=function(t){let e=t.split(I.DIVIDER),i=[],r=0,n=[];for(;r<e.length;)e[r]===I.ALL?(n.length&&i.push(n.join(I.DIVIDER)),i.push(I.ALL),n=[]):n.push(e[r]),r+=1;return n.length&&i.push(n.join(I.DIVIDER)),i},I.findMatchPaths=L,I.findMatchPathsWithEmptyValue=function(t,e){return e.includes("*")?L(t,e,!0):[e]};var P=((r=P||{}).Error="error",r.Warning="warning",r),R=((n=R||{}).onChange="onChange",n.onBlur="onBlur",n),A=class t{get parent(){if(!(this._path.length<2))return new t(this._path.slice(0,-1))}toString(){return this._path.join(".")}get value(){return this._path}isChild(e){let i=new t(e).value,r=this.value;if(i.length-r.length!=1)return!1;for(let t=0;t<r.length;t++)if(i[t]!==r[t])return!1;return!0}static compareArrayPath(t,e){let i=0;for(;t.value[i]&&e.value[i];){let r=parseInt(t.value[i]),n=parseInt(e.value[i]);if(!isNaN(r)&&!isNaN(n))return r-n;if(t.value[i]!==e.value[i])throw Error(`[Form] Path.compareArrayPath invalid input Error: two path should refers to the same array, but got path1: ${t.toString()}, path2: ${e.toString()}`);i++}throw Error(`[Form] Path.compareArrayPath invalid input Error: got path1: ${t.toString()}, path2: ${e.toString()}`)}isChildOrGrandChild(e){let i=new t(e).value,r=this.value;if(i.length-r.length<1)return!1;for(let t=0;t<r.length;t++)if(i[t]!==r[t])return!1;return!0}getArrayIndex(t){return parseInt(this._path[t.value.length])}concat(e){if("string"==typeof e||"number"==typeof e)return new t(this._path.concat(new t(e.toString())._path));throw Error(`[Form] Error in Path.concat: invalid param type, require number or string, but got ${typeof e}`)}replaceParent(e,i){if(e.value.length>this.value.length)throw Error(`[Form] Error in Path.replaceParent: invalid parent param: ${e}, parent length should not greater than current length.`);let r=[];for(let t=0;t<this.value.length;t++){if(t<e.value.length&&e.value[t]!==this.value[t])throw Error(`[Form] Error in Path.replaceParent: invalid parent param: '${e}' is not a parent of '${this.toString()}'`);t>=e.value.length&&r.push(this.value[t])}return new t(i.value.concat(r))}constructor(t){this._path=[],this._path=(0,c.Z)(t)}};function k(t,e){return(t||[]).map(t=>({...t,name:e}))}function O(t,e){return e?t?Object.keys(e).some(i=>!(0,E.Z)(t[i],e[i]))?{...t,...e}:t:{...e}:t}function V(t,e){return e&&t in e&&delete e[t],e}function B(t){let e={get name(){return t.name},get value(){return t.value},onChange:e=>{"object"==typeof e&&null!==e&&"target"in e&&"object"==typeof e.target?t.value="object"==typeof e&&null!==e&&"target"in e&&"object"==typeof e.target&&"checkbox"===e.target.type?e.target.checked:e.target.value:t.value=e},onBlur(){"onBlur"===t.form.validationTrigger&&t.validate()},onFocus(){t.state.isTouched=!0}};return Object.defineProperty(e,"key",{enumerable:!1,get:()=>t.id}),Object.defineProperty(e,"_fieldModel",{enumerable:!1,get:()=>t}),e}function F(t){return{get isTouched(){return t.isTouched},get invalid(){return t.invalid},get isDirty(){return t.isDirty},get isValidating(){return t.isValidating},get errors(){if(t.errors)return Object.values(t.errors).reduce((t,e)=>t.concat(e),[]);return},get warnings(){if(t.warnings)return Object.values(t.warnings).reduce((t,e)=>t.concat(e),[]);return}}}function z(t){let e={initialValues:t.initialValues,get values(){return t.values},set values(v){t.values=v},state:G(t.state),getValueIn:e=>t.getValueIn(e),setValueIn:(e,i)=>t.setValueIn(e,i),validate:t.validate.bind(t)};return Object.defineProperty(e,"_formModel",{enumerable:!1,get:()=>t}),e}function G(t){return{get isTouched(){return t.isTouched},get invalid(){return t.invalid},get isDirty(){return t.isDirty},get isValidating(){return t.isValidating},get errors(){return t.errors},get warnings(){return t.warnings}}}(s=a||(a={})).shouldTriggerFieldChangeEvent=function(t,e){let{name:i,options:r}=t;if(o.isMatchOrParent(e,i))return!0;if(new A(i).isChildOrGrandChild(e)){var n;return(null==r?void 0:r.action)==="array-append"?!new A(i).isChildOrGrandChild(e):(null==r?void 0:r.action)!=="array-splice"||null==r||null==(n=r.indexes)||!n.length||A.compareArrayPath(new A(e),new A(i).concat(r.indexes[0]))>=0}return!1},s.shouldTriggerFieldValidateWhenChange=function(t,e){let{name:i,options:r}=t;return(null==r?void 0:r.action)==="array-splice"||(null==r?void 0:r.action)==="array-swap"?e===i:s.shouldTriggerFieldChangeEvent(t,e)};var $=l.createContext({}),Y=l.createContext({});function X(){return(0,l.useContext)($)}function j(t){let{name:e,defaultValue:i,render:r,children:n,deps:s}=t,o=X(),a=o.getField(e)||o.createField(e),c=l.useMemo(()=>B(a),[a]),g=(0,u.nt)(a.reactiveState),p=(0,u.nt)(o.reactiveState),f=l.useMemo(()=>F(g),[g]),y=G(p),m=(0,d.JA)();return(l.useEffect(()=>{if(a.disposed)return m(),()=>{};a.renderCount=a.renderCount+1,o.getValueIn(e),void 0!==i&&(o.setInitValueIn(e,i),m());let t=new d.K4;return t.push(a.onValueChange(()=>{m()})),s&&s.forEach(e=>{var i;let r=null==(i=o.getField(e))?void 0:i.onValueChange(()=>{m()});r&&t.push(r)}),()=>{t.dispose(),a.renderCount>1?a.renderCount=a.renderCount-1:o.getField(a.name)===a&&a.dispose()}},[a]),a.disposed)?l.createElement(l.Fragment,null):l.createElement(Y.Provider,{value:a},r?r({field:c,fieldState:f,formState:y}):(0,h.Z)(n)?n({field:c,fieldState:f,formState:y}):l.cloneElement(n,{...c}))}function J(t){let e={get key(){return t.id},get name(){return t.path.toString()},get value(){return t.value},onChange:e=>{t.value=e},map:e=>t.map((t,i)=>e(B(t),i)),append:e=>B(t.append(e)),delete:e=>t.delete(e),remove:e=>t.delete(e),swap:(e,i)=>t.swap(e,i),move:(e,i)=>t.move(e,i)};return Object.defineProperty(e,"_fieldModel",{enumerable:!1,get:()=>t}),e}function U(t,e){return"string"==typeof t?{name:e,message:t,level:"error"}:(null==t?void 0:t.message)?{...t,name:e}:void 0}function H(t,e){return{[t]:e?[e]:[]}}var W={invalid:!1,isDirty:!1,isTouched:!1,isValidating:!1},K={invalid:!1,isDirty:!1,isTouched:!1,isValidating:!1},Z=class{get values(){return(0,g.Z)(this._values)}set values(t){this._values=(0,S.Z)(t)}setIn(t,e){this._values=function(t,e,i){let r=(0,g.Z)(t),n=r,s=0,o=(0,c.Z)(e);for(;s<o.length-1;s++){let e=o[s],i=function(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=(0,c.Z)(e);for(;t&&r<n.length;)t=t[n[r++]];return r===n.length||t?void 0===t?i:t:i}(t,o.slice(0,s+1));if(i&&(x(i)||Array.isArray(i)))n=n[e]=(0,g.Z)(i);else{let t=o[s+1];n=n[e]=N(t)&&Number(t)>=0?[]:{}}}return(0===s?t:n)[o[s]]===i&&o[s]in t?t:(n[o[s]]=i,r)}(this._values||{},t.toString(),e)}getIn(t){return(0,f.Z)(this.values,t.value)}dispose(){}},Q=class{get renderCount(){return this._renderCount}set renderCount(t){this._renderCount=t}initState(){let t=(0,f.Z)(this.form.state.errors,this.name),e=(0,f.Z)(this.form.state.warnings,this.name);t&&(this.state.errors={[this.name]:t}),e&&(this.state.warnings={[this.name]:e})}get path(){return this._path}get name(){return this._path.toString()}set name(t){this._path=new A(t)}get ref(){return this._ref}set ref(t){this._ref=t}get state(){return this._state.value}get reactiveState(){return this._state}get value(){return this.form.getValueIn(this.name)}set value(t){this.form.setValueIn(this.name,t),this.state.isTouched||(this.state.isTouched=!0,this.bubbleState())}updateNameForLeafState(t){var e,i;let{errors:r,warnings:n}=this.state,s=r?null==(e=Object.keys(r))?void 0:e[0]:void 0;s&&(null==r?void 0:r[s])&&s!==t&&(this.state.errors={[t]:(null==r?void 0:r[s])?k(null==r?void 0:r[s],t):null==r?void 0:r[s]});let o=n?null==(i=Object.keys(n))?void 0:i[0]:void 0;o&&(null==n?void 0:n[o])&&o!==t&&(this.state.warnings={[t]:(null==n?void 0:n[o])?k(null==n?void 0:n[o],t):null==n?void 0:n[o]})}updateValidate(t,e){"ui"===e&&this.originalValidate||(this.originalValidate=t)}bubbleState(){let{errors:t,warnings:e}=this.state;if(this.parent){this.parent.state.isTouched=(0,_.Z)(this.parent.children.map(t=>t.state.isTouched),Boolean),this.parent.state.invalid=(0,_.Z)(this.parent.children.map(t=>t.state.invalid),Boolean),this.parent.state.isDirty=(0,_.Z)(this.parent.children.map(t=>t.state.isDirty),Boolean),this.parent.state.isValidating=(0,_.Z)(this.parent.children.map(t=>t.state.isValidating),Boolean),this.parent.state.errors=t?O(this.parent.state.errors,t):V(this.name,this.parent.state.errors),this.parent.state.warnings=e?O(this.parent.state.warnings,e):V(this.name,this.parent.state.warnings),this.parent.bubbleState();return}this.form.state.isTouched=(0,_.Z)(this.form.fields.map(t=>t.state.isTouched),Boolean),this.form.state.invalid=(0,_.Z)(this.form.fields.map(t=>t.state.invalid),Boolean),this.form.state.isDirty=(0,_.Z)(this.form.fields.map(t=>t.state.isDirty),Boolean),this.form.state.isValidating=(0,_.Z)(this.form.fields.map(t=>t.state.isValidating),Boolean),this.form.state.errors=t?O(this.form.state.errors,t):V(this.name,this.form.state.errors),this.form.state.warnings=e?O(this.form.state.warnings,e):V(this.name,this.form.state.warnings)}clearState(){this.state.errors=W.errors,this.state.warnings=W.warnings,this.state.isTouched=W.isTouched,this.state.isDirty=W.isDirty,this.bubbleState()}get children(){let t=[];return this.form.fieldMap.forEach((e,i)=>{this.path.isChild(i)&&t.push(e)}),t}get parent(){let t=this.path.parent;if(t)return this.form.fieldMap.get(t.toString())}clear(){this.value&&(this.value=void 0)}async validate(){await this.validateSelf()}async validateSelf(){this.state.isValidating=!0,this.bubbleState();let{errors:t,warnings:e}=await this._runAsyncValidate();(null==t?void 0:t.length)?(this.state.errors=(0,w.Z)(t,"name"),this.state.invalid=!0):(this.state.errors={[this.name]:[]},this.state.invalid=!1),(null==e?void 0:e.length)?this.state.warnings=(0,w.Z)(e,"name"):this.state.warnings={[this.name]:[]},this.state.isValidating=!1,this.bubbleState(),this.form.onValidateEmitter.fire(this.form.state)}async _runAsyncValidate(){let t=[],e=[],i=await this.form.validateIn(this.name);if(!(null==i?void 0:i.length))return{};{let r=i.map(t=>U(t,this.name)).filter(Boolean);if(!(null==r?void 0:r.length))return{};let n=(0,w.Z)(r,"level");e=e.concat(n.warning||[]),t=t.concat(n.error||[])}return{errors:t,warnings:e}}updateState(t){}dispose(){this.children.map(t=>t.dispose()),this.toDispose.dispose(),this.form.fieldMap.delete(this.path.toString())}onDispose(t){this.toDispose.onDispose(t)}get disposed(){return this.toDispose.disposed}constructor(t,e){this.onValueChangeEmitter=new d.Q5,this.onValueChange=this.onValueChangeEmitter.event,this.toDispose=new d.K4,this._state=new u.BP({...W}),this._renderCount=0,this._mount=!1,this._path=t,this.form=e,this.id=(0,D.x0)();let i=this.form.onFormValuesChange(t=>{let{values:e,prevValues:i}=t;a.shouldTriggerFieldChangeEvent(t,this.name)&&(this.onValueChangeEmitter.fire({value:(0,f.Z)(e,this.name),prevValue:(0,f.Z)(i,this.name),formValues:e,prevFormValues:i}),"onChange"===this.form.validationTrigger&&a.shouldTriggerFieldValidateWhenChange(t,this.name)&&this.validate())});this.toDispose.push(i),this.toDispose.push(this.onValueChangeEmitter),this.initState()}},q=class extends Q{get children(){let t=[];return this.form.fieldMap.forEach((e,i)=>{this.path.isChild(i)&&t.push(e)}),t.sort((t,e)=>{let i=t.path.value,r=e.path.value;return parseInt(i[i.length-1])-parseInt(r[r.length-1])})}map(t){return(this.value||[]).map((t,e)=>{let i=this.path.concat(e).toString(),r=this.form.getField(i);return r||(r=this.form.createField(i)),r}).map(t)}append(t){var e;let i=(null==(e=this.value)?void 0:e.length)||0,r=this.path.concat(i).toString(),n=this.form.createField(r),s=this.value?[...this.value,t]:[t],o=this.form.values;return this.form.store.setIn(new A(this.name),s),this.form.fireOnFormValuesChange({values:this.form.values,prevValues:o,name:this.name,options:{action:"array-append",indexes:[i]}}),this.form.fireOnFormValuesInit({values:this.form.values,prevValues:o,name:r}),this.onAppendEmitter.fire({value:t,arrayValue:this.value,index:this.value.length-1}),n}delete(t){this._splice(t,1),this.onDeleteEmitter.fire({arrayValue:this.value,index:t})}_splice(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(t<0||e<0)throw Error("[Form] Error in FieldArrayModel.splice: Invalid Params, start and deleteCount should > 0");if(!this.value||0===this.value.length||e>this.value.length){var i;throw Error(`[Form] Error in FieldArrayModel.splice: delete count exceeds array length, tried to delete ${e} elements, but array length is ${(null==(i=this.value)?void 0:i.length)||0}`)}let r=this.form.values,n=[...this.value];n.splice(t,e),this.form.store.setIn(new A(this.name),n),this.form.fireOnFormValuesChange({values:this.form.values,prevValues:r,name:this.name,options:{action:"array-splice",indexes:Array.from({length:e},(e,i)=>i+t)}});let s=this.children;if(t+e>=s.length)for(let e=t;e<s.length;e++)this.form.disposeField(s[e].name);let o=[],a=new Map(this.form.fieldMap),l=(i,r)=>{var n;if((null==(n=i.children)?void 0:n.length)&&i.children.forEach(t=>{l(t,r)}),r<t)a.set(i.name,i);else if(r<t+e)o.push(i);else{let t=i.name,n=i.path.replaceParent(this.path.concat(r),this.path.concat(r-e)).toString();a.set(n,i),i.children.length||(i.updateNameForLeafState(n),i.bubbleState()),i.name=n,r>s.length-e-1&&a.delete(t)}};s.map((t,e)=>{l(t,e)}),o.forEach(t=>{t.dispose()}),this.form.fieldMap=a,this.form.alignStateWithFieldMap()}swap(t,e){if(!this.value)return;if(t<0||e<0||t>this.value.length-1||e>this.value.length-1)throw Error(`[Form]: FieldArrayModel.swap Error: invalid params 'form' and 'to', form=${t} to=${e}. expect the value between 0 to ${length-1}`);let i=this.form.values,r=[...this.value],n=r[t],s=r[e];r[e]=n,r[t]=s,this.form.store.setIn(this.path,r),this.form.fireOnFormValuesChange({values:this.form.values,prevValues:i,name:this.name,options:{action:"array-swap",indexes:[t,e]}});let o=new Map(this.form.fieldMap),a=this.findAllFieldsAt(t),l=this.findAllFieldsAt(e),h=this.getPathAt(t),d=this.getPathAt(e),u=[];a.forEach(t=>{let e=t.path.replaceParent(h,d).toString();t.name=e,t.children.length||(t.updateNameForLeafState(e),u.push(t)),o.set(e,t)}),l.forEach(t=>{let e=t.path.replaceParent(d,h).toString();t.name=e,t.children.length||t.updateNameForLeafState(e),o.set(e,t),u.push(t)}),this.form.fieldMap=o,u.forEach(t=>t.bubbleState()),this.form.alignStateWithFieldMap()}move(t,e){if(!this.value)return;if(t<0||e<0||t>this.value.length-1||e>this.value.length-1)throw Error(`[Form]: FieldArrayModel.move Error: invalid params 'form' and 'to', form=${t} to=${e}. expect the value between 0 to ${length-1}`);let i=[...this.value],r=i[t];i.splice(t,1),i.splice(e,0,r),this.form.setValueIn(this.name,i)}insertAt(t,e){if(!this.value)return;if(t<0||t>this.value.length)throw Error("[Form]: FieldArrayModel.insertAt Error: index exceeds array boundary");let i=[...this.value];i.splice(t,0,e),this.form.setValueIn(this.name,i)}getPathAt(t){return this.path.concat(t)}findAllFieldsAt(t){let e=this.getPathAt(t),i=e.toString(),r=this.form.fieldMap.get(i)?[this.form.fieldMap.get(i)]:[];return this.form.fieldMap.forEach((t,i)=>{e.isChildOrGrandChild(i)&&r.push(t)}),r}constructor(){super(...arguments),this.onAppendEmitter=new d.Q5,this.onAppend=this.onAppendEmitter.event,this.onDeleteEmitter=new d.Q5,this.onDelete=this.onDeleteEmitter.event}},tt=class{set fieldMap(t){this._fieldMap=t}get fieldMap(){return this._fieldMap}get context(){return this._options.context}get initialValues(){return this._options.initialValues}get values(){return this.store.values}set values(t){let e=this.values;(0,C.deepEqual)(e,t)||(this.store.values=t,this.fireOnFormValuesChange({values:this.values,prevValues:e,name:""}))}get validationTrigger(){return this._options.validateTrigger}get state(){return this._state.value}get reactiveState(){return this._state}get fields(){return Array.from(this.fieldMap.values())}updateState(t){}get initialized(){return this._initialized}fireOnFormValuesChange(t){this.onFormValuesChangeEmitter.fire(t),this.onFormValuesUpdatedEmitter.fire(t)}fireOnFormValuesInit(t){this.onFormValuesInitEmitter.fire(t),this.onFormValuesUpdatedEmitter.fire(t)}init(t){if(this._options=t,t.initialValues){let e=this.store.values;this.store.values=t.initialValues,this.fireOnFormValuesInit({values:t.initialValues,prevValues:e,name:""})}this._initialized=!0}createField(t,e){let i=new A(t),r=i.toString();if(this.fieldMap.get(r))return this.fieldMap.get(r);let n=e?new q(i,this):new Q(i,this);return this.fieldMap.set(r,n),n.onDispose(()=>{this.fieldMap.delete(r)}),this.onFieldModelCreateEmitter.fire(n),n}createFieldArray(t,e){return this.createField(t,!0)}disposeField(t){let e=this.fieldMap.get(t);e&&e.dispose()}deleteField(t){let e=this.fieldMap.get(t);e&&(e.clear(),e.dispose())}getField(t){return this.fieldMap.get(new A(t).toString())}getValueIn(t){return this.store.getIn(new A(t))}setValueIn(t,e){let i=this.values;this.store.setIn(new A(t),e),this.fireOnFormValuesChange({values:this.values,prevValues:i,name:t})}setInitValueIn(t,e){let i=new A(t);if(void 0===this.store.getIn(i)){let i=this.values;this.store.setIn(new A(t),e),this.fireOnFormValuesInit({values:this.values,prevValues:i,name:t})}}clearValueIn(t){this.setValueIn(t,void 0)}async validateIn(t){if(this.validateDisabled)return[];let e=this.getValidateOptions();if(e)return Promise.all(Object.keys(e).filter(e=>o.isMatch(e,t)).map(async i=>(0,e[i])({value:this.getValueIn(t),formValues:this.values,context:this.context,name:t})))}getValidateOptions(){let t=this._options.validate;return"function"==typeof t?t(this.values,this.context):t}async validate(){if(this.validateDisabled)return[];let t=this.getValidateOptions();if(!t)return[];let e=Object.keys(t).map(async e=>{let i=t[e],r=this.values;return Promise.all(o.findMatchPathsWithEmptyValue(r,e).map(async t=>{var e;let n=U(await i({value:(0,f.Z)(r,t),formValues:r,context:this.context,name:t}),t),s=this.getField(t),o=H(t,(null==n?void 0:n.level)==="error"?n:void 0),a=H(t,(null==n?void 0:n.level)==="warning"?n:void 0);s&&(s.state.errors=o,s.state.warnings=a,s.state.invalid=Object.keys(o).some(t=>{var e;return(null==(e=o[t])?void 0:e.length)>0}),s.bubbleState());return this.state.errors=O(this.state.errors,o),this.state.warnings=O(this.state.warnings,a),this.state.invalid=!(!(e=this.state.errors)||Object.keys(e).every(t=>(0,b.Z)(e[t]))),n}))});this.state.isValidating=!0;let i=await Promise.all(e);return this.state.isValidating=!1,this.onValidateEmitter.fire(this.state),(0,p.Z)(i).filter(Boolean)}alignStateWithFieldMap(){let t=Array.from(this.fieldMap.keys());this.state.errors&&(this.state.errors=M(this.state.errors,t)),this.state.warnings&&(this.state.warnings=M(this.state.warnings,t)),this.fieldMap.forEach(e=>{e.state.errors&&(e.state.errors=M(e.state.errors,t)),e.state.warnings&&(e.state.warnings=M(e.state.warnings,t))})}dispose(){this.fieldMap.forEach(t=>t.dispose()),this.store.dispose(),this._initialized=!1}constructor(){this._fieldMap=new Map,this.store=new Z,this._options={},this.onFieldModelCreateEmitter=new d.Q5,this.onFieldModelCreate=this.onFieldModelCreateEmitter.event,this.onFormValuesChangeEmitter=new d.Q5,this.onFormValuesChange=this.onFormValuesChangeEmitter.event,this.onFormValuesInitEmitter=new d.Q5,this.onFormValuesInit=this.onFormValuesInitEmitter.event,this.onFormValuesUpdatedEmitter=new d.Q5,this.onFormValuesUpdated=this.onFormValuesUpdatedEmitter.event,this.onValidateEmitter=new d.Q5,this.onValidate=this.onValidateEmitter.event,this._state=new u.BP({...K}),this._initialized=!1,this.validateDisabled=!1}};function te(t){let{disableAutoInit:e=!1,...i}=t||{},r=new tt;return e||r.init(i||{}),{form:z(r),control:{_formModel:r,getField:t=>{let e=r.getField(t);if(e)return e instanceof q?J(e):B(e)},init:()=>r.init(i||{})}}}function ti(t){let{form:e,render:i}=t;return l.createElement(l.Fragment,null,i({form:e}))}function tr(t){let{children:e,keepModelOnUnMount:i=!1,control:r,...n}=t,{_formModel:s}=(0,l.useMemo)(()=>r||te(n).control,[r]);(0,l.useEffect)(()=>()=>{i||s.dispose()},[]);let o=(0,l.useMemo)(()=>z(s),[s]);return l.createElement($.Provider,{value:s},e?(0,h.Z)(e)?l.createElement(ti,{form:o,render:e}):l.Children.only(e):null)}function tn(t){let e=(0,d.JA)(),i=X();if(!i)throw Error("[Form] error in useWatch, formModel not found");let r=i.getValueIn(t);return(0,l.useEffect)(()=>{let r=i.onFormValuesUpdated(i=>{let{name:r}=i;r===t&&e()});return()=>r.dispose()},[t,i]),r}function ts(t){let{name:e,defaultValue:i,deps:r,render:n,children:s}=t,o=X(),a=o.getField(e)||o.createFieldArray(e),c=l.useMemo(()=>J(a),[a]),g=(0,d.JA)(),p=(0,u.nt)(a.reactiveState),f=(0,u.nt)(o.reactiveState),y=F(p),m=l.useMemo(()=>G(f),[f]);return(l.useEffect(()=>{if(a.disposed)return g(),()=>{};a.renderCount=a.renderCount+1,o.getValueIn(e),void 0!==i&&(o.setInitValueIn(e,i),g());let t=new d.K4;return t.push(a.onValueChange(()=>{g()})),r&&r.forEach(e=>{var i;let r=null==(i=o.getField(e))?void 0:i.onValueChange(()=>{g()});r&&t.push(r)}),()=>{t.dispose(),a.renderCount>1?a.renderCount=a.renderCount-1:o.getField(a.name)===a&&a.dispose()}},[a]),a.disposed)?l.createElement(l.Fragment,null):l.createElement(Y.Provider,{value:a},n&&(0,h.Z)(n)?n({field:c,fieldState:y,formState:m}):(0,h.Z)(s)?s({field:c,fieldState:y,formState:m}):l.createElement(l.Fragment,null,"Invalid Array render"))}},928079:function(t,e,i){i.d(e,{CM:()=>L,CR:()=>T,TH:()=>b,wL:()=>M,zE:()=>E});var r,n=i(721855),s=i(969134),o=i(863875),a=i(336808),l=i(325681),h=i(437104),d=i(832176),u=i(57064),c=i(755395),g=i(893740),p=i(540300),f=i(280088),y=i(908600),m=i(129034),E=((r=E||{}).onValueChange="onValueChange",r.onValueInit="onValueInit",r.onValueInitOrChange="onValueInitOrChange",r.onArrayAppend="onArrayAppend",r.onArrayDelete="onArrayDelete",r);function b(t){return"onFormValuesChange"in t}function C(t){return t.startsWith("/")?u.b5.normalize(t).slice(1).split("/").join("."):t}function S(t,e){return()=>{null==t||t(),null==e||e()}}function D(t,e,i){i.forEach(i=>{let r=t.get(i);(null==r?void 0:r[e])&&(r[e](),delete r[e])})}var _=t=>{let{formModel:e}=t;return(null==e?void 0:e.formControl)?y.createElement(y.Fragment,null,y.createElement(c.l0,{control:null==e?void 0:e.formControl,keepModelOnUnMount:!0},e.formMeta.render)):null},w=()=>({}),x=()=>new Map([["onValueInitOrChange",{}],["onValueChange",{}],["onValueInit",{}],["onArrayAppend",{}],["onArrayDelete",{}]]),N=()=>[],M=class extends u.au{get valid(){return this._valid}set valid(t){this._valid=t,this.onValidChangeEmitter.fire(t)}get flowNodeEntity(){return this.node}get formManager(){return this.node.getService(u.yf)}get formControl(){return this._formControl}get formMeta(){return this._formMeta||this.node.getNodeRegistry().formMeta}get values(){var t;return null==(t=this.nativeFormModel)?void 0:t.values}get feedbacks(){return this._feedbacks}updateFormValues(t){if(this.nativeFormModel){let e=this.formMeta.formatOnInit?this.formMeta.formatOnInit(t,this.nodeContext):t;this.nativeFormModel.values=e}}set feedbacks(t){this._feedbacks=t,this.onFeedbacksChangeEmitter.fire(t)}get formItemPathMap(){return new Map}get initialized(){return this._initialized}get nodeContext(){return{node:this.node,playgroundContext:this.node.getService(g.xm),clientContext:this.node.getService(g.Zn)}}get nativeFormModel(){var t;return null==(t=this._formControl)?void 0:t._formModel}render(){return y.createElement(_,{formModel:this})}initPlugins(t){t.length&&(this.plugins=t,t.forEach(t=>{t.init(this)}))}init(t,e){var i;let r=this.node.getData(u.Ps);this.onFormValuesChange(()=>{this._valid=null,r.fireChange()}),null==(i=t.plugins||[])||i.forEach(e=>{e.setupFormMeta&&(t=e.setupFormMeta(t,this.nodeContext))}),this._formMeta=t;let{validateTrigger:h,validate:d,effect:g}=t;g&&(this.effectMap=g);let f="function"==typeof t.defaultValues?t.defaultValues(this.nodeContext):t.defaultValues,y=t.formatOnInit?t.formatOnInit(e,this.nodeContext):e,{control:m}=(0,c.Np)({initialValues:y||f,validateTrigger:h,context:this.nodeContext,validate:d,disableAutoInit:!0});this._formControl=m;let E=m._formModel;this.toDispose.push(E),E.onFormValuesChange(t=>{this.onFormValuesChangeEmitter.fire(t)}),t.plugins&&this.initPlugins(t.plugins),E.onFormValuesChange(t=>{let{values:e,prevValues:i,name:r,options:a}=t;Object.keys(this.effectMap).forEach(t=>{let l=(0,n.Z)([...c.rR.findMatchPaths(e,t),...c.rR.findMatchPaths(i,t)]).filter(t=>(0,s.Z)(e,t)!==(0,s.Z)(i,t));if(c.rR.isMatchOrParent(t,r)){let e=c.rR.getParentPathByPattern(t,r);l.includes(e)||l.push(e)}let h=this.effectMap[t];l.forEach(t=>{let n=["onValueChange","onValueInitOrChange"];(0,o.Z)((0,s.Z)(i,t))&&(n=(null==a?void 0:a.action)==="array-append"&&c.rR.isMatch(`${r}.*`,t)?[]:["onValueInit","onValueInitOrChange"]),D(this.effectReturnMap,t,n),h.forEach(r=>{let{effect:o,event:a}=r;if(n.includes(a)){let r=o({name:t,value:(0,s.Z)(e,t),prevValue:(0,s.Z)(i,t),formValues:e,form:(0,c.eP)(this.nativeFormModel),context:this.nodeContext});if(r&&"function"==typeof r&&this.effectReturnMap.has(a)){let e=this.effectReturnMap.get(a);e[t]=S(e[t],r)}}})})})}),E.onFormValuesInit(t=>{let{values:e,name:i,prevValues:r}=t;Object.keys(this.effectMap).forEach(t=>{let n=c.rR.findMatchPaths(e,t),o=this.effectMap[t];n.forEach(t=>{(c.rR.isMatchOrParent(i,t)||i===t)&&(D(this.effectReturnMap,t,["onValueInit","onValueInitOrChange"]),o.forEach(i=>{let{event:n,effect:o}=i;if("onValueInit"===n||"onValueInitOrChange"===n){let i=o({name:t,value:(0,s.Z)(e,t),formValues:e,prevValue:(0,s.Z)(r,t),form:(0,c.eP)(this.nativeFormModel),context:this.nodeContext});if(i&&"function"==typeof i&&this.effectReturnMap.has(n)){let e=this.effectReturnMap.get(n);e[t]=S(e[t],i)}}}))})})}),E.onFieldModelCreate(t=>{let e=function(t,e){if(!e)return;if(e[t.name])return e[t.name];let i=(0,p.Z)(Object.keys(e),e=>!!e.startsWith("regex:")&&RegExp(e.split(":")[1]).test(t.name));if(i)return e[i]}(t,this.effectMap);if(null==e?void 0:e.length){let i=(0,a.Z)(e,"event");(0,l.Z)(i,(e,i)=>{let r=t=>{e.forEach(e=>{let{effect:i}=e;return i({...t,formValues:E.values,form:(0,c.eP)(this.nativeFormModel),context:this.nodeContext})})};switch(i){case"onArrayAppend":t instanceof c.lE&&t.onAppend(r);break;case"onArrayDelete":t instanceof c.lE&&t.onDelete(r)}})}}),this._formControl.init(),this._initialized=!0,this.onInitializedEmitter.fire(this),this.onDispose(()=>{this._initialized=!1,this.effectMap={},E.dispose()})}toJSON(){var t,e;return this.formMeta.formatOnSubmit?this.formMeta.formatOnSubmit(null==(e=this.nativeFormModel)?void 0:e.values,this.nodeContext):null==(t=this.nativeFormModel)?void 0:t.values}clearValid(){}async validate(){var t,e;return this.formFeedbacks=await (null==(t=this.nativeFormModel)?void 0:t.validate()),this.valid=(0,h.Z)(null==(e=this.formFeedbacks)?void 0:e.filter(t=>"error"===t.level)),this.onValidateEmitter.fire(this),this.valid}getValues(){var t;return null==(t=this._formControl)?void 0:t._formModel.values}getField(t){var e;let i=t.includes("/")?C(t):t;return null==(e=this.formControl)?void 0:e.getField(i)}getValueIn(t){var e;let i=t.includes("/")?C(t):t;return null==(e=this.nativeFormModel)?void 0:e.getValueIn(i)}setValueIn(t,e){var i;let r=t.includes("/")?C(t):t;null==(i=this.nativeFormModel)||i.setValueIn(r,e)}onFormValueChangeIn(t,e){if(!this._initialized)throw Error("[NodeEngine] FormModel Error: onFormValueChangeIn can not be called before initialized");return this.formControl._formModel.onFormValuesChange(i=>{let{name:r,values:n,prevValues:o}=i;r===t&&e({value:(0,s.Z)(n,t),prevValue:(0,s.Z)(o,t),formValues:n,prevFormValues:o})})}getFormItemValueByPath(t){if(!t)return;if("/"===t){var e;return null==(e=this._formControl)?void 0:e._formModel.values}let i=C(t);return this.getValueIn(i)}async validateWithFeedbacks(){return await this.validate(),this.formFeedbacks.map(t=>({feedbackStatus:t.level,feedbackText:t.message,path:t.name}))}getFormItemByPath(t){if(!this.nativeFormModel)return;let e=this;if("/"===t)return{get value(){return e.nativeFormModel.values},set value(v){e.nativeFormModel.values=v}};let i=C(t),r=e.getValueIn(i);return{get value(){return r},set value(v){e.setValueIn(i,v)}}}dispose(){this.onDisposeEmitter.fire(),this.effectReturnMap.forEach(t=>{Object.values(t).forEach(t=>{t()})}),this.effectMap=w(),this.effectReturnMap=x(),this.plugins.forEach(t=>{t.dispose()}),this.plugins=[],this.formFeedbacks=N(),this._valid=null,this._formControl=void 0,this._initialized=!1,this.toDispose.dispose()}constructor(t){super(),this.effectMap=w(),this.effectReturnMap=x(),this.plugins=[],this.formFeedbacks=N(),this.onInitializedEmitter=new d.Q5,this.onValidateEmitter=new d.Q5,this.onValidate=this.onValidateEmitter.event,this.onInitialized=this.onInitializedEmitter.event,this.onDisposeEmitter=new d.Q5,this.onDispose=this.onDisposeEmitter.event,this.toDispose=new d.K4,this.onFormValuesChangeEmitter=new d.Q5,this.onFormValuesChange=this.onFormValuesChangeEmitter.event,this.onValidChangeEmitter=new d.Q5,this.onValidChange=this.onValidChangeEmitter.event,this.onFeedbacksChangeEmitter=new d.Q5,this.onFeedbacksChange=this.onFeedbacksChangeEmitter.event,this._valid=null,this._feedbacks=[],this._initialized=!1,this.node=t,this.toDispose.pushAll([this.onInitializedEmitter,this.onValidateEmitter,this.onValidChangeEmitter,this.onFeedbacksChangeEmitter,this.onFormValuesChangeEmitter])}},I=class{get formModel(){return this._formModel}get ctx(){return{formModel:this.formModel,...this.formModel.nodeContext}}setupFormMeta(t,e){var i,r;let n={...t};return null==(i=(r=this.config).onSetupFormMeta)||i.call(r,{mergeEffect:t=>{var e;e=n.effect||{},n.effect=(0,f.Z)(e,t,function(t,e){return(t||[]).concat(e)})},mergeValidate:t=>{n.validate={...n.validate||{},...t}},addFormatOnInit:t=>{if(!n.formatOnInit){n.formatOnInit=t;return}let e=n.formatOnInit;n.formatOnInit=(i,r)=>null==t?void 0:t(e(i,r),r)},addFormatOnSubmit:t=>{if(!n.formatOnSubmit){n.formatOnSubmit=t;return}let e=n.formatOnSubmit;n.formatOnSubmit=(i,r)=>null==t?void 0:t(e(i,r),r)},...e},this.opts),n}init(t){var e,i;this._formModel=t,null==(i=this.config)||null==(e=i.onInit)||e.call(i,this.ctx,this.opts)}dispose(){var t,e;(null==(t=this.config)?void 0:t.onDispose)&&(null==(e=this.config)||e.onDispose(this.ctx,this.opts))}constructor(t,e){this.name=(null==t?void 0:t.name)||"",this.pluginId=`${this.name}__${(0,m.x0)()}`,this.config=t,this.opts=e}};function T(t){return function(e){return new I(t,e)}}function L(t){var e;let i=null==(e=t.getData(u.Ps))?void 0:e.getFormModel(),r=null==i?void 0:i.nativeFormModel;if(!i||!r)return;let n={initialValues:r.initialValues,get values(){return r.values},state:r.state,getValueIn:t=>r.getValueIn(t),setValueIn:(t,e)=>r.setValueIn(t,e),updateFormValues:t=>{i.updateFormValues(t)},render:()=>y.createElement(u.o,{node:t}),onFormValuesChange:i.onFormValuesChange.bind(i),onFormValueChangeIn:i.onFormValueChangeIn.bind(i),onValidate:i.nativeFormModel.onValidate,validate:i.validate.bind(i)};return Object.defineProperty(n,"_formModel",{enumerable:!1,get:()=>i}),n}},569517:function(t,e,i){i.d(e,{Xm:()=>l,bz:()=>d});var r=i(832176),n=i(893740),s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,a=0,l=Symbol("BackgroundConfig"),h=class extends n.mh{get gridSize(){return this.options.gridSize??20}get dotSize(){return this.options.dotSize??1}get dotColor(){return this.options.dotColor??"#eceeef"}get dotOpacity(){return this.options.dotOpacity??.5}get backgroundColor(){return this.options.backgroundColor??"transparent"}get dotFillColor(){return this.options.dotFillColor??this.dotColor}get logoConfig(){return this.options.logo}get zoom(){return this.config.finalScale}onReady(){let{firstChild:t}=this.pipelineNode;this.pipelineNode.insertBefore(this.node,t),this.playgroundConfigEntity.updateConfig({minZoom:.1,maxZoom:2}),this.grid.style.zIndex="-1",this.grid.style.position="relative",this.node.appendChild(this.grid),this.grid.className="gedit-grid-svg","transparent"!==this.backgroundColor&&(this.node.style.backgroundColor=this.backgroundColor)}getScaleUnit(){let{zoom:t}=this;return{realSize:this.gridSize,renderSize:Math.round(this.gridSize*t*100)/100,zoom:t}}autorun(){let t=this.playgroundConfigEntity.config,e=this.getScaleUnit(),i=10*e.renderSize,s=t.width+2*i,o=t.height+2*i,{scrollX:a}=t,{scrollY:l}=t,h=this.getScrollDelta(a,i),d=this.getScrollDelta(l,i);r.xF.setStyle(this.node,{left:a-n.JW,top:l-n.JW}),this.drawGrid(e,s,o),this.setSVGStyle(this.grid,{width:s,height:o,left:n.JW-h-i,top:n.JW-d-i})}calculateLogoPosition(t,e){if(!this.logoConfig)return{x:0,y:0};let{position:i="center",offset:r={x:0,y:0}}=this.logoConfig,n=this.playgroundConfigEntity.config,s=10*this.getScaleUnit().renderSize,{scrollX:o,scrollY:a}=n,l=this.getScrollDelta(o,s),h=this.getScrollDelta(a,s),d=s+l,u=s+h,c=d+n.width/2,g=u+n.height/2,p=0,f=0;switch(i){case"center":p=c,f=g;break;case"top-left":p=d+100,f=u+100;break;case"top-right":p=d+n.width-100,f=u+100;break;case"bottom-left":p=d+100,f=u+n.height-100;break;case"bottom-right":p=d+n.width-100,f=u+n.height-100}return{x:p+r.x,y:f+r.y}}getLogoSize(){if(!this.logoConfig)return 0;let{size:t="medium"}=this.logoConfig;if("number"==typeof t)return t;switch(t){case"small":return 24;case"medium":default:return 48;case"large":return 72}}hexToRgb(t){let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}adjustBrightness(t,e){let i=this.hexToRgb(t);if(!i)return t;let r=t=>Math.max(0,Math.min(255,Math.round(t+(255-t)*e)));return`#${r(i.r).toString(16).padStart(2,"0")}${r(i.g).toString(16).padStart(2,"0")}${r(i.b).toString(16).padStart(2,"0")}`}generateNeumorphismFilter(t,e,i,r,n,s,o){let a=o?-r:r,l=o?r:-r;return`
      <defs>
        <filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="${a}" dy="${a}" stdDeviation="${n}" flood-color="${e}" flood-opacity="${s}"/>
          <feDropShadow dx="${l}" dy="${l}" stdDeviation="${n}" flood-color="${i}" flood-opacity="${s}"/>
        </filter>
      </defs>`}generateLogoSVG(t,e){if(!this.logoConfig)return"";let{text:i,imageUrl:r,opacity:n=.1,color:s="#cccccc",fontSize:o,fontFamily:a="Arial, sans-serif",fontWeight:l="normal",neumorphism:h}=this.logoConfig,d=this.calculateLogoPosition(t,e),u=this.getLogoSize(),c="";if(r)c=`
        <image
          href="${r}"
          x="${d.x-u/2}"
          y="${d.y-u/2}"
          width="${u}"
          height="${u}"
          opacity="${n}"
        />`;else if(i){let t=o??Math.max(u/2,12);if(null==h?void 0:h.enabled){let{textColor:e,lightShadowColor:r,darkShadowColor:s,shadowOffset:o=6,shadowBlur:u=12,intensity:g=.3,raised:p=!0}=h,f="transparent"!==this.backgroundColor?this.backgroundColor:"#f0f0f0",y=e||f,m=r||this.adjustBrightness(f,.2),E=s||this.adjustBrightness(f,-.2),b=`neumorphism-${this._patternId}`;c+=this.generateNeumorphismFilter(b,m,E,o,u,g,p),c+=`
          <text
            x="${d.x}"
            y="${d.y}"
            font-family="${a}"
            font-size="${t}"
            font-weight="${l}"
            fill="${y}"
            opacity="${n}"
            text-anchor="middle"
            dominant-baseline="middle"
            filter="url(#${b})"
          >${i}</text>`}else c=`
          <text
            x="${d.x}"
            y="${d.y}"
            font-family="${a}"
            font-size="${t}"
            font-weight="${l}"
            fill="${s}"
            opacity="${n}"
            text-anchor="middle"
            dominant-baseline="middle"
          >${i}</text>`}return c}drawGrid(t,e,i){let r=t.renderSize;if(!this.grid)return;let n=this.dotSize*this.zoom,s='<svg width="100%" height="100%">';"transparent"!==this.backgroundColor&&(s+=`<rect width="100%" height="100%" fill="${this.backgroundColor}"/>`);let o=[`cx="${n}"`,`cy="${n}"`,`r="${n}"`,`stroke="${this.dotColor}"`,this.options.dotFillColor&&this.dotFillColor!==this.dotColor?`fill="${this.dotFillColor}"`:"",`fill-opacity="${this.dotOpacity}"`].filter(Boolean).join(" ");s+=`
      <pattern id="${this._patternId}" width="${r}" height="${r}" patternUnits="userSpaceOnUse">
        <circle ${o} />
      </pattern>
      <rect width="100%" height="100%" fill="url(#${this._patternId})"/>`;let a=this.generateLogoSVG(e,i);a&&(s+=a),s+="</svg>",this.grid.innerHTML=s}setSVGStyle(t,e){t&&(t.style.width=`${e.width}px`,t.style.height=`${e.height}px`,t.style.left=`${e.left}px`,t.style.top=`${e.top}px`)}getScrollDelta(t,e){return t>=0?t%e:e-Math.abs(t)%e}constructor(){super(...arguments),this._patternId=`gedit-background-pattern-${a++}`,this.node=r.xF.createDivWithClass("gedit-flow-background-layer"),this.grid=document.createElement("div")}};h.type="WorkflowBackgroundLayer",((t,e,i,r)=>{for(var n,a=r>1?void 0:r?o(e,i):e,l=t.length-1;l>=0;l--)(n=t[l])&&(a=(r?n(e,i,a):n(a))||a);return r&&a&&s(e,i,a)})([(0,n.O0)(n.ER)],h.prototype,"playgroundConfigEntity",2);var d=(0,n.M1)({onBind:(t,e)=>{t.bind(l).toConstantValue(e)},onInit:(t,e)=>{t.playground.registerLayer(h,e)}})},148168:function(t,e,i){i.d(e,{Kg:()=>d,cL:()=>p});var r,n=i(893740),s=i(9163),o=Object.defineProperty,a=Object.getOwnPropertyDescriptor,l=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?a(e,i):e,l=t.length-1;l>=0;l--)(n=t[l])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&o(e,i,s),s},h=Symbol("ShortcutsContribution"),d=class{addHandlers(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(t=>{this.commandRegistry.getCommand(t.commandId)?this.commandRegistry.registerHandler(t.commandId,{execute:t.execute,isEnabled:t.isEnabled}):this.commandRegistry.registerCommand({id:t.commandId,...t.commandDetail||{}},{execute:t.execute,isEnabled:t.isEnabled})}),this.shortcutsHandlers.unshift(...e)}addHandlersIfNotFound(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(t=>{this.has(t.commandId)||this.addHandlers(t)})}has(t){return this.shortcutsHandlers.some(e=>e.commandId===t)}init(){var t;null==(t=this.contribs)||t.forEach(t=>t.registerShortcuts(this))}constructor(){this.shortcutsHandlers=[]}};l([(0,s.f3)(n.Qc),(0,s.t6)(h),(0,s.jt)()],d.prototype,"contribs",2),l([(0,s.f3)(n.Ho)],d.prototype,"commandRegistry",2),l([(0,s.zY)()],d.prototype,"init",1),d=l([(0,s.b2)()],d);var u={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pausebreak:19,capslock:20,esc:27,space:32,pageup:33,pagedown:34,end:35,home:36,leftarrow:37,uparrow:38,rightarrow:39,downarrow:40,insert:45,delete:46,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,leftwindowkey:91,rightwindowkey:92,meta:/(mac|iphone|ipod|ipad)/i.test("undefined"!=typeof navigator?null==(r=navigator)?void 0:r.platform:"")?[91,93]:[91,92],selectkey:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimalpoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,semicolon:186,equalsign:187,"=":187,comma:188,dash:189,"-":189,period:190,forwardslash:191,graveaccent:192,openbracket:219,backslash:220,closebracket:221,singlequote:222},c={ctrl:t=>t.ctrlKey,shift:t=>t.shiftKey,alt:t=>t.altKey,meta:t=>"keyup"===t.type?u.meta.includes(t.keyCode):t.metaKey},g=class extends n.mh{onReady(){this.shortcuts.addHandlersIfNotFound({commandId:n.mY.Default.ZOOM_IN,shortcuts:["meta =","ctrl ="],execute:()=>{this.config.zoomin()}},{commandId:n.mY.Default.ZOOM_OUT,shortcuts:["meta -","ctrl -"],execute:()=>{this.config.zoomout()}}),this.toDispose.pushAll([this.listenPlaygroundEvent("keydown",t=>{this.isFocused&&t.target===this.playgroundNode&&this.shortcuts.shortcutsHandlers.some(e=>{if(e.shortcuts.some(e=>(function(t,e){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(!t.key||!e)return!1;let r=e.split(/\s+/),n=0;for(let e of r){let i=c[e],r=u[e.toLowerCase()];(i&&i(t)||r&&r===t.keyCode)&&n++}return i?n===r.length&&function(t){let e=Object.keys(c).reduce((e,i)=>c[i](t)?e+1:e,0);return[16,17,18,91,92].includes(t.keyCode)?e:e+1}(t)===r.length:n===r.length})(t,e))&&(!e.isEnabled||e.isEnabled(t)))return e.execute(t),t.preventDefault(),!0})})])}};g.type="ShortcutsLayer",l([(0,s.f3)(d)],g.prototype,"shortcuts",2),l([(0,s.f3)(n.z2)],g.prototype,"selection",2),g=l([(0,s.b2)()],g);var p=(0,n.M1)({onBind:t=>{let{bind:e}=t;e(d).toSelf().inSingletonScope(),(0,n.yb)(e,h)},onInit:t=>{t.playground.registerLayer(g)},contributionKeys:[h]})},319428:function(t,e,i){i.d(e,{$Y:()=>tw,$e:()=>tx,$s:()=>X,Gw:()=>o,Hx:()=>j,LF:()=>tM,OI:()=>ty,gJ:()=>tD,i2:()=>tC,qR:()=>a,qm:()=>tS,rV:()=>tN,sX:()=>tb});var r,n,s,o,a,l=i(9163),h=i(149674),d=i(832176),u=i(706493),c=i(666442),g=i(336781),p=i(26302),f=i(492320),y=i(499273),m=i(705999),E=i(314842),b=i(98029),C=i(366418),S=i(322972),D=i(129034),_=i(268479),w=i(923032),x=i(972453),N=i(207074),M=i(928365),I=i(51429),T=i(661195),L=i(582939),P=i(697497),R=i(908600),A=i(893740),k=Object.defineProperty,O=Object.getOwnPropertyDescriptor,V=(t,e,i,r)=>{for(var n,s=r>1?void 0:r?O(e,i):e,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&k(e,i,s),s},B=(t,e)=>(i,r)=>e(i,r,t);function F(t){return d.JT.create(()=>t.unsubscribe())}var z=()=>{let t=new Map,e=(e,i)=>{if(t.has(e))return t.get(e);let r=i();return t.set(e,r),r};return e.clear=e=>{e?t.delete(e):t.clear()},e},G=class{onAnyVariableChange(t){return F(this.anyVariableChange$.subscribe(t))}onVariableListChange(t){return F(this.variables$.subscribe(t))}onListOrAnyVarChange(t){let e=new d.K4;return e.pushAll([this.onVariableListChange(t),this.onAnyVariableChange(t)]),e}fireChange(){var t;this.bumpVersion(),this.onDataChangeEmitter.fire(),this.variables$.next(this.variables),null==(t=this.parentTable)||t.fireChange()}get version(){return this._version}bumpVersion(){this._version=this._version+1,this._version===Number.MAX_SAFE_INTEGER&&(this._version=0)}get variables(){return Array.from(this.table.values())}get variableKeys(){return Array.from(this.table.keys())}getByKeyPath(t){let[e,...i]=t||[];if(!e)return;let r=this.getVariableByKey(e);return i.length?null==r?void 0:r.getByKeyPath(i):r}getVariableByKey(t){return this.table.get(t)}addVariableToTable(t){this.table.set(t.key,t),this.parentTable&&this.parentTable.addVariableToTable(t)}removeVariableFromTable(t){this.table.delete(t),this.parentTable&&this.parentTable.removeVariableFromTable(t)}dispose(){var t;this.variableKeys.forEach(t=>{var e;return null==(e=this.parentTable)?void 0:e.removeVariableFromTable(t)}),null==(t=this.parentTable)||t.fireChange(),this.variables$.complete(),this.variables$.unsubscribe(),this.toDispose.dispose()}constructor(t){this.parentTable=t,this.table=new Map,this.toDispose=new d.K4,this.onDataChangeEmitter=new d.Q5,this.variables$=new h.x,this.anyVariableChange$=this.variables$.pipe((0,u.w)(t=>(0,c.T)(...t.map(t=>t.value$.pipe((0,g.T)(1))))),(0,p.B)()),this.onDataChange=this.onDataChangeEmitter.event,this._version=0,this.toDispose.pushAll([this.onDataChangeEmitter,this.onAnyVariableChange(()=>{this.bumpVersion()})])}},$=Symbol("DynamicVariableEngine"),Y=Symbol("ContainerProvider"),X=class{get variableEngine(){return this.variableEngineProvider()}refreshAllChange(){this.variableEngine.getAllScopes().forEach(t=>{t.refreshCovers(),t.refreshDeps()})}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}get onDispose(){return this.toDispose.onDispose}constructor(){this.toDispose=new d.K4}};V([(0,l.f3)($)],X.prototype,"variableEngineProvider",2),X=V([(0,l.b2)()],X);var j=((r=j||{}).String="String",r.Number="Number",r.Integer="Integer",r.Boolean="Boolean",r.Object="Object",r.Array="Array",r.Map="Map",r.Union="Union",r.Any="Any",r.CustomType="CustomType",r.Property="Property",r.VariableDeclaration="VariableDeclaration",r.VariableDeclarationList="VariableDeclarationList",r.KeyPathExpression="KeyPathExpression",r.EnumerateExpression="EnumerateExpression",r.WrapArrayExpression="WrapArrayExpression",r.ListNode="ListNode",r.DataNode="DataNode",r.MapNode="MapNode",r),J=Symbol("post_construct_ast");function U(t){let{getChildNode:e,updateChildNode:i,removeChildNode:r,nextJSON:n}=t,s=e(),o=(null==s?void 0:s.kind)!==(null==n?void 0:n.kind),a=(null==n?void 0:n.key)&&(null==n?void 0:n.key)!==(null==s?void 0:s.key);if(o||a){if(s&&(s.dispose(),r()),n){let t=this.createChildNode(n);return i(t),this.fireChange(),t}this.fireChange()}else n&&(null==s||s.fromJSON(n));return s}function H(t){return"string"==typeof t?{kind:t}:t}(n=o||(o={})).isString=t=>(null==t?void 0:t.kind)==="String",n.isNumber=t=>(null==t?void 0:t.kind)==="Number",n.isBoolean=t=>(null==t?void 0:t.kind)==="Boolean",n.isInteger=t=>(null==t?void 0:t.kind)==="Integer",n.isObject=t=>(null==t?void 0:t.kind)==="Object",n.isArray=t=>(null==t?void 0:t.kind)==="Array",n.isMap=t=>(null==t?void 0:t.kind)==="Map",n.isCustomType=t=>(null==t?void 0:t.kind)==="CustomType",n.isVariableDeclaration=t=>(null==t?void 0:t.kind)==="VariableDeclaration",n.isProperty=t=>(null==t?void 0:t.kind)==="Property",n.isBaseVariableField=t=>!!(null==t?void 0:t.flags),n.isVariableDeclarationList=t=>(null==t?void 0:t.kind)==="VariableDeclarationList",n.isEnumerateExpression=t=>(null==t?void 0:t.kind)==="EnumerateExpression",n.isWrapArrayExpression=t=>(null==t?void 0:t.kind)==="WrapArrayExpression",n.isKeyPathExpression=t=>(null==t?void 0:t.kind)==="KeyPathExpression",n.is=function(t,e){return(null==t?void 0:t.kind)===(null==e?void 0:e.kind)};var W=class t{get kind(){if(!this.constructor.kind)throw Error(`ASTNode Registry need a kind: ${this.constructor.name}`);return this.constructor.kind}get children(){return Array.from(this._children)}toJSON(){return console.warn("[VariableEngine] Please Implement toJSON method for "+this.kind),{kind:this.kind}}createChildNode(t){let e=this.scope.variableEngine.astRegisters.createAST(t,{parent:this,scope:this.scope});return this._children.add(e),e.toDispose.push(d.JT.create(()=>{this._children.delete(e)})),e}updateChildNodeByKey(t,e){this.withBatchUpdate(U).call(this,{getChildNode:()=>this[t],updateChildNode:e=>this[t]=e,removeChildNode:()=>this[t]=void 0,nextJSON:e})}withBatchUpdate(t){var e=this;return function(){for(var i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];if(e._batch.batching)return t.call(e,...r);e._batch.hasChangesInBatch=!1,e._batch.batching=!0;let s=t.call(e,...r);return e._batch.batching=!1,e._batch.hasChangesInBatch&&e.fireChange(),e._batch.hasChangesInBatch=!1,s}}fireChange(){var t;if(!this.changeLocked&&!this.disposed){if(this._batch.batching){this._batch.hasChangesInBatch=!0;return}this._version++,this.value$.next(this),this.dispatchGlobalEvent({type:"UpdateAST"}),null==(t=this.parent)||t.fireChange()}}get version(){return this._version}get hash(){return`${this._version}${this.kind}${this.key}`}subscribe(e){let{selector:i,debounceAnimation:r,triggerOnInit:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return F(this.value$.pipe((0,y.U)(()=>i?i(this):this),(0,m.x)((t,e)=>(0,_.shallowEqual)(t,e),e=>e instanceof t?e.hash:e),n?(0,E.b)(()=>null):(0,g.T)(1),r?(0,b.b)(0,C.Z):(0,E.b)(()=>null)).subscribe(e))}dispatchGlobalEvent(t){this.scope.event.dispatch({...t,ast:this})}dispose(){this.toDispose.disposed||(this.toDispose.dispose(),this.dispatchGlobalEvent({type:"DisposeAST"}),this.value$.complete(),this.value$.unsubscribe())}get disposed(){return this.toDispose.disposed}constructor({key:t,parent:e,scope:i},r){this.flags=0,this._version=0,this.changeLocked=!1,this._batch={batching:!1,hasChangesInBatch:!1},this.value$=new S.X(this),this._children=new Set,this.toDispose=new d.K4(d.JT.create(()=>{var t;null==(t=this.parent)||t.fireChange(),this.children.forEach(t=>t.dispose())})),this.onDispose=this.toDispose.onDispose,this.scope=i,this.parent=e,this.opts=r,this.key=t||(0,D.x0)(),this.fromJSON=this.withBatchUpdate(this.fromJSON.bind(this))}},K=class extends W{isTypeEqual(t){let e=H(t);if((null==e?void 0:e.kind)==="Union"){var i;return null==(i=(null==e?void 0:e.types)||[])?void 0:i.some(t=>this.isTypeEqual(t))}return this.kind===(null==e?void 0:e.kind)}getByKeyPath(){throw arguments.length>0&&void 0!==arguments[0]&&arguments[0],Error(`Get By Key Path is not implemented for Type: ${this.kind}`)}toJSON(){return{kind:this.kind}}constructor(){super(...arguments),this.flags=8}},Z=class extends K{fromJSON(t){let{items:e}=t;this.updateChildNodeByKey("items",H(e))}get canDrilldownItems(){var t;return!!((null==(t=this.items)?void 0:t.flags)&16)}getByKeyPath(t){let[e,...i]=t||[];if("0"===e&&this.canDrilldownItems)return this.items.getByKeyPath(i)}isTypeEqual(t){let e=H(t),i=super.isTypeEqual(t);return(null==e?void 0:e.weak)||(null==e?void 0:e.kind)==="Union"?i:e&&i&&((null==e?void 0:e.weak)||this.customStrongEqual(e))}customStrongEqual(t){var e;return this.items?null==(e=this.items)?void 0:e.isTypeEqual(t.items):!(null==t?void 0:t.items)}toJSON(){var t;return{kind:"Array",items:null==(t=this.items)?void 0:t.toJSON()}}constructor(){super(...arguments),this.flags=48}};Z.kind="Array";var Q=class extends K{get format(){return this._format}fromJSON(t){(null==t?void 0:t.format)!==this._format&&(this._format=null==t?void 0:t.format,this.fireChange())}constructor(){super(...arguments),this.flags=8}};Q.kind="String";var q=class extends K{fromJSON(){}constructor(){super(...arguments),this.flags=8}};q.kind="Integer";var tt=class extends K{fromJSON(){}};tt.kind="Boolean";var te=class extends K{fromJSON(){}};te.kind="Number";var ti=class extends K{fromJSON(t){let{keyType:e="String",valueType:i}=t;this.updateChildNodeByKey("keyType",H(e)),this.updateChildNodeByKey("valueType",H(i))}isTypeEqual(t){let e=H(t),i=super.isTypeEqual(t);return(null==e?void 0:e.weak)||(null==e?void 0:e.kind)==="Union"?i:e&&i&&((null==e?void 0:e.weak)||this.customStrongEqual(e))}customStrongEqual(t){var e,i;let{keyType:r="String",valueType:n}=t;return(!n&&!this.valueType||(null==(e=this.valueType)?void 0:e.isTypeEqual(n)))&&(null==(i=this.keyType)?void 0:i.isTypeEqual(r))}toJSON(){var t,e;return{kind:"Map",keyType:null==(t=this.keyType)?void 0:t.toJSON(),valueType:null==(e=this.valueType)?void 0:e.toJSON()}}};ti.kind="Map";var tr=class extends K{fromJSON(t){let{properties:e}=t,i=new Set(this.propertyTable.keys()),r=[...this.properties||[]];this.properties=(e||[]).map(t=>{let e=this.propertyTable.get(t.key);if(i.delete(t.key),e)return e.fromJSON(t),e;{let e=this.createChildNode({...t,kind:"Property"});return this.fireChange(),this.propertyTable.set(t.key,e),e}}),i.forEach(t=>{let e=this.propertyTable.get(t);null==e||e.dispose(),this.propertyTable.delete(t),this.fireChange()}),this.dispatchGlobalEvent({type:"ObjectPropertiesChange",payload:{prev:r,next:[...this.properties]}})}toJSON(){return{kind:"Object",properties:this.properties.map(t=>t.toJSON())}}getByKeyPath(t){var e;let[i,...r]=t,n=this.propertyTable.get(i);return r.length?(null==n?void 0:n.type)&&(null==n||null==(e=n.type)?void 0:e.flags)&16?n.type.getByKeyPath(r):void 0:n}isTypeEqual(t){let e=H(t),i=super.isTypeEqual(t);return(null==e?void 0:e.weak)||(null==e?void 0:e.kind)==="Union"?i:e&&i&&((null==e?void 0:e.weak)||this.customStrongEqual(e))}customStrongEqual(t){let e=t.properties||[],i=Array.from(this.propertyTable.keys()),r=e.map(t=>t.key);return!(0,w.Z)(i,r).length&&e.every(t=>{var e;let i=this.propertyTable.get(t.key);return i&&i.key===t.key&&(null==(e=i.type)?void 0:e.isTypeEqual(null==t?void 0:t.type))})}constructor(){super(...arguments),this.flags=16,this.propertyTable=new Map}};tr.kind="Object";var tn=class extends K{get typeName(){return this._typeName}fromJSON(t){this._typeName!==t.typeName&&(this._typeName=t.typeName,this.fireChange())}isTypeEqual(t){let e=H(t);if((null==e?void 0:e.kind)==="Union"){var i;return null==(i=(null==e?void 0:e.types)||[])?void 0:i.some(t=>this.isTypeEqual(t))}return(null==e?void 0:e.kind)===this.kind&&(null==e?void 0:e.typeName)===this.typeName}};function ts(t){let e=t.parent,i=[];for(;e;)1&e.flags&&i.push(e),e=e.parent;return i}tn.kind="CustomType";var to=class extends W{get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}get parentFields(){return ts(this)}get refs(){return this._refs}refreshRefs(){this.refreshRefs$.next()}constructor(t,e){super(t,e),this.flags=4,this._refs=[],this.refreshRefs$=new h.x,this.refs$=this.refreshRefs$.pipe((0,y.U)(()=>this.getRefFields()),(0,m.x)(_.shallowEqual),(0,u.w)(t=>(null==t?void 0:t.length)?(0,N.a)(t.map(t=>t?t.value$:(0,x.of)(void 0))):(0,x.of)([])),(0,p.B)()),this.toDispose.push(F(this.refs$.subscribe(t=>{this._refs=t,this.fireChange()})))}},ta=class extends to{get enumerateFor(){return this._enumerateFor}get returnType(){var t;let e=null==(t=this.enumerateFor)?void 0:t.returnType;if((null==e?void 0:e.kind)==="Array")return e.items}getRefFields(){return[]}fromJSON(t){let{enumerateFor:e}=t;this.updateChildNodeByKey("_enumerateFor",e)}toJSON(){var t;return{kind:"EnumerateExpression",enumerateFor:null==(t=this.enumerateFor)?void 0:t.toJSON()}}};ta.kind="EnumerateExpression";var tl=class extends to{get keyPath(){return this._keyPath}getRefFields(){let t=this.scope.available.getByKeyPath(this._keyPath);return!function(t,e){if(0===(0,M.Z)(t.scope.coverScopes,e.map(t=>null==t?void 0:t.scope).filter(Boolean)).length)return!1;let i=new Set,r=[...e];for(;r.length;){let t=r.shift();for(let e of(i.add(t),(function t(e){return[...e.children,...e.children.map(e=>t(e)).flat()]})(t).filter(t=>4&t.flags).map(t=>t.refs).flat().filter(Boolean).filter(t=>!i.has(t))))r.push(e)}return(0,M.Z)(Array.from(i),ts(t)).length>0}(this,[t])?t?[t]:[]:(console.warn("[CustomKeyPathExpression] checkRefCycle: Reference Cycle Existed",this.parentFields.map(t=>t.key).reverse()),[])}get returnType(){return this._returnType}parseToKeyPath(t){return t.keyPath}fromJSON(t){let e=this.parseToKeyPath(t);(0,_.shallowEqual)(e,this._keyPath)||(this._keyPath=e,this.refreshRefs())}getReturnTypeJSONByRef(t){var e;return null==t||null==(e=t.type)?void 0:e.toJSON()}toJSON(){return{kind:"KeyPathExpression",keyPath:this._keyPath}}constructor(t,e){super(t,e),this._keyPath=[],this.toDispose.pushAll([this.scope.available.onVariableListChange(()=>{this.refreshRefs()}),this.scope.available.onAnyVariableChange(t=>{t.key===this._keyPath[0]&&this.refreshRefs()}),F(this.refs$.subscribe(t=>{var e,i;let[r]=this._refs;this.prevRefTypeHash!==(null==r||null==(e=r.type)?void 0:e.hash)&&(this.prevRefTypeHash=null==r||null==(i=r.type)?void 0:i.hash,this.updateChildNodeByKey("_returnType",this.getReturnTypeJSONByRef(r)))}))])}};tl.kind="KeyPathExpression";var th=class extends to{get wrapFor(){return this._wrapFor}get returnType(){return this._returnType}refreshReturnType(){var t,e;let i=null==(e=this.wrapFor)||null==(t=e.returnType)?void 0:t.toJSON();this.updateChildNodeByKey("_returnType",{kind:"Array",items:i})}getRefFields(){return[]}fromJSON(t){let{wrapFor:e}=t;this.updateChildNodeByKey("_wrapFor",e)}toJSON(){var t;return{kind:"WrapArrayExpression",wrapFor:null==(t=this.wrapFor)?void 0:t.toJSON()}}init(){this.refreshReturnType=this.refreshReturnType.bind(this),this.toDispose.push(this.subscribe(this.refreshReturnType,{selector:t=>{var e;return null==(e=t.wrapFor)?void 0:e.returnType},triggerOnInit:!0}))}};th.kind="WrapArrayExpression",V([(t,e)=>{if(Reflect.hasMetadata(J,t))throw Error("Duplication Post Construct AST");Reflect.defineMetadata(J,e,t)}],th.prototype,"init",1);var td=class extends W{get parentFields(){return ts(this)}get keyPath(){return[...this.parentFields.reverse().map(t=>t.key),this.key]}get meta(){return this._meta}get type(){var t;return(null==(t=this._initializer)?void 0:t.returnType)||this._type}get initializer(){return this._initializer}get hash(){return`[${this._version}]${this.keyPath.join(".")}`}fromJSON(t){let{type:e,initializer:i,meta:r}=t;this.updateType(e),this.updateInitializer(i),this.updateMeta(r)}updateType(t){this.updateChildNodeByKey("_type","string"==typeof t?{kind:t}:t)}updateInitializer(t){this.updateChildNodeByKey("_initializer",t)}updateMeta(t){(0,_.shallowEqual)(t,this._meta)||(this._meta=t,this.fireChange())}getByKeyPath(t){var e;if((null==(e=this.type)?void 0:e.flags)&16)return this.type.getByKeyPath(t)}onTypeChange(t){return this.subscribe(t,{selector:t=>t.type})}toJSON(){var t,e;return{kind:this.kind,key:this.key,type:null==(t=this.type)?void 0:t.toJSON(),initializer:null==(e=this.initializer)?void 0:e.toJSON(),meta:this._meta}}constructor(){super(...arguments),this.flags=1,this._meta={}}},tu=class extends td{get order(){return this._order}fromJSON(t){let{order:e,...i}=t;this.updateOrder(e),super.fromJSON(i)}updateOrder(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;t!==this._order&&(this._order=t,this.dispatchGlobalEvent({type:"ReSortVariableDeclarations"}),this.fireChange())}constructor(t){super(t),this._order=0}};tu.kind="VariableDeclaration";var tc=class extends W{fromJSON(t){let{declarations:e,startOrder:i}=t,r=new Set(this.declarationTable.keys()),n=[...this.declarations||[]];this.declarations=(e||[]).map((t,e)=>{var n,s;let o=(i||0)+e,a=t.key||(null==(s=this.declarations)||null==(n=s[e])?void 0:n.key),l=this.declarationTable.get(a);if(a&&r.delete(a),l)return l.fromJSON({order:o,...t}),l;{let e=this.createChildNode({order:o,...t,kind:"VariableDeclaration"});return this.fireChange(),this.declarationTable.set(e.key,e),e}}),r.forEach(t=>{let e=this.declarationTable.get(t);null==e||e.dispose(),this.declarationTable.delete(t)}),this.dispatchGlobalEvent({type:"VariableListChange",payload:{prev:n,next:[...this.declarations]}})}toJSON(){return{kind:"VariableDeclarationList",declarations:this.declarations.map(t=>t.toJSON())}}constructor(){super(...arguments),this.declarationTable=new Map}};tc.kind="VariableDeclarationList";var tg=class extends td{};tg.kind="Property";var tp=class extends W{get data(){return this._data}fromJSON(t){let{kind:e,...i}=t;(0,_.shallowEqual)(i,this._data)||(this._data=i,this.fireChange())}toJSON(){return{kind:"DataNode",...this._data}}partialUpdate(t){(0,_.shallowEqual)(t,this._data)||(this._data={...this._data,...t},this.fireChange())}};tp.kind="DataNode";var tf=class extends W{fromJSON(t){let{map:e}=t,i=new Set(this.map.keys());for(let[t,r]of e||[])i.delete(t),this.set(t,r);for(let t of Array.from(i))this.remove(t)}toJSON(){return{kind:"MapNode",map:Array.from(this.map.entries())}}set(t,e){return this.withBatchUpdate(U).call(this,{getChildNode:()=>this.get(t),removeChildNode:()=>this.map.delete(t),updateChildNode:e=>this.map.set(t,e),nextJSON:e})}remove(t){var e;null==(e=this.get(t))||e.dispose(),this.map.delete(t),this.fireChange()}get(t){return this.map.get(t)}constructor(){super(...arguments),this.map=new Map}};tf.kind="MapNode";var ty=class{createAST(t,e){let{parent:i,scope:r}=e,n=this.astMap.get(t.kind);if(!n)throw Error(`ASTKind: ${String(t.kind)} can not find its ASTNode Registry`);let s=this.injectors.get(t.kind),o=new n({key:t.key,scope:r,parent:i},(null==s?void 0:s())||{});if(o.changeLocked=!0,o.fromJSON((0,f.Z)(t,["key","kind"])),o.changeLocked=!1,o.dispatchGlobalEvent({type:"NewAST"}),Reflect.hasMetadata(J,o)){var a;let t=Reflect.getMetadata(J,o);null==(a=o[t])||a.call(o)}return o}getASTRegistryByKind(t){return this.astMap.get(t)}registerAST(t,e){this.astMap.set(t.kind,t),e&&this.injectors.set(t.kind,e)}constructor(){this.injectors=new Map,this.astMap=new Map,this.registerAST(Q),this.registerAST(te),this.registerAST(tt),this.registerAST(q),this.registerAST(tr),this.registerAST(Z),this.registerAST(ti),this.registerAST(tn),this.registerAST(tg),this.registerAST(tu),this.registerAST(tc),this.registerAST(tl),this.registerAST(ta),this.registerAST(th),this.registerAST(tf),this.registerAST(tp)}};ty=V([(0,l.b2)()],ty),(s=a||(a={})).createString=t=>({kind:"String",...t||{}}),s.createNumber=()=>({kind:"Number"}),s.createBoolean=()=>({kind:"Boolean"}),s.createInteger=()=>({kind:"Integer"}),s.createObject=t=>({kind:"Object",...t}),s.createArray=t=>({kind:"Array",...t}),s.createMap=t=>({kind:"Map",...t}),s.createUnion=t=>({kind:"Union",...t}),s.createCustomType=t=>({kind:"CustomType",...t}),s.createVariableDeclaration=t=>({kind:"VariableDeclaration",...t}),s.createProperty=t=>({kind:"Property",...t}),s.createVariableDeclarationList=t=>({kind:"VariableDeclarationList",...t}),s.createEnumerateExpression=t=>({kind:"EnumerateExpression",...t}),s.createKeyPathExpression=t=>({kind:"KeyPathExpression",...t}),s.createWrapArrayExpression=t=>({kind:"WrapArrayExpression",...t}),s.create=(t,e)=>({kind:t.kind,...e});var tm=class{get variableEngine(){return this.scope.variableEngine}get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}get version(){return this.variableTable.version}get onDataChange(){return this.variableTable.onDataChange.bind(this.variableTable)}get onVariableListChange(){return this.variableTable.onVariableListChange.bind(this.variableTable)}get onAnyVariableChange(){return this.variableTable.onAnyVariableChange.bind(this.variableTable)}get onListOrAnyVarChange(){return this.variableTable.onListOrAnyVarChange.bind(this.variableTable)}get variables(){return this.memo("variables",()=>this.variableTable.variables.sort((t,e)=>t.order-e.order))}get variableKeys(){return this.memo("variableKeys",()=>this.variableTable.variableKeys)}addVariableToTable(t){if(t.scope!==this.scope)throw Error("VariableDeclaration must be a ast node in scope");this.variableTable.addVariableToTable(t),this._hasChanges=!0}removeVariableFromTable(t){this.variableTable.removeVariableFromTable(t),this._hasChanges=!0}getVariableByKey(t){return this.variableTable.getVariableByKey(t)}notifyCoversChange(){this.scope.coverScopes.forEach(t=>t.available.refresh())}constructor(t){this.scope=t,this.memo=z(),this._hasChanges=!1,this.variableTable=new G(t.variableEngine.globalVariableTable),this.scope.toDispose.pushAll([this.scope.ast.subscribe(()=>{this._hasChanges&&(this.memo.clear(),this.notifyCoversChange(),this.variableTable.fireChange(),this._hasChanges=!1)}),this.scope.event.on("DisposeAST",t=>{var e;(null==(e=t.ast)?void 0:e.kind)==="VariableDeclaration"&&this.removeVariableFromTable(t.ast.key)}),this.scope.event.on("NewAST",t=>{var e;(null==(e=t.ast)?void 0:e.kind)==="VariableDeclaration"&&this.addVariableToTable(t.ast)}),this.scope.event.on("ReSortVariableDeclarations",()=>{this._hasChanges=!0}),this.variableTable])}},tv=class{get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}get version(){return this._version}bumpVersion(){this._version=this._version+1,this._version===Number.MAX_SAFE_INTEGER&&(this._version=0)}refresh(){this.scope.disposed||this.refresh$.next()}onAnyVariableChange(t){return F(this.anyVariableChange$.subscribe(t))}onVariableListChange(t){return F(this.variables$.subscribe(t))}get variables(){return this._variables}get variableKeys(){return this.memo("availableKeys",()=>this._variables.map(t=>t.key))}get depScopes(){return this.scope.depScopes}getByKeyPath(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(this.variableKeys.includes(t[0]))return this.globalVariableTable.getByKeyPath(t)}trackByKeyPath(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,{triggerOnInit:r=!0,debounceAnimation:n,selector:s}=i||{};return F((0,c.T)(this.anyVariableChange$,this.variables$).pipe(r?(0,I.O)():(0,E.b)(()=>null),(0,y.U)(()=>{let e=this.getByKeyPath(t);return s?s(e):e}),(0,m.x)((t,e)=>(0,_.shallowEqual)(t,e),t=>t instanceof W?t.hash:t),n?(0,b.b)(0,C.Z):(0,E.b)(()=>null)).subscribe(e))}constructor(t){this.scope=t,this.memo=z(),this._version=0,this.refresh$=new h.x,this._variables=[],this.variables$=this.refresh$.pipe((0,y.U)(()=>(0,T.Z)(this.depScopes.map(t=>t.output.variables||[]))),(0,m.x)(_.shallowEqual),(0,p.B)()),this.anyVariableChange$=this.variables$.pipe((0,u.w)(t=>(0,c.T)(...t.map(t=>t.value$.pipe((0,g.T)(1))))),(0,p.B)()),this.onDataChangeEmitter=new d.Q5,this.onListOrAnyVarChangeEmitter=new d.Q5,this.onDataChange=this.onDataChangeEmitter.event,this.onListOrAnyVarChange=this.onListOrAnyVarChangeEmitter.event,this.scope.toDispose.pushAll([this.onVariableListChange(t=>{this._variables=t,this.memo.clear(),this.onDataChangeEmitter.fire(this._variables),this.bumpVersion(),this.onListOrAnyVarChangeEmitter.fire(this._variables)}),this.onAnyVariableChange(()=>{this.onDataChangeEmitter.fire(this._variables),this.bumpVersion(),this.onListOrAnyVarChangeEmitter.fire(this._variables)}),d.JT.create(()=>{this.refresh$.complete(),this.refresh$.unsubscribe()})])}},tE=class{dispatch(t){this.scope.disposed||this.event$.next(t)}subscribe(t){return F(this.event$.subscribe(t))}on(t,e){return F(this.event$.pipe((0,L.h)(e=>e.type===t)).subscribe(e))}constructor(t){this.scope=t,this.event$=new h.x,t.toDispose.pushAll([this.subscribe(e=>{t.variableEngine.fireGlobalEvent(e)})])}},tb=class{refreshCovers(){this.memo.clear("covers")}refreshDeps(){this.memo.clear("deps"),this.available.refresh()}get depScopes(){return this.memo("deps",()=>this.variableEngine.chain.getDeps(this).filter(t=>!!t&&!(null==t?void 0:t.disposed)))}get coverScopes(){return this.memo("covers",()=>this.variableEngine.chain.getCovers(this).filter(t=>!!t&&!(null==t?void 0:t.disposed)))}dispose(){this.ast.dispose(),this.toDispose.dispose(),this.coverScopes.forEach(t=>t.refreshDeps()),this.depScopes.forEach(t=>t.refreshCovers())}get disposed(){return this.toDispose.disposed}setVar(t,e){if("string"==typeof t&&void 0!==e)return this.ast.set(t,e);if("object"==typeof t&&void 0===e)return this.ast.set("outputs",t);throw Error("Invalid arguments")}getVar(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return this.ast.get(t)}clearVar(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"outputs";return this.ast.remove(t)}constructor(t){this.memo=z(),this.toDispose=new d.K4,this.onDispose=this.toDispose.onDispose,this.id=t.id,this.meta=t.meta||{},this.variableEngine=t.variableEngine,this.event=new tE(this),this.ast=this.variableEngine.astRegisters.createAST({kind:"MapNode",key:String(this.id)},{scope:this}),this.output=new tm(this),this.available=new tv(this)}},tC=class{get container(){return this.containerProvider()}dispose(){this.toDispose.dispose()}getScopeById(t){return this.scopeMap.get(t)}removeScopeById(t){var e;null==(e=this.getScopeById(t))||e.dispose()}createScope(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{ScopeConstructor:r=tb}=i,n=this.getScopeById(t);return n||(n=new r({variableEngine:this,meta:e,id:t}),this.scopeMap.set(t,n),this.onScopeChangeEmitter.fire({type:"add",scope:n}),n.toDispose.pushAll([n.ast.subscribe(()=>{this.onScopeChangeEmitter.fire({type:"update",scope:n})}),n.available.onDataChange(()=>{this.onScopeChangeEmitter.fire({type:"available",scope:n})})]),n.onDispose(()=>{this.scopeMap.delete(t),this.onScopeChangeEmitter.fire({type:"delete",scope:n})})),n}getAllScopes(){let{sort:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=Array.from(this.scopeMap.values());if(t){let t=this.chain.sortAll(),i=new Set(e);return t.forEach(t=>i.delete(t)),[...t,...Array.from(i)]}return[...e]}fireGlobalEvent(t){this.globalEvent$.next(t)}onGlobalEvent(t,e){return F(this.globalEvent$.subscribe(i=>{i.type===t&&e(i)}))}constructor(t,e){this.chain=t,this.astRegisters=e,this.toDispose=new d.K4,this.memo=z(),this.scopeMap=new Map,this.globalEvent$=new h.x,this.onScopeChangeEmitter=new d.Q5,this.globalVariableTable=new G,this.onScopeChange=this.onScopeChangeEmitter.event,this.toDispose.pushAll([t,d.JT.create(()=>{this.getAllScopes().forEach(t=>t.dispose()),this.globalVariableTable.dispose()})])}};V([(0,l.f3)(Y)],tC.prototype,"containerProvider",2),V([(0,l.Pj)()],tC.prototype,"dispose",1),tC=V([(0,l.b2)(),B(0,(0,l.f3)(X)),B(1,(0,l.f3)(ty))],tC);var tS=class{handleFieldListChange(t,e,i){if(!t||!(null==e?void 0:e.length)||!(null==i?void 0:i.length)||e.length!==i.length)return void this.notifyFieldsDispose(e,i);let r=null,n=!1;for(let[t,a]of e.entries()){let l=i[t];if(a.key!==l.key){var s,o;if(n)return void this.notifyFieldsDispose(e,i);n=!0,(null==(s=a.type)?void 0:s.kind)===(null==(o=l.type)?void 0:o.kind)&&(r={before:a,after:l})}}if(!r)return void this.notifyFieldsDispose(e,i);this.renameEmitter.fire(r)}notifyFieldsDispose(t,e){(0,P.Z)(t||[],e||[]).forEach(t=>this.disposeInListEmitter.fire(t))}init(){this.toDispose.pushAll([this.variableEngine.onGlobalEvent("VariableListChange",t=>{var e,i;this.handleFieldListChange(t.ast,null==(e=t.payload)?void 0:e.prev,null==(i=t.payload)?void 0:i.next)}),this.variableEngine.onGlobalEvent("ObjectPropertiesChange",t=>{var e,i;this.handleFieldListChange(t.ast,null==(e=t.payload)?void 0:e.prev,null==(i=t.payload)?void 0:i.next)})])}dispose(){this.toDispose.dispose()}constructor(){this.toDispose=new d.K4,this.renameEmitter=new d.Q5,this.disposeInListEmitter=new d.Q5,this.onRename=this.renameEmitter.event,this.onDisposeInList=this.disposeInListEmitter.event}};V([(0,l.f3)(tC)],tS.prototype,"variableEngine",2),V([(0,l.zY)()],tS.prototype,"init",1),V([(0,l.Pj)()],tS.prototype,"dispose",1),tS=V([(0,l.b2)()],tS);var tD=new l.nZ(t=>{t(tC).toSelf().inSingletonScope(),t(ty).toSelf().inSingletonScope(),t(tS).toSelf().inSingletonScope(),t($).toDynamicValue(t=>()=>t.container.get(tC)),t(Y).toDynamicValue(t=>()=>t.container)}),t_=(0,R.createContext)(null),tw=t=>{let{scope:e,value:i,children:r}=t,n=e||(null==i?void 0:i.scope);if(!n)throw Error("[ScopeProvider] scope is required");return R.createElement(t_.Provider,{value:{scope:n}},r)},tx=t=>{let{strict:e=!1}=t||{},i=(0,R.useContext)(t_);if(!i){if(e)throw Error("useCurrentScope must be used within a <ScopeProvider scope={scope}>");console.warn("useCurrentScope should be used within a <ScopeProvider scope={scope}>")}return null==i?void 0:i.scope};function tN(t){let{autoRefresh:e=!0}=t||{},i=tx(),r=(0,A.JA)();return(0,R.useEffect)(()=>{if(!e)return()=>null;let t=i.available.onListOrAnyVarChange(()=>{r()});return()=>t.dispose()},[e]),i.available}function tM(){let t=tx(),e=(0,A.G2)(tC),i=(0,A.JA)();return(0,R.useEffect)(()=>{if(!t){let t=e.globalVariableTable.onListOrAnyVarChange(()=>{i()});return()=>t.dispose()}let r=t.available.onDataChange(()=>{i()});return()=>r.dispose()},[]),t?t.available.variables:e.globalVariableTable.variables}}}]);