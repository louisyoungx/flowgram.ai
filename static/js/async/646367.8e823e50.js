"use strict";(self.webpackChunk_flowgram_ai_docs=self.webpackChunk_flowgram_ai_docs||[]).push([["646367"],{558166:function(e,n,r){r.r(n),r.d(n,{default:()=>o});var s=r(110239),i=r(437562),a=r(944529),l=r(852271);function t(e){let n={a:"a",code:"code",div:"div",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",span:"span",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"validatewhenvariablesync",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#validatewhenvariablesync",children:"#"}),"validateWhenVariableSync"]}),"\n",(0,s.jsxs)(n.p,{children:["当字段可访问的变量发生了变化时，则重新触发指定",(0,s.jsx)(n.strong,{children:"错误字段"}),"的校验。"]}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive note",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"为什么是错误字段？"}),(0,s.jsxs)(n.div,{className:"rspress-directive-content",children:[(0,s.jsxs)(n.p,{children:["错误字段的",(0,s.jsx)(n.strong,{children:"错误信息可能源于变量引用的有效性"}),"。"]}),(0,s.jsxs)(n.p,{children:["如果字段的",(0,s.jsx)(n.strong,{children:"可访问变量发生了变化，使得字段的变量引用从无效变为有效"}),"，就需要需要重新校验当前字段，清空之前的错误信息。"]})]})]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"引入前"}),(0,s.jsx)(n.th,{children:"引入后"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsxs)(n.td,{children:[(0,s.jsx)("img",{loading:"lazy",src:"/materials/validate-when-variable-sync-without-effect.gif",alt:"syncVariableTitle 没引入",style:{width:500}})," ",(0,s.jsx)(n.em,{children:"变量从无效变有效，错误信息还在"})]}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)("img",{loading:"lazy",src:"/materials/validate-when-variable-sync-with-effect.gif",alt:"syncVariableTitle 引入",style:{width:500}})," ",(0,s.jsx)(n.em,{children:"变量从无效变有效，错误信息自动清空"})]})]})})]}),"\n",(0,s.jsxs)(n.h2,{id:"案例演示",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#案例演示",children:"#"}),"案例演示"]}),"\n",(0,s.jsxs)(n.h3,{id:"基本使用",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#基本使用",children:"#"}),"基本使用"]}),"\n",(0,s.jsx)(l.w,{}),"\n",(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(n.pre,{className:"shiki css-variables has-highlighted",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",title:"form-meta.tsx",children:(0,s.jsxs)(n.code,{className:"language-tsx",children:[(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" formMeta"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  effect"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    value"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" validateWhenVariableSync"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"()"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  validate"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"    value"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ({ value"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" context }) "}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"      validateFlowValue"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(value"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        node"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" context"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".node"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        errorMessages"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"          unknownVariable"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" 'Unknown Variable'"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"        }"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"      })"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,s.jsx)(n.span,{className:"line",children:(0,s.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"};"})})]})})}),"\n",(0,s.jsxs)(n.h2,{id:"api-参考",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#api-参考",children:"#"}),"API 参考"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"validateWhenVariableSync(options?: { scope?: 'private' | 'public' })"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"参数"}),(0,s.jsx)(n.th,{children:"类型"}),(0,s.jsx)(n.th,{children:"说明"}),(0,s.jsx)(n.th,{children:"默认值"}),(0,s.jsx)(n.th,{children:"是否必选"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"options.scope"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"'private' | 'public'"})}),(0,s.jsx)(n.td,{children:"变量作用域类型，指定监听私有还是公共变量的变化"}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"否"})]})})]}),"\n",(0,s.jsxs)(n.h2,{id:"源码导读",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#源码导读",children:"#"}),"源码导读"]}),"\n",(0,s.jsx)(a.ZB,{href:"https://github.com/bytedance/flowgram.ai/tree/main/packages/materials/form-materials/src/effects/validate-when-variable-sync/index.ts"}),"\n",(0,s.jsx)(n.p,{children:"使用 CLI 命令可以复制源代码到本地："}),"\n",(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(n.pre,{className:"shiki css-variables has-highlighted",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",children:(0,s.jsx)(n.code,{className:"language-bash",children:(0,s.jsxs)(n.span,{className:"line",children:[(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"npx"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:" @flowgram.ai/cli@latest"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:" materials"}),(0,s.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:" effects/validate-when-variable-sync"})]})})})}),"\n",(0,s.jsxs)(n.h3,{id:"目录结构讲解",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#目录结构讲解",children:"#"}),"目录结构讲解"]}),"\n",(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(n.pre,{className:"shiki css-variables has-highlighted",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",children:(0,s.jsxs)(n.code,{className:"language-txt",children:[(0,s.jsx)(n.span,{className:"line",children:(0,s.jsx)(n.span,{children:"packages/materials/form-materials/src/effects/validate-when-variable-sync/"})}),"\n",(0,s.jsx)(n.span,{className:"line",children:(0,s.jsx)(n.span,{children:"└── index.ts           # 核心实现和导出"})})]})})}),"\n",(0,s.jsxs)(n.h3,{id:"核心实现说明",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#核心实现说明",children:"#"}),"核心实现说明"]}),"\n",(0,s.jsx)(n.p,{children:"该效果通过监听字段可访问的变量变化，当变量发生变化时自动触发错误字段的校验，确保当变量引用从无效变为有效时能及时清除错误信息。"}),"\n",(0,s.jsx)(n.p,{children:"主要流程："}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["监听表单初始化事件 ",(0,s.jsx)(n.code,{children:"DataEvent.onValueInit"})]}),"\n",(0,s.jsx)(n.li,{children:"根据配置获取对应的节点作用域（私有或公共）"}),"\n",(0,s.jsxs)(n.li,{children:["监听作用域中可用变量的变化事件 ",(0,s.jsx)(n.code,{children:"available.onListOrAnyVarChange"})]}),"\n",(0,s.jsx)(n.li,{children:"当变量变化时，筛选出包含当前字段名称的错误字段"}),"\n",(0,s.jsx)(n.li,{children:"对筛选出的错误字段重新进行校验"}),"\n",(0,s.jsx)(n.li,{children:"返回清理函数以释放事件监听器"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"依赖梳理",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#依赖梳理",children:"#"}),"依赖梳理"]}),"\n",(0,s.jsxs)(n.h4,{id:"flowgram-api",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#flowgram-api",children:"#"}),"flowgram API"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/bytedance/flowgram.ai/tree/main/packages/variable-engine/variable-core",rel:"noopener noreferrer",target:"_blank",children:(0,s.jsx)(n.strong,{children:"@flowgram.ai/variable-core"})})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"scope.available.onListOrAnyVarChange"}),": 监听作用域中可用变量的变化事件"]}),"\n"]})]})}function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(t,{...e})}):t(e)}o.__RSPRESS_PAGE_META={},o.__RSPRESS_PAGE_META["zh%2Fmaterials%2Feffects%2Fvalidate-when-variable-sync.mdx"]={toc:[{id:"案例演示",text:"案例演示",depth:2},{id:"基本使用",text:"基本使用",depth:3},{id:"api-参考",text:"API 参考",depth:2},{id:"源码导读",text:"源码导读",depth:2},{id:"目录结构讲解",text:"目录结构讲解",depth:3},{id:"核心实现说明",text:"核心实现说明",depth:3},{id:"依赖梳理",text:"依赖梳理",depth:3},{id:"flowgram-api",text:"flowgram API",depth:4}],title:"validateWhenVariableSync",headingTitle:"validateWhenVariableSync",frontmatter:{}}},852271:function(e,n,r){r.d(n,{w:()=>h});var s=r(110239),i=r(908600),a=r(640898),l=r(183173),t=r(38643),o=r(653378),c=r(132288);let d=i.lazy(()=>Promise.all([r.e("386212"),r.e("227692"),r.e("933451"),r.e("942362"),r.e("254129"),r.e("135691"),r.e("46854"),r.e("378665"),r.e("990987")]).then(r.bind(r,129148)).then(e=>({default:e.DynamicValueInput}))),h=()=>(0,s.jsx)(c.y,{filterEndNode:!0,transformInitialNode:{custom_0:e=>(e.data.value={type:"ref",content:["start_0","query"]},e)},formMeta:{effect:{value:(0,l.S)()},validate:{value:e=>{let{value:n,context:r}=e;return(0,t.W)(n,{node:r.node,errorMessages:{unknownVariable:"Unknown Variable"}})}},render:e=>{let{form:n}=e;return(0,i.useEffect)(()=>{n.validate()},[]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.p,{}),(0,s.jsx)("b",{children:"Add 'query' in Start"}),(0,s.jsx)(a.gNt,{name:"value",children:e=>{var n;let{field:r,fieldState:i}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(d,{value:r.value,onChange:e=>r.onChange(e)}),(0,s.jsx)("span",{style:{color:"red"},children:null==(n=i.errors)?void 0:n.map(e=>e.message).join("\n")})]})}}),(0,s.jsx)("br",{}),(0,s.jsx)(o.Button,{onClick:()=>n.validate(),children:"Trigger Validate"})]})}}})},132288:function(e,n,r){r.d(n,{p:()=>l,y:()=>t});var s=r(110239),i=r(908600);let a=i.lazy(()=>Promise.all([r.e("386212"),r.e("133914"),r.e("227692"),r.e("933451"),r.e("254129"),r.e("428647"),r.e("135691"),r.e("46854"),r.e("690536")]).then(r.bind(r,654296)).then(e=>({default:e.FreeFormMetaStoryBuilder}))),l=i.lazy(()=>Promise.all([r.e("386212"),r.e("133914"),r.e("227692"),r.e("933451"),r.e("254129"),r.e("428647"),r.e("135691"),r.e("46854"),r.e("690536")]).then(r.bind(r,654296)).then(e=>({default:e.FormHeader}))),t=e=>(0,s.jsx)("div",{style:{position:"relative",height:e.height||400},children:(0,s.jsx)(a,{...e})})},183173:function(e,n,r){r.d(n,{S:()=>i});var s=r(950454);let i=function(){let{scope:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return[{event:s.zEJ.onValueInit,effect:n=>{let{context:r,form:i,name:a}=n,l=("private"===e?(0,s.u$R)(r.node):(0,s.k6H)(r.node)).available.onListOrAnyVarChange(()=>{Object.entries(i.state.errors||{}).filter(e=>{let[n,r]=e;return(null==r?void 0:r.length)>0}).filter(e=>{let[n]=e;return n.startsWith(a)||a.startsWith(n)}).map(e=>{let[n]=e;return n}).length>0&&i.validate()});return()=>l.dispose()}}]}},687252:function(e,n,r){r.d(n,{U:()=>s});var s,i=r(111886),a=r(13721),l=r(721855),t=r(325486),o=r(937643),c=r(123387);let d=c.ZP.object({index:c.ZP.number().optional()}).optional(),h=c.ZP.object({type:c.ZP.literal("constant"),content:c.ZP.any().optional(),schema:c.ZP.any().optional(),extra:d}),x=c.ZP.object({type:c.ZP.literal("ref"),content:c.ZP.array(c.ZP.string()).optional(),extra:d}),p=c.ZP.object({type:c.ZP.literal("expression"),content:c.ZP.string().optional(),extra:d}),j=c.ZP.object({type:c.ZP.literal("template"),content:c.ZP.string().optional(),extra:d});!function(e){function n(e){return h.safeParse(e).success}function r(e){return x.safeParse(e).success}function s(e){return p.safeParse(e).success}function c(e){return j.safeParse(e).success}function d(e){return(null==e?void 0:e.schema)?e.schema:"string"==typeof e.content?{type:"string"}:"number"==typeof e.content?{type:"number"}:"boolean"==typeof e.content?{type:"boolean"}:(0,t.Z)(e.content)?{type:"object"}:void 0}e.isConstant=n,e.isRef=r,e.isExpression=s,e.isTemplate=c,e.isConstantOrRef=function(e){return n(e)||r(e)},e.isFlowValue=function(e){return n(e)||r(e)||s(e)||c(e)},e.traverse=function* e(l,t){let{includeTypes:o=["ref","template","expression","constant"],path:d="",pathArr:h=[]}=t||{};if((0,i.Z)(l)){if(r(l)&&o.includes("ref")||c(l)&&o.includes("template")||s(l)&&o.includes("expression")||n(l)&&o.includes("constant"))return void(yield{value:l,path:d,pathArr:h});for(let[n,r]of Object.entries(l))yield*e(r,{...t,path:d?`${d}.${n}`:n,pathArr:[...h,n]});return}if((0,a.Z)(l))for(let[n,r]of l.entries())yield*e(r,{...t,path:d?`${d}[${n}]`:`[${n}]`,pathArr:[...h,`[${n}]`]})},e.getTemplateKeyPaths=function(e){var n;return(0,l.Z)((null==(n=e.content)?void 0:n.match(/\{\{([^\}\{]+)\}\}/g))||[]).map(e=>e.slice(2,-2).split("."))},e.inferConstantJsonSchema=d,e.inferJsonSchema=function e(s,a){if((0,i.Z)(s)){if(n(s))return d(s);if(r(s)){let e=a.available.getByKeyPath(null==s?void 0:s.content);return(null==e?void 0:e.type)?o.Kz.astToSchema(null==e?void 0:e.type):void 0}return c(s)?{type:"string"}:{type:"object",properties:Object.keys(s).reduce((n,r)=>{let i=e(s[r],a);return i&&(n[r]=i),n},{})}}}}(s||(s={}))},38643:function(e,n,r){r.d(n,{W:()=>l});var s=r(863875),i=r(950454),a=r(687252);function l(e,n){let{node:r,required:l,errorMessages:t}=n,{required:o="Field is required",unknownVariable:c="Unknown Variable"}=t||{};if(l&&((0,s.Z)(e)||(0,s.Z)(null==e?void 0:e.content)||(null==e?void 0:e.content)===""))return{level:i.Odm.Error,message:o};if((null==e?void 0:e.type)==="ref"&&!(0,i.k6H)(r).available.getByKeyPath((null==e?void 0:e.content)||[]))return{level:i.Odm.Error,message:c};if((null==e?void 0:e.type)==="template"){for(let n of a.U.getTemplateKeyPaths(e))if(!(0,i.k6H)(r).available.getByKeyPath(n))return{level:i.Odm.Error,message:c}}}}}]);