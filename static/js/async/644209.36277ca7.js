/*! For license information please see 644209.36277ca7.js.LICENSE.txt */
(self.webpackChunk_flowgram_ai_docs=self.webpackChunk_flowgram_ai_docs||[]).push([["644209"],{636345:function(e,t,r){"use strict";e=r.nmd(e);let a=(e=0)=>t=>`\u001B[${38+e};5;${t}m`,i=(e=0)=>(t,r,a)=>`\u001B[${38+e};2;${t};${r};${a}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){let e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};for(let[r,a]of(t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright,Object.entries(t))){for(let[r,i]of Object.entries(a))t[r]={open:`\u001B[${i[0]}m`,close:`\u001B[${i[1]}m`},a[r]=t[r],e.set(i[0],i[1]);Object.defineProperty(t,r,{value:a,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="\x1b[39m",t.bgColor.close="\x1b[49m",t.color.ansi256=a(),t.color.ansi16m=i(),t.bgColor.ansi256=a(10),t.bgColor.ansi16m=i(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{let t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map(e=>e+e).join(""));let a=Number.parseInt(r,16);return[a>>16&255,a>>8&255,255&a]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},392279:function(e,t){"use strict";t.byteLength=function(e){var t=l(e),r=t[0],a=t[1];return(r+a)*3/4-a},t.toByteArray=function(e){var t,r,n=l(e),s=n[0],o=n[1],u=new i((s+o)*3/4-o),c=0,d=o>0?s-4:s;for(r=0;r<d;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,u[c++]=255&t),1===o&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,a=e.length,i=a%3,n=[],s=0,o=a-i;s<o;s+=16383)n.push(function(e,t,a){for(var i,n=[],s=t;s<a;s+=3)i=(e[s]<<16&0xff0000)+(e[s+1]<<8&65280)+(255&e[s+2]),n.push(r[i>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i]);return n.join("")}(e,s,s+16383>o?o:s+16383));return 1===i?n.push(r[(t=e[a-1])>>2]+r[t<<4&63]+"=="):2===i&&n.push(r[(t=(e[a-2]<<8)+e[a-1])>>10]+r[t>>4&63]+r[t<<2&63]+"="),n.join("")};for(var r=[],a=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,o=n.length;s<o;++s)r[s]=n[s],a[n.charCodeAt(s)]=s;function l(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var a=r===t?0:4-r%4;return[r,a]}a[45]=62,a[95]=63},89151:function(e){"use strict";let t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,a=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,n=/[_.\- ]+/,s=RegExp("^"+n.source),o=RegExp(n.source+i.source,"gu"),l=RegExp("\\d+"+i.source,"gu"),u=(e,i)=>{var n,u;if(!("string"==typeof e||Array.isArray(e)))throw TypeError("Expected the input to be `string | string[]`");if(i={pascalCase:!1,preserveConsecutiveUppercase:!1,...i},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";let c=!1===i.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(i.locale),d=!1===i.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(i.locale);return 1===e.length?i.pascalCase?d(e):c(e):((e!==c(e)&&(e=((e,a,i)=>{let n=!1,s=!1,o=!1;for(let l=0;l<e.length;l++){let u=e[l];n&&t.test(u)?(e=e.slice(0,l)+"-"+e.slice(l),n=!1,o=s,s=!0,l++):s&&o&&r.test(u)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=s,s=!1,n=!0):(n=a(u)===u&&i(u)!==u,o=s,s=i(u)===u&&a(u)!==u)}return e})(e,c,d)),e=e.replace(s,""),i.preserveConsecutiveUppercase)?(n=e,a.lastIndex=0,e=n.replace(a,e=>c(e))):e=c(e),i.pascalCase&&(e=d(e.charAt(0))+e.slice(1)),u=e,o.lastIndex=0,l.lastIndex=0,u.replace(o,(e,t)=>d(t)).replace(l,e=>d(e)))};e.exports=u,e.exports.default=u},822227:function(e){"use strict";e.exports=function(e,t){if("string"!=typeof e)throw TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},504303:function(e){"use strict";var t=Object.prototype.hasOwnProperty,r="~";function a(){}function i(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function n(e,t,a,n,s){if("function"!=typeof a)throw TypeError("The listener must be a function");var o=new i(a,n||e,s),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(r=!1)),o.prototype.eventNames=function(){var e,a,i=[];if(0===this._eventsCount)return i;for(a in e=this._events)t.call(e,a)&&i.push(r?a.slice(1):a);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=r?r+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var i=0,n=a.length,s=Array(n);i<n;i++)s[i]=a[i].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,a=this._events[t];return a?a.fn?1:a.length:0},o.prototype.emit=function(e,t,a,i,n,s){var o=r?r+e:e;if(!this._events[o])return!1;var l,u,c=this._events[o],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,a),!0;case 4:return c.fn.call(c.context,t,a,i),!0;case 5:return c.fn.call(c.context,t,a,i,n),!0;case 6:return c.fn.call(c.context,t,a,i,n,s),!0}for(u=1,l=Array(d-1);u<d;u++)l[u-1]=arguments[u];c.fn.apply(c.context,l)}else{var h,p=c.length;for(u=0;u<p;u++)switch(c[u].once&&this.removeListener(e,c[u].fn,void 0,!0),d){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,t);break;case 3:c[u].fn.call(c[u].context,t,a);break;case 4:c[u].fn.call(c[u].context,t,a,i);break;default:if(!l)for(h=1,l=Array(d-1);h<d;h++)l[h-1]=arguments[h];c[u].fn.apply(c[u].context,l)}}return!0},o.prototype.on=function(e,t,r){return n(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return n(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,a,i){var n=r?r+e:e;if(!this._events[n])return this;if(!t)return s(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||i&&!o.once||a&&o.context!==a||s(this,n);else{for(var l=0,u=[],c=o.length;l<c;l++)(o[l].fn!==t||i&&!o[l].once||a&&o[l].context!==a)&&u.push(o[l]);u.length?this._events[n]=1===u.length?u[0]:u:s(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},772610:function(e){"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},350709:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let a=r(504303),i=r(388763),n=r(85771),s=()=>{},o=new i.TimeoutError;t.default=class extends a{constructor(e){var t,r,a,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:n.default},e)).intervalCap&&e.intervalCap>=1))throw TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!=(r=null==(t=e.intervalCap)?void 0:t.toString())?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!=(i=null==(a=e.interval)?void 0:a.toString())?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(void 0===this._intervalId){let t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let n=async()=>{this._pendingCount++,this._intervalCount++;try{let n=void 0===this._timeout&&void 0===t.timeout?e():i.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&a(o)});r(await n)}catch(e){a(e)}this._next()};this._queue.enqueue(n,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused&&(this._isPaused=!1,this._processQueue()),this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},991847:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let a=0,i=e.length;for(;i>0;){let n=i/2|0,s=a+n;0>=r(e[s],t)?(a=++s,i-=n+1):i=n}return a}},85771:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let a=r(991847);t.default=class{constructor(){this._queue=[]}enqueue(e,t){let r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);let i=a.default(this._queue,r,(e,t)=>t.priority-e.priority);this._queue.splice(i,0,r)}dequeue(){let e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},750980:function(e,t,r){"use strict";let a=r(92701),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class n extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}let s=(e,t)=>new Promise((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};let o=a.operation(t);o.attempt(async a=>{try{r(await e(a))}catch(e){if(!(e instanceof Error))return void s(TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof n)o.stop(),s(e.originalError);else{let r;if(e instanceof TypeError&&(r=e.message,!i.includes(r)))o.stop(),s(e);else{((e,t,r)=>{let a=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=a})(e,a,t);try{await t.onFailedAttempt(e)}catch(e){s(e);return}o.retry(e)||s(o.mainError())}}}})});e.exports=s,e.exports.default=s,e.exports.AbortError=n},388763:function(e,t,r){"use strict";let a=r(772610);class i extends Error{constructor(e){super(e),this.name="TimeoutError"}}let n=(e,t,r)=>new Promise((n,s)=>{if("number"!=typeof t||t<0)throw TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void n(e);let o=setTimeout(()=>{if("function"==typeof r){try{n(r())}catch(e){s(e)}return}let a="string"==typeof r?r:`Promise timed out after ${t} milliseconds`,o=r instanceof Error?r:new i(a);"function"==typeof e.cancel&&e.cancel(),s(o)},t);a(e.then(n,s),()=>{clearTimeout(o)})});e.exports=n,e.exports.default=n,e.exports.TimeoutError=i},92701:function(e,t,r){e.exports=r(311997)},311997:function(e,t,r){var a=r(969165);t.operation=function(e){return new a(t.timeouts(e),{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<t.retries;i++)a.push(this.createTimeout(i,t));return e&&e.forever&&!a.length&&a.push(this.createTimeout(i,t)),a.sort(function(e,t){return e-t}),a},t.createTimeout=function(e,t){var r=Math.round((t.randomize?Math.random()+1:1)*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,r,a){if(r instanceof Array&&(a=r,r=null),!a)for(var i in a=[],e)"function"==typeof e[i]&&a.push(i);for(var n=0;n<a.length;n++){var s=a[n],o=e[s];e[s]=(function(a){var i=t.operation(r),n=Array.prototype.slice.call(arguments,1),s=n.pop();n.push(function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),s.apply(this,arguments))}),i.attempt(function(){a.apply(e,n)})}).bind(e,o),e[s].options=r}}},969165:function(e){function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r)if(!this._cachedTimeouts)return!1;else this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);var a=this;return this._timer=setTimeout(function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout(function(){a._operationTimeoutCb(a._attempts)},a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var i=this._errors[a],n=i.message,s=(e[n]||0)+1;e[n]=s,s>=r&&(t=i,r=s)}return t}},893836:function(e,t,r){let a=Symbol("SemVer ANY");class i{static get ANY(){return a}constructor(e,t){if(t=n(t),e instanceof i)if(!!t.loose===e.loose)return e;else e=e.value;u("comparator",e=e.trim().split(/\s+/).join(" "),t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===a?this.value="":this.value=this.operator+this.semver.version,u("comp",this)}parse(e){let t=this.options.loose?s[o.COMPARATORLOOSE]:s[o.COMPARATOR],r=e.match(t);if(!r)throw TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new c(r[2],this.options.loose):this.semver=a}toString(){return this.value}test(e){if(u("Comparator.test",e,this.options.loose),this.semver===a||e===a)return!0;if("string"==typeof e)try{e=new c(e,this.options)}catch(e){return!1}return l(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof i))throw TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=n(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||l(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||l(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">"))}}e.exports=i;let n=r(744293),{safeRe:s,t:o}=r(870032),l=r(531400),u=r(826185),c=r(671336),d=r(54816)},54816:function(e,t,r){let a=/\s+/g;class i{constructor(e,t){if(t=s(t),e instanceof i)if(!!t.loose===e.loose&&!!t.includePrerelease===e.includePrerelease)return e;else return new i(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(a," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1){for(let e of this.set)if(1===e.length&&b(e[0])){this.set=[e];break}}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,r=n.get(t);if(r)return r;let a=this.options.loose,i=a?c[d.HYPHENRANGELOOSE]:c[d.HYPHENRANGE];l("hyphen replace",e=e.replace(i,I(this.options.includePrerelease))),l("comparator trim",e=e.replace(c[d.COMPARATORTRIM],h)),l("tilde trim",e=e.replace(c[d.TILDETRIM],p)),l("caret trim",e=e.replace(c[d.CARETTRIM],f));let s=e.split(" ").map(e=>v(e,this.options)).join(" ").split(/\s+/).map(e=>P(e,this.options));a&&(s=s.filter(e=>(l("loose invalid filter",e,this.options),!!e.match(c[d.COMPARATORLOOSE])))),l("range list",s);let u=new Map;for(let e of s.map(e=>new o(e,this.options))){if(y(e))return[e];u.set(e.value,e)}u.size>1&&u.has("")&&u.delete("");let b=[...u.values()];return n.set(t,b),b}intersects(e,t){if(!(e instanceof i))throw TypeError("a Range is required");return this.set.some(r=>_(r,t)&&e.set.some(e=>_(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(j(this.set[t],e,this.options))return!0;return!1}}e.exports=i;let n=new(r(261686)),s=r(744293),o=r(893836),l=r(826185),u=r(671336),{safeRe:c,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=r(870032),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=r(926996),y=e=>"<0.0.0-0"===e.value,b=e=>""===e.value,_=(e,t)=>{let r=!0,a=e.slice(),i=a.pop();for(;r&&a.length;)r=a.every(e=>i.intersects(e,t)),i=a.pop();return r},v=(e,t)=>(l("comp",e,t),l("caret",e=x(e,t)),l("tildes",e=E(e,t)),l("xrange",e=A(e,t)),l("stars",e=k(e,t)),e),w=e=>!e||"x"===e.toLowerCase()||"*"===e,E=(e,t)=>e.trim().split(/\s+/).map(e=>O(e,t)).join(" "),O=(e,t)=>{let r=t.loose?c[d.TILDELOOSE]:c[d.TILDE];return e.replace(r,(t,r,a,i,n)=>{let s;return l("tilde",e,t,r,a,i,n),w(r)?s="":w(a)?s=`>=${r}.0.0 <${+r+1}.0.0-0`:w(i)?s=`>=${r}.${a}.0 <${r}.${+a+1}.0-0`:n?(l("replaceTilde pr",n),s=`>=${r}.${a}.${i}-${n} <${r}.${+a+1}.0-0`):s=`>=${r}.${a}.${i} <${r}.${+a+1}.0-0`,l("tilde return",s),s})},x=(e,t)=>e.trim().split(/\s+/).map(e=>$(e,t)).join(" "),$=(e,t)=>{l("caret",e,t);let r=t.loose?c[d.CARETLOOSE]:c[d.CARET],a=t.includePrerelease?"-0":"";return e.replace(r,(t,r,i,n,s)=>{let o;return l("caret",e,t,r,i,n,s),w(r)?o="":w(i)?o=`>=${r}.0.0${a} <${+r+1}.0.0-0`:w(n)?o="0"===r?`>=${r}.${i}.0${a} <${r}.${+i+1}.0-0`:`>=${r}.${i}.0${a} <${+r+1}.0.0-0`:s?(l("replaceCaret pr",s),o="0"===r?"0"===i?`>=${r}.${i}.${n}-${s} <${r}.${i}.${+n+1}-0`:`>=${r}.${i}.${n}-${s} <${r}.${+i+1}.0-0`:`>=${r}.${i}.${n}-${s} <${+r+1}.0.0-0`):(l("no pr"),o="0"===r?"0"===i?`>=${r}.${i}.${n}${a} <${r}.${i}.${+n+1}-0`:`>=${r}.${i}.${n}${a} <${r}.${+i+1}.0-0`:`>=${r}.${i}.${n} <${+r+1}.0.0-0`),l("caret return",o),o})},A=(e,t)=>(l("replaceXRanges",e,t),e.split(/\s+/).map(e=>S(e,t)).join(" ")),S=(e,t)=>{e=e.trim();let r=t.loose?c[d.XRANGELOOSE]:c[d.XRANGE];return e.replace(r,(r,a,i,n,s,o)=>{l("xRange",e,r,a,i,n,s,o);let u=w(i),c=u||w(n),d=c||w(s);return"="===a&&d&&(a=""),o=t.includePrerelease?"-0":"",u?r=">"===a||"<"===a?"<0.0.0-0":"*":a&&d?(c&&(n=0),s=0,">"===a?(a=">=",c?(i=+i+1,n=0):n=+n+1,s=0):"<="===a&&(a="<",c?i=+i+1:n=+n+1),"<"===a&&(o="-0"),r=`${a+i}.${n}.${s}${o}`):c?r=`>=${i}.0.0${o} <${+i+1}.0.0-0`:d&&(r=`>=${i}.${n}.0${o} <${i}.${+n+1}.0-0`),l("xRange return",r),r})},k=(e,t)=>(l("replaceStars",e,t),e.trim().replace(c[d.STAR],"")),P=(e,t)=>(l("replaceGTE0",e,t),e.trim().replace(c[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),I=e=>(t,r,a,i,n,s,o,l,u,c,d,h)=>(r=w(a)?"":w(i)?`>=${a}.0.0${e?"-0":""}`:w(n)?`>=${a}.${i}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`,l=w(u)?"":w(c)?`<${+u+1}.0.0-0`:w(d)?`<${u}.${+c+1}.0-0`:h?`<=${u}.${c}.${d}-${h}`:e?`<${u}.${c}.${+d+1}-0`:`<=${l}`,`${r} ${l}`.trim()),j=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(l(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){let a=e[r].semver;if(a.major===t.major&&a.minor===t.minor&&a.patch===t.patch)return!0}return!1}return!0}},671336:function(e,t,r){let a=r(826185),{MAX_LENGTH:i,MAX_SAFE_INTEGER:n}=r(926996),{safeRe:s,t:o}=r(870032),l=r(744293),{compareIdentifiers:u}=r(610451);class c{constructor(e,t){if(t=l(t),e instanceof c)if(!!t.loose===e.loose&&!!t.includePrerelease===e.includePrerelease)return e;else e=e.version;else if("string"!=typeof e)throw TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>i)throw TypeError(`version is longer than ${i} characters`);a("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let r=e.trim().match(t.loose?s[o.LOOSE]:s[o.FULL]);if(!r)throw TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>n||this.major<0)throw TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){let t=+e;if(t>=0&&t<n)return t}return e}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(a("SemVer.compare",this.version,this.options,e),!(e instanceof c)){if("string"==typeof e&&e===this.version)return 0;e=new c(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof c||(e=new c(e,this.options)),u(this.major,e.major)||u(this.minor,e.minor)||u(this.patch,e.patch)}comparePre(e){if(e instanceof c||(e=new c(e,this.options)),this.prerelease.length&&!e.prerelease.length)return -1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let r=this.prerelease[t],i=e.prerelease[t];if(a("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return -1;else if(r===i)continue;else return u(r,i)}while(++t)}compareBuild(e){e instanceof c||(e=new c(e,this.options));let t=0;do{let r=this.build[t],i=e.build[t];if(a("build compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return -1;else if(r===i)continue;else return u(r,i)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":(0!==this.minor||0!==this.patch||0===this.prerelease.length)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(0!==this.patch||0===this.prerelease.length)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{let e=+!!Number(r);if(!t&&!1===r)throw Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let a=this.prerelease.length;for(;--a>=0;)"number"==typeof this.prerelease[a]&&(this.prerelease[a]++,a=-2);if(-1===a){if(t===this.prerelease.join(".")&&!1===r)throw Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let a=[t,e];!1===r&&(a=[t]),0===u(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=c},772363:function(e,t,r){let a=r(611054);e.exports=(e,t)=>{let r=a(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},531400:function(e,t,r){let a=r(353327),i=r(145812),n=r(990851),s=r(707701),o=r(133287),l=r(965136);e.exports=(e,t,r,u)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return a(e,r,u);case"!=":return i(e,r,u);case">":return n(e,r,u);case">=":return s(e,r,u);case"<":return o(e,r,u);case"<=":return l(e,r,u);default:throw TypeError(`Invalid operator: ${t}`)}}},657298:function(e,t,r){let a=r(671336),i=r(611054),{safeRe:n,t:s}=r(870032);e.exports=(e,t)=>{if(e instanceof a)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){let a,i=t.includePrerelease?n[s.COERCERTLFULL]:n[s.COERCERTL];for(;(a=i.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&a.index+a[0].length===r.index+r[0].length||(r=a),i.lastIndex=a.index+a[1].length+a[2].length;i.lastIndex=-1}else r=e.match(t.includePrerelease?n[s.COERCEFULL]:n[s.COERCE]);if(null===r)return null;let o=r[2],l=r[3]||"0",u=r[4]||"0",c=t.includePrerelease&&r[5]?`-${r[5]}`:"",d=t.includePrerelease&&r[6]?`+${r[6]}`:"";return i(`${o}.${l}.${u}${c}${d}`,t)}},880894:function(e,t,r){let a=r(671336);e.exports=(e,t,r)=>{let i=new a(e,r),n=new a(t,r);return i.compare(n)||i.compareBuild(n)}},273422:function(e,t,r){let a=r(894609);e.exports=(e,t)=>a(e,t,!0)},894609:function(e,t,r){let a=r(671336);e.exports=(e,t,r)=>new a(e,r).compare(new a(t,r))},274677:function(e,t,r){let a=r(611054);e.exports=(e,t)=>{let r=a(e,null,!0),i=a(t,null,!0),n=r.compare(i);if(0===n)return null;let s=n>0,o=s?r:i,l=s?i:r,u=!!o.prerelease.length;if(l.prerelease.length&&!u)return l.patch||l.minor?o.patch?"patch":o.minor?"minor":"major":"major";let c=u?"pre":"";return r.major!==i.major?c+"major":r.minor!==i.minor?c+"minor":r.patch!==i.patch?c+"patch":"prerelease"}},353327:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>0===a(e,t,r)},990851:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>a(e,t,r)>0},707701:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>a(e,t,r)>=0},131555:function(e,t,r){let a=r(671336);e.exports=(e,t,r,i,n)=>{"string"==typeof r&&(n=i,i=r,r=void 0);try{return new a(e instanceof a?e.version:e,r).inc(t,i,n).version}catch(e){return null}}},133287:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>0>a(e,t,r)},965136:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>0>=a(e,t,r)},710897:function(e,t,r){let a=r(671336);e.exports=(e,t)=>new a(e,t).major},419114:function(e,t,r){let a=r(671336);e.exports=(e,t)=>new a(e,t).minor},145812:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>0!==a(e,t,r)},611054:function(e,t,r){let a=r(671336);e.exports=(e,t,r=!1)=>{if(e instanceof a)return e;try{return new a(e,t)}catch(e){if(!r)return null;throw e}}},914610:function(e,t,r){let a=r(671336);e.exports=(e,t)=>new a(e,t).patch},310395:function(e,t,r){let a=r(611054);e.exports=(e,t)=>{let r=a(e,t);return r&&r.prerelease.length?r.prerelease:null}},530150:function(e,t,r){let a=r(894609);e.exports=(e,t,r)=>a(t,e,r)},898184:function(e,t,r){let a=r(880894);e.exports=(e,t)=>e.sort((e,r)=>a(r,e,t))},936135:function(e,t,r){let a=r(54816);e.exports=(e,t,r)=>{try{t=new a(t,r)}catch(e){return!1}return t.test(e)}},257348:function(e,t,r){let a=r(880894);e.exports=(e,t)=>e.sort((e,r)=>a(e,r,t))},340113:function(e,t,r){let a=r(611054);e.exports=(e,t)=>{let r=a(e,t);return r?r.version:null}},422066:function(e,t,r){let a=r(870032),i=r(926996),n=r(671336),s=r(610451),o=r(611054),l=r(340113),u=r(772363),c=r(131555),d=r(274677),h=r(710897),p=r(419114),f=r(914610),m=r(310395),g=r(894609),y=r(530150),b=r(273422),_=r(880894),v=r(257348),w=r(898184),E=r(990851),O=r(133287),x=r(353327),$=r(145812),A=r(707701),S=r(965136),k=r(531400),P=r(657298),I=r(893836),j=r(54816),T=r(936135),R=r(700856),C=r(333004),N=r(924769),L=r(447220),M=r(868567),U=r(592984),D=r(30049),F=r(944752),B=r(240226);e.exports={parse:o,valid:l,clean:u,inc:c,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:y,compareLoose:b,compareBuild:_,sort:v,rsort:w,gt:E,lt:O,eq:x,neq:$,gte:A,lte:S,cmp:k,coerce:P,Comparator:I,Range:j,satisfies:T,toComparators:R,maxSatisfying:C,minSatisfying:N,minVersion:L,validRange:M,outside:U,gtr:D,ltr:F,intersects:B,simplifyRange:r(150553),subset:r(551216),SemVer:n,re:a.re,src:a.src,tokens:a.t,SEMVER_SPEC_VERSION:i.SEMVER_SPEC_VERSION,RELEASE_TYPES:i.RELEASE_TYPES,compareIdentifiers:s.compareIdentifiers,rcompareIdentifiers:s.rcompareIdentifiers}},926996:function(e){e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||0x1fffffffffffff,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},826185:function(e){e.exports="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{}},610451:function(e){let t=/^[0-9]+$/,r=(e,r)=>{let a=t.test(e),i=t.test(r);return a&&i&&(e*=1,r*=1),e===r?0:a&&!i?-1:i&&!a?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},261686:function(e){e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){let e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},744293:function(e){let t=Object.freeze({loose:!0}),r=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:r},870032:function(e,t,r){let{MAX_SAFE_COMPONENT_LENGTH:a,MAX_SAFE_BUILD_LENGTH:i,MAX_LENGTH:n}=r(926996),s=r(826185),o=(t=e.exports={}).re=[],l=t.safeRe=[],u=t.src=[],c=t.t={},d=0,h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",n],[h,i]],f=(e,t,r)=>{let a=(e=>{for(let[t,r]of p)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),i=d++;s(e,i,t),c[e]=i,u[i]=t,o[i]=new RegExp(t,r?"g":void 0),l[i]=new RegExp(a,r?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),f("MAINVERSION",`(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${u[c.NUMERICIDENTIFIER]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${u[c.NUMERICIDENTIFIERLOOSE]}|${u[c.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${u[c.PRERELEASEIDENTIFIER]}(?:\\.${u[c.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${u[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[c.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${h}+`),f("BUILD",`(?:\\+(${u[c.BUILDIDENTIFIER]}(?:\\.${u[c.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${u[c.MAINVERSION]}${u[c.PRERELEASE]}?${u[c.BUILD]}?`),f("FULL",`^${u[c.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${u[c.MAINVERSIONLOOSE]}${u[c.PRERELEASELOOSE]}?${u[c.BUILD]}?`),f("LOOSE",`^${u[c.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${u[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${u[c.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:${u[c.PRERELEASE]})?${u[c.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:${u[c.PRERELEASELOOSE]})?${u[c.BUILD]}?)?)?`),f("XRANGE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${a}})(?:\\.(\\d{1,${a}}))?(?:\\.(\\d{1,${a}}))?`),f("COERCE",`${u[c.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",u[c.COERCEPLAIN]+`(?:${u[c.PRERELEASE]})?`+`(?:${u[c.BUILD]})?`+"(?:$|[^\\d])"),f("COERCERTL",u[c.COERCE],!0),f("COERCERTLFULL",u[c.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${u[c.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${u[c.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${u[c.LONECARET]}${u[c.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${u[c.LONECARET]}${u[c.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${u[c.GTLT]}\\s*(${u[c.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]}|${u[c.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${u[c.XRANGEPLAIN]})\\s+-\\s+(${u[c.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${u[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[c.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},30049:function(e,t,r){let a=r(592984);e.exports=(e,t,r)=>a(e,t,">",r)},240226:function(e,t,r){let a=r(54816);e.exports=(e,t,r)=>(e=new a(e,r),t=new a(t,r),e.intersects(t,r))},944752:function(e,t,r){let a=r(592984);e.exports=(e,t,r)=>a(e,t,"<",r)},333004:function(e,t,r){let a=r(671336),i=r(54816);e.exports=(e,t,r)=>{let n=null,s=null,o=null;try{o=new i(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(!n||-1===s.compare(e))&&(s=new a(n=e,r))}),n}},924769:function(e,t,r){let a=r(671336),i=r(54816);e.exports=(e,t,r)=>{let n=null,s=null,o=null;try{o=new i(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(!n||1===s.compare(e))&&(s=new a(n=e,r))}),n}},447220:function(e,t,r){let a=r(671336),i=r(54816),n=r(990851);e.exports=(e,t)=>{e=new i(e,t);let r=new a("0.0.0");if(e.test(r)||(r=new a("0.0.0-0"),e.test(r)))return r;r=null;for(let t=0;t<e.set.length;++t){let i=e.set[t],s=null;i.forEach(e=>{let t=new a(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":(!s||n(t,s))&&(s=t);break;case"<":case"<=":break;default:throw Error(`Unexpected operation: ${e.operator}`)}}),s&&(!r||n(r,s))&&(r=s)}return r&&e.test(r)?r:null}},592984:function(e,t,r){let a=r(671336),i=r(893836),{ANY:n}=i,s=r(54816),o=r(936135),l=r(990851),u=r(133287),c=r(965136),d=r(707701);e.exports=(e,t,r,h)=>{let p,f,m,g,y;switch(e=new a(e,h),t=new s(t,h),r){case">":p=l,f=c,m=u,g=">",y=">=";break;case"<":p=u,f=d,m=l,g="<",y="<=";break;default:throw TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let r=0;r<t.set.length;++r){let a=t.set[r],s=null,o=null;if(a.forEach(e=>{e.semver===n&&(e=new i(">=0.0.0")),s=s||e,o=o||e,p(e.semver,s.semver,h)?s=e:m(e.semver,o.semver,h)&&(o=e)}),s.operator===g||s.operator===y||(!o.operator||o.operator===g)&&f(e,o.semver)||o.operator===y&&m(e,o.semver))return!1}return!0}},150553:function(e,t,r){let a=r(936135),i=r(894609);e.exports=(e,t,r)=>{let n=[],s=null,o=null,l=e.sort((e,t)=>i(e,t,r));for(let e of l)a(e,t,r)?(o=e,s||(s=e)):(o&&n.push([s,o]),o=null,s=null);s&&n.push([s,null]);let u=[];for(let[e,t]of n)e===t?u.push(e):t||e!==l[0]?t?e===l[0]?u.push(`<=${t}`):u.push(`${e} - ${t}`):u.push(`>=${e}`):u.push("*");let c=u.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return c.length<d.length?c:t}},551216:function(e,t,r){let a=r(54816),i=r(893836),{ANY:n}=i,s=r(936135),o=r(894609),l=[new i(">=0.0.0-0")],u=[new i(">=0.0.0")],c=(e,t,r)=>{let a,i,c,p,f,m,g;if(e===t)return!0;if(1===e.length&&e[0].semver===n)if(1===t.length&&t[0].semver===n)return!0;else e=r.includePrerelease?l:u;if(1===t.length&&t[0].semver===n)if(r.includePrerelease)return!0;else t=u;let y=new Set;for(let t of e)">"===t.operator||">="===t.operator?a=d(a,t,r):"<"===t.operator||"<="===t.operator?i=h(i,t,r):y.add(t.semver);if(y.size>1)return null;if(a&&i&&((c=o(a.semver,i.semver,r))>0||0===c&&(">="!==a.operator||"<="!==i.operator)))return null;for(let e of y){if(a&&!s(e,String(a),r)||i&&!s(e,String(i),r))return null;for(let a of t)if(!s(e,String(a),r))return!1;return!0}let b=!!i&&!r.includePrerelease&&!!i.semver.prerelease.length&&i.semver,_=!!a&&!r.includePrerelease&&!!a.semver.prerelease.length&&a.semver;for(let e of(b&&1===b.prerelease.length&&"<"===i.operator&&0===b.prerelease[0]&&(b=!1),t)){if(g=g||">"===e.operator||">="===e.operator,m=m||"<"===e.operator||"<="===e.operator,a){if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),">"===e.operator||">="===e.operator){if((p=d(a,e,r))===e&&p!==a)return!1}else if(">="===a.operator&&!s(a.semver,String(e),r))return!1}if(i){if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),"<"===e.operator||"<="===e.operator){if((f=h(i,e,r))===e&&f!==i)return!1}else if("<="===i.operator&&!s(i.semver,String(e),r))return!1}if(!e.operator&&(i||a)&&0!==c)return!1}return(!a||!m||!!i||0===c)&&(!i||!g||!!a||0===c)&&!_&&!b&&!0},d=(e,t,r)=>{if(!e)return t;let a=o(e.semver,t.semver,r);return a>0?e:a<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,r)=>{if(!e)return t;let a=o(e.semver,t.semver,r);return a<0?e:a>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new a(e,r),t=new a(t,r);let i=!1;e:for(let a of e.set){for(let e of t.set){let t=c(a,e,r);if(i=i||null!==t,t)continue e}if(i)return!1}return!0}},700856:function(e,t,r){let a=r(54816);e.exports=(e,t)=>new a(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},868567:function(e,t,r){let a=r(54816);e.exports=(e,t)=>{try{return new a(e,t).range||"*"}catch(e){return null}}},724137:function(e,t,r){"use strict";r.d(t,{Z:()=>l});let a="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);for(var i,n=new Uint8Array(16),s=[],o=0;o<256;++o)s.push((o+256).toString(16).slice(1));let l=function(e,t,r){if(a&&!t&&!e)return a();var o=(e=e||{}).random||(e.rng||function(){if(!i&&!(i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(n)})();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(var l=0;l<16;++l)t[r+l]=o[l];return t}return function(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}(o)}},443269:function(e,t,r){"use strict";r.d(t,{Z:()=>i});let a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,i=function(e){return"string"==typeof e&&a.test(e)}},868977:function(e,t,r){"use strict";let a;r.d(t,{Z:()=>o});let i="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),n=new Uint8Array(16),s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));let o=function(e,t,r){if(i&&!t&&!e)return i();let o=(e=e||{}).random||(e.rng||function(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(n)})();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=o[e];return t}return function(e,t=0){return s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]}(o)}},570716:function(e,t,r){"use strict";r.d(t,{ET:()=>l,K$:()=>u,mb:()=>o});var a=r(724137),i=r(290729),n=r(821614);class s{}function o(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class l extends s{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,i.j)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,n.lS)("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return i.i.prototype.toJSON.call(this)}toJSONNotImplemented(){return i.i.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends l{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:a.Z()}),Object.assign(this,e)}}}}let u=e=>void 0!==e&&"function"==typeof e.copy&&"string"==typeof e.name&&"boolean"==typeof e.awaitHandlers},235786:function(e,t,r){"use strict";let a,i;r.d(t,{Ye:()=>R,QH:()=>A,xz:()=>C});var n=r(724137),s=r(570716),o=r(636345),l=r(319664);function u(e,t){return`${e.open}${t}${e.close}`}function c(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function d(e){return"string"==typeof e?e.trim():null==e?e:c(e,e.toString())}function h(e){if(!e.end_time)return"";let t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}let{color:p}=o;class f extends l.Z{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let e=this.runMap.get(r.parent_run_id);if(e)t.push(e),r=e;else break}return t}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((e,t,r)=>{let a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?u(o.bold,a):a}).join(" > ");return u(p.grey,t)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.green,"[chain/start]")} [${t}] Entering Chain run with input: ${c(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.cyan,"[chain/end]")} [${t}] [${h(e)}] Exiting Chain run with output: ${c(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.red,"[chain/error]")} [${t}] [${h(e)}] Chain run errored with error: ${c(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${u(p.green,"[llm/start]")} [${t}] Entering LLM run with input: ${c(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.cyan,"[llm/end]")} [${t}] [${h(e)}] Exiting LLM run with output: ${c(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.red,"[llm/error]")} [${t}] [${h(e)}] LLM run errored with error: ${c(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.green,"[tool/start]")} [${t}] Entering Tool run with input: "${d(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.cyan,"[tool/end]")} [${t}] [${h(e)}] Exiting Tool run with output: "${d(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.red,"[tool/error]")} [${t}] [${h(e)}] Tool run errored with error: ${c(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${c(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.cyan,"[retriever/end]")} [${t}] [${h(e)}] Exiting Retriever run with output: ${c(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.red,"[retriever/error]")} [${t}] [${h(e)}] Retriever run errored with error: ${c(e.error,"[error]")}`)}onAgentAction(e){let t=this.getBreadcrumbs(e);console.log(`${u(p.blue,"[agent/action]")} [${t}] Agent selected action: ${c(e.actions[e.actions.length-1],"[action]")}`)}}var m=r(835868),g=r(821614),y=r(296587),b=r(14391),_=r(773073);class v extends l.Z{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:i}=e;this.projectName=r??(0,g.lS)("LANGCHAIN_PROJECT")??(0,g.lS)("LANGCHAIN_SESSION"),this.exampleId=t,this.client=i??(()=>{if(void 0===a){let e="false"===(0,g.lS)("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};a=new _.KU(e)}return a})();let n=v.getTraceableRunTree();n&&this.updateFromRunTree(n)}async _convertToCreate(e,t){return{...e,extra:{...e.extra,runtime:await (0,g.sA)()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra,session_name:this.projectName};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e,r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);){;t=t.parent_run}r.clear();let a=[t];for(;a.length>0;){let e=a.shift();!(!e||r.has(e.id))&&(r.add(e.id),this.runMap.set(e.id,e),e.child_runs&&a.push(...e.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){let t={},r=[];for(let[e,a]of this.runMap){let i=new y.IV({...a,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[e]=i,r.push([e,a.dotted_order])}for(let[e]of(r.sort((e,t)=>e[1]&&t[1]?e[1].localeCompare(t[1]):0),r)){let r=this.runMap.get(e),a=t[e];if(r&&a&&r.parent_run_id){let e=t[r.parent_run_id];e&&(e.child_runs.push(a),a.parent_run=e)}}return t[e]}static getTraceableRunTree(){try{return(0,b.dy)(!0)}catch{return}}}var w=r(350709),E=r(408504);async function O(e,t){if(!0===t){let t=(0,E.IU)();void 0!==t?await t.run(void 0,async()=>e()):await e()}else void 0===i&&(i=new("default"in w?w.default:w)({autoStart:!0,concurrency:1})),i.add(async()=>{let t=(0,E.IU)();void 0!==t?await t.run(void 0,async()=>e()):await e()})}function x(e){let t=(0,E.IU)();if(void 0===t)return;let r=t.getStore();return r?.[E.aU]?.[e]}let $=Symbol("lc:configure_hooks");function A(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class S{setHandler(e){return this.setHandlers([e])}}class k{constructor(e,t,r,a,i,n,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>O(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(r=>O(async()=>{try{await r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}}class P extends k{getChild(e){let t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class I extends k{async handleLLMNewToken(e,t,r,a,i,n){await Promise.all(this.handlers.map(r=>O(async()=>{if(!r.ignoreLLM)try{await r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,n)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}async handleLLMError(e,t,r,a,i){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e,t,r,a,i){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class j extends k{getChild(e){let t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,i){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,r,a,i){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class T extends k{getChild(e){let t=new R(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>O(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class R extends S{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r,a,i,s,o,u){return Promise.all(t.map(async(t,a)=>{let s=0===a&&r?r:(0,n.Z)();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return(0,l.H)(r)&&r._createRunForLLMStart(e,[t],s,this._parentRunId,i,this.tags,this.metadata,u),O(async()=>{try{await r.handleLLMStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,u)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new I(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r,a,i,s,o,u){return Promise.all(t.map(async(t,a)=>{let s=0===a&&r?r:(0,n.Z)();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return(0,l.H)(r)&&r._createRunForChatModelStart(e,[t],s,this._parentRunId,i,this.tags,this.metadata,u),O(async()=>{try{if(r.handleChatModelStart)await r.handleChatModelStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,u);else if(r.handleLLMStart){let a=(0,m.zs)(t);await r.handleLLMStart?.(e,[a],s,this._parentRunId,i,this.tags,this.metadata,u)}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new I(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=(0,n.Z)(),a,i,s,o){return await Promise.all(this.handlers.map(i=>{if(!i.ignoreChain)return(0,l.H)(i)&&i._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),O(async()=>{try{await i.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(e){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainStart: ${e}`),i.raiseError)throw e}},i.awaitHandlers)})),new j(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=(0,n.Z)(),a,i,s,o){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreAgent)return(0,l.H)(a)&&a._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),O(async()=>{try{await a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new T(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=(0,n.Z)(),a,i,s,o){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreRetriever)return(0,l.H)(a)&&a._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),O(async()=>{try{await a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new P(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(a=>O(async()=>{if(!a.ignoreCustomEvent)try{await a.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${e}`),a.raiseError)throw e}},a.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){for(let r of(this.handlers=[],this.inheritableHandlers=[],e))this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new R(this._parentRunId);for(let e of this.handlers){let t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(let e of this.tags){let t=this.inheritableTags.includes(e);r.addTags([e],t)}for(let e of Object.keys(this.metadata)){let t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(let a of e)r.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends s.ET{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,n.Z)()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,i,n,s){return this._configureSync(e,t,r,a,i,n,s)}static _configureSync(e,t,r,a,i,n,o){var l;let u;(e||t)&&(Array.isArray(e)||!e?(u=new R).setHandlers(e?.map(C)??[],!0):u=e,u=u.copy(Array.isArray(t)?t.map(C):t?.handlers,!1));let c="true"===(0,g.lS)("LANGCHAIN_VERBOSE")||o?.verbose,d=v.getTraceableRunTree()?.tracingEnabled||(void 0!==l?l:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===(0,g.lS)(e))),h=d||((0,g.lS)("LANGCHAIN_TRACING")??!1);if(c||h){if(u||(u=new R),c&&!u.handlers.some(e=>e.name===f.prototype.name)){let e=new f;u.addHandler(e,!0)}if(h&&!u.handlers.some(e=>"langchain_tracer"===e.name)&&d){let e=new v;u.addHandler(e,!0),u._parentRunId=v.getTraceableRunTree()?.id??u._parentRunId}}for(let{contextVar:e,inheritable:t=!0,handlerClass:r,envVar:a}of x($)||[]){let i,n=a&&"true"===(0,g.lS)(a)&&r,o=void 0!==e?x(e):void 0;o&&(0,s.K$)(o)?i=o:n&&(i=new r({})),void 0!==i&&(u||(u=new R),u.handlers.some(e=>e.name===i.name)||u.addHandler(i,t))}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(i||n)&&u&&(u.addMetadata(i??{}),u.addMetadata(n??{},!1)),u}}function C(e){return"name"in e?e:s.ET.fromMethods(e)}},884026:function(e,t,r){"use strict";function a(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}r.d(t,{r:()=>a})},290729:function(e,t,r){"use strict";r.d(t,{i:()=>o,j:()=>s});var a=r(822227);function i(e,t){return t?.[e]||a(e)}function n(e){return Array.isArray(e)?[...e]:{...e}}function s(e){let t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}r(89151);class o{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,s(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([e])=>this.lc_serializable_keys?.includes(e))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable||this.lc_kwargs instanceof o||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(e=>{let t=this,a=r,[i,...n]=e.split(".").reverse();for(let e of n.reverse()){if(!(e in t)||void 0===t[e])return;e in a&&void 0!==a[e]||("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}i in t&&void 0!==t[i]&&(a[i]=a[i]||t[i])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:function(e,t,r){let a={};for(let i in e)Object.hasOwn(e,i)&&(a[t(i,r)]=e[i]);return a}(Object.keys(t).length?function(e,t){let r=n(e);for(let[e,a]of Object.entries(t)){let[t,...i]=e.split(".").reverse(),s=r;for(let e of i.reverse()){if(void 0===s[e])break;s[e]=n(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[a]})}return r}(r,t):r,i,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},423306:function(e,t,r){"use strict";r.d(t,{GC:()=>u,Z0:()=>o,gY:()=>s,wT:()=>l});var a=r(609922),i=r(38878),n=r(379616);class s extends i.ku{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if("string"==typeof e)r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let t=r.additional_kwargs?.tool_calls,a=r.tool_calls;null!=t&&t.length>0&&(void 0===a||0===a.length)&&console.warn("New LangChain packages are available that more efficiently handle tool calling.\n\nPlease upgrade your packages to versions that set message tool calls. e.g., `yarn add @langchain/anthropic`, yarn add @langchain/openai`, etc.");try{if(null!=t&&void 0===a){let[e,a]=(0,n.jC)(t);r.tool_calls=e??[],r.invalid_tool_calls=a??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch(e){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof r&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function o(e){return"ai"===e._getType()}function l(e){return"ai"===e._getType()}class u extends i.$k{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{let r=[],i=[];for(let t of e.tool_call_chunks){let e={};try{if(e=(0,a.g)(t.args||"{}"),null===e||"object"!=typeof e||Array.isArray(e))throw Error("Malformed tool call chunk args.");r.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){i.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:i,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:(0,i.Wf)(this.content,e.content),additional_kwargs:(0,i.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,i.wv)(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){let r=(0,i.eL)(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){let r={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},a={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},n=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0};t.usage_metadata={input_tokens:i.input_tokens+n.input_tokens,output_tokens:i.output_tokens+n.output_tokens,total_tokens:i.total_tokens+n.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(a).length>0&&{output_token_details:a}}}return new u(t)}}},38878:function(e,t,r){"use strict";r.d(t,{$k:()=>d,QW:()=>p,Wf:()=>n,a2:()=>f,eL:()=>u,gQ:()=>h,ku:()=>o,n4:()=>s,wv:()=>l,x:()=>c});var a=r(290729),i=r(693917);function n(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some(e=>(0,i.JG)(e))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?u(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some(e=>(0,i.JG)(e))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function s(e,t){return"error"===e||"error"===t?"error":"success"}class o extends a.i{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map(e=>"string"==typeof e?e:"text"===e.type?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){var t,r;if(null===e)return this;let a=(t=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,a){if("object"!=typeof t||null==t)return t;if(a>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map(t=>e(t,a+1));let i={};for(let r of Object.keys(t))i[r]=e(t[r],a+1);return i}(t,0),null,2));return`${this.constructor.lc_name()} ${a}`}}function l(e,t){let r={...e};for(let[e,a]of Object.entries(t))if(null==r[e])r[e]=a;else if(null==a)continue;else if(typeof r[e]!=typeof a||Array.isArray(r[e])!==Array.isArray(a))throw Error(`field[${e}] already exists in the message chunk, but with a different type.`);else if("string"==typeof r[e]){if("type"===e)continue;r[e]+=a}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=u(r[e],a);else{if(r[e]===a)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=l(r[e],a);return r}function u(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;let r=[...e];for(let e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){let t=r.findIndex(t=>t.index===e.index);-1!==t?r[t]=l(r[t],e):r.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}function c(e,t){if(!e&&!t)throw Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return u(e,t);if("object"==typeof e&&"object"==typeof t)return l(e,t);else if(e===t)return e;else throw Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}class d extends o{}function h(e){return"string"==typeof e.role}function p(e){return"function"==typeof e?._getType}function f(e){return p(e)&&"function"==typeof e.concat}},661998:function(e,t,r){"use strict";r.d(t,{HD:()=>n,J:()=>i});var a=r(38878);class i extends a.ku{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return i}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class n extends a.$k{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:(0,a.Wf)(this.content,e.content),additional_kwargs:(0,a.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.wv)(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}},693917:function(e,t,r){"use strict";function a(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function i(e){return a(e)&&"url"===e.source_type&&"url"in e&&"string"==typeof e.url}function n(e){return a(e)&&"base64"===e.source_type&&"data"in e&&"string"==typeof e.data}function s(e){if(a(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw Error("mime_type key is required for base64 data.");let t=e.mime_type;return{type:"image_url",image_url:{url:`data:${t};base64,${e.data}`}}}}throw Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function o(e){let t=e.split(";")[0].split("/");if(2!==t.length)throw Error(`Invalid mime type: "${e}" - does not match type/subtype format.`);let r=t[0].trim(),a=t[1].trim();if(""===r||""===a)throw Error(`Invalid mime type: "${e}" - type or subtype is empty.`);let i={};for(let t of e.split(";").slice(1)){let r=t.split("=");if(2!==r.length)throw Error(`Invalid parameter syntax in mime type: "${e}".`);let a=r[0].trim(),n=r[1].trim();if(""===a)throw Error(`Invalid parameter syntax in mime type: "${e}".`);i[a]=n}return{type:r,subtype:a,parameters:i}}function l({dataUrl:e,asTypedArray:t=!1}){let r=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);if(r)return{mime_type:r[1].toLowerCase(),data:t?Uint8Array.from(atob(r[2]),e=>e.charCodeAt(0)):r[2]}}function u(e,t){if("text"===e.type){if(!t.fromStandardTextBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardTextBlock\` method.`);return t.fromStandardTextBlock(e)}if("image"===e.type){if(!t.fromStandardImageBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardImageBlock\` method.`);return t.fromStandardImageBlock(e)}if("audio"===e.type){if(!t.fromStandardAudioBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardAudioBlock\` method.`);return t.fromStandardAudioBlock(e)}if("file"===e.type){if(!t.fromStandardFileBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardFileBlock\` method.`);return t.fromStandardFileBlock(e)}throw Error(`Unable to convert content block type '${e.type}' to provider-specific format: not recognized.`)}r.d(t,{JG:()=>a,Nu:()=>i,SR:()=>l,VL:()=>u,c1:()=>n,j0:()=>s,uy:()=>o})},159991:function(e,t,r){"use strict";r.d(t,{Cr:()=>i});var a=r(38878);a.ku;class i extends a.$k{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new i({content:(0,a.Wf)(this.content,e.content),additional_kwargs:(0,a.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.wv)(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}},795158:function(e,t,r){"use strict";r.d(t,{ro:()=>n,xk:()=>i});var a=r(38878);class i extends a.ku{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class n extends a.$k{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new n({content:(0,a.Wf)(this.content,e.content),additional_kwargs:(0,a.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.wv)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},646600:function(e,t,r){"use strict";r.d(t,{JG:()=>d.JG,zs:()=>u.zs,SR:()=>d.SR,gY:()=>a.gY,xk:()=>o.xk,jN:()=>l.jN,j0:()=>d.j0,VL:()=>d.VL,Cr:()=>s.Cr,c1:()=>d.c1,J:()=>n.J,Xz:()=>c.Xz,wT:()=>a.wT,QW:()=>i.QW,uy:()=>d.uy,Nu:()=>d.Nu,ro:()=>o.ro,GC:()=>a.GC,Z0:()=>a.Z0,HD:()=>n.HD,E1:()=>u.E1,xq:()=>l.xq});var a=r(423306),i=r(38878),n=r(661998),s=r(159991),o=r(795158),l=r(379751),u=r(835868);r(73698),i.ku;var c=r(379616),d=r(693917)},379751:function(e,t,r){"use strict";r.d(t,{jN:()=>i,xq:()=>n});var a=r(38878);class i extends a.ku{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class n extends a.$k{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new n({content:(0,a.Wf)(this.content,e.content),additional_kwargs:(0,a.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.wv)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},379616:function(e,t,r){"use strict";r.d(t,{BE:()=>i,Cq:()=>n,Xz:()=>s,jC:()=>o});var a=r(38878);function i(e){return null!=e&&"object"==typeof e&&"lc_direct_tool_output"in e&&!0===e.lc_direct_tool_output}class n extends a.ku{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){"string"==typeof e&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class s extends a.$k{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new s({content:(0,a.Wf)(this.content,e.content),additional_kwargs:(0,a.wv)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.wv)(this.response_metadata,e.response_metadata),artifact:(0,a.x)(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(0,a.n4)(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function o(e){let t=[],r=[];for(let a of e)if(!a.function)continue;else{let e=a.function.name;try{let r=JSON.parse(a.function.arguments),i={name:e||"",args:r||{},id:a.id};t.push(i)}catch(t){r.push({name:e,args:a.function.arguments,id:a.id,error:"Malformed args."})}}return[t,r]}},835868:function(e,t,r){"use strict";r.d(t,{E1:()=>f,Oy:()=>g,zs:()=>m});var a=r(884026),i=r(509351),n=r(423306),s=r(38878),o=r(661998),l=r(159991),u=r(795158),c=r(379751),d=r(379616);function h(e){return(0,i.uB)(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function p(e){let t,r;if("object"==typeof e&&null!=e&&1===e.lc&&Array.isArray(e.id)&&null!=e.kwargs&&"object"==typeof e.kwargs){let a=e.id.at(-1);t="HumanMessage"===a||"HumanMessageChunk"===a?"user":"AIMessage"===a||"AIMessageChunk"===a?"assistant":"SystemMessage"===a||"SystemMessageChunk"===a?"system":"FunctionMessage"===a||"FunctionMessageChunk"===a?"function":"ToolMessage"===a||"ToolMessageChunk"===a?"tool":"unknown",r=e.kwargs}else{let{type:a,...i}=e;t=a,r=i}if("human"===t||"user"===t)return new u.xk(r);if("ai"===t||"assistant"===t){let{tool_calls:e,...t}=r;if(!Array.isArray(e))return new n.gY(r);let a=e.map(h);return new n.gY({...t,tool_calls:a})}if("system"===t)return new c.jN(r);if("developer"===t)return new c.jN({...r,additional_kwargs:{...r.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in r)return new d.Cq({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});throw(0,a.r)(Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function f(e){if("string"==typeof e)return new u.xk(e);if((0,s.QW)(e))return e;if(Array.isArray(e)){let[t,r]=e;return p({type:t,content:r})}if(!(0,s.gQ)(e))return p(e);{let{role:t,...r}=e;return p({...r,type:t})}}function m(e,t="Human",r="AI"){let a=[];for(let i of e){let e;if("human"===i._getType())e=t;else if("ai"===i._getType())e=r;else if("system"===i._getType())e="System";else if("function"===i._getType())e="Function";else if("tool"===i._getType())e="Tool";else if("generic"===i._getType())e=i.role;else throw Error(`Got unsupported message type: ${i._getType()}`);let n=i.name?`${i.name}, `:"",s="string"==typeof i.content?i.content:JSON.stringify(i.content,null,2);a.push(`${e}: ${n}${s}`)}return a.join("\n")}function g(e){let t=e._getType();if("human"===t)return new u.ro({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),new n.GC({...t})}if("system"===t)return new c.xq({...e});if("function"===t)return new l.Cr({...e});if(o.J.isInstance(e))return new o.HD({...e});else throw Error("Unknown message type.")}},958098:function(e,t,r){"use strict";r.d(t,{Ls:()=>n,WH:()=>a,b6:()=>i});let a="__run";class i{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new i({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class n extends i{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},73698:function(e,t,r){"use strict";r.d(t,{Vh:()=>Q,k9:()=>Y,eq:()=>q,pX:()=>H,dT:()=>W,Uv:()=>z,lW:()=>G,Y8:()=>K});var a=r(196130),i=r(750980),n=r(724137),s=r(14391),o=r(635356),l=r(319664),u=r(730373),c=r(423306);class d{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=(0,o.af)({},t);return new h({ops:t,state:r[r.length-1].newDocument})}}class h extends d{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=(0,o.af)(this.state,e.ops);return new h({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=(0,o.af)({},e.ops);return new h({ops:e.ops,state:t[t.length-1].newDocument})}}let p=e=>"log_stream_tracer"===e.name;async function f(e,t){if("original"===t)throw Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||r?.input!==""?r.input:void 0}async function m(e,t){let{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&r?.output!==void 0?r.output:r}class g extends l.Z{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=u.QJ.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async *tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let t=this.keyMapByRunId[e];t&&await this.writer.write(new d({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new d({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await f(e,this._schemaFormat)),await this.writer.write(new d({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(void 0===t)return;let r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await f(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await m(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new d({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new d({ops:[{op:"replace",path:"/final_output",value:await m(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a,i=this.keyMapByRunId[e.id];if(void 0===i)return;if(void 0!==e.inputs.messages){var n;a=void 0!==(n=r?.chunk)&&void 0!==n.message?r?.chunk:new c.GC({id:`run-${e.id}`,content:t})}else a=t;let s=new d({ops:[{op:"add",path:`/logs/${i}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${i}/streamed_output/-`,value:a}]});await this.writer.write(s)}}var y=r(958098);function b({name:e,serialized:t}){return void 0!==e?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}let _=e=>"event_stream_tracer"===e.name;class v extends l.Z{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=u.QJ.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async *tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(void 0===a)return void(yield r.value);function i(e,t){return"llm"===e&&"string"==typeof t?new y.b6({text:t}):t}let n=this.tappedPromises.get(e);if(void 0===n){let s;n=new Promise(e=>{s=e}),this.tappedPromises.set(e,n);try{let n={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};for await(let e of(await this.send({...n,data:{chunk:i(a.runType,r.value)}},a),yield r.value,t))"tool"!==a.runType&&"retriever"!==a.runType&&await this.send({...n,data:{chunk:i(a.runType,e)}},a),yield e}finally{s()}}else for await(let e of(yield r.value,t))yield e}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);void 0!==r?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=b(e),r=void 0!==e.inputs.messages?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a,i,n=this.runInfoMap.get(e.id);if(void 0===n)throw Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===n.runType)i="on_chat_model_stream",a=r?.chunk===void 0?new c.GC({content:t,id:`run-${e.id}`}):r.chunk.message;else if("llm"===n.runType)i="on_llm_stream",a=r?.chunk===void 0?new y.b6({text:t}):r.chunk;else throw Error(`Unexpected run type ${n.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){let t,r,a=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===a)throw Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let i=e.outputs?.generations;if("chat_model"===a.runType){for(let e of i??[]){if(void 0!==r)break;r=e[0]?.message}t="on_chat_model_end"}else if("llm"===a.runType)r={generations:i?.map(e=>e.map(e=>({text:e.text,generationInfo:e.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},t="on_llm_end";else throw Error(`onLLMEnd: Unexpected run type: ${a.runType}`);await this.sendEndEvent({event:t,data:{output:r,input:a.inputs},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onChainStart(e){let t=b(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(i={},a.inputs={}):void 0!==e.inputs.input?(i.input=e.inputs.input,a.inputs=e.inputs.input):(i.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&1===Object.keys(a).length&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=b(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=b(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(void 0===a)throw Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){Promise.all([...this.tappedPromises.values()]).finally(()=>{this.writer.close()})}}var w=r(290729),E=r(191301),O=r(791388),x=r(921570);class $ extends l.Z{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){!this.rootId&&(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function A(e){return!!e&&e.lc_runnable}class S{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags,a=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||a.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&a.every(e=>!this.excludeTags?.includes(e))),r}}var k=r(731858),P=r(798455),I=r(443269);function j(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}let T=["*","_","`"];async function R(e,t){let{backgroundColor:r="white"}=t??{},a=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));let i=`https://mermaid.ink/img/${a}?bgColor=${r}`,n=await fetch(i);if(!n.ok)throw Error(`Failed to render the graph using the Mermaid.INK API.
Status code: ${n.status}
Status text: ${n.statusText}`);return await n.blob()}class C{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=(0,I.Z)(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...A(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...(0,P.Y_)(t.data.schema),title:t.data.name}}})),edges:this.edges.map(t=>{let r={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(r.data=t.data),void 0!==t.conditional&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(void 0!==t&&void 0!==this.nodes[t])throw Error(`Node with id ${t} already exists`);let a=t??(0,n.Z)(),i={id:a,data:e,name:function(e,t){if(void 0!==e&&!(0,I.Z)(e))return e;if(!A(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}(t,e),metadata:r};return this.nodes[a]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(void 0===this.nodes[e.id])throw Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw Error(`Target node ${t.id} not in graph`);let i={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(i),i}firstNode(){return N(this)}lastNode(){return L(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(e=>e.id).every(I.Z)&&(r="");let a=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[a(e)]={...t,id:a(e)}});let i=e.edges.map(e=>({...e,source:a(e.source),target:a(e.target)}));this.edges=[...this.edges,...i];let n=e.firstNode(),s=e.lastNode();return[n?{id:a(n.id),data:n.data}:void 0,s?{id:a(s.id),data:s.data}:void 0]}trimFirstNode(){let e=this.firstNode();e&&N(this,[e.id])&&this.removeNode(e)}trimLastNode(){let e=this.lastNode();e&&L(this,[e.id])&&this.removeNode(e)}reid(){let e=Object.fromEntries(Object.values(this.nodes).map(e=>[e.id,e.name])),t=new Map;Object.values(e).forEach(e=>{t.set(e,(t.get(e)||0)+1)});let r=r=>{let a=e[r];return(0,I.Z)(r)&&1===t.get(a)?a:r};return new C({nodes:Object.fromEntries(Object.entries(this.nodes).map(([e,t])=>[r(e),{...t,id:r(e)}])),edges:this.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}))})}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},n=this.reid(),s=n.firstNode(),o=n.lastNode();return function(e,t,r){let{firstNode:a,lastNode:i,nodeColors:n,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=r??{},u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:"graph TD;\n";if(s){let t="default",r={[t]:"{0}({1})"};for(let[n,s]of(void 0!==a&&(r[a]="{0}([{1}]):::first"),void 0!==i&&(r[i]="{0}([{1}]):::last"),Object.entries(e))){let e=s.name.split(":").pop()??"",a=T.some(t=>e.startsWith(t)&&e.endsWith(t))?`<p>${e}</p>`:e;Object.keys(s.metadata??{}).length&&(a+=`<hr/><small><em>${Object.entries(s.metadata??{}).map(([e,t])=>`${e} = ${t}`).join("\n")}</em></small>`);let i=(r[n]??r[t]).replace("{0}",j(n)).replace("{1}",a);u+=`	${i}
`}}let c={};for(let e of t){let t=e.source.split(":"),r=e.target.split(":"),a=t.filter((e,t)=>e===r[t]).join(":");c[a]||(c[a]=[]),c[a].push(e)}let d=new Set;function h(e,t){let r=1===e.length&&e[0].source===e[0].target;if(t&&!r){let e=t.split(":").pop();if(d.has(e))throw Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),u+=`	subgraph ${e}
`}for(let t of e){let{source:e,target:r,data:a,conditional:i}=t,n="";if(void 0!==a){let e=a,t=e.split(" ");t.length>l&&(e=Array.from({length:Math.ceil(t.length/l)},(e,r)=>t.slice(r*l,(r+1)*l).join(" ")).join("&nbsp;<br>&nbsp;")),n=i?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --> `}else n=i?" -.-> ":" --\x3e ";u+=`	${j(e)}${n}${j(r)};
`}for(let e in c)e.startsWith(`${t}:`)&&e!==t&&h(c[e],e);t&&!r&&(u+="	end\n")}for(let e in h(c[""]??[],""),c)e.includes(":")||""===e||h(c[e],e);return s&&(u+=function(e){let t="";for(let[r,a]of Object.entries(e))t+=`	classDef ${r} ${a};
`;return t}(n??{})),u}(n.nodes,n.edges,{firstNode:s?.id,lastNode:o?.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:i})}async drawMermaidPng(e){return R(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function N(e,t=[]){let r=new Set(e.edges.filter(e=>!t.includes(e.source)).map(e=>e.target)),a=[];for(let i of Object.values(e.nodes))t.includes(i.id)||r.has(i.id)||a.push(i);return 1===a.length?a[0]:void 0}function L(e,t=[]){let r=new Set(e.edges.filter(e=>!t.includes(e.target)).map(e=>e.source)),a=[];for(let i of Object.values(e.nodes))t.includes(i.id)||r.has(i.id)||a.push(i);return 1===a.length?a[0]:void 0}function M(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function U(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*D(e,t){for(;;){let{value:r,done:a}=k.AO.runWithConfig((0,O.yG)(e),t.next.bind(t),!0);if(a)break;yield r}}async function*F(e,t){let r=t[Symbol.asyncIterator]();for(;;){let{value:a,done:i}=await k.AO.runWithConfig((0,O.yG)(e),r.next.bind(t),!0);if(i)break;yield a}}var B=r(509351);function z(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class q extends w.i{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new H({bound:this,kwargs:e,config:{}})}map(){return new Z({bound:this})}withRetry(e){return new J({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new H({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new X({runnable:this,fallbacks:Array.isArray(e)?e:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(O.LE);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,a)=>(0,O.LE)(0===a?e:r))}return Array.from({length:t},()=>(0,O.LE)(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=a[0]?.maxConcurrency??r?.maxConcurrency,n=new x.L({maxConcurrency:i,onFailedAttempt:e=>{throw e}});return Promise.all(e.map((e,t)=>n.call(async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}})))}async *_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=(0,O.LE)(t),a=new u.qq({generator:this._streamIterator(e,r),config:r});return await a.setup,u.QJ.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?(0,O.LE)(e):(0,O.LE)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){let a,i=(0,O.LE)(r),n=await (0,O.Le)(i),s=await n?.handleChainStart(this.toJSON(),z(t,"input"),i.runId,i?.runType,void 0,void 0,i?.runName??this.getName());delete i.runId;try{let n=e.call(this,t,i,s);a=await (0,E.E)(n,r?.signal)}catch(e){throw await s?.handleChainError(e),e}return await s?.handleChainEnd(z(a,"output")),a}async _batchWithConfig(e,t,r,a){let i,n=this._getOptionsList(r??{},t.length),s=await Promise.all(n.map(O.Le)),o=await Promise.all(s.map(async(e,r)=>{let a=await e?.handleChainStart(this.toJSON(),z(t[r],"input"),n[r].runId,n[r].runType,void 0,void 0,n[r].runName??this.getName());return delete n[r].runId,a}));try{let r=e.call(this,t,n,o,a);i=await (0,E.E)(r,n?.[0]?.signal)}catch(e){throw await Promise.all(o.map(t=>t?.handleChainError(e))),e}return await Promise.all(o.map(e=>e?.handleChainEnd(z(i,"output")))),i}async *_transformStreamWithConfig(e,t,r){let a,i,n,s=!0,o=!0,l=(0,O.LE)(r),c=await (0,O.Le)(l);async function*d(){for await(let t of e){if(s)if(void 0===a)a=t;else try{a=(0,u.zo)(a,t)}catch{a=void 0,s=!1}yield t}}try{let e=await (0,u.E7)(t.bind(this),d(),async()=>c?.handleChainStart(this.toJSON(),{input:""},l.runId,l.runType,void 0,void 0,l.runName??this.getName()),r?.signal,l);delete l.runId,n=e.setup;let a=n?.handlers.find(_),s=e.output;void 0!==a&&void 0!==n&&(s=a.tapOutputIterable(n.runId,s));let h=n?.handlers.find(p);for await(let e of(void 0!==h&&void 0!==n&&(s=h.tapOutputIterable(n.runId,s)),s))if(yield e,o)if(void 0===i)i=e;else try{i=(0,u.zo)(i,e)}catch{i=void 0,o=!1}}catch(e){throw await n?.handleChainError(e,void 0,void 0,void 0,{inputs:z(a,"input")}),e}await n?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:z(a,"input")})}getGraph(e){let t=new C,r=t.addNode({name:`${this.getName()}Input`,schema:a.z.any()}),i=t.addNode(this),n=t.addNode({name:`${this.getName()}Output`,schema:a.z.any()});return t.addEdge(r,i),t.addEdge(i,n),t}pipe(e){return new G({first:this,last:Y(e)})}pick(e){return this.pipe(new ee(e))}assign(e){return this.pipe(new Q(new W({steps:e})))}async *transform(e,t){let r;for await(let t of e)r=void 0===r?t:(0,u.zo)(r,t);yield*this._streamIterator(r,(0,O.LE)(t))}async *streamLog(e,t,r){let a=new g({...r,autoClose:!1,_schemaFormat:"original"}),i=(0,O.LE)(t);yield*this._streamLog(e,a,i)}async *_streamLog(e,t,r){let{callbacks:a}=r;if(void 0===a)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let e=a.copy();e.addHandler(t,!0),r.callbacks=e}let i=this.stream(e,r),n=async function(){try{for await(let e of(await i)){let r=new d({ops:[{op:"add",path:"/streamed_output/-",value:e}]});await t.writer.write(r)}}finally{await t.writer.close()}}();try{for await(let e of t)yield e}finally{await n}}streamEvents(e,t,r){let a;if("v1"===t.version)a=this._streamEventsV1(e,t,r);else if("v2"===t.version)a=this._streamEventsV2(e,t,r);else throw Error('Only versions "v1" and "v2" of the schema are currently supported.');if("text/event-stream"!==t.encoding)return u.QJ.fromAsyncGenerator(a);var i=a;let n=new TextEncoder,s=new ReadableStream({async start(e){for await(let t of i)e.enqueue(n.encode(`event: data
data: ${JSON.stringify(t)}

`));e.enqueue(n.encode("event: end\n\n")),e.close()}});return u.QJ.fromReadableStream(s)}async *_streamEventsV2(e,t,r){let a,i=new v({...r,autoClose:!1}),s=(0,O.LE)(t),o=s.runId??(0,n.Z)();s.runId=o;let l=s.callbacks;if(void 0===l)s.callbacks=[i];else if(Array.isArray(l))s.callbacks=l.concat(i);else{let e=l.copy();e.addHandler(i,!0),s.callbacks=e}let u=new AbortController,c=this,d=async function(){try{let r;t?.signal?"any"in AbortSignal?r=AbortSignal.any([u.signal,t.signal]):(r=t.signal,t.signal.addEventListener("abort",()=>{u.abort()},{once:!0})):r=u.signal;let a=await c.stream(e,{...s,signal:r});for await(let e of i.tapOutputIterable(o,a))if(u.signal.aborted)break}finally{await i.finish()}}(),h=!1;try{for await(let t of i){if(!h){t.data.input=e,h=!0,a=t.run_id,yield t;continue}t.run_id===a&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t}}finally{u.abort(),await d}}async *_streamEventsV1(e,t,r){let a,i=!1,n=(0,O.LE)(t),s=n.tags??[],o=n.metadata??{},l=n.runName??this.getName(),u=new g({...r,autoClose:!1,_schemaFormat:"streaming_events"}),c=new S({...r});for await(let t of this._streamLog(e,u,n)){if(void 0===(a=a?a.concat(t):h.fromRunLogPatch(t)).state)throw Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let t={...a.state},r={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};c.includeEvent(r,t.type)&&(yield r)}for(let e of[...new Set(t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]))]){let t,r={},i=a.state.logs[e];if("start"==(t=void 0===i.end_time?i.streamed_output.length>0?"stream":"start":"end"))void 0!==i.inputs&&(r.input=i.inputs);else if("end"===t)void 0!==i.inputs&&(r.input=i.inputs),r.output=i.final_output;else if("stream"===t){let e=i.streamed_output.length;if(1!==e)throw Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${i.name}"`);r={chunk:i.streamed_output[0]},i.streamed_output=[]}yield{event:`on_${i.type}_${t}`,name:i.name,run_id:i.id,tags:i.tags,metadata:i.metadata,data:r}}let{state:r}=a;if(r.streamed_output.length>0){let e=r.streamed_output.length;if(1!==e)throw Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${r.name}"`);let t={chunk:r.streamed_output[0]};r.streamed_output=[];let a={event:`on_${r.type}_stream`,run_id:r.id,tags:s,metadata:o,name:l,data:t};c.includeEvent(a,r.type)&&(yield a)}}let d=a?.state;if(void 0!==d){let e={event:`on_${d.type}_end`,name:l,run_id:d.id,tags:s,metadata:o,data:{output:d.final_output}};c.includeEvent(e,d.type)&&(yield e)}}static isRunnable(e){return A(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new H({bound:this,config:{},configFactories:[a=>({callbacks:[new $({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){var t=this,r=e;let i=r.name??t.getName(),n=r.description??r.schema?.description;return new et(r.schema.constructor===a.z.ZodString?{name:i,description:n,schema:a.z.object({input:a.z.string()}).transform(e=>e.input),bound:t}:{name:i,description:n,schema:r.schema,bound:t})}}class H extends q{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=(0,O.t8)(this.config,...e);return(0,O.t8)(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new J({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig((0,O.LE)(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig((0,O.LE)(e),this.kwargs))):await this._mergeConfig((0,O.LE)(t),this.kwargs);return this.bound.batch(e,a,r)}async *_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig((0,O.LE)(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig((0,O.LE)(t),this.kwargs))}async *transform(e,t){yield*this.bound.transform(e,await this._mergeConfig((0,O.LE)(t),this.kwargs))}streamEvents(e,t,r){let a=this,i=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig((0,O.LE)(t),a.kwargs),version:t.version},r)};return u.QJ.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&q.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new H({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new $({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Z extends q{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Z({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,(0,O.q)(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Z({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class J extends H{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return(0,O.q)(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return i(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){let n={};try{await i(async i=>{let s,o=e.map((e,t)=>t).filter(e=>void 0===n[e.toString()]||n[e.toString()]instanceof Error),l=o.map(t=>e[t]),u=o.map(e=>this._patchConfigForRetry(i,t?.[e],r?.[e])),c=await super.batch(l,u,{...a,returnExceptions:!0});for(let e=0;e<c.length;e+=1){let t=c[e],r=o[e];t instanceof Error&&void 0===s&&((s=t).input=l[e]),n[r.toString()]=t}if(s)throw s;return c},{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(a?.returnExceptions!==!0)throw e}return Object.keys(n).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>n[parseInt(e,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class G extends q{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r,a=(0,O.LE)(t),i=await (0,O.Le)(a),n=await i?.handleChainStart(this.toJSON(),z(e,"input"),a.runId,void 0,void 0,void 0,a?.runName);delete a.runId;let s=e;try{let e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){let i=e[r].invoke(s,(0,O.q)(a,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));s=await (0,E.E)(i,t?.signal)}if(t?.signal?.aborted)throw Error("Aborted");r=await this.last.invoke(s,(0,O.q)(a,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await n?.handleChainError(e),e}return await n?.handleChainEnd(z(r,"output")),r}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(O.Le)),n=await Promise.all(i.map(async(t,r)=>{let i=await t?.handleChainStart(this.toJSON(),z(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName);return delete a[r].runId,i})),s=e;try{for(let e=0;e<this.steps.length;e+=1){let t=this.steps[e].batch(s,n.map((t,r)=>{let i=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return(0,O.q)(a[r],{callbacks:i})}),r);s=await (0,E.E)(t,a[0]?.signal)}}catch(e){throw await Promise.all(n.map(t=>t?.handleChainError(e))),e}return await Promise.all(n.map(e=>e?.handleChainEnd(z(s,"output")))),s}async *_streamIterator(e,t){let r,a=await (0,O.Le)(t),{runId:i,...n}=t??{},s=await a?.handleChainStart(this.toJSON(),z(e,"input"),i,void 0,void 0,void 0,n?.runName),o=[this.first,...this.middle,this.last],l=!0;async function*c(){yield e}try{let e=o[0].transform(c(),(0,O.q)(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let t=1;t<o.length;t+=1){let r=o[t];e=await r.transform(e,(0,O.q)(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${t+1}`)}))}for await(let a of e)if(t?.signal?.throwIfAborted(),yield a,l)if(void 0===r)r=a;else try{r=(0,u.zo)(r,a)}catch(e){r=void 0,l=!1}}catch(e){throw await s?.handleChainError(e),e}await s?.handleChainEnd(z(r,"output"))}getGraph(e){let t=new C,r=null;return this.steps.forEach((a,i)=>{let n=a.getGraph(e);0!==i&&n.trimFirstNode(),i!==this.steps.length-1&&n.trimLastNode(),t.extend(n);let s=n.firstNode();if(!s)throw Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,s),r=n.lastNode()}),t}pipe(e){return new G(G.isRunnableSequence(e)?{first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}:{first:this.first,middle:[...this.middle,this.last],last:Y(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&q.isRunnable(e)}static from([e,...t],r){let a={};return"string"==typeof r?a.name=r:void 0!==r&&(a=r),new G({...a,first:Y(e),middle:t.slice(0,-1).map(Y),last:Y(t[t.length-1])})}}class W extends q{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){for(let[t,r]of(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={},Object.entries(e.steps)))this.steps[t]=Y(r)}static from(e){return new W({steps:e})}async invoke(e,t){let r=(0,O.LE)(t),a=await (0,O.Le)(r),i=await a?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let n={};try{let a=Object.entries(this.steps).map(async([t,a])=>{n[t]=await a.invoke(e,(0,O.q)(r,{callbacks:i?.getChild(`map:key:${t}`)}))});await (0,E.E)(Promise.all(a),t?.signal)}catch(e){throw await i?.handleChainError(e),e}return await i?.handleChainEnd(n),n}async *_transform(e,t,r){let a={...this.steps},i=(0,u.y2)(e,Object.keys(a).length),n=new Map(Object.entries(a).map(([e,a],n)=>{let s=a.transform(i[n],(0,O.q)(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then(t=>({key:e,gen:s,result:t}))]}));for(;n.size;){let e=Promise.race(n.values()),{key:t,result:a,gen:i}=await (0,E.E)(e,r?.signal);n.delete(t),a.done||(yield{[t]:a.value},n.set(t,i.next().then(e=>({key:t,gen:i,result:e}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=(0,O.LE)(t),i=new u.qq({generator:this.transform(r(),a),config:a});return await i.setup,u.QJ.fromAsyncGenerator(i)}}class V extends q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!(0,s.xQ)(e.func))throw Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await (0,O.Le)(r),i=this.func((0,O.q)(r,{callbacks:a}),e);return(0,E.E)(i,r?.signal)}async *_streamIterator(e,t){let[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(U(a)){for await(let e of a)r?.signal?.throwIfAborted(),yield e;return}if(null!=a&&"object"==typeof a&&"next"in a&&"function"==typeof a.next){for(;;){r?.signal?.throwIfAborted();let e=a.next();if(e.done)break;yield e.value}return}yield a}static from(e){return new V({func:e})}}class K extends q{static lc_name(){return"RunnableLambda"}constructor(e){if((0,s.xQ)(e.func))return V.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0});var t=e.func;if((0,s.xQ)(t))throw Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.");this.func=e.func}static from(e){return new K({func:e})}async _invoke(e,t,r){return new Promise((a,i)=>{let n=(0,O.q)(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??O.ov)-1});k.AO.runWithConfig((0,O.yG)(n),async()=>{try{let r=await this.func(e,{...n});if(r&&q.isRunnable(r)){if(t?.recursionLimit===0)throw Error("Recursion limit reached.");r=await r.invoke(e,{...n,recursionLimit:(n.recursionLimit??O.ov)-1})}else if(U(r)){let e;for await(let a of F(n,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=(0,u.zo)(e,a)}catch(t){e=a}r=e}else if(M(r)){let e;for(let a of D(n,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=(0,u.zo)(e,a)}catch(t){e=a}r=e}a(r)}catch(e){i(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async *_transform(e,t,r){let a;for await(let t of e)if(void 0===a)a=t;else try{a=(0,u.zo)(a,t)}catch(e){a=t}let i=(0,O.q)(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??O.ov)-1}),n=await new Promise((e,t)=>{k.AO.runWithConfig((0,O.yG)(i),async()=>{try{let t=await this.func(a,{...i,config:i});e(t)}catch(e){t(e)}})});if(n&&q.isRunnable(n)){if(r?.recursionLimit===0)throw Error("Recursion limit reached.");for await(let e of(await n.stream(a,i)))yield e}else if(U(n))for await(let e of F(i,n))r?.signal?.throwIfAborted(),yield e;else if(M(n))for(let e of D(i,n))r?.signal?.throwIfAborted(),yield e;else yield n}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=(0,O.LE)(t),i=new u.qq({generator:this.transform(r(),a),config:a});return await i.setup,u.QJ.fromAsyncGenerator(i)}}class X extends q{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){for(let e of(yield this.runnable,this.fallbacks))yield e}async invoke(e,t){let r=(0,O.LE)(t),a=await (0,O.Le)(r),{runId:i,...n}=r,s=await a?.handleChainStart(this.toJSON(),z(e,"input"),i,void 0,void 0,void 0,n?.runName),o=(0,O.q)(n,{callbacks:s?.getChild()});return await k.AO.runWithConfig(o,async()=>{let t;for(let a of this.runnables()){r?.signal?.throwIfAborted();try{let t=await a.invoke(e,o);return await s?.handleChainEnd(z(t,"output")),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw Error("No error stored at end of fallback.");throw await s?.handleChainError(t),t})}async *_streamIterator(e,t){let r,a,i,n=(0,O.LE)(t),s=await (0,O.Le)(n),{runId:o,...l}=n,c=await s?.handleChainStart(this.toJSON(),z(e,"input"),o,void 0,void 0,void 0,l?.runName);for(let t of this.runnables()){n?.signal?.throwIfAborted();let i=(0,O.q)(l,{callbacks:c?.getChild()});try{let r=await t.stream(e,i);a=F(i,r);break}catch(e){void 0===r&&(r=e)}}if(void 0===a){let e=r??Error("No error stored at end of fallback.");throw await c?.handleChainError(e),e}try{for await(let e of a){yield e;try{i=void 0===i?i:(0,u.zo)(i,e)}catch(e){i=void 0}}}catch(e){throw await c?.handleChainError(e),e}await c?.handleChainEnd(z(i,"output"))}async batch(e,t,r){let a;if(r?.returnExceptions)throw Error("Not implemented.");let i=this._getOptionsList(t??{},e.length),n=await Promise.all(i.map(e=>(0,O.Le)(e))),s=await Promise.all(n.map(async(t,r)=>{let a=await t?.handleChainStart(this.toJSON(),z(e[r],"input"),i[r].runId,void 0,void 0,void 0,i[r].runName);return delete i[r].runId,a}));for(let t of this.runnables()){i[0].signal?.throwIfAborted();try{let a=await t.batch(e,s.map((e,t)=>(0,O.q)(i[t],{callbacks:e?.getChild()})),r);return await Promise.all(s.map((e,t)=>e?.handleChainEnd(z(a[t],"output")))),a}catch(e){void 0===a&&(a=e)}}if(!a)throw Error("No error stored at end of fallbacks.");throw await Promise.all(s.map(e=>e?.handleChainError(a))),a}}function Y(e){if("function"==typeof e)return new K({func:e});if(q.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`);{let t={};for(let[r,a]of Object.entries(e))t[r]=Y(a);return new W({steps:t})}}class Q extends q{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof W&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async *_transform(e,t,r){let a=this.mapper.getStepsKeys(),[i,n]=(0,u.y2)(e),s=this.mapper.transform(n,(0,O.q)(r,{callbacks:t?.getChild()})),o=s.next();for await(let e of i){if("object"!=typeof e||Array.isArray(e))throw Error(`RunnableAssign can only be used with objects as input, got ${typeof e}`);let t=Object.fromEntries(Object.entries(e).filter(([e])=>!a.includes(e)));Object.keys(t).length>0&&(yield t)}for await(let e of(yield(await o).value,s))yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=(0,O.LE)(t),i=new u.qq({generator:this.transform(r(),a),config:a});return await i.setup,u.QJ.fromAsyncGenerator(i)}}class ee extends q{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{let t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async *_transform(e){for await(let t of e){let e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=(0,O.LE)(t),i=new u.qq({generator:this.transform(r(),a),config:a});return await i.setup,u.QJ.fromAsyncGenerator(i)}}class et extends H{constructor(e){super({bound:G.from([K.from(async e=>{let t;if((0,B.uB)(e))try{t=await this.schema.parseAsync(e.args)}catch(t){throw new B.YE("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}},791388:function(e,t,r){"use strict";r.d(t,{LE:()=>u,Le:()=>s,ov:()=>n,q:()=>c,t8:()=>o,yG:()=>d});var a=r(235786),i=r(731858);let n=25;async function s(e){return a.Ye._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function o(...e){let t={};for(let r of e.filter(e=>!!e))for(let e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){let a=t[e]??[];t[e]=[...new Set(a.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=r.timeout:void 0!==r.timeout&&(t.timeout=Math.min(t.timeout,r.timeout));else if("signal"===e)void 0===t.signal?t.signal=r.signal:void 0!==r.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if("callbacks"===e){let e=t.callbacks,i=r.callbacks;if(Array.isArray(i))if(e)if(Array.isArray(e))t.callbacks=e.concat(i);else{let r=e.copy();for(let e of i)r.addHandler((0,a.xz)(e),!0);t.callbacks=r}else t.callbacks=i;else if(i)if(e)if(Array.isArray(e)){let r=i.copy();for(let t of e)r.addHandler((0,a.xz)(t),!0);t.callbacks=r}else t.callbacks=new a.Ye(i._parentRunId,{handlers:e.handlers.concat(i.handlers),inheritableHandlers:e.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(i.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(i.inheritableTags))),metadata:{...e.metadata,...i.metadata}});else t.callbacks=i}else t[e]=r[e]??t[e];return t}let l=new Set(["string","number","boolean"]);function u(e){let t=i.AO.getRunnableConfig(),r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){let{runId:e,runName:a,...i}=t;r=Object.entries(i).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)}if(e&&(r=Object.entries(e).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)),r?.configurable)for(let e of Object.keys(r.configurable))l.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);if(void 0!==r.timeout){if(r.timeout<=0)throw Error("Timeout must be a positive number");let e=AbortSignal.timeout(r.timeout);void 0!==r.signal?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,e])):r.signal=e,delete r.timeout}return r}function c(e={},{callbacks:t,maxConcurrency:r,recursionLimit:a,runName:i,configurable:n,runId:s}={}){let o=u(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==a&&(o.recursionLimit=a),void 0!==r&&(o.maxConcurrency=r),void 0!==i&&(o.runName=i),void 0!==n&&(o.configurable={...o.configurable,...n}),void 0!==s&&delete o.runId,o}function d(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}},408504:function(e,t,r){"use strict";r.d(t,{IU:()=>s,aU:()=>i,eO:()=>n});let a=Symbol.for("ls:tracing_async_local_storage"),i=Symbol.for("lc:context_variables"),n=e=>{globalThis[a]=e},s=()=>globalThis[a]},731858:function(e,t,r){"use strict";r.d(t,{AO:()=>l});var a=r(773073),i=r(408504),n=r(235786);let s=new class{getStore(){}run(e,t){return t()}enterWith(e){}},o=Symbol.for("lc:child_config"),l=new class{getInstance(){return(0,i.IU)()??s}getRunnableConfig(){let e=this.getInstance();return e.getStore()?.extra?.[o]}runWithConfig(e,t,r){let s,l=n.Ye._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),u=this.getInstance(),c=u.getStore(),d=l?.getParentRunId(),h=l?.handlers?.find(e=>e?.name==="langchain_tracer");return h&&d?s=h.convertToRunTree(d):r||(s=new a.IV({name:"<runnable_lambda>",tracingEnabled:!1})),s&&(s.extra={...s.extra,[o]:e}),void 0!==c&&void 0!==c[i.aU]&&(void 0===s&&(s={}),s[i.aU]=c[i.aU]),u.run(s,t)}initializeGlobalInstance(e){void 0===(0,i.IU)()&&(0,i.eO)(e)}}},509351:function(e,t,r){"use strict";function a(e){return!!(e&&"object"==typeof e&&"type"in e&&"tool_call"===e.type)}function i(e){return!!(e&&"object"==typeof e&&"toolCall"in e&&null!=e.toolCall&&"object"==typeof e.toolCall&&"id"in e.toolCall&&"string"==typeof e.toolCall.id)}r.d(t,{YE:()=>n,qS:()=>i,uB:()=>a});class n extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}},319664:function(e,t,r){"use strict";r.d(t,{H:()=>n,Z:()=>s});var a=r(570716);function i(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function n(e){return"function"==typeof e._addRunToRunMap}class s extends a.ET{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=function(e,t,r){let a=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${a}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),r={...e};if(void 0!==r.parent_run_id){let e=this.runMap.get(r.parent_run_id);e&&(this._addChildRun(e,r),e.child_execution_order=Math.max(e.child_execution_order,r.child_execution_order),r.trace_id=e.trace_id,void 0!==e.dotted_order&&(r.dotted_order=[e.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){let t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,a,i,n,s,o){let l=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,a,i,n,s,o){let l=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t,r,a,i){let n=this.runMap.get(t);if(!n||n?.run_type!=="llm")throw Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMEnd?.(n),await this._endTrace(n),n}async handleLLMError(e,t,r,a,i){let n=this.runMap.get(t);if(!n||n?.run_type!=="llm")throw Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMError?.(n),await this._endTrace(n),n}_createRunForChainStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(c)}async handleChainStart(e,t,r,a,i,n,s,o){let l=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,r,a,n){let s=this.runMap.get(t);if(!s)throw Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=i(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),n?.inputs!==void 0&&(s.inputs=i(n.inputs,"input")),await this.onChainEnd?.(s),await this._endTrace(s),s}async handleChainError(e,t,r,a,n){let s=this.runMap.get(t);if(!s)throw Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),n?.inputs!==void 0&&(s.inputs=i(n.inputs,"input")),await this.onChainError?.(s),await this._endTrace(s),s}_createRunForToolStart(e,t,r,a,i,n,s){let o=this._getExecutionOrder(a),l=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,a,i,n,s){let o=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,i,n,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);r&&r?.run_type==="chain"&&(r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r))}async handleAgentEnd(e,t){let r=this.runMap.get(t);r&&r?.run_type==="chain"&&(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,a,i,n,s){let o=this._getExecutionOrder(a),l=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,a,i,n,s){let o=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,i,n,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);r&&r?.run_type==="chain"&&(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,i,n){let s=this.runMap.get(r);if(!s||s?.run_type!=="llm")throw Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:n?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:n?.chunk}),s}}},921570:function(e,t,r){"use strict";r.d(t,{L:()=>o});var a=r(750980),i=r(350709);let n=[400,401,402,403,404,405,406,407,409],s=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name||e?.code==="ECONNABORTED")throw e;let t=e?.response?.status??e?.status;if(t&&n.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){let t=Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s;let t="default"in i?i.default:i;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>a(()=>e(...t).catch(e=>{if(e instanceof Error)throw e;throw Error(e)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}}},821614:function(e,t,r){"use strict";let a;r.d(t,{dU:()=>i,lS:()=>s,sA:()=>n});let i=()=>"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||"undefined"!=typeof Deno?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":"undefined"!=typeof Deno?"deno":"other":"node";async function n(){return void 0===a&&(a={library:"langchain-js",runtime:i()}),a}function s(e){try{if("undefined"!=typeof process)return process.env?.[e];if("undefined"!=typeof Deno)return Deno?.env.get(e);return}catch(e){return}}},635356:function(e,t,r){"use strict";r.d(t,{af:()=>_,qu:()=>x});var a={};r.r(a),r.d(a,{JsonPatchError:()=>p,_areEquals:()=>O,applyOperation:()=>b,applyPatch:()=>_,applyReducer:()=>v,deepClone:()=>f,getValueByPointer:()=>y,validate:()=>E,validator:()=>w});let i=Object.prototype.hasOwnProperty;function n(e,t){return i.call(e,t)}function s(e){if(Array.isArray(e)){let t=Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)n(e,r)&&t.push(r);return t}function o(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function l(e){let t,r=0,a=e.length;for(;r<a;){if((t=e.charCodeAt(r))>=48&&t<=57){r++;continue}return!1}return!0}function u(e){return -1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function c(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function d(e,t){let r=[e];for(let e in t){let a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==a&&r.push(`${e}: ${a}`)}return r.join("\n")}class h extends Error{constructor(e,t,r,a,i){super(d(e,{name:t,index:r,operation:a,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=d(e,{name:t,index:r,operation:a,tree:i})}}let p=h,f=o,m={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=y(r,this.path);a&&(a=o(a));let i=b(r,{op:"remove",path:this.from}).removed;return b(r,{op:"add",path:this.path,value:i}),{newDocument:r,removed:a}},copy:function(e,t,r){let a=y(r,this.from);return b(r,{op:"add",path:this.path,value:o(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:O(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var g={add:function(e,t,r){return l(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:m.move,copy:m.copy,test:m.test,_get:m._get};function y(e,t){if(""==t)return e;var r={op:"_get",path:t};return b(e,r),r.value}function b(e,t,r=!1,a=!0,i=!0,n=0){if(r&&("function"==typeof r?r(t,0,e,t.path):w(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=y(e,t.from),"move"===t.op&&(a.removed=e),a;else if("test"===t.op){if(a.test=O(e,t.value),!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return a.newDocument=e,a}else if("remove"===t.op)return a.removed=e,a.newDocument=null,a;else if("_get"===t.op)return t.value=e,a;else if(!r)return a;else throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,t,e)}{let s,u,d;a||(e=o(e));let h=(t.path||"").split("/"),f=e,y=1,b=h.length;for(u="function"==typeof r?r:w;;){if((s=h[y])&&-1!=s.indexOf("~")&&(s=c(s)),i&&("__proto__"==s||"prototype"==s&&y>0&&"constructor"==h[y-1]))throw TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===d&&(void 0===f[s]?d=h.slice(0,y).join("/"):y==b-1&&(d=t.path),void 0!==d&&u(t,0,e,d)),y++,Array.isArray(f)){if("-"===s)s=f.length;else if(r&&!l(s))throw new p("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",n,t,e);else l(s)&&(s=~~s);if(y>=b){if(r&&"add"===t.op&&s>f.length)throw new p("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",n,t,e);let a=g[t.op].call(t,f,s,e);if(!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return a}}else if(y>=b){let r=m[t.op].call(t,f,s,e);if(!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r}if(f=f[s],r&&y<b&&(!f||"object"!=typeof f))throw new p("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",n,t,e)}}}function _(e,t,r,a=!0,i=!0){if(r&&!Array.isArray(t))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=o(e));let n=Array(t.length);for(let a=0,s=t.length;a<s;a++)n[a]=b(e,t[a],r,!0,i,a),e=n[a].newDocument;return n.newDocument=e,n}function v(e,t,r){let a=b(e,t);if(!1===a.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return a.newDocument}function w(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new p("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(m[e.op]){if("string"!=typeof e.path)throw new p("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);else if(0!==e.path.indexOf("/")&&e.path.length>0)throw new p('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);else if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new p("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&function e(t){if(void 0===t)return!0;if(t){if(Array.isArray(t)){for(let r=0,a=t.length;r<a;r++)if(e(t[r]))return!0}else if("object"==typeof t){let a=s(t),i=a.length;for(var r=0;r<i;r++)if(e(t[a[r]]))return!0}}return!1}(e.value))throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);else if(r){if("add"==e.op){var i=e.path.split("/").length,n=a.split("/").length;if(i!==n+1&&i!==n)throw new p("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new p("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var o=E([{op:"_get",path:e.from,value:void 0}],r);if(o&&"OPERATION_PATH_UNRESOLVABLE"===o.name)throw new p("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function E(e,t,r){try{if(!Array.isArray(e))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)_(o(t),o(e),r||!0);else{r=r||w;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof p)return e;throw e}}function O(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,i,n=Array.isArray(e),s=Array.isArray(t);if(n&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!O(e[r],t[r]))return!1;return!0}if(n!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!O(e[i=o[r]],t[i]))return!1;return!0}return e!=e&&t!=t}function x(e,t,r=!1){var a=[];return!function e(t,r,a,i,l){if(r!==t){"function"==typeof r.toJSON&&(r=r.toJSON());for(var c=s(r),d=s(t),h=!1,p=d.length-1;p>=0;p--){var f=d[p],m=t[f];if(n(r,f)&&(void 0!==r[f]||void 0===m||!1!==Array.isArray(r))){var g=r[f];"object"==typeof m&&null!=m&&"object"==typeof g&&null!=g&&Array.isArray(m)===Array.isArray(g)?e(m,g,a,i+"/"+u(f),l):m!==g&&(l&&a.push({op:"test",path:i+"/"+u(f),value:o(m)}),a.push({op:"replace",path:i+"/"+u(f),value:o(g)}))}else Array.isArray(t)===Array.isArray(r)?(l&&a.push({op:"test",path:i+"/"+u(f),value:o(m)}),a.push({op:"remove",path:i+"/"+u(f)}),h=!0):(l&&a.push({op:"test",path:i,value:t}),a.push({op:"replace",path:i,value:r}))}if(h||c.length!=d.length)for(var p=0;p<c.length;p++){var f=c[p];n(t,f)||void 0===r[f]||a.push({op:"add",path:i+"/"+u(f),value:o(r[f])})}}}(e,t,a,"",r),a}new WeakMap,{...a,JsonPatchError:h,deepClone:o,escapePathComponent:u,unescapePathComponent:c}},609922:function(e,t,r){"use strict";function a(e,t=i){let r=(e=e.trim()).indexOf("```");if(-1===r)return t(e);let n=e.substring(r+3);n.startsWith("json\n")?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith("\n")&&(n=n.substring(1));let s=n.indexOf("```"),o=n;return -1!==s&&(o=n.substring(0,s)),t(o.trim())}function i(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="",r=[],a=!1,i=!1;for(let n of e){if(a)'"'!==n||i?"\n"!==n||i?i="\\"===n&&!i:n="\\n":a=!1;else if('"'===n)a=!0,i=!1;else if("{"===n)r.push("}");else if("["===n)r.push("]");else if("}"===n||"]"===n)if(!r||r[r.length-1]!==n)return null;else r.pop();t+=n}a&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}r.d(t,{M:()=>a,g:()=>i})},191301:function(e,t,r){"use strict";async function a(e,t){let r;return void 0===t?e:Promise.race([e.catch(e=>{if(!t?.aborted)throw e}),new Promise((e,a)=>{r=()=>{a(Error("Aborted"))},t.addEventListener("abort",r),t.aborted&&a(Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",r))}r.d(t,{E:()=>a})},730373:function(e,t,r){"use strict";r.d(t,{E7:()=>u,QJ:()=>s,qq:()=>l,y2:()=>o,zo:()=>function e(t,r){if(Array.isArray(t)&&Array.isArray(r))return t.concat(r);if("string"==typeof t&&"string"==typeof r)return t+r;if("number"==typeof t&&"number"==typeof r)return t+r;if("concat"in t&&"function"==typeof t.concat)return t.concat(r);if("object"==typeof t&&"object"==typeof r){let a={...t};for(let[t,i]of Object.entries(r))t in a&&!Array.isArray(a[t])?a[t]=e(a[t],i):a[t]=i;return a}else throw Error(`Cannot concat ${typeof t} and ${typeof r}`)}});var a=r(791388),i=r(731858),n=r(191301);class s extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();if(e.done)return this.reader.releaseLock(),{done:!0,value:void 0};return{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async [Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new s({start:e=>(function r(){return t.read().then(({done:t,value:a})=>t?void e.close():(e.enqueue(a),r()))})(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new s({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function o(e,t=2){let r=Array.from({length:t},()=>[]);return r.map(async function*(t){for(;;)if(0===t.length){let t=await e.next();for(let e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}class l{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{i.AO.runWithConfig((0,a.yG)(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(e=>t(void 0),r)},!0)})}async next(...e){return(this.signal?.throwIfAborted(),this.firstResultUsed)?i.AO.runWithConfig((0,a.yG)(this.config),this.signal?async()=>(0,n.E)(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async [Symbol.asyncDispose](){await this.return()}}async function u(e,t,r,a,...i){let n=new l({generator:t,startSetup:r,signal:a}),s=await n.setup;return{output:e(n,s,...i),setup:s}}},778168:function(e,t,r){"use strict";r.d(t,{Cr:()=>a.Cr,GC:()=>a.GC,HD:()=>a.HD,J:()=>a.J,JG:()=>a.JG,SR:()=>a.SR,VL:()=>a.VL,Xz:()=>a.Xz,Z0:()=>a.Z0,gY:()=>a.gY,jN:()=>a.jN,ro:()=>a.ro,uy:()=>a.uy,xk:()=>a.xk,xq:()=>a.xq});var a=r(646600)},418856:function(e,t,r){"use strict";let a,i,n,s,o,l,u,c,d,h,p,f;r.d(t,{z7:()=>np});let m="RFC3986",g={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)};Object.prototype.hasOwnProperty;let y=Array.isArray,b=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();function _(e,t){if(y(e)){let r=[];for(let a=0;a<e.length;a+=1)r.push(t(e[a]));return r}return t(e)}let v=Object.prototype.hasOwnProperty,w={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},E=Array.isArray,O=Array.prototype.push,x=function(e,t){O.apply(e,E(t)?t:[t])},$=Date.prototype.toISOString,A={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,r,a,i)=>{if(0===e.length)return e;let n=e;if("symbol"==typeof e?n=Symbol.prototype.toString.call(e):"string"!=typeof e&&(n=String(e)),"iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let s="";for(let e=0;e<n.length;e+=1024){let t=n.length>=1024?n.slice(e,e+1024):n,r=[];for(let e=0;e<t.length;++e){let a=t.charCodeAt(e);if(45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122||"RFC1738"===i&&(40===a||41===a)){r[r.length]=t.charAt(e);continue}if(a<128){r[r.length]=b[a];continue}if(a<2048){r[r.length]=b[192|a>>6]+b[128|63&a];continue}if(a<55296||a>=57344){r[r.length]=b[224|a>>12]+b[128|a>>6&63]+b[128|63&a];continue}e+=1,a=65536+((1023&a)<<10|1023&t.charCodeAt(e)),r[r.length]=b[240|a>>18]+b[128|a>>12&63]+b[128|a>>6&63]+b[128|63&a]}s+=r.join("")}return s},encodeValuesOnly:!1,format:m,formatter:g[m],indices:!1,serializeDate:e=>$.call(e),skipNulls:!1,strictNullHandling:!1},S={},k="4.98.0",P=!1;class I{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}let j=()=>{n||function(e,t={auto:!1}){if(P)throw Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(n)throw Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${n}'\``);P=t.auto,n=e.kind,s=e.fetch,e.Request,e.Response,e.Headers,o=e.FormData,e.Blob,l=e.File,u=e.ReadableStream,c=e.getMultipartRequestOptions,d=e.getDefaultAgent,h=e.fileFromPath,p=e.isFsReadStream}(function({manuallyImported:e}={}){let t,r,a,i,n=e?"You may need to use polyfills":`Add one of these imports before your first \`import  from 'openai'\`:
- \`import 'openai/shims/node'\` (if you're running on Node)
- \`import 'openai/shims/web'\` (otherwise)
`;try{t=fetch,r=Request,a=Response,i=Headers}catch(e){throw Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${n}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:i,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${n}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${n}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${n}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${n}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new I(e)}),getDefaultAgent:e=>void 0,fileFromPath:()=>{throw Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};j();class T extends Error{}class R extends T{constructor(e,t,r,a){super(`${R.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a?.["x-request-id"],this.error=t,this.code=t?.code,this.param=t?.param,this.type=t?.type}static makeMessage(e,t,r){let a=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new N({message:r,cause:tU(t)});let i=t?.error;return 400===e?new M(e,i,r,a):401===e?new U(e,i,r,a):403===e?new D(e,i,r,a):404===e?new F(e,i,r,a):409===e?new B(e,i,r,a):422===e?new z(e,i,r,a):429===e?new q(e,i,r,a):e>=500?new H(e,i,r,a):new R(e,i,r,a)}}class C extends R{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class N extends R{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class L extends N{constructor({message:e}={}){super({message:e??"Request timed out."})}}class M extends R{}class U extends R{}class D extends R{}class F extends R{}class B extends R{}class z extends R{}class q extends R{}class H extends R{}class Z extends T{constructor(){super("Could not parse response content as the length limit was reached")}}class J extends T{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var G,W,V,K,X,Y,Q,ee,et,er,ea,ei,en,es,eo,el,eu,ec,ed,eh,ep,ef,em,eg,ey,eb,e_,ev,ew,eE,eO,ex,e$,eA,eS,ek,eP,eI,ej,eT,eR,eC,eN,eL,eM,eU,eD,eF,eB,ez,eq,eH,eZ,eJ,eG,eW,eV,eK,eX,eY,eQ,e0,e1,e2,e4,e9,e3,e5,e6,e8=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r},e7=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};class te{constructor(){K.set(this,void 0),this.buffer=new Uint8Array,e8(this,K,null,"f")}decode(e){let t;if(null==e)return[];let r=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?new TextEncoder().encode(e):e,a=new Uint8Array(this.buffer.length+r.length);a.set(this.buffer),a.set(r,this.buffer.length),this.buffer=a;let i=[];for(;null!=(t=function(e,t){for(let r=t??0;r<e.length;r++){if(10===e[r])return{preceding:r,index:r+1,carriage:!1};if(13===e[r])return{preceding:r,index:r+1,carriage:!0}}return null}(this.buffer,e7(this,K,"f")));){if(t.carriage&&null==e7(this,K,"f")){e8(this,K,t.index,"f");continue}if(null!=e7(this,K,"f")&&(t.index!==e7(this,K,"f")+1||t.carriage)){i.push(this.decodeText(this.buffer.slice(0,e7(this,K,"f")-1))),this.buffer=this.buffer.slice(e7(this,K,"f")),e8(this,K,null,"f");continue}let e=null!==e7(this,K,"f")?t.preceding-1:t.preceding,r=this.decodeText(this.buffer.slice(0,e));i.push(r),this.buffer=this.buffer.slice(t.index),e8(this,K,null,"f")}return i}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new T(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new T(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new T("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function tt(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){let e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}K=new WeakMap,te.NEWLINE_CHARS=new Set(["\n","\r"]),te.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class tr{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(let r of ta(e,t))if(!a){if(r.data.startsWith("[DONE]")){a=!0;continue}if(null===r.event||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let t;try{t=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(t&&t.error)throw new R(void 0,t.error,void 0,tS(e.headers));yield t}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new R(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}}a=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{a||t.abort()}}return new tr(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let t=new te;for await(let r of tt(e))for(let e of t.decode(r))yield e;for(let e of t.flush())yield e}return new tr(async function*(){if(r)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(let t of a())!e&&t&&(yield JSON.parse(t));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=a=>({next:()=>{if(0===a.length){let a=r.next();e.push(a),t.push(a)}return a.shift()}});return[new tr(()=>a(e),this.controller),new tr(()=>a(t),this.controller)]}toReadableStream(){let e,t=this,r=new TextEncoder;return new u({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{let{value:a,done:i}=await e.next();if(i)return t.close();let n=r.encode(JSON.stringify(a)+"\n");t.enqueue(n)}catch(e){t.error(e)}},async cancel(){await e.return?.()}})}}async function*ta(e,t){if(!e.body)throw t.abort(),new T("Attempted to iterate over a response with no body");let r=new tn,a=new te;for await(let t of ti(tt(e.body)))for(let e of a.decode(t)){let t=r.decode(e);t&&(yield t)}for(let e of a.flush()){let t=r.decode(e);t&&(yield t)}}async function*ti(e){let t=new Uint8Array;for await(let r of e){let e;if(null==r)continue;let a=r instanceof ArrayBuffer?new Uint8Array(r):"string"==typeof r?new TextEncoder().encode(r):r,i=new Uint8Array(t.length+a.length);for(i.set(t),i.set(a,t.length),t=i;-1!==(e=function(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1]||13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return -1}(t));)yield t.slice(0,e),t=t.slice(e)}t.length>0&&(yield t)}class tn{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=function(e,t){let r=e.indexOf(":");return -1!==r?[e.substring(0,r),t,e.substring(r+t.length)]:[e,"",""]}(e,":");return a.startsWith(" ")&&(a=a.substring(1)),"event"===t?this.event=a:"data"===t&&this.data.push(a),null}}let ts=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,to=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&tl(e),tl=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer,tu=e=>to(e)||ts(e)||p(e);async function tc(e,t,r){var a;if(to(e=await e))return e;if(ts(e)){let a=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=tl(a)?[await a.arrayBuffer()]:[a];return new l(i,t,r)}let i=await td(e);if(t||(t=(th((a=e).name)||th(a.filename)||th(a.path)?.split(/[\\/]/).pop())??"unknown_file"),!r?.type){let e=i[0]?.type;"string"==typeof e&&(r={...r,type:e})}return new l(i,t,r)}async function td(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(tl(e))t.push(await e.arrayBuffer());else if(tp(e))for await(let r of e)t.push(r);else throw Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){let t=Object.getOwnPropertyNames(e);return`[${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`);return t}let th=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,tp=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],tf=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],tm=async e=>{let t=await tg(e.body);return c(t,e)},tg=async e=>{let t=new o;return await Promise.all(Object.entries(e||{}).map(([e,r])=>tb(t,e,r))),t},ty=e=>{if(tu(e))return!0;if(Array.isArray(e))return e.some(ty);if(e&&"object"==typeof e){for(let t in e)if(ty(e[t]))return!0}return!1},tb=async(e,t,r)=>{if(void 0!==r){if(null==r)throw TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)e.append(t,String(r));else if(tu(r)){let a=await tc(r);e.append(t,a)}else if(Array.isArray(r))await Promise.all(r.map(r=>tb(e,t+"[]",r)));else if("object"==typeof r)await Promise.all(Object.entries(r).map(([r,a])=>tb(e,`${t}[${r}]`,a)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`)}};var t_=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r},tv=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};async function tw(e){let{response:t}=e;if(e.options.stream)return(tH("response",t.status,t.url,t.headers,t.body),e.options.__streamClass)?e.options.__streamClass.fromSSEResponse(t,e.controller):tr.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;let r=t.headers.get("content-type"),a=r?.split(";")[0]?.trim();if(a?.includes("application/json")||a?.endsWith("+json")){let e=await t.json();return tH("response",t.status,t.url,t.headers,e),tE(e,t)}let i=await t.text();return tH("response",t.status,t.url,t.headers,i),i}function tE(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}j();class tO extends Promise{constructor(e,t=tw){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new tO(this.responsePromise,async t=>tE(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class tx{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:i}){this.baseURL=e,this.maxRetries=tM("maxRetries",t),this.timeout=tM("timeout",r),this.httpAgent=a,this.fetch=i??s}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...tT(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${tZ()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async r=>{let a=r&&tl(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:a}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:a,path:i,query:n,headers:s={}}=r,o=ArrayBuffer.isView(r.body)||r.__binaryRequest&&"string"==typeof r.body?r.body:tf(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,l=this.calculateContentLength(o),u=this.buildURL(i,n);"timeout"in r&&tM("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let c=r.httpAgent??this.httpAgent??d(u),h=r.timeout+1e3;"number"==typeof c?.options?.timeout&&h>(c.options.timeout??0)&&(c.options.timeout=h),this.idempotencyHeader&&"get"!==a&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let p=this.buildHeaders({options:r,headers:s,contentLength:l,retryCount:t});return{req:{method:a,...o&&{body:o},headers:p,...c&&{agent:c},signal:r.signal??null},url:u,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){let i={};r&&(i["content-length"]=r);let s=this.defaultHeaders(e);return tz(i,s),tz(i,t),tf(e.body)&&"node"!==n&&delete i["content-type"],void 0===tJ(s,"x-stainless-retry-count")&&void 0===tJ(t,"x-stainless-retry-count")&&(i["x-stainless-retry-count"]=String(a)),void 0===tJ(s,"x-stainless-timeout")&&void 0===tJ(t,"x-stainless-timeout")&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,t,r,a){return R.generate(e,t,r,a)}request(e,t=null){return new tO(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e,a=r.maxRetries??this.maxRetries;null==t&&(t=a),await this.prepareOptions(r);let{req:i,url:n,timeout:s}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(i,{url:n,options:r}),tH("request",n,r,i.headers),r.signal?.aborted)throw new C;let o=new AbortController,l=await this.fetchWithTimeout(n,i,s,o).catch(tU);if(l instanceof Error){if(r.signal?.aborted)throw new C;if(t)return this.retryRequest(r,t);if("AbortError"===l.name)throw new L;throw new N({cause:l})}let u=tS(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){let e=`retrying, ${t} attempts remaining`;return tH(`response (error; ${e})`,l.status,n,u),this.retryRequest(r,t,u)}let e=await l.text().catch(e=>tU(e).message),a=tR(e),i=a?void 0:e,s=t?"(error; no more retries left)":"(error; not retryable)";throw tH(`response (error; ${s})`,l.status,n,u,i),this.makeStatusError(l.status,a,i,u)}return{response:l,options:r,controller:o}}requestAPIList(e,t){return new tA(this,this.makeRequest(t,null),e)}buildURL(e,t){let r=new URL(tN(e)?e:this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return tF(a)||(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new T(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:i,...n}=t||{};i&&i.addEventListener("abort",()=>a.abort());let s=setTimeout(()=>a.abort(),r),o={signal:a.signal,...n};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(s)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||!!(e.status>=500))}async retryRequest(e,t,r){let a,i=r?.["retry-after-ms"];if(i){let e=parseFloat(i);Number.isNaN(e)||(a=e)}let n=r?.["retry-after"];if(n&&!a){let e=parseFloat(n);a=Number.isNaN(e)?Date.parse(n)-Date.now():1e3*e}if(!(a&&0<=a&&a<6e4)){let r=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,r)}return await tL(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){return Math.min(.5*Math.pow(2,t-e),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${k}`}}class t${constructor(e,t,r,a){X.set(this,void 0),t_(this,X,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new T("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){for(let[r,a]of[...Object.entries(t.query||{}),...e.url.searchParams.entries()])e.url.searchParams.set(r,a);t.query=void 0,t.path=e.url.toString()}return await tv(this,X,"f").requestAPIList(this.constructor,t)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(X=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}}class tA extends tO{constructor(e,t,r){super(t,async t=>new r(e,t.response,await tw(t),t.options))}async *[Symbol.asyncIterator](){for await(let e of(await this))yield e}}let tS=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),tk={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},tP=e=>"object"==typeof e&&null!==e&&!tF(e)&&Object.keys(e).every(e=>tB(tk,e)),tI=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",tj=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown",tT=()=>a??(a=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":k,"X-Stainless-OS":tj(Deno.build.os),"X-Stainless-Arch":tI(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":k,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":k,"X-Stainless-OS":tj(process.platform),"X-Stainless-Arch":tI(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let e=function(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:e,pattern:t}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let r=t.exec(navigator.userAgent);if(r){let t=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${t}.${a}.${i}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":k,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":k,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),tR=e=>{try{return JSON.parse(e)}catch(e){return}},tC=/^[a-z][a-z0-9+.-]*:/i,tN=e=>tC.test(e),tL=e=>new Promise(t=>setTimeout(t,e)),tM=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new T(`${e} must be an integer`);if(t<0)throw new T(`${e} must be a positive integer`);return t},tU=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return Error(JSON.stringify(e))}catch{}return Error(e)},tD=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function tF(e){if(!e)return!0;for(let t in e)return!1;return!0}function tB(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function tz(e,t){for(let r in t){if(!tB(t,r))continue;let a=r.toLowerCase();if(!a)continue;let i=t[r];null===i?delete e[a]:void 0!==i&&(e[a]=i)}}let tq=new Set(["authorization","api-key"]);function tH(e,...t){"undefined"!=typeof process&&process?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${e}`,...t.map(e=>{if(!e)return e;if(e.headers){let t={...e,headers:{...e.headers}};for(let r in e.headers)tq.has(r.toLowerCase())&&(t.headers[r]="REDACTED");return t}let t=null;for(let r in e)tq.has(r.toLowerCase())&&(t??(t={...e}),t[r]="REDACTED");return t??e}))}let tZ=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),tJ=(e,t)=>{let r=t.toLowerCase();if("function"==typeof e?.get){let a=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(e,t,r)=>t+r.toUpperCase());for(let i of[t,r,t.toUpperCase(),a]){let t=e.get(i);if(t)return t}}for(let[a,i]of Object.entries(e))if(a.toLowerCase()===r){if(Array.isArray(i)){if(i.length<=1)return i[0];return console.warn(`Received ${i.length} entries for the ${t} header, using the first entry.`),i[0]}return i}};function tG(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class tW{constructor(e){this._client=e}}class tV extends tW{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class tK extends tW{list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,t1,{query:t,...r})}}class tX extends t${constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class tY extends t${constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class tQ extends tW{constructor(){super(...arguments),this.messages=new tK(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/chat/completions",t0,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class t0 extends tY{}class t1 extends tY{}tQ.ChatCompletionsPage=t0,tQ.Messages=tK;class t2 extends tW{constructor(){super(...arguments),this.completions=new tQ(this._client)}}t2.Completions=tQ,t2.ChatCompletionsPage=t0;class t4 extends tW{create(e,t){let r=!!e.encoding_format,a=r?e.encoding_format:"base64";r&&tH("Request","User defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:a},...t});return r?i:(tH("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{let t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){let t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{let t=atob(e),r=t.length,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=t.charCodeAt(e);return Array.from(new Float32Array(a.buffer))}})(t)}),e)))}}class t9 extends tW{create(e,t){return this._client.post("/files",tm({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/files",t3,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=18e5}={}){let a=new Set(["processed","error","deleted"]),i=Date.now(),n=await this.retrieve(e);for(;!n.status||!a.has(n.status);)if(await tL(t),n=await this.retrieve(e),Date.now()-i>r)throw new L({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return n}}class t3 extends tY{}t9.FileObjectsPage=t3;class t5 extends tW{createVariation(e,t){return this._client.post("/images/variations",tm({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",tm({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class t6 extends tW{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class t8 extends tW{create(e,t){return this._client.post("/audio/transcriptions",tm({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class t7 extends tW{create(e,t){return this._client.post("/audio/translations",tm({body:e,...t,__metadata:{model:e.model}}))}}class re extends tW{constructor(){super(...arguments),this.transcriptions=new t8(this._client),this.translations=new t7(this._client),this.speech=new t6(this._client)}}re.Transcriptions=t8,re.Translations=t7,re.Speech=t6;class rt extends tW{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class rr extends tW{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ra,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class ra extends tX{}rr.ModelsPage=ra;class ri extends tW{}class rn extends tW{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class rs extends tW{constructor(){super(...arguments),this.graders=new rn(this._client)}}rs.Graders=rn;class ro extends tW{create(e,t,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,rl,{body:t,method:"post",...r})}retrieve(e,t={},r){return tP(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}del(e,t,r){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,r)}}class rl extends tX{}ro.PermissionCreateResponsesPage=rl;class ru extends tW{constructor(){super(...arguments),this.permissions=new ro(this._client)}}ru.Permissions=ro,ru.PermissionCreateResponsesPage=rl;class rc extends tW{list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,rd,{query:t,...r})}}class rd extends tY{}rc.FineTuningJobCheckpointsPage=rd;class rh extends tW{constructor(){super(...arguments),this.checkpoints=new rc(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",rp,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return tP(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,rf,{query:t,...r})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class rp extends tY{}class rf extends tY{}rh.FineTuningJobsPage=rp,rh.FineTuningJobEventsPage=rf,rh.Checkpoints=rc,rh.FineTuningJobCheckpointsPage=rd;class rm extends tW{constructor(){super(...arguments),this.methods=new ri(this._client),this.jobs=new rh(this._client),this.checkpoints=new ru(this._client),this.alpha=new rs(this._client)}}rm.Methods=ri,rm.Jobs=rh,rm.FineTuningJobsPage=rp,rm.FineTuningJobEventsPage=rf,rm.Checkpoints=ru,rm.Alpha=rs;class rg extends tW{}class ry extends tW{constructor(){super(...arguments),this.graderModels=new rg(this._client)}}ry.GraderModels=rg;let rb=async e=>{let t=await Promise.allSettled(e),r=t.filter(e=>"rejected"===e.status);if(r.length){for(let e of r)console.error(e.reason);throw Error(`${r.length} promise(s) failed - see the above errors`)}let a=[];for(let e of t)"fulfilled"===e.status&&a.push(e.value);return a};class r_ extends tW{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,rv,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let i=await this.retrieve(e,t,{...r,headers:a}).withResponse(),n=i.data;switch(n.status){case"in_progress":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=i.response.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tL(s);break;case"failed":case"completed":return n}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,rw,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class rv extends tY{}class rw extends tX{}r_.VectorStoreFilesPage=rv,r_.FileContentResponsesPage=rw;class rE extends tW{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return tP(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,rv,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:i,response:n}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(i.status){case"in_progress":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=n.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tL(s);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(null==t||0==t.length)throw Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=Math.min(a?.maxConcurrency??5,t.length),n=this._client,s=t.values(),o=[...r];async function l(e){for(let t of e){let e=await n.files.create({file:t,purpose:"assistants"},a);o.push(e.id)}}let u=Array(i).fill(s).map(l);return await rb(u),await this.createAndPoll(e,{file_ids:o})}}class rO extends tW{constructor(){super(...arguments),this.files=new r_(this._client),this.fileBatches=new rE(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/vector_stores",rx,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,r$,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class rx extends tY{}class r$ extends tX{}rO.VectorStoresPage=rx,rO.VectorStoreSearchResponsesPage=r$,rO.Files=r_,rO.VectorStoreFilesPage=rv,rO.FileContentResponsesPage=rw,rO.FileBatches=rE;class rA extends tW{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/assistants",rS,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class rS extends tY{}function rk(e){return"function"==typeof e.parse}rA.AssistantsPage=rS;let rP=e=>e?.role==="assistant",rI=e=>e?.role==="function",rj=e=>e?.role==="tool";var rT=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r},rR=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};class rC{constructor(){Y.add(this),this.controller=new AbortController,Q.set(this,void 0),ee.set(this,()=>{}),et.set(this,()=>{}),er.set(this,void 0),ea.set(this,()=>{}),ei.set(this,()=>{}),en.set(this,{}),es.set(this,!1),eo.set(this,!1),el.set(this,!1),eu.set(this,!1),rT(this,Q,new Promise((e,t)=>{rT(this,ee,e,"f"),rT(this,et,t,"f")}),"f"),rT(this,er,new Promise((e,t)=>{rT(this,ea,e,"f"),rT(this,ei,t,"f")}),"f"),rR(this,Q,"f").catch(()=>{}),rR(this,er,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},rR(this,Y,"m",ec).bind(this))},0)}_connected(){this.ended||(rR(this,ee,"f").call(this),this._emit("connect"))}get ended(){return rR(this,es,"f")}get errored(){return rR(this,eo,"f")}get aborted(){return rR(this,el,"f")}abort(){this.controller.abort()}on(e,t){return(rR(this,en,"f")[e]||(rR(this,en,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=rR(this,en,"f")[e];if(!r)return this;let a=r.findIndex(e=>e.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(rR(this,en,"f")[e]||(rR(this,en,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{rT(this,eu,!0,"f"),"error"!==e&&this.once("error",r),this.once(e,t)})}async done(){rT(this,eu,!0,"f"),await rR(this,er,"f")}_emit(e,...t){if(rR(this,es,"f"))return;"end"===e&&(rT(this,es,!0,"f"),rR(this,ea,"f").call(this));let r=rR(this,en,"f")[e];if(r&&(rR(this,en,"f")[e]=r.filter(e=>!e.once),r.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];rR(this,eu,"f")||r?.length||Promise.reject(e),rR(this,et,"f").call(this,e),rR(this,ei,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];rR(this,eu,"f")||r?.length||Promise.reject(e),rR(this,et,"f").call(this,e),rR(this,ei,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function rN(e){return e?.$brand==="auto-parseable-response-format"}function rL(e){return e?.$brand==="auto-parseable-tool"}function rM(e,t){let r=e.choices.map(e=>{var r,a;if("length"===e.finish_reason)throw new Z;if("content_filter"===e.finish_reason)throw new J;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>(function(e,t){let r=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:rL(r)?r.$parseRaw(t.function.arguments):r?.function.strict?JSON.parse(t.function.arguments):null}}})(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?(r=t,a=e.message.content,r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(a):JSON.parse(a):null):null}}});return{...e,choices:r}}function rU(e){return!!rN(e.response_format)||(e.tools?.some(e=>rL(e)||"function"===e.type&&!0===e.function.strict)??!1)}Q=new WeakMap,ee=new WeakMap,et=new WeakMap,er=new WeakMap,ea=new WeakMap,ei=new WeakMap,en=new WeakMap,es=new WeakMap,eo=new WeakMap,el=new WeakMap,eu=new WeakMap,Y=new WeakSet,ec=function(e){if(rT(this,eo,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new C),e instanceof C)return rT(this,el,!0,"f"),this._emit("abort",e);if(e instanceof T)return this._emit("error",e);if(e instanceof Error){let t=new T(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new T(String(e)))};var rD=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};class rF extends rC{constructor(){super(...arguments),ed.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(rI(e)||rj(e))&&e.content)this._emit("functionCallResult",e.content);else if(rP(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(rP(e)&&e.tool_calls)for(let t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new T("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),rD(this,ed,"m",eh).call(this)}async finalMessage(){return await this.done(),rD(this,ed,"m",ep).call(this)}async finalFunctionCall(){return await this.done(),rD(this,ed,"m",ef).call(this)}async finalFunctionCallResult(){return await this.done(),rD(this,ed,"m",em).call(this)}async totalUsage(){return await this.done(),rD(this,ed,"m",eg).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=rD(this,ed,"m",ep).call(this);t&&this._emit("finalMessage",t);let r=rD(this,ed,"m",eh).call(this);r&&this._emit("finalContent",r);let a=rD(this,ed,"m",ef).call(this);a&&this._emit("finalFunctionCall",a);let i=rD(this,ed,"m",em).call(this);null!=i&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",rD(this,ed,"m",eg).call(this))}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),rD(this,ed,"m",ey).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(rM(i,t))}async _runChatCompletion(e,t,r){for(let e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){let a="function",{function_call:i="auto",stream:n,...s}=t,o="string"!=typeof i&&i?.name,{maxChatCompletions:l=10}=r||{},u={};for(let e of t.functions)u[e.name||e.function.name]=e;let c=t.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t,n=await this._createChatCompletion(e,{...s,function_call:i,functions:c,messages:[...this.messages]},r),l=n.choices[0]?.message;if(!l)throw new T("missing message in ChatCompletion response");if(!l.function_call)return;let{name:d,arguments:h}=l.function_call,p=u[d];if(p){if(o&&o!==d){let e=`Invalid function_call: ${JSON.stringify(d)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:a,name:d,content:e});continue}}else{let e=`Invalid function_call: ${JSON.stringify(d)}. Available options are: ${c.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:d,content:e});continue}try{t=rk(p)?await p.parse(h):h}catch(e){this._addMessage({role:a,name:d,content:e instanceof Error?e.message:String(e)});continue}let f=await p.function(t,this),m=rD(this,ed,"m",eb).call(this,f);if(this._addMessage({role:a,name:d,content:m}),o)return}}async _runTools(e,t,r){let a="tool",{tool_choice:i="auto",stream:n,...s}=t,o="string"!=typeof i&&i?.function?.name,{maxChatCompletions:l=10}=r||{},u=t.tools.map(e=>{if(rL(e)){if(!e.$callback)throw new T("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),c={};for(let e of u)"function"===e.type&&(c[e.function.name||e.function.function.name]=e.function);let d="tools"in t?u.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t=await this._createChatCompletion(e,{...s,tool_choice:i,tools:d,messages:[...this.messages]},r),n=t.choices[0]?.message;if(!n)throw new T("missing message in ChatCompletion response");if(!n.tool_calls?.length)break;for(let e of n.tool_calls){let t;if("function"!==e.type)continue;let r=e.id,{name:i,arguments:n}=e.function,s=c[i];if(s){if(o&&o!==i){let e=`Invalid tool_call: ${JSON.stringify(i)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:a,tool_call_id:r,content:e});continue}}else{let e=`Invalid tool_call: ${JSON.stringify(i)}. Available options are: ${Object.keys(c).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:r,content:e});continue}try{t=rk(s)?await s.parse(n):n}catch(t){let e=t instanceof Error?t.message:String(t);this._addMessage({role:a,tool_call_id:r,content:e});continue}let l=await s.function(t,this),u=rD(this,ed,"m",eb).call(this,l);if(this._addMessage({role:a,tool_call_id:r,content:u}),o)return}}}}ed=new WeakSet,eh=function(){return rD(this,ed,"m",ep).call(this).content??null},ep=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(rP(t)){let{function_call:e,...r}=t,a={...r,content:t.content??null,refusal:t.refusal??null};return e&&(a.function_call=e),a}}throw new T("stream ended without producing a ChatCompletionMessage with role=assistant")},ef=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(rP(t)&&t?.function_call)return t.function_call;if(rP(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},em=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(rI(t)&&null!=t.content||rj(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},eg=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},ey=function(e){if(null!=e.n&&e.n>1)throw new T("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},eb=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class rB extends rF{static runFunctions(e,t,r){let a=new rB,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,i)),a}static runTools(e,t,r){let a=new rB,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}_addMessage(e,t=!0){super._addMessage(e,t),rP(e)&&e.content&&this._emit("content",e.content)}}let rz=511;class rq extends Error{}class rH extends Error{}let rZ=e=>(function(e,t=rz){if("string"!=typeof e)throw TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw Error(`${e} is empty`);return((e,t)=>{let r=e.length,a=0,i=e=>{throw new rq(`${e} at position ${a}`)},n=e=>{throw new rH(`${e} at position ${a}`)},s=()=>(d(),a>=r&&i("Unexpected end of input"),'"'===e[a])?o():"{"===e[a]?l():"["===e[a]?u():"null"===e.substring(a,a+4)||16&t&&r-a<4&&"null".startsWith(e.substring(a))?(a+=4,null):"true"===e.substring(a,a+4)||32&t&&r-a<4&&"true".startsWith(e.substring(a))?(a+=4,!0):"false"===e.substring(a,a+5)||32&t&&r-a<5&&"false".startsWith(e.substring(a))?(a+=5,!1):"Infinity"===e.substring(a,a+8)||128&t&&r-a<8&&"Infinity".startsWith(e.substring(a))?(a+=8,1/0):"-Infinity"===e.substring(a,a+9)||256&t&&1<r-a&&r-a<9&&"-Infinity".startsWith(e.substring(a))?(a+=9,-1/0):"NaN"===e.substring(a,a+3)||64&t&&r-a<3&&"NaN".startsWith(e.substring(a))?(a+=3,NaN):c(),o=()=>{let s=a,o=!1;for(a++;a<r&&('"'!==e[a]||o&&"\\"===e[a-1]);)o="\\"===e[a]&&!o,a++;if('"'==e.charAt(a))try{return JSON.parse(e.substring(s,++a-Number(o)))}catch(e){n(String(e))}else if(1&t)try{return JSON.parse(e.substring(s,a-Number(o))+'"')}catch(t){return JSON.parse(e.substring(s,e.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},l=()=>{a++,d();let n={};try{for(;"}"!==e[a];){if(d(),a>=r&&8&t)return n;let i=o();d(),a++;try{let e=s();Object.defineProperty(n,i,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return n;throw e}d(),","===e[a]&&a++}}catch(e){if(8&t)return n;i("Expected '}' at end of object")}return a++,n},u=()=>{a++;let r=[];try{for(;"]"!==e[a];)r.push(s()),d(),","===e[a]&&a++}catch(e){if(4&t)return r;i("Expected ']' at end of array")}return a++,r},c=()=>{if(0===a){"-"===e&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e)}catch(r){if(2&t)try{if("."===e[e.length-1])return JSON.parse(e.substring(0,e.lastIndexOf(".")));return JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}n(String(r))}}let s=a;for("-"===e[a]&&a++;e[a]&&!",]}".includes(e[a]);)a++;a!=r||2&t||i("Unterminated number literal");try{return JSON.parse(e.substring(s,a))}catch(r){"-"===e.substring(s,a)&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e.substring(s,e.lastIndexOf("e")))}catch(e){n(String(e))}}},d=()=>{for(;a<r&&" \n\r	".includes(e[a]);)a++};return s()})(e.trim(),t)})(e,2^rz);var rJ=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r},rG=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};class rW extends rF{constructor(e){super(),e_.add(this),ev.set(this,void 0),ew.set(this,void 0),eE.set(this,void 0),rJ(this,ev,e,"f"),rJ(this,ew,[],"f")}get currentChatCompletionSnapshot(){return rG(this,eE,"f")}static fromReadableStream(e){let t=new rW(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new rW(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){super._createChatCompletion;let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),rG(this,e_,"m",eO).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});for await(let e of(this._connected(),i))rG(this,e_,"m",e$).call(this,e);if(i.controller.signal?.aborted)throw new C;return this._addChatCompletion(rG(this,e_,"m",ek).call(this))}async _fromReadableStream(e,t){let r,a=t?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),rG(this,e_,"m",eO).call(this),this._connected();let i=tr.fromReadableStream(e,this.controller);for await(let e of i)r&&r!==e.id&&this._addChatCompletion(rG(this,e_,"m",ek).call(this)),rG(this,e_,"m",e$).call(this,e),r=e.id;if(i.controller.signal?.aborted)throw new C;return this._addChatCompletion(rG(this,e_,"m",ek).call(this))}[(ev=new WeakMap,ew=new WeakMap,eE=new WeakMap,e_=new WeakSet,eO=function(){this.ended||rJ(this,eE,void 0,"f")},ex=function(e){let t=rG(this,ew,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},rG(this,ew,"f")[e.index]=t),t},e$=function(e){if(this.ended)return;let t=rG(this,e_,"m",eI).call(this,e);for(let r of(this._emit("chunk",e,t),e.choices)){let e=t.choices[r.index];null!=r.delta.content&&e.message?.role==="assistant"&&e.message?.content&&(this._emit("content",r.delta.content,e.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=r.delta.refusal&&e.message?.role==="assistant"&&e.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:e.message.refusal}),r.logprobs?.content!=null&&e.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:e.logprobs?.content??[]}),r.logprobs?.refusal!=null&&e.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});let a=rG(this,e_,"m",ex).call(this,e);for(let t of(e.finish_reason&&(rG(this,e_,"m",eS).call(this,e),null!=a.current_tool_call_index&&rG(this,e_,"m",eA).call(this,e,a.current_tool_call_index)),r.delta.tool_calls??[]))a.current_tool_call_index!==t.index&&(rG(this,e_,"m",eS).call(this,e),null!=a.current_tool_call_index&&rG(this,e_,"m",eA).call(this,e,a.current_tool_call_index)),a.current_tool_call_index=t.index;for(let t of r.delta.tool_calls??[]){let r=e.message.tool_calls?.[t.index];r?.type&&(r?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:r.function?.name,index:t.index,arguments:r.function.arguments,parsed_arguments:r.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):r?.type)}}},eA=function(e,t){if(rG(this,e_,"m",ex).call(this,e).done_tool_calls.has(t))return;let r=e.message.tool_calls?.[t];if(!r)throw Error("no tool call snapshot");if(!r.type)throw Error("tool call snapshot missing `type`");if("function"===r.type){let e=rG(this,ev,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:rL(e)?e.$parseRaw(r.function.arguments):e?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},eS=function(e){let t=rG(this,e_,"m",ex).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;let r=rG(this,e_,"m",eP).call(this);this._emit("content.done",{content:e.message.content,parsed:r?r.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},ek=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");let e=rG(this,eE,"f");if(!e)throw new T("request ended without sending any chunks");return rJ(this,eE,void 0,"f"),rJ(this,ew,[],"f"),function(e,t){var r;let{id:a,choices:i,created:n,model:s,system_fingerprint:o,...l}=e;return r={...l,id:a,choices:i.map(({message:t,finish_reason:r,index:a,logprobs:i,...n})=>{if(!r)throw new T(`missing finish_reason for choice ${a}`);let{content:s=null,function_call:o,tool_calls:l,...u}=t,c=t.role;if(!c)throw new T(`missing role for choice ${a}`);if(o){let{arguments:e,name:l}=o;if(null==e)throw new T(`missing function_call.arguments for choice ${a}`);if(!l)throw new T(`missing function_call.name for choice ${a}`);return{...n,message:{content:s,function_call:{arguments:e,name:l},role:c,refusal:t.refusal??null},finish_reason:r,index:a,logprobs:i}}return l?{...n,index:a,finish_reason:r,logprobs:i,message:{...u,role:c,content:s,refusal:t.refusal??null,tool_calls:l.map((t,r)=>{let{function:i,type:n,id:s,...o}=t,{arguments:l,name:u,...c}=i||{};if(null==s)throw new T(`missing choices[${a}].tool_calls[${r}].id
${rV(e)}`);if(null==n)throw new T(`missing choices[${a}].tool_calls[${r}].type
${rV(e)}`);if(null==u)throw new T(`missing choices[${a}].tool_calls[${r}].function.name
${rV(e)}`);if(null==l)throw new T(`missing choices[${a}].tool_calls[${r}].function.arguments
${rV(e)}`);return{...o,id:s,type:n,function:{...c,name:u,arguments:l}}})}}:{...n,message:{...u,content:s,role:c,refusal:t.refusal??null},finish_reason:r,index:a,logprobs:i}}),created:n,model:s,object:"chat.completion",...o?{system_fingerprint:o}:{}},t&&rU(t)?rM(r,t):{...r,choices:r.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(e,rG(this,ev,"f"))},eP=function(){let e=rG(this,ev,"f")?.response_format;return rN(e)?e:null},eI=function(e){var t,r,a,i;let n=rG(this,eE,"f"),{choices:s,...o}=e;for(let{delta:s,finish_reason:l,index:u,logprobs:c=null,...d}of(n?Object.assign(n,o):n=rJ(this,eE,{...o,choices:[]},"f"),e.choices)){let e=n.choices[u];if(e||(e=n.choices[u]={finish_reason:l,index:u,message:{},logprobs:c,...d}),c)if(e.logprobs){let{content:a,refusal:i,...n}=c;Object.assign(e.logprobs,n),a&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...a)),i&&((r=e.logprobs).refusal??(r.refusal=[]),e.logprobs.refusal.push(...i))}else e.logprobs=Object.assign({},c);if(l&&(e.finish_reason=l,rG(this,ev,"f")&&rU(rG(this,ev,"f")))){if("length"===l)throw new Z;if("content_filter"===l)throw new J}if(Object.assign(e,d),!s)continue;let{content:o,refusal:h,function_call:p,role:f,tool_calls:m,...g}=s;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((a=e.message.function_call).arguments??(a.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),o&&(e.message.content=(e.message.content||"")+o,!e.message.refusal&&rG(this,e_,"m",eP).call(this)&&(e.message.parsed=rZ(e.message.content))),m)for(let{index:t,id:r,type:a,function:n,...s}of(e.message.tool_calls||(e.message.tool_calls=[]),m)){let o=(i=e.message.tool_calls)[t]??(i[t]={});Object.assign(o,s),r&&(o.id=r),a&&(o.type=a),n&&(o.function??(o.function={name:n.name??"",arguments:""})),n?.name&&(o.function.name=n.name),n?.arguments&&(o.function.arguments+=n.arguments,function(e,t){if(!e)return!1;let r=e.tools?.find(e=>e.function?.name===t.function.name);return rL(r)||r?.function.strict||!1}(rG(this,ev,"f"),o)&&(o.function.parsed_arguments=rZ(o.function.arguments)))}}return n},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new tr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function rV(e){return JSON.stringify(e)}class rK extends rW{static fromReadableStream(e){let t=new rK(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new rK(null),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,i)),a}static runTools(e,t,r){let a=new rK(t),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}}class rX extends tW{parse(e,t){for(let t of e.tools??[]){if("function"!==t.type)throw new T(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new T(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}return this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>rM(t,e))}runFunctions(e,t){return e.stream?rK.runFunctions(this._client,e,t):rB.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?rK.runTools(this._client,e,t):rB.runTools(this._client,e,t)}stream(e,t){return rW.createChatCompletion(this._client,e,t)}}class rY extends tW{constructor(){super(...arguments),this.completions=new rX(this._client)}}(rY||(rY={})).Completions=rX;class rQ extends tW{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class r0 extends tW{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class r1 extends tW{constructor(){super(...arguments),this.sessions=new rQ(this._client),this.transcriptionSessions=new r0(this._client)}}r1.Sessions=rQ,r1.TranscriptionSessions=r0;var r2=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)},r4=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r};class r9 extends rC{constructor(){super(...arguments),ej.add(this),eT.set(this,[]),eR.set(this,{}),eC.set(this,{}),eN.set(this,void 0),eL.set(this,void 0),eM.set(this,void 0),eU.set(this,void 0),eD.set(this,void 0),eF.set(this,void 0),eB.set(this,void 0),ez.set(this,void 0),eq.set(this,void 0)}[(eT=new WeakMap,eR=new WeakMap,eC=new WeakMap,eN=new WeakMap,eL=new WeakMap,eM=new WeakMap,eU=new WeakMap,eD=new WeakMap,eF=new WeakMap,eB=new WeakMap,ez=new WeakMap,eq=new WeakMap,ej=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new r9;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=tr.fromReadableStream(e,this.controller);for await(let e of a)r2(this,ej,"m",eH).call(this,e);if(a.controller.signal?.aborted)throw new C;return this._addRun(r2(this,ej,"m",eZ).call(this))}toReadableStream(){return new tr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,i){let n=new r9;return n._run(()=>n._runToolAssistantStream(e,t,r,a,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createToolAssistantStream(e,t,r,a,i){let n=i?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let s={...a,stream:!0},o=await e.submitToolOutputs(t,r,s,{...i,signal:this.controller.signal});for await(let e of(this._connected(),o))r2(this,ej,"m",eH).call(this,e);if(o.controller.signal?.aborted)throw new C;return this._addRun(r2(this,ej,"m",eZ).call(this))}static createThreadAssistantStream(e,t,r){let a=new r9;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let i=new r9;return i._run(()=>i._runAssistantStream(e,t,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return r2(this,eB,"f")}currentRun(){return r2(this,ez,"f")}currentMessageSnapshot(){return r2(this,eN,"f")}currentRunStepSnapshot(){return r2(this,eq,"f")}async finalRunSteps(){return await this.done(),Object.values(r2(this,eR,"f"))}async finalMessages(){return await this.done(),Object.values(r2(this,eC,"f"))}async finalRun(){if(await this.done(),!r2(this,eL,"f"))throw Error("Final run was not received.");return r2(this,eL,"f")}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},n=await e.createAndRun(i,{...r,signal:this.controller.signal});for await(let e of(this._connected(),n))r2(this,ej,"m",eH).call(this,e);if(n.controller.signal?.aborted)throw new C;return this._addRun(r2(this,ej,"m",eZ).call(this))}async _createAssistantStream(e,t,r,a){let i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let n={...r,stream:!0},s=await e.create(t,n,{...a,signal:this.controller.signal});for await(let e of(this._connected(),s))r2(this,ej,"m",eH).call(this,e);if(s.controller.signal?.aborted)throw new C;return this._addRun(r2(this,ej,"m",eZ).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let t=e[r];if(null==t||"index"===r||"type"===r){e[r]=a;continue}if("string"==typeof t&&"string"==typeof a)t+=a;else if("number"==typeof t&&"number"==typeof a)t+=a;else if(tG(t)&&tG(a))t=this.accumulateDelta(t,a);else if(Array.isArray(t)&&Array.isArray(a)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...a);continue}for(let e of a){if(!tG(e))throw Error(`Expected array delta entry to be an object but got: ${e}`);let r=e.index;if(null==r)throw console.error(e),Error("Expected array delta entry to have an `index` property");if("number"!=typeof r)throw Error(`Expected array delta entry \`index\` property to be a number but got ${r}`);let a=t[r];null==a?t.push(e):t[r]=this.accumulateDelta(a,e)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${t}`);e[r]=t}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,i){return await this._createToolAssistantStream(r,e,t,a,i)}}eH=function(e){if(!this.ended)switch(r4(this,eB,e,"f"),r2(this,ej,"m",eW).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":r2(this,ej,"m",eY).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":r2(this,ej,"m",eG).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":r2(this,ej,"m",eJ).call(this,e);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},eZ=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");if(!r2(this,eL,"f"))throw Error("Final run has not been received");return r2(this,eL,"f")},eJ=function(e){let[t,r]=r2(this,ej,"m",eK).call(this,e,r2(this,eN,"f"));for(let e of(r4(this,eN,t,"f"),r2(this,eC,"f")[t.id]=t,r)){let r=t.content[e.index];r?.type=="text"&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if("text"==r.type&&r.text){let e=r.text,a=t.content[r.index];if(a&&"text"==a.type)this._emit("textDelta",e,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=r2(this,eM,"f")){if(r2(this,eU,"f"))switch(r2(this,eU,"f").type){case"text":this._emit("textDone",r2(this,eU,"f").text,r2(this,eN,"f"));break;case"image_file":this._emit("imageFileDone",r2(this,eU,"f").image_file,r2(this,eN,"f"))}r4(this,eM,r.index,"f")}r4(this,eU,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==r2(this,eM,"f")){let t=e.data.content[r2(this,eM,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,r2(this,eN,"f"));break;case"text":this._emit("textDone",t.text,r2(this,eN,"f"))}}r2(this,eN,"f")&&this._emit("messageDone",e.data),r4(this,eN,void 0,"f")}},eG=function(e){let t=r2(this,ej,"m",eV).call(this,e);switch(r4(this,eq,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&"tool_calls"==r.step_details.type&&r.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(let e of r.step_details.tool_calls)e.index==r2(this,eD,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(r2(this,eF,"f")&&this._emit("toolCallDone",r2(this,eF,"f")),r4(this,eD,e.index,"f"),r4(this,eF,t.step_details.tool_calls[e.index],"f"),r2(this,eF,"f")&&this._emit("toolCallCreated",r2(this,eF,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":r4(this,eq,void 0,"f"),"tool_calls"==e.data.step_details.type&&r2(this,eF,"f")&&(this._emit("toolCallDone",r2(this,eF,"f")),r4(this,eF,void 0,"f")),this._emit("runStepDone",e.data,t)}},eW=function(e){r2(this,eT,"f").push(e),this._emit("event",e)},eV=function(e){switch(e.event){case"thread.run.step.created":return r2(this,eR,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=r2(this,eR,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=r9.accumulateDelta(t,r.delta);r2(this,eR,"f")[e.data.id]=a}return r2(this,eR,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":r2(this,eR,"f")[e.data.id]=e.data}if(r2(this,eR,"f")[e.data.id])return r2(this,eR,"f")[e.data.id];throw Error("No snapshot available")},eK=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let e of a.delta.content)if(e.index in t.content){let r=t.content[e.index];t.content[e.index]=r2(this,ej,"m",eX).call(this,e,r)}else t.content[e.index]=e,r.push(e);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},eX=function(e,t){return r9.accumulateDelta(t,e)},eY=function(e){switch(r4(this,ez,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":r4(this,eL,e.data,"f"),r2(this,eF,"f")&&(this._emit("toolCallDone",r2(this,eF,"f")),r4(this,eF,void 0,"f"))}};class r3 extends tW{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,r5,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class r5 extends tY{}r3.MessagesPage=r5;class r6 extends tW{retrieve(e,t,r,a={},i){return tP(a)?this.retrieve(e,t,r,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:a,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,r={},a){return tP(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,r8,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}}class r8 extends tY{}r6.RunStepsPage=r8;class r7 extends tW{constructor(){super(...arguments),this.steps=new r6(this._client)}create(e,t,r){let{include:a,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:i,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,ae,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return r9.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:i,response:n}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...a}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=n.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tL(s);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,r){return r9.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,a){let i=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,i.id,a)}submitToolOutputsStream(e,t,r,a){return r9.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}}class ae extends tY{}r7.RunsPage=ae,r7.Steps=r6,r7.RunStepsPage=r8;class at extends tW{constructor(){super(...arguments),this.runs=new r7(this._client),this.messages=new r3(this._client)}create(e={},t){return tP(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return r9.createThreadAssistantStream(e,this._client.beta.threads,t)}}at.Runs=r7,at.RunsPage=ae,at.Messages=r3,at.MessagesPage=r5;class ar extends tW{constructor(){super(...arguments),this.realtime=new r1(this._client),this.chat=new rY(this._client),this.assistants=new rA(this._client),this.threads=new at(this._client)}}ar.Realtime=r1,ar.Assistants=rA,ar.AssistantsPage=rS,ar.Threads=at;class aa extends tW{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/batches",ai,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class ai extends tY{}aa.BatchesPage=ai;class an extends tW{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,tm({body:t,...r}))}}class as extends tW{constructor(){super(...arguments),this.parts=new an(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}function ao(e,t){let r=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:function(e,t){var r,a;let i=(r=e.tools??[],a=t.name,r.find(e=>"function"===e.type&&e.name===a));return{...t,...t,parsed_arguments:i?.$brand==="auto-parseable-tool"?i.$parseRaw(t.arguments):i?.strict?JSON.parse(t.arguments):null}}(t,e)};if("message"===e.type){let r=e.content.map(e=>{var r,a;return"output_text"===e.type?{...e,parsed:(r=t,a=e.text,r.text?.format?.type!=="json_schema"?null:"$parseRaw"in r.text?.format?(r.text?.format).$parseRaw(a):JSON.parse(a))}:e});return{...e,content:r}}return e}),a=Object.assign({},e,{output:r});return Object.getOwnPropertyDescriptor(e,"output_text")||al(a),Object.defineProperty(a,"output_parsed",{enumerable:!0,get(){for(let e of a.output)if("message"===e.type){for(let t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed}return null}}),a}function al(e){let t=[];for(let r of e.output)if("message"===r.type)for(let e of r.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}as.Parts=an;class au extends tW{list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,af,{query:t,...r})}}var ac=function(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r},ad=function(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)};class ah extends rC{constructor(e){super(),eQ.add(this),e0.set(this,void 0),e1.set(this,void 0),e2.set(this,void 0),ac(this,e0,e,"f")}static createResponse(e,t,r){let a=new ah(t);return a._run(()=>a._createResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createResponse(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ad(this,eQ,"m",e4).call(this);let i=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal});for await(let e of(this._connected(),i))ad(this,eQ,"m",e9).call(this,e);if(i.controller.signal?.aborted)throw new C;return ad(this,eQ,"m",e3).call(this)}[(e0=new WeakMap,e1=new WeakMap,e2=new WeakMap,eQ=new WeakSet,e4=function(){this.ended||ac(this,e1,void 0,"f")},e9=function(e){if(this.ended)return;let t=ad(this,eQ,"m",e5).call(this,e);switch(this._emit("event",e),e.type){case"response.output_text.delta":{let r=t.output[e.output_index];if(!r)throw new T(`missing output at index ${e.output_index}`);if("message"===r.type){let t=r.content[e.content_index];if(!t)throw new T(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new T(`expected content to be 'output_text', got ${t.type}`);this._emit("response.output_text.delta",{...e,snapshot:t.text})}break}case"response.function_call_arguments.delta":{let r=t.output[e.output_index];if(!r)throw new T(`missing output at index ${e.output_index}`);"function_call"===r.type&&this._emit("response.function_call_arguments.delta",{...e,snapshot:r.arguments});break}default:this._emit(e.type,e)}},e3=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");let e=ad(this,e1,"f");if(!e)throw new T("request ended without sending any events");ac(this,e1,void 0,"f");let t=function(e,t){var r;return t&&(r=t,rN(r.text?.format))?ao(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,ad(this,e0,"f"));return ac(this,e2,t,"f"),t},e5=function(e){let t=ad(this,e1,"f");if(!t){if("response.created"!==e.type)throw new T(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return ac(this,e1,e.response,"f")}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{let r=t.output[e.output_index];if(!r)throw new T(`missing output at index ${e.output_index}`);"message"===r.type&&r.content.push(e.part);break}case"response.output_text.delta":{let r=t.output[e.output_index];if(!r)throw new T(`missing output at index ${e.output_index}`);if("message"===r.type){let t=r.content[e.content_index];if(!t)throw new T(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new T(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{let r=t.output[e.output_index];if(!r)throw new T(`missing output at index ${e.output_index}`);"function_call"===r.type&&(r.arguments+=e.delta);break}case"response.completed":ac(this,e1,e.response,"f")}return t},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=ad(this,e2,"f");if(!e)throw new T("stream ended without producing a ChatCompletion");return e}}class ap extends tW{constructor(){super(...arguments),this.inputItems=new au(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&al(e),e))}retrieve(e,t={},r){return tP(t)?this.retrieve(e,{},t):this._client.get(`/responses/${e}`,{query:t,...r})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>ao(t,e))}stream(e,t){return ah.createResponse(this._client,e,t)}}class af extends tY{}ap.InputItems=au;class am extends tW{retrieve(e,t,r,a){return this._client.get(`/evals/${e}/runs/${t}/output_items/${r}`,a)}list(e,t,r={},a){return tP(r)?this.list(e,t,{},r):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,ag,{query:r,...a})}}class ag extends tY{}am.OutputItemListResponsesPage=ag;class ay extends tW{constructor(){super(...arguments),this.outputItems=new am(this._client)}create(e,t,r){return this._client.post(`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){return this._client.get(`/evals/${e}/runs/${t}`,r)}list(e,t={},r){return tP(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,ab,{query:t,...r})}del(e,t,r){return this._client.delete(`/evals/${e}/runs/${t}`,r)}cancel(e,t,r){return this._client.post(`/evals/${e}/runs/${t}`,r)}}class ab extends tY{}ay.RunListResponsesPage=ab,ay.OutputItems=am,ay.OutputItemListResponsesPage=ag;class a_ extends tW{constructor(){super(...arguments),this.runs=new ay(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,r){return this._client.post(`/evals/${e}`,{body:t,...r})}list(e={},t){return tP(e)?this.list({},e):this._client.getAPIList("/evals",av,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class av extends tY{}a_.EvalListResponsesPage=av,a_.Runs=ay,a_.RunListResponsesPage=ab;class aw extends tx{constructor({baseURL:e=tD("OPENAI_BASE_URL"),apiKey:t=tD("OPENAI_API_KEY"),organization:r=tD("OPENAI_ORG_ID")??null,project:a=tD("OPENAI_PROJECT_ID")??null,...i}={}){if(void 0===t)throw new T("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let n={apiKey:t,organization:r,project:a,...i,baseURL:e||"https://api.openai.com/v1"};if(!n.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new T("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:n.baseURL,timeout:n.timeout??6e5,httpAgent:n.httpAgent,maxRetries:n.maxRetries,fetch:n.fetch}),this.completions=new tV(this),this.chat=new t2(this),this.embeddings=new t4(this),this.files=new t9(this),this.images=new t5(this),this.audio=new re(this),this.moderations=new rt(this),this.models=new rr(this),this.fineTuning=new rm(this),this.graders=new ry(this),this.vectorStores=new rO(this),this.beta=new ar(this),this.batches=new aa(this),this.uploads=new as(this),this.responses=new ap(this),this.evals=new a_(this),this._options=n,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let r,a=e,i=function(e=A){let t;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw TypeError("Encoder has to be a function.");let r=e.charset||A.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let a=m;if(void 0!==e.format){if(!v.call(g,e.format))throw TypeError("Unknown format option provided.");a=e.format}let i=g[a],n=A.filter;if(("function"==typeof e.filter||E(e.filter))&&(n=e.filter),t=e.arrayFormat&&e.arrayFormat in w?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":A.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw TypeError("`commaRoundTrip` must be a boolean, or absent");let s=void 0===e.allowDots?!0==!!e.encodeDotInKeys||A.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:A.addQueryPrefix,allowDots:s,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:A.allowEmptyArrays,arrayFormat:t,charset:r,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:A.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?A.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:A.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:A.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:A.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:A.encodeValuesOnly,filter:n,format:a,formatter:i,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:A.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:A.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:A.strictNullHandling}}(t);"function"==typeof i.filter?a=(0,i.filter)("",a):E(i.filter)&&(r=i.filter);let n=[];if("object"!=typeof a||null===a)return"";let s=w[i.arrayFormat],o="comma"===s&&i.commaRoundTrip;r||(r=Object.keys(a)),i.sort&&r.sort(i.sort);let l=new WeakMap;for(let e=0;e<r.length;++e){let t=r[e];i.skipNulls&&null===a[t]||x(n,function e(t,r,a,i,n,s,o,l,u,c,d,h,p,f,m,g,y,b){var v,w;let O,$=t,k=b,P=0,I=!1;for(;void 0!==(k=k.get(S))&&!I;){let e=k.get(t);if(P+=1,void 0!==e)if(e===P)throw RangeError("Cyclic object value");else I=!0;void 0===k.get(S)&&(P=0)}if("function"==typeof c?$=c(r,$):$ instanceof Date?$=p?.($):"comma"===a&&E($)&&($=_($,function(e){return e instanceof Date?p?.(e):e})),null===$){if(s)return u&&!g?u(r,A.encoder,y,"key",f):r;$=""}if("string"==typeof(v=$)||"number"==typeof v||"boolean"==typeof v||"symbol"==typeof v||"bigint"==typeof v||(w=$)&&"object"==typeof w&&w.constructor&&w.constructor.isBuffer&&w.constructor.isBuffer(w)){if(u){let e=g?r:u(r,A.encoder,y,"key",f);return[m?.(e)+"="+m?.(u($,A.encoder,y,"value",f))]}return[m?.(r)+"="+m?.(String($))]}let j=[];if(void 0===$)return j;if("comma"===a&&E($))g&&u&&($=_($,u)),O=[{value:$.length>0?$.join(",")||null:void 0}];else if(E(c))O=c;else{let e=Object.keys($);O=d?e.sort(d):e}let T=l?String(r).replace(/\./g,"%2E"):String(r),R=i&&E($)&&1===$.length?T+"[]":T;if(n&&E($)&&0===$.length)return R+"[]";for(let r=0;r<O.length;++r){let _=O[r],v="object"==typeof _&&void 0!==_.value?_.value:$[_];if(o&&null===v)continue;let w=h&&l?_.replace(/\./g,"%2E"):_,A=E($)?"function"==typeof a?a(R,w):R:R+(h?"."+w:"["+w+"]");b.set(t,P);let k=new WeakMap;k.set(S,b),x(j,e(v,A,a,i,n,s,o,l,"comma"===a&&g&&E($)?null:u,c,d,h,p,f,m,g,y,k))}return j}(a[t],t,s,o,i.allowEmptyArrays,i.strictNullHandling,i.skipNulls,i.encodeDotInKeys,i.encode?i.encoder:null,i.filter,i.sort,i.allowDots,i.serializeDate,i.format,i.formatter,i.encodeValuesOnly,i.charset,l))}let u=n.join(i.delimiter),c=!0===i.addQueryPrefix?"?":"";return i.charsetSentinel&&("iso-8859-1"===i.charset?c+="utf8=%26%2310003%3B&":c+="utf8=%E2%9C%93&"),u.length>0?c+u:""}(e,{arrayFormat:"brackets"})}}aw.OpenAI=aw,aw.DEFAULT_TIMEOUT=6e5,aw.OpenAIError=T,aw.APIError=R,aw.APIConnectionError=N,aw.APIConnectionTimeoutError=L,aw.APIUserAbortError=C,aw.NotFoundError=F,aw.ConflictError=B,aw.RateLimitError=q,aw.BadRequestError=M,aw.AuthenticationError=U,aw.InternalServerError=H,aw.PermissionDeniedError=D,aw.UnprocessableEntityError=z,aw.toFile=tc,aw.fileFromPath=h,aw.Completions=tV,aw.Chat=t2,aw.ChatCompletionsPage=t0,aw.Embeddings=t4,aw.Files=t9,aw.FileObjectsPage=t3,aw.Images=t5,aw.Audio=re,aw.Moderations=rt,aw.Models=rr,aw.ModelsPage=ra,aw.FineTuning=rm,aw.Graders=ry,aw.VectorStores=rO,aw.VectorStoresPage=rx,aw.VectorStoreSearchResponsesPage=r$,aw.Beta=ar,aw.Batches=aa,aw.BatchesPage=ai,aw.Uploads=as,aw.Responses=ap,aw.Evals=a_,aw.EvalListResponsesPage=av;var aE=r(778168),aO=r(958098),ax=r(821614),a$=r(798455),aA=r(646600),aS="object"==typeof window?window:{},ak="0123456789abcdef".split(""),aP=[-0x80000000,8388608,32768,128],aI=[24,16,8,0],aj=[];function aT(e){e?(aj[0]=aj[16]=aj[1]=aj[2]=aj[3]=aj[4]=aj[5]=aj[6]=aj[7]=aj[8]=aj[9]=aj[10]=aj[11]=aj[12]=aj[13]=aj[14]=aj[15]=0,this.blocks=aj):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=0x67452301,this.h1=0xefcdab89,this.h2=0x98badcfe,this.h3=0x10325476,this.h4=0xc3d2e1f0,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}aT.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===aS.ArrayBuffer&&(e=new Uint8Array(e));for(var r,a,i=0,n=e.length||0,s=this.blocks;i<n;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(a=this.start;i<n&&a<64;++i)s[a>>2]|=e[i]<<aI[3&a++];else for(a=this.start;i<n&&a<64;++i)(r=e.charCodeAt(i))<128?s[a>>2]|=r<<aI[3&a++]:(r<2048?s[a>>2]|=(192|r>>6)<<aI[3&a++]:(r<55296||r>=57344?s[a>>2]|=(224|r>>12)<<aI[3&a++]:(r=65536+((1023&r)<<10|1023&e.charCodeAt(++i)),s[a>>2]|=(240|r>>18)<<aI[3&a++],s[a>>2]|=(128|r>>12&63)<<aI[3&a++]),s[a>>2]|=(128|r>>6&63)<<aI[3&a++]),s[a>>2]|=(128|63&r)<<aI[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=s[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},aT.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=aP[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},aT.prototype.hash=function(){var e,t,r,a=this.h0,i=this.h1,n=this.h2,s=this.h3,o=this.h4,l=this.blocks;for(t=16;t<80;++t)r=l[t-3]^l[t-8]^l[t-14]^l[t-16],l[t]=r<<1|r>>>31;for(t=0;t<20;t+=5)e=i&n|~i&s,o=(r=a<<5|a>>>27)+e+o+0x5a827999+l[t]|0,e=a&(i=i<<30|i>>>2)|~a&n,s=(r=o<<5|o>>>27)+e+s+0x5a827999+l[t+1]|0,e=o&(a=a<<30|a>>>2)|~o&i,n=(r=s<<5|s>>>27)+e+n+0x5a827999+l[t+2]|0,e=s&(o=o<<30|o>>>2)|~s&a,i=(r=n<<5|n>>>27)+e+i+0x5a827999+l[t+3]|0,e=n&(s=s<<30|s>>>2)|~n&o,a=(r=i<<5|i>>>27)+e+a+0x5a827999+l[t+4]|0,n=n<<30|n>>>2;for(;t<40;t+=5)e=i^n^s,o=(r=a<<5|a>>>27)+e+o+0x6ed9eba1+l[t]|0,e=a^(i=i<<30|i>>>2)^n,s=(r=o<<5|o>>>27)+e+s+0x6ed9eba1+l[t+1]|0,e=o^(a=a<<30|a>>>2)^i,n=(r=s<<5|s>>>27)+e+n+0x6ed9eba1+l[t+2]|0,e=s^(o=o<<30|o>>>2)^a,i=(r=n<<5|n>>>27)+e+i+0x6ed9eba1+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,a=(r=i<<5|i>>>27)+e+a+0x6ed9eba1+l[t+4]|0,n=n<<30|n>>>2;for(;t<60;t+=5)e=i&n|i&s|n&s,o=(r=a<<5|a>>>27)+e+o-0x70e44324+l[t]|0,e=a&(i=i<<30|i>>>2)|a&n|i&n,s=(r=o<<5|o>>>27)+e+s-0x70e44324+l[t+1]|0,e=o&(a=a<<30|a>>>2)|o&i|a&i,n=(r=s<<5|s>>>27)+e+n-0x70e44324+l[t+2]|0,e=s&(o=o<<30|o>>>2)|s&a|o&a,i=(r=n<<5|n>>>27)+e+i-0x70e44324+l[t+3]|0,e=n&(s=s<<30|s>>>2)|n&o|s&o,a=(r=i<<5|i>>>27)+e+a-0x70e44324+l[t+4]|0,n=n<<30|n>>>2;for(;t<80;t+=5)e=i^n^s,o=(r=a<<5|a>>>27)+e+o-0x359d3e2a+l[t]|0,e=a^(i=i<<30|i>>>2)^n,s=(r=o<<5|o>>>27)+e+s-0x359d3e2a+l[t+1]|0,e=o^(a=a<<30|a>>>2)^i,n=(r=s<<5|s>>>27)+e+n-0x359d3e2a+l[t+2]|0,e=s^(o=o<<30|o>>>2)^a,i=(r=n<<5|n>>>27)+e+i-0x359d3e2a+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,a=(r=i<<5|i>>>27)+e+a-0x359d3e2a+l[t+4]|0,n=n<<30|n>>>2;this.h0=this.h0+a|0,this.h1=this.h1+i|0,this.h2=this.h2+n|0,this.h3=this.h3+s|0,this.h4=this.h4+o|0},aT.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4;return ak[e>>28&15]+ak[e>>24&15]+ak[e>>20&15]+ak[e>>16&15]+ak[e>>12&15]+ak[e>>8&15]+ak[e>>4&15]+ak[15&e]+ak[t>>28&15]+ak[t>>24&15]+ak[t>>20&15]+ak[t>>16&15]+ak[t>>12&15]+ak[t>>8&15]+ak[t>>4&15]+ak[15&t]+ak[r>>28&15]+ak[r>>24&15]+ak[r>>20&15]+ak[r>>16&15]+ak[r>>12&15]+ak[r>>8&15]+ak[r>>4&15]+ak[15&r]+ak[a>>28&15]+ak[a>>24&15]+ak[a>>20&15]+ak[a>>16&15]+ak[a>>12&15]+ak[a>>8&15]+ak[a>>4&15]+ak[15&a]+ak[i>>28&15]+ak[i>>24&15]+ak[i>>20&15]+ak[i>>16&15]+ak[i>>12&15]+ak[i>>8&15]+ak[i>>4&15]+ak[15&i]},aT.prototype.toString=aT.prototype.hex,aT.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a,i>>24&255,i>>16&255,i>>8&255,255&i]},aT.prototype.array=aT.prototype.digest,aT.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var aR=r(835868);let aC=(...e)=>{let t;return t=e.join("_"),new aT(!0).update(t).hex()};class aN{}let aL=new Map;class aM extends aN{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(aC(e,t))??null)}async update(e,t,r){this.cache.set(aC(e,t),r)}static global(){return new aM(aL)}}var aU=r(290729),aD=r(795158);class aF extends aU.i{}class aB extends aF{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new aD.xk(this.value)]}}class az extends aF{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,aR.zs)(this.messages)}toChatMessages(){return this.messages}}var aq=r(921570),aH=r(392279),aZ=Object.defineProperty,aJ=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(let[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,a,...i]=t.split(" "),n=Number.parseInt(a,10);return i.forEach((t,r)=>e[t]=n+r),e},{})))){let e=aH.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let a=RegExp(this.patStr,"ug"),i=aJ.specialTokenRegex(Object.keys(this.specialTokens)),n=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!s.has(e)):r);if(o.size>0){let t=aJ.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;i.lastIndex=r,!(null==(t=i.exec(e))||s.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(a)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){n.push(r);continue}n.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let a=null;for(let i=0;i<r.length-1;i++){let n=e.slice(r[i].start,r[i+1].end),s=t.get(n.join(","));null!=s&&(null==a||s<a[0])&&(a=[s,i])}if(null!=a){let e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let u=this.specialTokens[t[0]];n.push(u),l=t.index+t[0].length}return n}decode(e){let t=[],r=0;for(let a=0;a<e.length;++a){let i=e[a],n=this.textMap.get(i)??this.inverseSpecialTokens[i];null!=n&&(t.push(n),r+=n.length)}let a=new Uint8Array(r),i=0;for(let e of t)a.set(e,i),i+=e.length;return this.textDecoder.decode(a)}};G="specialTokenRegex",W=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(f="symbol"!=typeof G?G+"":G)in aJ?aZ(aJ,f,{enumerable:!0,configurable:!0,writable:!0,value:W}):aJ[f]=W;let aG={},aW=new aq.L({});async function aV(e){return e in aG||(aG[e]=aW.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new aJ(e)).catch(t=>{throw delete aG[e],t})),await aG[e]}async function aK(e){return aV(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":return"o200k_base";default:throw Error("Unknown model")}}(e))}var aX=r(73698);function aY(e){return"object"==typeof e&&!!e&&("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&!!e.function&&"name"in e.function&&"parameters"in e.function||!1)}class aQ extends aX.eq{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class a0 extends aQ{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){let{cache:a,...i}=r;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof a?this.cache=a:a?this.cache=aM.global():this.cache=void 0,this.caller=new aq.L(r??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{var r;this._encoding=await aK("modelName"in this?(r=this.modelName).startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r.startsWith("gpt-4o")?"gpt-4o":r:"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new aB(e):Array.isArray(e)?new az(e.map(aR.E1)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){return Object.entries({...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()}).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw Error("Use .toJSON() instead")}}var a1=r(235786),a2=r(730373),a4=r(791388);class a9 extends aX.eq{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=(0,a4.LE)(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async *transform(e,t){let r,a=(0,a4.LE)(t),i=!0;for await(let t of this._transformStreamWithConfig(e,e=>e,a))if(yield t,i)if(void 0===r)r=t;else try{r=(0,a2.zo)(r,t)}catch{r=void 0,i=!1}this.func&&void 0!==r&&await this.func(r,a)}static assign(e){return new aX.Vh(new aX.dT({steps:e}))}}var a3=r(196130);function a5(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&(!!(e._def||Object.values(a3.z.ZodFirstPartyTypeKind).includes(e.constructor?.name??"NOT_INCLUDED"))||"function"==typeof e.parse&&"function"==typeof e.parseAsync&&"function"==typeof e.safeParse&&"function"==typeof e.safeParseAsync)}var a6=r(570716);function a8(e){let t=[];for(let r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){let a=r.content[t];((0,aA.Nu)(a)||(0,aA.c1)(a))&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),(0,aA.j0)(a),...r.content.slice(t+1)]}))}t.push(e)}return t}class a7 extends a0{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=a7._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}async *_streamIterator(e,t){if(this._streamResponseChunks===a7.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{let r,a,i=a7._convertInputToPromptValue(e).toChatMessages(),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...n.metadata,...this.getLsParams(s)},l=await a1.Ye.configure(n.callbacks,this.callbacks,n.tags,this.tags,o,this.metadata,{verbose:this.verbose}),u={options:s,invocation_params:this?.invocationParams(s),batch_size:1},c=await l?.handleChatModelStart(this.toJSON(),[a8(i)],n.runId,void 0,u,void 0,void 0,n.runName);try{for await(let e of this._streamResponseChunks(i,s,c?.[0])){if(null==e.message.id){let t=c?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,r=r?r.concat(e):e,(0,aA.wT)(e.message)&&void 0!==e.message.usage_metadata&&(a={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((c??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((c??[]).map(e=>e?.handleLLMEnd({generations:[[r]],llmOutput:a})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,a){let i,n=e.map(e=>e.map(aA.E1));if(void 0!==a&&a.length===n.length)i=a;else{let e={...r.metadata,...this.getLsParams(t)},a=await a1.Ye.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1};i=await a?.handleChatModelStart(this.toJSON(),n.map(a8),r.runId,void 0,s,void 0,void 0,r.runName)}let s=[],o=[];if(i?.[0].handlers.find(a6.mb)&&!this.disableStreaming&&1===n.length&&this._streamResponseChunks!==a7.prototype._streamResponseChunks)try{let e,r;for await(let a of(await this._streamResponseChunks(n[0],t,i?.[0]))){if(null==a.message.id){let e=i?.at(0)?.runId;null!=e&&a.message._updateId(`run-${e}`)}e=void 0===e?a:(0,a2.zo)(e,a),(0,aA.wT)(a.message)&&void 0!==a.message.usage_metadata&&(r={tokenUsage:{promptTokens:a.message.usage_metadata.input_tokens,completionTokens:a.message.usage_metadata.output_tokens,totalTokens:a.message.usage_metadata.total_tokens}})}if(void 0===e)throw Error("Received empty response from chat model call.");s.push([e]),await i?.[0].handleLLMEnd({generations:s,llmOutput:r})}catch(e){throw await i?.[0].handleLLMError(e),e}else{let e=await Promise.allSettled(n.map((e,r)=>this._generate(e,{...t,promptIndex:r},i?.[r])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"!==e.status)return await i?.[t]?.handleLLMError(e.reason),Promise.reject(e.reason);{let r=e.value;for(let e of r.generations){if(null==e.message.id){let t=i?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),s[t]=r.generations,o[t]=r.llmOutput,i?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}}))}let l={generations:s,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(l,aO.WH,{value:i?{runIds:i?.map(e=>e.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:i}){let n=e.map(e=>e.map(aA.E1)),s={...i.metadata,...this.getLsParams(a)},o=await a1.Ye.configure(i.callbacks,this.callbacks,i.tags,this.tags,s,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1},u=await o?.handleChatModelStart(this.toJSON(),n.map(a8),i.runId,void 0,l,void 0,void 0,i.runName),c=[],d=(await Promise.allSettled(n.map(async(e,a)=>{let i=a7._convertInputToPromptValue(e).toString(),n=await t.lookup(i,r);return null==n&&c.push(a),n}))).map((e,t)=>({result:e,runManager:u?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(d.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let a=e.value;return h[r]=a.map(e=>("message"in e&&(0,aA.QW)(e.message)&&(0,aA.Z0)(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),a.length&&await t?.handleLLMNewToken(a[0].text),t?.handleLLMEnd({generations:[a]},void 0,void 0,void 0,{cached:!0})}}));let p={generations:h,missingPromptIndices:c,startedRunManagers:u};return Object.defineProperty(p,aO.WH,{value:u?{runIds:u?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let a;a=Array.isArray(t)?{stop:t}:t;let i=e.map(e=>e.map(aA.E1)),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(a);if(n.callbacks=n.callbacks??r,!this.cache)return this._generateUncached(i,s,n);let{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(s),{generations:u,missingPromptIndices:c,startedRunManagers:d}=await this._generateCached({messages:i,cache:o,llmStringKey:l,parsedOptions:s,handledOptions:n}),h={};if(c.length>0){let e=await this._generateUncached(c.map(e=>i[e]),s,n,void 0!==d?c.map(e=>d?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{let r=c[t];u[r]=e;let a=a7._convertInputToPromptValue(i[r]).toString();return o.update(a,l,e)})),h=e.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(e=>e.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(aA.E1)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new aA.xk(e),i=await this.call([a],t,r);if("string"!=typeof i.content)throw Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){let r;if("function"!=typeof this.bindTools)throw Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw Error('"strict" mode is not supported for this model by default.');let a=t?.name,i=e.description??"A function available to call.",n=t?.method,s=t?.includeRaw;if("jsonMode"===n)throw Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o=a??"extract";a5(e)?r=[{type:"function",function:{name:o,description:i,parameters:(0,a$.Y_)(e)}}]:("name"in e&&(o=e.name),r=[{type:"function",function:{name:o,description:i,parameters:e}}]);let l=this.bindTools(r),u=aX.Y8.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw Error("No tool calls found in the response.");let t=e.tool_calls.find(e=>e.name===o);if(!t)throw Error(`No tool call found with name ${o}.`);return t.args});if(!s)return l.pipe(u).withConfig({runName:"StructuredOutput"});let c=a9.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),d=a9.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[d]});return aX.lW.from([{raw:l},h]).withConfig({runName:"StructuredOutputRunnable"})}}aX.eq,aX.eq,aX.pX;var ie=r(884026);class it extends aX.eq{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class ir extends it{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw Error("_type not implemented")}}class ia extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(void 0===r||void 0===t))throw Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,ie.r)(this,"OUTPUT_PARSING_FAILURE")}}function ii(e,t){let r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let r=e.length;if(r!==t.length)return!1;for(let a=0;a<r;a++)if(!ii(e[a],t[a]))return!1;return!0}if("object"===r){if(!e||!t)return e===t;let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let a of r)if(!ii(e[a],t[a]))return!1;return!0}return e===t}function is(e){return encodeURI(e.replace(/~/g,"~0").replace(/\//g,"~1"))}let io={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},il={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},iu={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0},ic="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker"),id=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,ih=[0,31,28,31,30,31,30,31,31,30,31,30,31],ip=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function im(e){return e.test.bind(e)}let ig={date:iy,time:ib.bind(void 0,!1),"date-time":function(e){let t=e.split(i_);return 2==t.length&&iy(t[0])&&ib(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return iv.test(e)&&iw.test(e)},"uri-reference":im(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":im(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:im(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;let[t,r,...a]=e.split("@");return!(!t||!r||0!==a.length||t.length>64||r.length>253||"."===t[0]||t.endsWith(".")||t.includes(".."))&&!!/^[a-z0-9.-]+$/i.test(r)&&!!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)&&r.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))},hostname:im(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:im(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:im(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(iE.test(e))return!1;try{return RegExp(e,"u"),!0}catch(e){return!1}},uuid:im(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":im(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":im(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":im(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function iy(e){var t;let r=e.match(id);if(!r)return!1;let a=+r[1],i=+r[2],n=+r[3];return i>=1&&i<=12&&n>=1&&n<=(2==i&&(t=a)%4==0&&(t%100!=0||t%400==0)?29:ih[i])}function ib(e,t){let r=t.match(ip);if(!r)return!1;let a=+r[1],i=+r[2],n=+r[3],s=!!r[5];return(a<=23&&i<=59&&n<=59||23==a&&59==i&&60==n)&&(!e||s)}let i_=/t|\s/i,iv=/\/|:/,iw=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,iE=/[^\\]\\Z/;(V=e6||(e6={}))[V.Flag=1]="Flag",V[V.Basic=2]="Basic",V[V.Detailed=4]="Detailed";var iO=r(38878);class ix extends ir{async *_transform(e){for await(let t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async *transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class i$ extends ix{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async *_transform(e){let t,r;for await(let a of e){let e;if("string"!=typeof a&&"string"!=typeof a.content)throw Error("Cannot handle non-string output.");if((0,iO.a2)(a)){if("string"!=typeof a.content)throw Error("Cannot handle non-string message output.");e=new aO.Ls({message:a,text:a.content})}else if((0,iO.QW)(a)){if("string"!=typeof a.content)throw Error("Cannot handle non-string message output.");e=new aO.Ls({message:(0,aR.Oy)(a),text:a.content})}else e=new aO.b6({text:a});r=void 0===r?e:r.concat(e);let i=await this.parsePartialResult([r]);null==i||ii(i,t)||(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}}class iA extends ir{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(a3.z.object(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,a3.z.string().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify((0,a$.Y_)(this.schema))}
\`\`\`
`}async parse(e){try{let t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>{let r=t.replace(/\n/g,"\\n");return`"${r}"`}).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new ia(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}var iS=r(635356),ik=r(609922);class iP extends i${constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?(0,iS.qu)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,ik.M)(e[0].text)}async parse(e){return(0,ik.M)(e,JSON.parse)}getFormatInstructions(){return""}}let iI=e=>{if(0===Object.keys(e).length)return{};let t={};return e.children.length>0?t[e.name]=e.children.map(iI):t[e.name]=e.text??void 0,t};var ij=r(423306);function iT(e,t){let r;if(void 0===e.function)return;if(t?.partial)try{r=(0,ik.g)(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new ia([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"\nare not valid JSON.",`Error: ${t.message}`].join("\n"))}let a={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(a.id=e.id),a}function iR(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function iC(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class iN extends i${static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw Error("Not supported.")}async parse(){throw Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let r,a=e[0].message;if((0,ij.Z0)(a)&&a.tool_calls?.length?r=a.tool_calls.map(e=>{let{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==a.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(a.additional_kwargs.tool_calls)).map(e=>iT(e,{returnId:this.returnId,partial:t}))),!r)return[];let i=[];for(let e of r)if(void 0!==e){let t={type:e.name,args:e.args,id:e.id};i.push(t)}return i}}class iL extends iN{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ia(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName),r=t;if(t.length)return(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?r[0]:r}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?this._validateResult(r[0]):await Promise.all(r.map(e=>this._validateResult(e))):void 0}}function iM(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function iU(e,t,r,a,i){e[t]=r,iM(e,t,a,i)}let iD=/^[cC][^\s-]{8,}$/,iF=/^[0-9a-z]+$/,iB=/^[0-9A-HJKMNP-TV-Z]{26}$/,iz=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,iq=()=>(void 0===i&&(i=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),i),iH=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,iZ=/^[a-zA-Z0-9_-]{21}$/;function iJ(e,t){let r={type:"string"};function a(e){return"escape"===t.patternStrategy?iG(e):e}if(e.checks)for(let i of e.checks)switch(i.kind){case"min":iU(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,i.value):i.value,i.message,t);break;case"max":iU(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":iW(r,"email",i.message,t);break;case"format:idn-email":iW(r,"idn-email",i.message,t);break;case"pattern:zod":iV(r,iz,i.message,t)}break;case"url":iW(r,"uri",i.message,t);break;case"uuid":iW(r,"uuid",i.message,t);break;case"regex":iV(r,i.regex,i.message,t);break;case"cuid":iV(r,iD,i.message,t);break;case"cuid2":iV(r,iF,i.message,t);break;case"startsWith":iV(r,RegExp(`^${a(i.value)}`),i.message,t);break;case"endsWith":iV(r,RegExp(`${a(i.value)}$`),i.message,t);break;case"datetime":iW(r,"date-time",i.message,t);break;case"date":iW(r,"date",i.message,t);break;case"time":iW(r,"time",i.message,t);break;case"duration":iW(r,"duration",i.message,t);break;case"length":iU(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,i.value):i.value,i.message,t),iU(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,i.value):i.value,i.message,t);break;case"includes":iV(r,RegExp(a(i.value)),i.message,t);break;case"ip":"v6"!==i.version&&iW(r,"ipv4",i.message,t),"v4"!==i.version&&iW(r,"ipv6",i.message,t);break;case"emoji":iV(r,iq,i.message,t);break;case"ulid":iV(r,iB,i.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":iW(r,"binary",i.message,t);break;case"contentEncoding:base64":iU(r,"contentEncoding","base64",i.message,t);break;case"pattern:zod":iV(r,iH,i.message,t)}break;case"nanoid":iV(r,iZ,i.message,t)}return r}let iG=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),iW=(e,t,r,a)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):iU(e,"format",t,r,a)},iV=(e,t,r,a)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:iK(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):iU(e,"pattern",iK(t,a),r,a)},iK=(e,t)=>{let r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;let a={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},i=a.i?r.source.toLowerCase():r.source,n="",s=!1,o=!1,l=!1;for(let e=0;e<i.length;e++){if(s){n+=i[e],s=!1;continue}if(a.i){if(o){if(i[e].match(/[a-z]/)){l?(n+=i[e],n+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(n+=i[e],l=!0):n+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){n+=`[${i[e]}${i[e].toUpperCase()}]`;continue}}if(a.m){if("^"===i[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===i[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===i[e]){n+=o?`${i[e]}\r
`:`[${i[e]}\r
]`;continue}n+=i[e],"\\"===i[e]?s=!0:o&&"]"===i[e]?o=!1:o||"["!==i[e]||(o=!0)}try{new RegExp(n)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return n};function iX(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===a3.pA.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:i2(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};let r={type:"object",additionalProperties:i2(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===a3.pA.ZodString&&e.keyType._def.checks?.length){let a=Object.entries(iJ(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:a}}return e.keyType?._def.typeName===a3.pA.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}let iY={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},iQ=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>i2(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0},i0=Symbol("Let zodToJsonSchema decide on which parser to use"),i1={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function i2(e,t,r=!1){let a=t.seen.get(e);if(t.override){let i=t.override?.(e,t,a,r);if(i!==i0)return i}if(a&&!r){let e=i4(a,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}let i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);let n=i3(e,e.typeName,t,r);return n&&i5(e,t,n),i.jsonSchema=n,n}let i4=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:i9(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},i9=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},i3=(e,t,r,a)=>{switch(t){case a3.pA.ZodString:return iJ(e,r);case a3.pA.ZodNumber:let i={type:"number"};if(!e.checks)return i;for(let t of e.checks)switch(t.kind){case"int":i.type="integer",iM(i,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?iU(i,"minimum",t.value,t.message,r):iU(i,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(i.exclusiveMinimum=!0),iU(i,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?iU(i,"maximum",t.value,t.message,r):iU(i,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(i.exclusiveMaximum=!0),iU(i,"maximum",t.value,t.message,r));break;case"multipleOf":iU(i,"multipleOf",t.value,t.message,r)}return i;case a3.pA.ZodObject:let n={type:"object",...Object.entries(e.shape()).reduce((e,[t,a])=>{if(void 0===a||void 0===a._def)return e;let i=[...r.currentPath,"properties",t],n=i2(a._def,{...r,currentPath:i,propertyPath:i});return void 0===n?e:(r.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&console.warn(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...e.properties,[t]:n},required:a.isOptional()&&!r.openaiStrictMode?e.required:[...e.required,t]})},{properties:{},required:[]}),additionalProperties:"strict"===r.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:i2(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:i2(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0};return n.required.length||delete n.required,n;case a3.pA.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?iU(s,"minimum",t.value,t.message,r):iU(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),iU(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?iU(s,"maximum",t.value,t.message,r):iU(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),iU(s,"maximum",t.value,t.message,r));break;case"multipleOf":iU(s,"multipleOf",t.value,t.message,r)}return s;case a3.pA.ZodBoolean:return{type:"boolean"};case a3.pA.ZodDate:return function e(t,r,a){let i=a??r.dateStrategy;if(Array.isArray(i))return{anyOf:i.map((a,i)=>e(t,r,a))};switch(i){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,s=r;let o={type:"integer",format:"unix-time"};if("openApi3"===s.target)return o;for(let e of n.checks)switch(e.kind){case"min":iU(o,"minimum",e.value,e.message,s);break;case"max":iU(o,"maximum",e.value,e.message,s)}return o}}(e,r);case a3.pA.ZodUndefined:return{not:{}};case a3.pA.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case a3.pA.ZodArray:let o={type:"array"};return e.type?._def?.typeName!==a3.pA.ZodAny&&(o.items=i2(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&iU(o,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&iU(o,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(iU(o,"minItems",e.exactLength.value,e.exactLength.message,r),iU(o,"maxItems",e.exactLength.value,e.exactLength.message,r)),o;case a3.pA.ZodUnion:case a3.pA.ZodDiscriminatedUnion:if("openApi3"===r.target)return iQ(e,r);let l=e.options instanceof Map?Array.from(e.options.values()):e.options;if(l.every(e=>e._def.typeName in iY&&(!e._def.checks||!e._def.checks.length))){let e=l.reduce((e,t)=>{let r=iY[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(l.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=l.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===l.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:l.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(l.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:l.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return iQ(e,r);case a3.pA.ZodIntersection:let u=[i2(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),i2(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),c="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,d=[];return u.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)d.push(...e.allOf),void 0===e.unevaluatedProperties&&(c=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else c=void 0;d.push(t)}}),d.length?{allOf:d,...c}:void 0;case a3.pA.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>i2(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:i2(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>i2(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case a3.pA.ZodRecord:return iX(e,r);case a3.pA.ZodLiteral:let h=typeof e.value;return"bigint"!==h&&"number"!==h&&"boolean"!==h&&"string"!==h?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===h?"integer":h,enum:[e.value]}:{type:"bigint"===h?"integer":h,const:e.value};case a3.pA.ZodEnum:return{type:"string",enum:[...e.values]};case a3.pA.ZodNativeEnum:let p=e.values,f=Object.keys(e.values).filter(e=>"number"!=typeof p[p[e]]).map(e=>p[e]),m=Array.from(new Set(f.map(e=>typeof e)));return{type:1===m.length?"string"===m[0]?"string":"number":["string","number"],enum:f};case a3.pA.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target||"property"===r.nullableStrategy?{type:iY[e.innerType._def.typeName],nullable:!0}:{type:[iY[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=i2(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=i2(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case a3.pA.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return i2(e.innerType._def,r);let y=i2(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return y?{anyOf:[{not:{}},y]}:{};case a3.pA.ZodMap:if("record"===r.mapStrategy)return iX(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[i2(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},i2(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case a3.pA.ZodSet:let b={type:"array",uniqueItems:!0,items:i2(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})};return e.minSize&&iU(b,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&iU(b,"maxItems",e.maxSize.value,e.maxSize.message,r),b;case a3.pA.ZodLazy:return i2(e.getter()._def,r);case a3.pA.ZodPromise:return i2(e.type._def,r);case a3.pA.ZodNaN:case a3.pA.ZodNever:return{not:{}};case a3.pA.ZodEffects:return"input"===r.effectStrategy?i2(e.schema._def,r,a):{};case a3.pA.ZodAny:case a3.pA.ZodUnknown:return{};case a3.pA.ZodDefault:return{...i2(e.innerType._def,r),default:e.defaultValue()};case a3.pA.ZodBranded:return i2(e.type._def,r);case a3.pA.ZodReadonly:case a3.pA.ZodCatch:return i2(e.innerType._def,r);case a3.pA.ZodPipeline:if("input"===r.pipeStrategy)return i2(e.in._def,r);if("output"===r.pipeStrategy)return i2(e.out._def,r);let _=i2(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),v=i2(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",_?"1":"0"]});return{allOf:[_,v].filter(e=>void 0!==e)};case a3.pA.ZodFunction:case a3.pA.ZodVoid:case a3.pA.ZodSymbol:default:return}},i5=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),i6=e=>"_def"in e?e._def:e;function i8(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&(a5(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))||void 0!==e&&aX.eq.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()||void 0!==e&&Array.isArray(e.lc_namespace)}function i7(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function ne(e){let t;return e.constructor.name===L.name?(t=Error(e.message)).name="TimeoutError":e.constructor.name===C.name?(t=Error(e.message)).name="AbortError":t=400===e.status&&e.message.includes("tool_calls")?i7(e,"INVALID_TOOL_RESULTS"):401===e.status?i7(e,"MODEL_AUTHENTICATION"):429===e.status?i7(e,"MODEL_RATE_LIMIT"):404===e.status?i7(e,"MODEL_NOT_FOUND"):e,t}function nt(e){if(e){if("any"===e||"required"===e)return"required";if("auto"===e)return"auto";if("none"===e)return"none";else if("string"==typeof e)return{type:"function",function:{name:e}};else return e}}function nr(e,t){let r=[];for(let[a,i]of Object.entries(e.properties??{}))i.description&&t<2&&r.push(`// ${i.description}`),e.required?.includes(a)?r.push(`${a}: ${na(i,t)},`):r.push(`${a}?: ${na(i,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function na(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>na(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",nr(e,t+2),"}"].join("\n");case"array":if(e.items)return`${na(e.items,t)}[]`;return"any[]";default:return""}}function ni(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!aE.J.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}let nn={providerName:"ChatOpenAI",fromStandardTextBlock:e=>({type:"text",text:e.text}),fromStandardImageBlock(e){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if("base64"===e.source_type)return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};throw Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if("url"===e.source_type){let t,r=(0,aE.SR)({dataUrl:e.url});if(!r)throw Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);let a=r.mime_type||e.mime_type||"";try{t=(0,aE.uy)(a)}catch{throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:r.data}}}if("base64"===e.source_type){let t;try{t=(0,aE.uy)(e.mime_type??"")}catch{throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if("url"===e.source_type){if(!(0,aE.SR)({dataUrl:e.url}))throw Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:e.metadata?.filename||e.metadata?.name}:{}}}}if("base64"===e.source_type)return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:e.metadata?.filename||e.metadata?.name||e.metadata?.title}:{}}};if("id"===e.source_type)return{type:"file",file:{file_id:e.id}};throw Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}};function ns(e,t){return e.flatMap(e=>{let r=ni(e);"system"===r&&nh(t)&&(r="developer");let a={role:r,content:"string"==typeof e.content?e.content:e.content.map(e=>(0,aE.JG)(e)?(0,aE.VL)(e,nn):e)};return(null!=e.name&&(a.name=e.name),null!=e.additional_kwargs.function_call&&(a.function_call=e.additional_kwargs.function_call,a.content=""),(0,aE.Z0)(e)&&e.tool_calls?.length?(a.tool_calls=e.tool_calls.map(iR),a.content=""):(null!=e.additional_kwargs.tool_calls&&(a.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(a.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio)?[a,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:a})}let no="__openai_function_call_ids__";function nl(e,t,r){let a=e.filter(e=>(0,aE.Z0)(e)).pop(),i=a?.response_metadata?.id;return(i&&i.startsWith("resp_")&&!r?e.slice(e.indexOf(a)+1):e).flatMap(e=>{let a=ni(e);if("system"===a&&nh(t)&&(a="developer"),"function"===a)throw Error("Function messages are not supported in Responses API");if("tool"===a)return e.additional_kwargs?.type==="computer_call_output"?{type:"computer_call_output",output:(()=>{if("string"==typeof e.content)return{type:"computer_screenshot",image_url:e.content};if(Array.isArray(e.content)){let t=e.content.find(e=>"computer_screenshot"===e.type);if(t)return t;let r=e.content.find(e=>"image_url"===e.type);if(r)return{type:"computer_screenshot",image_url:"string"==typeof r.image_url?r.image_url:r.image_url.url}}throw Error("Invalid computer call output")})(),call_id:e.tool_call_id}:{type:"function_call_output",call_id:e.tool_call_id,id:e.id?.startsWith("fc_")?e.id:void 0,output:"string"!=typeof e.content?JSON.stringify(e.content):e.content};if("assistant"===a){if(!r&&null!=e.response_metadata.output&&Array.isArray(e.response_metadata.output)&&e.response_metadata.output.length>0&&e.response_metadata.output.every(e=>"type"in e))return e.response_metadata.output;let t=[];if(!r&&null!=e.additional_kwargs.reasoning){let r;if("object"==typeof(r=e.additional_kwargs.reasoning)&&null!=r&&"type"in r&&"reasoning"===r.type){let r=function(e){let t=(e.summary.length>1?e.summary.reduce((e,t)=>{let r=e.at(-1);return r.index===t.index?r.text+=t.text:e.push(t),e},[{...e.summary[0]}]):e.summary).map(e=>Object.fromEntries(Object.entries(e).filter(([e])=>"index"!==e)));return{...e,summary:t}}(e.additional_kwargs.reasoning);t.push(r)}}let{content:a}=e;null!=e.additional_kwargs.refusal&&("string"==typeof a&&(a=[{type:"output_text",text:a,annotations:[]}]),a=[...a,{type:"refusal",refusal:e.additional_kwargs.refusal}]),t.push({type:"message",role:"assistant",...e.id&&!r?{id:e.id}:{},content:"string"==typeof a?a:a.flatMap(e=>"text"===e.type?{type:"output_text",text:e.text,annotations:e.annotations??[]}:"output_text"===e.type||"refusal"===e.type?e:[])});let i=e.additional_kwargs[no];(0,aE.Z0)(e)&&e.tool_calls?.length?t.push(...e.tool_calls.map(e=>({type:"function_call",name:e.name,arguments:JSON.stringify(e.args),call_id:e.id,...r?{id:i?.[e.id]}:{}}))):null!=e.additional_kwargs.tool_calls&&t.push(...e.additional_kwargs.tool_calls.map(e=>({type:"function_call",name:e.function.name,call_id:e.id,...r?{id:i?.[e.id]}:{},arguments:e.function.arguments})));let n=e.response_metadata.output?.length?e.response_metadata.output:e.additional_kwargs.tool_outputs,s=[];return null!=n&&(s=n?.filter(e=>"computer_call"===e.type)).length>0&&t.push(...s),t}let i="string"==typeof e.content?e.content:e.content.flatMap(e=>(0,aE.JG)(e)?(0,aE.VL)(e,nn):"text"===e.type?{type:"input_text",text:e.text}:"image_url"===e.type?{type:"input_image",image_url:"string"==typeof e.image_url?e.image_url:e.image_url.url,detail:"string"==typeof e.image_url?"auto":e.image_url.detail}:"input_text"===e.type||"input_image"===e.type||"input_file"===e.type?e:[]);return"user"===a||"system"===a||"developer"===a?{type:"message",role:a,content:i}:(console.warn(`Unsupported role found when converting to OpenAI Responses API: ${a}`),[])})}function nu(e){let t;if(e.error){let t=Error(e.error.message);throw t.name=e.error.code,t}let r=[],a=[],i=[],n={model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,model_name:e.model},s={};for(let n of e.output)if("message"===n.type)t=n.id,r.push(...n.content.flatMap(e=>"output_text"===e.type?("parsed"in e&&null!=e.parsed&&(s.parsed=e.parsed),{type:"text",text:e.text,annotations:e.annotations}):"refusal"===e.type?(s.refusal=e.refusal,[]):e));else if("function_call"===n.type){let e={function:{name:n.name,arguments:n.arguments},id:n.call_id};try{a.push(iT(e,{returnId:!0}))}catch(r){let t;"object"==typeof r&&null!=r&&"message"in r&&"string"==typeof r.message&&(t=r.message),i.push(iC(e,t))}s[no]??={},n.id&&(s[no][n.call_id]=n.id)}else"reasoning"===n.type?s.reasoning=n:(s.tool_outputs??=[],s.tool_outputs.push(n));return new aE.gY({id:t,content:r,tool_calls:a,invalid_tool_calls:i,usage_metadata:e.usage,additional_kwargs:s,response_metadata:n})}function nc(e){return"type"in e&&"function"!==e.type}function nd(e,t){var r,a,i,n,s;let o,l;if(aY(e))return t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e;return o=i8(e)?(l=i8(r=e)?{type:"function",function:{name:(i=r).name,description:i.description,parameters:a5(s=i.schema)?(0,a$.Y_)(s):s,...{}}}:r,l):e,t?.strict!==void 0&&(o.function.strict=t.strict),o}function nh(e){return e&&/^o\d/.test(e)}class np extends a7{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,ax.lS)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??(0,ax.lS)("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort??e?.reasoning?.effort,this.reasoning=e?.reasoning??(e?.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.useResponsesApi=e?.useResponsesApi??this.useResponsesApi,this.disableStreaming=e?.disableStreaming??this.disableStreaming,this.streaming=e?.streaming??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),this.zdrEnabled=e?.zdrEnabled??!1}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return t?.strict!==void 0?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.withConfig({tools:e.map(e=>nc(e)?e:nd(e,{strict:r})),...t})}createResponseFormat(e){var t,r;return e&&"json_schema"===e.type&&e.json_schema.schema&&nf(e.json_schema.schema)?(t=e.json_schema.schema,r=e.json_schema.name,function(e,t){let r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),r}({type:"json_schema",json_schema:{...{description:e.json_schema.description},name:r,strict:!0,schema:((e,t)=>{let r=(e=>{let t="string"==typeof e?{...i1,basePath:["#"],definitions:{},name:e}:{...i1,basePath:["#"],definitions:{},...e},r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[i6(r),{def:i6(r),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),a="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,i=i2(e._def,void 0===a?r:{...r,currentPath:[...r.basePath,r.definitionPath,a]},!1)??{},n="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==n&&(i.title=n);let s=(()=>{if(function(e){if(!e)return!0;for(let t in e)return!1;return!0}(r.definitions))return;let e={},t=new Set;for(let a=0;a<500;a++){let a=Object.entries(r.definitions).filter(([e])=>!t.has(e));if(0===a.length)break;for(let[i,n]of a)e[i]=i2(i6(n),{...r,currentPath:[...r.basePath,r.definitionPath,i]},!0)??{},t.add(i)}return e})(),o=void 0===a?s?{...i,[r.definitionPath]:s}:i:"duplicate-ref"===r.nameStrategy?{...i,...s||r.seenRefs.size?{[r.definitionPath]:{...s,...r.seenRefs.size?{[a]:i}:void 0}}:void 0}:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...s,[a]:i}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(t,{openaiStrictMode:!0,name:{name:r}.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}},e=>t.parse(JSON.parse(e)))):e}getReasoningParams(e){let t;if(nh(this.model))return void 0!==this.reasoningEffort&&(t={effort:this.reasoningEffort}),void 0!==this.reasoning&&(t={...t,...this.reasoning}),e?.reasoning_effort!==void 0&&(t={...t,effort:e.reasoning_effort}),e?.reasoning!==void 0&&(t={...t,...e.reasoning}),t}invocationParams(e,t){let r;if(e?.strict!==void 0?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this._useResponseApi(e)){var a;let t={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?e.tools.map(e=>nc(e)?e:aY(e)?{type:"function",name:e.function.name,parameters:e.function.parameters,description:e.function.description,strict:r}:null).filter(e=>null!==e):void 0,tool_choice:null!=(a=e?.tool_choice)&&"object"==typeof a&&"type"in a&&"function"!==a.type?e?.tool_choice:(()=>{let t=nt(e?.tool_choice);return"object"==typeof t&&"type"in t?{type:"function",name:t.function.name}:void 0})(),text:(()=>{if(e?.text)return e.text;let t=this.createResponseFormat(e?.response_format);return t?.type==="json_schema"?null!=t.json_schema.schema?{format:{type:"json_schema",schema:t.json_schema.schema,description:t.json_schema.description,name:t.json_schema.name,strict:t.json_schema.strict}}:void 0:{format:t}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:-1===this.maxTokens?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},i=this.getReasoningParams(e);return void 0!==i&&(t.reasoning=i),t}let i={};e?.stream_options!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(i={stream_options:{include_usage:!0}});let n={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>nd(e,{strict:r})):void 0,tool_choice:nt(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...i,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(n.prediction=e.prediction);let s=this.getReasoningParams(e);return void 0!==s&&void 0!==s.effort&&(n.reasoning_effort=s.effort),nh(n.model)?n.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:n.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,n}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){let r=e.tool_calls;if("assistant"!==e.role)return new aE.J(e.content||"",e.role??"unknown");{let a=[],i=[];for(let e of r??[])try{a.push(iT(e,{returnId:!0}))}catch(t){i.push(iC(e,t.message))}let n={function_call:e.function_call,tool_calls:r};void 0!==this.__includeRawResponse&&(n.__raw_response=t);let s={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(n.audio=e.audio),new aE.gY({content:e.content||"",tool_calls:a,invalid_tool_calls:i,additional_kwargs:n,response_metadata:s,id:t.id})}}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){let a,i=e.role??r,n=e.content??"";a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},this.__includeRawResponse&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});let s={usage:{...t.usage}};if("user"===i)return new aE.ro({content:n,response_metadata:s});if("assistant"===i){let r=[];if(Array.isArray(e.tool_calls))for(let t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new aE.GC({content:n,tool_call_chunks:r,additional_kwargs:a,id:t.id,response_metadata:s})}if("system"===i)return new aE.xq({content:n,response_metadata:s});if("developer"===i)return new aE.xq({content:n,response_metadata:s,additional_kwargs:{__openai_role__:"developer"}});if("function"===i)return new aE.Cr({content:n,additional_kwargs:a,name:e.name,response_metadata:s});else if("tool"===i)return new aE.Xz({content:n,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:s});else return new aE.HD({content:n,role:i,response_metadata:s})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,r){let a,i;if(this._useResponseApi(t)){let r=e.filter(e=>(0,aE.Z0)(e)).pop(),a=r?.response_metadata?.id;for await(let r of(await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:nl(e,this.model,this.zdrEnabled),stream:!0,...a&&a.startsWith("resp_")&&!this.zdrEnabled?{previous_response_id:a}:{}},t))){let e=function(e){let t,r,a=[],i={},n=[],s={},o={};if("response.output_text.delta"===e.type)a.push({type:"text",text:e.delta,index:e.content_index});else if("response.output_text.annotation.added"===e.type)a.push({type:"text",text:"",annotations:[e.annotation],index:e.content_index});else if("response.output_item.added"===e.type&&"message"===e.item.type)r=e.item.id;else if("response.output_item.added"===e.type&&"function_call"===e.item.type)n.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.call_id,index:e.output_index}),o[no]={[e.item.call_id]:e.item.id};else if("response.output_item.done"===e.type&&("web_search_call"===e.item.type||"file_search_call"===e.item.type||"computer_call"===e.item.type))o.tool_outputs=[e.item];else if("response.created"===e.type)s.id=e.response.id,s.model_name=e.response.model,s.model=e.response.model;else if("response.completed"===e.type){let r=nu(e.response);for(let[a,i]of(t=e.response.usage,e.response.text?.format?.type==="json_schema"&&(o.parsed??=JSON.parse(r.text)),Object.entries(e.response)))"id"!==a&&(s[a]=i)}else if("response.function_call_arguments.delta"===e.type)n.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if("response.web_search_call.completed"===e.type||"response.file_search_call.completed"===e.type)i={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else if("response.refusal.done"===e.type)o.refusal=e.refusal;else if("response.output_item.added"===e.type&&"item"in e&&"reasoning"===e.item.type){let t=e.item.summary?e.item.summary.map((e,t)=>({...e,index:t})):void 0;o.reasoning={id:e.item.id,type:e.item.type,...t?{summary:t}:{}}}else if("response.reasoning_summary_part.added"===e.type)o.reasoning={type:"reasoning",summary:[{...e.part,index:e.summary_index}]};else{if("response.reasoning_summary_text.delta"!==e.type)return null;o.reasoning={type:"reasoning",summary:[{text:e.delta,type:"summary_text",index:e.summary_index}]}}return new aO.Ls({text:a.map(e=>e.text).join(""),message:new aE.GC({id:r,content:a,tool_call_chunks:n,usage_metadata:t,additional_kwargs:o,response_metadata:s}),generationInfo:i})}(r);null!=e&&(yield e)}return}let n=ns(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:n,stream:!0};for await(let e of(await this.completionWithRetry(s,t))){let n=e?.choices?.[0];if(e.usage&&(i=e.usage),!n)continue;let{delta:s}=n;if(!s)continue;let o=this._convertOpenAIDeltaToBaseMessageChunk(s,e,a);a=s.role??a;let l={prompt:t.promptIndex??0,completion:n.index??0};if("string"!=typeof o.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let u={...l};null!=n.finish_reason&&(u.finish_reason=n.finish_reason,u.system_fingerprint=e.system_fingerprint,u.model_name=e.model),this.logprobs&&(u.logprobs=n.logprobs);let c=new aO.Ls({message:o,text:o.content,generationInfo:u});yield c,await r?.handleLLMNewToken(c.text??"",l,void 0,void 0,void 0,{chunk:c})}if(i){let e={...i.prompt_tokens_details?.audio_tokens!==null&&{audio:i.prompt_tokens_details?.audio_tokens},...i.prompt_tokens_details?.cached_tokens!==null&&{cache_read:i.prompt_tokens_details?.cached_tokens}},t={...i.completion_tokens_details?.audio_tokens!==null&&{audio:i.completion_tokens_details?.audio_tokens},...i.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:i.completion_tokens_details?.reasoning_tokens}},r=new aO.Ls({message:new aE.GC({content:"",response_metadata:{usage:{...i}},usage_metadata:{input_tokens:i.prompt_tokens,output_tokens:i.completion_tokens,total_tokens:i.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,r){let a=this.invocationParams(t);if(a.stream){let a;for await(let i of this._streamResponseChunks(e,t,r))i.message.response_metadata={...i.generationInfo,...i.message.response_metadata},a=a?.concat(i)??i;return{generations:a?[a]:[],llmOutput:{estimatedTokenUsage:a?.message?.usage_metadata}}}let i=e.filter(e=>(0,aE.Z0)(e)).pop(),n=i?.response_metadata?.id,s=nl(e,this.model,this.zdrEnabled),o=await this.responseApiWithRetry({input:s,...a,...n&&n.startsWith("resp_")&&!this.zdrEnabled?{previous_response_id:n}:{}},{signal:t?.signal,...t?.options});return{generations:[{text:o.output_text,message:nu(o)}],llmOutput:{id:o.id,estimatedTokenUsage:o.usage?{promptTokens:o.usage.input_tokens,completionTokens:o.usage.output_tokens,totalTokens:o.usage.total_tokens}:void 0}}}_useResponseApi(e){let t=e?.tools?.some(nc),r=e?.previous_response_id!=null||e?.text!=null||e?.truncation!=null||e?.include!=null||e?.reasoning?.summary!=null||this.reasoning?.summary!=null;return this.useResponsesApi||t||r}async _generate(e,t,r){if(this._useResponseApi(t))return this._responseApiGenerate(e,t,r);let a={},i=this.invocationParams(t),n=ns(e,this.model);if(i.stream){let i=this._streamResponseChunks(e,t,r),n={};for await(let e of i){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let t=e.generationInfo?.completion??0;void 0===n[t]?n[t]=e:n[t]=n[t].concat(e)}let s=Object.entries(n).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:l}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,l),c=await this.getNumTokensFromGenerations(s);return a.input_tokens=u,a.output_tokens=c,a.total_tokens=u+c,{generations:s,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options});let{completion_tokens:r,prompt_tokens:s,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:u}=e?.usage??{};r&&(a.output_tokens=(a.output_tokens??0)+r),s&&(a.input_tokens=(a.input_tokens??0)+s),o&&(a.total_tokens=(a.total_tokens??0)+o),(l?.audio_tokens!==null||l?.cached_tokens!==null)&&(a.input_token_details={...l?.audio_tokens!==null&&{audio:l?.audio_tokens},...l?.cached_tokens!==null&&{cache_read:l?.cached_tokens}}),(u?.audio_tokens!==null||u?.reasoning_tokens!==null)&&(a.output_token_details={...u?.audio_tokens!==null&&{audio:u?.audio_tokens},...u?.reasoning_tokens!==null&&{reasoning:u?.reasoning_tokens}});let c=[];for(let t of e?.choices??[]){let r={text:t.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(t.message??{role:"assistant"},e)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,aE.Z0)(r.message)&&(r.message.usage_metadata=a),r.message=new aE.gY(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),c.push(r)}return{generations:c,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){let e=function(e){let t=["namespace functions {",""];for(let r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(nr(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);a+=await this.getNumTokens(e),a+=9}return t&&e.find(e=>"system"===e._getType())&&(a-=4),"none"===r?a+=1:"object"==typeof r&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;"gpt-3.5-turbo-0301"===this.model?(r=4,a=-1):(r=3,a=1);let i=await Promise.all(e.map(async e=>{let i=await this.getNumTokens(e.content),n=await this.getNumTokens(ni(e)),s=void 0!==e.name?a+await this.getNumTokens(e.name):0,o=i+r+n+s;if("function"===e._getType()&&(o-=2),e.additional_kwargs?.function_call&&(o+=3),e?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(t){console.error("Error parsing function arguments",t,JSON.stringify(e.additional_kwargs.function_call)),o+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return t+=o,o}));return{totalCount:t+=3,countPerMessage:i}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw ne(e)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{let r=this._getClientOptions(t);try{if(e.text?.format?.type==="json_schema"&&!e.stream)return await this.client.responses.parse(e,r);return await this.client.responses.create(e,r)}catch(e){throw ne(e)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(e){throw ne(e)}})}_getClientOptions(e){if(!this.client){let e=function(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:a,azureOpenAIBasePath:i,baseURL:n,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((a||s)&&i&&t)return`${i}/${t}`;if((a||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(a||s){if(!r)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return n}({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new aw(t)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var r;let a,i,n,s,o,l;if(void 0!==(r=e)&&"object"==typeof r.schema?(a=e.schema,i=e.name,n=e.method,s=e.includeRaw):(a=e,i=t?.name,n=t?.method,s=t?.includeRaw),t?.strict!==void 0&&"jsonMode"===n)throw Error("Argument `strict` is only supported for `method` = 'function_calling'");if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model?"jsonSchema"===n&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`):void 0===n&&(n="jsonSchema"),"jsonMode"===n)o=this.withConfig({response_format:{type:"json_object"}}),l=nf(a)?iA.fromZodSchema(a):new iP;else if("jsonSchema"===n)if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:i??"extract",description:a.description,schema:a,strict:t?.strict}}}),nf(a)){let e=iA.fromZodSchema(a);l=aX.Y8.from(t=>"parsed"in t.additional_kwargs?t.additional_kwargs.parsed:e)}else l=new iP;else{let e=i??"extract";if(nf(a)){let r=(0,a$.Y_)(a);o=this.withConfig({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new iL({returnSingle:!0,keyName:e,zodSchema:a})}else{let r;"string"==typeof a.name&&"object"==typeof a.parameters&&null!=a.parameters?(r=a,e=a.name):r={name:e=a.title??e,description:a.description??"",parameters:a},o=this.withConfig({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new iL({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(l);let u=a9.assign({parsed:(e,t)=>l.invoke(e.raw,t)}),c=a9.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[c]});return aX.lW.from([{raw:o},d])}}function nf(e){return"function"==typeof e?.parse}var nm=r(379616);r(731858);var ng=r(509351);class ny extends aQ{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let r,a=(0,a4.LE)(t);return(0,ng.uB)(e)?(r=e.args,a={...a,toolCall:e}):r=e,this.call(r,a)}async call(e,t,r){let a,i,n,s,o,l=(0,ng.uB)(e)?e.args:e;if(a5(this.schema))try{a=await this.schema.parseAsync(l)}catch(r){let t="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(t=`${t}
Details: ${r.message}`),new ng.YE(t,JSON.stringify(e))}else{let t=function e(t,r,a="2019-09",i=function e(t,r=Object.create(null),a=ic,i=""){if(t&&"object"==typeof t&&!Array.isArray(t)){let n=t.$id||t.id;if(n){let s=new URL(n,a.href);s.hash.length>1?r[s.href]=t:(s.hash="",""===i?a=s:e(t,r,a))}}else if(!0!==t&&!1!==t)return r;let n=a.href+(i?"#"+i:"");if(void 0!==r[n])throw Error(`Duplicate schema URI "${n}".`);if(r[n]=t,!0===t||!1===t)return r;if(void 0===t.__absolute_uri__&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:n}),t.$ref&&void 0===t.__absolute_ref__){let e=new URL(t.$ref,a.href);e.hash=e.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:e.href})}if(t.$recursiveRef&&void 0===t.__absolute_recursive_ref__){let e=new URL(t.$recursiveRef,a.href);e.hash=e.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:e.href})}for(let n in t.$anchor&&(r[new URL("#"+t.$anchor,a.href).href]=t),t){if(iu[n])continue;let s=`${i}/${is(n)}`,o=t[n];if(Array.isArray(o)){if(io[n]){let t=o.length;for(let i=0;i<t;i++)e(o[i],r,a,`${s}/${i}`)}}else if(il[n])for(let t in o)e(o[t],r,a,`${s}/${is(t)}`);else e(o,r,a,s)}return r}(r),n=!0,s=null,o="#",l="#",u=Object.create(null)){let c;if(!0===r)return{valid:!0,errors:[]};if(!1===r)return{valid:!1,errors:[{instanceLocation:o,keyword:"false",keywordLocation:o,error:"False boolean schema."}]};let d=typeof t;switch(d){case"boolean":case"number":case"string":c=d;break;case"object":c=null===t?"null":Array.isArray(t)?"array":"object";break;default:throw Error(`Instances of "${d}" type are not supported.`)}let{$ref:h,$recursiveRef:p,$recursiveAnchor:f,type:m,const:g,enum:y,required:b,not:_,anyOf:v,allOf:w,oneOf:E,if:O,then:x,else:$,format:A,properties:S,patternProperties:k,additionalProperties:P,unevaluatedProperties:I,minProperties:j,maxProperties:T,propertyNames:R,dependentRequired:C,dependentSchemas:N,dependencies:L,prefixItems:M,items:U,additionalItems:D,unevaluatedItems:F,contains:B,minContains:z,maxContains:q,minItems:H,maxItems:Z,uniqueItems:J,minimum:G,maximum:W,exclusiveMinimum:V,exclusiveMaximum:K,multipleOf:X,minLength:Y,maxLength:Q,pattern:ee,__absolute_ref__:et,__absolute_recursive_ref__:er}=r,ea=[];if(!0===f&&null===s&&(s=r),"#"===p){let c=null===s?i[er]:s,d=`${l}/$recursiveRef`,h=e(t,null===s?r:s,a,i,n,c,o,d,u);h.valid||ea.push({instanceLocation:o,keyword:"$recursiveRef",keywordLocation:d,error:"A subschema had errors."},...h.errors)}if(void 0!==h){let r=i[et||h];if(void 0===r){let e=`Unresolved $ref "${h}".`;throw et&&et!==h&&(e+=`  Absolute URI "${et}".`),Error(e+=`
Known schemas:
- ${Object.keys(i).join("\n- ")}`)}let c=`${l}/$ref`,d=e(t,r,a,i,n,s,o,c,u);if(d.valid||ea.push({instanceLocation:o,keyword:"$ref",keywordLocation:c,error:"A subschema had errors."},...d.errors),"4"===a||"7"===a)return{valid:0===ea.length,errors:ea}}if(Array.isArray(m)){let e=m.length,r=!1;for(let a=0;a<e;a++)if(c===m[a]||"integer"===m[a]&&"number"===c&&t%1==0&&t==t){r=!0;break}r||ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m.join('", "')}".`})}else"integer"===m?("number"!==c||t%1||t!=t)&&ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m}".`}):void 0!==m&&c!==m&&ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m}".`});if(void 0!==g&&("object"===c||"array"===c?ii(t,g)||ea.push({instanceLocation:o,keyword:"const",keywordLocation:`${l}/const`,error:`Instance does not match ${JSON.stringify(g)}.`}):t!==g&&ea.push({instanceLocation:o,keyword:"const",keywordLocation:`${l}/const`,error:`Instance does not match ${JSON.stringify(g)}.`})),void 0!==y&&("object"===c||"array"===c?y.some(e=>ii(t,e))||ea.push({instanceLocation:o,keyword:"enum",keywordLocation:`${l}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`}):y.some(e=>t===e)||ea.push({instanceLocation:o,keyword:"enum",keywordLocation:`${l}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`})),void 0!==_){let r=`${l}/not`;e(t,_,a,i,n,s,o,r).valid&&ea.push({instanceLocation:o,keyword:"not",keywordLocation:r,error:'Instance matched "not" schema.'})}let ei=[];if(void 0!==v){let r=`${l}/anyOf`,c=ea.length,d=!1;for(let l=0;l<v.length;l++){let c=v[l],h=Object.create(u),p=e(t,c,a,i,n,!0===f?s:null,o,`${r}/${l}`,h);ea.push(...p.errors),d=d||p.valid,p.valid&&ei.push(h)}d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"anyOf",keywordLocation:r,error:"Instance does not match any subschemas."})}if(void 0!==w){let r=`${l}/allOf`,c=ea.length,d=!0;for(let l=0;l<w.length;l++){let c=w[l],h=Object.create(u),p=e(t,c,a,i,n,!0===f?s:null,o,`${r}/${l}`,h);ea.push(...p.errors),d=d&&p.valid,p.valid&&ei.push(h)}d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"allOf",keywordLocation:r,error:"Instance does not match every subschema."})}if(void 0!==E){let r=`${l}/oneOf`,c=ea.length,d=E.filter((l,c)=>{let d=Object.create(u),h=e(t,l,a,i,n,!0===f?s:null,o,`${r}/${c}`,d);return ea.push(...h.errors),h.valid&&ei.push(d),h.valid}).length;1===d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"oneOf",keywordLocation:r,error:`Instance does not match exactly one subschema (${d} matches).`})}if(("object"===c||"array"===c)&&Object.assign(u,...ei),void 0!==O){let r=`${l}/if`;if(e(t,O,a,i,n,s,o,r,u).valid){if(void 0!==x){let c=e(t,x,a,i,n,s,o,`${l}/then`,u);c.valid||ea.push({instanceLocation:o,keyword:"if",keywordLocation:r,error:'Instance does not match "then" schema.'},...c.errors)}}else if(void 0!==$){let c=e(t,$,a,i,n,s,o,`${l}/else`,u);c.valid||ea.push({instanceLocation:o,keyword:"if",keywordLocation:r,error:'Instance does not match "else" schema.'},...c.errors)}}if("object"===c){if(void 0!==b)for(let e of b)e in t||ea.push({instanceLocation:o,keyword:"required",keywordLocation:`${l}/required`,error:`Instance does not have required property "${e}".`});let r=Object.keys(t);if(void 0!==j&&r.length<j&&ea.push({instanceLocation:o,keyword:"minProperties",keywordLocation:`${l}/minProperties`,error:`Instance does not have at least ${j} properties.`}),void 0!==T&&r.length>T&&ea.push({instanceLocation:o,keyword:"maxProperties",keywordLocation:`${l}/maxProperties`,error:`Instance does not have at least ${T} properties.`}),void 0!==R){let r=`${l}/propertyNames`;for(let l in t){let t=`${o}/${is(l)}`,u=e(l,R,a,i,n,s,t,r);u.valid||ea.push({instanceLocation:o,keyword:"propertyNames",keywordLocation:r,error:`Property name "${l}" does not match schema.`},...u.errors)}}if(void 0!==C){let e=`${l}/dependantRequired`;for(let r in C)if(r in t)for(let a of C[r])a in t||ea.push({instanceLocation:o,keyword:"dependentRequired",keywordLocation:e,error:`Instance has "${r}" but does not have "${a}".`})}if(void 0!==N)for(let r in N){let c=`${l}/dependentSchemas`;if(r in t){let l=e(t,N[r],a,i,n,s,o,`${c}/${is(r)}`,u);l.valid||ea.push({instanceLocation:o,keyword:"dependentSchemas",keywordLocation:c,error:`Instance has "${r}" but does not match dependant schema.`},...l.errors)}}if(void 0!==L){let r=`${l}/dependencies`;for(let l in L)if(l in t){let u=L[l];if(Array.isArray(u))for(let e of u)e in t||ea.push({instanceLocation:o,keyword:"dependencies",keywordLocation:r,error:`Instance has "${l}" but does not have "${e}".`});else{let c=e(t,u,a,i,n,s,o,`${r}/${is(l)}`);c.valid||ea.push({instanceLocation:o,keyword:"dependencies",keywordLocation:r,error:`Instance has "${l}" but does not match dependant schema.`},...c.errors)}}}let c=Object.create(null),d=!1;if(void 0!==S){let r=`${l}/properties`;for(let l in S){if(!(l in t))continue;let h=`${o}/${is(l)}`,p=e(t[l],S[l],a,i,n,s,h,`${r}/${is(l)}`);if(p.valid)u[l]=c[l]=!0;else if(d=n,ea.push({instanceLocation:o,keyword:"properties",keywordLocation:r,error:`Property "${l}" does not match schema.`},...p.errors),d)break}}if(!d&&void 0!==k){let r=`${l}/patternProperties`;for(let l in k){let h=RegExp(l,"u"),p=k[l];for(let f in t){if(!h.test(f))continue;let m=`${o}/${is(f)}`,g=e(t[f],p,a,i,n,s,m,`${r}/${is(l)}`);g.valid?u[f]=c[f]=!0:(d=n,ea.push({instanceLocation:o,keyword:"patternProperties",keywordLocation:r,error:`Property "${f}" matches pattern "${l}" but does not match associated schema.`},...g.errors))}}}if(d||void 0===P){if(!d&&void 0!==I){let r=`${l}/unevaluatedProperties`;for(let l in t)if(!u[l]){let c=`${o}/${is(l)}`,d=e(t[l],I,a,i,n,s,c,r);d.valid?u[l]=!0:ea.push({instanceLocation:o,keyword:"unevaluatedProperties",keywordLocation:r,error:`Property "${l}" does not match unevaluated properties schema.`},...d.errors)}}}else{let r=`${l}/additionalProperties`;for(let l in t){if(c[l])continue;let h=`${o}/${is(l)}`,p=e(t[l],P,a,i,n,s,h,r);p.valid?u[l]=!0:(d=n,ea.push({instanceLocation:o,keyword:"additionalProperties",keywordLocation:r,error:`Property "${l}" does not match additional properties schema.`},...p.errors))}}}else if("array"===c){void 0!==Z&&t.length>Z&&ea.push({instanceLocation:o,keyword:"maxItems",keywordLocation:`${l}/maxItems`,error:`Array has too many items (${t.length} > ${Z}).`}),void 0!==H&&t.length<H&&ea.push({instanceLocation:o,keyword:"minItems",keywordLocation:`${l}/minItems`,error:`Array has too few items (${t.length} < ${H}).`});let r=t.length,c=0,d=!1;if(void 0!==M){let h=`${l}/prefixItems`,p=Math.min(M.length,r);for(;c<p;c++){let r=e(t[c],M[c],a,i,n,s,`${o}/${c}`,`${h}/${c}`);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"prefixItems",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}}if(void 0!==U){let h=`${l}/items`;if(Array.isArray(U)){let l=Math.min(U.length,r);for(;c<l;c++){let r=e(t[c],U[c],a,i,n,s,`${o}/${c}`,`${h}/${c}`);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}}else for(;c<r;c++){let r=e(t[c],U,a,i,n,s,`${o}/${c}`,h);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}if(!d&&void 0!==D){let h=`${l}/additionalItems`;for(;c<r;c++){let r=e(t[c],D,a,i,n,s,`${o}/${c}`,h);u[c]=!0,r.valid||(d=n,ea.push({instanceLocation:o,keyword:"additionalItems",keywordLocation:h,error:"Items did not match additional items schema."},...r.errors))}}}if(void 0!==B)if(0===r&&void 0===z)ea.push({instanceLocation:o,keyword:"contains",keywordLocation:`${l}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==z&&r<z)ea.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${l}/minContains`,error:`Array has less items (${r}) than minContains (${z}).`});else{let c=`${l}/contains`,d=ea.length,h=0;for(let l=0;l<r;l++){let r=e(t[l],B,a,i,n,s,`${o}/${l}`,c);r.valid?(u[l]=!0,h++):ea.push(...r.errors)}h>=(z||0)&&(ea.length=d),void 0===z&&void 0===q&&0===h?ea.splice(d,0,{instanceLocation:o,keyword:"contains",keywordLocation:c,error:"Array does not contain item matching schema."}):void 0!==z&&h<z?ea.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${l}/minContains`,error:`Array must contain at least ${z} items matching schema. Only ${h} items were found.`}):void 0!==q&&h>q&&ea.push({instanceLocation:o,keyword:"maxContains",keywordLocation:`${l}/maxContains`,error:`Array may contain at most ${q} items matching schema. ${h} items were found.`})}if(!d&&void 0!==F){let d=`${l}/unevaluatedItems`;for(;c<r;c++){if(u[c])continue;let r=e(t[c],F,a,i,n,s,`${o}/${c}`,d);u[c]=!0,r.valid||ea.push({instanceLocation:o,keyword:"unevaluatedItems",keywordLocation:d,error:"Items did not match unevaluated items schema."},...r.errors)}}if(J)for(let e=0;e<r;e++){let a=t[e],i="object"==typeof a&&null!==a;for(let n=0;n<r;n++){if(e===n)continue;let r=t[n],s="object"==typeof r&&null!==r;(a===r||i&&s&&ii(a,r))&&(ea.push({instanceLocation:o,keyword:"uniqueItems",keywordLocation:`${l}/uniqueItems`,error:`Duplicate items at indexes ${e} and ${n}.`}),e=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER)}}}else if("number"===c){if("4"===a?(void 0!==G&&(!0===V&&t<=G||t<G)&&ea.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${l}/minimum`,error:`${t} is less than ${V?"or equal to ":""} ${G}.`}),void 0!==W&&(!0===K&&t>=W||t>W)&&ea.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${l}/maximum`,error:`${t} is greater than ${K?"or equal to ":""} ${W}.`})):(void 0!==G&&t<G&&ea.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${l}/minimum`,error:`${t} is less than ${G}.`}),void 0!==W&&t>W&&ea.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${l}/maximum`,error:`${t} is greater than ${W}.`}),void 0!==V&&t<=V&&ea.push({instanceLocation:o,keyword:"exclusiveMinimum",keywordLocation:`${l}/exclusiveMinimum`,error:`${t} is less than ${V}.`}),void 0!==K&&t>=K&&ea.push({instanceLocation:o,keyword:"exclusiveMaximum",keywordLocation:`${l}/exclusiveMaximum`,error:`${t} is greater than or equal to ${K}.`})),void 0!==X){let e=t%X;Math.abs(0-e)>=11920929e-14&&Math.abs(X-e)>=11920929e-14&&ea.push({instanceLocation:o,keyword:"multipleOf",keywordLocation:`${l}/multipleOf`,error:`${t} is not a multiple of ${X}.`})}}else if("string"===c){let e=void 0===Y&&void 0===Q?0:function(e){let t,r=0,a=e.length,i=0;for(;i<a;)r++,(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<a&&(64512&(t=e.charCodeAt(i)))==56320&&i++;return r}(t);void 0!==Y&&e<Y&&ea.push({instanceLocation:o,keyword:"minLength",keywordLocation:`${l}/minLength`,error:`String is too short (${e} < ${Y}).`}),void 0!==Q&&e>Q&&ea.push({instanceLocation:o,keyword:"maxLength",keywordLocation:`${l}/maxLength`,error:`String is too long (${e} > ${Q}).`}),void 0===ee||RegExp(ee,"u").test(t)||ea.push({instanceLocation:o,keyword:"pattern",keywordLocation:`${l}/pattern`,error:"String does not match pattern."}),void 0!==A&&ig[A]&&!ig[A](t)&&ea.push({instanceLocation:o,keyword:"format",keywordLocation:`${l}/format`,error:`String does not match format "${A}".`})}return{valid:0===ea.length,errors:ea}}(l,this.schema);if(!t.valid){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}
Details: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new ng.YE(r,JSON.stringify(e))}a=l}let u=(0,a1.QH)(t),c=a1.Ye.configure(u.callbacks,this.callbacks,u.tags||r,this.tags,u.metadata,this.metadata,{verbose:this.verbose}),d=await c?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),u.runId,void 0,void 0,void 0,u.runName);delete u.runId;try{i=await this._call(a,d,u)}catch(e){throw await d?.handleToolError(e),e}if("content_and_artifact"===this.responseFormat)if(Array.isArray(i)&&2===i.length)[n,s]=i;else throw Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(i)}`);else n=i;(0,ng.uB)(e)&&(o=e.id),!o&&(0,ng.qS)(u)&&(o=u.toolCall.id);let h=function(e){let{content:t,artifact:r,toolCallId:a}=e;return!a||(0,nm.BE)(t)?t:new nm.Cq("string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?{content:t,artifact:r,tool_call_id:a,name:e.name}:{content:function(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}(t),artifact:r,tool_call_id:a,name:e.name})}({content:n,artifact:s,toolCallId:o,name:this.name});return await d?.handleToolEnd(h),h}}class nb extends ny{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:a3.z.object({input:a3.z.string().optional()}).transform(e=>e.input)})}call(e,t){return super.call("string"==typeof e||null==e?{input:e}:e,t)}}Object.defineProperty(class extends nb{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t={apiKey:e?.apiKey??e?.openAIApiKey??(0,ax.lS)("OPENAI_API_KEY"),organization:e?.organization??(0,ax.lS)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseURL:e?.baseUrl};this.client=new aw(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data?.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)??[]):e.flatMap(e=>e.data?.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url)??[])}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}let r=await this.client.images.generate(t),a="";return"url"===this.dallEResponseFormat?[a]=r.data?.map(e=>e.url).filter(e=>"undefined"!==e)??[]:[a]=r.data?.map(e=>e.b64_json).filter(e=>"undefined"!==e)??[],a}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"})},842260:function(e,t,r){"use strict";r.d(t,{KU:()=>R});var a=r(724137),i=r(750980),n=r(350709),s=r(588148);let o=[400,401,403,404,405,406,407,408],l=[409];class u{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.debug=e.debug,"default"in n?this.queue=new n.default({concurrency:this.maxConcurrency}):this.queue=new n({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>i(()=>e(...t).catch(e=>{if(e instanceof Error)throw e;throw Error(e)}),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError")||e?.code==="ECONNABORTED")throw e;let t=e?.response,a=t?.status;if(a){if(o.includes(+a))throw e;if(l.includes(+a))return;r&&await r(t)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>(0,s.sv)(this.debug)(...e).then(e=>e.ok?e:Promise.reject(e)))}}function c(e){return"function"==typeof e?._getType}function d(e){let t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var h=r(43266),p=r(864055),f=r(443269);function m(e,t){if(!f.Z(e))throw Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}var g=r(7270);function y(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw Error(`Invalid identifier format: ${e}`);let[t,r]=e.split(":"),a=r||"latest";if(t.includes("/")){let[r,i]=t.split("/",2);if(!r||!i)throw Error(`Invalid identifier format: ${e}`);return[r,i,a]}if(!t)throw Error(`Invalid identifier format: ${e}`);return["-",t,a]}r(422066);class b extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function _(e,t,r){let a;if(e.ok){r&&(a=await e.text());return}a=await e.text();let i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${a}`;if(409===e.status)throw new b(i);let n=Error(i);throw n.status=e.status,n}var v={result:"[Circular]"},w=[],E=[];let O=new TextEncoder;function x(e){return O.encode(e)}function $(e,t,r,a,i){try{let t=JSON.stringify(e,r,a);return x(t)}catch(o){let s;if(!o.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),x("[Unserializable]");console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),void 0===i&&(i={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),function e(t,r,a,i,n,s,o){if(s+=1,"object"==typeof t&&null!==t){for(l=0;l<i.length;l++)if(i[l]===t)return void A(v,t,r,n);if(void 0!==o.depthLimit&&s>o.depthLimit||void 0!==o.edgesLimit&&a+1>o.edgesLimit)return void A("[...]",t,r,n);if(i.push(t),Array.isArray(t))for(l=0;l<t.length;l++)e(t[l],l,l,i,t,s,o);else{var l,u=Object.keys(t);for(l=0;l<u.length;l++){var c=u[l];e(t[c],c,l,i,t,s,o)}}i.pop()}}(e,"",0,[],void 0,0,i);try{var n;s=0===E.length?JSON.stringify(e,r,a):JSON.stringify(e,(n=r,n=void 0!==n?n:function(e,t){return t},function(e,t){if(E.length>0)for(var r=0;r<E.length;r++){var a=E[r];if(a[1]===e&&a[0]===t){t=a[2],E.splice(r,1);break}}return n.call(this,e,t)}),a)}catch(e){return x("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==w.length;){let e=w.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return x(s)}}function A(e,t,r,a){var i=Object.getOwnPropertyDescriptor(a,r);void 0!==i.get?i.configurable?(Object.defineProperty(a,r,{value:e}),w.push([a,r,t,i])):E.push([t,r,e]):(a[r]=e,w.push([a,r,t]))}function S(e){let t=(0,h.sA)(),r=(0,h.DW)(),a=e.extra??{},i=a.metadata;return e.extra={...a,runtime:{...t,...a?.runtime},metadata:{...r,...r.revision_id||e.revision_id?{revision_id:e.revision_id??r.revision_id}:{},...i}},e}async function k(e){let t=[];for await(let r of e)t.push(r);return t}function P(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}let I=async e=>{if(e?.status===429){let t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};function j(e){return"number"==typeof e?Number(e.toFixed(4)):e}class T{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,r=new Promise(e=>{t=e}),a=$(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){if(e<1)throw Error("Number of bytes to pop off may not be less than 1.");let t=[],r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){let e=this.items.shift();e&&(t.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){let e=this.items.shift();t.push(e),r+=e.size,this.sizeBytes-=e.size}return[t.map(e=>({action:e.action,item:e.payload})),()=>t.forEach(e=>e.itemPromiseResolve())]}}class R{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new T}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,h.lS)("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===(0,h.lS)("LANGSMITH_DEBUG")});let t=R.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{let t=e?.toString()??(0,h.HC)("TRACING_SAMPLING_RATE");if(void 0===t)return;let r=parseFloat(t);if(r<0||r>1)throw Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r})(e.tracingSamplingRate),this.apiUrl=P(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=P(e.apiKey??t.apiKey),this.webUrl=P(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new u({...e.callerOptions??{},debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.batchIngestCaller=new u({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:I,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){let e=(0,h.HC)("API_KEY"),t=(0,h.HC)("ENDPOINT")??"https://api.smith.langchain.com";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:"true"===(0,h.HC)("HIDE_INPUTS"),hideOutputs:"true"===(0,h.HC)("HIDE_OUTPUTS")}}getHostUrl(){if(this.webUrl)return this.webUrl;if((e=>{let t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl))return this.webUrl="http://localhost:3000",this.webUrl;if(this.apiUrl.endsWith("/api/v1"))return this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl;if(this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api"))return this.webUrl=this.apiUrl.replace("/api",""),this.webUrl;if(this.apiUrl.split(".",1)[0].includes("dev"))return this.webUrl="https://dev.smith.langchain.com",this.webUrl;else if(this.apiUrl.split(".",1)[0].includes("eu"))return this.webUrl="https://eu.smith.langchain.com",this.webUrl;else if(this.apiUrl.split(".",1)[0].includes("beta"))return this.webUrl="https://beta.smith.langchain.com",this.webUrl;else return this.webUrl="https://smith.langchain.com",this.webUrl}get headers(){let e={"User-Agent":`langsmith-js/${p.I9}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){let t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,i=await this.caller.call((0,s.sv)(this.debug),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,`Failed to fetch ${e}`),i}async _get(e,t){return(await this._getResponse(e,t)).json()}async *_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0,i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(i));let n=`${this.apiUrl}${e}?${t}`,o=await this.caller.call((0,s.sv)(this.debug),n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,`Failed to fetch ${e}`);let l=r?r(await o.json()):await o.json();if(0===l.length||(yield l,l.length<i))break;a+=l.length}}async *_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let i=t?{...t}:{};for(;;){let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(i)}),n=await t.json();if(!n||!n[a])break;yield n[a];let o=n.cursors;if(!o||!o.next)break;i.cursor=o.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){let t=[];for(let r of e)this.filteredPostUuids.has(r.id)?this.filteredPostUuids.delete(r.id):t.push(r);return t}{let t=[];for(let r of e){let e=r.trace_id??r.id;this.filteredPostUuids.has(e)||(r.id===e?this._shouldSample()?t.push(r):this.filteredPostUuids.add(e):t.push(r))}return t}}async _getBatchSizeLimitBytes(){let e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??0x1400000}async _getMultiPartSupport(){let e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){let t=[];for(;this.autoBatchQueue.items.length>0;){let[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}let i=this._processBatch(r,a).catch(console.error);t.push(i)}return Promise.all(t)}async _processBatch(e,t){if(!e.length)return void t();try{let t={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},r=await this._ensureServerInfo();r?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=S(e.item));let t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;let r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){let e=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(2500),...this.fetchOptions});await _(e,"get server info");let t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[WARNING]: LangSmith failed to fetch info on supported operations with status code ${e.status}. Falling back to batch operations and default limits.`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=await this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order)return void this.processRunOperation({action:"create",item:a}).catch(console.error);let i=S(a),n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:$(i,`Creating run with id: ${i.id}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r=await Promise.all(e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]),a=await Promise.all(t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]);if(r.length>0&&a.length>0){let e=r.reduce((e,t)=>(t.id&&(e[t.id]=t),e),{}),t=[];for(let r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);r=Object.values(e),a=t}let i={post:r,patch:a};if(!i.post.length&&!i.patch.length)return;let n={post:[],patch:[]};for(let e of["post","patch"]){let t=i[e].reverse(),r=t.pop();for(;void 0!==r;)n[e].push(r),r=t.pop()}if(n.post.length>0||n.patch.length>0){let e=n.post.map(e=>e.id).concat(n.patch.map(e=>e.id)).join(",");await this._postBatchIngestRuns($(n,`Ingesting runs with ids: ${e}`))}}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r={},a=[];for(let t of e??[]){let e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(r[e.id]=e.attachments),delete e.attachments,a.push(e)}let i=[];for(let e of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==a.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==i.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&i.length>0){let e=a.reduce((e,t)=>(t.id&&(e[t.id]=t),e),{}),t=[];for(let r of i)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);a=Object.values(e),i=t}if(0===a.length&&0===i.length)return;let n=[],s=[];for(let[e,t]of[["post",a],["patch",i]])for(let a of t){let{inputs:t,outputs:i,events:o,attachments:l,...u}=a,c={inputs:t,outputs:i,events:o},d=$(u,`Serializing for multipart ingestion of run with id: ${u.id}`);for(let[t,r]of(s.push({name:`${e}.${u.id}`,payload:new Blob([d],{type:`application/json; length=${d.length}`})}),Object.entries(c))){if(void 0===r)continue;let a=$(r,`Serializing ${t} for multipart ingestion of run with id: ${u.id}`);s.push({name:`${e}.${u.id}.${t}`,payload:new Blob([a],{type:`application/json; length=${a.length}`})})}if(void 0!==u.id){let e=r[u.id];if(e)for(let[t,a]of(delete r[u.id],Object.entries(e))){let e,r;if(Array.isArray(a)?[e,r]=a:(e=a.mimeType,r=a.data),t.includes(".")){console.warn(`Skipping attachment '${t}' for run ${u.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}s.push({name:`attachment.${u.id}.${t}`,payload:new Blob([r],{type:`${e}; length=${r.byteLength}`})})}}n.push(`trace=${u.trace_id},id=${u.id}`)}await this._sendMultipartRequest(s,n.join("; "))}async _createNodeFetchBody(e,t){let r=[];for(let a of e)r.push(new Blob([`--${t}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),r.push(a.payload),r.push(new Blob(["\r\n"]));r.push(new Blob([`--${t}--\r
`]));let a=new Blob(r);return await a.arrayBuffer()}async _createMultipartStream(e,t){let r=new TextEncoder;return new ReadableStream({async start(a){let i=async e=>{"string"==typeof e?a.enqueue(r.encode(e)):a.enqueue(e)};for(let r of e){await i(`--${t}\r
`),await i(`Content-Disposition: form-data; name="${r.name}"\r
`),await i(`Content-Type: ${r.payload.type}\r
\r
`);let e=r.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)a.enqueue(t.value)}finally{e.releaseLock()}await i("\r\n")}await i(`--${t}--\r
`),a.close()}})}async _sendMultipartRequest(e,t){try{let t="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),r=await ((0,s.Pf)()?this._createNodeFetchBody(e,t):this._createMultipartStream(e,t)),a=await this.batchIngestCaller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${t}`},body:r,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"ingest multipart runs",!0)}catch(e){console.warn(`${e.message.trim()}

Context: ${t}`)}}async updateRun(e,t){m(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:r}).catch(console.error):void this.processRunOperation({action:"update",item:r}).catch(console.error);let a={...this.headers,"Content-Type":"application/json"},i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:$(t,`Serializing payload to update run with id: ${e}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){m(e);let r=await this._get(`/runs/${e}`);return t&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:(0,h.HC)("PROJECT")||"default"})).id;let a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){let t=await this.readRun(e);if(!t.app_path)throw Error(`Run ${e} has no app_path`);let r=this.getHostUrl();return`${r}${t.app_path}`}throw Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await k(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},a={};for(let i of(t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")),t)){if(null===i.parent_run_id||void 0===i.parent_run_id)throw Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),a[i.id]=i)}for(let t in e.child_runs=r[e.id]||[],r)t!==e.id&&(a[t].child_runs=r[t]);return e}async *listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:i,referenceExampleId:n,startTime:s,executionOrder:o,isRoot:l,runType:u,error:c,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y,order:b}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let e=Array.isArray(r)?r:[r],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));_.push(...t)}let v={session:_.length?_:null,run_type:u,reference_example:n,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:a,start_time:s?s.toISOString():null,error:c,id:d,limit:g,trace:i,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l,order:b},w=0;for await(let e of this._getCursorPaginatedList("/runs/query",v))if(g){if(w>=g)break;if(e.length+w>g){let t=e.slice(0,g-w);yield*t;break}w+=e.length,yield*e}else yield*e}async *listGroupRuns(e){let{projectId:t,projectName:r,groupBy:a,filter:i,startTime:n,endTime:o,limit:l,offset:u}=e,c={session_id:t||(await this.readProject({projectName:r})).id,group_by:a,filter:i,start_time:n?n.toISOString():null,end_time:o?o.toISOString():null,limit:Number(l)||100},d=Number(u)||0,h="/runs/group",p=`${this.apiUrl}${h}`;for(;;){let e=Object.fromEntries(Object.entries({...c,offset:d}).filter(([e,t])=>void 0!==t)),t=await this.caller.call((0,s.sv)(),p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,`Failed to fetch ${h}`);let{groups:r,total:a}=await t.json();if(0===r.length)break;for(let e of r)yield e;if((d+=r.length)>=a)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:i,projectIds:n,referenceExampleIds:o,startTime:l,endTime:u,error:c,query:d,filter:h,traceFilter:p,treeFilter:f,isRoot:m,dataSourceType:g}){let y=n||[];i&&(y=[...n||[],...await Promise.all(i.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);let b=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:y,reference_example:o,start_time:l,end_time:u,error:c,query:d,filter:h,trace_filter:p,tree_filter:f,is_root:m,data_source_type:g}).filter(([e,t])=>void 0!==t)),_=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _.json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||a.Z()};m(e);let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await i.json();if(null===n||!("share_token"in n))throw Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(e){m(e);let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare run",!0)}async readRunSharedLink(e){m(e);let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(void 0!==t)for(let e of t)r.append("id",e);m(e);let a=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),m(e);let r=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};m(e);let a=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){m(e);let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare dataset",!0)}async readSharedDataset(e){m(e);let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){let r={};t?.exampleIds&&(r.id=t.exampleIds);let a=new URLSearchParams;Object.entries(r).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>a.append(e,t)):a.append(e,t)});let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await i.json();if(!i.ok){if("detail"in n)throw Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(n.detail)?n.detail.join("\n"):"Unspecified error"}`);throw Error(`Failed to list shared examples: ${i.status} ${i.statusText}`)}return n.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:i=null,referenceDatasetId:n=null}){let o=`${this.apiUrl}/sessions${a?"?upsert=true":""}`,l=i||{};r&&(l.metadata=r);let u={name:e,extra:l,description:t};null!==n&&(u.reference_dataset_id=n);let c=await this.caller.call((0,s.sv)(this.debug),o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(c,"create project"),await c.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:i=null,endTime:n=null}){let o=`${this.apiUrl}/sessions/${e}`,l=i;a&&(l={...l||{},metadata:a});let u={name:t,extra:l,description:r,end_time:n?new Date(n).toISOString():null},c=await this.caller.call((0,s.sv)(this.debug),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(c,"update project"),await c.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),r+=`/${e}`;else if(void 0!==t)a.append("name",t);else throw Error("Must provide projectName or projectId");let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let e=await i.json();if(!i.ok)return!1;if(Array.isArray(e))return e.length>0;return!0}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a,i="/sessions",n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),i+=`/${e}`;else if(void 0!==t)n.append("name",t);else throw Error("Must provide projectName or projectId");void 0!==r&&n.append("include_stats",r.toString());let s=await this._get(i,n);if(Array.isArray(s)){if(0===s.length)throw Error(`Project[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw Error("No projects found to resolve tenant.")}async *listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:i,referenceFree:n,metadata:s}={}){let o=new URLSearchParams;if(void 0!==e)for(let t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==r&&o.append("name_contains",r),void 0!==a)o.append("reference_dataset",a);else if(void 0!==i){let e=await this.readDataset({datasetName:i});o.append("reference_dataset",e.id)}for await(let e of(void 0!==n&&o.append("reference_free",n.toString()),void 0!==s&&o.append("metadata",JSON.stringify(s)),this._getPaginated("/sessions",o)))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");m(r=void 0===e?(await this.readProject({projectName:t})).id:e);let a=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:i,dataType:n,name:o}){let l=`${this.apiUrl}/datasets/upload`,u=new FormData;u.append("file",e,t),r.forEach(e=>{u.append("input_keys",e)}),a.forEach(e=>{u.append("output_keys",e)}),i&&u.append("description",i),n&&u.append("data_type",n),o&&u.append("name",o);let c=await this.caller.call((0,s.sv)(this.debug),l,{method:"POST",headers:this.headers,body:u,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(c,"upload CSV"),await c.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:i,metadata:n}={}){let o={name:e,description:t,extra:n?{metadata:n}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),i&&(o.outputs_schema_definition=i);let l=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(l,"create dataset"),await l.json()}async readDataset({datasetId:e,datasetName:t}){let r,a="/datasets",i=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)m(e),a+=`/${e}`;else if(void 0!==t)i.append("name",t);else throw Error("Must provide datasetName or datasetId");let n=await this._get(a,i);if(Array.isArray(n)){if(0===n.length)throw Error(`Dataset[id=${e}, name=${t}] not found`);r=n[0]}else r=n;return r}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let i=e;if(void 0===i&&void 0===t)throw Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");void 0===i&&(i=(await this.readDataset({datasetName:t})).id);let n=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof a?a:a.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,n)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else if(void 0!==t)e=(await this.readDataset({datasetName:t})).id;else throw Error("Must provide either datasetName or datasetId");let r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map(e=>JSON.parse(e))}async *listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:i,metadata:n}={}){let s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(let e of r)s.append("id",e);for await(let e of(void 0!==a&&s.append("name",a),void 0!==i&&s.append("name_contains",i),void 0!==n&&s.append("metadata",JSON.stringify(n)),this._getPaginated("/datasets",s)))yield*e}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw Error("Must provide either datasetName or datasetId");let i=t??(await this.readDataset({datasetName:r})).id;m(i);let n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"update dataset"),await n.json()}async updateDatasetTag(e){let{datasetId:t,datasetName:r,asOf:a,tag:i}=e;if(!t&&!r)throw Error("Must provide either datasetName or datasetId");let n=t??(await this.readDataset({datasetName:r})).id;m(n);let o=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${n}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:"string"==typeof a?a:a.toISOString(),tag:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(a=(await this.readDataset({datasetName:t})).id),void 0!==a)m(a),r+=`/${a}`;else throw Error("Must provide datasetName or datasetId");let i=await this.caller.call((0,s.sv)(this.debug),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,`delete ${r}`),await i.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(a||t)if(a&&t)throw Error("Must provide either datasetName or datasetId, not both");else a||(a=(await this.readDataset({datasetName:t})).id);else throw Error("Must provide either datasetName or datasetId");m(a);let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({tag:r}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){let i={limit:r,inputs:e};void 0!==a&&(i.filter=a),m(t);let n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"fetch similar examples"),(await n.json()).examples}async createExample(e,t,r){let i;if(C(e)&&(void 0!==t||void 0!==r))throw Error("Cannot provide outputs or options when using ExampleCreate object");let n=t?r?.datasetId:e.dataset_id,s=t?r?.datasetName:e.dataset_name;if(void 0===n&&void 0===s)throw Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==s)throw Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:s})).id);let o=(t?r?.createdAt:e.created_at)||new Date;i=C(e)?e:{inputs:e,outputs:t,created_at:o?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};let l=await this._uploadExamplesMultipart(n,[i]);return await this.readExample(l.example_ids?.[0]??a.Z())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];let t=e[0].dataset_id,r=e[0].dataset_name;if(void 0===t&&void 0===r)throw Error("Must provide either datasetName or datasetId");if(void 0!==t&&void 0!==r)throw Error("Must provide either datasetName or datasetId, not both");void 0===t&&(t=(await this.readDataset({datasetName:r})).id);let a=await this._uploadExamplesMultipart(t,e);return await Promise.all(a.example_ids.map(e=>this.readExample(e)))}let{inputs:t,outputs:r,metadata:a,splits:i,sourceRunIds:n,useSourceRunIOs:s,useSourceRunAttachments:o,attachments:l,exampleIds:u,datasetId:c,datasetName:d}=e;if(void 0===t)throw Error("Must provide inputs when using legacy parameters");let h=c;if(void 0===h&&void 0===d)throw Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==d)throw Error("Must provide either datasetName or datasetId, not both");void 0===h&&(h=(await this.readDataset({datasetName:d})).id);let p=t.map((e,t)=>({dataset_id:h,inputs:e,outputs:r?.[t],metadata:a?.[t],split:i?.[t],id:u?.[t],attachments:l?.[t],source_run_id:n?.[t],use_source_run_io:s?.[t],use_source_run_attachments:o?.[t]})),f=await this._uploadExamplesMultipart(h,p);return await Promise.all(f.example_ids.map(e=>this.readExample(e)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(e=>c(e)?d(e):e),i=c(t)?d(t):t;return this.createExample({input:a},{output:i},r)}async readExample(e){m(e);let t=`/examples/${e}`,{attachment_urls:r,...a}=await this._get(t);return r&&(a.attachments=Object.entries(r).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type},e),{})),a}async *listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:i,inlineS3Urls:n,metadata:s,limit:o,offset:l,filter:u,includeAttachments:c}={}){let d;if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else if(void 0!==t)d=(await this.readDataset({datasetName:t})).id;else throw Error("Must provide a datasetName or datasetId");let h=new URLSearchParams({dataset:d}),p=a?"string"==typeof a?a:a?.toISOString():void 0;if(p&&h.append("as_of",p),h.append("inline_s3_urls",(n??!0).toString()),void 0!==r)for(let e of r)h.append("id",e);if(void 0!==i)for(let e of i)h.append("splits",e);if(void 0!==s){let e=JSON.stringify(s);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==l&&h.append("offset",l.toString()),void 0!==u&&h.append("filter",u),!0===c&&["attachment_urls","outputs","metadata"].forEach(e=>h.append("select",e));let f=0;for await(let e of this._getPaginated("/examples",h)){for(let t of e){let{attachment_urls:e,...r}=t;e&&(r.attachments=Object.entries(e).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type||void 0},e),{})),yield r,f++}if(void 0!==o&&f>=o)break}}async deleteExample(e){m(e);let t=`/examples/${e}`,r=await this.caller.call((0,s.sv)(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async updateExample(e,t){let r,a,i;return m(r=t?e:e.id),i=void 0!==(a=t?{id:r,...t}:e).dataset_id?a.dataset_id:(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[a])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let i;if(m(i=e||(await this.readDataset({datasetName:t})).id),r&&a||!r&&!a)throw Error("Exactly one of asOf and tag must be specified.");let n=new URLSearchParams;void 0!==r&&n.append("as_of","string"==typeof r?r:r.toISOString()),void 0!==a&&n.append("tag",a);let o=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${i}/version?${n.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(void 0===e&&void 0===t)throw Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");m(a=void 0===e?(await this.readDataset({datasetName:t})).id:e);let i=new URLSearchParams,n=r?"string"==typeof r?r:r?.toISOString():void 0;return n&&i.append("as_of",n),await this._get(`/datasets/${a}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:i=!1}){let n;if(void 0===e&&void 0===t)throw Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");m(n=void 0===e?(await this.readDataset({datasetName:t})).id:e);let o={split_name:r,examples:a.map(e=>(m(e),e)),remove:i},l=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/${n}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:i}={loadChildRuns:!1}){let n;if((0,g.O)("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)n=await this.readRun(e,{loadChildRuns:a});else if("object"==typeof e&&"id"in e)n=e;else throw Error(`Invalid run type: ${typeof e}`);null!==n.reference_example_id&&void 0!==n.reference_example_id&&(i=await this.readExample(n.reference_example_id));let s=await t.evaluateRun(n,i),[o,l]=await this._logEvaluationFeedback(s,n,r);return l[0]}async createFeedback(e,t,{score:r,value:i,correction:n,comment:o,sourceInfo:l,feedbackSourceType:u="api",sourceRunId:c,feedbackId:d,feedbackConfig:h,projectId:p,comparativeExperimentId:f}){if(!e&&!p)throw Error("One of runId or projectId must be provided");if(e&&p)throw Error("Only one of runId or projectId can be provided");let g={type:u??"api",metadata:l??{}};void 0===c||g?.metadata===void 0||g.metadata.__run||(g.metadata.__run={run_id:c}),g?.metadata!==void 0&&g.metadata.__run?.run_id!==void 0&&m(g.metadata.__run.run_id);let y={id:d??a.Z(),run_id:e,key:t,score:j(r),value:i,correction:n,comment:o,feedback_source:g,comparative_experiment_id:f,feedbackConfig:h,session_id:p},b=`${this.apiUrl}/feedback`,v=await this.caller.call((0,s.sv)(this.debug),b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(y),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(v,"create feedback",!0),y}async updateFeedback(e,{score:t,value:r,correction:a,comment:i}){let n={};null!=t&&(n.score=j(t)),null!=r&&(n.value=r),null!=a&&(n.correction=a),null!=i&&(n.comment=i),m(e);let o=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"update feedback",!0)}async readFeedback(e){m(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){m(e);let t=`/feedback/${e}`,r=await this.caller.call((0,s.sv)(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async *listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let e of t)a.append("key",e);if(r)for(let e of r)a.append("source",e);for await(let e of this._getPaginated("/feedback",a))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let i={run_id:e,feedback_key:t,feedback_config:a};r?"string"==typeof r?i.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(i.expires_in=r):i.expires_in={hours:3};let n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await n.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:i,metadata:n,id:o}){if(0===t.length)throw Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw Error("A reference dataset is required");let l={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:i,created_at:(a??new Date)?.toISOString(),extra:{}};n&&(l.extra.metadata=n);let u=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await u.json()}async *listPresignedFeedbackTokens(e){m(e);let t=new URLSearchParams({run_id:e});for await(let e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){return"results"in e?e.results:Array.isArray(e)?e:[e]}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),i=[];for(let e of a){let a=r||{};e.evaluatorInfo&&(a={...e.evaluatorInfo,...a});let n=null;e.targetRunId?n=e.targetRunId:t&&(n=t.id),i.push(await this.createFeedback(n,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:a,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[a,i]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}async *listAnnotationQueues(e={}){let{queueIds:t,name:r,nameContains:a,limit:i}=e,n=new URLSearchParams;t&&t.forEach((e,t)=>{m(e,`queueIds[${t}]`),n.append("ids",e)}),r&&n.append("name",r),a&&n.append("name_contains",a),n.append("limit",(void 0!==i?Math.min(i,100):100).toString());let s=0;for await(let e of this._getPaginated("/annotation-queues",n))if(yield*e,s++,void 0!==i&&s>=i)break}async createAnnotationQueue(e){let{name:t,description:r,queueId:i,rubricInstructions:n}=e,o={name:t,description:r,id:i||a.Z(),rubric_instructions:n},l=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(o).filter(([e,t])=>void 0!==t))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(l,"create annotation queue"),await l.json()}async readAnnotationQueue(e){let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(t,"read annotation queue"),await t.json()}async updateAnnotationQueue(e,t){let{name:r,description:a,rubricInstructions:i}=t,n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a,rubric_instructions:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,"update annotation queue")}async deleteAnnotationQueue(e){let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){let r=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((e,t)=>m(e,`runIds[${t}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){let r=`/annotation-queues/${m(e,"queueId")}/run`,a=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(a,"get run from annotation queue"),await a.json()}async deleteRunFromAnnotationQueue(e,t){let r=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}/runs/${m(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){let r=await this._getSettings();return Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let t=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){let e="string"==typeof r.detail?r.detail:JSON.stringify(r.detail),a=Error(`Error ${t.status}: ${t.statusText}
${e}`);throw a.statusCode=t.status,a}if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[r,a,i]=y(e),n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,`${t?"like":"unlike"} prompt`),await n.json()}async _getPromptUrl(e){let[t,r,a]=y(e);if(await this._currentTenantIsOwner(t)){let e=await this._getSettings();return"latest"!==a?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==a?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async *listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async *listPrompts(e){let t=new URLSearchParams;for await(let r of(t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query),this._getPaginated("/repos",t,e=>e.repos)))yield*r}async getPrompt(e){let[t,r,a]=y(e),i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===i.status)return null;await _(i,"get prompt");let n=await i.json();return n.repo?n.repo:null}async createPrompt(e,t){let r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[a,i,n]=y(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);let o={repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},l=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"create prompt");let{repo:u}=await l.json();return u}async createCommit(e,t,r){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[a,i,n]=y(e),o=r?.parentCommitHash!=="latest"&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${a}/${i}`),l={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},u=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/commits/${a}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(u,"create commit");let c=await u.json();return this._getPromptUrl(`${a}/${i}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let e of t){let t=e.id,a=new Blob([$({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`)],{type:"application/json"});if(r.append(t,a),e.inputs){let a=new Blob([$(e.inputs,`Serializing inputs for example with id: ${t}`)],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){let a=new Blob([$(e.outputs,`Serializing outputs whle updating example with id: ${t}`)],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(let[a,i]of Object.entries(e.attachments)){let e,n;Array.isArray(i)?[e,n]=i:(e=i.mimeType,n=i.data);let s=new Blob([n],{type:`${e}; length=${n.byteLength}`});r.append(`${t}.attachment.${a}`,s)}if(e.attachments_operations){let a=new Blob([$(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`)],{type:"application/json"});r.append(`${t}.attachments_operations`,a)}}let a=e??t[0]?.dataset_id,i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/v1/platform/datasets/${a}/examples`,{method:"PATCH",headers:this.headers,body:r});return await i.json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let e of t){let t=(e.id??a.Z()).toString(),i=new Blob([$({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`)],{type:"application/json"});if(r.append(t,i),e.inputs){let a=new Blob([$(e.inputs,`Serializing inputs for uploaded example with id: ${t}`)],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){let a=new Blob([$(e.outputs,`Serializing outputs for uploaded example with id: ${t}`)],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(let[a,i]of Object.entries(e.attachments)){let e,n;Array.isArray(i)?[e,n]=i:(e=i.mimeType,n=i.data);let s=new Blob([n],{type:`${e}; length=${n.byteLength}`});r.append(`${t}.attachment.${a}`,s)}}let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r});return await _(i,"upload examples"),await i.json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[r,a]=y(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let i={};if(t?.description!==void 0&&(i.description=t.description),t?.readme!==void 0&&(i.readme=t.readme),t?.tags!==void 0&&(i.tags=t.tags),t?.isPublic!==void 0&&(i.is_public=t.isPublic),t?.isArchived!==void 0&&(i.is_archived=t.isArchived),0===Object.keys(i).length)throw Error("No valid update options provided");let n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(i),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"update prompt"),n.json()}async deletePrompt(e){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[t,r,a]=y(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);let i=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async pullPromptCommit(e,t){let[r,a,i]=y(e),n=await this.caller.call((0,s.sv)(this.debug),`${this.apiUrl}/commits/${r}/${a}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,"pull prompt commit");let o=await n.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){return JSON.stringify((await this.pullPromptCommit(e,{includeModel:t?.includeModel})).manifest)}async pushPrompt(e,t){return(await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object)?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){let{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[i,n]=this.parseTokenOrUrl(e,r),s=new R({apiUrl:i,apiKey:"placeholder"}),o=await s.readSharedDataset(n),l=a||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}let u=await s.listSharedExamples(n),c=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(e=>e.inputs),outputs:u.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:c.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return m(e),[t,e]}catch(e){}try{let i=new URL(e).pathname.split("/").filter(e=>""!==e);if(i.length>=r){let e=i[i.length-r];return[t,e]}throw Error(`Invalid public ${a} URL: ${e}`)}catch(t){throw Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}function C(e){return"dataset_id"in e||"dataset_name"in e}},864055:function(e,t,r){"use strict";r.d(t,{I9:()=>n,IV:()=>i.IV,KU:()=>a.KU});var a=r(842260),i=r(296587);r(588148);let n="0.3.30"},296587:function(e,t,r){"use strict";r.d(t,{IV:()=>u,n6:()=>c});var a=r(724137),i=r(43266),n=r(842260),s=r(7270);let o=Symbol.for("lc:context_variables");class l{constructor(e,t,r){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r}static fromHeader(e){let t,r=e.split(","),a={},i=[];for(let e of r){let[r,n]=e.split("="),s=decodeURIComponent(n);"langsmith-metadata"===r?a=JSON.parse(s):"langsmith-tags"===r?i=s.split(","):"langsmith-project"===r&&(t=s)}return new l(a,i,t)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class u{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),c(e))return void Object.assign(this,{...e});let t=u.getDefaultConfig(),{metadata:r,...a}=e,i=a.client??u.getSharedClient(),n={...r,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:n},Object.assign(this,{...t,...a,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){let e=function(e,t,r=1){let a=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${a}Z`.replace(/[-:.]/g,"")+t}(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:a.Z(),run_type:"chain",project_name:(0,i.HC)("PROJECT")??(0,i.lS)("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:(0,i.lS)("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:(0,i.lS)("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return u.sharedClient||(u.sharedClient=new n.KU),u.sharedClient}createChild(e){var t,r;let a=this.child_execution_order+1,i=new u({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:a,child_execution_order:a});o in this&&(i[o]=this[o]);let n=Symbol.for("lc:child_config"),s=e.extra?.[n]??this.extra[n];if(void 0!==(t=s)&&"object"==typeof t.callbacks&&(h(t.callbacks?.handlers)||h(t.callbacks))){let e={...s},t="object"==typeof(r=e.callbacks)&&null!=r&&Array.isArray(r.handlers)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:i.id}),t.handlers?.find(d)?.updateFromRunTree?.(i),e.callbacks=t),i.extra[n]=e}let l=new Set,c=this;for(;null!=c&&!l.has(c.id);)l.add(c.id),c.child_execution_order=Math.max(c.child_execution_order,a),c=c.parent_run;return this.child_runs.push(i),i}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){let a,i,n=e.extra??{};if(n.runtime||(n.runtime={}),t)for(let[e,r]of Object.entries(t))n.runtime[e]||(n.runtime[e]=r);return r?(i=e.parent_run?.id,a=[]):(a=e.child_runs.map(e=>this._convertToCreate(e,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{let t=(0,i.sA)(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e)for(let e of((0,s.O)("Posting with excludeChildRuns=false is deprecated and will be removed in a future version."),this.child_runs))await e.postRun(!1)}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){try{let e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var r;let a,n,s,o=e?.callbacks,l=void 0!==r?r:!!["TRACING_V2","TRACING"].find(e=>"true"===(0,i.HC)(e));if(o){let e=o?.getParentRunId?.()??"",t=o?.handlers?.find(e=>e?.name=="langchain_tracer");a=t?.getRun?.(e),n=t?.projectName,s=t?.client,l=l||!!t}return a?new u({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:s,tracingEnabled:l,project_name:n,tags:[...new Set((a?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...e?.metadata}}}).createChild(t):new u({...t,client:s,tracingEnabled:l,project_name:n})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){let r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||"string"!=typeof a)return;let i=a.trim(),n=i.split(".").map(e=>{let[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}}),s=n[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:n.at(-1)?.uuid,trace_id:s,dotted_order:i};if(r.baggage&&"string"==typeof r.baggage){let e=l.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name}return new u(o)}toHeaders(e){let t={"langsmith-trace":this.dotted_order,baggage:new l(this.extra?.metadata,this.tags,this.project_name).toHeader()};if(e)for(let[r,a]of Object.entries(t))e.set(r,a);return t}}function c(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function d(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function h(e){return Array.isArray(e)&&e.some(e=>d(e))}Object.defineProperty(u,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})},588148:function(e,t,r){"use strict";r.d(t,{Pf:()=>n,sv:()=>s});var a=r(43266);let i=Symbol.for("ls:fetch_implementation"),n=()=>{let e=globalThis[i];return!!e&&"function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e},s=e=>async(...t)=>{if(e||"true"===(0,a.HC)("DEBUG")){let[e,r]=t;console.log(` ${r?.method||"GET"} ${e}`)}let r=await (globalThis[i]??((...e)=>fetch(...e)))(...t);return(e||"true"===(0,a.HC)("DEBUG"))&&console.log(` ${r.status} ${r.statusText} ${r.url}`),r}},43266:function(e,t,r){"use strict";let a,i,n;r.d(t,{DW:()=>l,HC:()=>c,lS:()=>u,sA:()=>o});var s=r(864055);function o(){if(void 0===i){let e=a||(a="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||"undefined"!=typeof Deno?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":"undefined"!=typeof Deno?"deno":"other":"node"),t=function(){if(void 0!==n)return n;let e={};for(let t of["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"]){let r=u(t);void 0!==r&&(e[t]=r)}return n=e,e}();i={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:s.I9,...t}}return i}function l(){let e=function(){try{if("undefined"!=typeof process&&process.env)return Object.entries(process.env).reduce((e,[t,r])=>(e[t]=String(r),e),{});return}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[a,i]of Object.entries(e))(a.startsWith("LANGCHAIN_")||a.startsWith("LANGSMITH_"))&&"string"==typeof i&&!r.includes(a)&&!a.toLowerCase().includes("key")&&!a.toLowerCase().includes("secret")&&!a.toLowerCase().includes("token")&&("LANGCHAIN_REVISION_ID"===a?t.revision_id=i:t[a]=i);return t}function u(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function c(e){return u(`LANGSMITH_${e}`)||u(`LANGCHAIN_${e}`)}},7270:function(e,t,r){"use strict";r.d(t,{O:()=>i});let a={};function i(e){a[e]||(console.warn(e),a[e]=!0)}},773073:function(e,t,r){"use strict";r.d(t,{IV:()=>a.IV,KU:()=>a.KU});var a=r(864055)},14391:function(e,t,r){"use strict";r.d(t,{xQ:()=>l,dy:()=>o});var a=r(296587);let i=Symbol.for("ls:tracing_async_local_storage"),n=new class{getStore(){}run(e,t){return t()}},s=new class{getInstance(){return globalThis[i]??n}initializeGlobalInstance(e){void 0===globalThis[i]&&(globalThis[i]=e)}};function o(e=!1){let t=s.getInstance().getStore();if(!e&&!(0,a.n6)(t))throw Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}function l(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root")},512587:function(e,t,r){"use strict";r.d(t,{Z:()=>w});var a,i,n=r(13721),s=r(315358),o=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,l=/^\w*$/;let u=function(e,t){if((0,n.Z)(e))return!1;var r=typeof e;return!!("number"==r||"symbol"==r||"boolean"==r||null==e||(0,s.Z)(e))||l.test(e)||!o.test(e)||null!=t&&e in Object(t)};var c=r(697741);function d(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw TypeError("Expected a function");var r=function(){var a=arguments,i=t?t.apply(this,a):a[0],n=r.cache;if(n.has(i))return n.get(i);var s=e.apply(this,a);return r.cache=n.set(i,s)||n,s};return r.cache=new(d.Cache||c.Z),r}d.Cache=c.Z;var h=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,p=/\\(\\)?/g,f=(i=(a=d(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(h,function(e,r,a,i){t.push(a?i.replace(p,"$1"):r||e)}),t},function(e){return 500===i.size&&i.clear(),e})).cache,a),m=r(682642);let g=function(e,t){for(var r=-1,a=null==e?0:e.length,i=Array(a);++r<a;)i[r]=t(e[r],r,e);return i};var y=1/0,b=m.Z?m.Z.prototype:void 0,_=b?b.toString:void 0;let v=function e(t){if("string"==typeof t)return t;if((0,n.Z)(t))return g(t,e)+"";if((0,s.Z)(t))return _?_.call(t):"";var r=t+"";return"0"==r&&1/t==-y?"-0":r},w=function(e,t){return(0,n.Z)(e)?e:u(e,t)?[e]:f(null==e?"":v(e))}},522449:function(e,t,r){"use strict";r.d(t,{Z:()=>n});var a=r(315358),i=1/0;let n=function(e){if("string"==typeof e||(0,a.Z)(e))return e;var t=e+"";return"0"==t&&1/e==-i?"-0":t}},272521:function(e,t,r){"use strict";r.d(t,{Z:()=>s});var a=r(512587),i=r(522449);let n=function(e,t){t=(0,a.Z)(t,e);for(var r=0,n=t.length;null!=e&&r<n;)e=e[(0,i.Z)(t[r++])];return r&&r==n?e:void 0},s=function(e,t,r){var a=null==e?void 0:n(e,t);return void 0===a?r:a}},863875:function(e,t,r){"use strict";r.d(t,{Z:()=>a});let a=function(e){return null==e}},909860:function(e,t,r){"use strict";r.d(t,{Z:()=>f});var a=r(470487),i=function(){try{var e=(0,a.Z)(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();let n=function(e,t,r){"__proto__"==t&&i?i(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r};var s=r(103619),o=Object.prototype.hasOwnProperty;let l=function(e,t,r){var a=e[t];o.call(e,t)&&(0,s.Z)(a,r)&&(void 0!==r||t in e)||n(e,t,r)};var u=r(512587),c=r(429646),d=r(325486),h=r(522449);let p=function(e,t,r,a){if(!(0,d.Z)(e))return e;t=(0,u.Z)(t,e);for(var i=-1,n=t.length,s=n-1,o=e;null!=o&&++i<n;){var p=(0,h.Z)(t[i]),f=r;if("__proto__"===p||"constructor"===p||"prototype"===p)break;if(i!=s){var m=o[p];void 0===(f=a?a(m,p,o):void 0)&&(f=(0,d.Z)(m)?m:(0,c.Z)(t[i+1])?[]:{})}l(o,p,f),o=o[p]}return e},f=function(e,t,r){return null==e?e:p(e,t,r)}},798455:function(e,t,r){"use strict";let a;r.d(t,{Y_:()=>C});let i=Symbol("Let zodToJsonSchema decide on which parser to use"),n={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};var s=r(196130);function o(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function l(e,t,r,a,i){e[t]=r,o(e,t,a,i)}function u(e,t){return I(e.type._def,t)}let c=/^[cC][^\s-]{8,}$/,d=/^[0-9a-z]+$/,h=/^[0-9A-HJKMNP-TV-Z]{26}$/,p=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,f=()=>(void 0===a&&(a=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),a),m=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,g=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,y=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,b=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,_=/^[a-zA-Z0-9_-]{21}$/,v=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function w(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":l(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":l(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":x(r,"email",a.message,t);break;case"format:idn-email":x(r,"idn-email",a.message,t);break;case"pattern:zod":$(r,p,a.message,t)}break;case"url":x(r,"uri",a.message,t);break;case"uuid":x(r,"uuid",a.message,t);break;case"regex":$(r,a.regex,a.message,t);break;case"cuid":$(r,c,a.message,t);break;case"cuid2":$(r,d,a.message,t);break;case"startsWith":$(r,RegExp(`^${E(a.value,t)}`),a.message,t);break;case"endsWith":$(r,RegExp(`${E(a.value,t)}$`),a.message,t);break;case"datetime":x(r,"date-time",a.message,t);break;case"date":x(r,"date",a.message,t);break;case"time":x(r,"time",a.message,t);break;case"duration":x(r,"duration",a.message,t);break;case"length":l(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),l(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":$(r,RegExp(E(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&x(r,"ipv4",a.message,t),"v4"!==a.version&&x(r,"ipv6",a.message,t);break;case"base64url":$(r,b,a.message,t);break;case"jwt":$(r,v,a.message,t);break;case"cidr":"v6"!==a.version&&$(r,m,a.message,t),"v4"!==a.version&&$(r,g,a.message,t);break;case"emoji":$(r,f(),a.message,t);break;case"ulid":$(r,h,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":x(r,"binary",a.message,t);break;case"contentEncoding:base64":l(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":$(r,y,a.message,t)}break;case"nanoid":$(r,_,a.message,t)}return r}function E(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)O.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}let O=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function x(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):l(e,"format",t,r,a)}function $(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:A(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):l(e,"pattern",A(t,a),r,a)}function A(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,i="",n=!1,s=!1,o=!1;for(let e=0;e<a.length;e++){if(n){i+=a[e],n=!1;continue}if(r.i){if(s){if(a[e].match(/[a-z]/)){o?(i+=a[e],i+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(i+=a[e],o=!0):i+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){i+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){i+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){i+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){i+=s?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}i+=a[e],"\\"===a[e]?n=!0:s&&"]"===a[e]?s=!1:s||"["!==a[e]||(s=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function S(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===s.pA.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:I(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??{}}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:I(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===s.pA.ZodString&&e.keyType._def.checks?.length){let{type:a,...i}=w(e.keyType._def,t);return{...r,propertyNames:i}}if(e.keyType?._def.typeName===s.pA.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===s.pA.ZodBranded&&e.keyType._def.type._def.typeName===s.pA.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...i}=u(e.keyType._def,t);return{...r,propertyNames:i}}return r}let k={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},P=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>I(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function I(e,t,r=!1){let a=t.seen.get(e);if(t.override){let n=t.override?.(e,t,a,r);if(n!==i)return n}if(a&&!r){let e=j(a,t);if(void 0!==e)return e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let c=((e,t,r)=>{switch(t){case s.pA.ZodString:return w(e,r);case s.pA.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",o(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?l(a,"minimum",t.value,t.message,r):l(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),l(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?l(a,"maximum",t.value,t.message,r):l(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),l(a,"maximum",t.value,t.message,r));break;case"multipleOf":l(a,"multipleOf",t.value,t.message,r)}return a;case s.pA.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},i=[],n=e.shape();for(let e in n){let o=n[e];if(void 0===o||void 0===o._def)continue;let l=function(e){try{return e.isOptional()}catch{return!0}}(o);l&&r&&(o instanceof s.ak&&(o=o._def.innerType),o.isNullable()||(o=o.nullable()),l=!1);let u=I(o._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==u&&(a.properties[e]=u,l||i.push(e))}i.length&&(a.required=i);let o=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return I(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==o&&(a.additionalProperties=o),a}(e,r);case s.pA.ZodBigInt:let i={type:"integer",format:"int64"};if(!e.checks)return i;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?l(i,"minimum",t.value,t.message,r):l(i,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(i.exclusiveMinimum=!0),l(i,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?l(i,"maximum",t.value,t.message,r):l(i,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(i.exclusiveMaximum=!0),l(i,"maximum",t.value,t.message,r));break;case"multipleOf":l(i,"multipleOf",t.value,t.message,r)}return i;case s.pA.ZodBoolean:return{type:"boolean"};case s.pA.ZodDate:return function e(t,r,a){let i=a??r.dateStrategy;if(Array.isArray(i))return{anyOf:i.map((a,i)=>e(t,r,a))};switch(i){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,s=r;let o={type:"integer",format:"unix-time"};if("openApi3"===s.target)return o;for(let e of n.checks)switch(e.kind){case"min":l(o,"minimum",e.value,e.message,s);break;case"max":l(o,"maximum",e.value,e.message,s)}return o}}(e,r);case s.pA.ZodUndefined:return{not:{}};case s.pA.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case s.pA.ZodArray:let n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==s.pA.ZodAny&&(n.items=I(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&l(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&l(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(l(n,"minItems",e.exactLength.value,e.exactLength.message,r),l(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case s.pA.ZodUnion:case s.pA.ZodDiscriminatedUnion:if("openApi3"===r.target)return P(e,r);let c=e.options instanceof Map?Array.from(e.options.values()):e.options;if(c.every(e=>e._def.typeName in k&&(!e._def.checks||!e._def.checks.length))){let e=c.reduce((e,t)=>{let r=k[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(c.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=c.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===c.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:c.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(c.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:c.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return P(e,r);case s.pA.ZodIntersection:let d=[I(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),I(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),h="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,p=[];return d.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)p.push(...e.allOf),void 0===e.unevaluatedProperties&&(h=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else h=void 0;p.push(t)}}),p.length?{allOf:p,...h}:void 0;case s.pA.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>I(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:I(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>I(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case s.pA.ZodRecord:return S(e,r);case s.pA.ZodLiteral:let f=typeof e.value;return"bigint"!==f&&"number"!==f&&"boolean"!==f&&"string"!==f?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===f?"integer":f,enum:[e.value]}:{type:"bigint"===f?"integer":f,const:e.value};case s.pA.ZodEnum:return{type:"string",enum:Array.from(e.values)};case s.pA.ZodNativeEnum:let m=e.values,g=Object.keys(e.values).filter(e=>"number"!=typeof m[m[e]]).map(e=>m[e]),y=Array.from(new Set(g.map(e=>typeof e)));return{type:1===y.length?"string"===y[0]?"string":"number":["string","number"],enum:g};case s.pA.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:k[e.innerType._def.typeName],nullable:!0}:{type:[k[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=I(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let b=I(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return b&&{anyOf:[b,{type:"null"}]};case s.pA.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return I(e.innerType._def,r);let _=I(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return _?{anyOf:[{not:{}},_]}:{};case s.pA.ZodMap:if("record"===r.mapStrategy)return S(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[I(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},I(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case s.pA.ZodSet:let v={type:"array",uniqueItems:!0,items:I(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})};return e.minSize&&l(v,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&l(v,"maxItems",e.maxSize.value,e.maxSize.message,r),v;case s.pA.ZodLazy:return()=>e.getter()._def;case s.pA.ZodPromise:return I(e.type._def,r);case s.pA.ZodNaN:case s.pA.ZodNever:return{not:{}};case s.pA.ZodEffects:return"input"===r.effectStrategy?I(e.schema._def,r):{};case s.pA.ZodAny:case s.pA.ZodUnknown:return{};case s.pA.ZodDefault:return{...I(e.innerType._def,r),default:e.defaultValue()};case s.pA.ZodBranded:return u(e,r);case s.pA.ZodReadonly:case s.pA.ZodCatch:return I(e.innerType._def,r);case s.pA.ZodPipeline:if("input"===r.pipeStrategy)return I(e.in._def,r);if("output"===r.pipeStrategy)return I(e.out._def,r);let E=I(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),O=I(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",E?"1":"0"]});return{allOf:[E,O].filter(e=>void 0!==e)};case s.pA.ZodFunction:case s.pA.ZodVoid:case s.pA.ZodSymbol:default:return}})(e,e.typeName,t),d="function"==typeof c?I(c(),t):c;if(d&&R(e,t,d),t.postProcess){let r=t.postProcess(d,e,t);return n.jsonSchema=d,r}return n.jsonSchema=d,d}let j=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:T(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},T=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},R=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),C=(e,t)=>{let r=(e=>{let t="string"==typeof e?{...n,name:e}:{...n,...e},r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),a="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,a])=>({...e,[t]:I(a._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??{}}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,s=I(e._def,void 0===i?r:{...r,currentPath:[...r.basePath,r.definitionPath,i]},!1)??{},o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(s.title=o);let l=void 0===i?a?{...s,[r.definitionPath]:a}:s:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...a,[i]:s}};return"jsonSchema7"===r.target?l.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===r.target||"openAi"===r.target)&&(l.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===r.target&&("anyOf"in l||"oneOf"in l||"allOf"in l||"type"in l&&Array.isArray(l.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),l}}}]);