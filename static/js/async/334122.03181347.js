"use strict";(self.webpackChunk_flowgram_ai_docs=self.webpackChunk_flowgram_ai_docs||[]).push([["334122"],{302953:function(e,t,r){r.d(t,{TaskCancelAPI:()=>eQ,TaskReportAPI:()=>eU,TaskResultAPI:()=>eJ,TaskRunAPI:()=>eG,TaskValidateAPI:()=>eF});var s,o,a,n,i,u,l,d,c,p,h,f,g,m=r(123387),y=r(863875),b=r(842307),w=r(17217),E=r(999310),T=r(383909),N=r(969134),k=m.ZP.record(m.ZP.string(),m.ZP.any()),I=m.ZP.object({id:m.ZP.string(),nodeID:m.ZP.string(),inputs:k,outputs:k.optional(),data:k,branch:m.ZP.string().optional()}),v={status:m.ZP.string(),terminated:m.ZP.boolean(),startTime:m.ZP.number(),endTime:m.ZP.number().optional(),timeCost:m.ZP.number()},S=m.ZP.object(v),P=m.ZP.object({id:m.ZP.string(),...v,snapshots:m.ZP.array(I)}),_=m.ZP.record(m.ZP.string(),P),x=m.ZP.object({id:m.ZP.string(),type:m.ZP.enum(["log","info","debug","error","warning"]),message:m.ZP.string(),nodeID:m.ZP.string().optional(),timestamp:m.ZP.number()}),C=m.ZP.record(m.ZP.enum(["log","info","debug","error","warning"]),m.ZP.array(x)),O=((s=O||{}).ServerInfo="ServerInfo",s.TaskRun="TaskRun",s.TaskReport="TaskReport",s.TaskResult="TaskResult",s.TaskCancel="TaskCancel",s.TaskValidate="TaskValidate",s),$=(m.ZP.object({schema:m.ZP.string(),inputs:k}),m.ZP.object({valid:m.ZP.boolean(),errors:m.ZP.array(m.ZP.string()).optional()}),m.ZP.object({schema:m.ZP.string(),inputs:k}),m.ZP.object({taskID:m.ZP.string()}),m.ZP.object({taskID:m.ZP.string()}),{name:"TaskReport",method:"GET",path:"/task/report",module:"Task",schema:{input:m.ZP.object({taskID:m.ZP.string()}),output:m.ZP.object({id:m.ZP.string(),inputs:k,outputs:k,workflowStatus:S,reports:_,messages:C})}}),D=(m.ZP.object({taskID:m.ZP.string()}),m.ZP.object({success:m.ZP.boolean()}),m.ZP.undefined(),m.ZP.object({name:m.ZP.string(),runtime:m.ZP.string(),version:m.ZP.string(),time:m.ZP.string()}),(o=D||{}).Input="input",o.Output="output",o),Z=((a=Z||{}).String="string",a.Integer="integer",a.Number="number",a.Boolean="boolean",a.Object="object",a.Array="array",a.Map="map",a.DateTime="date-time",a.Null="null",a),A=((n=A||{}).Root="root",n.Start="start",n.End="end",n.LLM="llm",n.Code="code",n.Condition="condition",n.Loop="loop",n.Comment="comment",n.Group="group",n.BlockStart="block-start",n.BlockEnd="block-end",n.HTTP="http",n.Break="break",n.Continue="continue",n),j=((i=j||{}).EQ="eq",i.NEQ="neq",i.GT="gt",i.GTE="gte",i.LT="lt",i.LTE="lte",i.IN="in",i.NIN="nin",i.CONTAINS="contains",i.NOT_CONTAINS="not_contains",i.IS_EMPTY="is_empty",i.IS_NOT_EMPTY="is_not_empty",i.IS_TRUE="is_true",i.IS_FALSE="is_false",i),M=((u=M||{}).None="none",u.FormData="form-data",u.XWwwFormUrlencoded="x-www-form-urlencoded",u.RawText="raw-text",u.JSON="JSON",u.Binary="binary",u),V=Symbol.for("Engine"),L=Symbol.for("Executor"),R=((l=R||{}).Pending="pending",l.Processing="processing",l.Succeeded="succeeded",l.Failed="failed",l.Canceled="canceled",l),W=Symbol.for("Validation"),B=((d=B||{}).Log="log",d.Info="info",d.Debug="debug",d.Error="error",d.Warn="warning",d),Y=class{async execute(e){return{outputs:e.runtime.ioCenter.inputs}}constructor(){this.type=A.Start}},q=b.Z;function F(e,t){let r=new Set,s=[],o=e=>{for(let a of t(e))r.has(a.id)||(r.add(a.id),s.push(a),o(a))};return o(e),s}(c=p||(p={})).getWorkflowType=e=>{if(null==e)return Z.Null;if("string"==typeof e)return/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?$/.test(e)&&!isNaN(new Date(e).getTime())?Z.DateTime:Z.String;return"boolean"==typeof e?Z.Boolean:"number"==typeof e?Number.isInteger(e)?Z.Integer:Z.Number:Array.isArray(e)?Z.Array:"object"==typeof e?Z.Object:null},c.isMatchWorkflowType=(e,t)=>{let r=(0,c.getWorkflowType)(e);return!!r&&r===t},c.isTypeEqual=(e,t)=>e===Z.Number&&t===Z.Integer||e===Z.Integer&&t===Z.Number||e===t,c.getArrayItemsType=e=>{let t=e[0];return e.forEach(e=>{if(e!==t)throw Error(`Array items type must be same, expect ${t}, but got ${e}`)}),t};var G="root",J=e=>e===G,U=(e,t,r)=>{if(t.$ref)return{result:!0};if(t.enum&&t.enum.length>0&&!t.enum.includes(e))return{result:!1,errorMessage:`Value at ${r} must be one of: ${t.enum.join(", ")}, but got: ${JSON.stringify(e)}`};switch(t.type){case"boolean":return Q(e,r);case"string":return H(e,r);case"integer":return X(e,r);case"number":return z(e,r);case"object":return K(e,t,r);case"array":return ee(e,t,r);case"map":return et(e,t,r);default:return{result:!1,errorMessage:`Unknown type "${t.type}" at ${r}`}}},Q=(e,t)=>"boolean"!=typeof e?{result:!1,errorMessage:`Expected boolean at ${t}, but got: ${typeof e}`}:{result:!0},H=(e,t)=>"string"!=typeof e?{result:!1,errorMessage:`Expected string at ${t}, but got: ${typeof e}`}:{result:!0},X=(e,t)=>Number.isInteger(e)?{result:!0}:{result:!1,errorMessage:`Expected integer at ${t}, but got: ${JSON.stringify(e)}`},z=(e,t)=>"number"!=typeof e||isNaN(e)?{result:!1,errorMessage:`Expected number at ${t}, but got: ${JSON.stringify(e)}`}:{result:!0},K=(e,t,r)=>{if(null==e)return{result:!1,errorMessage:`Expected object at ${r}, but got: ${e}`};if("object"!=typeof e||Array.isArray(e))return{result:!1,errorMessage:`Expected object at ${r}, but got: ${Array.isArray(e)?"array":typeof e}`};if(t.required&&t.required.length>0){for(let s of t.required)if(!(s in e))return{result:!1,errorMessage:`Missing required property "${s}" at ${r}`}}if(t.properties)for(let[o]of Object.entries(t.properties)){var s;if((null==(s=t.required)?void 0:s.includes(o))&&!(o in e))return{result:!1,errorMessage:`Missing required property "${o}" at ${r}`}}if(t.properties){for(let[s,o]of Object.entries(t.properties))if(s in e){let t=J(r)?s:`${r}.${s}`,a=U(e[s],o,t);if(!a.result)return a}}if(t.additionalProperties){let s=new Set(Object.keys(t.properties||{}));for(let[o,a]of Object.entries(e))if(!s.has(o)){let e=J(r)?o:`${r}.${o}`,s=U(a,t.additionalProperties,e);if(!s.result)return s}}return{result:!0}},ee=(e,t,r)=>{if(!Array.isArray(e))return{result:!1,errorMessage:`Expected array at ${r}, but got: ${typeof e}`};if(t.items)for(let[s,o]of e.entries()){let e=`${r}[${s}]`,a=U(o,t.items,e);if(!a.result)return a}return{result:!0}},et=(e,t,r)=>{if(null==e)return{result:!1,errorMessage:`Expected map at ${r}, but got: ${e}`};if("object"!=typeof e||Array.isArray(e))return{result:!1,errorMessage:`Expected map at ${r}, but got: ${Array.isArray(e)?"array":typeof e}`};if(t.additionalProperties)for(let[s,o]of Object.entries(e)){let e=J(r)?s:`${r}.${s}`,a=U(o,t.additionalProperties,e);if(!a.result)return a}return{result:!0}},er=class{async execute(e){let t=e.node.id,r=e.container.get(V),{value:s,itemsType:o}=this.getLoopArrayVariable(e),a=e.node.children.find(e=>e.type===A.BlockStart);if(!a)throw Error("Loop block start node not found");let n=[];for(let i=0;i<s.length;i++){let u=s[i],l=e.runtime.sub();l.variableStore.setVariable({nodeID:`${t}_locals`,key:"item",type:o,value:u}),l.variableStore.setVariable({nodeID:`${t}_locals`,key:"index",type:Z.Number,value:i});try{await r.executeNode({context:l,node:a})}catch(e){throw Error("Loop block execute error")}if(this.isBreak(l))break;if(this.isContinue(l))continue;let d=this.getBlockOutput(e,l);n.push(d)}return this.setLoopNodeOutputs(e,n),{outputs:this.combineBlockOutputs(e,n)}}getLoopArrayVariable(e){let t=e.node.data,r=e.runtime.state.parseRef(t.loopFor);return this.checkLoopArray(r),r}checkLoopArray(e){let t=null==e?void 0:e.value;if(!t||(0,y.Z)(t)||!Array.isArray(t))throw Error('Loop "loopFor" is required');if(e.type!==Z.Array)throw Error('Loop "loopFor" must be an array');let r=e.itemsType;if((0,y.Z)(r))throw Error('Loop "loopFor.items" must be array items')}getBlockOutput(e,t){return Object.entries(this.getLoopOutputsDeclare(e)).reduce((e,r)=>{let[s,o]=r,a=t.state.parseRef(o);return a?{...e,[s]:a}:e},{})}setLoopNodeOutputs(e,t){let r=e.node;Object.keys(this.getLoopOutputsDeclare(e)).forEach(s=>{let o=t.map(e=>e[s]),a=o.map(e=>e.type),n=p.getArrayItemsType(a),i=o.map(e=>e.value);e.runtime.variableStore.setVariable({nodeID:r.id,key:s,type:Z.Array,itemsType:n,value:i})})}combineBlockOutputs(e,t){return Object.keys(this.getLoopOutputsDeclare(e)).reduce((e,r)=>({...e,[r]:t.map(e=>e[r].value)}),{})}getLoopOutputsDeclare(e){return e.node.data.loopOutputs??{}}isBreak(e){return!0===e.cache.get("loop-break")}isContinue(e){return!0===e.cache.get("loop-continue")}constructor(){this.type=A.Loop}},es=class{async execute(e){let t,r=e.inputs;this.checkInputs(r);let{modelName:s,temperature:o,apiKey:a,apiHost:n,systemPrompt:i,prompt:u}=r,l=new w.z7({modelName:s,temperature:o,apiKey:a,configuration:{baseURL:n},maxRetries:3}),d=[];i&&d.push(new E.jN(i)),d.push(new E.xk(u));try{t=await l.invoke(d)}catch(e){if("Connection error."===(null==e?void 0:e.message))throw Error(`Network error: unreachable api "${n}"`);throw e}return{outputs:{result:t.content}}}checkInputs(e){let{modelName:t,temperature:r,apiKey:s,apiHost:o,prompt:a}=e,n=[];if(t||n.push("modelName"),(0,y.Z)(r)&&n.push("temperature"),s||n.push("apiKey"),o||n.push("apiHost"),a||n.push("prompt"),n.length>0)throw Error(`LLM node missing required inputs: "${n.join('", "')}"`);this.checkApiHost(o)}checkApiHost(e){if(!e||"string"!=typeof e)throw Error(`Invalid API host format - ${e}`);let t=new URL(e);if("http:"!==t.protocol&&"https:"!==t.protocol)throw Error(`Invalid API host protocol - ${t.protocol}`)}constructor(){this.type=A.LLM}},eo=class{async execute(e){let t=this.parseInputs(e),r=await this.request(t),s={};r.headers.forEach((e,t)=>{s[t]=e});let o=await r.text();return{outputs:{headers:s,statusCode:r.status,body:o}}}async request(e){let{method:t,url:r,headers:s,params:o,bodyType:a,body:n,retryTimes:i,timeout:u}=e,l=this.buildUrlWithParams(r,o),d={method:t,headers:this.prepareHeaders(s,a),signal:AbortSignal.timeout(u)};"GET"!==t&&"HEAD"!==t&&n&&(d.body=this.prepareBody(n,a));let c=null;for(let e=0;e<=i;e++)try{return await fetch(l,d)}catch(t){c=t,e<i&&await new Promise(t=>setTimeout(t,1e3*Math.pow(2,e)))}throw c||Error("HTTP request failed after all retry attempts")}parseInputs(e){let t=e.node,r=t.data.api.method,s=e.runtime.state.parseTemplate(t.data.api.url);if(!s)throw Error("HTTP url is required");let o=s.value,a=e.runtime.state.parseInputs({values:t.data.headersValues,declare:t.data.headers}),n=e.runtime.state.parseInputs({values:t.data.paramsValues,declare:t.data.params}),i=this.parseBody(e),u=t.data.timeout.retryTimes,l=t.data.timeout.timeout,d={method:r,url:o,headers:a,params:n,bodyType:i.bodyType,body:i.body,retryTimes:u,timeout:l};return e.snapshot.update({inputs:JSON.parse(JSON.stringify(d))}),d}parseBody(e){let t=e.node,r=t.data.body.bodyType;if(r===M.None)return{bodyType:r,body:""};if(r===M.JSON){if(!t.data.body.json)throw Error("HTTP json body is required");let s=e.runtime.state.parseTemplate(t.data.body.json);if(!s)throw Error("HTTP json body is required");return{bodyType:r,body:s.value}}if(r===M.FormData){if(!t.data.body.formData||!t.data.body.formDataValues)throw Error("HTTP form-data body is required");return{bodyType:r,body:JSON.stringify(e.runtime.state.parseInputs({values:t.data.body.formDataValues,declare:t.data.body.formData}))}}if(r===M.RawText){if(!t.data.body.json)throw Error("HTTP json body is required");let s=e.runtime.state.parseTemplate(t.data.body.json);if(!s)throw Error("HTTP json body is required");return{bodyType:r,body:s.value}}if(r===M.Binary){if(!t.data.body.binary)throw Error("HTTP binary body is required");let s=e.runtime.state.parseTemplate(t.data.body.binary);if(!s)throw Error("HTTP binary body is required");return{bodyType:r,body:s.value}}if(r===M.XWwwFormUrlencoded){if(!t.data.body.xWwwFormUrlencoded||!t.data.body.xWwwFormUrlencodedValues)throw Error("HTTP x-www-form-urlencoded body is required");return{bodyType:r,body:JSON.stringify(e.runtime.state.parseInputs({values:t.data.body.xWwwFormUrlencodedValues,declare:t.data.body.xWwwFormUrlencoded}))}}throw Error(`HTTP invalid body type "${r}"`)}buildUrlWithParams(e,t){let r=new URL(e);return Object.entries(t).forEach(e=>{let[t,s]=e;null!=s&&""!==s&&r.searchParams.set(t,s)}),r.toString()}prepareHeaders(e,t){let r={...e};if(!r["Content-Type"]&&!r["content-type"])switch(t){case M.JSON:r["Content-Type"]="application/json";break;case M.FormData:break;case M.XWwwFormUrlencoded:r["Content-Type"]="application/x-www-form-urlencoded";break;case M.RawText:r["Content-Type"]="text/plain";break;case M.Binary:r["Content-Type"]="application/octet-stream"}return r}prepareBody(e,t){switch(t){case M.JSON:return e;case M.FormData:let r=new FormData;try{let t=JSON.parse(e);Object.entries(t).forEach(e=>{let[t,s]=e;r.append(t,String(s))})}catch(e){throw Error("Invalid FormData body format")}return r;case M.XWwwFormUrlencoded:try{let t=JSON.parse(e),r=new URLSearchParams;return Object.entries(t).forEach(e=>{let[t,s]=e;r.append(t,String(s))}),r.toString()}catch(e){throw Error("Invalid x-www-form-urlencoded body format")}case M.RawText:case M.Binary:default:return e}}constructor(){this.type=A.HTTP}},ea=class{async execute(e){return e.runtime.ioCenter.setOutputs(e.inputs),{outputs:e.inputs}}constructor(){this.type=A.End}},en=class{async execute(e){return{outputs:{}}}constructor(){this.type=A.BlockStart}},ei=class{async execute(e){return{outputs:{}}}constructor(){this.type=A.BlockEnd}},eu=class{async execute(e){return e.runtime.cache.set("loop-continue",!0),{outputs:{}}}constructor(){this.type=A.Continue}},el={[Z.String]:{[j.EQ]:Z.String,[j.NEQ]:Z.String,[j.CONTAINS]:Z.String,[j.NOT_CONTAINS]:Z.String,[j.IN]:Z.Array,[j.NIN]:Z.Array,[j.IS_EMPTY]:Z.String,[j.IS_NOT_EMPTY]:Z.String},[Z.Number]:{[j.EQ]:Z.Number,[j.NEQ]:Z.Number,[j.GT]:Z.Number,[j.GTE]:Z.Number,[j.LT]:Z.Number,[j.LTE]:Z.Number,[j.IN]:Z.Array,[j.NIN]:Z.Array,[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Integer]:{[j.EQ]:Z.Integer,[j.NEQ]:Z.Integer,[j.GT]:Z.Integer,[j.GTE]:Z.Integer,[j.LT]:Z.Integer,[j.LTE]:Z.Integer,[j.IN]:Z.Array,[j.NIN]:Z.Array,[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Boolean]:{[j.EQ]:Z.Boolean,[j.NEQ]:Z.Boolean,[j.IS_TRUE]:Z.Null,[j.IS_FALSE]:Z.Null,[j.IN]:Z.Array,[j.NIN]:Z.Array,[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Object]:{[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Map]:{[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.DateTime]:{[j.EQ]:Z.DateTime,[j.NEQ]:Z.DateTime,[j.GT]:Z.DateTime,[j.GTE]:Z.DateTime,[j.LT]:Z.DateTime,[j.LTE]:Z.DateTime,[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Array]:{[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null},[Z.Null]:{[j.EQ]:Z.Null,[j.IS_EMPTY]:Z.Null,[j.IS_NOT_EMPTY]:Z.Null}},ed=e=>{let{operator:t}=e,r=e.leftValue;return t===j.EQ?r===e.rightValue:t===j.NEQ?r!==e.rightValue:t===j.GT?r>e.rightValue:t===j.GTE?r>=e.rightValue:t===j.LT?r<e.rightValue:t===j.LTE?r<=e.rightValue:t===j.IN?e.rightValue.includes(r):t===j.NIN?!e.rightValue.includes(r):t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},ec=e=>e instanceof Date?e:new Date(e),ep={[Z.String]:e=>{let{operator:t}=e,r=e.leftValue;if(t===j.EQ)return r===e.rightValue;if(t===j.NEQ)return r!==e.rightValue;if(t===j.CONTAINS){let t=e.rightValue;return r.includes(t)}if(t===j.NOT_CONTAINS){let t=e.rightValue;return!r.includes(t)}return t===j.IN?e.rightValue.includes(r):t===j.NIN?!e.rightValue.includes(r):t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},[Z.Number]:ed,[Z.Integer]:ed,[Z.Boolean]:e=>{let{operator:t}=e,r=e.leftValue;return t===j.EQ?r===e.rightValue:t===j.NEQ?r!==e.rightValue:t===j.IS_TRUE?!0===r:t===j.IS_FALSE?!1===r:t===j.IN?e.rightValue.includes(r):t===j.NIN?!e.rightValue.includes(r):t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},[Z.Object]:e=>{let{operator:t}=e,r=e.leftValue;return t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},[Z.Map]:e=>{let{operator:t}=e,r=e.leftValue;return t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},[Z.Array]:e=>{let{operator:t}=e,r=e.leftValue;return t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)},[Z.DateTime]:e=>{let{operator:t}=e,r=e.leftValue;if(t===j.IS_EMPTY)return(0,y.Z)(r);if(t===j.IS_NOT_EMPTY)return!(0,y.Z)(r);let s=ec(r).getTime(),o=ec(e.rightValue).getTime();return t===j.EQ?s===o:t===j.NEQ?s!==o:t===j.GT?s>o:t===j.GTE?s>=o:t===j.LT?s<o:t===j.LTE&&s<=o},[Z.Null]:e=>{let{operator:t}=e,r=e.leftValue;return t===j.EQ?(0,y.Z)(r)&&(0,y.Z)(e.rightValue):t===j.IS_EMPTY?(0,y.Z)(r):t===j.IS_NOT_EMPTY&&!(0,y.Z)(r)}},eh=[Y,ea,es,class{async execute(e){var t;let r=null==(t=e.node.data)?void 0:t.conditions;if(!r)return{outputs:{}};let s=r.map(t=>this.parseCondition(t,e)).filter(e=>this.checkCondition(e)).find(e=>this.handleCondition(e));return s?{outputs:{},branch:s.key}:{outputs:{},branch:"else"}}parseCondition(e,t){let{key:r,value:s}=e,{left:o,operator:a,right:n}=s,i=t.runtime.state.parseRef(o),u=(null==i?void 0:i.value)??null,l=(null==i?void 0:i.type)??Z.Null,d=this.getRuleType({leftType:l,operator:a}),c=n?t.runtime.state.parseFlowValue({flowValue:n,declareType:d}):null;return{key:r,leftValue:u,leftType:l,rightValue:(null==c?void 0:c.value)??null,rightType:(null==c?void 0:c.type)??Z.Null,operator:a}}checkCondition(e){let t=el[e.leftType];if((0,y.Z)(t))throw Error(`Condition left type "${e.leftType}" is not supported`);let r=t[e.operator];if((0,y.Z)(r))throw Error(`Condition left type "${e.leftType}" has no operator "${e.operator}"`);return!!p.isTypeEqual(r,e.rightType)}handleCondition(e){let t=ep[e.leftType];if(!t)throw Error(`Condition left type ${e.leftType} is not supported`);return t(e)}getRuleType(e){let{leftType:t,operator:r}=e,s=el[t];if((0,y.Z)(s))return Z.Null;let o=s[r];return(0,y.Z)(o)?Z.Null:o}constructor(){this.type=A.Condition}},er,en,ei,eo,class{async execute(e){let t=this.parseInputs(e);if("javascript"===t.script.language)return this.javascript(t);throw Error(`Unsupported code language "${t.script.language}"`)}parseInputs(e){let t=e.node,r=e.inputs,{language:s,content:o}=t.data.script;if(!o)throw Error("Code content is required");return{params:r,script:{language:s,content:o}}}async javascript(e){let{params:t={},script:r}=e;try{let e=Function("params",`
        'use strict';

        ${r.content}

        // Ensure main function exists
        if (typeof main !== 'function') {
          throw new Error('main function is required in the script');
        }

        // Execute main function with params
        return main({ params });
        `),s=new Promise((e,t)=>{setTimeout(()=>{t(Error("Code execution timeout: exceeded 1 minute"))},6e4)}),o=await Promise.race([e(t),s]);return{outputs:o&&"object"==typeof o&&!Array.isArray(o)?o:{result:o}}}catch(e){throw Error(`Code execution failed: ${e.message}`)}}constructor(){this.type=A.Code}},class{async execute(e){return e.runtime.cache.set("loop-break",!0),{outputs:{}}}constructor(){this.type=A.Break}},eu],ef=e=>{var t;let r,{nodes:s,edges:o}=e,a=new Map,n=new Set(s.map(e=>e.id));n.forEach(e=>{a.set(e,[])}),o.forEach(e=>{let t=a.get(e.sourceNodeID);t&&t.push(e.targetNodeID)}),(t=r||(r={}))[t.Unvisited=0]="Unvisited",t[t.Visiting=1]="Visiting",t[t.Visited=2]="Visited";let i=new Map;n.forEach(e=>{i.set(e,0)});let u=e=>{for(let t of(i.set(e,1),a.get(e)||[])){let e=i.get(t);if(1===e||0===e&&u(t))return!0}return i.set(e,2),!1};for(let e of n)if(0===i.get(e)&&u(e))throw Error("Workflow schema contains a cycle, which is not allowed");s.forEach(e=>{e.blocks&&ef({nodes:e.blocks,edges:e.edges??[]})})},eg=e=>{let{blockStartNodes:t,blockEndNodes:r}=e.nodes.reduce((e,t)=>(t.type===A.BlockStart?e.blockStartNodes.push(t):t.type===A.BlockEnd&&e.blockEndNodes.push(t),e),{blockStartNodes:[],blockEndNodes:[]});if(!t.length&&!r.length)throw Error("Workflow block schema must have a block-start node and a block-end node");if(!t.length)throw Error("Workflow block schema must have a block-start node");if(!r.length)throw Error("Workflow block schema must have an block-end node");if(t.length>1)throw Error("Workflow block schema must have only one block-start node");if(r.length>1)throw Error("Workflow block schema must have only one block-end node");e.nodes.forEach(e=>{e.blocks&&eg({nodes:e.blocks,edges:e.edges??[]})})},em=e=>{let{nodes:t,edges:r}=e,s=new Set(t.map(e=>e.id));r.forEach(e=>{if(!s.has(e.sourceNodeID))throw Error(`Workflow schema edge source node "${e.sourceNodeID}" not exist`);if(!s.has(e.targetNodeID))throw Error(`Workflow schema edge target node "${e.targetNodeID}" not exist`)}),t.forEach(e=>{e.blocks&&em({nodes:e.blocks,edges:e.edges??[]})})},ey=e=>{if(!e||"object"!=typeof e)throw Error("Workflow schema must be a valid object");if(!Array.isArray(e.nodes))throw Error("Workflow schema must have a valid nodes array");if(!Array.isArray(e.edges))throw Error("Workflow schema must have a valid edges array");e.nodes.forEach((e,t)=>{eb(e,`nodes[${t}]`)}),e.edges.forEach((e,t)=>{ew(e,`edges[${t}]`)}),e.nodes.forEach((e,t)=>{if(e.blocks){if(!Array.isArray(e.blocks))throw Error(`Node nodes[${t}].blocks must be an array`);ey({nodes:e.blocks,edges:e.edges||[]})}})},eb=(e,t)=>{if(!e||"object"!=typeof e)throw Error(`${t} must be a valid object`);if("string"!=typeof e.id||!e.id.trim())throw Error(`${t}.id must be a non-empty string`);if("string"!=typeof e.type||!e.type.trim())throw Error(`${t}.type must be a non-empty string`);if(!e.meta||"object"!=typeof e.meta)throw Error(`${t}.meta must be a valid object`);if(!e.data||"object"!=typeof e.data)throw Error(`${t}.data must be a valid object`);if(void 0!==e.blocks&&!Array.isArray(e.blocks))throw Error(`${t}.blocks must be an array if present`);if(void 0!==e.edges&&!Array.isArray(e.edges))throw Error(`${t}.edges must be an array if present`);if(void 0!==e.data.inputs&&("object"!=typeof e.data.inputs||null===e.data.inputs))throw Error(`${t}.data.inputs must be a valid object if present`);if(void 0!==e.data.outputs&&("object"!=typeof e.data.outputs||null===e.data.outputs))throw Error(`${t}.data.outputs must be a valid object if present`);if(void 0!==e.data.inputsValues&&("object"!=typeof e.data.inputsValues||null===e.data.inputsValues))throw Error(`${t}.data.inputsValues must be a valid object if present`);if(void 0!==e.data.title&&"string"!=typeof e.data.title)throw Error(`${t}.data.title must be a string if present`)},ew=(e,t)=>{if(!e||"object"!=typeof e)throw Error(`${t} must be a valid object`);if("string"!=typeof e.sourceNodeID||!e.sourceNodeID.trim())throw Error(`${t}.sourceNodeID must be a non-empty string`);if("string"!=typeof e.targetNodeID||!e.targetNodeID.trim())throw Error(`${t}.targetNodeID must be a non-empty string`);if(void 0!==e.sourcePortID&&"string"!=typeof e.sourcePortID)throw Error(`${t}.sourcePortID must be a string if present`);if(void 0!==e.targetPortID&&"string"!=typeof e.targetPortID)throw Error(`${t}.targetPortID must be a string if present`)},eE=class{invoke(e){let{schema:t,inputs:r}=e,s=this.schema(t);if(!s.valid)return s;let o=this.inputs(this.getWorkflowInputsDeclare(t),r);return o.valid?{valid:!0}:o}schema(e){let t=[];return[()=>ey(e),()=>ef(e),()=>em(e),()=>(e=>{let{startNodes:t,endNodes:r}=e.nodes.reduce((e,t)=>(t.type===A.Start?e.startNodes.push(t):t.type===A.End&&e.endNodes.push(t),e),{startNodes:[],endNodes:[]});if(!t.length&&!r.length)throw Error("Workflow schema must have a start node and an end node");if(!t.length)throw Error("Workflow schema must have a start node");if(!r.length)throw Error("Workflow schema must have an end node");if(t.length>1)throw Error("Workflow schema must have only one start node");if(r.length>1)throw Error("Workflow schema must have only one end node");e.nodes.forEach(e=>{e.blocks&&eg({nodes:e.blocks,edges:e.edges??[]})})})(e)].forEach(e=>{try{e()}catch(e){t.push(e instanceof Error?e.message:String(e))}}),{valid:0===t.length,errors:t.length>0?t:void 0}}inputs(e,t){let{result:r,errorMessage:s}=(e=>{let{schema:t,value:r}=e;try{return U(r,t,G)}catch(e){return{result:!1,errorMessage:`Validation error: ${e instanceof Error?e.message:String(e)}`}}})({schema:e,value:t});return r?{valid:!0}:{valid:!1,errors:[`JSON Schema validation failed: ${s}`]}}getWorkflowInputsDeclare(e){let t=e.nodes.find(e=>e.type===A.Start);if(!t)throw Error("Workflow schema must have a start node");return t.data.outputs}},eT=class{register(e){this.nodeExecutors.set(e.type,e)}async execute(e){let t=e.node.type,r=this.nodeExecutors.get(t);if(!r)throw Error(`No executor found for node type ${t}`);return await r.execute(e)}constructor(e){this.nodeExecutors=new Map,e.forEach(e=>{this.register(new e)})}},eN=class e{cancel(){this.context.statusCenter.workflow.cancel(),this.context.statusCenter.getStatusNodeIDs(R.Processing).forEach(e=>{this.context.statusCenter.nodeStatus(e).cancel()})}static create(t){return new e(t)}constructor(e){this.id=q(),this.context=e.context,this.processing=e.processing}};(h||(h={})).create=e=>{let t={id:q(),...e};return e.timestamp||(t.timestamp=Date.now()),t};var ek=class{init(){this.messages={[B.Log]:[],[B.Info]:[],[B.Debug]:[],[B.Error]:[],[B.Warn]:[]}}dispose(){}log(e){let t=h.create({type:B.Log,...e});return this.messages[B.Log].push(t),t}info(e){let t=h.create({type:B.Info,...e});return this.messages[B.Info].push(t),t}debug(e){let t=h.create({type:B.Debug,...e});return this.messages[B.Debug].push(t),t}error(e){let t=h.create({type:B.Error,...e});return this.messages[B.Error].push(t),t}warn(e){let t=h.create({type:B.Warn,...e});return this.messages[B.Warn].push(t),t}export(){return{[B.Log]:this.messages[B.Log].slice(),[B.Info]:this.messages[B.Info].slice(),[B.Debug]:this.messages[B.Debug].slice(),[B.Error]:this.messages[B.Error].slice(),[B.Warn]:this.messages[B.Warn].slice()}}},eI=class{init(){this.map=new Map}dispose(){this.map.clear()}get(e){return this.map.get(e)}set(e,t){return this.map.set(e,t),this}delete(e){return this.map.delete(e)}has(e){return this.map.has(e)}};(f||(f={})).create=e=>({id:q(),...e});var ev=class{init(){this.store=new Map}dispose(){this.store.clear()}setParent(e){this.parent=e}globalGet(e){let t=this.store.get(e);return!t&&this.parent?this.parent.globalGet(e):t}setVariable(e){let{nodeID:t,key:r,value:s,type:o,itemsType:a}=e;this.store.has(t)||this.store.set(t,new Map);let n=this.store.get(t),i=f.create({nodeID:t,key:r,value:s,type:o,itemsType:a});n.set(r,i)}setValue(e){let{nodeID:t,variableKey:r,variablePath:s,value:o}=e;this.store.has(t)||this.store.set(t,new Map);let a=this.store.get(t);if(!a.has(r)){let e=f.create({nodeID:t,key:r,value:{},type:Z.Object});a.set(r,e)}let n=a.get(r);if(!s){n.value=o;return}(0,T.Z)(n.value,s,o)}getValue(e){var t;let{nodeID:r,variableKey:s,variablePath:o}=e,a=null==(t=this.globalGet(r))?void 0:t.get(s);if(!a)return null;if(!o||0===o.length)return{value:a.value,type:a.type,itemsType:a.itemsType};let n=(0,N.Z)(a.value,o),i=p.getWorkflowType(n);if(!i)return null;if(i===Z.Array&&Array.isArray(n)){let e=p.getWorkflowType(n[0]);return e?{value:n,type:i,itemsType:e}:null}return{value:n,type:i}}constructor(){this.id=q()}},eS=class e{get status(){return this._status}get terminated(){return[R.Succeeded,R.Failed,R.Canceled].includes(this.status)}get startTime(){return this._startTime}get endTime(){return this._endTime}get timeCost(){return this.startTime?this.endTime?this.endTime-this.startTime:Date.now()-this.startTime:0}process(){this._status=R.Processing,this._startTime=Date.now(),this._endTime=void 0}success(){this.terminated||(this._status=R.Succeeded,this._endTime=Date.now())}fail(){this.terminated||(this._status=R.Failed,this._endTime=Date.now())}cancel(){this.terminated||(this._status=R.Canceled,this._endTime=Date.now())}export(){return{status:this.status,terminated:this.terminated,startTime:this.startTime,endTime:this.endTime,timeCost:this.timeCost}}static create(){return new e}constructor(){this.id=q(),this._status=R.Pending}},eP=class{init(){this._workflowStatus=eS.create(),this._nodeStatus=new Map}dispose(){}get workflow(){return this._workflowStatus}get workflowStatus(){return this._workflowStatus}nodeStatus(e){return this._nodeStatus.has(e)||this._nodeStatus.set(e,eS.create()),this._nodeStatus.get(e)}getStatusNodeIDs(e){return Array.from(this._nodeStatus.entries()).filter(t=>{let[,r]=t;return r.status===e}).map(e=>{let[t]=e;return t})}exportNodeStatus(){return Object.fromEntries(Array.from(this._nodeStatus.entries()).map(e=>{let[t,r]=e;return[t,r.export()]}))}},e_=class{init(e){this.setGlobalVariable(null==e?void 0:e.globalVariable),this.executedNodes=new Set}dispose(){this.executedNodes.clear()}getNodeInputs(e){let t=e.declare.inputs,r=e.declare.inputsValues;return this.parseInputs({values:r,declare:t})}setNodeOutputs(e){let{node:t,outputs:r}=e,s=t.declare.outputs;(null==s?void 0:s.type)==="object"&&s.properties&&Object.entries(s.properties).forEach(e=>{var s;let[o,a]=e;if(!o||!a)return;let n=a.type,i=null==(s=a.items)?void 0:s.type,u=this.parseJSONContent(a.default,n),l=r[o]??u;this.variableStore.setVariable({nodeID:t.id,key:o,value:l,type:n,itemsType:i})})}parseInputs(e){let{values:t,declare:r}=e;return r&&t?Object.entries(t).reduce((e,t)=>{var s;let[o,a]=t,n=null==(s=r.properties)?void 0:s[o];if(!n)return e;let i=n.type,u=this.parseFlowValue({flowValue:a,declareType:i});if(!u)return e;let{value:l,type:d}=u;return p.isTypeEqual(d,i)&&(e[o]=l),e},{}):{}}parseRef(e){if((null==e?void 0:e.type)!=="ref")throw Error(`Invalid ref value: ${e}`);if(!e.content||e.content.length<2)return null;let[t,r,...s]=e.content,o=this.variableStore.getValue({nodeID:t,variableKey:r,variablePath:s});return o||null}parseTemplate(e){if((null==e?void 0:e.type)!=="template")throw Error(`Invalid template value: ${e}`);if(!e.content)return null;let t=e.content.replace(/\{\{([^\}]+)\}\}/g,(e,t)=>{let r=t.trim().split("."),s=this.parseRef({type:"ref",content:r});return s?s.value:""});return{type:Z.String,value:t}}parseFlowValue(e){let{flowValue:t,declareType:r}=e;if(!(null==t?void 0:t.type))throw Error(`Invalid flow value type: ${t.type}`);if("constant"===t.type){let e=this.parseJSONContent(t.content,r),s=r??p.getWorkflowType(e);return(0,y.Z)(e)||!s?null:{value:e,type:s}}if("ref"===t.type)return this.parseRef(t);if("template"===t.type)return this.parseTemplate(t);throw Error(`Unknown flow value type: ${t.type}`)}isExecutedNode(e){return this.executedNodes.has(e.id)}addExecutedNode(e){this.executedNodes.add(e.id)}parseJSONContent(e,t){let r=[Z.Object,Z.Array,Z.Map];if(t&&r.includes(t)&&"string"==typeof e)try{return JSON.parse(e)}catch(e){}return e}setGlobalVariable(e){(null==e?void 0:e.type)==="object"&&e.properties&&Object.entries(e.properties).forEach(e=>{var t;let[r,s]=e;if(!r||!s)return;let o=s.type,a=null==(t=s.items)?void 0:t.type,n=this.parseJSONContent(s.default,o);this.variableStore.setVariable({nodeID:"global",key:r,value:n,type:o,itemsType:a})})}constructor(e){this.variableStore=e,this.id=q()}},ex=class e{update(e){Object.assign(this.data,e)}validate(){return["nodeID","inputs","outputs","data"].every(e=>void 0!==this.data[e])}export(){return{id:this.id,...this.data}}static create(t){return new e(t)}constructor(e){this.id=q(),this.data=e}},eC=class{create(e){let t=ex.create(e);return this.snapshots.push(t),t}init(){this.snapshots=[]}dispose(){}exportAll(){return this.snapshots.slice().map(e=>e.export())}export(){let e={};return this.exportAll().forEach(t=>{e[t.nodeID]?e[t.nodeID].push(t):e[t.nodeID]=[t]}),e}constructor(){this.id=q()}};(g||(g={})).create=e=>({id:q(),...e});var eO=class{init(){}dispose(){}export(){return g.create({inputs:this.ioCenter.inputs,outputs:this.ioCenter.outputs,workflowStatus:this.statusCenter.workflow.export(),reports:this.nodeReports(),messages:this.messageCenter.export()})}nodeReports(){let e={},t=this.statusCenter.exportNodeStatus(),r=this.snapshotCenter.export();return Object.keys(t).forEach(s=>{let o=t[s],a=r[s]||[],n={id:s,...o,snapshots:a};e[s]=n}),e}constructor(e,t,r,s){this.ioCenter=e,this.snapshotCenter=t,this.statusCenter=r,this.messageCenter=s}},e$=class{init(e){this.setInputs(e)}dispose(){}get inputs(){return this._inputs??{}}get outputs(){return this._outputs??{}}setInputs(e){this._inputs=e}setOutputs(e){this._outputs=e}export(){return{inputs:this._inputs,outputs:this._outputs}}},eD=class{get fromPort(){return this._fromPort}set fromPort(e){this._fromPort=e}get toPort(){return this._toPort}set toPort(e){this._toPort=e}static createID(e){let{sourceNodeID:t,sourcePortID:r,targetNodeID:s,targetPortID:o}=e,a=r?`${t}:${r}`:t,n=o?`${s}:${o}`:s;return`${a}-${n}`}constructor(e){let{id:t,from:r,to:s}=e;this.id=t,this.from=r,this.to=s}},eZ=class{get ports(){return{inputs:this._ports.filter(e=>e.type===D.Input),outputs:this._ports.filter(e=>e.type===D.Output)}}get edges(){return{inputs:this._inputEdges,outputs:this._outputEdges}}get parent(){return this._parent}set parent(e){this._parent=e}get children(){return this._children}addChild(e){this._children.push(e)}addPort(e){this._ports.push(e)}addInputEdge(e){this._inputEdges.push(e),this._prev.push(e.from)}addOutputEdge(e){this._outputEdges.push(e),this._next.push(e.to)}get prev(){return this._prev}get next(){return this._next}get successors(){return F(this,e=>e.next)}get predecessors(){return F(this,e=>e.prev)}get isBranch(){return this.ports.outputs.length>1}constructor(e){let{id:t,type:r,name:s,position:o,variable:a,data:n}=e;this.id=t,this.type=r,this.name=s,this.position=o,this.declare=a??{},this.data=n??{},this._parent=null,this._children=[],this._ports=[],this._inputEdges=[],this._outputEdges=[],this._prev=[],this._next=[]}},eA=class{get edges(){return this._edges}addEdge(e){this._edges.push(e)}constructor(e){let{id:t,node:r}=e;this.id=t,this.node=r,this.type=e.type,this._edges=[]}},ej=(e,t)=>{let{blocks:r,edges:s}=t;if(r){e.flattenSchema.nodes.push(...r);let s=[];r.forEach(t=>{s.push(t.id),t.blocks&&ej(e,t)}),e.nodeBlocks.set(t.id,s),delete t.blocks}if(s){e.flattenSchema.edges.push(...s);let r=[];s.forEach(e=>{let t=eD.createID(e);r.push(t)}),e.nodeEdges.set(t.id,r),delete t.edges}},eM=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{nodes:[],edges:[]},t=e.nodes??[],r=e.edges??[],s={flattenSchema:{nodes:[],edges:[]},nodeBlocks:new Map,nodeEdges:new Map};return ej(s,{id:A.Root,type:A.Root,blocks:t,edges:r,meta:{position:{x:0,y:0}},data:{}}),s},eV=(e,t)=>{let r=new eZ(t);return e.nodes.set(r.id,r),r},eL=(e,t)=>{let r=e.ports.get(t.id);if(r)return r;let s=new eA(t);return e.ports.set(s.id,s),s},eR=class{get root(){let e=this.getNode(A.Root);if(!e)throw Error("Root node not found");return e}get start(){let e=this.nodes.find(e=>e.type===A.Start);if(!e)throw Error("Start node not found");return e}get end(){let e=this.nodes.find(e=>e.type===A.End);if(!e)throw Error("End node not found");return e}getNode(e){return this.store.nodes.get(e)??null}getEdge(e){return this.store.edges.get(e)??null}get nodes(){return Array.from(this.store.nodes.values())}get edges(){return Array.from(this.store.edges.values())}init(e){let t=eM(e);this.store=(e=>{let{flattenSchema:t,nodeBlocks:r}=e,{nodes:s,edges:o}=t,a={nodes:new Map,edges:new Map,ports:new Map};return eV(a,{id:A.Root,type:A.Root,name:A.Root,position:{x:0,y:0}}),s.forEach(e=>{let t=e.id,r=e.type,{title:s=`${r}-${t}-untitled`,inputsValues:o,inputs:n,outputs:i,...u}=e.data??{};eV(a,{id:t,type:r,name:s,position:e.meta.position,variable:{inputsValues:o,inputs:n,outputs:i},data:u})}),r.forEach((e,t)=>{let r=a.nodes.get(t);e.map(e=>a.nodes.get(e)).filter(Boolean).forEach(e=>{e.parent=r,r.addChild(e)})}),o.forEach(e=>{let t=eD.createID(e),{sourceNodeID:r,targetNodeID:s,sourcePortID:o="defaultOutput",targetPortID:n="defaultInput"}=e,i=a.nodes.get(r),u=a.nodes.get(s);if(!i||!u)throw Error(`Invalid edge schema ID: ${t}, from: ${r}, to: ${s}`);let l=((e,t)=>{let r=new eD(t);return e.edges.set(r.id,r),r})(a,{id:t,from:i,to:u}),d=eL(a,{node:i,id:o,type:D.Output});d.addEdge(l),l.fromPort=d,i.addPort(d),i.addOutputEdge(l);let c=eL(a,{node:u,id:n,type:D.Input});c.addEdge(l),l.toPort=c,u.addPort(c),u.addInputEdge(l)}),a})(t)}dispose(){this.store.edges.clear(),this.store.nodes.clear(),this.store.ports.clear()}constructor(){this.id=q()}},eW=class e{init(e){let{schema:t,inputs:r}=e;this.cache.init(),this.document.init(t),this.variableStore.init(),this.state.init(t),this.ioCenter.init(r),this.snapshotCenter.init(),this.statusCenter.init(),this.messageCenter.init(),this.reporter.init()}dispose(){this.subContexts.forEach(e=>{e.dispose()}),this.subContexts=[],this.cache.dispose(),this.document.dispose(),this.variableStore.dispose(),this.state.dispose(),this.ioCenter.dispose(),this.snapshotCenter.dispose(),this.statusCenter.dispose(),this.messageCenter.dispose(),this.reporter.dispose()}sub(){let t=new eI,r=new ev;r.setParent(this.variableStore);let s=new e_(r),o=new e({cache:t,document:this.document,ioCenter:this.ioCenter,snapshotCenter:this.snapshotCenter,statusCenter:this.statusCenter,messageCenter:this.messageCenter,reporter:this.reporter,variableStore:r,state:s});return this.subContexts.push(o),o.cache.init(),o.variableStore.init(),o.state.init(),o}static create(){let t=new eI,r=new eR,s=new ev,o=new e_(s),a=new e$,n=new eC,i=new eP,u=new ek,l=new eO(a,n,i,u);return new e({cache:t,document:r,variableStore:s,state:o,ioCenter:a,snapshotCenter:n,statusCenter:i,messageCenter:u,reporter:l})}constructor(e){this.subContexts=[],this.id=q(),this.cache=e.cache,this.document=e.document,this.variableStore=e.variableStore,this.state=e.state,this.ioCenter=e.ioCenter,this.snapshotCenter=e.snapshotCenter,this.statusCenter=e.statusCenter,this.messageCenter=e.messageCenter,this.reporter=e.reporter}},eB=class{invoke(e){let t=eW.create();if(t.init(e),!this.validate(e,t))return eN.create({processing:Promise.resolve({}),context:t});let r=this.process(t);return r.then(()=>{t.dispose()}),eN.create({processing:r,context:t})}async executeNode(e){let{node:t,context:r}=e;if(!this.canExecuteNode({node:t,context:r}))return;r.statusCenter.nodeStatus(t.id).process();let s=r.snapshotCenter.create({nodeID:t.id,data:t.data}),o=[];try{let e=r.state.getNodeInputs(t);s.update({inputs:e});let a=await this.executor.execute({node:t,inputs:e,runtime:r,container:eY.instance,snapshot:s});if(r.statusCenter.workflow.terminated)return;let{outputs:n,branch:i}=a;s.update({outputs:n,branch:i}),r.state.setNodeOutputs({node:t,outputs:n}),r.state.addExecutedNode(t),r.statusCenter.nodeStatus(t.id).success(),o=this.getNextNodes({node:t,branch:i,context:r})}catch(o){let e=o instanceof Error?o.message:"An unknown error occurred";throw s.update({error:e}),r.messageCenter.error({nodeID:t.id,message:e}),r.statusCenter.nodeStatus(t.id).fail(),console.error(o),o}await this.executeNext({node:t,nextNodes:o,context:r})}async process(e){let t=e.document.start;e.statusCenter.workflow.process();try{await this.executeNode({node:t,context:e});let r=e.ioCenter.outputs;return e.statusCenter.workflow.success(),r}catch(t){return e.statusCenter.workflow.fail(),{}}}validate(e,t){let{valid:r,errors:s}=this.validation.invoke(e);return!!r||(null==s||s.forEach(e=>{t.messageCenter.error({message:e})}),t.statusCenter.workflow.fail(),!1)}canExecuteNode(e){let{node:t,context:r}=e,s=t.prev;return 0===s.length||s.every(e=>r.state.isExecutedNode(e))}getNextNodes(e){let{node:t,branch:r,context:s}=e,o=t.next;if(!r)return o;let a=t.ports.outputs.find(e=>e.id===r);if(!a)throw Error(`Branch "${r}" not found`);let n=new Set(a.edges.map(e=>e.to.id)),i=o.filter(e=>n.has(e.id)),u=o.filter(e=>!n.has(e.id)),{uniqueToB:l}=function(e,t){let r=e.flat(),s=new Map;r.forEach(e=>{s.set(e.id,e)});let o=t.flat(),a=new Map;o.forEach(e=>{a.set(e.id,e)});let n=[],i=[],u=[];return s.forEach((e,t)=>{a.has(t)?n.push(e):i.push(e)}),a.forEach((e,t)=>{s.has(t)||u.push(e)}),{common:n,uniqueToA:i,uniqueToB:u}}(i.map(e=>[e,...e.successors]),u.map(e=>[e,...e.successors]));return l.forEach(e=>{s.state.addExecutedNode(e)}),i}async executeNext(e){let{context:t,node:r,nextNodes:s}=e;if(![A.End,A.BlockEnd,A.Break,A.Continue].includes(r.type)){if(0===s.length)throw Error(`Node "${r.id}" has no next nodes`);await Promise.all(s.map(e=>this.executeNode({node:e,context:t})))}}constructor(e){this.validation=e.Validation,this.executor=e.Executor}},eY=class e{get(e){return this.services[e]}static get instance(){if(this._instance)return this._instance;let t=this.create();return this._instance=new e(t),this._instance}static create(){let e=new eE,t=new eT(eh),r=new eB({Validation:e,Executor:t});return{[W]:e,[L]:t,[V]:r}}constructor(e){this.services=e}},eq=class e{run(e){let t=this.container.get(V).invoke(e);return this.tasks.set(t.id,t),console.log("> POST TaskRun - taskID: ",t.id),console.log(e.inputs),t.processing.then(e=>{console.log("> LOG Task finished: ",t.id),console.log(e)}),t.id}cancel(e){console.log("> PUT TaskCancel - taskID: ",e);let t=this.tasks.get(e);return!!t&&(t.cancel(),!0)}report(e){let t=this.tasks.get(e);if(console.log("> GET TaskReport - taskID: ",e),t)return t.context.reporter.export()}result(e){console.log("> GET TaskResult - taskID: ",e);let t=this.tasks.get(e);if(t&&t.context.statusCenter.workflow.terminated)return t.context.ioCenter.outputs}validate(e){let t=this.container.get(W).invoke(e);return console.log("> POST TaskValidate - valid: ",t.valid),t}static get instance(){return this._instance||(this._instance=new e),this._instance}constructor(){this.container=eY.instance,this.tasks=new Map}},eF=async e=>{let t=eq.instance,{schema:r,inputs:s}=e,o=JSON.parse(r);return t.validate({schema:o,inputs:s})},eG=async e=>{let t=eq.instance,{schema:r,inputs:s}=e,o=JSON.parse(r);return{taskID:t.run({schema:o,inputs:s})}},eJ=async e=>{let t=eq.instance,{taskID:r}=e;return t.result(r)},eU=async e=>{let t=eq.instance,{taskID:r}=e,s=t.report(r);try{$.schema.output.parse(s)}catch(e){console.log("> TaskReportAPI - output: ",JSON.stringify(s)),console.error(e)}return s},eQ=async e=>{let t=eq.instance,{taskID:r}=e;return{success:t.cancel(r)}};O.ServerInfo,O.TaskRun,O.TaskReport,O.TaskResult,O.TaskCancel,O.TaskValidate}}]);